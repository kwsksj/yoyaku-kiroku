<script>
  /**
   * =================================================================
   * ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: 14_WebApp_Handlers.html
   * ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘: 1.6
   * ã€å½¹å‰²ã€‘: WebAppã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«ãŠã‘ã‚‹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œã«å¿œã˜ãŸ
   * ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ã‚’é›†ç´„ã—ã¾ã™ã€‚
   * ã€æ§‹æˆã€‘: 14ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®ã†ã¡ã®14ç•ªç›®
   * ã€v1.6ã§ã®å¤‰æ›´ç‚¹ã€‘:
   * - FE-14: ä¼šè¨ˆå…¥åŠ›ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã‚’è¿½åŠ ã€‚
   *   - localStorageã¸ã®ä¿å­˜ã€èª­ã¿è¾¼ã¿ã€å‰Šé™¤å‡¦ç†ã‚’å®Ÿè£…ã€‚
   *   - ç”»é¢é·ç§»ã€ä¿å­˜ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’é©åˆ‡ã«æ“ä½œã™ã‚‹ã‚ˆã†ä¿®æ­£ã€‚
   * =================================================================
   */

  // =================================================================
  // --- Accounting Cache Helper Functions (FE-14) ---
  // -----------------------------------------------------------------
  // ä¼šè¨ˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤
  // =================================================================

  /**
   * ä¼šè¨ˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç¾åœ¨ã®å…¥åŠ›å†…å®¹ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦å–å¾—ã—ã¾ã™ã€‚
   * @returns {object} ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿
   */
  function getAccountingFormData() {
    const form = document.getElementById('accounting-form');
    if (!form) return {};

    const data = {};
    const elements = form.elements;

    for (let i = 0; i < elements.length; i++) {
      const item = elements[i];
      if (item.name) {
        if (item.type === 'checkbox') {
          data[item.name] = item.checked;
        } else if (item.type === 'radio') {
          if (item.checked) {
            data[item.name] = item.value;
          }
        } else {
          data[item.name] = item.value;
        }
      }
    }
    return data;
  }

  /**
   * ä¼šè¨ˆç”»é¢ã®å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
   * @param {string} reservationId - äºˆç´„ID
   */
  function setupAccountingFormListeners(reservationId) {
    const form = document.getElementById('accounting-form');
    if (!form) return;

    form.addEventListener('input', () => {
      const accountingData = getAccountingFormData();
      saveAccountingCache(reservationId, accountingData);
    });
  }

  // =================================================================
  // --- Action Handlers ---
  // -----------------------------------------------------------------
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œï¼ˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãªã©ï¼‰ã‚’èµ·ç‚¹ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹
  // å…¨ã¦ã®å‡¦ç†ã‚’å®šç¾©ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚
  // å„ã‚­ãƒ¼ãŒ data-action å±æ€§ã«å¯¾å¿œã—ã¾ã™ã€‚
  // =================================================================
  const actionHandlers = {
    /** ãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯æ–°è¦ç™»éŒ²ã‚’é–‹å§‹ã—ã¾ã™ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ç‰ˆï¼‰ */
    login: () => {
      const p = document.getElementById('phone').value;
      // å…¥åŠ›å€¤ã‚’setStateçµŒç”±ã§ä¿å­˜
      setState({ loginPhone: p });
      if (!p) return showInfo('é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      const n = p.replace(/[â€ï¼-]/g, '').replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 65248));
      showLoading('login');

      // ç’°å¢ƒåˆ†å²: ãƒ†ã‚¹ãƒˆç’°å¢ƒã®å ´åˆã¯ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
      if (isTestEnvironment) {
        // ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
        setTimeout(() => {
          hideLoading();
          setState({
            currentUser: getEnvironmentData('currentUser', { displayName: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼', phone: n }),
            slots: getEnvironmentData('slots', []),
            myBookings: getEnvironmentData('myBookings', []),
            accountingMaster: getEnvironmentData('accountingMaster', {}),
            history: getEnvironmentData('history', []),
            historyTotal: getEnvironmentData('history', []).length,
            recordsToShow: 10, // UI.HISTORY_INITIAL_RECORDSã§å¾Œã§æ›´æ–°
            view: 'dashboard', // ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç›´æ¥é·ç§»
          });
        }, 300);
        return;
      }

      // æœ¬ç•ªç’°å¢ƒ: çµ±åˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§åˆæœŸãƒ‡ãƒ¼ã‚¿ã¨ç©ºå¸­æƒ…å ±ã‚’ä¸€æ‹¬å–å¾—
      google.script.run
        .withSuccessHandler(response => {
          // â† ã“ã® response ã«ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã® getLoginData é–¢æ•°ã®æˆ»ã‚Šå€¤ãŒæ ¼ç´ã•ã‚Œã¾ã™ã€‚
          hideLoading();

          // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ç”»é¢ã«è¡¨ç¤º
          debugLog('åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†');
          debugLog('response.success: ' + response.success);
          debugLog('response.userFound: ' + response.userFound);
          debugLog(
            'response.availableSlots: ' +
              (response.availableSlots ? response.availableSlots.length + 'ä»¶' : 'null/undefined'),
          );
          debugLog('response.data: ' + (response.data ? 'ã‚ã‚Š' : 'null/undefined'));

          if (response.success && response.userFound) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆï¼šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰å‡¦ç†ã§çŠ¶æ…‹æ§‹ç¯‰
            const newAppState = processInitialData(
              response.data,
              n,
              response.availableSlots,
              response.data.userReservations,
            );
            debugLog(
              'processInitialDataå®Œäº† - slots: ' + (newAppState.slots ? newAppState.slots.length + 'ä»¶' : 'null'),
            );
            debugLog('processInitialDataå®Œäº† - classrooms: ' + JSON.stringify(newAppState.classrooms));
            // NF-04.2: åˆå›äºˆç´„åˆ¤å®š
            const isFirstTime =
              (!newAppState.myBookings || newAppState.myBookings.length === 0) &&
              (!newAppState.history || newAppState.history.length === 0);
            setState({
              ...newAppState,
              isFirstTimeBooking: isFirstTime,
              // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸå®šæ•°ã‚’ä½¿ã£ã¦ã€è¡¨ç¤ºã™ã‚‹å±¥æ­´ã®åˆæœŸä»¶æ•°ã‚’è¨­å®š
              recordsToShow: newAppState.constants?.ui?.HISTORY_INITIAL_RECORDS || 10,
              isDataFresh: true,
            });
          } else {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¾ãŸã¯ç‰¹åˆ¥ã‚³ãƒãƒ³ãƒ‰èªè­˜æ™‚
            setState({
              view: 'userSearch',
              searchedUsers: [],
              selectedSearchedUser: null,
              searchAttempted: false,
            });
          }
        })
        .withFailureHandler(err => {
          hideLoading();
          debugLog('åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + err.message);
          handleServerError(err);
        })
        .getLoginData(n);
    },

    /** æ–°ã—ã„ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ï¼ˆãƒ¡ã‚¤ãƒ³ã®loginã«çµ±åˆæ¸ˆã¿ï¼‰ */

    /** æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼šStep1ã‹ã‚‰Step2ã¸ */
    goToStep2: () => {
      const realName = document.getElementById('reg-realname').value;
      const nickname = document.getElementById('reg-nickname').value.trim();
      const phone = document.getElementById('reg-phone').value;
      // å…¥åŠ›å€¤ã‚’setStateçµŒç”±ã§ä¿å­˜
      const updatedRegistrationData = {
        ...appState.registrationData,
        phone,
        realName,
        nickname: nickname || realName,
      };
      if (!realName) return showInfo('ãŠåå‰ï¼ˆæœ¬åï¼‰ã¯å¿…é ˆã§ã™ã€‚');
      setState({
        registrationData: updatedRegistrationData,
        registrationStep: 2,
        view: 'registrationStep2',
      });
    },

    /** æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼šStep2ã‹ã‚‰Step1ã¸æˆ»ã‚‹ */
    backToStep1: () => {
      const realName = document.getElementById('reg-realname')?.value;
      const nickname = document.getElementById('reg-nickname')?.value;
      const phone = document.getElementById('reg-phone')?.value;
      if (realName || nickname || phone) {
        const updatedRegistrationData = {
          ...appState.registrationData,
          realName: realName || appState.registrationData?.realName || '',
          nickname: nickname || appState.registrationData?.nickname || '',
          phone: phone || appState.registrationData?.phone || '',
        };
        setState({ registrationData: updatedRegistrationData });
      }
      setState({ view: 'register', registrationStep: 1 });
    },

    /** æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼šStep2ã‹ã‚‰Step3ã¸é€²ã‚€ */
    goToStep3: () => {
      const email = document.getElementById('q-email').value;
      if (!email || !email.includes('@')) {
        return showInfo('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      }

      const step2Data = {
        email: email,
        wantsEmail: document.getElementById('q-wants-email').checked,
        ageGroup: document.getElementById('q-age-group').value,
        gender: document.querySelector('input[name="gender"]:checked')?.value || '',
        dominantHand: document.querySelector('input[name="dominantHand"]:checked')?.value || '',
        address: document.getElementById('q-address').value,
      };

      setState({
        registrationData: { ...appState.registrationData, ...step2Data },
        registrationStep: 3,
        view: 'registrationStep3',
      });
    },

    /** æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼šStep3ã‹ã‚‰Step2ã¸æˆ»ã‚‹ */
    backToStep2: () => setState({ view: 'registrationStep2', registrationStep: 2 }),

    /** æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼šæœ€çµ‚ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ï¼ˆãƒãƒƒãƒå‡¦ç†ç‰ˆï¼‰ */
    submitRegistration: () => {
      const step3Data = {
        experience: document.querySelector('input[name="experience"]:checked')?.value || '',
        pastWork: document.getElementById('q-past-work').value,
        futureGoal: document.getElementById('q-future-goal').value,
      };

      const finalUserData = { ...appState.registrationData, ...step3Data };

      showLoading('login');
      google.script.run
        .withSuccessHandler(res => {
          if (res.success) {
            // ç™»éŒ²å¾Œã€ãƒãƒƒãƒå‡¦ç†ã§åˆæœŸãƒ‡ãƒ¼ã‚¿ã¨ç©ºå¸­æƒ…å ±ã‚’ä¸€æ‹¬å–å¾—
            google.script.run
              .withSuccessHandler(batchResult => {
                hideLoading();

                if (batchResult.success) {
                  const newAppState = processInitialData(
                    batchResult.data.initial,
                    res.user.phone,
                    batchResult.data.slots,
                  );
                  setState({
                    ...newAppState,
                    currentUser: res.user,
                    view: 'classroomSelection',
                  });
                } else {
                  showInfo(batchResult.message || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'ã‚¨ãƒ©ãƒ¼');
                }
              })
              .withFailureHandler(handleServerError)
              .getBatchData(['initial', 'slots'], res.user.phone);
          } else {
            hideLoading();
            showInfo(res.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(handleServerError)
        .registerNewUser(finalUserData);
    },

    /** ãã‚ãã‚«ãƒ¼ãƒ‰ã®ç·¨é›†ãƒœã‚¿ãƒ³ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ç‰ˆï¼‰ */
    editHistoryMemo: d => {
      const item = appState.history.find(h => h.reservationId === d.reservationId);
      if (!item) return;

      const originalMemo = item.workInProgress;

      showConfirm({
        title: 'åˆ¶ä½œãƒ¡ãƒ¢ã®ç·¨é›†',
        message: buildMemoEditModal(item),
        confirmText: 'ä¿å­˜ã™ã‚‹',
        cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
        confirmColorClass: DesignConfig.colors.primary,
        onConfirm: () => {
          const newMemo = document.getElementById('memo-edit-textarea').value;

          // æ¥½è¦³çš„UI: ã¾ãšãƒ•ãƒ­ãƒ³ãƒˆã®è¡¨ç¤ºã‚’æ›´æ–°
          item.workInProgress = newMemo;
          setState({ history: [...appState.history] });

          showLoading();

          // ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ï¼ˆçµ±åˆäºˆç´„ã‚·ãƒ¼ãƒˆæ›´æ–° + ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†æ§‹ç¯‰ + æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼‰
          google.script.run
            .withSuccessHandler(r => {
              hideLoading();
              if (r.success) {
                showInfo('åˆ¶ä½œãƒ¡ãƒ¢ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚', 'ä¿å­˜å®Œäº†');
                // ä»–ã®æ“ä½œã¨åŒæ§˜ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§çŠ¶æ…‹ã‚’æ›´æ–°
                if (r.data) {
                  setState({
                    ...r.data.initialData,
                    myBookings: r.data.myBookings || [],
                    history: r.data.initialData.myHistory || [],
                    historyTotal: (r.data.initialData.myHistory || []).length,
                    isDataFresh: true, // æœ€æ–°ãƒ‡ãƒ¼ã‚¿å—ä¿¡æ¸ˆã¿
                  });
                } else {
                  setState({ view: 'dashboard' });
                }
              } else {
                // ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å…ƒã«æˆ»ã™
                item.workInProgress = originalMemo;
                setState({ history: [...appState.history] });
                showInfo(r.message || 'ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'ã‚¨ãƒ©ãƒ¼');
              }
            })
            .withFailureHandler(err => {
              hideLoading();
              // é€šä¿¡ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å…ƒã«æˆ»ã™
              item.workInProgress = originalMemo;
              setState({ history: [...appState.history] });
              handleServerError(err);
            })
            .updateReservationMemoAndGetLatestData(d.reservationId, appState.currentUser.studentId, newMemo);
        },
      });
    },

    /** ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã™ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ç‰ˆï¼‰ */
    saveProfile: () => {
      const r = document.getElementById('edit-realname').value;
      let n = document.getElementById('edit-nickname').value.trim();
      if (!r) return showInfo('ãŠåå‰ï¼ˆæœ¬åï¼‰ã¯å¿…é ˆã§ã™ã€‚');
      if (!n) n = r;

      // NF-01: é›»è©±ç•ªå·å…¥åŠ›æ¬„ãŒã‚ã‚Œã°ãã®å€¤ã‚‚å–å¾—
      const phoneInput = document.getElementById('edit-phone');
      const phone = phoneInput ? phoneInput.value : appState.currentUser.phone; // é›»è©±ç•ªå·å…¥åŠ›æ¬„ãŒãªã‘ã‚Œã°æ—¢å­˜ã®é›»è©±ç•ªå·ã‚’ä½¿ç”¨

      const u = { ...appState.currentUser, realName: r, displayName: n, phone: phone }; // é›»è©±ç•ªå·ã‚‚è¿½åŠ 
      showLoading();
      google.script.run
        .withSuccessHandler(res => {
          hideLoading();
          if (res.success) {
            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°å¾Œã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚æ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã®ã§ãã®ã¾ã¾çŠ¶æ…‹æ›´æ–°
            showInfo('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'æ›´æ–°å®Œäº†');
            setState({ currentUser: res.updatedUser, view: 'dashboard' });
          } else {
            showInfo(res.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(handleServerError)
        .updateUserProfile(u);
    },

    /**
     * NF-01: é›»è©±ç•ªå·æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢ã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ç‰ˆï¼‰ã€‚
     */
    searchUserByName: () => {
      const searchInput = document.getElementById('nickname-search-input');
      const searchTerm = searchInput ? searchInput.value.trim() : ''; // æ¤œç´¢èªã‚’searchTermã«å¤‰æ›´

      if (!searchTerm) {
        return showInfo('ãŠåå‰ï¼ˆæœ¬åï¼‰ã¾ãŸã¯ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      }

      showLoading('login');

      // æ¤œç´¢èªã‹ã‚‰ã‚¹ãƒšãƒ¼ã‚¹ã‚’é™¤å»ã—ã¦å°æ–‡å­—åŒ–ã—ã¦æ¯”è¼ƒã«ä½¿ã†
      const normalizedSearchTerm = searchTerm.replace(/\s+/g, '').toLowerCase();

      google.script.run
        .withSuccessHandler(response => {
          hideLoading();
          if (response.success) {
            // ã€çµ±ä¸€ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã€‘ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ä¿®æ­£
            // searchName (ã‚¹ãƒšãƒ¼ã‚¹é™¤å»æ¸ˆã¿ãƒ»å°æ–‡å­—åŒ–ã•ã‚ŒãŸçµåˆå) ã‚’ä½¿ã£ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const filteredUsers = response.data.filter(
              user => user.searchName && user.searchName.includes(normalizedSearchTerm),
            );

            // NF-01: æ¤œç´¢ãŒè©¦è¡Œã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
            setState({ searchedUsers: filteredUsers, searchAttempted: true });

            if (filteredUsers.length === 0) {
              // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒ“ãƒ¥ãƒ¼å´ã§è¡¨ç¤º
            }
          } else {
            showInfo(response.message || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(handleServerError)
        .searchUsersWithoutPhone(searchTerm);
    },

    /**
     * NF-01: æ¤œç´¢çµæœã‹ã‚‰é›»è©±ç•ªå·æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¾ã™ï¼ˆãƒãƒƒãƒå‡¦ç†ç‰ˆï¼‰ã€‚
     */
    selectSearchedUser: d => {
      // ãƒœã‚¿ãƒ³ã«åŸ‹ã‚è¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€ã¾ãšä»®ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä½œæˆ
      const tempUser = {
        studentId: d.studentId,
        realName: d.realName, // ãƒœã‚¿ãƒ³ã®dataå±æ€§ã‹ã‚‰å–å¾—
        displayName: d.nickname, // ãƒœã‚¿ãƒ³ã®dataå±æ€§ã‹ã‚‰å–å¾—
        phone: '', // é›»è©±ç•ªå·ã¯ã¾ã ãªã„ã®ã§ç©º
      };

      showLoading('login');

      // ãƒãƒƒãƒå‡¦ç†ã§åˆæœŸãƒ‡ãƒ¼ã‚¿ã€ç©ºå¸­æƒ…å ±ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬å–å¾—
      google.script.run
        .withSuccessHandler(response => {
          hideLoading();
          if (response.success) {
            // tempUserã®æƒ…å ±ã§currentUserã‚’ä¸Šæ›¸ãã—ã¤ã¤ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’æ´»ç”¨
            const userFromCache = response.data.initial.allStudents[tempUser.studentId];
            const finalUser = userFromCache
              ? {
                  ...userFromCache,
                  displayName: tempUser.displayName,
                  phone: tempUser.phone,
                }
              : tempUser;

            // å€‹äººäºˆç´„ãƒ‡ãƒ¼ã‚¿ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å–å¾—æ¸ˆã¿
            const { myBookings, myHistory } = response.data.userReservations || { myBookings: [], myHistory: [] };
            const today = response.data.initial.today;

            setState({
              currentUser: finalUser,
              slots: response.data.slots,
              myBookings: myBookings,
              accountingMaster: response.data.initial.accountingMaster,
              history: myHistory,
              historyTotal: myHistory.length,
              recordsToShow: 10, // UI.HISTORY_INITIAL_RECORDSã§å¾Œã§æ›´æ–°
              view: 'editProfile', // é›»è©±ç•ªå·ç™»éŒ²ã‚’ä¿ƒã™ãŸã‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ç”»é¢ã¸
              today: today,
              _allStudents: response.data.initial.allStudents,
              _cacheVersions: response.data.initial.cacheVersions,
            });
          } else {
            showInfo(response.message || 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(handleServerError)
        .getBatchData(['initial', 'slots', 'reservations'], null, tempUser.studentId);
    },

    /**
     * NF-01: è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã«æ–°è¦ç™»éŒ²ç”»é¢ã¸é·ç§»ã—ã¾ã™ã€‚
     */
    goToRegisterFromUserSearch: () => {
      // æ–°è¦ç™»éŒ²ç”»é¢ã¸é·ç§»ã€‚é›»è©±ç•ªå·ã¯æœªå…¥åŠ›ã®ã¾ã¾ã€‚
      setState({ view: 'register', registrationPhone: '' });
    },

    /** äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ */
    cancel: d => {
      const message = `
        <div class="text-left space-y-4">
          <p class="text-center"><b>${formatDate(d.date)}</b><br>${d.classroom}<br>ã“ã®äºˆç´„ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ</p>
          <div class="pt-4 border-t">
            <label class="block text-sm font-bold mb-2">å…ˆç”Ÿã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="cancel-message" class="w-full p-2 border border-ui-border rounded" rows="3" placeholder=""></textarea>
          </div>
        </div>
      `;
      showConfirm({
        title: 'äºˆç´„ã®å–ã‚Šæ¶ˆã—',
        message: message,
        confirmText: 'ã¯ã„ã€€å–ã‚Šæ¶ˆã—ã¾ã™',
        cancelText: 'ã„ã„ãˆ',
        confirmColorClass: DesignConfig.colors.danger,
        onConfirm: () => {
          showLoading('cancel');
          const cancelMessage = document.getElementById('cancel-message')?.value || '';
          const p = {
            ...d,
            studentId: appState.currentUser.studentId,
            cancelMessage: cancelMessage,
          };
          google.script.run
            .withSuccessHandler(r => {
              hideLoading();
              if (r.success) {
                if (r.data) {
                  setState({
                    ...r.data.initialData,
                    myBookings: r.data.myBookings || [],
                    history: r.data.initialData.myHistory || [],
                    historyTotal: (r.data.initialData.myHistory || []).length,
                    view: 'dashboard',
                    isDataFresh: true, // æœ€æ–°ãƒ‡ãƒ¼ã‚¿å—ä¿¡æ¸ˆã¿
                  });
                } else {
                  setState({
                    view: 'dashboard',
                    isDataFresh: false, // å†èª­ã¿è¾¼ã¿å¿…è¦
                  });
                }
                showInfo(r.message || 'äºˆç´„ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚', 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†');
              } else {
                showInfo(r.message || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
              }
            })
            .withFailureHandler(err => {
              // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç”»é¢ã‚’æ›´æ–°ã›ãšã€å…ƒã®çŠ¶æ…‹ã‚’ç¶­æŒ
              handleServerError(err);
            })
            .cancelReservationAndGetLatestData(p);
        },
      });
    },

    /** äºˆç´„ã‚’ç¢ºå®šã—ã¾ã™ */
    confirmBooking: () => {
      const bookingOptions = {
        chiselRental: document.getElementById('option-rental')?.checked || false,
        firstLecture: document.getElementById('option-first-lecture')?.checked || false,
        startTime: document.getElementById('res-start-time')?.value || '',
        endTime: document.getElementById('res-end-time')?.value || '',
        workInProgress: document.getElementById('wip-input')?.value || '',
        order: document.getElementById('order-input')?.value || '',
        messageToTeacher: document.getElementById('message-input')?.value || '',
        materialInfo: document.getElementById('material-input')?.value || '',
      };

      showLoading('booking');
      const p = {
        ...appState.selectedSlot,
        user: appState.currentUser,
        studentId: appState.currentUser.studentId,
        options: bookingOptions,
      };

      google.script.run
        .withSuccessHandler(r => {
          hideLoading();
          if (r.success) {
            if (r.data) {
              setState({
                ...r.data.initialData,
                myBookings: r.data.myBookings || [],
                history: r.data.initialData.myHistory || [],
                historyTotal: (r.data.initialData.myHistory || []).length,
                view: 'complete',
                completionMessage: r.message,
                isDataFresh: true, // æœ€æ–°ãƒ‡ãƒ¼ã‚¿å—ä¿¡æ¸ˆã¿
              });
            } else {
              setState({
                view: 'complete',
                completionMessage: r.message,
                isDataFresh: false, // å†èª­ã¿è¾¼ã¿å¿…è¦
              });
            }
          } else {
            showInfo(r.message || 'äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(handleServerError)
        .makeReservationAndGetLatestData(p);
    },

    /** äºˆç´„ç·¨é›†ç”»é¢ã«é·ç§»ã—ã¾ã™ï¼ˆäºˆç´„ãƒ‡ãƒ¼ã‚¿ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—æ¸ˆã¿ï¼‰ */
    goToEditReservation: d => {
      // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã¯æ—¢ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—æ¸ˆã¿ãªã®ã§ã€ç›´æ¥ç·¨é›†ç”»é¢ã«é·ç§»
      const reservation = appState.myBookings.find(
        booking => booking.reservationId === d.reservationId && booking.classroom === d.classroom,
      );

      if (reservation) {
        const editingDetails = {
          reservationId: reservation.reservationId,
          classroom: reservation.classroom,
          date: reservation.date,
          venue: reservation.venue,
          chiselRental: reservation.chiselRental || false,
          firstLecture: reservation.firstLecture || false,
          startTime: reservation.startTime || '',
          endTime: reservation.endTime || '',
          workInProgress: reservation.workInProgress || '',
          order: reservation.order || '',
          messageToTeacher: reservation.message || '',
          materialInfo: reservation.materialInfo || '',
        };
        setState({ view: 'editReservation', editingReservationDetails: editingDetails });
      } else {
        showInfo('äºˆç´„æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      }
    },

    /** äºˆç´„æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã™ */
    updateReservation: () => {
      const d = appState.editingReservationDetails;
      const p = {
        reservationId: d.reservationId,
        classroom: d.classroom,
        studentId: appState.currentUser.studentId,
        chiselRental: document.getElementById('option-rental')?.checked || false,
        firstLecture: document.getElementById('option-first-lecture')?.checked || false,
        startTime: document.getElementById('res-start-time')?.value || '',
        endTime: document.getElementById('res-end-time')?.value || '',
        workInProgress: document.getElementById('wip-input').value,
        order: document.getElementById('order-input').value,
        messageToTeacher: document.getElementById('message-input').value,
        materialInfo: document.getElementById('material-input')?.value || '',
      };
      showLoading('booking');
      google.script.run
        .withSuccessHandler(r => {
          hideLoading();
          if (r.success) {
            if (r.data) {
              setState({
                ...r.data.initialData,
                myBookings: r.data.myBookings || [],
                history: r.data.initialData.myHistory || [],
                historyTotal: (r.data.initialData.myHistory || []).length,
                view: 'dashboard',
                isDataFresh: true, // æœ€æ–°ãƒ‡ãƒ¼ã‚¿å—ä¿¡æ¸ˆã¿
              });
            } else {
              setState({
                view: 'dashboard',
                isDataFresh: false, // å†èª­ã¿è¾¼ã¿å¿…è¦
              });
            }
            showInfo(r.message || 'äºˆç´„å†…å®¹ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚', 'æ›´æ–°å®Œäº†');
          } else {
            showInfo(r.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(handleServerError)
        .updateReservationDetailsAndGetLatestData(p);
    },

    /** ä¼šè¨ˆç”»é¢ã«é·ç§»ã—ã¾ã™ï¼ˆäºˆç´„ãƒ‡ãƒ¼ã‚¿ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—æ¸ˆã¿ï¼‰ */
    goToAccounting: d => {
      // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã¯æ—¢ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—æ¸ˆã¿ãªã®ã§ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®ã¿èª­ã¿è¾¼ã¿
      const reservationId = d.reservationId;
      const cachedData = loadAccountingCache(reservationId);

      // åŸºæœ¬çš„ãªäºˆç´„æƒ…å ±ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—
      const reservation = appState.myBookings.find(booking => booking.reservationId === reservationId);

      if (reservation) {
        const baseDetails = {
          firstLecture: reservation.firstLecture || false,
          chiselRental: reservation.chiselRental || false,
          startTime: reservation.startTime || null,
          endTime: reservation.endTime || null,
        };

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã¨åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸ (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å„ªå…ˆ)
        const initialValues = { ...baseDetails, ...cachedData };

        setState({
          view: 'accounting',
          accountingReservation: d,
          accountingInitialValues: initialValues,
        });
      } else {
        showInfo('äºˆç´„æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      }
    },

    /** å±¥æ­´ã‹ã‚‰ä¼šè¨ˆè©³ç´°ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤ºã—ã¾ã™ï¼ˆãƒ‡ãƒ¼ã‚¿ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—æ¸ˆã¿ï¼‰ */
    showHistoryAccounting: d => {
      const details = JSON.parse(d.details);
      const tuitionItemsHtml = details.tuition.items
        .map(i => `<li>${i.name}: ${i.price.toLocaleString()}å††</li>`)
        .join('');
      const salesItemsHtml = details.sales.items.map(i => `<li>${i.name}: ${i.price.toLocaleString()}å††</li>`).join('');
      const message = `
            <div class="p-4 bg-brand-light rounded-lg text-left space-y-4 text-base">
                ${tuitionItemsHtml ? `<b>æˆæ¥­æ–™</b><ul class="list-disc list-inside">${tuitionItemsHtml}</ul>` : ''}
                ${salesItemsHtml ? `<b class="mt-1 inline-block">è²©å£²</b><ul class="list-disc list-inside">${salesItemsHtml}</ul>` : ''}
                <div class="font-bold mt-1 pt-1 border-t">åˆè¨ˆ: ${details.grandTotal.toLocaleString()}å††</div><div class="text-right text-sm pt-1">æ”¯æ‰•æ–¹æ³•: ${details.paymentMethod}</div></div>`;
      showInfo(message, 'ä¼šè¨ˆè¨˜éŒ²');
    },

    /** ä¼šè¨ˆç”»é¢ã§ææ–™å…¥åŠ›è¡Œã‚’è¿½åŠ ã—ã¾ã™ */
    addMaterialRow: () => {
      const container = document.getElementById('materials-container');
      const newIndex = container.querySelectorAll('div[data-material-row-index]').length;
      const newRow = document.createElement('div');
      newRow.className = 'mt-4 pt-4 border-t border-ui-border-light';
      newRow.dataset.materialRowIndex = newIndex;
      newRow.innerHTML = buildMaterialRow(newIndex);
      container.appendChild(newRow);
    },

    /** ä¼šè¨ˆç”»é¢ã§ãã®ä»–è²©å£²å“å…¥åŠ›è¡Œã‚’è¿½åŠ ã—ã¾ã™ */
    addOtherSalesRow: () => {
      const container = document.getElementById('other-sales-container');
      const newIndex = container.querySelectorAll('div[data-other-sales-row]').length;
      // getOtherSalesRowHtmlãŒè¿”ã™HTMLæ–‡å­—åˆ—ã‚’ã€ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ä»‹ã•ãšç›´æ¥ã‚³ãƒ³ãƒ†ãƒŠã®æœ«å°¾ã«è¿½åŠ ã™ã‚‹
      container.insertAdjacentHTML('beforeend', getOtherSalesRowHtml(newIndex));
    },

    /** ä¼šè¨ˆç”»é¢ã§åˆè¨ˆé‡‘é¡ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ */
    copyGrandTotal: button => {
      const totalText = document.getElementById('grand-total-amount')?.textContent || '';
      const numericTotal = totalText.replace(/[^0-9-]/g, '');
      actionHandlers.copyToClipboard(button, numericTotal);
    },

    /** æŒ‡å®šã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ */
    copyToClipboard: (button, text) => {
      const textToCopy = text || button.dataset.copyText;
      const textArea = document.createElement('textarea');
      textArea.style.position = 'fixed';
      textArea.style.top = '-9999px';
      textArea.style.left = '-9999px';
      textArea.value = textToCopy.replace(/,/g, '');
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          const originalText = button.textContent;
          button.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ!';
          setTimeout(() => {
            button.textContent = originalText;
          }, 2000);
        } else {
          showInfo('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      } catch (err) {
        showInfo('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯é–‹ç™ºç’°å¢ƒã§ã®ã¿å‡ºåŠ›
        if (typeof console !== 'undefined' && console.error) {
          console.error('Clipboard copy failed:', err);
        }
      }
      document.body.removeChild(textArea);
    },

    /** å‚åŠ è¨˜éŒ²ã‚’è¿½åŠ ã§èª­ã¿è¾¼ã¿ã¾ã™ï¼ˆçµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ï¼‰ */
    loadMoreHistory: () => {
      const newCount =
        (appState.recordsToShow || UI?.HISTORY_INITIAL_RECORDS || 10) + (UI?.HISTORY_LOAD_MORE_RECORDS || 10);
      setState({ recordsToShow: newCount });
    },

    /** æ–°è¦äºˆç´„ã®ãŸã‚ã®æ•™å®¤é¸æŠç”»é¢ã«é·ç§»ã—ã¾ã™ */
    goToClassroomSelection: () => {
      // æ•™å®¤ãƒªã‚¹ãƒˆã¯ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«å–å¾—ã—ãŸã€Œçµ±åˆå®šæ•°ã€ã‹ã‚‰è¡¨ç¤ºã™ã‚‹ãŸã‚ã€
      // ã“ã“ã§ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒã‚§ãƒƒã‚¯ã¯ä¸è¦ã§ã™ã€‚
      if (appState.constants && appState.constants.CLASSROOMS) {
        setState({ view: 'classroomSelection' });
      } else {
        // ä¸‡ãŒä¸€ã€å®šæ•°ãŒèª­ã¿è¾¼ã‚ã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
        showInfo('æ•™å®¤æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä¸€åº¦ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™ã€‚');
        actionHandlers.goBackToDashboard();
      }
    },

    /** ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ç”»é¢ã«é·ç§»ã—ã¾ã™ */
    goToEditProfile: () => {
      // ãƒ‡ãƒ¼ã‚¿ãŒå¤ãã€ã‹ã¤æ›´æ–°ä¸­ã§ãªã‘ã‚Œã°ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      if (!appState.isDataFresh && !appState._dataUpdateInProgress) {
        updateAppStateFromCache('editProfile');
      } else {
        // æ–°ã—ã„dispatchãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨
        if (window.stateManager) {
          window.stateManager.dispatch({
            type: 'CHANGE_VIEW',
            payload: { view: 'editProfile' },
          });
        } else {
          setState({ view: 'editProfile' });
        }
      }
    },

    /**
     * ã‚¹ãƒ­ãƒƒãƒˆæƒ…å ±ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã—ã¦çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹çµ±åˆé–¢æ•°
     * æ•™å®¤é¸æŠç”»é¢ã§åˆ©ç”¨ã™ã‚‹ç©ºãæ æƒ…å ±ã‚’æœ€æ–°åŒ–ã—ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®Ÿè¡Œ
     * @param {Function} [onComplete] - ã‚¹ãƒ­ãƒƒãƒˆæ›´æ–°å®Œäº†æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
     */
    refreshAndUpdateSlots: function (onComplete) {
      google.script.run
        .withSuccessHandler(response => {
          debugLog('ã‚¹ãƒ­ãƒƒãƒˆå–å¾—å®Œäº† - success: ' + response.success);

          if (response.success && response.data && response.data.slots) {
            const classroomsFromSlots = [...new Set(response.data.slots.map(slot => slot.classroom))];
            debugLog('å–å¾—ã—ãŸã‚¹ãƒ­ãƒƒãƒˆ: ' + response.data.slots.length + 'ä»¶');

            setState({
              slots: response.data.slots,
              classrooms: classroomsFromSlots,
            });
          } else {
            debugLog('ã‚¹ãƒ­ãƒƒãƒˆå–å¾—ã«å¤±æ•—');
          }

          if (onComplete) onComplete(response);
        })
        .withFailureHandler(error => {
          debugLog('ã‚¹ãƒ­ãƒƒãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message);
          if (onComplete) onComplete({ success: false, message: error.message });
        })
        .getBatchData(['slots'], appState.currentUser.phone);
    },

    /** æ•™å®¤ã‚’é¸æŠã—ã€äºˆç´„æ ä¸€è¦§ç”»é¢ã«é·ç§»ã—ã¾ã™ */
    selectClassroom: d => {
      if (!d || !d.classroomName) {
        // slotsã¯refreshAndUpdateSlotså†…ã§æ›´æ–°æ¸ˆã¿ã€‚ã“ã“ã§ã¯ç”»é¢é·ç§»ã¨æ•™å®¤é¸æŠã®çŠ¶æ…‹ã‚’ã‚»ãƒƒãƒˆã€‚
        setState({ selectedClassroom: d.classroomName, view: 'booking' });
      } else {
        showInfo('äºˆç´„æ ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      }
    },

    /** äºˆç´„æ ã‚’é¸æŠã—ã€äºˆç´„ç¢ºèªç”»é¢ã«é·ç§»ã—ã¾ã™ */
    bookSlot: d => {
      const foundSlot = appState.slots.find(s => s.classroom === d.classroom && s.date === d.date);
      if (foundSlot) {
        // ç©ºå¸­æ•°ã«åŸºã¥ã„ã¦isFullçŠ¶æ…‹ã‚’ç¢ºå®Ÿã«è¨­å®š
        const isFullSlot =
          foundSlot.isFull ||
          foundSlot.availableSlots === 0 ||
          (typeof foundSlot.morningSlots !== 'undefined' &&
            foundSlot.morningSlots === 0 &&
            foundSlot.afternoonSlots === 0);
        setState({
          selectedSlot: {
            ...foundSlot,
            isFull: isFullSlot,
          },
          view: 'newReservation',
        });
      } else {
        showInfo('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚é¸æŠã—ãŸäºˆç´„æ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
      }
    },

    /** ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚Šã¾ã™ï¼ˆé›»è©±ç•ªå·å…¥åŠ›å€¤ã‚’ä¿å­˜ï¼‰ */
    goBackToLogin: () => {
      const phoneInput = document.getElementById('phone');
      const loginPhone = phoneInput ? phoneInput.value : appState.loginPhone;
      setState({ view: 'login', loginPhone: loginPhone });
    },

    /** ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰ã«é·ç§»ï¼ˆåˆ¥åï¼‰ */
    goBackToDashboard: () => actionHandlers.goToDashboard(),

    /** ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰ã«é·ç§» */
    goToDashboard: () => {
      if (!appState.isDataFresh && !appState._dataUpdateInProgress) {
        updateAppStateFromCache('dashboard');
      } else {
        setState({ view: 'dashboard' });
      }
    },

    /** äºˆç´„æ ä¸€è¦§ç”»é¢ã«æˆ»ã‚Šã¾ã™ */
    goBackToBooking: () => {
      if (appState.view === 'accounting') {
        showConfirm({
          title: 'ç¢ºèª',
          message: 'ä¼šè¨ˆå…¥åŠ›ã‚’ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ<br>ï¼ˆå…¥åŠ›å†…å®¹ã¯ã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™ï¼‰',
          confirmText: 'ã¯ã„',
          cancelText: 'ã„ã„ãˆ',
          confirmColorClass: DesignConfig.colors.danger,
          onConfirm: () => {
            clearAccountingCache(appState.accountingReservation.reservationId);
            setState({
              view: 'booking',
              selectedClassroom:
                appState.selectedSlot?.classroom ||
                appState.accountingReservation?.classroom ||
                appState.editingReservationDetails?.classroom,
            });
          },
        });
      } else {
        setState({
          view: 'booking',
          selectedClassroom:
            appState.selectedSlot?.classroom ||
            appState.accountingReservation?.classroom ||
            appState.editingReservationDetails?.classroom,
        });
      }
    },

    /** ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ç¢ºèªãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†ã§ã™ */
    modalConfirm: () => {
      ModalManager.executeCallback();
      hideModal();
    },

    /** ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†ã§ã™ */
    modalCancel: () => hideModal(),
  };

  /**
   * ä¼šè¨ˆã®ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
   */
  actionHandlers.showAccountingConfirmation = () => {
    const accountingDetails = calculateAccountingDetails();
    if (!accountingDetails || accountingDetails.grandTotal <= 0) {
      showInfo('åˆè¨ˆé‡‘é¡ãŒ0å††ã§ã™ã€‚é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    const message = `
        <div class="p-4 bg-brand-light rounded-lg text-left space-y-4 text-base" id="modal-accounting-form">
            <div>
                <span class="font-bold">åˆè¨ˆé‡‘é¡:</span> ${accountingDetails.grandTotal.toLocaleString()}å††
                <button data-action="copyGrandTotal" class="ml-2 text-sm bg-action-secondary-bg active:bg-action-secondary-hover text-action-secondary-text font-bold px-2 py-1 rounded">ã‚³ãƒ”ãƒ¼</button>
            </div>
            <div>
                <span class="font-bold">æ”¯æ‰•ã„æ–¹æ³•:</span>
                <div class="mt-2 space-y-3">
                    ${getPaymentOptionsHtml()}
                </div>
            </div>
            <div class="mt-4">
                <button id="confirm-payment-button" data-action="confirmAndPay" class="w-full bg-action-primary-bg text-action-primary-text font-bold py-2 rounded disabled:bg-brand-muted" disabled>ã“ã®å†…å®¹ã§æ”¯æ‰•ã„ã¾ã—ãŸ</button>
            </div>
            <p class="text-red-700 font-bold mt-2 text-center">å¿…ãšãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­</p>
        </div>
    `;
    showModal({
      title: 'ãŠä¼šè¨ˆ',
      message: message,
      showCancel: true,
      cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
      onConfirm: null,
    });
  };

  /**
   * ã€Œã“ã®å†…å®¹ã§æ”¯æ‰•ã„ã¾ã—ãŸã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
   */
  actionHandlers.confirmAndPay = () => {
    const reservationId = appState.accountingReservation.reservationId;
    // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®æ”¯æ‰•ã„æ–¹æ³•ã‚’å–å¾—
    const modalForm = document.getElementById('modal-accounting-form');
    let paymentMethod = PAYMENT.CASH;
    if (modalForm) {
      const selected = modalForm.querySelector('input[name="payment-method"]:checked');
      if (selected) paymentMethod = selected.value;
    }

    // --- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«é€ä¿¡ã™ã‚‹ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ ---
    const form = document.getElementById('accounting-form');
    const userInput = {
      paymentMethod: paymentMethod,
      tuitionItems: [],
      salesItems: [],
      timeBased: null,
    };

    // æˆæ¥­æ–™é …ç›®ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰
    form.querySelectorAll(`input[type="checkbox"][data-item-type="${C.itemTypes.TUITION}"]:checked`).forEach(cb => {
      userInput.tuitionItems.push(cb.dataset.itemName);
    });

    // æ™‚é–“åˆ¶æˆæ¥­æ–™
    if (document.getElementById('start-time')) {
      userInput.timeBased = {
        startTime: document.getElementById('start-time').value,
        endTime: document.getElementById('end-time').value,
        breakMinutes: parseInt(document.getElementById('break-time')?.value || 0, 10),
        discountMinutes: parseInt(document.getElementById('discount-selector')?.value || 0, 10),
      };
    }

    // ç‰©è²©ãƒ»ææ–™è²»é …ç›®
    const materialContainer = document.getElementById('materials-container');
    if (materialContainer) {
      materialContainer.querySelectorAll('div[data-material-row-index]').forEach((row, index) => {
        const name = document.getElementById(`material-type-${index}`)?.value;
        const priceText = document.getElementById(`material-price-${index}`)?.textContent || '0';
        const price = parseInt(priceText.replace(/[^0-9]/g, ''), 10);
        if (name && price > 0) userInput.salesItems.push({ name: name, price: price });
      });
    }

    // ç‰©è²©é …ç›®ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰
    form.querySelectorAll(`input[type="checkbox"][data-item-type="${C.itemTypes.SALES}"]:checked`).forEach(cb => {
      userInput.salesItems.push({ name: cb.dataset.itemName });
    });

    form.querySelectorAll('div[data-other-sales-row]').forEach((row, index) => {
      const name = document.getElementById(`other-sales-name-${index}`)?.value.trim();
      const price = document.getElementById(`other-sales-price-${index}`)?.value;
      if (name && price) userInput.salesItems.push({ name: name, price: Number(price) });
    });
    // --- ã“ã“ã¾ã§ ---

    const payload = {
      reservationId: appState.accountingReservation.reservationId,
      classroom: appState.accountingReservation.classroom,
      studentId: appState.currentUser.studentId,
      userInput: userInput,
    };

    showLoading('accounting');
    google.script.run
      .withSuccessHandler(r => {
        if (r.success) {
          clearAccountingCache(reservationId); // <-- ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤
          hideModal(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
          hideLoading();
          setState({
            view: 'complete',
            completionMessage: 'ä¼šè¨ˆæƒ…å ±ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚',
            accountingReservation: appState.accountingReservation,
            isDataFresh: false, // æœ€æ–°ã‚¹ãƒ­ãƒƒãƒˆæƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚
          });
        } else {
          hideLoading();
          showInfo(r.message || 'ä¼šè¨ˆæƒ…å ±ã®è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      })
      .withFailureHandler(handleServerError)
      .saveAccountingDetails(payload);
  };

  // =================================================================
  // --- Main Application Logic ---
  // -----------------------------------------------------------------
  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã€ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã€çŠ¶æ…‹ç®¡ç†ã€ç”»é¢æç”»ãªã©ã€
  // å…¨ä½“ã‚’åˆ¶å¾¡ã™ã‚‹ã‚³ã‚¢ã¨ãªã‚‹é–¢æ•°ç¾¤ã§ã™ã€‚
  // =================================================================

  /**
   * æ³¨æ„: setStateé–¢æ•°ã¯StateManagerã‚·ã‚¹ãƒ†ãƒ ã«çµ±åˆã•ã‚Œã¾ã—ãŸ
   * æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã§ã¯ stateManager.dispatch() ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
   *
   * ä¸‹ä½äº’æ›æ€§ã®ãŸã‚ã®setStateé–¢æ•°ã¯12_WebApp_StateManager.htmlã§å®šç¾©ã•ã‚Œã€
   * è‡ªå‹•çš„ã«StateManagerã®dispatch()ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¾ã™
   */

  /**
   * ãƒãƒƒãƒå‡¦ç†ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦appStateã‚’æ›´æ–°
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®äºˆç´„ãƒ»å±¥æ­´ãƒ»ã‚¹ãƒ­ãƒƒãƒˆæƒ…å ±ã‚’ä¸€æ‹¬å–å¾—ã—ã€æŒ‡å®šã•ã‚ŒãŸãƒ“ãƒ¥ãƒ¼ã«é·ç§»
   * @param {string} targetView - ãƒ‡ãƒ¼ã‚¿å–å¾—å¾Œã«é·ç§»ã—ãŸã„ãƒ“ãƒ¥ãƒ¼å
   */
  function updateAppStateFromCache(targetView) {
    if (!appState.currentUser || !appState.currentUser.phone) {
      if (targetView) {
        setState({ view: targetView });
      }
      return;
    }

    // æ›´æ–°ä¸­ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
    setState({ _dataUpdateInProgress: true });

    showLoading('æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
    google.script.run
      .withSuccessHandler(response => {
        hideLoading();
        setState({ _dataUpdateInProgress: false }); // ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢

        if (response.success && response.userFound) {
          // ãƒãƒƒãƒå‡¦ç†çµæœã‹ã‚‰appStateã‚’æ›´æ–°
          const newAppState = processInitialData(
            response.data.initial,
            appState.currentUser.phone,
            response.data.slots,
          );
          // ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã¨é‡è¦ãªçŠ¶æ…‹ã¯ä¿æŒã€ãŸã ã—targetViewãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãã¡ã‚‰ã‚’å„ªå…ˆ
          const preservedState = {
            view: targetView || appState.view,
            selectedClassroom: appState.selectedClassroom,
            selectedSlot: appState.selectedSlot,
            editingReservationDetails: appState.editingReservationDetails,
            accountingReservation: appState.accountingReservation,
            isDataFresh: true, // æ–°é®®ãªãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã“ã¨ã‚’è¨˜éŒ²
          };
          setState({ ...newAppState, ...preservedState }); // setStateã«çµ±åˆã—ã€çŠ¶æ…‹æ›´æ–°ã¨å†æç”»ã‚’ä¸€å…ƒåŒ–
        } else {
          // å¤±æ•—æ™‚ã‚‚setStateã‚’ä»‹ã—ã¦çŠ¶æ…‹ã‚’æ›´æ–°ã—ã€å†æç”»ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹
          setState({
            _dataUpdateInProgress: false,
            view: targetView || appState.view,
          });
          showInfo(response.message || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      })
      .withFailureHandler(err => {
        hideLoading();
        setState({
          _dataUpdateInProgress: false,
          view: targetView || appState.view,
        }); // ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
        handleServerError(err);
        // setStateãŒrenderã‚’å‘¼ã³å‡ºã™ã®ã§ã€ã“ã“ã§ã®render()ã¯ä¸è¦
      })
      .getBatchData(['initial', 'slots'], appState.currentUser.phone);
  }

  /**
   * ç¾åœ¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã«åŸºã¥ã„ã¦ã€é©åˆ‡ãªãƒ“ãƒ¥ãƒ¼ã‚’æç”»ã™ã‚‹
   * ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®å¿…è¦æ€§ã‚’åˆ¤å®šã—ã€å¿…è¦ã«å¿œã˜ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—å¾Œã«å†æç”»
   * appState.viewã®å€¤ã«å¿œã˜ã¦å¯¾å¿œã™ã‚‹ãƒ“ãƒ¥ãƒ¼é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦UIã‚’æ›´æ–°
   */
  function render() {
    // appStateã®å®‰å…¨ãªå‚ç…§ç¢ºèª
    if (!window.appState) {
      console.warn('render(): appStateãŒæœªåˆæœŸåŒ–ã®ãŸã‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
      return;
    }

    console.log('ğŸ¨ renderå®Ÿè¡Œ:', window.appState.view);

    // ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’é¿ã‘ã‚‹ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿æ›´æ–°å‡¦ç†ã¯å‰Šé™¤
    // å˜ç´”ã«ãƒ“ãƒ¥ãƒ¼ã‚’æç”»ã™ã‚‹ã ã‘

    let v = '';
    switch (window.appState.view) {
      case 'login':
        v = getLoginView();
        break;
      case 'register':
        v = getRegisterView(window.appState.registrationPhone);
        break;
      case 'registrationStep2':
        v = getRegistrationStep2View();
        break;
      case 'registrationStep3':
        v = getRegistrationStep3View();
        break;
      case 'dashboard':
        v = getDashboardView();
        break;
      case 'classroomSelection':
        v = getClassroomSelectionView();
        break;
      case 'editProfile':
        v = getEditProfileView();
        break;
      case 'booking':
        v = getBookingView(window.appState.selectedClassroom);
        break;
      case 'newReservation':
        v = getReservationFormView('new');
        break;
      case 'editReservation':
        v = getReservationFormView('edit');
        break;
      case 'accounting':
        v = getAccountingView();
        break;
      case 'complete':
        v = getCompleteView(window.appState.completionMessage);
        break;
      case 'userSearch':
        v = getUserSearchView();
        break;
    }
    document.getElementById('view-container').innerHTML = `<div class="fade-in">${v}</div>`;

    if (window.appState.view === 'accounting') {
      requestAnimationFrame(() => {
        calculateAccountingDetails();
        setupAccountingFormListeners(window.appState.accountingReservation.reservationId);
      });
    }

    window.scrollTo(0, 0);
  }

  /**
   * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ç‚¹ã§ã™ã€‚
   * ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å®Ÿè¡Œã•ã‚Œã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
   */
  window.onload = function () {
    const app = document.getElementById('app');

    // ä¼šè¨ˆè¨ˆç”»é¢ã§ã®å…¥åŠ›å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å†è¨ˆç®—
    ['input', 'change'].forEach(eventName => {
      app.addEventListener(eventName, e => {
        if (appState.view === 'accounting' && e.target.closest('#accounting-form')) {
          calculateAccountingDetails();
        }
        // changeã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã®ã¿ã€æ”¯æ‰•ã„æ–¹æ³•é¸æŠã‚’ãƒã‚§ãƒƒã‚¯
        if (eventName === 'change' && e.target.matches('#modal-accounting-form input[name="payment-method"]')) {
          document.getElementById('confirm-payment-button')?.removeAttribute('disabled');
        }
      });
    });

    // ã‚¢ãƒ—ãƒªå…¨ä½“ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ•æ‰
    app.addEventListener('click', e => {
      const targetButton = e.target.closest('button');
      if (targetButton?.dataset.action) {
        const { action, ...data } = targetButton.dataset;
        if (action === 'copyToClipboard' || action === 'copyGrandTotal') {
          actionHandlers[action](targetButton);
        } else if (actionHandlers[action]) {
          actionHandlers[action](data);
        }
      }
    });

    // NF-04: æœ¨å½«ã‚ŠçµŒé¨“ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å¤‰æ›´ã‚’ç›£è¦–
    app.addEventListener('change', e => {
      if (e.target.closest('#experience-radio-group')) {
        const container = document.getElementById('past-work-container');
        if (container) {
          if (e.target.value === 'ã¯ã˜ã‚ã¦ï¼') {
            container.classList.add('hidden');
          } else {
            container.classList.remove('hidden');
          }
        }
      }
    });
  };
</script>
