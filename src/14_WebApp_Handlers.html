<script>
  /**
   * =================================================================
   * ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: 14_WebApp_Handlers.html
   * ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘: 1.5
   * ã€å½¹å‰²ã€‘: WebAppã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«ãŠã‘ã‚‹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œã«å¿œã˜ãŸ
   * ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ã‚’é›†ç´„ã—ã¾ã™ã€‚
   * ã€æ§‹æˆã€‘: 14ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®ã†ã¡ã®14ç•ªç›®
   * ã€v1.5ã§ã®å¤‰æ›´ç‚¹ã€‘:
   * - åˆ¶ä½œãƒ¡ãƒ¢ç·¨é›†æ©Ÿèƒ½ã®å¼·åŒ–: ãã‚ãã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨äºˆç´„ã‚·ãƒ¼ãƒˆã®ä¸¡æ–¹ã«ä¿å­˜ã™ã‚‹ã‚ˆã†æ”¹å–„ã€‚
   * - ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ã®æ”¹å–„: æˆåŠŸæ™‚ã«æœ€æ–°å±¥æ­´ã§ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çŠ¶æ…‹ã‚’æ›´æ–°ã€‚
   * - ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š: é©åˆ‡ãªãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã¨æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¿½åŠ ã€‚
   * =================================================================
   */

  // =================================================================
  // --- Action Handlers ---
  // -----------------------------------------------------------------
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œï¼ˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãªã©ï¼‰ã‚’èµ·ç‚¹ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹
  // å…¨ã¦ã®å‡¦ç†ã‚’å®šç¾©ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚
  // å„ã‚­ãƒ¼ãŒ data-action å±æ€§ã«å¯¾å¿œã—ã¾ã™ã€‚
  // =================================================================
  const actionHandlers = {
    /** ãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯æ–°è¦ç™»éŒ²ã‚’é–‹å§‹ã—ã¾ã™ */
    login: () => {
      const p = document.getElementById('phone').value;
      if (!p) return showInfo('é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      const n = p.replace(/[â€ï¼-]/g, '').replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 65248));
      showLoading('login');

      // ç’°å¢ƒåˆ†å²: ãƒ†ã‚¹ãƒˆç’°å¢ƒã®å ´åˆã¯ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
      if (isTestEnvironment) {
        console.log('ğŸ§ª Using mock login data');
        setTimeout(() => {
          hideLoading();
          setState({
            currentUser: getEnvironmentData('currentUser', { displayName: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼', phone: n }),
            slots: getEnvironmentData('slots', []),
            myBookings: getEnvironmentData('myBookings', []),
            accountingMaster: getEnvironmentData('accountingMaster', {}),
            history: getEnvironmentData('history', []),
            historyTotal: getEnvironmentData('history', []).length,
            recordsToShow: 20,
            view: 'dashboard', // ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç›´æ¥é·ç§»
          });
        }, 300);
        return;
      }

      // æœ¬ç•ªç’°å¢ƒ: å®Ÿéš›ã®GASé–¢æ•°ã‚’å‘¼ã³å‡ºã—
      google.script.run
        .withSuccessHandler(r => {
          hideLoading();
          if (r.success) {
            // èªè¨¼ã¨ãƒ‡ãƒ¼ã‚¿å–å¾—ãŒä¸€åº¦ã§å®Œäº†ã™ã‚‹ãŸã‚ã€ã“ã“ã§å…¨ã¦ã®çŠ¶æ…‹ã‚’è¨­å®šã™ã‚‹
            setState({
              currentUser: r.user,
              slots: r.initialData.availableSlots,
              myBookings: r.initialData.myBookings,
              accountingMaster: r.initialData.accountingMaster,
              history: r.initialData.myHistory,
              historyTotal: r.initialData.myHistory.length,
              recordsToShow: 20,
              view: 'classroomSelect',
            });
          } else if (r.commandRecognized) {
            // ç‰¹æ®Šã‚³ãƒãƒ³ãƒ‰èªè­˜æ™‚ã®ãƒ•ãƒ­ãƒ¼ã€‚é›»è©±ç•ªå·æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆè¡¨ç¤ºã¸
            setState({
              view: 'noPhoneUserSelect',
              noPhoneUsers: [],
              selectedNoPhoneUser: null,
              searchAttempted: false,
            });
          } else {
            // èªè¨¼å¤±æ•—æ™‚
            if (r.phoneForRegistration) {
              // é›»è©±ç•ªå·ã®å½¢å¼ã¯æ­£ã—ã„ãŒæœªç™»éŒ²ã®å ´åˆ
              setState({ view: 'register', phoneForRegistration: n });
            } else {
              // é›»è©±ç•ªå·ã®å½¢å¼è‡ªä½“ãŒä¸æ­£ãªå ´åˆãªã©
              showInfo(
                r.message || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é›»è©±ç•ªå·ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„ã‹ã€å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚',
                'ã‚¨ãƒ©ãƒ¼',
              );
            }
          }
        })
        .withFailureHandler(handleServerError)
        .authenticateUser(n);
    },

    /** æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¾ã™ */
    register: () => {
      const r = document.getElementById('reg-realname').value;
      let n = document.getElementById('reg-nickname').value.trim();
      if (!r) return showInfo('ãŠåå‰ï¼ˆæœ¬åï¼‰ã¯å¿…é ˆã§ã™ã€‚');
      if (!n) n = r;
      showLoading('login');
      google.script.run
        .withSuccessHandler(res => {
          hideLoading();
          if (res.success) {
            // ç™»éŒ²ã¨ãƒ‡ãƒ¼ã‚¿å–å¾—ãŒä¸€åº¦ã§å®Œäº†ã™ã‚‹ãŸã‚ã€ã“ã“ã§å…¨ã¦ã®çŠ¶æ…‹ã‚’è¨­å®šã™ã‚‹
            setState({
              currentUser: res.user,
              slots: res.initialData.availableSlots,
              myBookings: res.initialData.myBookings,
              accountingMaster: res.initialData.accountingMaster,
              history: res.initialData.myHistory,
              historyTotal: res.initialData.myHistory.length,
              recordsToShow: 20,
              view: 'classroomSelect',
            });
          } else {
            showInfo(res.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(handleServerError)
        .registerNewUser({
          phone: document.getElementById('reg-phone').value,
          realName: r,
          nickname: n,
        });
    },

    /** ãã‚ãã‚«ãƒ¼ãƒ‰ã®ç·¨é›†ãƒœã‚¿ãƒ³ */
    editHistoryMemo: d => {
      const item = appState.history.find(h => h.reservationId === d.reservationId);
      if (!item) return;

      const originalMemo = item.workInProgress;

      showConfirm({
        title: 'åˆ¶ä½œãƒ¡ãƒ¢ã®ç·¨é›†',
        message: getMemoEditModalHtml(item),
        confirmText: 'ä¿å­˜ã™ã‚‹',
        cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
        confirmColorClass: DesignConfig.colors.primary,
        onConfirm: () => {
          const newMemo = document.getElementById('memo-edit-textarea').value;

          // æ¥½è¦³çš„UI: ã¾ãšãƒ•ãƒ­ãƒ³ãƒˆã®è¡¨ç¤ºã‚’æ›´æ–°
          item.workInProgress = newMemo;
          setState({ history: [...appState.history] });

          showLoading();

          // ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã—ã€æœ€æ–°ã®å±¥æ­´ã‚’å–å¾—
          google.script.run
            .withSuccessHandler(result => {
              hideLoading();
              if (result.success) {
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã§çŠ¶æ…‹ã‚’æ›´æ–°
                setState({
                  history: result.history || appState.history,
                  historyTotal: result.total || appState.historyTotal,
                });
                showInfo('åˆ¶ä½œãƒ¡ãƒ¢ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚', 'ä¿å­˜å®Œäº†');
              } else {
                // ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å…ƒã«æˆ»ã™
                item.workInProgress = originalMemo;
                setState({ history: [...appState.history] });
                showInfo(result.message || 'ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'ã‚¨ãƒ©ãƒ¼');
              }
            })
            .withFailureHandler(err => {
              hideLoading();
              // é€šä¿¡ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å…ƒã«æˆ»ã™
              item.workInProgress = originalMemo;
              setState({ history: [...appState.history] });
              handleServerError(err);
            })
            .updateMemo(d.reservationId, d.sheetName, newMemo, appState.currentUser.studentId);
        },
      });
    },

    /** ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã™ */
    saveProfile: () => {
      const r = document.getElementById('edit-realname').value;
      let n = document.getElementById('edit-nickname').value.trim();
      if (!r) return showInfo('ãŠåå‰ï¼ˆæœ¬åï¼‰ã¯å¿…é ˆã§ã™ã€‚');
      if (!n) n = r;

      // NF-01: é›»è©±ç•ªå·å…¥åŠ›æ¬„ãŒã‚ã‚Œã°ãã®å€¤ã‚‚å–å¾—
      const phoneInput = document.getElementById('edit-phone');
      const phone = phoneInput ? phoneInput.value : appState.currentUser.phone; // é›»è©±ç•ªå·å…¥åŠ›æ¬„ãŒãªã‘ã‚Œã°æ—¢å­˜ã®é›»è©±ç•ªå·ã‚’ä½¿ç”¨

      const u = { ...appState.currentUser, realName: r, displayName: n, phone: phone }; // é›»è©±ç•ªå·ã‚‚è¿½åŠ 
      showLoading();
      google.script.run
        .withSuccessHandler(res => {
          hideLoading();
          if (res.success) {
            // â˜…â˜…â˜… å¤‰æ›´ç‚¹ â˜…â˜…â˜…
            // æˆ»ã‚Šå€¤ã®æ›´æ–°ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã§ãƒ­ãƒ¼ã‚«ãƒ«ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã€
            // è¿½åŠ é€šä¿¡ãªã—ã§ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«é·ç§»ã™ã‚‹
            showInfo('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'æ›´æ–°å®Œäº†');
            setState({ currentUser: res.updatedUser, view: 'classroomSelect' });
          } else {
            showInfo(res.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(handleServerError)
        .updateUserProfile(u);
    },

    /**
     * NF-01: é›»è©±ç•ªå·æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
     */
    searchNoPhoneUser: () => {
      const searchInput = document.getElementById('nickname-search-input');
      const searchTerm = searchInput ? searchInput.value.trim() : ''; // æ¤œç´¢èªã‚’searchTermã«å¤‰æ›´

      if (!searchTerm) {
        return showInfo('ãŠåå‰ï¼ˆæœ¬åï¼‰ã¾ãŸã¯ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      }

      showLoading('login');

      // æ¤œç´¢èªã‹ã‚‰ã‚¹ãƒšãƒ¼ã‚¹ã‚’é™¤å»ã—ã¦å°æ–‡å­—åŒ–ã—ã¦æ¯”è¼ƒã«ä½¿ã†
      const normalizedSearchTerm = searchTerm.replace(/\s+/g, '').toLowerCase();

      google.script.run
        .withSuccessHandler(users => {
          hideLoading();
          // searchName (ã‚¹ãƒšãƒ¼ã‚¹é™¤å»æ¸ˆã¿ãƒ»å°æ–‡å­—åŒ–ã•ã‚ŒãŸçµåˆå) ã‚’ä½¿ã£ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
          const filteredUsers = users.filter(user => user.searchName && user.searchName.includes(normalizedSearchTerm));

          // NF-01: æ¤œç´¢ãŒè©¦è¡Œã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
          setState({ noPhoneUsers: filteredUsers, searchAttempted: true });

          if (filteredUsers.length === 0) {
            // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒ“ãƒ¥ãƒ¼å´ã§è¡¨ç¤º
          }
        })
        .withFailureHandler(handleServerError)
        .searchNoPhoneUsersByFilterForWebApp();
    },

    /**
     * NF-01: æ¤œç´¢çµæœã‹ã‚‰é›»è©±ç•ªå·æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¾ã™ã€‚
     */
    selectNoPhoneUser: d => {
      // ãƒœã‚¿ãƒ³ã«åŸ‹ã‚è¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€ã¾ãšä»®ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä½œæˆ
      const tempUser = {
        studentId: d.studentId,
        realName: d.realName, // ãƒœã‚¿ãƒ³ã®dataå±æ€§ã‹ã‚‰å–å¾—
        displayName: d.nickname, // ãƒœã‚¿ãƒ³ã®dataå±æ€§ã‹ã‚‰å–å¾—
        phone: '', // é›»è©±ç•ªå·ã¯ã¾ã ãªã„ã®ã§ç©º
      };

      showLoading('login');

      // studentIdã‚’ä½¿ã£ã¦ã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰äºˆç´„æƒ…å ±ã‚„å±¥æ­´ãªã©ã®å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(initialData => {
          console.log('[APP] Received initialData:', initialData);
          console.log('[APP] availableSlots check:', initialData.availableSlots);
          hideLoading();
          if (initialData.success) {
            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã¨ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã®åå‰æƒ…å ±ã‚’çµ„ã¿åˆã‚ã›ã¦å®Œå…¨ãªçŠ¶æ…‹ã‚’æ§‹ç¯‰
            setState({
              currentUser: tempUser, // åå‰æƒ…å ±ã‚’å«ã‚€ä»®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
              slots: initialData.availableSlots,
              myBookings: initialData.myBookings,
              accountingMaster: initialData.accountingMaster,
              history: initialData.myHistory,
              historyTotal: initialData.myHistory.length,
              recordsToShow: 20,
              view: 'editProfile', // é›»è©±ç•ªå·ç™»éŒ²ã‚’ä¿ƒã™ãŸã‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ç”»é¢ã¸
            });
          } else {
            showInfo('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(handleServerError)
        .getInitialWebApp_Data(tempUser.studentId);
    },

    /**
     * NF-01: è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã«æ–°è¦ç™»éŒ²ç”»é¢ã¸é·ç§»ã—ã¾ã™ã€‚
     */
    goToRegisterFromNoPhoneSearch: () => {
      // æ–°è¦ç™»éŒ²ç”»é¢ã¸é·ç§»ã€‚é›»è©±ç•ªå·ã¯æœªå…¥åŠ›ã®ã¾ã¾ã€‚
      setState({ view: 'register', phoneForRegistration: '' });
    },

    /** äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ */
    cancel: d => {
      const message = `
        <div class="text-left space-y-4">
          <p class="text-center"><b>${formatDate(d.date)}</b><br>${d.classroom}<br>ã“ã®äºˆç´„ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ</p>
          <div class="pt-4 border-t">
            <label class="block text-sm font-bold mb-2">å…ˆç”Ÿã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="cancel-message" class="w-full p-2 border border-ui-border rounded" rows="3" placeholder=""></textarea>
          </div>
        </div>
      `;
      showConfirm({
        title: 'äºˆç´„ã®å–ã‚Šæ¶ˆã—',
        message: message,
        confirmText: 'ã¯ã„<br>å–ã‚Šæ¶ˆã—ã¾ã™',
        cancelText: 'ã„ã„ãˆ',
        confirmColorClass: DesignConfig.colors.danger,
        onConfirm: () => {
          showLoading('cancel');
          const cancelMessage = document.getElementById('cancel-message')?.value || '';
          const p = {
            ...d,
            studentId: appState.currentUser.studentId,
            cancelMessage: cancelMessage,
          };
          google.script.run
            .withSuccessHandler(r => {
              hideLoading();
              if (r.success) {
                // ã€NF-12ã€‘ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸæœ€æ–°ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§çŠ¶æ…‹ã‚’æ›´æ–°
                setState({ myBookings: r.newBookingsCache });
                showInfo('äºˆç´„ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚', 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†');
              } else {
                showInfo(r.message || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
              }
            })
            .withFailureHandler(err => {
              // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç”»é¢ã‚’æ›´æ–°ã›ãšã€å…ƒã®çŠ¶æ…‹ã‚’ç¶­æŒ
              handleServerError(err);
            })
            .cancelReservationAndGetLatestData(p);
        },
      });
    },

    /** äºˆç´„ã‚’ç¢ºå®šã—ã¾ã™ */
    confirmBooking: () => {
      const bookingOptions = {
        earlyArrival: document.getElementById('option-hayade')?.checked || false,
        chiselRental: document.getElementById('option-rental')?.checked || false,
        firstLecture: document.getElementById('option-first-lecture')?.checked || false,
        startTime: document.getElementById('res-start-time')?.value || '',
        endTime: document.getElementById('res-end-time')?.value || '',
        workInProgress: document.getElementById('wip-input')?.value || '',
        order: document.getElementById('order-input')?.value || '',
        messageToTeacher: document.getElementById('message-input')?.value || '',
      };
      showLoading('booking');
      const p = { ...appState.selectedSlot, user: appState.currentUser, options: bookingOptions };

      google.script.run
        .withSuccessHandler(r => {
          hideLoading();
          if (r.success) {
            // ã€NF-12ã€‘ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸæœ€æ–°ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§çŠ¶æ…‹ã‚’æ›´æ–°
            setState({
              view: 'complete',
              completionMessage: r.message,
              myBookings: r.newBookingsCache,
              // accountingReservationã¯ã‚»ãƒƒãƒˆã—ãªã„
            });
          } else {
            showInfo(r.message || 'äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(handleServerError)
        .makeReservationAndGetLatestData(p);
    },

    /** äºˆç´„ç·¨é›†ç”»é¢ã«é·ç§»ã—ã¾ã™ */
    goToEditReservation: d => {
      showLoading();
      google.script.run
        .withSuccessHandler(r => {
          hideLoading();
          if (r.success) {
            setState({ view: 'editReservation', editingReservationDetails: r.details });
          } else {
            showInfo(r.message || 'äºˆç´„è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(handleServerError)
        .getReservationDetailsForEdit(d.reservationId, d.classroom);
    },

    /** äºˆç´„æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã™ */
    updateReservation: () => {
      const d = appState.editingReservationDetails;
      const p = {
        reservationId: d.reservationId,
        classroom: d.classroom,
        studentId: appState.currentUser.studentId,
        earlyArrival: document.getElementById('edit-option-hayade')?.checked || false,
        chiselRental: document.getElementById('edit-option-rental')?.checked || false,
        startTime: document.getElementById('edit-start-time')?.value || '',
        endTime: document.getElementById('edit-end-time')?.value || '',
        workInProgress: document.getElementById('edit-wip-input').value,
        order: document.getElementById('edit-order-input').value,
        messageToTeacher: document.getElementById('edit-message-input').value,
      };

      showLoading('booking');
      google.script.run
        .withSuccessHandler(r => {
          hideLoading();
          if (r.success) {
            // ã€NF-12ã€‘ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸæœ€æ–°ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§çŠ¶æ…‹ã‚’æ›´æ–°
            setState({ view: 'classroomSelect', myBookings: r.newBookingsCache });
            showInfo('äºˆç´„å†…å®¹ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚', 'æ›´æ–°å®Œäº†');
          } else {
            showInfo(r.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(handleServerError)
        .updateReservationDetailsAndGetLatestData(p);
    },

    /** ä¼šè¨ˆç”»é¢ã«é·ç§»ã—ã¾ã™ */
    goToAccounting: d => {
      console.log('[DEBUG] goToAccounting called with data:', d);
      console.log('[DEBUG] Current myBookings:', appState.myBookings);
      showLoading('accounting');
      google.script.run
        .withSuccessHandler(res => {
          console.log('[DEBUG] getReservationDetails response:', res);
          hideLoading();
          if (res.success) {
            setState({
              view: 'accounting',
              accountingReservation: d,
              accountingInitialValues: res.details,
            });
          } else {
            showInfo(res.message || 'äºˆç´„è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(handleServerError)
        .getReservationDetails(d);
    },

    /** å±¥æ­´ã‹ã‚‰ä¼šè¨ˆè©³ç´°ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤ºã—ã¾ã™ */
    showHistoryAccounting: d => {
      const details = JSON.parse(d.details);
      const tuitionItemsHtml = details.tuition.items
        .map(i => `<li>${i.name}: ${i.price.toLocaleString()}å††</li>`)
        .join('');
      const salesItemsHtml = details.sales.items.map(i => `<li>${i.name}: ${i.price.toLocaleString()}å††</li>`).join('');
      const message = `
            <div class="p-4 bg-brand-light rounded-lg text-left space-y-4 text-base">
                ${tuitionItemsHtml ? `<b>æˆæ¥­æ–™</b><ul class="list-disc list-inside">${tuitionItemsHtml}</ul>` : ''}
                ${salesItemsHtml ? `<b class="mt-1 inline-block">è²©å£²</b><ul class="list-disc list-inside">${salesItemsHtml}</ul>` : ''}
                <div class="font-bold mt-1 pt-1 border-t">åˆè¨ˆ: ${details.grandTotal.toLocaleString()}å††</div><div class="text-right text-sm pt-1">æ”¯æ‰•æ–¹æ³•: ${details.paymentMethod}</div></div>`;
      showInfo(message, 'ä¼šè¨ˆè¨˜éŒ²');
    },

    /** ä¼šè¨ˆç”»é¢ã§ææ–™å…¥åŠ›è¡Œã‚’è¿½åŠ ã—ã¾ã™ */
    addMaterialRow: () => {
      const container = document.getElementById('materials-container');
      const newIndex = container.querySelectorAll('div[data-material-row-index]').length;
      const newRow = document.createElement('div');
      newRow.className = 'mt-4 pt-4 border-t border-ui-border-light';
      newRow.dataset.materialRowIndex = newIndex;
      newRow.innerHTML = getMaterialRowHtml(newIndex);
      container.appendChild(newRow);
    },

    /** ä¼šè¨ˆç”»é¢ã§ãã®ä»–è²©å£²å“å…¥åŠ›è¡Œã‚’è¿½åŠ ã—ã¾ã™ */
    addOtherSalesRow: () => {
      const container = document.getElementById('other-sales-container');
      const newIndex = container.querySelectorAll('div[data-other-sales-row]').length;
      // getOtherSalesRowHtmlãŒè¿”ã™HTMLæ–‡å­—åˆ—ã‚’ã€ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ä»‹ã•ãšç›´æ¥ã‚³ãƒ³ãƒ†ãƒŠã®æœ«å°¾ã«è¿½åŠ ã™ã‚‹
      container.insertAdjacentHTML('beforeend', getOtherSalesRowHtml(newIndex));
    },

    /** ä¼šè¨ˆç”»é¢ã§åˆè¨ˆé‡‘é¡ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ */
    copyGrandTotal: button => {
      const totalText = document.getElementById('grand-total-amount')?.textContent || '';
      const numericTotal = totalText.replace(/[^0-9-]/g, '');
      actionHandlers.copyToClipboard(button, numericTotal);
    },

    /** æŒ‡å®šã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ */
    copyToClipboard: (button, text) => {
      const textToCopy = text || button.dataset.copyText;
      const textArea = document.createElement('textarea');
      textArea.style.position = 'fixed';
      textArea.style.top = '-9999px';
      textArea.style.left = '-9999px';
      textArea.value = textToCopy.replace(/,/g, '');
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          const originalText = button.textContent;
          button.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ!';
          setTimeout(() => {
            button.textContent = originalText;
          }, 2000);
        } else {
          showInfo('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      } catch (err) {
        showInfo('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯é–‹ç™ºç’°å¢ƒã§ã®ã¿å‡ºåŠ›
        if (typeof console !== 'undefined' && console.error) {
          console.error('Clipboard copy failed:', err);
        }
      }
      document.body.removeChild(textArea);
    },

    // ã€LEGACY REMOVEDã€‘å¤ã„å€‹åˆ¥å±¥æ­´ãƒšãƒ¼ã‚¸é–¢æ•°ã‚’å‰Šé™¤
    // goToHistory, forceGoToHistory ã¯çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç§»è¡Œæ¸ˆã¿

    /** å‚åŠ è¨˜éŒ²ã‚’è¿½åŠ ã§èª­ã¿è¾¼ã¿ã¾ã™ï¼ˆçµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ï¼‰ */
    loadMoreHistory: () => {
      const newCount = (appState.recordsToShow || 20) + 20;
      setState({ recordsToShow: newCount });
    },

    /** æ–°è¦äºˆç´„ã®ãŸã‚ã®æ•™å®¤é¸æŠç”»é¢ã«é·ç§»ã—ã¾ã™ */
    goToNewBookingView: () => setState({ view: 'newBooking' }),

    /** ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ç”»é¢ã«é·ç§»ã—ã¾ã™ */
    goToEditProfile: () => setState({ view: 'editProfile' }),

    /** æ•™å®¤ã‚’é¸æŠã—ã€äºˆç´„æ ä¸€è¦§ç”»é¢ã«é·ç§»ã—ã¾ã™ */
    selectClassroom: d => setState({ selectedClassroom: d.classroomName, view: 'booking' }),

    /** äºˆç´„æ ã‚’é¸æŠã—ã€äºˆç´„ç¢ºèªç”»é¢ã«é·ç§»ã—ã¾ã™ */
    bookSlot: d => {
      const foundSlot = appState.slots.find(s => s.classroom === d.classroom && s.date === d.date);
      if (foundSlot) {
        // ç©ºå¸­æ•°ã«åŸºã¥ã„ã¦isFullçŠ¶æ…‹ã‚’ç¢ºå®Ÿã«è¨­å®š
        const isFullSlot =
          foundSlot.isFull ||
          foundSlot.availableSlots === 0 ||
          (typeof foundSlot.morningSlots !== 'undefined' &&
            foundSlot.morningSlots === 0 &&
            foundSlot.afternoonSlots === 0);
        setState({
          selectedSlot: {
            ...foundSlot,
            isFull: isFullSlot,
          },
          view: 'confirm',
        });
      } else {
        showInfo('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚é¸æŠã—ãŸäºˆç´„æ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
      }
    },

    /** ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚Šã¾ã™ */
    goBackToLogin: () => setState({ view: 'login' }),

    /** ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰ã«æˆ»ã‚Šã¾ã™ */
    goBackToClassroomSelect: () => setState({ view: 'classroomSelect' }),

    /** ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰ã«æˆ»ã‚Šã¾ã™ï¼ˆåˆ¥åï¼‰ */
    goToDashboard: () => setState({ view: 'classroomSelect' }),

    /** äºˆç´„æ ä¸€è¦§ç”»é¢ã«æˆ»ã‚Šã¾ã™ */
    goBackToBooking: () =>
      setState({
        view: 'booking',
        selectedClassroom:
          appState.selectedSlot?.classroom ||
          appState.accountingReservation?.classroom ||
          appState.editingReservationDetails?.classroom,
      }),

    /** ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆæ•™å®¤é¸æŠç”»é¢ï¼‰ã«æˆ»ã‚Šã¾ã™ */
    goToDashboard: () => setState({ view: 'classroomSelect' }),

    /** ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ç¢ºèªãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†ã§ã™ */
    modalConfirm: () => {
      if (onConfirmCallback) onConfirmCallback();
      hideModal();
    },

    /** ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†ã§ã™ */
    modalCancel: () => hideModal(),

    /** ã€Œæ¬¡ã®äºˆç´„ã‚’ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã®å‡¦ç†ï¼ˆäºˆç´„ä¸€è¦§ç”»é¢ã¸é·ç§»ï¼‰ */
    goToBooking: d => {
      // data-classroomå±æ€§ã‹ã‚‰æ•™å®¤åã‚’å–å¾—
      const classroom = d.classroom || appState.accountingReservation?.classroom;
      if (classroom) {
        setState({ selectedClassroom: classroom, view: 'booking' });
      } else {
        showInfo('æ•™å®¤åãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
      }
    },
  };

  /**
   * ä¼šè¨ˆã®ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
   */
  actionHandlers.showAccountingConfirmation = () => {
    const accountingDetails = calculateAccountingDetails();
    if (!accountingDetails || accountingDetails.grandTotal <= 0) {
      showInfo('åˆè¨ˆé‡‘é¡ãŒ0å††ã§ã™ã€‚é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    const message = `
        <div class="p-4 bg-brand-light rounded-lg text-left space-y-4 text-base" id="modal-accounting-form">
            <div>
                <span class="font-bold">åˆè¨ˆé‡‘é¡:</span> ${accountingDetails.grandTotal.toLocaleString()}å††
                <button data-action="copyGrandTotal" class="ml-2 text-sm bg-action-secondary-bg active:bg-action-secondary-hover text-action-secondary-text font-bold px-2 py-1 rounded">ã‚³ãƒ”ãƒ¼</button>
            </div>
            <div>
                <span class="font-bold">æ”¯æ‰•ã„æ–¹æ³•:</span>
                <div class="mt-2 space-y-3">
                    ${getPaymentOptionsHtml()}
                </div>
            </div>
            <div class="mt-4">
                <button id="confirm-payment-button" data-action="confirmAndPay" class="w-full bg-action-primary-bg text-action-primary-text font-bold py-2 rounded disabled:bg-brand-muted" disabled>ã“ã®å†…å®¹ã§æ”¯æ‰•ã„ã¾ã—ãŸ</button>
            </div>
            <p class="text-red-700 font-bold mt-2 text-center">å¿…ãšãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­</p>
        </div>
    `;
    showModal({
      title: 'ãŠä¼šè¨ˆ',
      message: message,
      showCancel: true,
      cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
      onConfirm: null,
    });
  };

  /**
   * ã€Œã“ã®å†…å®¹ã§æ”¯æ‰•ã„ã¾ã—ãŸã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
   */
  actionHandlers.confirmAndPay = () => {
    // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®æ”¯æ‰•ã„æ–¹æ³•ã‚’å–å¾—
    const modalForm = document.getElementById('modal-accounting-form');
    let paymentMethod = 'ç¾é‡‘';
    if (modalForm) {
      const selected = modalForm.querySelector('input[name="payment-method"]:checked');
      if (selected) paymentMethod = selected.value;
    }

    // --- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«é€ä¿¡ã™ã‚‹ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ ---
    const form = document.getElementById('accounting-form');
    const userInput = {
      paymentMethod: paymentMethod,
      tuitionItems: [],
      salesItems: [],
      timeBased: null,
    };

    // æˆæ¥­æ–™é …ç›®ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰
    form.querySelectorAll('input[type="checkbox"][data-item-type="æˆæ¥­æ–™"]:checked').forEach(cb => {
      userInput.tuitionItems.push(cb.dataset.itemName);
    });

    // æ™‚é–“åˆ¶æˆæ¥­æ–™
    if (document.getElementById('start-time')) {
      userInput.timeBased = {
        startTime: document.getElementById('start-time').value,
        endTime: document.getElementById('end-time').value,
        breakMinutes: parseInt(document.getElementById('break-time')?.value || 0, 10),
        discountMinutes: parseInt(document.getElementById('discount-selector')?.value || 0, 10),
      };
    }

    // ç‰©è²©ãƒ»ææ–™è²»é …ç›®
    const materialContainer = document.getElementById('materials-container');
    if (materialContainer) {
      materialContainer.querySelectorAll('div[data-material-row-index]').forEach((row, index) => {
        const name = document.getElementById(`material-type-${index}`)?.value;
        const priceText = document.getElementById(`material-price-${index}`)?.textContent || '0';
        const price = parseInt(priceText.replace(/[^0-9]/g, ''), 10);
        if (name && price > 0) userInput.salesItems.push({ name: name, price: price });
      });
    }

    // ç‰©è²©é …ç›®ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰
    form.querySelectorAll('input[type="checkbox"][data-item-type="ç‰©è²©"]:checked').forEach(cb => {
      userInput.salesItems.push({ name: cb.dataset.itemName });
    });

    form.querySelectorAll('div[data-other-sales-row]').forEach((row, index) => {
      const name = document.getElementById(`other-sales-name-${index}`)?.value.trim();
      const price = document.getElementById(`other-sales-price-${index}`)?.value;
      if (name && price) userInput.salesItems.push({ name: name, price: Number(price) });
    });
    // --- ã“ã“ã¾ã§ ---

    const payload = {
      reservationId: appState.accountingReservation.reservationId,
      classroom: appState.accountingReservation.classroom,
      studentId: appState.currentUser.studentId,
      userInput: userInput,
    };

    showLoading('accounting');
    google.script.run
      .withSuccessHandler(r => {
        if (r.success) {
          hideModal(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
          hideLoading();
          setState({
            view: 'complete',
            completionMessage: 'ä¼šè¨ˆæƒ…å ±ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚',
            myBookings: r.newBookingsCache,
            history: r.newHistory,
            historyTotal: r.newHistoryTotal,
            slots: r.updatedSlots, // <--- ã“ã‚Œã‚’è¿½åŠ 
            accountingReservation: appState.accountingReservation,
          });
        } else {
          hideLoading();
          showInfo(r.message || 'ä¼šè¨ˆæƒ…å ±ã®è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      })
      .withFailureHandler(handleServerError)
      .saveAccountingDetails(payload);
  };

  // =================================================================
  // --- Main Application Logic ---
  // -----------------------------------------------------------------
  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã€ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã€çŠ¶æ…‹ç®¡ç†ã€ç”»é¢æç”»ãªã©ã€
  // å…¨ä½“ã‚’åˆ¶å¾¡ã™ã‚‹ã‚³ã‚¢ã¨ãªã‚‹é–¢æ•°ç¾¤ã§ã™ã€‚
  // =================================================================

  /**
   * ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸéš›ã®å…±é€šå‡¦ç†ã§ã™ã€‚
   * @param {Error} err - ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  function handleServerError(err) {
    hideLoading();

    // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯é–‹ç™ºç’°å¢ƒã§ã®ã¿å‡ºåŠ›
    if (typeof console !== 'undefined' && console.error) {
      console.error('Server Error:', err);
    }

    const errorMessage = typeof err === 'object' && err.message ? err.message : JSON.stringify(err);
    showInfo(`ã‚µãƒ¼ãƒãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br><br>è©³ç´°: ${errorMessage}`, 'ã‚¨ãƒ©ãƒ¼');
  }

  /**
   * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã€ç”»é¢ã‚’å†æç”»ã—ã¾ã™ã€‚
   * @param {object} newState - æ›´æ–°ã™ã‚‹æ–°ã—ã„çŠ¶æ…‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  function setState(newState) {
    // ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®ã¿ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’è¡¨ç¤º
    const isTestEnvironment =
      typeof window !== 'undefined' &&
      (window.location.protocol === 'file:' || window.location.hostname === 'localhost');

    if (isTestEnvironment) {
      console.log('[DEBUG] setState called with:', newState);
      console.log('[DEBUG] Current appState before update:', appState);
    }

    Object.assign(appState, newState);

    // myBookingsãŒé…åˆ—ã§ãªã„å ´åˆã®é˜²å¾¡çš„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã‚‚é‡è¦ï¼‰
    if (appState.myBookings && !Array.isArray(appState.myBookings)) {
      if (isTestEnvironment) {
        console.warn('[DEBUG] myBookings is not an array, converting:', appState.myBookings);
      }
      appState.myBookings = [];
    }

    // myBookingsãŒundefinedã®å ´åˆã‚‚é…åˆ—ã§åˆæœŸåŒ–
    if (!appState.myBookings) {
      appState.myBookings = [];
    }

    if (isTestEnvironment) {
      console.log('[DEBUG] Updated appState:', appState);
    }

    render();
  }
  window.setState = setState;
  this.setState = setState;
  self.setState = setState;

  /**
   * ç¾åœ¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã«åŸºã¥ã„ã¦ã€é©åˆ‡ãªãƒ“ãƒ¥ãƒ¼ã‚’æç”»ã—ã¾ã™ã€‚
   */
  function render() {
    let v = '';
    switch (appState.view) {
      case 'login':
        v = getLoginView();
        break;
      case 'register':
        v = getRegisterView(appState.phoneForRegistration);
        break;
      case 'classroomSelect':
        v = getDashboardView();
        break;
      case 'newBooking':
        v = getNewBookingView();
        break;
      case 'editProfile':
        v = getEditProfileView();
        break;
      case 'booking':
        v = getBookingView(appState.selectedClassroom);
        break;
      case 'confirm':
        v = getConfirmationView();
        break;
      case 'editReservation':
        v = getEditReservationView();
        break;
      case 'accounting':
        v = getAccountingView();
        break;
      // ã€LEGACY REMOVEDã€‘ case 'history' - çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç§»è¡Œæ¸ˆã¿
      case 'complete':
        v = getCompleteView(appState.completionMessage);
        break;
      case 'noPhoneUserSelect':
        v = getNoPhoneUserSelectView();
        break; // NF-01: æ–°ã—ã„ãƒ“ãƒ¥ãƒ¼ã‚’è¿½åŠ 
    }
    document.getElementById('view-container').innerHTML = `<div class="fade-in">${v}</div>`;

    if (appState.view === 'accounting') {
      requestAnimationFrame(calculateAccountingDetails);
    }
  }

  /**
   * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ç‚¹ã§ã™ã€‚
   * ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å®Ÿè¡Œã•ã‚Œã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
   */
  window.onload = function () {
    const app = document.getElementById('app');

    // ä¼šè¨ˆè¨ˆç”»é¢ã§ã®å…¥åŠ›å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å†è¨ˆç®—
    ['input', 'change'].forEach(eventName => {
      app.addEventListener(eventName, e => {
        if (appState.view === 'accounting' && e.target.closest('#accounting-form')) {
          calculateAccountingDetails();
        }
        // changeã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã®ã¿ã€æ”¯æ‰•ã„æ–¹æ³•é¸æŠã‚’ãƒã‚§ãƒƒã‚¯
        if (eventName === 'change' && e.target.matches('#modal-accounting-form input[name="payment-method"]')) {
          document.getElementById('confirm-payment-button')?.removeAttribute('disabled');
        }
      });
    });

    // ã‚¢ãƒ—ãƒªå…¨ä½“ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ•æ‰
    app.addEventListener('click', e => {
      const targetButton = e.target.closest('button');
      if (targetButton?.dataset.action) {
        const { action, ...data } = targetButton.dataset;
        if (action === 'copyToClipboard' || action === 'copyGrandTotal') {
          actionHandlers[action](targetButton);
        } else if (actionHandlers[action]) {
          actionHandlers[action](data);
        }
      }
    });

    // åˆæœŸç”»é¢ã‚’æç”»
    render();
  };
</script>
