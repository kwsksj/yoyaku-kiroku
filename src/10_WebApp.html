<!--
=================================================================
ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: 10_WebApp.html
ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘: 26.0 (ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–å¯¾å¿œç‰ˆ)
ã€æ›´æ–°æ—¥æ™‚ã€‘: 2025-08-04
ã€èª¬æ˜ã€‘:
- è¨­å®šã¨ãƒ¢ãƒƒã‚¯æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†é›¢
- ã‚ˆã‚Šä¿å®ˆæ€§ã®é«˜ã„æ§‹é€ ã«æ”¹å–„
- ãƒ†ã‚¹ãƒˆç’°å¢ƒã¨ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã®åˆ†é›¢
=================================================================
-->
<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <base target="_top" />
    <title>ãã¼ã‚Šã® ã‚ˆã‚„ããƒ»ãã‚ã å·å´èª äºŒæœ¨å½«ã‚Šæ•™å®¤</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
  </head>

  <body class="bg-brand-bg min-h-screen">
    <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯éè¡¨ç¤ºï¼‰ -->

    <!-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="app" class="container mx-auto px-4 max-w-lg">
      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
      <div
        id="loading"
        class="loading-fade fixed inset-0 flex flex-col items-center justify-center z-50"
      >
        <div class="spinner mb-4"></div>
        <p id="loading-message" class="text-brand-text">
          ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ä¸­...
        </p>
      </div>

      <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <main id="main-content" class="py-6">
        <div id="view-container"></div>
      </main>

      <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
      <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
          <div id="modal-body"></div>
        </div>
      </div>

      <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
      <div
        id="custom-modal"
        class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50"
      >
        <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
          <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
          <div id="modal-message" class="mb-6"></div>
          <div id="modal-buttons" class="flex gap-3 justify-end"></div>
        </div>
      </div>
      <footer class="text-center text-sm text-brand-muted mt-4">
        ãã¼ã‚Šã® ã‚ˆã‚„ããƒ»ãã‚ã
      </footer>
    </div>

    <!-- GASç’°å¢ƒç”¨ã®JavaScriptãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè©•ä¾¡å¯¾å¿œï¼‰ -->
    
    <!-- çµ±åˆJavaScript (è‡ªå‹•ç”Ÿæˆ) -->
<script>
  // @ts-check
  /// <reference path="../html-globals.d.ts" />

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°å®£è¨€ï¼ˆVSCode TypeScriptè¨€èªã‚µãƒ¼ãƒãƒ¼ç”¨ï¼‰
  /* global CONSTANTS:readonly, STATUS:readonly, CLASSROOMS:readonly, ITEMS:readonly, HEADERS:readonly */
  /* global ITEM_TYPES:readonly, UNITS:readonly, PAYMENT_METHODS:readonly, UI:readonly, SESSIONS:readonly */
  /* global PAYMENT:readonly, BANK_INFO:readonly, BANK:readonly, MESSAGES:readonly, LOG_ACTIONS:readonly */
  /* global CLASSROOM_TYPES:readonly, SCHEDULE_STATUS:readonly, SHEET_NAMES:readonly, LIMITS:readonly */
  /* global DISCOUNT_OPTIONS:readonly, TIME_SETTINGS:readonly, SYSTEM:readonly, HEADERS_RESERVATIONS:readonly */
  /* global HEADERS_ROSTER:readonly, HEADERS_ACCOUNTING:readonly, HEADERS_SCHEDULE:readonly */
  /* global DesignConfig:readonly, stateManager:readonly, Components:readonly, pageTransitionManager:readonly */
  /* global escapeHTML:readonly, formatDate:readonly, showLoading:readonly, hideLoading:readonly */
  /* global showInfo:readonly, showConfirm:readonly, debugLog:readonly, getTuitionItemRule:readonly */
  /* global getTimeBasedTuitionHtml:readonly, createReservationCard:readonly, findReservationByDateAndClassroom:readonly */
  /* global isTimeBasedClassroom:readonly, getClassroomTimesFromSchedule:readonly, buildSalesChecklist:readonly */
  /* global findReservationById:readonly, google:readonly, server:readonly, MockData:readonly */
  /* global isProduction:readonly, C:readonly */

  // ESLintãƒ¯ãƒ³ãƒ©ã‚¤ãƒ³ç„¡åŠ¹åŒ–
  /* eslint-disable no-undef */

  /**
   * =================================================================
   * çµ±åˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰JavaScript (è‡ªå‹•ç”Ÿæˆ)
   * Generated: 2025-09-08T13:30:48.862Z
   * =================================================================
   */

  // =================================================================
  // 11_WebApp_Config.js (è‡ªå‹•çµ±åˆ)
  // =================================================================

  // @ts-check
  /// <reference path="../types.d.ts" />

  /**
   * =================================================================
   * ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: 11_WebApp_Config.html
   * ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘: 1.7
   * ã€å½¹å‰²ã€‘: WebAppã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ä½¿ç”¨ã•ã‚Œã‚‹è¨­å®šã¨ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
   * ã€æ§‹æˆã€‘: 14ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®ã†ã¡ã®11ç•ªç›®
   * ã€v1.7ã§ã®å¤‰æ›´ç‚¹ã€‘:
   * - å…¨ä½“çš„ãªé…è‰²ã‚’ã‚ˆã‚Šã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ã§æ¸©ã‹ã¿ã®ã‚ã‚‹ãƒ†ãƒ¼ãƒã«æ›´æ–°
   * - ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã®å¯èª­æ€§ã‚’å‘ä¸Š
   * - ä¼šè¨ˆãƒœã‚¿ãƒ³ã«é»„è‰²ç³»ã®é…è‰²ã‚’é©ç”¨
   * - è¨˜éŒ²ã‚«ãƒ¼ãƒ‰ã«èƒŒæ™¯è‰²ã‚’è¿½åŠ 
   * =================================================================
   */

  // =================================================================
  // 1. APPLICATION CONSTANTSï¼ˆçµ±ä¸€å®šæ•°ã‚·ã‚¹ãƒ†ãƒ ï¼‰
  // =================================================================

  // ã€é‡è¦ã€‘çµ±ä¸€å®šæ•°ã¯ getAppInitialData() ã§å–å¾—ã•ã‚Œã‚‹ constants ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨
  // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® 00_Constants.js ã§å®šç¾©ã•ã‚ŒãŸçµ±ä¸€å®šæ•°ãŒãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«é…ä¿¡ã•ã‚Œã‚‹
  //
  // ä½¿ç”¨ä¾‹:
  // - stateManager.getState().constants.classrooms.TOKYO ï¼ˆ'æ±äº¬æ•™å®¤'ï¼‰
  // - stateManager.getState().constants.headers.STUDENT_ID ï¼ˆ'ç”Ÿå¾’ID'ï¼‰
  // - STATUS.WAITLISTED ï¼ˆ'waitlisted'ï¼‰
  // - stateManager.getState().constants.sessions.MORNING ï¼ˆ'åˆå‰'ï¼‰
  // - BANK.NAME ï¼ˆ'ã‚†ã†ã¡ã‚‡éŠ€è¡Œ'ï¼‰
  // - stateManager.getState().constants.frontendUi.DISCOUNT_OPTIONS.THIRTY_MIN ï¼ˆ30ï¼‰
  //
  // æ³¨æ„: ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®šæ•°ã¨ã®é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚
  // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å›ºæœ‰ã®å®šæ•°ã®ã¿å®šç¾©ã™ã‚‹

  // --- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å°‚ç”¨å®šæ•°ï¼ˆçµ±ä¸€å®šæ•°ã‚·ã‚¹ãƒ†ãƒ ã«ç§»è¡Œæ¸ˆã¿ï¼‰ ---

  // ã€ç§»è¡Œå®Œäº†ã€‘ä»¥ä¸‹ã®å®šæ•°ã¯ 00_Constants.js ã«ç§»è¡Œã—ã€constants ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
  // - ITEM_NAME_DISCOUNT â†’ stateManager.getState().constants.items.DISCOUNT
  // - SESSION_MORNING/AFTERNOON/ALL_DAY â†’ stateManager.getState().constants.sessions.MORNING/AFTERNOON/ALL_DAY
  // - UNIT_CM3 â†’ stateManager.getState().constants.units.CM3
  // - PAYMENT.* â†’ stateManager.getState().constants.paymentDisplay.*
  // - BANK_* â†’ BANK.*
  // - DISCOUNT_OPTION_* â†’ stateManager.getState().constants.frontendUi.DISCOUNT_OPTIONS.*
  // - TIME_STEP_MINUTES â†’ stateManager.getState().constants.frontendUi.TIME_SETTINGS.STEP_MINUTES
  // - TIME_END_BUFFER_HOURS â†’ stateManager.getState().constants.frontendUi.TIME_SETTINGS.END_BUFFER_HOURS

  // ã€äº’æ›æ€§ã€‘æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®äº’æ›æ€§ã®ãŸã‚ã€å¿…è¦ã«å¿œã˜ã¦å€‹åˆ¥å®šæ•°ã‚‚åˆ©ç”¨å¯èƒ½
  // ä¾‹: const SESSION_MORNING = stateManager.getState().constants.sessions.MORNING;

  // ã€ç´”ç²‹ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å°‚ç”¨ã€‘ä»¥ä¸‹ã¯æœ¬å½“ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã—ã‹ä½¿ã‚ãªã„å®šæ•°ã®ã¿

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å®šæ•°ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨ - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰CONSTANTSã¨ã®é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚windowã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è¨­å®šï¼‰
  window.STATUS = window.STATUS || {
    CANCELED: 'å–æ¶ˆ', // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿
    WAITLISTED: 'å¾…æ©Ÿ', // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡
    CONFIRMED: 'ç¢ºå®š', // äºˆç´„ç¢ºå®šï¼ˆä¼šè¨ˆå‰ï¼‰
    COMPLETED: 'å®Œäº†', // å®Œäº†ï¼ˆä¼šè¨ˆæ¸ˆã¿ï¼‰
  };

  // =================================================================
  // 2. DESIGN CONFIGURATION
  // =================================================================
  window.DesignConfig = window.DesignConfig || {
    // ãƒ†ã‚­ã‚¹ãƒˆã‚„èƒŒæ™¯ã®è‰²è¨­å®šï¼ˆæ¸©ã‹ã¿ã¨æ´»æ°—ã®ã‚ã‚‹é…è‰²ï¼‰
    colors: {
      text: 'text-brand-text', // ãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
      textSubtle: 'text-brand-subtle', // ã‚µãƒ–ãƒ†ã‚­ã‚¹ãƒˆ
      textMuted: 'text-brand-muted', // è–„ã„ãƒ†ã‚­ã‚¹ãƒˆ
      primary:
        'bg-action-primary-bg text-action-primary-text active:bg-action-primary-hover', // ãƒ—ãƒ©ã‚¤ãƒãƒª (ãƒ†ãƒ©ã‚³ãƒƒã‚¿)
      secondary:
        'bg-action-secondary-bg text-action-secondary-text active:bg-action-secondary-hover', // ã‚»ã‚«ãƒ³ãƒ€ãƒª (æ˜ã‚‹ã„ãƒ™ãƒ¼ã‚¸ãƒ¥)
      attention:
        'bg-action-attention-bg text-action-attention-text active:bg-action-attention-hover', // æ³¨æ„ (è‹¥è‘‰è‰²)
      accounting:
        'bg-action-accounting-bg text-action-accounting-text active:bg-action-accounting-hover', // ä¼šè¨ˆ (ã‚¢ãƒ³ãƒãƒ¼)
      danger:
        'bg-state-danger-bg text-state-danger-text active:bg-state-danger-hover', // å±é™º (è½ã¡ç€ã„ãŸèµ¤)
      success:
        'bg-state-success-bg text-state-success-text active:bg-state-success-hover', // æˆåŠŸ (è‹¥è‘‰è‰²)
      paid: 'bg-action-paid-bg text-action-paid-text', // æ”¯æ‰•ã„æ¸ˆã¿ (è–„ã„ç·‘)
      info: 'bg-ui-surface text-brand-text border border-ui-border',
      warning:
        'bg-ui-warning-bg text-ui-warning-text border border-ui-warning-border',
      error: 'bg-ui-error-bg text-ui-error-text border border-ui-error-border',
    },

    // æ•™å®¤åˆ¥ã®ãƒœã‚¿ãƒ³è‰²è¨­å®š
    classroomColors: {
      tokyo: {
        button: 'bg-red-50 border-red-200 text-red-800 hover:bg-red-100',
        colorClass: 'bg-red-50 border-red-200 text-red-800 hover:bg-red-100',
      },
      numazu: {
        button: 'bg-blue-50 border-blue-200 text-blue-800 hover:bg-blue-100',
        colorClass: 'bg-blue-50 border-blue-200 text-blue-800 hover:bg-blue-100',
      },
      tsukuba: {
        button: 'bg-green-50 border-green-200 text-green-800 hover:bg-green-100',
        colorClass:
          'bg-green-50 border-green-200 text-green-800 hover:bg-green-100',
      },
      default: {
        button:
          'bg-state-available-bg border-state-available-border text-brand-text hover:bg-gray-50',
        colorClass:
          'bg-state-available-bg border-state-available-border text-brand-text hover:bg-gray-50',
      },
    },

    // ãƒœã‚¿ãƒ³ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«
    buttons: {
      base: 'font-bold py-2.5 px-5 rounded-md transition-all duration-150 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 mobile-button touch-friendly',
      full: 'w-[250px] mx-auto block',
      auto: 'w-auto',
      primary:
        'font-bold py-2.5 px-5 rounded-md transition-all duration-150 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 mobile-button touch-friendly bg-action-primary-bg text-action-primary-text active:bg-action-primary-hover',
      secondary:
        'font-bold py-2.5 px-5 rounded-md transition-all duration-150 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 mobile-button touch-friendly bg-action-secondary-bg text-action-secondary-text active:bg-action-secondary-hover',
      attention:
        'font-bold py-2.5 px-5 rounded-md transition-all duration-150 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 mobile-button touch-friendly bg-action-attention-bg text-action-attention-text active:bg-action-attention-hover',
      accounting:
        'font-bold py-2.5 px-5 rounded-md transition-all duration-150 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 mobile-button touch-friendly bg-action-accounting-bg text-action-accounting-text active:bg-action-accounting-hover',
    },

    // ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
    text: {
      heading: 'text-xl font-bold text-brand-text',
      subheading: 'text-lg font-medium text-brand-text',
      body: 'text-base text-brand-text',
      bodySubtle: 'text-base text-brand-subtle',
      caption: 'text-sm text-brand-subtle',
      label: 'text-base font-bold text-brand-text',
      labelBlock: 'block text-brand-text text-base font-bold mb-2',
    },

    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    layout: {
      container: 'max-w-screen-sm mx-auto p-4',
      containerNoPadding: 'max-w-screen-sm mx-auto',
      section: 'mb-8',
      card: 'shadow-card rounded-lg border border-solid border-card-border',
      centerContent: 'flex items-center justify-center',
      spaceBetween: 'flex items-center justify-between',
    },

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹
    utils: {
      hidden: 'hidden',
      loading: 'opacity-50 pointer-events-none',
      mobileFriendly: 'mobile-button touch-friendly',
      flexCenter: 'flex items-center justify-center',
      flexBetween: 'flex items-center justify-between',
      fullWidth: 'w-full',
      autoMargin: 'mx-auto',
    },

    // ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«
    cards: {
      base: 'w-full text-left p-3 rounded-lg mobile-card touch-friendly transition-all duration-150',
      container: 'max-w-md mx-auto space-y-3',
      background: 'bg-ui-surface border border-ui-border',
      state: {
        available: {
          card: 'bg-state-available-bg border border-state-available-border mobile-card active:bg-state-success-hover',
          text: 'text-state-available-text',
        },
        waitlist: {
          card: 'bg-state-waitlist-bg border border-state-waitlist-border mobile-card',
          text: 'text-state-waitlist-text',
        },
        booked: {
          card: 'bg-state-booked-bg border border-state-booked-border mobile-card',
          text: 'text-state-booked-text',
        },
        history: {
          card: 'bg-brand-light border border-ui-border mobile-card',
        },
      },
    },

    // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ«
    inputs: {
      container: 'max-w-md mx-auto',
      base: 'text-lg w-full p-3 border border-ui-border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-text mobile-input touch-friendly bg-ui-input focus:bg-ui-input-focus transition-all duration-150',
      textarea:
        'text-lg w-full p-3 border border-ui-border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-text h-24 mobile-input bg-ui-input focus:bg-ui-input-focus transition-all duration-150',
    },
  };

  // =================================================================
  // 3. CSS STYLES SETUP
  // =================================================================
  const addCustomStyles = () => {
    const style = document.createElement('style');
    style.textContent = `
        /* ========== Font Loading Optimization ========== */
        @import url('https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap');

        /* Prevent FOUT (Flash of Unstyled Text) */
        .font-loading {
          visibility: hidden;
        }

        .fonts-loaded .font-loading {
          visibility: visible;
        }

        /* ========== CSS Variables - kibori-class.netå®Œå…¨èª¿å’Œãƒ‡ã‚¶ã‚¤ãƒ³ ========== */
        :root {
          /* Energetic and warm theme for a wood carving school */
          --brand-text: #4E342E;       /* Dark Brown for high readability */
          --brand-subtle: #785A4E;     /* Medium Brown for sub-text */
          --brand-muted: #A1887F;      /* Lighter, soft brown */
          --brand-bg: #FFFDF5;         /* Warm, very light cream background */
          --brand-surface: #FFFFFF;    /* White for card backgrounds for a clean look */
          --brand-light: #F5F1ED;      /* Light, warm beige for hover states */

          --action-primary: #C86F34;   /* Energetic terracotta for main actions */
          --action-secondary: #E4CDBA; /* Light, warm beige for secondary actions */
          --action-attention: #5A8C36; /* Lively, fresh green for attention */
          --action-accounting: #F59E0B;/* Bright amber for accounting actions */
          --action-danger: #B91C1C;    /* A clear, strong red for danger */

          --state-available: #5A8C36;  /* Lively green for available slots */
          --state-waitlist: #F59E0B;   /* Bright amber for waitlist */
          --state-booked: #785A4E;     /* Medium brown for booked slots */

          /* UIè¦ç´  - ã‚ˆã‚Šæ´—ç·´ã•ã‚ŒãŸå¢ƒç•Œç·šã¨èƒŒæ™¯ */
          --ui-border: #D4C4B8;        /* æ¸©ã‹ã¿ã®ã‚ã‚‹ãƒ™ãƒ¼ã‚¸ãƒ¥å¢ƒç•Œç·š */
          --ui-border-light: #E8DDD6;  /* ã‚ˆã‚Šè–„ã„å¢ƒç•Œç·š */
          --ui-input: #FAFAFA;         /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰èƒŒæ™¯ */
          --ui-input-focus: #FFFFFF;   /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚èƒŒæ™¯ */
          --ui-surface: #FFFFFF;       /* ã‚µãƒ¼ãƒ•ã‚§ã‚¹èƒŒæ™¯ */

          /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
          --modal-overlay: rgba(73, 59, 49, 0.6); /* ãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼ãƒ™ãƒ¼ã‚¹ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
          --spinner-border: #f3f4f6;

          /* å½±ã¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
          --shadow-sm: 0 1px 2px 0 rgba(73, 59, 49, 0.05);
          --shadow-md: 0 4px 6px -1px rgba(73, 59, 49, 0.1);
          --shadow-lg: 0 10px 15px -3px rgba(73, 59, 49, 0.1);
        }

        /* ========== Base Styles ========== */
        body {
          font-family: 'Zen Kaku Gothic New', sans-serif;
          color: var(--brand-text);
          background-color: var(--brand-bg);
          line-height: 1.6;
          /* ãƒ¢ãƒã‚¤ãƒ«ç’°å¢ƒã§ã®Googleã‚µã‚¤ãƒˆåŸ‹ã‚è¾¼ã¿å¯¾å¿œ */
          padding-top: env(safe-area-inset-top, 0);
        }

        /* Googleã‚µã‚¤ãƒˆåŸ‹ã‚è¾¼ã¿æ™‚ã®ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media screen and (max-width: 768px) {
          body.embedded-in-google-sites {
            padding-top: 60px; /* Googleã‚µã‚¤ãƒˆã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼åˆ†ã®ä½™ç™½ */
          }

          body.embedded-in-google-sites .fixed.top-4 {
            top: 70px; /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ä½ç½®ã‚’èª¿æ•´ */
          }

          .app-container {
            min-height: calc(100vh - 60px);
          }
        }

        /* ã‚ˆã‚Šå¤§ããªãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ã®å ´åˆ */
        @media screen and (max-width: 480px) {
          body.embedded-in-google-sites {
            padding-top: 80px;
          }

          body.embedded-in-google-sites .fixed.top-4 {
            top: 90px; /* ã‚ˆã‚Šå°ã•ãªã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã§ã®æˆ»ã‚‹ãƒœã‚¿ãƒ³èª¿æ•´ */
          }

          .app-container {
            min-height: calc(100vh - 80px);
          }
        }

        /* ========== Mobile-Friendly Components ========== */
        .mobile-button, .mobile-input, .mobile-card {
          min-height: 48px;
        }
        .touch-friendly {
          touch-action: manipulation;
        }

        /* ========== Animations ========== */
        .fade-in { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
          border: 4px solid var(--spinner-border);
          width: 32px;
          height: 32px;
          border-radius: 50%;
          border-left-color: var(--brand-text);
          animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ========== Layout Components ========== */
        #loading { z-index: 100; }
        .modal-overlay {
          position: fixed; inset: 0; background-color: var(--modal-overlay);
          display: flex; align-items: center; justify-content: center;
          z-index: 50; opacity: 0; transition: opacity 0.3s ease;
          pointer-events: none; backdrop-filter: blur(3px);
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        #custom-modal {
          opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
        }
        #custom-modal.active { opacity: 1; pointer-events: auto; }
        /* æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .modal-fade {
          opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
        }
        .modal-fade.active { opacity: 1; pointer-events: auto; }
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .loading-fade {
          opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
        }
        .loading-fade.active { opacity: 1; pointer-events: auto; }
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã®èƒŒæ™¯ã‚’å°‘ã—é€æ˜ã«ã—ã¦æ»‘ã‚‰ã‹ãªé·ç§»ã‚’å®Ÿç¾ */
        #loading { background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(2px); }
        .modal-content {
          background: white; padding: 1.5rem; border-radius: 0.75rem;
          width: 90%; max-width: 400px; text-align: center;
          max-height: 85vh; overflow-y: auto;
        }
        .modal-content p { margin-bottom: 1.25rem; }
        .modal-content .modal-buttons { justify-content: center; }

        /* ========== Custom Components ========== */
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }

        .accounting-item, .reservation-card {
          background-color: var(--brand-surface);
          border: 1px solid var(--ui-border);
          transition: all 0.2s ease;
          position: relative;
        }
        .accounting-item:hover, .reservation-card:hover {
          transform: translateY(-2px);
          box-shadow: var(--shadow-md);
          border-color: var(--brand-accent);
        }

        /* ========== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ”¹å–„ - memo.mdå•é¡Œå¯¾å¿œ ========== */

        /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’å³ä¸Šã«å›ºå®šï¼ˆå•é¡Œ#3å¯¾å¿œï¼‰ */
        .back-button-container {
          position: fixed;
          top: 1rem;
          right: 1rem;
          z-index: 40;
          transform: none !important; /* ä½ç½®ã‚ºãƒ¬é˜²æ­¢ï¼ˆå•é¡Œ#36å¯¾å¿œï¼‰ */
        }

        /* Googleã‚µã‚¤ãƒˆåŸ‹ã‚è¾¼ã¿æ™‚ã®æˆ»ã‚‹ãƒœã‚¿ãƒ³èª¿æ•´ï¼ˆå•é¡Œ#14å¯¾å¿œï¼‰ */
        body.embedded-in-google-sites .back-button-container {
          top: 70px;
        }

        @media screen and (max-width: 480px) {
          body.embedded-in-google-sites .back-button-container {
            top: 90px;
          }
        }

        /* ========== æ–°ã‚«ãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ - ã‚ˆã‚„ããƒ»ãã‚ãã‚«ãƒ¼ãƒ‰ ========== */

        .reservation-card, .record-card {
          padding: 1rem;
          display: flex;
          flex-direction: column;
          gap: 1rem;
          position: relative;
        }

        /* ã‚«ãƒ¼ãƒ‰ä¸Šéƒ¨: æ•™å®¤æƒ…å ± + ç·¨é›†ãƒœã‚¿ãƒ³ */
        .card-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          gap: 1rem;
        }

        .card-class-info {
          flex: 1;
          display: flex;
          flex-direction: column;
          gap: 0.25rem;
        }

        .card-class-info .class-datetime {
          font-weight: 600;
          color: var(--brand-text);
          font-size: 1rem;
        }

        .card-class-info .class-venue {
          color: var(--brand-subtle);
          font-size: 0.875rem;
        }

        .card-edit-button {
          flex-shrink: 0;
          align-self: flex-start;
        }

        .card-edit-button button {
          font-size: 0.75rem;
          padding: 0.375rem 0.75rem;
          white-space: nowrap;
        }

        /* ã‚«ãƒ¼ãƒ‰ä¸­å¤®: åˆ¶ä½œãƒ¡ãƒ¢ã‚¨ãƒªã‚¢ */
        .card-memo-section {
          background-color: var(--brand-light);
          border: 1px solid var(--ui-border-light);
          border-radius: 0.5rem;
          padding: 0.75rem;
          min-height: 4rem;
        }

        .card-memo-section .memo-label {
          font-size: 0.75rem;
          font-weight: 600;
          color: var(--brand-subtle);
          margin-bottom: 0.5rem;
          display: block;
        }

        .card-memo-section .memo-content {
          color: var(--brand-text);
          font-size: 0.875rem;
          line-height: 1.4;
          white-space: pre-wrap;
          word-break: break-word;
        }

        .card-memo-section .memo-empty {
          color: var(--brand-muted);
          font-style: italic;
        }

        /* ã‚«ãƒ¼ãƒ‰ä¸‹éƒ¨: å½“æ—¥ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹ä¼šè¨ˆãƒœã‚¿ãƒ³ */
        .card-accounting-section {
          border-top: 1px solid var(--ui-border-light);
          padding-top: 0.75rem;
          display: flex;
          justify-content: center;
        }

        .card-accounting-section button {
          min-width: 150px;
        }

        /* å½“æ—¥ä»¥å¤–ã¯ä¼šè¨ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º */
        .card-accounting-section.hidden {
          display: none;
        }

        /* ãƒœã‚¿ãƒ³é…ç½®ã®çµ±ä¸€ï¼ˆå•é¡Œ#27,33å¯¾å¿œï¼‰ */
        .button-group {
          display: flex;
          gap: 0.75rem;
          justify-content: center;
          flex-wrap: wrap;
          margin: 1rem 0;
        }

        /* å·¦å¯„ã›ãŒé©åˆ‡ãªãƒšãƒ¼ã‚¸ã§ã¯å·¦å¯„ã›ã‚’ç¶­æŒ */
        .button-group.left-aligned {
          justify-content: flex-start;
        }

        /* ã‚ªãƒ¬ãƒ³ã‚¸è‰²ãƒœã‚¿ãƒ³ã®é…ç½®ä¿®æ­£ï¼ˆå•é¡Œ#27å¯¾å¿œï¼‰ */
        .button-group button.accounting {
          flex-shrink: 0;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«é•·ã•åˆ¶é™ï¼ˆå•é¡Œ#15å¯¾å¿œï¼‰ */
        .modal-content {
          max-height: 80vh;
          overflow-y: auto;
        }

        @media screen and (max-height: 600px) {
          .modal-content {
            max-height: 70vh;
          }
        }

        /* ========== ãƒšãƒ¼ã‚¸é·ç§»ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ç®¡ç†ï¼ˆå•é¡Œ#16å¯¾å¿œï¼‰ ========== */
        .page-container {
          min-height: 100vh;
          scroll-behavior: smooth;
        }

        /* ãƒšãƒ¼ã‚¸é·ç§»æ™‚ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãƒªã‚»ãƒƒãƒˆ */
        .view-transition {
          animation: pageSlideIn 0.3s ease-out;
        }

        @keyframes pageSlideIn {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        /* ========== æ–‡å­—ã®ã¡ã‚‰ã¤ãé˜²æ­¢ï¼ˆå•é¡Œ#6å¯¾å¿œï¼‰ ========== */
        .content-container {
          opacity: 0;
          transition: opacity 0.2s ease-in;
        }

        .content-container.loaded {
          opacity: 1;
        }

        /* ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿å®Œäº†ã¾ã§éè¡¨ç¤º */
        .font-loading .content-container {
          visibility: hidden;
        }

        /* ========== Skeleton Loading States ========== */
        .skeleton {
          background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
          background-size: 200% 100%;
          animation: loading 1.5s infinite;
        }
        @keyframes loading {
          0% { background-position: 200% 0; }
          100% { background-position: -200% 0; }
        }

        /* ========== Enhanced Responsive Design ========== */

        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨èª¿æ•´ */
        @media screen and (min-width: 641px) and (max-width: 1024px) {
          .container {
            max-width: 600px;
            padding: 2rem;
          }

          .button-group {
            gap: 1rem;
          }

          .reservation-card .card-actions button {
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
          }
        }

        /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ç”¨èª¿æ•´ */
        @media (max-width: 640px) {
          .modal-content {
            width: 95%;
            padding: 1rem;
            margin: 1rem;
          }
          .mobile-button, .mobile-input { font-size: 16px; }

          /* ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã®å°ç”»é¢å¯¾å¿œ */
          .button-group {
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
          }

          .button-group button {
            width: 100%;
            max-width: 280px;
          }

          /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ãƒ¢ãƒã‚¤ãƒ«èª¿æ•´ */
          .back-button-container {
            top: 0.5rem;
            right: 0.5rem;
          }

          .back-button-container button {
            padding: 0.5rem;
            font-size: 0.875rem;
          }

          /* ã‚«ãƒ¼ãƒ‰ã®ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– */
          .reservation-card, .record-card {
            padding: 0.75rem;
            gap: 0.75rem;
          }

          .card-header {
            flex-direction: column;
            gap: 0.75rem;
            align-items: stretch;
          }

          .card-edit-button {
            align-self: center;
          }

          .card-edit-button button {
            width: 100%;
            max-width: 120px;
          }

          .card-memo-section {
            padding: 0.5rem;
          }

          .card-accounting-section button {
            width: 100%;
            max-width: 200px;
          }
        }

        /* æ¥µå°ç”»é¢ï¼ˆ320pxä»¥ä¸‹ï¼‰å¯¾å¿œ */
        @media (max-width: 320px) {
          .container {
            padding: 0.5rem;
          }

          .button-group button {
            font-size: 0.875rem;
            padding: 0.75rem;
          }

          .modal-content {
            margin: 0.5rem;
            padding: 0.75rem;
          }
        }
      `;
    document.head.appendChild(style);
  };

  // =================================================================
  // Font Loading Detection
  // =================================================================
  const setupFontLoadingDetection = () => {
    if ('fonts' in document) {
      document.fonts.ready.then(() => {
        document.documentElement.classList.add('fonts-loaded');
      });
    } else {
      // Fallback for older browsers
      setTimeout(() => {
        document.documentElement.classList.add('fonts-loaded');
      }, 1000);
    }
  };

  // =================================================================
  // Page Transition & Content Loading Management
  // =================================================================
  const setupPageTransitionManagement = () => {
    let currentView = null;
    let previousScrollPosition = 0;

    // ãƒšãƒ¼ã‚¸é·ç§»æ™‚ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãƒªã‚»ãƒƒãƒˆï¼ˆå•é¡Œ#16å¯¾å¿œï¼‰
    const resetScrollPosition = () => {
      window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });
    };

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜
    const saveScrollPosition = () => {
      previousScrollPosition = window.scrollY;
    };

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
    const restoreScrollPosition = () => {
      window.scrollTo({
        top: previousScrollPosition,
        left: 0,
        behavior: 'auto',
      });
    };

    // ãƒšãƒ¼ã‚¸é·ç§»ã®åˆ¤å®šã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç®¡ç†
    const handleViewChange = (newView, isModal = false) => {
      const hasViewChanged = currentView !== newView;

      if (isModal) {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰ï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿æŒ
        if (newView) {
          // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ãæ™‚ï¼šç¾åœ¨ä½ç½®ã‚’ä¿å­˜
          saveScrollPosition();
        } else {
          // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹æ™‚ï¼šä½ç½®ã‚’å¾©å…ƒ
          restoreScrollPosition();
        }
      } else if (hasViewChanged && newView) {
        // å®Ÿéš›ã®ãƒšãƒ¼ã‚¸é·ç§»ï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
        currentView = newView;
        resetScrollPosition();
      }
    };

    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆå•é¡Œ#6å¯¾å¿œï¼‰
    const initializeContentVisibility = () => {
      // ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…æ©Ÿ
      document.fonts.ready.then(() => {
        const contentContainers = document.querySelectorAll('.content-container');
        contentContainers.forEach(container => {
          container.classList.add('loaded');
        });
      });

      // ãƒšãƒ¼ã‚¸é·ç§»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      const pageContainer = document.querySelector('.page-container');
      if (pageContainer) {
        pageContainer.classList.add('view-transition');
      }
    };

    // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ä½ç½®èª¿æ•´ï¼ˆå•é¡Œ#36å¯¾å¿œï¼‰
    const stabilizeBackButtonPosition = () => {
      const backButtonContainer = document.querySelector(
        '.back-button-container',
      );
      if (backButtonContainer) {
        // ä½ç½®ã®å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ
        backButtonContainer.style.transform = 'none';
        backButtonContainer.style.transition = 'none';

        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰transitionã‚’å¾©æ´»ï¼ˆã‚¹ãƒ ãƒ¼ã‚ºãªå‹•ä½œã®ãŸã‚ï¼‰
        setTimeout(() => {
          backButtonContainer.style.transition = 'all 0.2s ease';
        }, 100);
      }
    };

    return {
      resetScrollPosition,
      saveScrollPosition,
      restoreScrollPosition,
      handleViewChange,
      initializeContentVisibility,
      stabilizeBackButtonPosition,

      // çµ±åˆåˆæœŸåŒ–é–¢æ•°
      initializePage: () => {
        // åˆå›èª­ã¿è¾¼ã¿æ™‚ã¯ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã‚’è¨˜éŒ²ã™ã‚‹ã®ã¿ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒªã‚»ãƒƒãƒˆã—ãªã„
        if (window.stateManager && window.stateManager.getState) {
          currentView = window.stateManager.getState().view;
        }
        initializeContentVisibility();
        stabilizeBackButtonPosition();
      },

      // ãƒšãƒ¼ã‚¸é·ç§»æ™‚å°‚ç”¨åˆæœŸåŒ–ï¼ˆStateManagerã‹ã‚‰å‘¼ã³å‡ºã—ï¼‰
      onPageTransition: newView => {
        handleViewChange(newView, false);
      },

      // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œæ™‚å°‚ç”¨ï¼ˆshowInfo, showConfirmç­‰ã‹ã‚‰å‘¼ã³å‡ºã—ï¼‰
      onModalOpen: () => {
        handleViewChange('modal', true);
      },

      onModalClose: () => {
        handleViewChange(null, true);
      },
    };
  };

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆStateManagerã‹ã‚‰ä½¿ç”¨å¯èƒ½ï¼‰
  window.pageTransitionManager = setupPageTransitionManagement();

  // =================================================================
  // Mobile & Embedded Site Detection
  // =================================================================
  const setupMobileOptimizations = () => {
    // Googleã‚µã‚¤ãƒˆåŸ‹ã‚è¾¼ã¿æ¤œçŸ¥
    const detectEmbeddedEnvironment = () => {
      try {
        // iframeå†…ã§ã®å®Ÿè¡Œã‹ã©ã†ã‹ã‚’åˆ¤å®š
        const isInIframe = window.self !== window.top;

        // Googleã‚µã‚¤ãƒˆã®referrerã‚’æ¤œçŸ¥
        const isFromGoogleSites = document.referrer.includes('sites.google.com');

        // URLã®ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã®åˆ¤å®šï¼ˆå°†æ¥çš„ãªæ‹¡å¼µç”¨ï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        const embedParam = urlParams.get('embedded');

        return isInIframe || isFromGoogleSites || embedParam === 'true';
      } catch (e) {
        // Cross-originåˆ¶é™ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€åŸ‹ã‚è¾¼ã¿ç’°å¢ƒã¨åˆ¤å®š
        return true;
      }
    };

    // ãƒ¢ãƒã‚¤ãƒ«ç’°å¢ƒã®æ¤œçŸ¥
    const isMobile =
      /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
        navigator.userAgent,
      ) || window.innerWidth <= 768;

    // viewportè¨­å®šã®æœ€é©åŒ–
    const optimizeViewport = () => {
      let viewport = document.querySelector('meta[name=viewport]');
      if (!viewport) {
        viewport = document.createElement('meta');
        viewport.name = 'viewport';
        document.head.appendChild(viewport);
      }

      if (isMobile) {
        viewport.content =
          'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover';
      } else {
        viewport.content = 'width=device-width, initial-scale=1.0';
      }
    };

    // åŸ‹ã‚è¾¼ã¿ç’°å¢ƒã§ã®èª¿æ•´ã‚’é©ç”¨
    if (detectEmbeddedEnvironment()) {
      document.body.classList.add('embedded-in-google-sites');

      // å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã®èª¿æ•´
      if (isMobile) {
        document.body.classList.add('mobile-embedded');
      }
    }

    optimizeViewport();

    // ã‚¿ãƒƒãƒæ“ä½œã®æœ€é©åŒ–
    if (isMobile) {
      document.body.classList.add('touch-device');

      // iOS Safariã§ã®ãƒã‚¦ãƒ³ã‚¹åŠ¹æœã‚’ç„¡åŠ¹åŒ–
      document.addEventListener(
        'touchmove',
        e => {
          if (e.target.closest('.scrollable')) {
            return; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã‚¨ãƒªã‚¢å†…ã§ã¯è¨±å¯
          }
          e.preventDefault();
        },
        { passive: false },
      );
    }
  };

  // =================================================================
  // 4. TAILWIND CSS SETUP
  // =================================================================
  // æ³¨æ„: CDNç‰ˆTailwindã¯æœ¬ç•ªç’°å¢ƒã§ã¯æ¨å¥¨ã•ã‚Œã¾ã›ã‚“ãŒã€Google Apps Scriptç’°å¢ƒã§ã¯
  // PostCSS pluginã‚„Tailwind CLIã®åˆ©ç”¨ãŒå›°é›£ãªãŸã‚ã€CDNç‰ˆã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
  const setupTailwindCSS = () => {
    const tailwindScript = document.createElement('script');
    tailwindScript.src = 'https://cdn.tailwindcss.com';

    tailwindScript.onload = function () {
      if (window.tailwind) {
        window.tailwind.config = {
          theme: {
            extend: {
              fontSize: { '2xs': '0.625rem' },
              fontFamily: { sans: ['Zen Kaku Gothic New', 'sans-serif'] },
              colors: {
                brand: {
                  bg: '#FFFDF5',
                  surface: '#FFFFFF',
                  text: '#4E342E',
                  subtle: '#785A4E',
                  light: '#F5F1ED',
                  dark: '#4E342E',
                  muted: '#A1887F',
                },
                action: {
                  'primary-bg': '#C86F34',
                  'primary-text': '#FFFFFF',
                  'primary-hover': '#A95B2A',
                  'secondary-bg': '#E4CDBA',
                  'secondary-text': '#4E342E', // Improved contrast
                  'secondary-hover': '#D7BCA9',
                  'attention-bg': '#5A8C36',
                  'attention-text': '#FFFFFF',
                  'attention-hover': '#4A732C',
                  'accounting-bg': '#F59E0B', // Amber
                  'accounting-text': '#4E342E', // Dark text for readability
                  'accounting-hover': '#D97706',
                  'danger-bg': '#B91C1C',
                  'danger-text': '#FFFFFF',
                  'danger-hover': '#991B1B',
                  'paid-bg': '#F0FDF4',
                  'paid-text': '#166534',
                },
                state: {
                  'available-text': '#166534',
                  'available-bg': '#F0FDF4',
                  'available-border': '#A7F3D0',
                  'available-hover': '#D1FAE5',
                  'waitlist-text': '#B45309',
                  'waitlist-bg': '#FFFBEB',
                  'waitlist-border': '#FDE68A',
                  'booked-text': '#44403C',
                  'booked-bg': '#F5F5F4',
                  'booked-border': '#E7E5E4',
                  'success-bg': '#F0FDF4',
                  'success-text': '#166534',
                  'success-border': '#A7F3D0',
                  'success-hover': '#D1FAE5',
                  'danger-bg': '#FEF2F2',
                  'danger-text': '#B91C1C',
                  'danger-border': '#FECACA',
                  'danger-hover': '#FEE2E2',
                },
                ui: {
                  border: '#E4CDBA',
                  'border-light': '#F5F1ED',
                  surface: '#FFFFFF',
                  input: '#FAFAFA',
                  'input-focus': '#FFFFFF',
                  'error-text': '#B91C1C',
                  'error-bg': '#FEF2F2',
                  'error-border': '#FECACA',
                  'warning-text': '#B45309',
                  'warning-bg': '#FFFBEB',
                  'warning-border': '#FDE68A',
                  'link-text': '#0369A1',
                  'weekend-sunday': '#B91C1C',
                  'weekend-saturday': '#0369A1',
                },
              },
            },
          },
        };
      }
    };

    tailwindScript.onerror = function () {
      console.warn('[CONFIG] Tailwind CSSèª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    };

    document.head.appendChild(tailwindScript);
  };

  // =================================================================
  // 5. INITIALIZATION
  // =================================================================
  addCustomStyles();
  setupTailwindCSS();
  setupFontLoadingDetection();
  setupMobileOptimizations();

  // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ãƒšãƒ¼ã‚¸é·ç§»ç®¡ç†ã‚’åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', () => {
    if (window.pageTransitionManager) {
      window.pageTransitionManager.initializePage();
    }
  });


  // =================================================================
  // 12_WebApp_Core.js (è‡ªå‹•çµ±åˆ)
  // =================================================================

  // @ts-check
  /// <reference path="../types.d.ts" />

  /**
   * =================================================================
   * ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: 12_WebApp_Core.js
   * ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘: 1.2
   * ã€å½¹å‰²ã€‘: WebAppã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«ãŠã‘ã‚‹ä¸­æ ¸æ©Ÿèƒ½ã‚’é›†ç´„ã—ã¾ã™ã€‚
   * - çŠ¶æ…‹ç®¡ç† (State Management)
   * - UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç”Ÿæˆ (UI Components)
   * - æ±ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ (Utilities)
   * - ä¼šè¨ˆè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (Calculation Logic)
   * ã€æ§‹æˆã€‘: 14ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®ã†ã¡ã®12ç•ªç›®
   * ã€v1.2ã§ã®å¤‰æ›´ç‚¹ã€‘:
   * - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å˜ç´”åŒ–ã§myReservationsçµ±ä¸€å®Œäº†ã€‚
   * - ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã‚’å‘ä¸Šã€‚
   * =================================================================
   */

  /**
   * =================================================================
   * --- New Data Model Client-Side Processing (2025-08-19) ---
   * =================================================================
   */

  // calculateSlotsFromReservationsé–¢æ•°ã¨transformReservationArrayToObjecté–¢æ•°ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ
  // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã¯å…¨ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã€getAvailableSlots()ã¨getUserReservations()ã‚’ä½¿ç”¨ã—ã¾ã™

  /**
   * =================================================================
   * --- çµ±ä¸€æ¤œç´¢é–¢æ•°ã‚·ã‚¹ãƒ†ãƒ  (2025-08-30) ---
   * ã€Œã‚ˆã‚„ãã€(myBookings) ã¨ã€Œãã‚ãã€(history) ã‚’çµ±ä¸€çš„ã«æ¤œç´¢ã™ã‚‹é–¢æ•°ç¾¤
   * =================================================================
   */

  /**
   * äºˆç´„IDã§ã€Œã‚ˆã‚„ãã€ã¨ã€Œãã‚ãã€ã‚’çµ±ä¸€çš„ã«æ¤œç´¢ã—ã¾ã™
   * @param {string} reservationId - æ¤œç´¢å¯¾è±¡ã®äºˆç´„ID
   * @param {object} state - stateManager.getState()ã®æˆ»ã‚Šå€¤
   * @returns {object|null} è¦‹ã¤ã‹ã£ãŸäºˆç´„/è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã€è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯null
   */
  function findReservationById(reservationId, state = null) {
    const currentState = state || window.stateManager?.getState();
    if (!currentState) return null;

    // myReservationsã‹ã‚‰ç›´æ¥æ¤œç´¢
    const reservation = currentState.myReservations?.find(
      item => item.reservationId === reservationId,
    );
    if (reservation) {
      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«åŸºã¥ã„ã¦typeåˆ†é¡ã‚’è¿½åŠ 
      if (reservation.status === window.STATUS.COMPLETED) {
        return { ...reservation, type: 'record' };
      } else {
        return { ...reservation, type: 'booking' };
      }
    }

    return null;
  }

  /**
   * æ—¥ä»˜ã¨æ•™å®¤ã§ã€Œã‚ˆã‚„ãã€ã¨ã€Œãã‚ãã€ã‚’çµ±ä¸€çš„ã«æ¤œç´¢ã—ã¾ã™
   * @param {string} date - æ¤œç´¢å¯¾è±¡ã®æ—¥ä»˜ (YYYY-MM-DD)
   * @param {string} classroom - æ¤œç´¢å¯¾è±¡ã®æ•™å®¤å
   * @param {object} state - stateManager.getState()ã®æˆ»ã‚Šå€¤
   * @returns {object|null} è¦‹ã¤ã‹ã£ãŸäºˆç´„/è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã€è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯null
   */
  function findReservationByDateAndClassroom(date, classroom, state = null) {
    const currentState = state || window.stateManager?.getState();
    if (!currentState) return null;

    // myReservationsã‹ã‚‰ç›´æ¥æ¤œç´¢ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿ã¯æ—¢ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§é™¤å¤–æ¸ˆã¿ï¼‰
    const reservation = currentState.myReservations?.find(
      item => item.date === date && item.classroom === classroom,
    );

    if (reservation) {
      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«åŸºã¥ã„ã¦typeåˆ†é¡ã‚’è¿½åŠ 
      if (reservation.status === window.STATUS.COMPLETED) {
        return { ...reservation, type: 'record' };
      } else {
        return { ...reservation, type: 'booking' };
      }
    }

    return null;
  }

  /**
   * æŒ‡å®šã•ã‚ŒãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®äºˆç´„/è¨˜éŒ²ã‚’æ¤œç´¢ã—ã¾ã™
   * @param {string} status - æ¤œç´¢å¯¾è±¡ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
   * @param {object} state - stateManager.getState()ã®æˆ»ã‚Šå€¤
   * @returns {Array} æ¡ä»¶ã«åˆè‡´ã™ã‚‹äºˆç´„/è¨˜éŒ²ã®é…åˆ—
   */
  function findReservationsByStatus(status, state = null) {
    const currentState = state || window.stateManager?.getState();
    if (!currentState) return [];

    // myReservationsã‹ã‚‰ç›´æ¥æ¤œç´¢
    const reservations =
      currentState.myReservations?.filter(item => item.status === status) || [];

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«åŸºã¥ã„ã¦typeåˆ†é¡ã‚’è¿½åŠ 
    return reservations.map(item => {
      if (item.status === window.STATUS.COMPLETED) {
        return { ...item, type: 'record' };
      } else {
        return { ...item, type: 'booking' };
      }
    });
  }

  /**
   * æ–°ã—ã„åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§å‡¦ç†ã—ã¦appStateã‚’æ§‹ç¯‰ã™ã‚‹
   * @param {object} data - getAppInitialDataã‹ã‚‰è¿”ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ (allStudents, accountingMaster, etc.)
   * @param {string} phone - ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã•ã‚ŒãŸé›»è©±ç•ªå·
   * @param {Array} availableSlots - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å–å¾—æ¸ˆã¿ã®ç©ºå¸­æƒ…å ±
   * @param {object | null} userReservations - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®äºˆç´„ã¨å±¥æ­´ãƒ‡ãƒ¼ã‚¿ {myBookings, myHistory}
   * @returns {object} setStateã«æ¸¡ã™ãŸã‚ã®æ–°ã—ã„çŠ¶æ…‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ { currentUser: null }
   */
  function processInitialData(
    data,
    phone,
    availableSlots,
    userReservations = null,
  ) {
    const { allStudents, accountingMaster, cacheVersions, today, constants } =
      data;

    // 1. é›»è©±ç•ªå·ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
    const currentUser = Object.values(allStudents).find(
      student => student.phone === phone,
    );

    if (!currentUser) {
      return { currentUser: null }; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„
    }

    // currentUserã®displayNameã‚’ã‚»ãƒƒãƒˆ
    currentUser.displayName = currentUser.nickname || currentUser.realName;

    // 2. å€‹äººäºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥ä¿å­˜ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¯è¡¨ç¤ºæ™‚ã«å®Ÿè¡Œï¼‰
    const myReservations = userReservations
      ? userReservations.myReservations
      : [];

    // 3. æ•™å®¤ä¸€è¦§ã¯çµ±åˆå®šæ•°ã‹ã‚‰å–å¾—ï¼ˆStateManagerã§è¨­å®šã•ã‚Œã‚‹ï¼‰
    // availableSlots ã‹ã‚‰å–å¾—ã™ã‚‹å¿…è¦ã¯ãªããªã£ãŸ
    const classroomsFromConstants = constants
      ? Object.values(constants.classrooms)
      : [];

    // 4. ç©ºãæ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç”Ÿæˆ
    const slotsVersion = cacheVersions
      ? `${cacheVersions.allReservations || 0}-${cacheVersions.scheduleMaster || 0}`
      : null;

    // 5. appStateã‚’æ§‹ç¯‰ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ãªã„ç”Ÿã®äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼‰
    return {
      view: 'dashboard',
      currentUser: currentUser,
      myReservations: myReservations, // ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥ä¿å­˜
      slots: availableSlots,
      classrooms: classroomsFromConstants,
      accountingMaster: accountingMaster,
      today: today,
      constants: constants, // çµ±ä¸€å®šæ•°ã‚’è¿½åŠ 
      _allStudents: allStudents,
      _cacheVersions: cacheVersions,
      _slotsVersion: slotsVersion, // ç©ºãæ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®š
    };
  }

  // =================================================================
  // --- Application State Management ---
  // -----------------------------------------------------------------
  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®å‹•çš„ãªçŠ¶æ…‹ã‚’ä¸€å…ƒç®¡ç†ã—ã¾ã™ã€‚
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€äºˆç´„ãƒ‡ãƒ¼ã‚¿ã€ç¾åœ¨ã®è¡¨ç¤ºç”»é¢ãªã©ãŒå«ã¾ã‚Œã¾ã™ã€‚
  // =================================================================

  // =================================================================
  // --- Environment Detection & Data Management ---
  // -----------------------------------------------------------------
  // å®Ÿè¡Œç’°å¢ƒã‚’è‡ªå‹•æ¤œå‡ºã—ã€é©åˆ‡ãªãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’é¸æŠã—ã¾ã™ã€‚
  // ãƒ†ã‚¹ãƒˆç’°å¢ƒ: ãƒ–ãƒ©ã‚¦ã‚¶ + ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
  // æœ¬ç•ªç’°å¢ƒ: Google Apps Script + å®Ÿãƒ‡ãƒ¼ã‚¿
  // =================================================================

  /**
   * å®Ÿè¡Œç’°å¢ƒã®æ¤œå‡º
   * @returns {string} 'test' | 'production'
   */
  const detectEnvironment = () => {
    try {
      // GASç’°å¢ƒã®æ¤œå‡º
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        return 'production';
      }
      return 'test';
    } catch (error) {
      return 'test';
    }
  };

  /**
   * ç’°å¢ƒã«å¿œã˜ãŸãƒ‡ãƒ¼ã‚¿å–å¾—
   * @param {string} dataType - ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—
   * @param {any} fallback - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
   */
  const getEnvironmentData = (dataType, fallback = null) => {
    const env = detectEnvironment();

    if (env === 'test' && typeof MockData !== 'undefined') {
      return MockData[dataType] || fallback;
    }

    // GASç’°å¢ƒã§ã¯åˆæœŸå€¤ã®ã¿è¿”ã—ã€ãƒ‡ãƒ¼ã‚¿ã¯å¾Œã§APIå‘¼ã³å‡ºã—ã§å–å¾—
    return fallback;
  };

  // StateManagerã®å†åˆæœŸåŒ–ï¼ˆä¾å­˜é–¢æ•°ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œï¼‰
  if (
    typeof window.initializeStateManager === 'function' &&
    !window.stateManager
  ) {
    console.log('ğŸ”„ StateManagerã‚’å†åˆæœŸåŒ–ä¸­...');
    window.initializeStateManager();
  }

  // StateManagerãŒåˆæœŸåŒ–ã•ã‚ŒãŸå¾Œã«ãƒ“ãƒ¥ãƒ¼ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
  // DOMContentLoadedã¾ãŸã¯ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å®Ÿè¡Œ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      if (window.stateManager && typeof setupViewListener === 'function') {
        setupViewListener();
      }
    });
  } else {
    // æ—¢ã«DOMãŒèª­ã¿è¾¼ã¿æ¸ˆã¿ã®å ´åˆã¯å³åº§ã«å®Ÿè¡Œ
    if (window.stateManager && typeof setupViewListener === 'function') {
      setupViewListener();
    }
  }

  // æ³¨æ„: appStateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯æ–°ã—ã„StateManagerã‚·ã‚¹ãƒ†ãƒ ï¼ˆ12_WebApp_StateManager.htmlï¼‰ã«ç§»è¡Œã•ã‚Œã¾ã—ãŸ
  // ä¸‹ä½äº’æ›æ€§ã®ãŸã‚ã€appStateã¨setStateã¯è‡ªå‹•çš„ã«StateManagerã«ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¾ã™

  // æ—¢å­˜ã‚³ãƒ¼ãƒ‰äº’æ›æ€§ã®ãŸã‚ã€appStateã¯12_WebApp_StateManager.htmlã§å®šç¾©ã•ã‚Œã€
  // window.appStateã¨ã—ã¦å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™

  /**
   * ãƒ¢ãƒ¼ãƒ€ãƒ«ç®¡ç†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   * ã‚«ãƒ—ã‚»ãƒ«åŒ–ã•ã‚ŒãŸæ–¹å¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚’ç®¡ç†ã™ã‚‹
   * ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®ä¹±ç”¨ã‚’é¿ã‘ã‚‹ãŸã‚ã®è¨­è¨ˆ
   */
  const ModalManager = {
    onConfirmCallback: null,

    /**
     * ãƒ¢ãƒ¼ãƒ€ãƒ«ç¢ºèªæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’è¨­å®š
     * @param {Function} callback - ç¢ºèªãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«å®Ÿè¡Œã™ã‚‹é–¢æ•°
     */
    setCallback: function (callback) {
      this.onConfirmCallback = callback;
    },

    /**
     * è¨­å®šã•ã‚ŒãŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’ã‚¯ãƒªã‚¢
     */
    clearCallback: function () {
      this.onConfirmCallback = null;
    },

    /**
     * è¨­å®šã•ã‚ŒãŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®Ÿè¡Œã—ã€è‡ªå‹•ã§ã‚¯ãƒªã‚¢ã™ã‚‹
     * ãƒ¢ãƒ¼ãƒ€ãƒ«ç¢ºèªãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹
     */
    executeCallback: function () {
      if (this.onConfirmCallback) {
        this.onConfirmCallback();
        this.clearCallback();
      }
    },
  };

  // =================================================================
  // --- Utility Functions ---
  // -----------------------------------------------------------------

  /**
   * é›»è©±ç•ªå·ã‚’æ­£è¦åŒ–ã—ã¾ã™ï¼ˆå…¨è§’â†’åŠè§’ã€ãƒã‚¤ãƒ•ãƒ³å‰Šé™¤ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
   * ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®normalizePhoneNumberé–¢æ•°ã¨åŒç­‰ã®å‡¦ç†ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å®Ÿè¡Œ
   * @param {string} phoneInput - å…¥åŠ›ã•ã‚ŒãŸé›»è©±ç•ªå·
   * @returns {{normalized: string, isValid: boolean, error?: string}} æ­£è¦åŒ–çµæœ
   */
  window.normalizePhoneNumberFrontend = function (phoneInput) {
    if (!phoneInput || typeof phoneInput !== 'string') {
      return {
        normalized: '',
        isValid: false,
        error: 'é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
      };
    }

    // å…¨è§’æ•°å­—ã‚’åŠè§’ã«å¤‰æ›
    let normalized = phoneInput.replace(/[ï¼-ï¼™]/g, s =>
      String.fromCharCode(s.charCodeAt(0) - 65248),
    );

    // å„ç¨®ãƒã‚¤ãƒ•ãƒ³ã‚’å‰Šé™¤
    normalized = normalized.replace(/[â€ï¼\-]/g, '');

    // ç©ºç™½æ–‡å­—ã‚’å‰Šé™¤
    normalized = normalized.replace(/\s/g, '');

    // å›½ç•ªå·ã®è‡ªå‹•ä¿®æ­£å‡¦ç†
    // +81ã¾ãŸã¯81ã§å§‹ã¾ã‚‹å ´åˆã¯æ—¥æœ¬ã®æ¨™æº–å½¢å¼ã«å¤‰æ›
    if (normalized.startsWith('+81')) {
      normalized = '0' + normalized.substring(3);
    } else if (normalized.startsWith('81') && normalized.length >= 12) {
      // 81ã§å§‹ã¾ã‚Šã€12æ¡ä»¥ä¸Šã®å ´åˆï¼ˆ81 + 11æ¡ã®æ—¥æœ¬ã®ç•ªå·ï¼‰
      normalized = '0' + normalized.substring(2);
    }

    // æ•°å­—ä»¥å¤–ã®æ–‡å­—ã‚’ãƒã‚§ãƒƒã‚¯
    if (!/^\d+$/.test(normalized)) {
      return {
        normalized: '',
        isValid: false,
        error: 'é›»è©±ç•ªå·ã¯æ•°å­—ã®ã¿å…¥åŠ›ã—ã¦ãã ã•ã„',
      };
    }

    // æ¡æ•°ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¥æœ¬ã®æºå¸¯ãƒ»å›ºå®šé›»è©±ã¯11æ¡ã¾ãŸã¯10æ¡ï¼‰
    if (normalized.length !== 11 && normalized.length !== 10) {
      return {
        normalized: '',
        isValid: false,
        error: 'é›»è©±ç•ªå·ã¯10æ¡ã¾ãŸã¯11æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„',
      };
    }

    // å…ˆé ­ç•ªå·ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¥æœ¬ã®é›»è©±ç•ªå·ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
    if (normalized.length === 11 && !normalized.startsWith('0')) {
      return {
        normalized: '',
        isValid: false,
        error: '11æ¡ã®é›»è©±ç•ªå·ã¯0ã‹ã‚‰å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™',
      };
    }

    return { normalized, isValid: true };
  };

  // =================================================================
  // --- UI Components (Moved to 13_WebApp_Components.html) ---
  // -----------------------------------------------------------------
  // UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç”Ÿæˆé–¢æ•°ç¾¤ã¯13_WebApp_Components.htmlã«ç§»å‹•ã•ã‚Œã¾ã—ãŸã€‚
  //
  // ç§»è¡Œã•ã‚ŒãŸå†…å®¹:
  // - window.escapeHTML é–¢æ•°
  // - Components ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆå…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰
  // - æ–°è¨­è¨ˆã®ã‚·ãƒ³ãƒ—ãƒ«åŒ–ã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
  // - ãƒ¬ã‚¬ã‚·ãƒ¼äº’æ›æ€§ã‚µãƒãƒ¼ãƒˆ
  // =================================================================

  // =================================================================
  // --- Loading Message System ---
  // -----------------------------------------------------------------
  // UI-11: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¤šæ§˜åŒ–æ©Ÿèƒ½
  // çŠ¶æ³ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒ¦ãƒ¼ãƒ¢ãƒ©ã‚¹ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¡¨ç¤ºã—ã€
  // æ•°ç§’ã”ã¨ã«è‡ªå‹•ã§åˆ‡ã‚Šæ›¿ãˆã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚
  // =================================================================
  let loadingMessageTimer = null;

  const LoadingMessages = {
    // ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    login: [
      'ã‚ã„ã¼ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã‚ã„ã¼ ã˜ãŸã„ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã‚ã„ã¼ ã® ã†ã‚‰ã® ã‚ã‚‚ ã‚’ ã‹ãã«ã‚“ ã—ã¦ã„ã¾ã™...',
      'ãã‚ã ã‚’ ã‹ãã«ã‚“ ã—ã¦ã„ã¾ã™...',
      'ã—ã‚‡ã‚‹ã„ ã‚’ ã²ã‚‚ã¨ã„ã¦ ã—ã¦ã„ã¾ã™...',
      'ãªã¾ãˆ ã‚’ ã‹ãã«ã‚“ ã—ã¦ã„ã¾ã™...',
      'ãªã¾ãˆ ã® ã‚ˆã¿ã‹ãŸ ã‚’ ã‹ãã«ã‚“ ã—ã¦ã„ã¾ã™...',
      'ã‹ãŠ ã‚’ ãŠã‚‚ã„ã ã—ã¦ã„ã¾ã™...',
      'ãŠã¿ã‚„ã’ ã‚’ ãŠã‚‚ã„ã ã—ã¦ã„ã¾ã™...',
      'ã•ãã²ã‚“ ã‚’ ãŠã‚‚ã„ã ã—ã¦ã„ã¾ã™...',
      'ã¨ã†ã‚ã ãŒ ã‚ã‚‹ã‹ ã—ã‚‰ã¹ã¦ã„ã¾ã™...',
      'ã§ã‚“ã‚ã°ã‚“ã”ã† ã‚’ ã‹ãã«ã‚“ ã—ã¦ã„ã¾ã™...',
      'ã²ã¨ ã¨ ãªã‚Š ã‚’ ãã†ãã† ã—ã¦ã„ã¾ã™...',
      'ã«ãŒãŠ ãˆ ã‚’ ã‹ã„ã¦ã„ã¾ã™...',
    ],

    // ç”³ã—è¾¼ã¿æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    booking: [
      'ã‚ˆã‚„ã ã‚’ ã‚‚ã†ã—ã“ã¿ ã¡ã‚…ã†ã§ã™...',
      'ã—ã‚“ã›ã„ã—ã‚‡ ã‚’ ã¦ã„ã—ã‚…ã¤ ã—ã¦ã„ã¾ã™...',
      'ã¯ã‚“ã“ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã²ã¥ã‘ ã‚’ ã‹ãã«ã‚“ ã—ã¦ã„ã¾ã™...',
      'ã‹ã‚Œã‚“ã ãƒ¼ ã« ã‹ãã“ã‚“ã§ã„ã¾ã™...',
      'ã›ã ã‚’ ã‚ˆã†ã„ ã—ã¦ã„ã¾ã™...',
      'ãã¼ã† ã‚’ ã‹ãªãˆã‚ˆã†ã¨ã—ã¦ã„ã¾ã™...',
      'ã„ã‚ã„ã‚ãª ã¡ã‚‡ã†ã›ã„ ã‚’ ã—ã¦ã„ã¾ã™...',
      'ãã†ã”ã†ã¦ãã« ã¡ã‚‡ã†ã›ã„ ã‚’ ã—ã¦ã„ã¾ã™...',
      'ã—ã‚‡ã‚‹ã„ ã® ã‘ã„ã—ã ã‚’ ã‹ãã«ã‚“ã—ã¦ã„ã¾ã™...',
      'ã˜ã‚…ã‚“ã°ã‚“ ã« ãªã‚‰ã¹ã¦ã„ã¾ã™...',
    ],

    // äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    cancel: [
      'ã‚ˆã‚„ã ã‚’ ã¨ã‚Šã‘ã—ã¦ã„ã¾ã™...',
      'ã‘ã—ã”ã‚€ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã¨ã‚Šã‘ã—ã›ã‚“ ã‚’ ã²ã„ã¦ã„ã¾ã™...',
      'ãŠã ã„ã˜ã« ã¨ ãŠã‚‚ã£ã¦ã„ã¾ã™...',
      'ã¾ãŸ ã“ã‚“ã© ã‚’ ãŸã®ã—ã¿ã«ã—ã¦ã„ã¾ã™...',
      'ã¹ã¤ã® ã² ã‚’ ã‹ã‚“ãŒãˆã¦ã„ã¾ã™...',
    ],

    // äºˆç´„ç·¨é›†æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    edit: [
      'ã¸ã‚“ã“ã† ã‚’ ã»ãã‚“ã—ã¦ã„ã¾ã™...',
      'ã‚ãŸã‚‰ã—ã„ ãªã„ã‚ˆã† ã« ã‹ãã‹ãˆã¦ã„ã¾ã™...',
      'ã¾ã¡ãŒã„ ãŒ ãªã„ã‹ ã‹ãã«ã‚“ã—ã¦ã„ã¾ã™...',
      'ã‹ã‚“ãŒãˆãªãŠã—ã¦ ã¿ã¦ã„ã¾ã™...',
      'ã“ã ã‚ã‚Š ã‚’ ã¡ã‚‡ã†ã›ã„ ã—ã¦ã„ã¾ã™...',
    ],

    // ä¼šè¨ˆæ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    accounting: [
      'ã§ã‚“ã´ã‚‡ã† ã‚’ ãŠãã£ã¦ã„ã¾ã™...',
      'ã¡ã‚‡ã†ã¼ ã‚’ ã¤ã‘ã¦ã„ã¾ã™...',
      'ãŠã‹ã­ ã‚’ ã‹ããˆã¦ã„ã¾ã™...',
      'ãŠã¤ã‚Š ã‚’ ã˜ã‚…ã‚“ã³ã—ã¦ã„ã¾ã™...',
      'ãã‚ã°ã‚“ ã‚’ ã¯ã˜ã„ã¦ã„ã¾ã™...',
      'ã‘ã„ã•ã‚“ã ã‚’ ãŸãŸã„ã¦ã„ã¾ã™...',
      'ã½ã‘ã£ã¨ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã‘ã„ã‚Šã®ã²ã¨ ã‚’ ã‚ˆã‚“ã§ã„ã¾ã™...',
    ],

    // ãƒ‡ãƒ¼ã‚¿å–å¾—æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    dataFetch: [
      'ã„ã‚ã„ã‚ãªã‚‚ã® ã‚’ ã²ã£ãã‚Šã‹ãˆã—ã¦ã„ã¾ã™...',
      'ã•ãŒã—ã‚‚ã® ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ãŸã„ã›ã¤ãªã“ã¨ ã‚’ ãŠã‚‚ã„ã ã—ã¦ã„ã¾ã™...',
      'ã‚€ã“ã†ã®ã»ã† ã‚’ ã®ãã„ã¦ã„ã¾ã™...',
      'ã˜ã‚‡ã†ã»ã† ã‚’ ã¤ã‹ã¾ãˆã¦ã„ã¾ã™...',
      'ã—ã‚‡ã‚‹ã„ ã‚’ ã²ã£ãã‚Šã‹ãˆã—ã¦ã„ã¾ã™...',
    ],

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    default: [
      'ã›ã‚“ã›ã„ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã—ã‚‡ã‚‹ã„ ã‚’ ã›ã„ã‚Š ã—ã¦ã„ã¾ã™...',
      'ã—ã‚‡ã‚‹ã„ ã‚’ ãªãŒã‚ã¦ã„ã¾ã™...',
      'ã—ã‚‡ã‚‹ã„ ã® ã‘ã„ã—ã ã‚’ ã‹ãã«ã‚“ ã—ã¦ã„ã¾ã™...',
      'ã—ã‚‡ã‚‹ã„ ã‚’ ã¶ã‚“ã‚‹ã„ ã—ã¦ã„ã¾ã™...',
      'ãããš ã‚’ ã‹ãŸãšã‘ã¦ã„ã¾ã™...',
      'ã“ã¨ã° ã‚’ ãˆã‚‰ã‚“ã§ã„ã¾ã™...',
      'ã¦ã„ã•ã„ ã‚’ ã¨ã¨ã®ãˆã¦ã„ã¾ã™...',
      'ã¿ã ã® ã‚‚ã® ã‚’ ã²ã ã‚Š ã« ã†ã”ã‹ã—ã¦ã„ã¾ã™...',
      'ã²ã ã‚Š ã® ã‚‚ã® ã‚’ ã¿ã ã« ã†ã”ã‹ã—ã¦ã„ã¾ã™...',
      'ã“ãƒ¼ã²ãƒ¼ ã‚’ ã„ã‚Œã¦ã„ã¾ã™...',
      'ã™ã“ã— ãã‚…ã†ã‘ã„ ã—ã¦ã„ã¾ã™...',
      'ã­ã“ ã® ã¦ ã‚’ ã‹ã‚Šã‚ˆã†ã¨ã—ã¦ã„ã¾ã™...',
      'ã¯ã‚€ã™ãŸãƒ¼ ã® ã¦ ã‚’ ã‹ã‚Šã‚ˆã†ã¨ã—ã¦ã„ã¾ã™...',
      'ãã† ã® ã¯ãª ã‚’ ã‹ã‚Šã‚ˆã†ã¨ã—ã¦ã„ã¾ã™...',
      'ã‚ã ã‹ ã‚’ ãªãŒã‚ã¦ã„ã¾ã™...',
      'ã‚ã ã‹ ã‚’ ã‹ããˆã¦ã„ã¾ã™...',
      'ã¯ã‚‚ã® ã‚’ ã¨ã¨ã®ãˆã¦ã„ã¾ã™...',
      'ã¦ã‚“ ã¨ ã¦ã‚“ ã‚’ ã‚€ã™ã‚“ã§ã„ã¾ã™...',
      'ã‚ãŸã¾ ã‚’ ã‹ãã«ã‚“ ã—ã¦ã„ã¾ã™...',
      'ã›ã‚“ã›ã„ ã¯ ã—ã‚…ã†ã¡ã‚…ã† ã—ã¦ã„ã¾ã™...',
      'ã›ã‚“ã›ã„ ã¯ ã„ã¾ ã‚€ã‹ã£ã¦ã„ã¾ã™...',
      'ã‚ã·ã‚Š ã‚’ ã‹ã„ã‚Šã‚‡ã† ã—ã¦ã„ã¾ã™...',
      'ãœã‚“ãŸã„ ã¨ ã¶ã¶ã‚“ ã‚’ ã‹ã‚“ãŒãˆã¦ã„ã¾ã™...',
      'ã‚„ã‚‰ãªã„ã¨ã„ã‘ãªã„ã“ã¨ ã‚’ ãªãŒã‚ã¦ã„ã¾ã™...',
      'ã‚ãŸã‚‰ã—ã„ ã“ã¨ ã‚’ ã‹ã‚“ãŒãˆã¦ã„ã¾ã™...',
      'ã§ãã‚ãŒã‚Š ã‚’ ãŠã‚‚ã„ãˆãŒã„ã¦ã„ã¾ã™...',
      'ã¤ããˆ ã® ã†ãˆ ã§ ã—ã”ã¨ã‚‰ã—ãã“ã¨ ã‚’ ã—ã¦ã„ã¾ã™...',
      'ã¾ã‚‹ã„ ã‚‚ã® ã‚’ ã—ã‹ãã ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™...',
      'ã—ã‹ãã„ ã‚‚ã® ã‚’ ã¾ã‚‹ã ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™...',
      'ã—ã‹ãã„ ã‚‚ã® ã‚’ ã‚ˆã‚Šã—ã‹ãã ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™...',
      'ãŠã‚‚ã—ã‚ã„ ã‹ãŸã¡ ã‚’ ã‹ã‚“ãŒãˆã¦ã„ã¾ã™...',
      'ã˜ã‹ã‚“ ãŒ ã‚†ã£ãã‚Š ã™ãã¦ã„ã¾ã™...',
      'ã˜ã‹ã‚“ ãŒ ã‚ã£ã¨ã„ã†ã¾ã« ã™ãã¦ã„ã¾ã™...',
      'ã„ã„ ã‹ãŸã¡ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ãã‚Œã‚‰ã—ã„ ã“ã¨ã° ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ãªã«ã‚’ã—ã‚ˆã†ã¨ã—ã¦ã„ãŸã®ã‹ ã‚’ ãŠã‚‚ã„ã ã—ã¦ã„ã¾ã™...',
      'ã‹ãŸã¡ ã‚’ ãªãŒã‚ã¦ã„ã¾ã™...',
    ],
  };

  const getRandomMessage = (category = 'default') => {
    const messages = [
      ...(LoadingMessages[category] || []),
      ...LoadingMessages.default,
    ];
    return messages[Math.floor(Math.random() * messages.length)];
  };

  const updateLoadingMessage = (category = 'default') => {
    const messageElement = document.getElementById('loading-message');
    if (messageElement) {
      messageElement.textContent = getRandomMessage(category);
    }
  };

  const startLoadingMessageRotation = (category = 'default') => {
    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
    updateLoadingMessage(category);

    // 3ç§’ã”ã¨ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
    loadingMessageTimer = setInterval(() => {
      updateLoadingMessage(category);
    }, UI?.LOADING_MESSAGE_INTERVAL || 3000);
  };

  const stopLoadingMessageRotation = () => {
    if (loadingMessageTimer) {
      clearInterval(loadingMessageTimer);
      loadingMessageTimer = null;
    }
  };

  const showLoading = (category = 'default') => {
    const loadingElement = document.getElementById('loading');

    loadingElement.classList.remove('hidden');

    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    requestAnimationFrame(() => {
      loadingElement.classList.add('active');
    });

    startLoadingMessageRotation(category);
  };

  const hideLoading = () => {
    const loadingElement = document.getElementById('loading');

    loadingElement.classList.remove('active');

    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå®Œäº†å¾Œã«å®Œå…¨ã«éè¡¨ç¤º
    setTimeout(() => {
      loadingElement.classList.add('hidden');
      stopLoadingMessageRotation();
    }, 300); // CSS transitionã¨åŒã˜æ™‚é–“
  };

  // =================================================================
  // --- General Utilities ---
  /**
   * è²©å£²å“ãƒã‚¹ã‚¿ã‹ã‚‰ç‰©è²©ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆæŠ˜ã‚Šç•³ã¿å¯èƒ½ï¼‰ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
   * @param {Array} accountingMaster - è²©å£²å“ãƒã‚¹ã‚¿
   * @param {Array} checkedValues - ãƒã‚§ãƒƒã‚¯æ¸ˆã¿é …ç›®åé…åˆ—ï¼ˆä»»æ„ï¼‰
   * @param {string} [title='è²©å£²å“ãƒªã‚¹ãƒˆ'] - è¦‹å‡ºã—ã‚¿ã‚¤ãƒˆãƒ«
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  function buildSalesChecklist(
    accountingMaster,
    checkedValues = [],
    title = 'è²©å£²å“ãƒªã‚¹ãƒˆ',
  ) {
    const salesList = (accountingMaster || []).filter(
      item => item['ç¨®åˆ¥'] === 'ç‰©è²©',
    );
    if (!salesList.length) return '';
    const checklistHtml = getSalesCheckboxListHtml(salesList, checkedValues);
    return `
      <details class="mt-4">
        <summary class="cursor-pointer font-bold text-base py-2 px-3 bg-ui-surface border border-ui-border rounded hover:bg-ui-hover">${title} <span class="ml-2 text-sm text-brand-subtle">ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</span></summary>
        <div class="pt-2">${checklistHtml}</div>
      </details>
    `;
  }
  /**
   * ç‰©è²©ãƒªã‚¹ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§è¡¨ç¤ºã™ã‚‹HTMLã‚’è¿”ã™ï¼ˆå†åˆ©ç”¨å¯èƒ½ï¼‰
   * @param {Array} salesList - ç‰©è²©ã‚¢ã‚¤ãƒ†ãƒ é…åˆ—
   * @param {Array} checkedValues - ãƒã‚§ãƒƒã‚¯æ¸ˆã¿é …ç›®åé…åˆ—ï¼ˆä»»æ„ï¼‰
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  function getSalesCheckboxListHtml(salesList, checkedValues = []) {
    if (!salesList || salesList.length === 0) return '';
    return `
      <div class="mt-4 pt-4 border-t">
        <label class="font-bold mb-2 block">è³¼å…¥å¸Œæœ›ï¼ˆãƒã‚§ãƒƒã‚¯å¯ï¼‰</label>
        <div class="grid grid-cols-1 gap-2">
          ${salesList
            .map(
              item => `
            <label class="flex items-center space-x-2">
              <input type="checkbox" name="orderSales" value="${item[HEADERS.ACCOUNTING.ITEM_NAME]}" class="accent-action-primary-bg" ${checkedValues.includes(item[HEADERS.ACCOUNTING.ITEM_NAME]) ? 'checked' : ''}>
              <span>${item[HEADERS.ACCOUNTING.ITEM_NAME]}${item[HEADERS.ACCOUNTING.UNIT_PRICE] ? `ï¼ˆ${item[HEADERS.ACCOUNTING.UNIT_PRICE]}å††ï¼‰` : ''}</span>
            </label>
          `,
            )
            .join('')}
        </div>
      </div>`;
  }
  // -----------------------------------------------------------------
  // æ—¥ä»˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãªã©ã€
  // ã‚¢ãƒ—ãƒªå…¨ä½“ã§æ±ç”¨çš„ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤ã§ã™ã€‚
  // =================================================================

  // =================================================================
  // çµ±ä¸€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ08_ErrorHandler.jsã‹ã‚‰çµ±åˆï¼‰
  // =================================================================

  /**
   * ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±ä¸€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
   */
  class FrontendErrorHandler {
    /**
     * ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é©åˆ‡ã«é€šçŸ¥
     * @param {Error} error - ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {string} context - ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
     * @param {Object} additionalInfo - è¿½åŠ æƒ…å ±
     */
    static handle(error, context = '', additionalInfo = {}) {
      hideLoading(); // æ—¢å­˜ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤ºå‡¦ç†

      const errorInfo = {
        message: error.message || 'Unknown error',
        stack: error.stack || 'No stack trace available',
        context: context,
        timestamp: new Date().toISOString(),
        userId:
          (window.stateManager &&
            window.stateManager.getState().currentUser?.studentId) ||
          'anonymous',
        userAgent: navigator.userAgent,
        url: window.location.href,
        additionalInfo: additionalInfo,
      };

      // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã«å‡ºåŠ›
      console.error('[ERROR]', context, errorInfo);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥
      const userMessage = this.getUserFriendlyMessage(error, context);
      showInfo(userMessage, 'ã‚¨ãƒ©ãƒ¼');

      // é‡è¦ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯è©³ç´°ãƒ­ã‚°ã‚’é€ä¿¡ï¼ˆå°†æ¥çš„ã«Sentryãªã©ã¸ï¼‰
      if (this.isCriticalError(error)) {
        this.reportError(errorInfo);
      }
    }

    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
     * @param {Error} error - ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {string} context - ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
     * @returns {string} ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     */
    static getUserFriendlyMessage(error, context) {
      // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«åŸºã¥ã„ã¦é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
      const contextMessages = {
        login:
          'ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚é›»è©±ç•ªå·ã‚’ç¢ºèªã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
        booking:
          'äºˆç´„å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
        cancel:
          'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
        accounting:
          'ä¼šè¨ˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
        'data-load':
          'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
      };

      return (
        contextMessages[context] ||
        `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}\n\næ™‚é–“ã‚’ãŠã„ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`
      );
    }

    /**
     * é‡è¦ãªã‚¨ãƒ©ãƒ¼ã‹ã©ã†ã‹ã‚’åˆ¤å®š
     * @param {Error} error - ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @returns {boolean}
     */
    static isCriticalError(error) {
      const criticalMessages = [
        'Script runtime exceeded',
        'Service invoked too many times',
        'Network error',
        'Timeout',
      ];

      return criticalMessages.some(
        msg => error.message && error.message.includes(msg),
      );
    }

    /**
     * ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡ï¼ˆå°†æ¥çš„ã«Sentryãªã©ã®ç›£è¦–ã‚µãƒ¼ãƒ“ã‚¹ã¸ï¼‰
     * @param {Object} errorInfo - ã‚¨ãƒ©ãƒ¼æƒ…å ±
     */
    static reportError(errorInfo) {
      // ç¾åœ¨ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®ã¿
      // å°†æ¥çš„ã«Sentryã€Bugsnagã€LogRocketãªã©ã«é€ä¿¡
      console.log('[CRITICAL ERROR REPORT]', errorInfo);

      // ç®¡ç†è€…ã¸ã®ç·Šæ€¥é€šçŸ¥ã‚‚æ¤œè¨
      // ã“ã®éƒ¨åˆ†ã¯å°†æ¥çš„ã«å®Ÿè£…äºˆå®š
    }
  }

  /**
   * æ—¢å­˜ã®handleServerErroré–¢æ•°ã¨ã®äº’æ›æ€§ã‚’ä¿ã¤ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°
   * æ®µéšçš„ç§»è¡Œã®ãŸã‚æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®äº’æ›æ€§ã‚’ç¶­æŒ
   * @param {Error} err - ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  function handleServerError(err) {
    FrontendErrorHandler.handle(err, 'server-error');
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®è¨­å®š
  window.addEventListener('error', event => {
    FrontendErrorHandler.handle(event.error, 'global-error', {
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno,
    });
  });

  // Promiseæ‹’å¦ã‚¨ãƒ©ãƒ¼ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  window.addEventListener('unhandledrejection', event => {
    FrontendErrorHandler.handle(
      new Error(event.reason),
      'unhandled-promise-rejection',
    );
  });

  const formatDate = dStr => {
    if (!dStr) return '';
    const d = new Date(dStr);
    if (isNaN(d)) return '';
    d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
    const day = d.getDay();
    const wd = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
    return `${d.getMonth() + 1}/${d.getDate()} <span class="font-bold ${day === 0 ? 'text-ui-weekend-sunday' : day === 6 ? 'text-ui-weekend-saturday' : ''}">${wd[day]}</span>`;
  };
  const showModal = c => {
    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜
    if (window.pageTransitionManager) {
      window.pageTransitionManager.onModalOpen();
    }

    const m = document.getElementById('custom-modal'),
      b = document.getElementById('modal-buttons');
    b.innerHTML = '';
    if (c.showCancel) {
      b.innerHTML += Components.createButton({
        text:
          c.cancelText ||
          window.stateManager.getState().constants?.messages?.CANCEL ||
          'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
        action: 'modalCancel',
        colorClass: DesignConfig.colors.secondary,
        widthClass: DesignConfig.buttons.auto,
      });
    }
    if (c.confirmText) {
      b.innerHTML += `<div class="w-3"></div>${Components.createButton({ text: c.confirmText, action: 'modalConfirm', colorClass: c.confirmColorClass, widthClass: DesignConfig.buttons.auto, disabled: c.disableConfirm })}`;
    }
    ModalManager.setCallback(c.onConfirm);
    document.getElementById('modal-title').textContent = c.title;
    document.getElementById('modal-message').innerHTML = c.message;
    m.classList.add('active');
  };
  const hideModal = () => {
    document.getElementById('custom-modal').classList.remove('active');
    ModalManager.clearCallback();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤ºæ™‚ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
    if (window.pageTransitionManager) {
      window.pageTransitionManager.onModalClose();
    }
  };
  const showInfo = (msg, t = 'æƒ…å ±', cb = null) =>
    showModal({
      title: t,
      message: msg,
      confirmText: 'OK',
      confirmColorClass: DesignConfig.colors.primary,
      onConfirm: cb,
    });
  const showConfirm = c => showModal({ ...c, showCancel: true });

  // =================================================================
  // --- Computed Data Management ---
  // -----------------------------------------------------------------
  // stateManager.getState().computedã®è¨ˆç®—ãƒ»æ›´æ–°å‡¦ç†ã‚’ç®¡ç†ã—ã¾ã™ã€‚
  // =================================================================

  // =================================================================
  // --- Accounting Cache Utilities ---
  // -----------------------------------------------------------------
  // FE-14: ä¼šè¨ˆå…¥åŠ›å†…å®¹ã‚’localStorageã«ä¸€æ™‚ä¿å­˜ã™ã‚‹æ©Ÿèƒ½
  // =================================================================

  /**
   * ä¼šè¨ˆå…¥åŠ›ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’localStorageã«ä¿å­˜ã™ã‚‹
   * @param {string} reservationId - äºˆç´„ID
   * @param {object} accountingData - ä¿å­˜ã™ã‚‹ä¼šè¨ˆãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  function saveAccountingCache(reservationId, accountingData) {
    if (!reservationId || !accountingData) return;
    const cacheKey = `accounting_cache_${reservationId}`;
    try {
      localStorage.setItem(cacheKey, JSON.stringify(accountingData));
    } catch (e) {
      console.error('Failed to save accounting cache:', e);
    }
  }

  /**
   * localStorageã‹ã‚‰ä¼šè¨ˆå…¥åŠ›ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
   * @param {string} reservationId - äºˆç´„ID
   * @returns {object|null} - èª­ã¿è¾¼ã‚“ã ä¼šè¨ˆãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã¾ãŸã¯null
   */
  function loadAccountingCache(reservationId) {
    if (!reservationId) return null;

    const cacheKey = `accounting_cache_${reservationId}`;
    try {
      const cachedData = localStorage.getItem(cacheKey);
      if (!cachedData) return null;

      const parsed = JSON.parse(cachedData);

      // ç¾åœ¨ã®ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¨ç…§åˆã—ã¦ã€å­˜åœ¨ã—ãªã„é …ç›®ã‚’é™¤å¤–
      return filterValidCacheData(parsed);
    } catch (e) {
      console.error('Failed to load accounting cache:', e);
      return null;
    }
  }

  /**
   * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã®åŸºæœ¬çš„ãªæ¤œè¨¼
   * @param {object} cachedData - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
   * @returns {object} - æ¤œè¨¼æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿
   */
  function filterValidCacheData(cachedData) {
    if (!cachedData || typeof cachedData !== 'object') return {};
    return cachedData;
  }

  /**
   * localStorageã‹ã‚‰ä¼šè¨ˆå…¥åŠ›ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹
   * @param {string} reservationId - äºˆç´„ID
   */
  function clearAccountingCache(reservationId) {
    if (!reservationId) return;
    const cacheKey = `accounting_cache_${reservationId}`;
    try {
      localStorage.removeItem(cacheKey);
    } catch (e) {
      console.error('Failed to clear accounting cache:', e);
    }
  }

  // =================================================================
  // --- Accounting Utilities ---
  // -----------------------------------------------------------------

  /**
   * æ–™é‡‘ãƒã‚¹ã‚¿ã‹ã‚‰ã€æŒ‡å®šã•ã‚ŒãŸæ•™å®¤ã¨é …ç›®åã«åˆè‡´ã™ã‚‹æˆæ¥­æ–™ãƒ«ãƒ¼ãƒ«ã‚’å–å¾—ã—ã¾ã™ã€‚
   * @param {Array} master - æ–™é‡‘ãƒã‚¹ã‚¿ (stateManager.getState().accountingMaster)
   * @param {string} classroom - æ•™å®¤å
   * @param {string} itemName - é …ç›®å
   * @returns {object|undefined} - è©²å½“ã™ã‚‹æˆæ¥­æ–™ãƒ«ãƒ¼ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  const getTuitionItemRule = (master, classroom, itemName) => {
    if (!master || !classroom || !itemName) return undefined;
    return master.find(
      item =>
        item['ç¨®åˆ¥'] === C.itemTypes.TUITION &&
        item[HEADERS.ACCOUNTING.ITEM_NAME] === itemName &&
        item[HEADERS.ACCOUNTING.TARGET_CLASSROOM] &&
        item[HEADERS.ACCOUNTING.TARGET_CLASSROOM].includes(classroom),
    );
  };

  // =================================================================
  // --- Schedule Master Helper Functions ---
  // -----------------------------------------------------------------
  // æ—¥ç¨‹ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤
  // ãƒ•ã‚§ãƒ¼ã‚º1: tuitionItemRuleä¾å­˜ã‹ã‚‰ã®è„±å´ã®ãŸã‚ã®æ–°æ©Ÿèƒ½
  // =================================================================

  /**
   * æ—¥ç¨‹ãƒã‚¹ã‚¿ã‹ã‚‰æ•™å®¤å½¢å¼ã‚’å–å¾—ã—ã¾ã™
   * @param {object} scheduleData - æ—¥ç¨‹ãƒã‚¹ã‚¿ã®ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   * @returns {string} æ•™å®¤å½¢å¼ ('æ™‚é–“åˆ¶' | 'å›æ•°åˆ¶' | 'ææ–™åˆ¶')
   */
  function getClassroomTypeFromSchedule(scheduleData) {
    if (!scheduleData) return null;
    return scheduleData.classroomType || scheduleData['æ•™å®¤å½¢å¼'] || null;
  }

  /**
   * æ—¥ç¨‹ãƒã‚¹ã‚¿ã‹ã‚‰æ•™å®¤ã®é–‹è¬›æ™‚é–“æƒ…å ±ã‚’å–å¾—ã—ã¾ã™
   * @param {object} scheduleData - æ—¥ç¨‹ãƒã‚¹ã‚¿ã®ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   * @returns {object} æ™‚é–“æƒ…å ± {firstStart, firstEnd, secondStart?, secondEnd?}
   */
  function getClassroomTimesFromSchedule(scheduleData) {
    if (!scheduleData) return null;

    return {
      firstStart: scheduleData.firstStart || scheduleData['1éƒ¨é–‹å§‹'] || null,
      firstEnd: scheduleData.firstEnd || scheduleData['1éƒ¨çµ‚äº†'] || null,
      secondStart: scheduleData.secondStart || scheduleData['2éƒ¨é–‹å§‹'] || null,
      secondEnd: scheduleData.secondEnd || scheduleData['2éƒ¨çµ‚äº†'] || null,
    };
  }

  /**
   * æ•™å®¤å½¢å¼ãŒæ™‚é–“åˆ¶ã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã¾ã™
   * @param {object} scheduleData - æ—¥ç¨‹ãƒã‚¹ã‚¿ã®ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   * @returns {boolean} æ™‚é–“åˆ¶ã®å ´åˆtrue
   */
  function isTimeBasedClassroom(scheduleData) {
    const classroomType = getClassroomTypeFromSchedule(scheduleData);
    // æ™‚é–“åˆ¶ã®æ•™å®¤å½¢å¼ã‚’ã™ã¹ã¦ãƒã‚§ãƒƒã‚¯ï¼ˆæ™‚é–“åˆ¶ãƒ»2éƒ¨åˆ¶ã€æ™‚é–“åˆ¶ãƒ»å…¨æ—¥ï¼‰
    return classroomType && classroomType.includes('æ™‚é–“åˆ¶');
  }

  /**
   * æ•™å®¤ãŒ2éƒ¨åˆ¶ã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã¾ã™ï¼ˆ2éƒ¨é–‹å§‹ãƒ»2éƒ¨çµ‚äº†ã®ä¸¡æ–¹ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
   * @param {object} scheduleData - æ—¥ç¨‹ãƒã‚¹ã‚¿ã®ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   * @returns {boolean} 2éƒ¨åˆ¶ã®å ´åˆtrue
   */
  function isTwoSessionClassroom(scheduleData) {
    const times = getClassroomTimesFromSchedule(scheduleData);
    if (!times) return false;
    return !!(times.secondStart && times.secondEnd);
  }

  /**
   * ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ç‰¹å®šã®æ—¥ç¨‹ãƒã‚¹ã‚¿æƒ…å ±ã‚’å–å¾—
   * @param {string} date - æ—¥ä»˜ (YYYY-MM-DD)
   * @param {string} classroom - æ•™å®¤å
   * @returns {Promise<object|null>} æ—¥ç¨‹ãƒã‚¹ã‚¿æƒ…å ±ã¾ãŸã¯null
   */
  function getScheduleInfoFromCache(date, classroom) {
    return new Promise(resolve => {
      google.script.run
        .withSuccessHandler(response => {
          if (response.success && response.data) {
            console.log(
              'âœ… getScheduleInfoFromCache: æ—¥ç¨‹ãƒã‚¹ã‚¿æƒ…å ±å–å¾—æˆåŠŸ',
              response.data.scheduleInfo,
            );
            resolve(response.data.scheduleInfo);
          } else {
            console.warn(
              'âš ï¸ getScheduleInfoFromCache: æ—¥ç¨‹ãƒã‚¹ã‚¿æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
              { date, classroom },
            );
            resolve(null);
          }
        })
        .withFailureHandler(error => {
          console.error('âŒ getScheduleInfoFromCache: APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼', error);
          resolve(null);
        })
        .getScheduleInfo({ date, classroom });
    });
  }

  /**
   * äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¯¾å¿œã™ã‚‹æ—¥ç¨‹ãƒã‚¹ã‚¿æƒ…å ±ã‚’å–å¾—
   * @param {object} reservation - äºˆç´„ãƒ‡ãƒ¼ã‚¿ (date, classroom ã‚’å«ã‚€)
   * @returns {object|null} æ—¥ç¨‹ãƒã‚¹ã‚¿æƒ…å ±ã¾ãŸã¯null (slotsçµŒç”±ã®å ´åˆ)
   */
  function getScheduleDataFromSlots(reservation) {
    if (!reservation || !reservation.date || !reservation.classroom) {
      console.warn('âš ï¸ getScheduleDataFromSlots: äºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£', reservation);
      return null;
    }

    const state = stateManager.getState();
    const slots = state.slots;

    if (!slots || !Array.isArray(slots)) {
      console.warn('âš ï¸ getScheduleDataFromSlots: slotsãŒå­˜åœ¨ã—ã¾ã›ã‚“', slots);
      return null;
    }

    console.log('ğŸ” getScheduleDataFromSlots: æ¤œç´¢å¯¾è±¡', {
      date: reservation.date,
      classroom: reservation.classroom,
      slotsLength: slots.length,
    });

    // äºˆç´„ã®æ—¥ä»˜ã¨æ•™å®¤ã«å¯¾å¿œã™ã‚‹ã‚¹ãƒ­ãƒƒãƒˆã‚’æ¤œç´¢
    const matchingSlot = slots.find(
      slot =>
        slot.date === reservation.date &&
        slot.classroom === reservation.classroom,
    );

    if (!matchingSlot) {
      console.warn(
        'âš ï¸ getScheduleDataFromSlots: ä¸€è‡´ã™ã‚‹ã‚¹ãƒ­ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
        {
          date: reservation.date,
          classroom: reservation.classroom,
          availableSlots: slots.map(s => ({
            date: s.date,
            classroom: s.classroom,
          })),
        },
      );
      return null;
    }

    console.log('âœ… getScheduleDataFromSlots: ã‚¹ãƒ­ãƒƒãƒˆç™ºè¦‹', matchingSlot);

    // æ—¥ç¨‹ãƒã‚¹ã‚¿å½¢å¼ã®æƒ…å ±ã‚’è¿”ã™
    return {
      classroomType: matchingSlot.classroomType || matchingSlot['æ•™å®¤å½¢å¼'],
      firstStart: matchingSlot.firstStart || matchingSlot['1éƒ¨é–‹å§‹'],
      firstEnd: matchingSlot.firstEnd || matchingSlot['1éƒ¨çµ‚äº†'],
      secondStart: matchingSlot.secondStart || matchingSlot['2éƒ¨é–‹å§‹'],
      secondEnd: matchingSlot.secondEnd || matchingSlot['2éƒ¨çµ‚äº†'],
    };
  }

  // =================================================================
  // --- Accounting Calculation Logic ---
  // -----------------------------------------------------------------
  // ä¼šè¨ˆç”»é¢ã§ã®è¤‡é›‘ãªæ–™é‡‘è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã§ã™ã€‚
  // æˆæ¥­æ–™ã€ææ–™è²»ã€å‰²å¼•ãªã©ã‚’å‹•çš„ã«è¨ˆç®—ã—ã€åˆè¨ˆé‡‘é¡ã‚’ç®—å‡ºã—ã¾ã™ã€‚
  // =================================================================

  /**
   * ä¼šè¨ˆè¨ˆç®—ã‚’å®Ÿè¡Œã—ã€çµæœã‚’è¿”ã—ã¾ã™ã€‚
   * @returns {object} è¨ˆç®—çµæœè©³ç´°
   */
  function calculateAccountingDetails() {
    if (!stateManager.getState().accountingMaster) return null;

    const details = calculateAccountingDetailsFromForm();

    // è¨ˆç®—çµæœã‚’ç›´æ¥ä½¿ç”¨ï¼ˆcomputedä¸è¦ï¼‰

    // UIè¦ç´ ã®æ›´æ–°
    updateAccountingUI(details);

    return details;
  }

  /**
   * ãƒ•ã‚©ãƒ¼ãƒ ã®å†…å®¹ã‹ã‚‰ä¼šè¨ˆè¨ˆç®—ã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆappStateç‹¬ç«‹ï¼‰ã€‚
   * @returns {object} è¨ˆç®—çµæœè©³ç´°
   */
  function calculateAccountingDetailsFromForm() {
    let tuitionSubtotal = 0;
    let salesSubtotal = 0;
    const details = {
      tuition: { items: [] },
      sales: { items: [] },
      grandTotal: 0,
      paymentMethod: '',
      items: [],
    };
    const form = document.getElementById('accounting-form');
    if (!form) return details;

    const r = stateManager.getState().accountingReservation;
    const tuitionItemRule = getTuitionItemRule(
      stateManager.getState().accountingMaster,
      r.classroom,
      C.items.MAIN_LECTURE,
    );
    const isTimeBased =
      tuitionItemRule && tuitionItemRule['å˜ä½'] === C.units.THIRTY_MIN;

    // æ™‚é–“åˆ¶æˆæ¥­æ–™è¨ˆç®—
    if (isTimeBased) {
      const timeBasedResult = calculateTimeBasedTuition(tuitionItemRule);
      if (timeBasedResult) {
        tuitionSubtotal += timeBasedResult.price;
        details.tuition.items.push(timeBasedResult.item);
      }
    }

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é …ç›®è¨ˆç®—
    const checkboxResult = calculateCheckboxItems();
    tuitionSubtotal += checkboxResult.tuitionSubtotal;
    salesSubtotal += checkboxResult.salesSubtotal;
    details.tuition.items.push(...checkboxResult.tuitionItems);
    details.sales.items.push(...checkboxResult.salesItems);
    details.items.push(...checkboxResult.allItems);

    // å‰²å¼•è¨ˆç®—
    const discountResult = calculateDiscount();
    if (discountResult) {
      tuitionSubtotal -= discountResult.amount;
      details.tuition.items.push(discountResult.item);
    }

    // ææ–™è²»è¨ˆç®—
    const materialResult = calculateMaterials();
    salesSubtotal += materialResult.subtotal;
    details.sales.items.push(...materialResult.items);

    // ãã®ä»–è²©å£²å“è¨ˆç®—
    const otherSalesResult = calculateOtherSales();
    salesSubtotal += otherSalesResult.subtotal;
    details.sales.items.push(...otherSalesResult.items);

    // åˆè¨ˆè¨ˆç®—
    details.tuition.subtotal = tuitionSubtotal;
    details.sales.subtotal = salesSubtotal;
    details.grandTotal = tuitionSubtotal + salesSubtotal;
    details.paymentMethod =
      form.querySelector('input[name="payment-method"]:checked')?.value || 'ç¾é‡‘';

    return details;
  }

  /**
   * æ™‚é–“åˆ¶æˆæ¥­æ–™ã‚’è¨ˆç®—ã™ã‚‹
   * é–‹å§‹æ™‚é–“ãƒ»çµ‚äº†æ™‚é–“ãƒ»ä¼‘æ†©æ™‚é–“ã‹ã‚‰å®Ÿéš›ã®å—è¬›æ™‚é–“ã‚’ç®—å‡ºã—ã€30åˆ†å˜ä½ã§æ–™é‡‘ã‚’è¨ˆç®—
   * @param {Object} tuitionItemRule - ä¼šè¨ˆãƒã‚¹ã‚¿ã®æˆæ¥­æ–™ãƒ«ãƒ¼ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆå˜ä¾¡ã‚’å«ã‚€ï¼‰
   * @returns {Object|null} è¨ˆç®—çµæœ { price: number, item: {name: string, price: number} } ã¾ãŸã¯ null
   */
  function calculateTimeBasedTuition(tuitionItemRule) {
    // æ™‚åˆ»ãƒ‡ãƒ¼ã‚¿ã‚’é©åˆ‡ã«å–å¾—ï¼ˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ä½¿ç”¨ï¼‰
    const accountingReservation = stateManager.getState().accountingReservation;
    const startTime = getTimeValue(
      'start-time',
      accountingReservation,
      'startTime',
    );
    const endTime = getTimeValue('end-time', accountingReservation, 'endTime');
    const breakMinutes = parseInt(
      document.getElementById('break-time')?.value || 0,
      10,
    );

    if (startTime && endTime && startTime < endTime) {
      const start = new Date(`1900-01-01T${startTime}:00`);
      const end = new Date(`1900-01-01T${endTime}:00`);
      let diffMinutes = (end - start) / 60000 - breakMinutes;

      if (diffMinutes > 0) {
        const billableUnits = Math.ceil(diffMinutes / 30);
        const price =
          billableUnits * Number(tuitionItemRule[HEADERS.ACCOUNTING.UNIT_PRICE]);
        return {
          price: price,
          item: { name: `æˆæ¥­æ–™ (${startTime} - ${endTime})`, price: price },
          billableUnits: billableUnits,
        };
      }
    }
    return null;
  }

  /**
   * ä¼šè¨ˆç”»é¢ã§æ™‚åˆ»å¤‰æ›´æ™‚ã«è¨ˆç®—ã‚’æ›´æ–°ã™ã‚‹
   */
  function updateAccountingCalculation() {
    // ä¼šè¨ˆåˆè¨ˆã‚’å†è¨ˆç®—
    const accountingResult = calculateAccountingDetailsFromForm();

    // åˆè¨ˆé‡‘é¡è¡¨ç¤ºã‚’æ›´æ–°
    const totalElement = document.getElementById('total-amount');
    if (totalElement && accountingResult) {
      totalElement.textContent = `Â¥${accountingResult.grandTotal.toLocaleString()}`;
    }

    // è©³ç´°è¡¨ç¤ºã‚‚æ›´æ–°ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
    const detailsElement = document.getElementById('calculation-details');
    if (detailsElement && accountingResult) {
      // è©³ç´°è¨ˆç®—çµæœã‚’è¡¨ç¤º
      detailsElement.innerHTML = `
        <div class="text-sm text-gray-600 space-y-1">
          <div>æˆæ¥­æ–™å°è¨ˆ: Â¥${accountingResult.tuition.subtotal.toLocaleString()}</div>
          <div>ç‰©è²©å°è¨ˆ: Â¥${accountingResult.materials.subtotal.toLocaleString()}</div>
          <div class="font-semibold border-t pt-1">åˆè¨ˆ: Â¥${accountingResult.grandTotal.toLocaleString()}</div>
        </div>`;
    }
  }

  /**
   * ä¼šè¨ˆç”»é¢ã®æ™‚åˆ»é¸æŠã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ã™ã‚‹
   */
  function setupAccountingEventListeners() {
    // æ™‚åˆ»é¸æŠè¦ç´ ã«changeã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
    ['start-time', 'end-time', 'break-time'].forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('change', updateAccountingCalculation);
      }
    });

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é …ç›®ã«ã‚‚changeã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
    document
      .querySelectorAll('input[type="checkbox"].accounting-item')
      .forEach(checkbox => {
        checkbox.addEventListener('change', updateAccountingCalculation);
      });

    // å‰²å¼•ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ã‚‚changeã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
    const discountCheckbox = document.getElementById('discount-checkbox');
    if (discountCheckbox) {
      discountCheckbox.addEventListener('change', updateAccountingCalculation);
    }
  }

  /**
   * ãƒ•ã‚©ãƒ¼ãƒ å†…ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é …ç›®ã®æ–™é‡‘ã‚’è¨ˆç®—ã™ã‚‹
   * æˆæ¥­æ–™é …ç›®ã¨ç‰©è²©é …ç›®ã‚’åŒºåˆ¥ã—ã¦é›†è¨ˆã—ã€ä¸¡æ–¹ã®å°è¨ˆã‚’ç®—å‡º
   * @returns {Object} è¨ˆç®—çµæœ { tuitionSubtotal: number, salesSubtotal: number, tuitionItems: Array, salesItems: Array, allItems: Array }
   */
  function calculateCheckboxItems() {
    let tuitionSubtotal = 0;
    let salesSubtotal = 0;
    const tuitionItems = [];
    const salesItems = [];
    const allItems = [];

    const form = document.getElementById('accounting-form');
    form
      .querySelectorAll('input[type="checkbox"].accounting-item')
      .forEach(cb => {
        if (cb.checked || cb.disabled) {
          const itemName = cb.dataset.itemName;
          const itemType = cb.dataset.itemType;
          const masterItem = stateManager
            .getState()
            .accountingMaster.find(
              m =>
                m[HEADERS.ACCOUNTING.ITEM_NAME] === itemName &&
                m['ç¨®åˆ¥'] === itemType,
            );
          if (!masterItem) return;

          const price = Number(masterItem[HEADERS.ACCOUNTING.UNIT_PRICE]);
          const itemDetail = { name: itemName, price: price };
          allItems.push(itemDetail);

          if (itemType === C.itemTypes.TUITION) {
            tuitionSubtotal += price;
            tuitionItems.push(itemDetail);
          } else {
            salesSubtotal += price;
            salesItems.push(itemDetail);
          }
        }
      });

    return {
      tuitionSubtotal,
      salesSubtotal,
      tuitionItems,
      salesItems,
      allItems,
    };
  }

  /**
   * åˆå›è€…åŒæ™‚å‰²å¼•ã‚’è¨ˆç®—ã™ã‚‹
   * å›ºå®šã®Â¥500å¼•ãã‚’é©ç”¨
   * @returns {Object|null} å‰²å¼•è¨ˆç®—çµæœ { discountAmount: number, discountItem: {name: string, price: number} } ã¾ãŸã¯ null
   */
  function calculateDiscount() {
    const discountCheckbox = document.getElementById('discount-checkbox');
    if (discountCheckbox && discountCheckbox.checked) {
      const discountAmount = 500; // å›ºå®šã®Â¥500å¼•ã
      return {
        amount: discountAmount,
        item: {
          name: `${C.items.DISCOUNT}`,
          price: -discountAmount,
        },
      };
    }
    return null;
  }

  /**
   * ææ–™è²»ã‚’è¨ˆç®—ã™ã‚‹
   * ç«‹ä½“ææ–™ã®å ´åˆã¯ã‚µã‚¤ã‚º(é•·ã•Ã—å¹…Ã—é«˜ã•)ã‹ã‚‰ä½“ç©ã‚’è¨ˆç®—ã—ã€å˜ä¾¡ã‚’æ›ã‘ã¦ç®—å‡º
   * ãã®ä»–ã®ææ–™ã¯å›ºå®šå˜ä¾¡ã§è¨ˆç®—
   * @returns {Object} è¨ˆç®—çµæœ { subtotal: number, items: Array<{name: string, price: number}> }
   */
  function calculateMaterials() {
    let subtotal = 0;
    const items = [];

    const materialContainer = document.getElementById('materials-container');
    if (materialContainer) {
      const materialRows = materialContainer.querySelectorAll(
        'div[data-material-row-index]',
      );
      materialRows.forEach((row, index) => {
        const type = document.getElementById(`material-type-${index}`)?.value;
        const masterItem = stateManager
          .getState()
          .accountingMaster.find(m => m[HEADERS.ACCOUNTING.ITEM_NAME] === type);
        const priceEl = document.getElementById(`material-price-${index}`);

        if (!masterItem) {
          if (priceEl) priceEl.textContent = '0å††';
          return;
        }

        const unitPrice = Number(masterItem[HEADERS.ACCOUNTING.UNIT_PRICE]);
        let finalName = type;
        let price = 0;

        if (masterItem['å˜ä½'] === stateManager.getState().constants.units.CM3) {
          const l = document.getElementById(`material-l-${index}`)?.value || 0;
          const w = document.getElementById(`material-w-${index}`)?.value || 0;
          const h = document.getElementById(`material-h-${index}`)?.value || 0;
          if (l > 0 && w > 0 && h > 0) {
            const volumeCm = (l / 10) * (w / 10) * (h / 10);
            let calculatedPrice = Math.round((volumeCm * unitPrice) / 100) * 100;
            price = Math.max(100, calculatedPrice);
            finalName = `${type} (${l}x${w}x${h}mm)`;
          }
        } else {
          if (type) price = unitPrice;
        }

        if (priceEl) priceEl.textContent = `${price.toLocaleString()}å††`;
        if (price > 0) {
          const itemDetail = { name: finalName, price: price };
          subtotal += price;
          items.push(itemDetail);
        }
      });
    }

    return { subtotal, items };
  }

  /**
   * ãã®ä»–è²©å£²å“ã‚’è¨ˆç®—ã™ã‚‹
   * å‹•çš„ã«è¿½åŠ ã•ã‚ŒãŸè²©å£²å“é …ç›®ã®åå‰ã¨ä¾¡æ ¼ã‹ã‚‰å°è¨ˆã‚’ç®—å‡º
   * @returns {Object} è¨ˆç®—çµæœ { subtotal: number, items: Array<{name: string, price: number}> }
   */
  function calculateOtherSales() {
    let subtotal = 0;
    const items = [];

    const otherSalesContainer = document.getElementById('other-sales-container');
    if (otherSalesContainer) {
      const otherSalesRows = otherSalesContainer.querySelectorAll(
        'div[data-other-sales-row]',
      );
      otherSalesRows.forEach((row, index) => {
        const name = document
          .getElementById(`other-sales-name-${index}`)
          ?.value.trim();
        const priceInput = document.getElementById(`other-sales-price-${index}`);
        let priceValue = priceInput.value
          .replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xfee0))
          .replace(/[^0-9.-]/g, '');
        priceInput.value = priceValue;
        const price = Number(priceValue || 0);

        if (name && price !== 0) {
          const itemDetail = { name: name, price: price };
          subtotal += price;
          items.push(itemDetail);
        }
      });
    }

    return { subtotal, items };
  }

  /**
   * ä¼šè¨ˆãƒ•ã‚©ãƒ¼ãƒ ã®UIè¦ç´ ã‚’è¨ˆç®—çµæœã«åŸºã¥ã„ã¦æ›´æ–°ã™ã‚‹
   * æˆæ¥­æ–™ãƒ»ç‰©è²©ã®å°è¨ˆã€åˆè¨ˆé‡‘é¡ã€å†…è¨³è¡¨ç¤ºãªã©ã‚’å‹•çš„ã«æ›´æ–°
   * @param {Object} details - calculateAccountingDetailsFromForm()ã®è¨ˆç®—çµæœ
   */
  function updateAccountingUI(details) {
    const tuitionBreakdownEl = document.getElementById('tuition-breakdown');
    const calculatedHoursEl = document.getElementById('calculated-hours');
    const tuitionSubtotalEl = document.getElementById('tuition-subtotal');
    const salesSubtotalEl = document.getElementById('sales-subtotal');
    const grandTotalEl = document.getElementById('grand-total-amount');

    // æ™‚é–“åˆ¶æˆæ¥­æ–™ã®è¡¨ç¤ºæ›´æ–°
    if (tuitionBreakdownEl) {
      const tuitionBreakdownHtml = details.tuition.items
        .map(
          item =>
            `<div class="flex justify-between${item.price < 0 ? ' text-red-600' : ''}"><span>${item.name}</span><span>${item.price.toLocaleString()}å††</span></div>`,
        )
        .join('');
      tuitionBreakdownEl.innerHTML = tuitionBreakdownHtml;
    }

    // å—è¬›æ™‚é–“è¡¨ç¤ºã®æ›´æ–°
    if (calculatedHoursEl && details) {
      const timeBasedItems = details.tuition.items.filter(item =>
        item.name.includes('æˆæ¥­æ–™ ('),
      );
      if (timeBasedItems.length > 0) {
        const r = stateManager.getState().accountingReservation;
        const tuitionItemRule = getTuitionItemRule(
          stateManager.getState().accountingMaster,
          r.classroom,
          C.items.MAIN_LECTURE,
        );
        if (tuitionItemRule) {
          const billableUnits = Math.ceil(
            timeBasedItems[0].price /
              Number(tuitionItemRule[HEADERS.ACCOUNTING.UNIT_PRICE]),
          );
          calculatedHoursEl.textContent = `å—è¬›æ™‚é–“: ${billableUnits * 0.5}æ™‚é–“ Ã— ${2.0 * tuitionItemRule[HEADERS.ACCOUNTING.UNIT_PRICE]}å††`;
        }
      } else {
        calculatedHoursEl.textContent = '';
      }
    }

    // å°è¨ˆãƒ»åˆè¨ˆã®è¡¨ç¤ºæ›´æ–°
    if (tuitionSubtotalEl)
      tuitionSubtotalEl.textContent = `å°è¨ˆ: ${details.tuition.subtotal.toLocaleString()}å††`;
    if (salesSubtotalEl)
      salesSubtotalEl.textContent = `å°è¨ˆ: ${details.sales.subtotal.toLocaleString()}å††`;
    if (grandTotalEl)
      grandTotalEl.textContent = `åˆè¨ˆ: ${details.grandTotal.toLocaleString()}å††`;
  }

  // =================================================================
  // --- Event Listener Management ---
  // -----------------------------------------------------------------
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç™»éŒ²ãƒ»è§£é™¤ã‚’è¿½è·¡ç®¡ç†ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤
  // ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ã®ãŸã‚ã€ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ™‚ã«å¤ã„ãƒªã‚¹ãƒŠãƒ¼ã‚’ç¢ºå®Ÿã«è§£é™¤ã™ã‚‹
  // =================================================================

  let activeListeners = [];

  /**
   * ç™»éŒ²ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å…¨ã¦è§£é™¤ã™ã‚‹
   */
  function teardownAllListeners() {
    activeListeners.forEach(({ element, type, listener, options }) => {
      if (element) {
        element.removeEventListener(type, listener, options);
      }
    });
    activeListeners = [];
  }

  /**
   * ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²ã—ã€è§£é™¤ã§ãã‚‹ã‚ˆã†ã«è¿½è·¡ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
   * @param {Element} element - å¯¾è±¡è¦ç´ 
   * @param {string} type - ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—
   * @param {Function} listener - ãƒªã‚¹ãƒŠãƒ¼é–¢æ•°
   * @param {object} [options] - addEventListenerã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
   */
  function addTrackedListener(element, type, listener, options) {
    if (!element) {
      console.warn(
        `Attempted to add listener to a null element for event: ${type}`,
      );
      return;
    }
    element.addEventListener(type, listener, options);
    activeListeners.push({ element, type, listener, options });
  }

  /**
   * StateManagerã®åˆæœŸåŒ–å¾Œã«è¿½åŠ ã™ã‚‹é–¢æ•°
   * ãƒ“ãƒ¥ãƒ¼å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç®¡ç†ã‚’è¨­å®š
   */
  function setupViewListener() {
    if (!window.stateManager) {
      console.error('StateManager not initialized. Cannot set up view listener.');
      return;
    }

    window.stateManager.subscribe((newState, oldState) => {
      // ãƒ“ãƒ¥ãƒ¼ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿å‡¦ç†
      if (newState.view !== oldState.view) {
        // å¤ã„ãƒ“ãƒ¥ãƒ¼ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å…¨ã¦è§£é™¤
        teardownAllListeners();

        // æ–°ã—ã„ãƒ“ãƒ¥ãƒ¼ã«å¿œã˜ãŸãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²
        // requestAnimationFrameã§DOMã®æç”»ã‚’å¾…ã¤
        requestAnimationFrame(() => {
          if (newState.view === 'accounting') {
            // ä¼šè¨ˆç”»é¢ãŒè¡¨ç¤ºã•ã‚ŒãŸéš›ã®åˆæœŸåŒ–å‡¦ç†
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯14_WebApp_Handlers.htmlã®ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã§å‡¦ç†ã•ã‚Œã¾ã™ã€‚
            // ã“ã“ã§ã¯ã€DOMæç”»å¾Œã«åˆå›è¨ˆç®—ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
            if (typeof calculateAccountingDetails === 'function') {
              calculateAccountingDetails();
            }
          }
          // ä»–ã®ãƒ“ãƒ¥ãƒ¼ã§ãƒªã‚¹ãƒŠãƒ¼ãŒå¿…è¦ãªå ´åˆã¯ã“ã“ã«è¿½åŠ 
          // else if (newState.view === 'someOtherView') {
          //   setupSomeOtherViewListeners();
          // }
        });
      }
    });
  }


  // =================================================================
  // 12_WebApp_StateManager.js (è‡ªå‹•çµ±åˆ)
  // =================================================================

  // @ts-check
  /// <reference path="../types.d.ts" />

  /**
   * =================================================================
   * ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: 12_WebApp_StateManager.js
   * ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘: 2.1 (JavaScriptåˆ†é›¢é–‹ç™ºç‰ˆ)
   * ã€å½¹å‰²ã€‘: ã‚·ãƒ³ãƒ—ãƒ«ã§ç¢ºå®ŸãªçŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
   * - ç„¡é™ãƒ«ãƒ¼ãƒ—ã®å®Œå…¨å›é¿
   * - JavaScriptåˆ†é›¢é–‹ç™ºç’°å¢ƒå¯¾å¿œ
   * - å®Œå…¨ãªTypeScriptå‹ãƒã‚§ãƒƒã‚¯å¯¾å¿œ
   * =================================================================
   */

  /**
   * ã‚·ãƒ³ãƒ—ãƒ«ãªçŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
   */
  class SimpleStateManager {
    constructor() {
      this.state = {
        // --- User & Session Data ---
        /** @type {{studentId: string, realName: string, displayName: string, phone: string} | null} */
        currentUser: null,
        /** @type {string} */
        loginPhone: '',
        /** @type {boolean} */
        isFirstTimeBooking: false,
        /** @type {Object} */
        registrationData: {},
        /** @type {string | null} */
        registrationPhone: null,

        // --- Core Application Data ---
        /** @type {Array<Object>} */
        slots: [],
        /** @type {Array<Object>} */
        myReservations: [],
        /** @type {Array<Object>} */
        accountingMaster: [],
        /** @type {Array<string>} */
        classrooms: [],
        /** @type {Object | null} */
        constants: null,

        // --- UI State ---
        /** @type {string} */
        view: 'login',
        /** @type {string | null} */
        selectedClassroom: null,
        /** @type {Object | null} */
        selectedSlot: null,
        /** @type {Object | null} */
        editingReservationDetails: null,
        /** @type {Object | null} - ä¼šè¨ˆç”»é¢ã®åŸºæœ¬äºˆç´„æƒ…å ± (ID, æ•™å®¤, æ—¥ä»˜ãªã©) */
        accountingReservation: null,
        /** @type {Object} - äºˆç´„å›ºæœ‰ã®è©³ç´°æƒ…å ± (é–‹å§‹æ™‚åˆ», ãƒ¬ãƒ³ã‚¿ãƒ«, å‰²å¼•ãªã©) */
        accountingReservationDetails: {},
        /** @type {Object | null} - è¬›åº§å›ºæœ‰æƒ…å ± (æ•™å®¤å½¢å¼, é–‹è¬›æ™‚é–“ãªã©) */
        accountingScheduleInfo: null,
        /** @type {string} */ completionMessage: '',
        /** @type {number} */ recordsToShow: 10,
        /** @type {number} */ registrationStep: 1,
        /** @type {Array<Object>} */
        searchedUsers: [],
        /** @type {boolean} */
        searchAttempted: false,

        // --- Navigation History ---
        /** @type {Array<{view: string, context: Object}>} */
        navigationHistory: [],

        // --- System State ---
        /** @type {boolean} */
        isDataFresh: false,
        /** @type {boolean} */
        _dataUpdateInProgress: false,
        /** @type {string | null} */
        _slotsVersion: null,

        // --- Computed Data ---
        computed: {},
      };

      this.isUpdating = false; // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ãƒ•ãƒ©ã‚°
      this.subscribers = []; // çŠ¶æ…‹å¤‰æ›´ã®è³¼èª­è€…ãƒªã‚¹ãƒˆ

      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµ±ä¸€å®šæ•°ã‚’å³åº§ã«è¨­å®šï¼ˆã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
      this.initializeFallbackConstants();
    }

    /**
     * ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã—ã¦çŠ¶æ…‹ã‚’æ›´æ–°ã—ã€UIã‚’è‡ªå‹•å†æç”»
     * @param {Object} action - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ { type: 'ACTION_NAME', payload: { ... } }
     */
    dispatch(action) {
      if (this.isUpdating) {
        console.warn('çŠ¶æ…‹æ›´æ–°ä¸­ã®ãŸã‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }

      if (!window.isProduction) {
        console.log(
          'ğŸ¯ Action dispatched:',
          action.type,
          action.payload ? Object.keys(action.payload) : 'no payload',
        );
      }

      // ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã‚’è¨˜éŒ²ï¼ˆãƒšãƒ¼ã‚¸é·ç§»åˆ¤å®šç”¨ï¼‰
      const previousView = this.state.view;

      // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«åŸºã¥ã„ã¦çŠ¶æ…‹æ›´æ–°
      let newState = {};
      switch (action.type) {
        case 'SET_STATE':
          newState = action.payload || {};
          break;
        case 'UPDATE_STATE':
          newState = action.payload || {};
          break;
        case 'CHANGE_VIEW':
          newState = { view: action.payload.view };
          break;
        case 'NAVIGATE':
          newState = this._handleNavigate(action.payload);
          break;
        default:
          console.warn('æœªçŸ¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—:', action.type);
          return;
      }

      // å†…éƒ¨ã®çŠ¶æ…‹æ›´æ–°ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—
      this._updateState(newState);

      // ãƒšãƒ¼ã‚¸é·ç§»ãŒç™ºç”Ÿã—ãŸå ´åˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç®¡ç†
      if (
        newState.view &&
        newState.view !== previousView &&
        window.pageTransitionManager
      ) {
        window.pageTransitionManager.onPageTransition(newState.view);
      }

      // æœ€çµ‚çš„ãªçŠ¶æ…‹æ›´æ–°ï¼ˆç”»é¢é·ç§»ã‚’ä¼´ã†ï¼‰ã§ã®ã¿ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤ºã‚’å®Ÿè¡Œ
      const isViewChange = newState.view && newState.view !== previousView;
      const hasSubstantialData =
        newState.slots || newState.myReservations || newState.currentUser;
      const isFinalUpdate =
        action.type === 'SET_STATE' && (isViewChange || hasSubstantialData);

      if (isFinalUpdate) {
        this._shouldHideLoadingAfterRender = true;
      }

      // UI ã‚’è‡ªå‹•ã§å†æç”»
      this._scheduleRender();
    }

    /**
     * çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆå†…éƒ¨ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰
     * @param {Object} newState - æ–°ã—ã„çŠ¶æ…‹
     */
    _updateState(newState) {
      if (this.isUpdating) {
        console.warn('çŠ¶æ…‹æ›´æ–°ä¸­ã®ãŸã‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }

      this.isUpdating = true;

      try {
        // å¤‰æ›´å‰ã®çŠ¶æ…‹ã‚’ä¿å­˜ï¼ˆsubscriberç”¨ï¼‰
        const oldState = { ...this.state };

        // çŠ¶æ…‹ã‚’ç›´æ¥æ›´æ–°
        Object.assign(this.state, newState);

        // çµ±ä¸€å®šæ•°ãŒè¨­å®šã•ã‚ŒãŸå ´åˆã€ã‚°ãƒ­ãƒ¼ãƒãƒ«çŸ­ç¸®å‚ç…§ã‚’åˆæœŸåŒ–
        // window.CãŒãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ{}ã§åˆæœŸåŒ–ã•ã‚Œã‚‹ãŸã‚ã€
        // !window.Cã§ã¯æ­£ã—ãåˆ¤å®šã§ããªã„ã€‚
        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç©ºã‹ã©ã†ã‹ã‚‚ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã€‚
        if (
          newState.constants &&
          (!window.C || Object.keys(window.C).length === 0)
        ) {
          this.initializeGlobalConstants();
        }

        // åŸºæœ¬çš„ãªè¨ˆç®—æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        this.updateComputed();

        // subscriberã«å¤‰æ›´ã‚’é€šçŸ¥
        this._notifySubscribers(this.state, oldState);

        if (!window.isProduction) {
          if (typeof DEBUG_ENABLED !== 'undefined' && DEBUG_ENABLED)
            console.log('âœ… çŠ¶æ…‹æ›´æ–°å®Œäº†:', Object.keys(newState));
        }
      } catch (error) {
        console.error('âŒ çŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      } finally {
        this.isUpdating = false;
      }
    }

    /**
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«çµ±ä¸€å®šæ•°ã®çŸ­ç¸®å‚ç…§ã‚’åˆæœŸåŒ–
     */
    initializeGlobalConstants() {
      if (!this.state.constants) return;

      const constants = this.state.constants;

      // å¿…è¦ãªé…åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’çŠ¶æ…‹ã«è¨­å®š
      if (constants.classrooms && !this.state.classrooms.length) {
        this.state.classrooms = Object.values(constants.classrooms);
        if (!window.isProduction) {
          console.log('ğŸ“‹ æ•™å®¤ä¸€è¦§ã‚’çŠ¶æ…‹ã«è¨­å®š:', this.state.classrooms);
        }
      }

      // UIè¨­å®šã®åˆæœŸåŒ–
      if (!this.state.recordsToShow && constants.ui?.HISTORY_INITIAL_RECORDS) {
        this.state.recordsToShow = constants.ui.HISTORY_INITIAL_RECORDS;
        if (!window.isProduction) {
          console.log('ğŸ“‹ å±¥æ­´è¡¨ç¤ºä»¶æ•°ã‚’åˆæœŸåŒ–:', this.state.recordsToShow);
        }
      }

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŸ­ç¸®å‚ç…§ã‚’è¨­å®š
      window.C = constants;
      window.STATUS = constants.status || {};
      window.UI = constants.ui || {};
      window.MESSAGES = constants.messages || {};
      window.BANK = constants.bankInfo || {};
      window.PAYMENT = constants.paymentDisplay || {};
      window.HEADERS = constants.headers || {}; // çµ±åˆãƒ˜ãƒƒãƒ€ãƒ¼å®šæ•°ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§åˆ©ç”¨å¯èƒ½ã«

      if (!window.isProduction) {
        console.log('ğŸ“‹ çµ±ä¸€å®šæ•°ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ã‚’åˆæœŸåŒ–:', Object.keys(constants));
      }
    }

    /**
     * è¨ˆç®—æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®åŸºæœ¬æ›´æ–°
     */
    updateComputed() {
      if (!this.state.myReservations) return;

      // isFirstTimeBooking ã®è¨ˆç®—ï¼šäºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒå…¨ããªã„å ´åˆ
      this.state.isFirstTimeBooking = this.state.myReservations.length === 0;
    }

    /**
     * ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å®šæ•°ã‚’åˆæœŸåŒ–ã™ã‚‹
     * ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ¬ç‰©ã®å®šæ•°ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§ã®é–“ã®ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹
     */
    initializeFallbackConstants() {
      if (window.C && Object.keys(window.C).length > 0) return; // æ—¢ã«è¨­å®šæ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„

      window.C = {};
      window.STATUS = {
        CANCELED: 'å–æ¶ˆ',
        WAITLISTED: 'å¾…æ©Ÿ',
        CONFIRMED: 'ç¢ºå®š',
        COMPLETED: 'å®Œäº†',
      };
      window.UI = {
        HISTORY_INITIAL_RECORDS: 10,
        HISTORY_LOAD_MORE_RECORDS: 10,
        LOADING_MESSAGE_INTERVAL: 2000,
        MODAL_FADE_DURATION: 300,
      };
      window.MESSAGES = {
        CANCEL: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
        SAVE: 'ä¿å­˜ã™ã‚‹',
        EDIT: 'ç·¨é›†',
        SUCCESS: 'æˆåŠŸ',
        ERROR: 'ã‚¨ãƒ©ãƒ¼',
      };
      window.BANK = {};
      window.PAYMENT = { CASH: 'ç¾é‡‘' };
      console.log('ğŸ“‹ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®šæ•°ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ');
    }

    /**
     * requestAnimationFrameã‚’ä½¿ã£ãŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°
     */
    _scheduleRender() {
      if (this._renderScheduled) {
        return; // æ—¢ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ¸ˆã¿
      }

      this._renderScheduled = true;
      requestAnimationFrame(() => {
        this._renderScheduled = false;
        if (typeof window.render === 'function') {
          console.log('ğŸ¨ Auto-rendering UI...');
          window.render();
          // ç‰¹å®šã®action.typeã§ã®ã¿ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºï¼ˆæœ€çµ‚çš„ãªçŠ¶æ…‹æ›´æ–°ã®ã¿ï¼‰
          if (this._shouldHideLoadingAfterRender) {
            if (typeof hideLoading === 'function') hideLoading();
            this._shouldHideLoadingAfterRender = false;
          }
        } else {
          console.warn('renderé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
      });
    }

    /**
     * ç¾åœ¨ã®çŠ¶æ…‹ã‚’å–å¾—
     */
    getState() {
      return this.state;
    }

    /**
     * çŠ¶æ…‹å¤‰æ›´ã‚’è³¼èª­ã™ã‚‹
     * @param {Function} callback - çŠ¶æ…‹å¤‰æ›´æ™‚ã«å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•° (newState, oldState) => void
     * @returns {Function} unsubscribeé–¢æ•°
     */
    subscribe(callback) {
      this.subscribers.push(callback);

      // unsubscribeé–¢æ•°ã‚’è¿”ã™
      return () => {
        const index = this.subscribers.indexOf(callback);
        if (index > -1) {
          this.subscribers.splice(index, 1);
        }
      };
    }

    /**
     * subscriberã«çŠ¶æ…‹å¤‰æ›´ã‚’é€šçŸ¥ã™ã‚‹
     * @param {Object} newState - æ–°ã—ã„çŠ¶æ…‹
     * @param {Object} oldState - å¤ã„çŠ¶æ…‹
     */
    _notifySubscribers(newState, oldState) {
      this.subscribers.forEach(callback => {
        try {
          callback(newState, oldState);
        } catch (error) {
          console.error('subscriber callback error:', error);
        }
      });
    }

    /**
     * ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‡¦ç†ã—ã€å±¥æ­´ã‚’ç®¡ç†ã™ã‚‹
     * @param {Object} payload - { to: string, context?: Object, saveHistory?: boolean }
     * @returns {Object} æ–°ã—ã„çŠ¶æ…‹
     */
    _handleNavigate(payload) {
      const { to, context = {}, saveHistory = true } = payload;
      const currentView = this.state.view;

      // ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã‚’å±¥æ­´ã«ä¿å­˜ï¼ˆæˆ»ã‚‹å±¥æ­´ã¨ã—ã¦ï¼‰
      if (saveHistory && currentView !== to) {
        const currentContext = this._extractCurrentContext();
        const historyEntry = { view: currentView, context: currentContext };

        // åŒã˜ãƒ“ãƒ¥ãƒ¼ã®é€£ç¶šã‚¨ãƒ³ãƒˆãƒªã‚’é¿ã‘ã‚‹
        const lastEntry =
          this.state.navigationHistory[this.state.navigationHistory.length - 1];
        if (!lastEntry || lastEntry.view !== currentView) {
          const newHistory = [...this.state.navigationHistory, historyEntry];
          // å±¥æ­´ã‚’æœ€å¤§10ä»¶ã«åˆ¶é™
          if (newHistory.length > 10) {
            newHistory.shift();
          }
          return {
            view: to,
            ...context,
            navigationHistory: newHistory,
          };
        }
      }

      return {
        view: to,
        ...context,
      };
    }

    /**
     * ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºã™ã‚‹
     * @returns {Object} ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     */
    _extractCurrentContext() {
      const context = {};

      // ãƒ“ãƒ¥ãƒ¼ã«å¿œã˜ã¦é‡è¦ãªçŠ¶æ…‹ã‚’ä¿å­˜
      switch (this.state.view) {
        case 'booking':
          if (this.state.selectedClassroom) {
            context.selectedClassroom = this.state.selectedClassroom;
          }
          break;
        case 'newReservation':
        case 'editReservation':
          if (this.state.selectedSlot) {
            context.selectedSlot = this.state.selectedSlot;
            context.selectedClassroom = this.state.selectedClassroom;
          }
          if (this.state.editingReservationDetails) {
            context.editingReservationDetails =
              this.state.editingReservationDetails;
          }
          break;
        case 'accounting':
          if (this.state.accountingReservation) {
            context.accountingReservation = this.state.accountingReservation;
          }
          break;
        default:
          break;
      }

      return context;
    }

    /**
     * å‰ã®ãƒ“ãƒ¥ãƒ¼ã«æˆ»ã‚‹
     * @returns {Object} æ–°ã—ã„çŠ¶æ…‹ã€ã¾ãŸã¯æˆ»ã‚Œãªã„å ´åˆã¯null
     */
    goBack() {
      const history = this.state.navigationHistory;
      if (history.length === 0) {
        console.log('ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ãŒç©ºã§ã™ - ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™');
        return { view: 'dashboard' };
      }

      const previousEntry = history[history.length - 1];
      const newHistory = history.slice(0, -1); // æœ€å¾Œã®ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤

      return {
        view: previousEntry.view,
        ...previousEntry.context,
        navigationHistory: newHistory,
      };
    }

    /**
     * ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
     * @param {Object} dataObj - ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {string} dataType - ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ— ('reservations', 'schedule' ãªã©)
     */
    validateDataStructure(dataObj, dataType = 'reservations') {
      if (!window.HEADERS || !dataObj) return true;

      const expectedHeaders =
        dataType === 'schedule'
          ? window.HEADERS.SCHEDULE
          : window.HEADERS.RESERVATIONS;

      if (!expectedHeaders) return true;

      // é‡è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
      const requiredProperties = ['date', 'classroom'];
      const missingProperties = requiredProperties.filter(prop => !dataObj[prop]);

      if (missingProperties.length > 0) {
        console.warn(`ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯: å¿…é ˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒä¸è¶³`, {
          dataType,
          missing: missingProperties,
          data: dataObj,
        });
        return false;
      }

      return true;
    }
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
  window.stateManager = new SimpleStateManager();


  // =================================================================
  // 13_WebApp_Components.js (è‡ªå‹•çµ±åˆ)
  // =================================================================

  // @ts-check
  /// <reference path="../types.d.ts" />

  /**
   * =================================================================
   * ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: 13_WebApp_Components.js
   * ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘: 2.0 (ã‚·ãƒ³ãƒ—ãƒ«åŒ–è¨­è¨ˆç‰ˆ)
   * ã€å½¹å‰²ã€‘: WebAppã®UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç”Ÿæˆé–¢æ•°ã‚’é›†ç´„ã—ã¾ã™ã€‚
   * - å†åˆ©ç”¨å¯èƒ½ãªUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®šç¾©
   * - ã‚·ãƒ³ãƒ—ãƒ«åŒ–ã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­è¨ˆ
   * - 3å±¤æ§‹é€ : Atomic â†’ Molecular â†’ Organisms
   * ã€æ§‹æˆã€‘: 14ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®ã†ã¡ã®13ç•ªç›®ï¼ˆæ–°è¦è¿½åŠ ï¼‰
   * ã€è¨­è¨ˆåŸå‰‡ã€‘:
   * - å˜ä¸€è²¬ä»»åŸå‰‡: 1ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ = 1ã¤ã®æ˜ç¢ºãªè²¬ä»»
   * - æœ€å°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: æœ¬è³ªçš„ãªãƒ‡ãƒ¼ã‚¿ã®ã¿å—ã‘å–ã‚‹
   * - é–¢å¿ƒã®åˆ†é›¢: UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ãƒ“ã‚¸ãƒã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é›¢
   * - çµ„ã¿åˆã‚ã›å¯èƒ½: å°ã•ãªéƒ¨å“ã®çµ„ã¿åˆã‚ã›ã§è¤‡é›‘ãªç”»é¢ã‚’æ§‹ç¯‰
   */

  // =================================================================
  // --- HTML Escape Utility ---
  // -----------------------------------------------------------------
  // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ©Ÿèƒ½ï¼ˆ12_WebApp_Core.htmlã‹ã‚‰ç§»å‹•ï¼‰
  // =================================================================

  /**
   * HTMLæ–‡å­—åˆ—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¾ã™ã€‚
   * @param {string} str ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹æ–‡å­—åˆ—
   * @returns {string} ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸæ–‡å­—åˆ—
   */
  window.escapeHTML = str => {
    if (typeof str !== 'string') {
      return str;
    }
    return str.replace(/[&<>"']/g, function (match) {
      return {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
      }[match];
    });
  };

  // =================================================================
  // --- Level 1: åŸºæœ¬è¦ç´ ï¼ˆAtomic Componentsï¼‰ ---
  // -----------------------------------------------------------------
  // æœ€å°å˜ä½ã®UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€‚å˜ä¸€è²¬ä»»ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€å°åŒ–ã€‚
  // =================================================================

  const Components = {
    /**
     * é€²åŒ–ç‰ˆãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {string} config.action - data-actionå±æ€§ã®å€¤
     * @param {string} config.text - ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
     * @param {string} [config.style='primary'] - ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« ('primary'|'secondary'|'danger')
     * @param {string} [config.size='normal'] - ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚º ('normal'|'full'|'small')
     * @param {boolean} [config.disabled=false] - ç„¡åŠ¹çŠ¶æ…‹
     * @param {string} [config.customClass=''] - è¿½åŠ ã®CSSã‚¯ãƒ©ã‚¹
     * @param {Object} [config.dataAttributes={}] - è¿½åŠ ã®data-*å±æ€§ (ä¾‹: { classroomName: 'æ±äº¬' })
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    button: ({
      action,
      text,
      style = 'primary',
      size = 'normal',
      disabled = false,
      customClass = '',
      dataAttributes = {},
    }) => {
      // ã‚¹ã‚¿ã‚¤ãƒ«ãƒãƒƒãƒ”ãƒ³ã‚°
      const styleClasses = {
        primary: DesignConfig.colors.primary,
        secondary: DesignConfig.colors.secondary,
        danger: DesignConfig.colors.danger,
      };

      const sizeClasses = {
        normal: '',
        full: DesignConfig.buttons.full,
        small: 'text-sm px-3 py-1.5',
      };

      // ãƒ‡ãƒ¼ã‚¿å±æ€§ã‚’HTMLæ–‡å­—åˆ—ã«å¤‰æ›
      const dataAttrs = Object.entries(dataAttributes)
        .map(
          ([key, value]) =>
            `data-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}="${escapeHTML(value)}"`,
        )
        .join(' ');

      // ã‚¹ã‚¿ã‚¤ãƒ«ãŒ'none'ã®å ´åˆã¯åŸºæœ¬ã‚¯ãƒ©ã‚¹ã‚’æœ€å°é™ã«ã™ã‚‹
      const baseClass = style === 'none' ? '' : DesignConfig.buttons.base;
      const styleClass = style === 'none' ? '' : styleClasses[style] || '';

      return `<button type="button"
          data-action="${escapeHTML(action || '')}"
          class="${[baseClass, styleClass, sizeClasses[size] || '', customClass || ''].filter(Boolean).join(' ')}"
          ${dataAttrs}
          ${disabled ? 'disabled' : ''}
        >${escapeHTML(text)}</button>`;
    },

    /**
     * ã‚·ãƒ³ãƒ—ãƒ«åŒ–ã•ã‚ŒãŸå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {string} config.id - inputè¦ç´ ã®id
     * @param {string} config.label - ãƒ©ãƒ™ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ
     * @param {string} [config.type='text'] - inputè¦ç´ ã®type
     * @param {string} [config.value=''] - åˆæœŸå€¤
     * @param {string} [config.placeholder=''] - ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
     * @param {boolean} [config.required=false] - å¿…é ˆé …ç›®ã‹ã©ã†ã‹
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    input: ({
      id,
      label,
      type = 'text',
      value = '',
      placeholder = '',
      required = false,
    }) => {
      return `<div class="mb-4">
          <label
            for="${id}"
            class="${DesignConfig.text.labelBlock}"
          >${escapeHTML(label)}</label>
          <input
            type="${type}"
            id="${id}"
            value="${escapeHTML(value)}"
            class="${DesignConfig.inputs.base}"
            placeholder="${escapeHTML(placeholder)}"
            ${required ? 'required' : ''}
            autocomplete="off"
          >
        </div>`;
    },

    /**
     * ã‚·ãƒ³ãƒ—ãƒ«åŒ–ã•ã‚ŒãŸã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {string} config.id - selectè¦ç´ ã®id
     * @param {string} config.label - ãƒ©ãƒ™ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ
     * @param {string} config.options - optionè¦ç´ ã®HTMLæ–‡å­—åˆ—
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    select: ({ id, label, options }) => {
      return `<div class="mb-4">
          <label for="${id}" class="${DesignConfig.text.labelBlock}">${escapeHTML(label)}</label>
          <select
            id="${id}"
            class="${DesignConfig.inputs.base}"
          >${options}</select>
        </div>`;
    },

    /**
     * ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {string} config.id - textareaè¦ç´ ã®id
     * @param {string} config.label - ãƒ©ãƒ™ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ
     * @param {string} [config.value=''] - åˆæœŸå€¤
     * @param {string} [config.placeholder=''] - ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    textarea: ({ id, label, value = '', placeholder = '' }) => {
      return `<div class="mb-4">
          <label for="${id}" class="${DesignConfig.text.labelBlock}">${escapeHTML(label)}</label>
          <textarea
            id="${id}"
            class="${DesignConfig.inputs.textarea}"
            placeholder="${escapeHTML(placeholder)}"
          >${escapeHTML(value)}</textarea>
        </div>`;
    },

    /**
     * ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {string} config.id - inputè¦ç´ ã®id
     * @param {string} config.label - ãƒ©ãƒ™ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ
     * @param {boolean} [config.checked=false] - ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    checkbox: ({ id, label, checked = false }) => {
      return `<label class="flex items-center space-x-2 ${DesignConfig.colors.text}">
          <input
            type="checkbox"
            id="${id}"
            ${checked ? 'checked' : ''}
            class="accent-action-primary-bg"
          >
          <span>${escapeHTML(label)}</span>
        </label>`;
    },

    // =================================================================
    // --- æ–°è¨­è¨ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
    // -----------------------------------------------------------------

    /**
     * æƒ…å ±è¡¨ç¤ºã‚«ãƒ¼ãƒ‰
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {string} config.title - ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«
     * @param {Array<string>} config.items - è¡¨ç¤ºé …ç›®ã®é…åˆ—
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    infoCard: ({ title, items }) => {
      const itemsHtml = items
        .map(item => `<p class="text-brand-text">${escapeHTML(item)}</p>`)
        .join('');
      return `<div class="bg-ui-surface border border-ui-border p-3 rounded-lg">
          <h3 class="font-bold text-brand-text mb-2">${escapeHTML(title)}</h3>
          ${itemsHtml}
        </div>`;
    },

    /**
     * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {string} config.type - ãƒãƒƒã‚¸ã‚¿ã‚¤ãƒ— ('success'|'warning'|'error'|'info')
     * @param {string} config.text - ãƒãƒƒã‚¸ãƒ†ã‚­ã‚¹ãƒˆ
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    statusBadge: ({ type, text }) => {
      const typeClasses = {
        success: 'bg-state-success-bg text-state-success-text',
        warning: 'bg-ui-warning-bg text-ui-warning-text',
        error: 'bg-ui-error-bg text-ui-error-text',
        info: 'bg-action-secondary-bg text-action-secondary-text',
      };

      return `<span class="inline-block px-2 py-1 text-sm font-bold rounded ${typeClasses[type] || typeClasses.info}">${escapeHTML(text)}</span>`;
    },

    /**
     * æ–™é‡‘è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {number|string} config.amount - é‡‘é¡
     * @param {string} [config.label=''] - ãƒ©ãƒ™ãƒ«
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    priceDisplay: ({ amount, label = '' }) => {
      const formattedAmount =
        typeof amount === 'number' ? amount.toLocaleString() : amount;
      return `<div class="text-right">
          ${label ? `<span class="text-brand-subtle text-sm">${escapeHTML(label)}: </span>` : ''}
          <span class="font-bold text-brand-text">${formattedAmount}å††</span>
        </div>`;
    },

    // =================================================================
    // --- ä¼šè¨ˆç³»å°‚ç”¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
    // -----------------------------------------------------------------

    /**
     * ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {string} config.title - ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«
     * @param {string} config.backAction - æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®action
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    navigationHeader: ({ title, backAction }) => {
      return `<div class="flex justify-between items-center">
          <h1 class="text-2xl font-bold text-brand-text">${escapeHTML(title)}</h1>
          <button data-action="${backAction}" class="text-sm bg-action-secondary-bg text-action-secondary-text px-3 py-1.5 rounded-md active:bg-action-secondary-hover mobile-button">æˆ»ã‚‹</button>
        </div>`;
    },

    /**
     * ä¼šè¨ˆé …ç›®è¡Œï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä»˜ãï¼‰
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {string} config.name - é …ç›®å
     * @param {string} config.itemType - ã‚¢ã‚¤ãƒ†ãƒ ã‚¿ã‚¤ãƒ—
     * @param {number} config.price - å˜ä¾¡
     * @param {boolean} [config.checked=false] - ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹
     * @param {boolean} [config.disabled=false] - ç„¡åŠ¹åŒ–çŠ¶æ…‹
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    accountingRow: ({
      name,
      itemType,
      price,
      checked = false,
      disabled = false,
    }) => {
      return `<div class="flex items-center justify-between mb-2">
          <label class="flex items-center space-x-2 text-brand-text">
            <input type="checkbox"
                   name="${name}"
                   data-item-type="${itemType}"
                   data-item-name="${name}"
                   class="accounting-item h-5 w-5 rounded border-ui-border text-brand-text focus:ring-brand-text accent-action-primary-bg"
                   ${checked ? 'checked' : ''}
                   ${disabled ? 'disabled' : ''}>
            <span>${escapeHTML(name)}</span>
          </label>
          <span class="text-brand-subtle">${price.toLocaleString()}å††</span>
        </div>`;
    },

    /**
     * ææ–™å…¥åŠ›è¡Œ
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {number} config.index - è¡Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
     * @param {Object} [config.values] - åˆæœŸå€¤
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    materialRow: ({ index, values = {} }) => {
      const { type = '', l = '', w = '', h = '' } = values;

      // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ææ–™ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‹•çš„ã«ç”Ÿæˆ
      let materialOptions = '';
      try {
        const master = window.stateManager?.getState?.()?.accountingMaster;
        if (master && Array.isArray(master)) {
          materialOptions = master
            .filter(m => m['ç¨®åˆ¥'] === C.itemTypes.MATERIAL)
            .map(
              m =>
                `<option value="${escapeHTML(m[HEADERS.ACCOUNTING.ITEM_NAME])}" ${type === m[HEADERS.ACCOUNTING.ITEM_NAME] ? 'selected' : ''}>${escapeHTML(m[HEADERS.ACCOUNTING.ITEM_NAME])}</option>`,
            )
            .join('');
        }
      } catch (e) {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é™çš„ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        const staticOptions = ['æ¡‚', 'ã‚·ãƒŠ', 'æªœ', 'æ¥ ', 'æ¡œ', 'æœ´', 'ãã®ä»–'];
        materialOptions = staticOptions
          .map(
            option =>
              `<option value="${option}" ${type === option ? 'selected' : ''}>${option}</option>`,
          )
          .join('');
      }

      return `<div data-material-row-index="${index}">
          <div class="grid grid-cols-1 gap-y-2">
            <select id="material-type-${index}" name="materialType${index}" class="${DesignConfig.inputs.base} accounting-item">
              <option value="">-- æ¨¹ç¨®ã‚’é¸æŠ --</option>
              ${materialOptions}
            </select>
          </div>
          <div class="grid grid-cols-4 gap-2 mt-2 items-center">
            <input type="number" id="material-l-${index}" name="materialL${index}" value="${l || ''}" placeholder="ç¸¦(mm)" step="5" class="${DesignConfig.inputs.base} accounting-item custom-placeholder">
            <input type="number" id="material-w-${index}" name="materialW${index}" value="${w || ''}" placeholder="æ¨ª(mm)" step="5" class="${DesignConfig.inputs.base} accounting-item custom-placeholder">
            <input type="number" id="material-h-${index}" name="materialH${index}" value="${h || ''}" placeholder="åš(mm)" step="5" class="${DesignConfig.inputs.base} accounting-item custom-placeholder">
            <div id="material-price-${index}" class="text-right text-base text-brand-subtle">0å††</div>
          </div>
        </div>`;
    },

    /**
     * ãã®ä»–è²©å£²é …ç›®è¡Œ
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {number} config.index - è¡Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
     * @param {Object} [config.values] - åˆæœŸå€¤
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    otherSalesRow: ({ index, values = {} }) => {
      const { name = '', price = '' } = values;
      return `<div data-other-sales-row="${index}" class="mt-2 pt-2 border-t border-ui-border grid grid-cols-3 gap-2 items-center">
          <input type="text" id="other-sales-name-${index}" name="otherSalesName${index}" value="${escapeHTML(name)}" placeholder="å•†å“å" class="col-span-2 ${DesignConfig.inputs.base} accounting-item">
          <input type="text" inputmode="decimal" id="other-sales-price-${index}" name="otherSalesPrice${index}" value="${price}" placeholder="é‡‘é¡" class="${DesignConfig.inputs.base} accounting-item">
        </div>`;
    },

    /**
     * ä¼šè¨ˆæ¸ˆã¿è¡¨ç¤º
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {Object} config.details - ä¼šè¨ˆè©³ç´°ãƒ‡ãƒ¼ã‚¿
     * @param {Object} config.reservation - äºˆç´„ãƒ‡ãƒ¼ã‚¿
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    accountingCompleted: ({ details, reservation }) => {
      const tuitionItemsHtml = details.tuition.items
        .map(
          i =>
            `<div class="flex justify-between"><span>${escapeHTML(i.name)}</span><span>${i.price.toLocaleString()}å††</span></div>`,
        )
        .join('');
      const salesItemsHtml = details.sales.items
        .map(
          i =>
            `<div class="flex justify-between"><span>${escapeHTML(i.name)}</span><span>${i.price.toLocaleString()}å††</span></div>`,
        )
        .join('');
      const v = reservation.venue ? `ï¼ˆ${reservation.venue}ï¼‰` : '';

      return `<div class="text-center py-4">
          <h1 class="text-2xl font-bold text-brand-text mt-4 mb-2">ä¼šè¨ˆæ¸ˆã¿</h1>
          <p class="text-brand-subtle mb-6"><b>${formatDate(reservation.date)}</b><br>${reservation.classroom}${v}</p>
        </div>
        <div class="p-4 bg-ui-surface border border-ui-border rounded-lg text-left space-y-4">
          <div><h3 class="font-bold text-brand-text border-b border-ui-border mb-1 pb-1">æˆæ¥­æ–™</h3><div class="space-y-1 text-brand-text">${tuitionItemsHtml || 'ãªã—'}</div></div>
          <div><h3 class="font-bold text-brand-text border-b border-ui-border mb-1 pb-1">è²©å£²</h3><div class="space-y-1 text-brand-text">${salesItemsHtml || 'ãªã—'}</div></div>
          <div class="text-right font-bold text-xl pt-2 border-t border-ui-border text-brand-text">åˆè¨ˆ: ${details.grandTotal.toLocaleString()}å††</div>
          <div class="text-right text-base pt-2 text-brand-subtle">æ”¯æ‰•æ–¹æ³•: ${escapeHTML(details.paymentMethod)}</div>
        </div>
        <div class="mt-4 flex flex-col space-y-3">
          ${Components.button({ action: 'editAccountingRecord', text: 'ä¼šè¨ˆå†…å®¹ã‚’ä¿®æ­£ã™ã‚‹', style: 'secondary', size: 'full' })}
        </div>`;
    },

    /**
     * ä¼šè¨ˆãƒ•ã‚©ãƒ¼ãƒ å…¨ä½“
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {string} config.type - ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒ— ('timeBased' | 'fixed')
     * @param {Object} config.master - ä¼šè¨ˆãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
     * @param {Object} config.reservation - äºˆç´„ãƒ‡ãƒ¼ã‚¿
     * @param {Object} config.reservationDetails - äºˆç´„å›ºæœ‰æƒ…å ±
     * @param {Object} config.scheduleInfo - è¬›åº§å›ºæœ‰æƒ…å ±
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    accountingForm: ({
      type,
      master,
      reservation,
      reservationDetails,
      scheduleInfo,
    }) => {
      // æˆæ¥­æ–™ã‚»ã‚¯ã‚·ãƒ§ãƒ³
      let tuitionHtml;
      if (type === 'timeBased') {
        const tuitionItemRule = getTuitionItemRule(
          master,
          reservation.classroom,
          C.items.MAIN_LECTURE,
        );
        tuitionHtml = Components.timeBasedTuition({
          tuitionItemRule,
          reservationDetails,
          scheduleInfo,
        });
      } else {
        tuitionHtml = Components.fixedTuitionSection({
          master,
          reservation,
          reservationDetails,
        });
      }

      // è²©å£²ã‚»ã‚¯ã‚·ãƒ§ãƒ³
      const salesHtml = Components.salesSection({ master, reservationDetails });

      return `<div class="text-center py-4">
          <p class="text-brand-subtle mb-6"><b>${formatDate(reservation.date)}</b><br>${reservation.classroom}${reservation.venue ? `ï¼ˆ${reservation.venue}ï¼‰` : ''}</p>
        </div>
        <form id="accounting-form" class="space-y-6">
          ${tuitionHtml}
          ${salesHtml}
          <div class="text-right text-2xl font-bold py-4 border-t-2 border-ui-border flex flex-col items-end">
            <span id="grand-total-amount" class="text-brand-text">åˆè¨ˆ: 0å††</span>
          </div>
          <div class="mt-4 text-center">
            <p class="text-base text-state-danger-text font-bold mb-2">é‡‘é¡ã‚’ã€å…ˆç”Ÿã«ç¢ºèªã—ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„</p>
            <div class="space-y-3">
              ${Components.button({ action: 'showAccountingConfirmation', text: 'å…ˆç”Ÿã®ç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸ', style: 'primary', size: 'full' })}
            </div>
          </div>
        </form>`;
    },

    /**
     * æ™‚é–“åˆ¶æˆæ¥­æ–™ã‚»ã‚¯ã‚·ãƒ§ãƒ³
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {Object} config.tuitionItemRule - æˆæ¥­æ–™ãƒ«ãƒ¼ãƒ«
     * @param {Object} config.reservationDetails - äºˆç´„å›ºæœ‰æƒ…å ±
     * @param {Object} config.scheduleInfo - è¬›åº§å›ºæœ‰æƒ…å ±
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    timeBasedTuition: ({ tuitionItemRule, reservationDetails, scheduleInfo }) => {
      return getTimeBasedTuitionHtml(
        tuitionItemRule,
        reservationDetails,
        scheduleInfo,
      );
    },

    /**
     * å›ºå®šåˆ¶æˆæ¥­æ–™ã‚»ã‚¯ã‚·ãƒ§ãƒ³
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {Object} config.master - ä¼šè¨ˆãƒã‚¹ã‚¿ãƒ¼
     * @param {Object} config.reservation - äºˆç´„ãƒ‡ãƒ¼ã‚¿
     * @param {Object} config.reservationDetails - äºˆç´„å›ºæœ‰æƒ…å ±
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    fixedTuitionSection: ({ master, reservation, reservationDetails }) => {
      // isFirstTimeBooking ã‚’stateManagerã‹ã‚‰å–å¾—
      const isFirstTimeBooking = stateManager.getState().isFirstTimeBooking;

      // ä½¿ç”¨ã™ã‚‹æˆæ¥­æ–™é …ç›®ã‚’æ±ºå®šï¼ˆåˆå›æˆæ¥­æ–™ or åŸºæœ¬æˆæ¥­æ–™ï¼‰
      const targetItemName = isFirstTimeBooking
        ? C.items.FIRST_LECTURE
        : C.items.MAIN_LECTURE;
      const tuitionItem = master.find(
        item =>
          item[HEADERS.ACCOUNTING.TYPE] === C.itemTypes.TUITION &&
          item[HEADERS.ACCOUNTING.ITEM_NAME] === targetItemName &&
          (item[HEADERS.ACCOUNTING.TARGET_CLASSROOM] === 'å…±é€š' ||
            item[HEADERS.ACCOUNTING.TARGET_CLASSROOM]?.includes(
              reservation.classroom,
            )),
      );

      // æˆæ¥­æ–™ã®è¡¨ç¤ºå†…å®¹ã‚’ç”Ÿæˆ
      let tuitionDisplayHtml = '';
      if (tuitionItem) {
        const price = tuitionItem[HEADERS.ACCOUNTING.UNIT_PRICE] || 0;
        const bgColor = isFirstTimeBooking
          ? 'bg-green-50 border-green-400'
          : 'bg-blue-50 border-blue-400';
        const textColor = isFirstTimeBooking ? 'text-green-800' : 'text-blue-800';
        const label = isFirstTimeBooking
          ? C.items.FIRST_LECTURE
          : C.items.MAIN_LECTURE;

        tuitionDisplayHtml = `<div class="mb-4 p-3 ${bgColor} rounded border-l-4">
            <div class="text-base ${textColor}">
              <span class="font-semibold">${label}:</span> Â¥${price.toLocaleString()}
            </div>
          </div>`;
      }

      const tuitionItems = master.filter(
        item =>
          item[HEADERS.ACCOUNTING.TYPE] === C.itemTypes.TUITION &&
          (item[HEADERS.ACCOUNTING.TARGET_CLASSROOM] === 'å…±é€š' ||
            item[HEADERS.ACCOUNTING.TARGET_CLASSROOM]?.includes(
              reservation.classroom,
            )),
      );

      const tuitionRowsHtml = tuitionItems
        .map(item => {
          const itemName = item[HEADERS.ACCOUNTING.ITEM_NAME];

          // ãƒ¡ã‚¤ãƒ³æˆæ¥­æ–™é …ç›®ã®å‡¦ç†ï¼ˆåˆå›å‚åŠ æ™‚ã¯å·®ã—æ›¿ãˆï¼‰
          if (itemName === targetItemName) {
            return Components.accountingRow({
              name: itemName,
              itemType: C.itemTypes.TUITION,
              price: item[HEADERS.ACCOUNTING.UNIT_PRICE],
              checked: true,
              disabled: true,
            });
          }

          // ä½¿ã‚ãªã„æˆæ¥­æ–™é …ç›®ã‚’ã‚¹ã‚­ãƒƒãƒ—
          if (
            (itemName === C.items.FIRST_LECTURE && !isFirstTimeBooking) ||
            (itemName === C.items.MAIN_LECTURE && isFirstTimeBooking)
          ) {
            return '';
          }

          // ãã®ä»–ã®é …ç›®ï¼ˆå½«åˆ»åˆ€ãƒ¬ãƒ³ã‚¿ãƒ«ãªã©ï¼‰
          const isChecked = !!(
            reservationDetails[itemName] ||
            (itemName === C.items.CHISEL_RENTAL &&
              reservationDetails.chiselRental)
          );

          return Components.accountingRow({
            name: itemName,
            itemType: C.itemTypes.TUITION,
            price: item[HEADERS.ACCOUNTING.UNIT_PRICE],
            checked: isChecked,
            disabled: false,
          });
        })
        .filter(html => html !== '')
        .join('');

      return `<div class="p-4 bg-ui-surface border border-ui-border rounded-lg">
          <h3 class="text-xl font-bold mb-3 text-brand-text">æˆæ¥­æ–™</h3>
          ${tuitionDisplayHtml}
          <div class="space-y-3">${tuitionRowsHtml}</div>
          <div id="tuition-breakdown" class="mt-4 pt-4 border-t border-ui-border space-y-1 text-base text-brand-subtle"></div>
          <div class="text-right font-bold mt-2 text-brand-text" id="tuition-subtotal">å°è¨ˆ: 0å††</div>
        </div>`;
    },

    // =================================================================
    // --- Level 3: ç”»é¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆOrganismsï¼‰ ---
    // -----------------------------------------------------------------
    // è¤‡åˆçš„ãªUIã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ›ãƒ¼ãƒ ã€äºˆç´„ä¸€è¦§ç­‰ï¼‰
    // =================================================================

    /**
     * ãƒ›ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆäºˆç´„ã¾ãŸã¯å±¥æ­´ï¼‰
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {string} config.title - ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«
     * @param {Array} config.items - è¡¨ç¤ºé …ç›®ã®é…åˆ—ï¼ˆHTMLã‚«ãƒ¼ãƒ‰æ–‡å­—åˆ—ã®é…åˆ—ï¼‰
     * @param {boolean} [config.showNewButton=false] - æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
     * @param {string} [config.newAction] - æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³ã®action
     * @param {boolean} [config.showMoreButton=false] - ã‚‚ã£ã¨ã¿ã‚‹ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
     * @param {string} [config.moreAction] - ã‚‚ã£ã¨ã¿ã‚‹ãƒœã‚¿ãƒ³ã®action
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    dashboardSection: ({
      title,
      items,
      showNewButton = false,
      newAction,
      showMoreButton = false,
      moreAction,
    }) => {
      let newButtonHtml = '';
      if (showNewButton && newAction) {
        newButtonHtml = Components.newReservationCard({ action: newAction });
      }

      const itemsHtml = items.join('');

      let moreButtonHtml = '';
      if (showMoreButton && moreAction) {
        moreButtonHtml = `<div class="text-center mt-4">
            ${Components.button({ action: moreAction, text: 'ã‚‚ã£ã¨ã¿ã‚‹', style: 'secondary', size: 'small' })}
          </div>`;
      }

      return `
          <div class="mb-8 w-full">
            <div class="bg-ui-surface border border-ui-border p-3 rounded-lg space-y-3">
              <h2 class="text-xl font-medium text-brand-text text-center mb-2">${escapeHTML(title)}</h2>
              ${newButtonHtml}
              ${itemsHtml}
              ${moreButtonHtml}
            </div>
          </div>
        `;
    },

    /**
     * æ–°è¦äºˆç´„ã‚«ãƒ¼ãƒ‰ï¼ˆãƒ›ãƒ¼ãƒ ç”¨ï¼‰
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {string} config.action - data-actionå±æ€§ã®å€¤
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    newReservationCard: ({ action }) => {
      return `
          <div data-action="${action}" class="w-full p-4 rounded-lg border-2 border-dashed border-action-primary-border bg-action-primary-light cursor-pointer mobile-card touch-friendly">
            <div class="text-center">
              <span class="text-xl font-bold text-action-primary-bg">+ ã‚ãŸã‚‰ã—ã ã‚ˆã‚„ã ã™ã‚‹</span>
            </div>
          </div>
        `;
    },

    /**
     * çµ±ä¸€ã‚«ãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆäºˆç´„ãƒ»å±¥æ­´å…±é€šï¼‰
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {Object} config.item - äºˆç´„ã¾ãŸã¯å±¥æ­´ãƒ‡ãƒ¼ã‚¿
     * @param {Array} config.buttons - ãƒœã‚¿ãƒ³é…åˆ—ï¼ˆ{action, text, style, details?}ã®å½¢å¼ï¼‰
     * @param {string} [config.type='booking'] - ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ— ('booking' | 'history')
     * @param {Date} [config.today] - ä»Šæ—¥ã®æ—¥ä»˜ï¼ˆäºˆç´„ç”¨ï¼‰
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    listCard: ({ item, buttons, type = 'booking', today }) => {
      // ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆViewsã‹ã‚‰ã®æŠ½è±¡çš„ãªstyleã‚’å…·ä½“çš„ãªCSSã‚¯ãƒ©ã‚¹ã«å¤‰æ›ï¼‰
      const styleMapping = {
        paid: `${DesignConfig.colors.paid} text-base font-bold px-3 py-1.5 rounded`,
        accounting: `text-base ${DesignConfig.colors.accounting} font-bold px-3 py-1.5 rounded mobile-button`,
        edit: 'text-base bg-action-secondary-bg text-action-secondary-text font-medium px-3 py-1.5 rounded active:bg-action-secondary-hover focus:bg-action-secondary-hover mobile-button',
        record:
          'text-sm bg-action-paid-bg text-action-paid-text font-bold px-3 py-1.5 rounded',
        'edit-small':
          'text-sm bg-action-secondary-bg text-action-secondary-text font-bold px-3 py-1.5 rounded active:bg-action-secondary-hover focus:bg-action-secondary-hover mobile-button',
      };

      // ãƒœã‚¿ãƒ³é…åˆ—ã‚’æ—§å½¢å¼ã«å¤‰æ›
      const legacyButtons = buttons.map(btn => ({
        action: btn.action,
        text: btn.text,
        colorClass: styleMapping[btn.style] || styleMapping['edit'],
        details: btn.details, // ä¼šè¨ˆè¨˜éŒ²ç”¨
      }));

      return createReservationCard({
        type: type,
        item: item,
        today: today,
        buttons: legacyButtons,
      });
    },

    /**
     * è²©å£²ã‚»ã‚¯ã‚·ãƒ§ãƒ³
     * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {Object} config.master - ä¼šè¨ˆãƒã‚¹ã‚¿ãƒ¼
     * @param {Object} config.reservationDetails - äºˆç´„å›ºæœ‰æƒ…å ±
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    salesSection: ({ master, reservationDetails }) => {
      const salesItems = master.filter(
        item => item['ç¨®åˆ¥'] === C.itemTypes.SALES,
      );
      const salesItemsHtml = salesItems
        .map(item => {
          // truthyå€¤ã§ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’åˆ¤å®šï¼ˆã‚ˆã‚ŠæŸ”è»Ÿï¼‰
          const isChecked =
            !!reservationDetails[item[HEADERS.ACCOUNTING.ITEM_NAME]];

          return Components.accountingRow({
            name: item[HEADERS.ACCOUNTING.ITEM_NAME],
            itemType: C.itemTypes.SALES,
            price: item[HEADERS.ACCOUNTING.UNIT_PRICE],
            checked: isChecked,
          });
        })
        .join('');

      return `<div class="p-4 bg-ui-surface border border-ui-border rounded-lg">
          <h3 class="text-xl font-bold mb-3 text-left text-brand-text">è²©å£²</h3>
          <div class="mb-3 space-y-4">
            <label class="block text-brand-text text-base font-bold">ææ–™ä»£</label>
            <div id="materials-container">
              ${Components.materialRow({
                index: 0,
                values: {
                  type: reservationDetails.materialType0,
                  l: reservationDetails.materialL0,
                  w: reservationDetails.materialW0,
                  h: reservationDetails.materialH0,
                },
              })}
            </div>
          </div>
          ${Components.button({ action: 'addMaterialRow', text: '+ ææ–™ã‚’è¿½åŠ ', style: 'secondary', size: 'full' })}
          <details class="mt-4">
            <summary class="font-bold text-brand-text flex items-center">
              <span class="arrow mr-2">â–¶</span> ãã®ä»–ã®è²©å£²å“
            </summary>
            <div class="mt-2 space-y-2 pt-2 border-t border-ui-border">
              ${salesItemsHtml}
              <div id="other-sales-container" class="mt-2 pt-2 border-t border-ui-border">
                ${Components.otherSalesRow({
                  index: 0,
                  values: {
                    name: reservationDetails.otherSalesName0,
                    price: reservationDetails.otherSalesPrice0,
                  },
                })}
              </div>
            </div>
            ${Components.button({ action: 'addOtherSalesRow', text: '+ è‡ªç”±å…¥åŠ›æ¬„ã‚’è¿½åŠ ', style: 'secondary', size: 'full' })}
          </details>
          <div class="text-right font-bold mt-2 text-brand-text" id="sales-subtotal">å°è¨ˆ: 0å††</div>
        </div>`;
    },
  };

  // =================================================================
  // --- Specialized Components ---
  // -----------------------------------------------------------------
  // ç‰¹å®šç”¨é€”ã«ç‰¹åŒ–ã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
  // =================================================================

  /**
   * å³ä¸Šå›ºå®šé…ç½®ã®æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆã—ã¾ã™
   * @param {string} action - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 'smartGoBack'ï¼‰
   * @param {string} text - ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 'æˆ»ã‚‹'ï¼‰
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  Components.createBackButton = (action = 'smartGoBack', text = 'æˆ»ã‚‹') => {
    return `
        <div class="back-button-container fixed top-4 right-4 z-30">
          <button
            data-action="${escapeHTML(action)}"
            class="bg-action-secondary-bg text-action-secondary-text active:bg-action-secondary-hover font-bold py-2 px-4 rounded-md transition-all duration-150 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 mobile-button touch-friendly shadow-lg"
          >
            ${escapeHTML(text)}
          </button>
        </div>`;
  };

  /**
   * ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã«å¿œã˜ã¦é©åˆ‡ãªæˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆã—ã¾ã™
   * @param {string} currentView - ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼å
   * @param {object} appState - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  Components.createSmartBackButton = (currentView, appState = null) => {
    const state =
      appState || (window.stateManager ? window.stateManager.getState() : {});
    let action = 'smartGoBack';
    let text = 'æˆ»ã‚‹';

    // ãƒ“ãƒ¥ãƒ¼ã«å¿œã˜ã¦é©åˆ‡ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
    switch (currentView) {
      case 'login':
        // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã§ã¯æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ãªã„
        return '';

      case 'register':
        text = 'ãƒ­ã‚°ã‚¤ãƒ³ã¸';
        action = 'goBackToLogin';
        break;

      case 'registrationStep2':
        text = 'å‰ã¸';
        action = 'backToStep1';
        break;

      case 'registrationStep3':
        text = 'å‰ã¸';
        action = 'backToStep2';
        break;

      case 'registrationStep4':
        text = 'å‰ã¸';
        action = 'backToStep3';
        break;

      case 'userSearch':
        text = 'ãƒ­ã‚°ã‚¤ãƒ³ã¸';
        action = 'goBackToLogin';
        break;

      case 'dashboard':
        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã¯æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ãªã„
        return '';

      case 'bookingSlots':
        text = 'ãƒ›ãƒ¼ãƒ ';
        action = 'goBackToDashboard';
        break;

      case 'newReservation':
        text = 'äºˆç´„ä¸€è¦§';
        action = 'goBackToBooking';
        break;

      case 'editReservation':
        text = 'ãƒ›ãƒ¼ãƒ ';
        action = 'goBackToDashboard';
        break;

      case 'accounting':
        text = 'ãƒ›ãƒ¼ãƒ ';
        action = 'goBackToDashboard';
        break;

      case 'complete':
        text = 'ãƒ›ãƒ¼ãƒ ';
        action = 'goBackToDashboard';
        break;

      default:
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚¹ãƒãƒ¼ãƒˆæˆ»ã‚‹
        break;
    }

    return Components.createBackButton(action, text);
  };

  // =================================================================
  // --- ãƒ¬ã‚¬ã‚·ãƒ¼äº’æ›æ€§ã‚µãƒãƒ¼ãƒˆ ---
  // -----------------------------------------------------------------
  // æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰äº’æ›æ€§ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã®æ—§å¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
  // æ®µéšçš„ç§»è¡ŒæœŸé–“ä¸­ã®ã¿ä½¿ç”¨
  // =================================================================

  /**
   * ãƒ¬ã‚¬ã‚·ãƒ¼ createButton (æ—¢å­˜ã‚³ãƒ¼ãƒ‰äº’æ›ç”¨)
   * æ–°è¦ã‚³ãƒ¼ãƒ‰ã§ã¯Components.button()ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
   */
  Components.createButton = config => {
    // æ—§å½¢å¼ã‚’æ–°å½¢å¼ã«ãƒãƒƒãƒ”ãƒ³ã‚°
    let style = 'primary';
    if (config.colorClass) {
      if (config.colorClass.includes('secondary')) style = 'secondary';
      if (config.colorClass.includes('danger')) style = 'danger';
    }

    let size = 'normal';
    if (config.widthClass && config.widthClass.includes('full')) size = 'full';

    // æ—§å¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’HTMLã«åŸ‹ã‚è¾¼ã¿ï¼ˆactionHandlersäº’æ›æ€§ã®ãŸã‚ï¼‰
    const dataAttributes = {};
    if (config.classroom) dataAttributes.classroom = config.classroom;
    if (config.date) dataAttributes.date = config.date;
    if (config.reservationId) dataAttributes.reservationId = config.reservationId;
    if (config.sheetName) dataAttributes.sheetName = config.sheetName;
    if (config.copyText) dataAttributes.copyText = config.copyText;
    if (config.details) dataAttributes.details = config.details;
    if (config.studentId) dataAttributes.studentId = config.studentId;
    if (config.realName) dataAttributes.realName = config.realName;
    if (config.nickname) dataAttributes.nickname = config.nickname;
    if (config.classroomName) dataAttributes.classroomName = config.classroomName;

    return Components.button({
      action: config.action,
      text: config.text,
      style: style,
      size: size,
      disabled: config.disabled,
      customClass: config.colorClass, // ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ©ã‚¹ã‚’æ¸¡ã™
      dataAttributes: dataAttributes,
    });
  };

  /**
   * ãƒ¬ã‚¬ã‚·ãƒ¼ createInput (æ—¢å­˜ã‚³ãƒ¼ãƒ‰äº’æ›ç”¨)
   */
  Components.createInput = config => {
    // è¤‡é›‘ãªæ—§å½¢å¼ã‚’ã‚µãƒãƒ¼ãƒˆ
    let inputHtml = `<div class="${config.containerClass || ''} mb-4">
        <label
          for="${config.id}"
          class="${config.labelClass || DesignConfig.text.labelBlock} ${config.isSrOnly ? 'sr-only' : ''}"
        >${escapeHTML(config.label)}</label>
        ${config.caption ? `<p class="${DesignConfig.text.caption} mb-2">${escapeHTML(config.caption)}</p>` : ''}
        <input
          type="${config.type}"
          id="${config.id}"
          value="${escapeHTML(config.value || '')}"
          class="${DesignConfig.inputs.base} ${config.inputClass || ''}"
          placeholder="${escapeHTML(config.placeholder || '')}"
          ${config.required ? 'required' : ''}
          autocomplete="${config.autocomplete || 'off'}"
          ${config.step ? `step="${config.step}"` : ''}
          ${config.inputmode ? `inputmode="${config.inputmode}"` : ''}
          ${config.pattern ? `pattern="${config.pattern}"` : ''}
        >
      </div>`;

    return inputHtml;
  };

  /**
   * ãƒ¬ã‚¬ã‚·ãƒ¼ createTextArea (æ—¢å­˜ã‚³ãƒ¼ãƒ‰äº’æ›ç”¨)
   */
  Components.createTextArea = config => {
    return `<div class="${config.containerClass || ''} mb-4">
        <label for="${config.id}" class="${DesignConfig.text.labelBlock}">${escapeHTML(config.label)}</label>
        ${config.caption ? `<p class="${DesignConfig.text.caption} mb-2">${escapeHTML(config.caption)}</p>` : ''}
        <textarea
          id="${config.id}"
          class="${DesignConfig.inputs.textarea}"
          placeholder="${escapeHTML(config.placeholder || '')}"
        >${escapeHTML(config.value || '')}</textarea>
      </div>`;
  };

  /**
   * ãƒ¬ã‚¬ã‚·ãƒ¼ createSelect (æ—¢å­˜ã‚³ãƒ¼ãƒ‰äº’æ›ç”¨)
   */
  Components.createSelect = config => {
    return `<div class="${config.containerClass || ''}">
        ${config.label ? `<label for="${config.id}" class="${DesignConfig.text.labelBlock}">${escapeHTML(config.label)}</label>` : ''}
        ${config.caption ? `<p class="${DesignConfig.text.caption} mb-2">${escapeHTML(config.caption)}</p>` : ''}
        <select
          id="${config.id}"
          class="${DesignConfig.inputs.base} ${config.sizeClass || ''} accounting-item"
          ${config.name ? `name="${config.name}"` : ''}
        >${config.options}</select>
      </div>`;
  };

  /**
   * ãƒ¬ã‚¬ã‚·ãƒ¼ createCheckbox (æ—¢å­˜ã‚³ãƒ¼ãƒ‰äº’æ›ç”¨)
   */
  Components.createCheckbox = config => {
    return `<label class="flex items-center space-x-2 ${DesignConfig.colors.text}">
        <input
          type="checkbox"
          id="${config.id}"
          ${config.checked ? 'checked' : ''}
          class="accent-action-primary-bg"
        >
        <span>${escapeHTML(config.label)}</span>
      </label>`;
  };

  // =================================================================
  // --- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
  // -----------------------------------------------------------------
  // æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½
  // =================================================================

  /**
   * æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¾ã™
   * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   * @param {string} config.id - ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ID
   * @param {string} config.title - ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«
   * @param {string} config.content - ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ï¼ˆHTMLæ–‡å­—åˆ—ï¼‰
   * @param {string} [config.maxWidth] - æœ€å¤§å¹…ã®CSSã‚¯ãƒ©ã‚¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 'max-w-sm'ï¼‰
   * @param {boolean} [config.showCloseButton] - å³ä¸Šã®Ã—ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ã‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: trueï¼‰
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  Components.modal = config => {
    const maxWidth = config.maxWidth || 'max-w-sm';
    const showCloseButton = config.showCloseButton !== false;

    return `
        <div id="${escapeHTML(config.id)}" class="modal-fade fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="Components.closeModalOnBackdrop(event, '${escapeHTML(config.id)}')">
          <div class="bg-white rounded-lg ${maxWidth} mx-4 max-h-[90vh] overflow-y-auto" onclick="Components.handleModalContentClick(event)" data-modal-content="true">
            <div class="flex justify-between items-center p-4 border-b border-ui-border">
              <h2 class="text-xl font-bold text-brand-text">${escapeHTML(config.title)}</h2>
              ${showCloseButton ? `<button onclick="Components.closeModal('${escapeHTML(config.id)}')" class="text-gray-500 hover:text-gray-700 text-2xl font-bold leading-none">&times;</button>` : ''}
            </div>
            <div class="p-4">
              ${config.content}
            </div>
          </div>
        </div>`;
  };

  /**
   * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™ï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
   * @param {string} modalId - ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ID
   */
  Components.showModal = modalId => {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.remove('hidden');
      // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã®é…å»¶
      requestAnimationFrame(() => {
        modal.classList.add('active');
      });
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒˆãƒ©ãƒƒãƒ—ã®è¨­å®š
      const focusableElements = modal.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',
      );
      if (focusableElements.length > 0) {
        focusableElements[0].focus();
      }
    }
  };

  /**
   * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤ºã«ã—ã¾ã™ï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
   * @param {string} modalId - ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ID
   */
  Components.closeModal = modalId => {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.remove('active');
      // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«å®Œå…¨ã«éè¡¨ç¤ºã«ã™ã‚‹
      setTimeout(() => {
        modal.classList.add('hidden');
      }, 300); // CSS transitionã¨åŒã˜æ™‚é–“
    }
  };

  /**
   * èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹å‡¦ç†
   * @param {Event} event - ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
   * @param {string} modalId - ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ID
   */
  Components.closeModalOnBackdrop = (event, modalId) => {
    if (event.target === event.currentTarget) {
      Components.closeModal(modalId);
    }
  };

  /**
   * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å†…ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
   * ãƒœã‚¿ãƒ³ãªã©ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–è¦ç´ ã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç¶™ç¶šã—ã€ãã®ä»–ã§ã¯ä¼æ’­ã‚’åœæ­¢
   * @param {Event} event - ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
   */
  Components.handleModalContentClick = event => {
    // ãƒœã‚¿ãƒ³ã¾ãŸã¯data-actionè¦ç´ ã®å ´åˆã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç¶™ç¶š
    const actionElement = event.target.closest('button, [data-action]');
    if (actionElement) {
      // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã®å ´åˆã¯ä¼æ’­ã‚’ç¶™ç¶šï¼ˆå¤–å´ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§å‡¦ç†ï¼‰
      return;
    }
    // ãã‚Œä»¥å¤–ã®å ´åˆã¯ä¼æ’­ã‚’åœæ­¢
    event.stopPropagation();
  };


  // =================================================================
  // 13_WebApp_Views.js (è‡ªå‹•çµ±åˆ)
  // =================================================================

  // @ts-check
  /// <reference path="../types.d.ts" />

  /**
   * =================================================================
   * ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: 13_WebApp_Views.js
   * ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘: 1.9
   * ã€å½¹å‰²ã€‘: WebAppã®å„ç”»é¢ï¼ˆãƒ“ãƒ¥ãƒ¼ï¼‰ã®HTMLæ§‹é€ ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ç¾¤ã‚’é›†ç´„ã—ã¾ã™ã€‚
   * - å„é–¢æ•°ã¯ç‰¹å®šã®ç”»é¢ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã€äºˆç´„ä¸€è¦§ãªã©ï¼‰ã®UIæ§‹ç¯‰ã‚’æ‹…å½“ã—ã¾ã™ã€‚
   * - appStateã®ç¾åœ¨ã®çŠ¶æ…‹ã«åŸºã¥ãã€å‹•çš„ã«HTMLã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * ã€æ§‹æˆã€‘: 14ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã§ã®ãƒ“ãƒ¥ãƒ¼ç®¡ç†
   * ã€v1.9ã§ã®å¤‰æ›´ç‚¹ã€‘:
   * - FE-14: ä¼šè¨ˆç”»é¢ã®å…¥åŠ›ä¿æŒæ©Ÿèƒ½ã‚’å®Ÿè£…ã€‚
   *   - getAccountingViewã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸå€¤ã¨ã—ã¦è¨­å®šã™ã‚‹ã‚ˆã†ä¿®æ­£ã€‚
   * =================================================================
   */

  // =================================================================
  // --- View Helper Components ---
  // -----------------------------------------------------------------
  // å„ãƒ“ãƒ¥ãƒ¼ã‚’æ§‹æˆã™ã‚‹ãŸã‚ã®ã€ã‚ˆã‚Šå°ã•ãªéƒ¨å“ã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤ã€‚
  // =================================================================

  /**
   * å½“æ—¥ã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã¾ã™ã€‚
   * @param {string} dateString - æ—¥ä»˜æ–‡å­—åˆ— (YYYY-MM-DD)
   * @returns {boolean} å½“æ—¥ã®å ´åˆtrue
   */
  const _isToday = dateString => {
    const itemDate = new Date(dateString);
    const today = new Date();
    return itemDate.toDateString() === today.toDateString();
  };

  /**
   * æ™‚åˆ»é¸æŠç”¨ã®<option>ã‚¿ã‚°ç¾¤ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {number} startHour - é–‹å§‹æ™‚åˆ»ï¼ˆæ™‚ï¼‰
   * @param {number} endHour - çµ‚äº†æ™‚åˆ»ï¼ˆæ™‚ï¼‰
   * @param {number} step - é–“éš”ï¼ˆåˆ†ï¼‰
   * @param {string | null} selectedValue - äº‹å‰ã«é¸æŠã™ã‚‹æ™‚åˆ» (HH:mm)
   * @returns {string} HTMLã®<option>ã‚¿ã‚°æ–‡å­—åˆ—
   */
  const getTimeOptionsHtml = (startHour, endHour, step, selectedValue) => {
    let options = [];
    for (let h = startHour; h <= endHour; h++) {
      for (let m = 0; m < 60; m += step) {
        const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        options.push(
          `<option value="${time}" ${time === selectedValue ? 'selected' : ''}>${time}</option>`,
        );
      }
    }
    return options.join('');
  };

  /**
   * å‰²å¼•é¸æŠç”¨ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {object} discountRule - æ–™é‡‘ãƒã‚¹ã‚¿ã‹ã‚‰å–å¾—ã—ãŸå‰²å¼•ãƒ«ãƒ¼ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   * @param {string} selectedValue - é¸æŠæ¸ˆã¿ã®å€¤
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getDiscountHtml = (discountRule, selectedValue) => {
    if (!discountRule) return '';
    const isChecked =
      selectedValue && parseInt(selectedValue, 10) > 0 ? 'checked' : '';
    return `
          <div class="mt-4 pt-4 border-t border-ui-border-light">
              <label class="flex items-center space-x-2">
                  <input type="checkbox" id="discount-checkbox" name="discountApplied" ${isChecked} class="accounting-item accent-action-primary-bg">
                  <span class="${DesignConfig.text.labelBlock}">${discountRule[HEADERS.ACCOUNTING.ITEM_NAME]} (Â¥500å¼•ã)</span>
              </label>
          </div>`;
  };

  /**
   * é¸æŠã•ã‚ŒãŸæ”¯æ‰•æ–¹æ³•ã«å¿œã˜ãŸæ”¯æ‰•ã„æƒ…å ±ã‚’å‹•çš„ã«è¡¨ç¤ºã™ã‚‹UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {string} selectedPaymentMethod - é¸æŠã•ã‚ŒãŸæ”¯æ‰•æ–¹æ³•
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getPaymentInfoHtml = (selectedPaymentMethod = '') => {
    let paymentInfoHtml = '';

    // ã“ã¨ã‚‰é€é‡‘ãŒé¸æŠã•ã‚ŒãŸå ´åˆã®ã¿é›»è©±ç•ªå·ã‚’è¡¨ç¤º
    if (selectedPaymentMethod === PAYMENT.COTRA) {
      paymentInfoHtml += `
          <div class="bg-ui-surface border border-ui-border p-3 rounded-md">
              <div class="flex justify-between items-center">
                  <div class="${DesignConfig.text.body}"><span class="font-bold">${PAYMENT.COTRA}:</span><span class="ml-2">${BANK.COTRA_PHONE}</span></div>
                  <button data-action="copyToClipboard" data-copy-text="${BANK.COTRA_PHONE}" class="flex-shrink-0 text-sm bg-action-secondary-bg active:bg-action-secondary-hover text-action-secondary-text font-bold px-2 py-1 rounded mobile-button">ã‚³ãƒ”ãƒ¼</button>
              </div>
          </div>`;
    }

    // æŒ¯è¾¼ãŒé¸æŠã•ã‚ŒãŸå ´åˆã®ã¿å£åº§æƒ…å ±ã‚’è¡¨ç¤º
    if (selectedPaymentMethod === PAYMENT.BANK_TRANSFER) {
      paymentInfoHtml += `
          <div class="bg-ui-surface border border-ui-border p-3 rounded-md">
              <div class="text-brand-text"><span class="font-bold">æŒ¯è¾¼å…ˆ:</span><span class="ml-2">${BANK.NAME}</span></div>
              <div class="mt-1 flex justify-between items-center">
                  <div class="text-base text-brand-text">åº—ç•ª: ${BANK.BRANCH}</div>
                  <button data-action="copyToClipboard" data-copy-text="${BANK.BRANCH}" class="text-sm bg-action-secondary-bg active:bg-action-secondary-hover text-action-secondary-text font-bold px-2 py-1 rounded mobile-button">ã‚³ãƒ”ãƒ¼</button>
              </div>
              <div class="mt-1 flex justify-between items-center">
                  <div class="text-base text-brand-text">æ™®é€š: ${BANK.ACCOUNT}</div>
                  <button data-action="copyToClipboard" data-copy-text="${BANK.ACCOUNT}" class="text-sm bg-action-secondary-bg active:bg-action-secondary-hover text-action-secondary-text font-bold px-2 py-1 rounded mobile-button">ã‚³ãƒ”ãƒ¼</button>
              </div>
          </div>`;
    }

    // ç¾é‡‘ã®å ´åˆã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
    return paymentInfoHtml;
  };

  /**
   * æ”¯æ‰•ã„æ–¹æ³•ã®é¸æŠè‚¢ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼‰UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {string} selectedValue - é¸æŠæ¸ˆã¿ã®æ”¯æ‰•ã„æ–¹æ³•
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getPaymentOptionsHtml = selectedValue => {
    const cotraDetails = `
          <details class="mt-2 ml-6">
              <summary class="inline-block px-2 py-1 bg-ui-warning-light text-ui-warning-text text-sm font-semibold rounded-md active:bg-ui-warning-bg">
                  ã“ã¨ã‚‰é€é‡‘ã¨ã¯ï¼Ÿ <span class="arrow">â–¼</span>
              </summary>
              <p class="mt-2 p-2 bg-ui-warning-bg rounded-md text-sm text-left text-brand-subtle">
                  é›»è©±ç•ªå·ã ã‘ã§éŠ€è¡Œå£åº§é–“ã§é€é‡‘ã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚æ‰‹æ•°æ–™ç„¡æ–™ã€‚å¯¾å¿œã®éŠ€è¡Œã‚¢ãƒ—ãƒªã‹ã‚‰åˆ©ç”¨ã§ãã¾ã™ã€‚<br>
                  (ä¾‹ï¼šã‚†ã†ã¡ã‚‡é€šå¸³ã‚¢ãƒ—ãƒªã€ä¸‰äº•ä½å‹éŠ€è¡Œã‚¢ãƒ—ãƒªã€ä½ä¿¡SBIãƒãƒƒãƒˆéŠ€è¡Œã‚¢ãƒ—ãƒªãªã©)
                  <a href="https://www.cotra.ne.jp/member/" target="_blank" class="text-ui-link-text">å¯¾å¿œã‚¢ãƒ—ãƒªä¸€è¦§</a>
              </p>
          </details>`;
    const options = [
      {
        value: PAYMENT.CASH,
        text: PAYMENT.CASH,
        details: '',
      },
      {
        value: PAYMENT.COTRA,
        text: PAYMENT.COTRA,
        details: cotraDetails,
      },
      {
        value: PAYMENT.BANK_TRANSFER,
        text: PAYMENT.BANK_TRANSFER,
        details: '',
      },
    ];
    return (
      options
        .map(
          (opt, i) => `
          <div>
              <label class="flex items-center space-x-2 text-brand-text">
                  <input type="radio" name="payment-method" value="${opt.value}" class="accounting-item accent-action-primary-bg" ${opt.value === selectedValue ? 'checked' : ''}>
                  <span>${opt.text}</span>
              </label>
              ${opt.details}
          </div>`,
        )
        .join('') +
      `
          <div class="mt-4 space-y-2 text-base" id="payment-info-container">
              <!-- æ”¯æ‰•æ–¹æ³•åˆ¥æƒ…å ±ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
          </div>`
    );
  };

  /**
   * äºˆç´„ãƒ»å±¥æ­´ã‚«ãƒ¼ãƒ‰ç”¨ã®æ–°ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚«ãƒ¼ãƒ‰æ§‹é€ ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * ä»•æ§˜: ä¸Šéƒ¨ã«æ•™å®¤æƒ…å ±ï¼ˆå·¦ï¼‰+ç·¨é›†ãƒœã‚¿ãƒ³ï¼ˆå³ï¼‰ã€ä¸­å¤®ã«åˆ¶ä½œãƒ¡ãƒ¢ã‚¨ãƒªã‚¢ã€ä¸‹éƒ¨ã«å½“æ—¥ã®ã¿ä¼šè¨ˆãƒœã‚¿ãƒ³
   * @param {object} config - ã‚«ãƒ¼ãƒ‰è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const createReservationCard = config => {
    const {
      type, // 'booking' | 'history'
      item,
      today,
      buttons = [],
    } = config;

    const isBooking = type === 'booking';
    const venueText = item.venue || '';
    const isPastOrToday = isBooking
      ? new Date(item.date).getTime() <= today.getTime()
      : true;
    const isToday =
      today && new Date(item.date).toDateString() === today.toDateString();

    // æ™‚åˆ»è¡¨ç¤ºã®ç”Ÿæˆ
    let timeText = '';
    if (item.startTime && item.endTime) {
      timeText = `${item.startTime} - ${item.endTime}`;
    }

    // æ—¥æ™‚è¡¨ç¤ºï¼ˆæ•™å®¤æƒ…å ±éƒ¨åˆ†ï¼‰
    const dateTimeDisplay = `${formatDate(item.date || '')}${timeText ? ` ${timeText}` : ''}`;
    const venueDisplay = `${item.classroom || ''}${venueText ? ` ${venueText}` : ''}`;

    let cardColorClass = 'reservation-card bg-ui-surface border border-ui-border';
    if (isBooking) {
      const cardColor = item.isWaiting
        ? DesignConfig.cards.state.waitlist
        : DesignConfig.cards.state.booked;
      cardColorClass = `reservation-card ${cardColor.card}`;
    } else if (type === 'history') {
      cardColorClass = `record-card ${DesignConfig.cards.state.history.card}`;
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ï¼ˆåˆå›ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡ï¼‰
    let statusBadges = '';
    if (isBooking) {
      if (item.firstLecture) {
        statusBadges += `<span class="inline-block bg-action-attention-bg text-action-attention-text text-xs font-bold px-2 py-1 rounded-full ml-2">åˆå›</span>`;
      }
      if (item.status === window.STATUS.WAITLISTED || item.isWaiting) {
        statusBadges += `<span class="inline-block bg-state-waitlist-bg text-state-waitlist-text text-xs font-bold px-2 py-1 rounded-full ml-2">â³ ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡</span>`;
      }
    }

    // ç·¨é›†/ç¢ºèªãƒœã‚¿ãƒ³ã®æŠ½å‡ºï¼ˆä¼šè¨ˆãƒœã‚¿ãƒ³ä»¥å¤–ï¼‰
    const editButtons = buttons.filter(
      btn => !btn.text.includes('ä¼šè¨ˆ') && !btn.text.includes('è¨˜éŒ²'),
    );
    const editButtonsHtml = editButtons
      .map(btn =>
        Components.createButton({
          action: btn.action,
          classroom: btn.classroom || item.classroom,
          reservationId: btn.reservationId || item.reservationId,
          date: btn.date || item.date,
          sheetName: btn.sheetName || item.sheetName,
          details: btn.details,
          text: btn.text,
          colorClass: btn.colorClass,
        }),
      )
      .join('');

    // ä¼šè¨ˆãƒœã‚¿ãƒ³ã®æŠ½å‡ºï¼ˆå½“æ—¥ã®ã¿è¡¨ç¤ºï¼‰
    const accountingButtons = buttons.filter(
      btn => btn.text.includes('ä¼šè¨ˆ') || btn.text.includes('è¨˜éŒ²'),
    );
    const showAccountingButtons = isToday && accountingButtons.length > 0;
    const accountingButtonsHtml = showAccountingButtons
      ? accountingButtons
          .map(btn =>
            Components.createButton({
              action: btn.action,
              classroom: btn.classroom || item.classroom,
              reservationId: btn.reservationId || item.reservationId,
              date: btn.date || item.date,
              sheetName: btn.sheetName || item.sheetName,
              details: btn.details,
              text: btn.text,
              colorClass: btn.colorClass,
            }),
          )
          .join('')
      : '';

    // åˆ¶ä½œãƒ¡ãƒ¢ã®å†…å®¹ï¼ˆå…ƒã®è¡¨ç¤ºæ–¹å¼ã«æˆ»ã™ï¼‰
    const memoContent =
      item.workInProgress != null && item.workInProgress !== ''
        ? item.workInProgress
        : `<span class="text-brand-muted">åˆ¶ä½œãƒ¡ãƒ¢</span>`;
    const memoDisplay = `<p class="text-base text-brand-text whitespace-pre-wrap break-words w-full leading-relaxed">${memoContent}</p>`;

    return `
        <div class="${cardColorClass || 'bg-ui-surface border border-ui-border'} p-3 rounded-lg flex flex-col space-y-3">
          <!-- æ•™å®¤æƒ…å ± -->
          <div class="flex-shrink-0">
            <div>
              <span class="text-brand-text font-bold text-base sm:text-xl">${formatDate(item.date || '')} </span>
              <span class="text-brand-text text-base time-display">${timeText || ''}</span>
            </div>
            <p class="text-brand-text font-bold text-base break-words">${item.classroom || ''} ${venueText || ''}</p>
            ${statusBadges || ''}
          </div>

          <!-- åˆ¶ä½œãƒ¡ãƒ¢ -->
          <div class="bg-ui-surface p-3 rounded-md w-full border border-ui-border">
            <div class="w-full min-h-[3rem] flex items-start">
              ${memoDisplay}
            </div>
          </div>

          <!-- ãƒœã‚¿ãƒ³é…ç½®ï¼ˆå…ƒã®é…ç½®ã«æˆ»ã™ï¼šç·¨é›†ãƒœã‚¿ãƒ³+å½“æ—¥ã®ã¿ä¼šè¨ˆãƒœã‚¿ãƒ³ï¼‰ -->
          ${editButtonsHtml || accountingButtonsHtml ? `<div class="flex flex-wrap justify-center sm:justify-end items-center gap-2 flex-shrink-0 mt-3">${editButtonsHtml}${showAccountingButtons ? accountingButtonsHtml : ''}</div>` : ''}
        </div>
      `;
  };

  /**
   * å‚åŠ è¨˜éŒ²ç·¨é›†ç”¨ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ä¸­èº«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {object} item - ç·¨é›†å¯¾è±¡ã®å±¥æ­´ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const buildMemoEditModal = item => {
    return `
          <p class="text-base ${DesignConfig.colors.textSubtle} mb-4">${formatDate(item.date)}  ${item.classroom}</p>
          <textarea id="memo-edit-textarea" class="${DesignConfig.inputs.textarea} h-32" placeholder="åˆ¶ä½œãƒ¡ãƒ¢ã‚’å…¥åŠ›â€¦">${item.workInProgress || ''}</textarea>
      `;
  };

  /**
   * æ™‚é–“åˆ¶æ•™å®¤ã®æˆæ¥­æ–™è¨ˆç®—UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {object} rule - æ–™é‡‘ãƒã‚¹ã‚¿ã‹ã‚‰å–å¾—ã—ãŸæ•™å®¤ãƒ«ãƒ¼ãƒ«
   * @param {object} reservationDetails - äºˆç´„å›ºæœ‰æƒ…å ±ï¼ˆé–‹å§‹æ™‚åˆ»ã€ãƒ¬ãƒ³ã‚¿ãƒ«ç­‰ï¼‰
   * @param {object} scheduleInfo - è¬›åº§å›ºæœ‰æƒ…å ±ï¼ˆæ•™å®¤å½¢å¼ã€é–‹è¬›æ™‚é–“ç­‰ï¼‰
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getTimeBasedTuitionHtml = (rule, reservationDetails, scheduleInfo) => {
    // è¬›åº§å›ºæœ‰æƒ…å ±ã‹ã‚‰æ™‚é–“è¨­å®šã‚’å–å¾—
    let classStart, classEnd;

    if (scheduleInfo && scheduleInfo.firstStart && scheduleInfo.firstEnd) {
      // æ—¥ç¨‹ãƒã‚¹ã‚¿ã‹ã‚‰æ™‚é–“ã‚’å–å¾—
      const startParts = scheduleInfo.firstStart.split(':');
      const endParts = scheduleInfo.firstEnd.split(':');
      classStart = parseInt(startParts[0] || '0');
      classEnd = parseInt(endParts[0] || '0');
    } else {
      return `<div class="text-ui-error-text p-4 bg-ui-error-bg rounded-lg">ã‚¨ãƒ©ãƒ¼: ã“ã®æ•™å®¤ã®è¬›åº§æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>`;
    }
    const endBuffer = 3;

    const breakOptions = [...Array(5).keys()]
      .map(
        i =>
          `<option value="${i * 30}" ${String(i * 30) === (reservationDetails.breakTime || '0') ? 'selected' : ''}>${i * 30}åˆ†</option>`,
      )
      .join('');

    const startTimeOptions = getTimeOptionsHtml(
      classStart,
      classEnd + endBuffer,
      30,
      reservationDetails[window.HEADERS?.RESERVATIONS?.START_TIME] ||
        reservationDetails.startTime,
    );
    const endTimeOptions = getTimeOptionsHtml(
      classStart,
      classEnd + endBuffer,
      30,
      reservationDetails[window.HEADERS?.RESERVATIONS?.END_TIME] ||
        reservationDetails.endTime,
    );

    const rentalChecked =
      reservationDetails.chiselRental ||
      reservationDetails['å½«åˆ»åˆ€ãƒ¬ãƒ³ã‚¿ãƒ«'] === true
        ? 'checked'
        : '';

    const discountRule = stateManager
      .getState()
      .accountingMaster.find(
        item => item[HEADERS.ACCOUNTING.ITEM_NAME] === C.items.DISCOUNT,
      );
    // å‰²å¼•ãƒ«ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã§ã‚‚ã€å¸¸ã«å‰²å¼•ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤º
    const discountHtml = `<div class="mt-4 pt-4 border-t border-gray-200">${getDiscountHtml({ é …ç›®å: C.items.DISCOUNT }, reservationDetails.discountApplied ? '1' : '0')}<p class="text-sm ${DesignConfig.colors.textSubtle} mt-2 text-left">åˆå›å‚åŠ è€…ã¨åŒæ™‚åˆ»ã«å‚åŠ ã®å ´åˆã€Â¥500å‰²å¼•</p></div>`;

    // åŸºæœ¬æˆæ¥­æ–™ã®è¡¨ç¤ºã‚’è¿½åŠ 
    const basicTuitionRule = stateManager
      .getState()
      .accountingMaster.find(
        item =>
          item[HEADERS.ACCOUNTING.ITEM_NAME] === C.items.MAIN_LECTURE &&
          item[HEADERS.ACCOUNTING.TARGET_CLASSROOM] &&
          item[HEADERS.ACCOUNTING.TARGET_CLASSROOM].includes(
            scheduleInfo.classroom || reservationDetails.classroom,
          ),
      );

    const basicTuitionDisplay = basicTuitionRule
      ? `<div class="mb-3 p-3 bg-blue-50 rounded border-l-4 border-blue-400">
             <div class="text-base text-blue-800">
               <span class="font-semibold">${C.items.MAIN_LECTURE}:</span> Â¥${basicTuitionRule[HEADERS.ACCOUNTING.UNIT_PRICE]?.toLocaleString() || 0} / 30åˆ†
             </div>
           </div>`
      : '';

    return `
          <div class="p-4 ${DesignConfig.cards.background} rounded-lg space-y-3">
              <h3 class="${DesignConfig.text.heading} mb-2">æˆæ¥­æ–™</h3>
              ${basicTuitionDisplay}
              <div class="grid grid-cols-3 gap-2 items-end">
                  ${Components.createSelect({
                    id: 'start-time',
                    name: 'startTime',
                    label: 'é–‹å§‹æ™‚åˆ»',
                    containerClass: 'col-span-1',
                    options: startTimeOptions,
                  })}
                  ${Components.createSelect({
                    id: 'end-time',
                    name: 'endTime',
                    label: 'çµ‚äº†æ™‚åˆ»',
                    containerClass: 'col-span-1',
                    options: endTimeOptions,
                  })}
                  ${Components.createSelect({
                    id: 'break-time',
                    name: 'breakTime',
                    label: 'ä¼‘æ†©æ™‚é–“',
                    containerClass: 'col-span-1',
                    options: breakOptions,
                  })}
              </div>
              <div id="calculated-hours" class="text-left text-base ${DesignConfig.colors.textSubtle} mt-2"></div>
              <div class="pt-3 mt-3 border-t border-gray-200">
                  <label class="flex items-center justify-between">
                      <span class="text-brand-text">${C.items.CHISEL_RENTAL}</span>
                      <input type="checkbox" name="chiselRental" data-item-type="${C.itemTypes.TUITION}" data-item-name="${C.items.CHISEL_RENTAL}" class="accounting-item h-5 w-5 rounded border-ui-border text-brand-text focus:ring-brand-text" ${rentalChecked}>
                  </label>
              </div>
              ${discountHtml}
              <div id="tuition-breakdown" class="mt-4 pt-4 border-t border-ui-border space-y-1 text-base ${DesignConfig.colors.textSubtle}"></div>
              <div class="text-right font-bold mt-2" id="tuition-subtotal">å°è¨ˆ: 0å††</div>
          </div>`;
  };

  // =================================================================
  // --- Main Application Views ---
  // -----------------------------------------------------------------
  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å„ç”»é¢ã®å®Œå…¨ãªHTMLæ§‹é€ ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ç¾¤ã€‚
  // =================================================================

  /**
   * ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getLoginView = () => {
    const phoneValue = stateManager.getState().loginPhone || '';
    return `
        <div class="text-center pt-8 pb-4">
            <h1 class="text-3xl font-bold text-brand-text tracking-tight">ãã¼ã‚Šã®<br>ã‚ˆã‚„ããƒ»ãã‚ã</h1>
            <h2 class="text-xl text-brand-subtle mt-2 mb-10">å·å´èª äºŒ æœ¨å½«ã‚Šæ•™å®¤</h2>
        </div>
        ${Components.createInput({ id: 'phone', label: 'é›»è©±ç•ªå·', type: 'tel', placeholder: '090 1234 5678', containerClass: DesignConfig.inputs.container, autocomplete: 'tel', isSrOnly: false, labelClass: `block text-brand-subtle text-sm text-center mb-1`, inputClass: 'text-center', inputmode: 'numeric', pattern: '[0-9]*', value: phoneValue })}
        <div class="mt-6 flex justify-center">
            <div class="${DesignConfig.inputs.container}">
                ${Components.createButton({ text: 'ãƒ­ã‚°ã‚¤ãƒ³ ã¾ãŸã¯ æ–°è¦ç™»éŒ²', action: 'login', colorClass: DesignConfig.colors.primary, widthClass: DesignConfig.buttons.full })}
            </div>
        </div>`;
  };

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæ–°è¦ç™»éŒ²ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†å…±é€šï¼‰
   * ã€çµ±åˆè¨­è¨ˆã€‘æ–°è¦ç™»éŒ²ã¨ç·¨é›†ã‚’1ã¤ã®é–¢æ•°ã§å‡¦ç†ã™ã‚‹åŠ¹ç‡çš„ãªå®Ÿè£…
   * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   * @param {string} config.mode - 'register'ï¼ˆæ–°è¦ç™»éŒ²ï¼‰ã¾ãŸã¯ 'edit'ï¼ˆç·¨é›†ï¼‰
   * @param {string} [config.phone] - é›»è©±ç•ªå·ï¼ˆæ–°è¦ç™»éŒ²æ™‚ã®ã¿ï¼‰
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getUserFormView = config => {
    const { mode, phone } = config;
    const isEdit = mode === 'edit';
    const u = stateManager.getState().currentUser || {};

    // å…¥åŠ›å€¤ã®ä¿æŒ: æ–°è¦ç™»éŒ²Step1ã§ã¯stateManager.getState().registrationDataã‚’å‚ç…§
    let regData = stateManager.getState().registrationData || {};
    const realNameValue = isEdit ? u.realName || '' : regData.realName || '';
    const nicknameValue = isEdit ? u.displayName || '' : regData.nickname || '';
    const phoneValue = isEdit
      ? stateManager.getState().registrationPhone || u.phone || ''
      : regData.phone || phone || '';

    // é›»è©±ç•ªå·è¡¨ç¤ºã®åˆ¤å®š
    const isPhoneInputNeeded =
      isEdit && (stateManager.getState().registrationPhone || !u.phone);

    // ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜æ–‡
    const title = isEdit ? 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†' : 'æ–°è¦ç™»éŒ²';
    const description = isEdit
      ? ''
      : '<p class="text-brand-subtle mb-6">ãŠåå‰ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>';

    // é›»è©±ç•ªå·ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    let phoneSection = '';
    if (!isEdit) {
      // æ–°è¦ç™»éŒ²æ™‚ï¼šé›»è©±ç•ªå·ã‚’è¡¨ç¤ºã®ã¿
      phoneSection = `
          <div class="mb-4">
              <label class="block text-brand-text text-base font-bold mb-2">é›»è©±ç•ªå·</label>
              <input type="tel" id="reg-phone" value="${phoneValue}" class="${DesignConfig.inputs.base}" placeholder="090 1234 5678" autocomplete="tel" inputmode="numeric" pattern="[0-9]*">
          </div>`;
    } else if (isPhoneInputNeeded) {
      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†æ™‚ï¼šé›»è©±ç•ªå·å…¥åŠ›ãŒå¿…è¦
      phoneSection = `
          <div class="mb-4">
              <label for="edit-phone" class="block text-brand-text text-base font-bold mb-2">é›»è©±ç•ªå·</label>
              <input type="tel" id="edit-phone" value="${phoneValue}"
                     class="${DesignConfig.inputs.base}" placeholder="090 1234 5678"
                     autocomplete="tel" inputmode="numeric" pattern="[0-9]*">
              <p class="text-sm text-brand-subtle mt-1">é›»è©±ç•ªå·ã‚’ç™»éŒ²ã™ã‚‹ã¨æ¬¡å›ã‹ã‚‰ã‚¹ãƒ ãƒ¼ã‚ºã«ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚</p>
          </div>`;
    } else {
      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†æ™‚ï¼šé›»è©±ç•ªå·è¡¨ç¤ºã®ã¿
      phoneSection = `
          <div class="mb-4">
              <label class="block text-brand-text text-base font-bold mb-2">é›»è©±ç•ªå·</label>
              <p class="font-semibold p-3 bg-ui-surface text-brand-text rounded-lg w-auto inline-block">${phoneValue}</p>
          </div>`;
    }

    // ãƒ¡ãƒ¼ãƒ«è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†æ™‚ã®ã¿ï¼‰
    const emailSection = isEdit
      ? `
          <div class="space-y-4">
            ${Components.createInput({
              id: 'edit-email',
              label: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
              type: 'email',
              value: u.email || '',
              placeholder: 'example@email.com',
              containerClass: '',
              autocomplete: 'email',
            })}
            <div class="p-3 bg-ui-surface rounded-md">
              <label class="flex items-center space-x-3">
                <input type="checkbox" id="edit-wants-email"
                       class="h-5 w-5 accent-action-primary-bg"
                       ${u.wantsEmail ? 'checked' : ''}>
                <span class="text-brand-text text-sm">ãƒ¡ãƒ¼ãƒ«é€£çµ¡ã‚’å¸Œæœ›ã—ã¾ã™ï¼ˆæ•™å®¤æ—¥ç¨‹ã€äºˆç´„å—ä»˜ã€ãªã©ï¼‰**åˆå›äºˆç´„æ™‚ã¯ã€ã™ã¹ã¦ã®æ–¹ã¸é€£çµ¡ã—ã¾ã™**</span>
              </label>
            </div>
          </div>
        `
      : '';

    // ãƒœã‚¿ãƒ³è¨­å®š
    const buttons = isEdit
      ? [
          {
            text: 'æˆ»ã‚‹',
            action: 'smartGoBack',
            colorClass: DesignConfig.colors.secondary,
          },
          {
            text: 'ã“ã®å†…å®¹ã§æ›´æ–°',
            action: 'saveProfile',
            colorClass: DesignConfig.colors.primary,
          },
        ]
      : [
          {
            text: 'æˆ»ã‚‹',
            action: 'goBackToLogin',
            colorClass: DesignConfig.colors.secondary,
          },
          {
            text: 'æ¬¡ã¸é€²ã‚€',
            action: 'goToStep2',
            colorClass: DesignConfig.colors.primary,
          },
        ];

    const nameIdPrefix = isEdit ? 'edit' : 'reg';

    return `
          <div class="max-w-md mx-auto">
              <h1 class="text-xl font-bold text-brand-text mb-4">${title}</h1>
              ${description}
              <div class="space-y-4">
                ${Components.createInput({
                  id: `${nameIdPrefix}-realname`,
                  label: 'ãŠåå‰ *å¿…é ˆé …ç›®*',
                  type: 'text',
                  required: true,
                  value: realNameValue,
                  containerClass: '',
                  autocomplete: 'name',
                })}
                ${Components.createInput({
                  id: `${nameIdPrefix}-nickname`,
                  label: 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆè¡¨ç¤ºåï¼‰',
                  caption: 'ä»–ã®ç”Ÿå¾’ã•ã‚“ã«ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã™',
                  type: 'text',
                  value: nicknameValue,
                  placeholder: 'ç©ºæ¬„ã®å ´åˆã¯ãŠåå‰',
                  containerClass: '',
                })}
                ${phoneSection}
                ${emailSection}
              </div>

              <div class="mt-8 grid grid-cols-2 gap-3">
              ${buttons
                .map(btn =>
                  Components.createButton({
                    text: btn.text,
                    action: btn.action,
                    colorClass: btn.colorClass,
                    widthClass: DesignConfig.buttons.full,
                  }),
                )
                .join('')}
              </div>
          </div>`;
  };

  /**
   * æ–°è¦ç™»éŒ²ç”»é¢ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {string} p - ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œæ™‚ã«å…¥åŠ›ã•ã‚ŒãŸé›»è©±ç•ªå·
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getRegisterView = p => getUserFormView({ mode: 'register', phone: p });

  /**
   * æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼ã®ã‚¹ãƒ†ãƒƒãƒ—2ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è©³ç´°ï¼‰
   * ã€è¨­è¨ˆæ–¹é‡ã€‘ã‚¹ãƒ†ãƒƒãƒ—å¼ç™»éŒ²ã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è² æ‹…ã‚’è»½æ¸›
   * @returns {string} ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è©³ç´°ãƒ•ã‚©ãƒ¼ãƒ ã®HTMLæ–‡å­—åˆ—
   */
  const getRegistrationStep2View = () => {
    const data = stateManager.getState().registrationData;
    const genderOptions = ['å¥³æ€§', 'ç”·æ€§', 'ãã®ä»–']
      .map(
        opt =>
          `<label class="flex items-center space-x-2"><input type="radio" name="gender" value="${opt}" ${data.gender === opt ? 'checked' : ''}><span class="text-brand-text">${opt}</span></label>`,
      )
      .join('');
    const handOptions = ['å³åˆ©ã', 'å·¦åˆ©ã', 'ä¸¡åˆ©ã']
      .map(
        opt =>
          `<label class="flex items-center space-x-2"><input type="radio" name="dominantHand" value="${opt}" ${data.dominantHand === opt ? 'checked' : ''}><span class="text-brand-text">${opt}</span></label>`,
      )
      .join('');
    const ageOptions = [
      '----',
      '10ä»£ï¼ˆ16æ­³ä»¥ä¸Šï¼‰',
      '20ä»£',
      '30ä»£',
      '40ä»£',
      '50ä»£',
      '60ä»£',
      '70ä»£',
      '80ä»£ä»¥ä¸Š',
      'ã²ã¿ã¤',
    ]
      .map(
        opt =>
          `<option value="${opt}" ${data.ageGroup === opt ? 'selected' : ''}>${opt}</option>`,
      )
      .join('');

    return `
      <div class="max-w-md mx-auto text-left">
        <h1 class="text-xl font-bold text-brand-text mb-4 text-center">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h1>
        <form id="step2-form" class="space-y-6">
          ${Components.createInput({ id: 'q-email', label: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *å¿…é ˆé …ç›®*', type: 'email', value: data.email || '', required: true })}
          <div class="p-3 bg-ui-surface rounded-md">
            <label class="flex items-center space-x-3">
              <input type="checkbox" id="q-wants-email" name="wantsEmail" class="h-5 w-5 accent-action-primary-bg" ${data.wantsEmail ? 'checked' : ''}>
              <span class="text-brand-text text-sm">ãƒ¡ãƒ¼ãƒ«é€£çµ¡ã‚’å¸Œæœ›ã—ã¾ã™ï¼ˆæ•™å®¤æ—¥ç¨‹ã€äºˆç´„å—ä»˜ã€ãªã©ï¼‰</span>
            </label>
          </div>
          ${Components.createSelect({ id: 'q-age-group', label: 'ãŠå¹´é ƒ', options: ageOptions })}
          <div><label class="block text-brand-text text-base font-bold mb-2">æ€§åˆ¥</label><div class="flex space-x-4">${genderOptions}</div></div>
          <div><label class="block text-brand-text text-base font-bold mb-2">åˆ©ãæ‰‹</label><div class="flex space-x-4">${handOptions}</div></div>
          ${Components.createInput({ id: 'q-address', label: 'ä½æ‰€ï¼ˆå¸‚åŒºç”ºæ‘ã¾ã§ã§OKï¼ï¼‰', type: 'text', value: data.address || '' })}
        </form>
        <div class="mt-8 grid grid-cols-2 gap-3">
          ${Components.createButton({ text: 'å‰ã«æˆ»ã‚‹', action: 'backToStep1', colorClass: DesignConfig.colors.secondary })}
          ${Components.createButton({ text: 'æ¬¡ã¸é€²ã‚€', action: 'goToStep3', colorClass: DesignConfig.colors.primary })}
        </div>
      </div>
    `;
  };

  /**
   * æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼ã®ã‚¹ãƒ†ãƒƒãƒ—3ï¼ˆæœ¨å½«ã‚Šé–¢é€£æƒ…å ±ï¼‰
   * ã€UXé…æ…®ã€‘å‹•çš„è¡¨ç¤ºåˆ¶å¾¡ã«ã‚ˆã‚Šã€çµŒé¨“è€…ã«ã¯è©³ç´°è³ªå•ã‚’è¡¨ç¤º
   * @returns {string} æœ¨å½«ã‚Šã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®HTMLæ–‡å­—åˆ—
   */
  const getRegistrationStep3View = () => {
    const data = stateManager.getState().registrationData;
    const experienceOptions = ['ã¯ã˜ã‚ã¦ï¼', 'ã¡ã‚‡ã£ã¨', 'ãã“ãã“', 'ã‹ãªã‚Šï¼']
      .map(
        opt =>
          `<label class="flex items-center space-x-2"><input type="radio" name="experience" value="${opt}" ${data.experience === opt ? 'checked' : ''}><span class="text-brand-text">${opt}</span></label>`,
      )
      .join('');

    return `
      <div class="max-w-md mx-auto text-left">
        <h1 class="text-xl font-bold text-brand-text mb-4 text-center">æœ¨å½«ã‚Šã«ã¤ã„ã¦</h1>
        <form id="step3-form" class="space-y-6">
          <div>
            <label class="block text-brand-text text-base font-bold mb-2">æœ¨å½«ã‚Šã®çµŒé¨“ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</label>
            <div class="space-y-2" id="experience-radio-group">${experienceOptions}</div>
          </div>
          <div id="past-work-container" class="${data.experience === 'ã¯ã˜ã‚ã¦ï¼' ? 'hidden' : ''}">
            ${Components.createTextArea({
              id: 'q-past-work',
              label: 'ã„ã¤é ƒã€ã©ã“ã§ã€ä½•ã‚’ä½œã‚Šã¾ã—ãŸã‹ï¼Ÿ',
              caption: 'ã ã„ãŸã„ã§OKï¼',
              value: data.pastWork || '',
            })}
          </div>
          ${Components.createTextArea({
            id: 'q-future-goal',
            label: 'å°†æ¥çš„ã«åˆ¶ä½œã—ãŸã„ã‚‚ã®ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
            caption: 'æ›–æ˜§ãªå†…å®¹ã§ã‚‚å¤§ä¸ˆå¤«ï¼',
            value: data.futureGoal || '',
          })}
        </form>
        <div class="mt-8 grid grid-cols-2 gap-3">
          ${Components.createButton({ text: 'å‰ã«æˆ»ã‚‹', action: 'backToStep2', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
          ${Components.createButton({ text: 'æ¬¡ã¸', action: 'proceedToStep4', colorClass: DesignConfig.colors.primary, widthClass: DesignConfig.buttons.full })}
        </div>
      </div>
    `;
  };

  /**
   * æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼ã®ã‚¹ãƒ†ãƒƒãƒ—4ï¼ˆã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼‰
   * ã€è¨­è¨ˆæ–¹é‡ã€‘æœ€çµ‚ã‚¹ãƒ†ãƒƒãƒ—ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‚åŠ æ„å‘ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’åé›†
   * @returns {string} ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®HTMLæ–‡å­—åˆ—
   */
  const getRegistrationStep4View = () => {
    const data = stateManager.getState().registrationData;
    const participationOptions = [
      'æ¯æœˆé€šã„ãŸã„ï¼',
      '2,3ãƒ¶æœˆã”ã¨ãã‚‰ã„ã§é€šã„ãŸã„ï¼',
      'ã“ã‚Œã‚‹ã¨ãã«ãŸã¾ã«é€šã„ãŸã„ï¼',
      '1å›ã‚„ã£ã¦ã¿ãŸã„ï¼',
      'é€šã„ãŸã„ãŒã‚€ãšã‹ã—ã„â€¦',
    ]
      .map(
        opt =>
          `<label class="flex items-center space-x-2 p-2 rounded hover:bg-ui-surface cursor-pointer">
              <input type="radio" name="futureParticipation" value="${opt}" ${data.futureParticipation === opt ? 'checked' : ''} class="text-action-primary-bg focus:ring-action-primary-bg">
              <span class="text-brand-text">${opt}</span>
            </label>`,
      )
      .join('');

    return `
      <div class="max-w-md mx-auto text-left">
        <h1 class="text-xl font-bold text-brand-text mb-4 text-center">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h1>
        <form id="step4-form" class="space-y-6">
          <div>
            <label class="block text-brand-text text-base font-bold mb-3">ä»Šå¾Œã®ã”å‚åŠ ã«ã¤ã„ã¦</label>
            <div class="space-y-2" id="participation-radio-group">${participationOptions}</div>
          </div>

          ${Components.createTextArea({
            id: 'q-trigger',
            label: 'ã“ã®æ•™å®¤ã‚’çŸ¥ã£ãŸãã£ã‹ã‘ã¯ï¼Ÿå‚åŠ ã—ã‚ˆã†ã¨æ€ã£ãŸãã£ã‹ã‘ã¯ï¼Ÿ',
            caption: '',
            value: data.trigger || '',
            rows: 4,
          })}

          ${Components.createTextArea({
            id: 'q-first-message',
            label: 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
            caption: 'ãã®ä»–ã‚³ãƒ¡ãƒ³ãƒˆãƒ»è¦æœ›ãƒ»æ„è¦‹ãªã©ã€ã‚ã‚Œã°ã©ã†ãã€œ',
            value: data.firstMessage || '',
            rows: 4,
          })}
        </form>
        <div class="mt-8 grid grid-cols-2 gap-3">
          ${Components.createButton({ text: 'å‰ã«æˆ»ã‚‹', action: 'backToStep3', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
          ${Components.createButton({ text: 'ç™»éŒ²ã—ã¦äºˆç´„ã¸é€²ã‚€', action: 'submitRegistration', colorClass: DesignConfig.colors.primary, widthClass: DesignConfig.buttons.full })}
        </div>
      </div>
    `;
  };

  /**
   * é›»è©±ç•ªå·æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢ãƒ»é¸æŠç”»é¢
   * ã€æ©Ÿèƒ½ã€‘NF-01 å¯¾å¿œï¼šåå‰æ¤œç´¢ã«ã‚ˆã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™ºè¦‹æ©Ÿèƒ½
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getUserSearchView = () => {
    const users = stateManager.getState().searchedUsers;
    // NF-01: æ¤œç´¢ãŒå®Ÿè¡Œã•ã‚Œã€çµæœãŒ0ä»¶ã®å ´åˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    const hasSearchedAndNoResults =
      stateManager.getState().searchAttempted && users.length === 0;

    return `
          <h1 class="text-xl font-bold text-brand-text mb-4">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æ¢ã™</h1>
          <p class="text-brand-subtle mb-6">ãŠåå‰ï¼ˆæœ¬åï¼‰ã¾ãŸã¯ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ã€ã‚ãªãŸã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚<br>
          <span class="text-sm text-brand-muted">ï¼ˆæ¼¢å­—ãŒç•°ãªã‚‹å ´åˆã‚„ã€å§“ã¨åã®é–“ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã§ã‚‚ã€ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¥ã‚Œãšã«ã€è‹—å­—ã ã‘ã§ã‚‚è©¦ã—ã¦ã¿ã¦ãã ã•ã„ï¼‰</span></p>

          <div class="${DesignConfig.inputs.container} mb-4">
              ${Components.createInput({
                id: 'nickname-search-input',
                label: 'ãŠåå‰ï¼ˆæœ¬åï¼‰ã¾ãŸã¯ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ', // ãƒ©ãƒ™ãƒ«ã‚’å¤‰æ›´
                type: 'text',
                placeholder: 'ãŠåå‰ã¾ãŸã¯ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ', // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å¤‰æ›´
                inputClass: 'text-center',
                autocomplete: 'off',
              })}
              <div class="mt-4 flex justify-center">
                  ${Components.createButton({
                    text: 'æ¤œç´¢',
                    action: 'searchUserByName',
                    colorClass: DesignConfig.colors.primary,
                    widthClass: DesignConfig.buttons.full,
                  })}
              </div>
          </div>

          <div class="mt-8 space-y-3">
              ${
                users.length > 0
                  ? `
                  <h2 class="text-lg font-bold ${DesignConfig.colors.text} text-center mb-2">è¦‹ã¤ã‹ã£ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h2>
                  ${users
                    .map(
                      user => `
                      <div class="${DesignConfig.cards.background} p-3 rounded-lg flex justify-between items-center">
                          <p class="text-base font-semibold">${user.realName}ï¼ˆ${user.nickname}ï¼‰</p> // æœ¬åã¨ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ä¸¡æ–¹è¡¨ç¤º
                          ${Components.createButton({
                            text: 'ã“ã‚Œã ï¼',
                            action: 'selectSearchedUser',
                            studentId: user.studentId,
                            realName: user.realName,
                            nickname: user.nickname,
                            colorClass:
                              'bg-state-success-bg text-state-success-text text-sm py-1 px-3 rounded active:bg-state-success-hover focus:bg-state-success-hover mobile-button',
                          })}
                      </div>
                  `,
                    )
                    .join('')}
              `
                  : hasSearchedAndNoResults
                    ? `
                  <p class="text-center ${DesignConfig.colors.textSubtle}">ä¸€è‡´ã™ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
              `
                    : ''
              }
          </div>

          <div class="mt-8 pt-4 border-t border-gray-200 flex flex-col space-y-3">
              <h2 class="text-lg font-bold ${DesignConfig.colors.text} text-center mb-2">è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ</h2>
              ${Components.createButton({
                text: 'è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„ã®ã§ã€æ–°è¦ç™»éŒ²ã™ã‚‹',
                action: 'goToRegisterFromUserSearch',
                colorClass: DesignConfig.colors.primary,
                widthClass: DesignConfig.buttons.full,
              })}
              ${Components.createButton({
                text: 'ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹',
                action: 'goBackToLogin',
                colorClass: DesignConfig.colors.secondary,
                widthClass: DesignConfig.buttons.full,
              })}
          </div>
      `;
  };

  /**
   * ãƒ›ãƒ¼ãƒ äºˆç´„ã‚«ãƒ¼ãƒ‰ã®ãƒœã‚¿ãƒ³é…åˆ—ã‚’ç”Ÿæˆã—ã¾ã™ï¼ˆæ–°ä»•æ§˜ï¼‰ã€‚
   * @param {object} booking - äºˆç´„ãƒ‡ãƒ¼ã‚¿
   * @returns {Array} ãƒœã‚¿ãƒ³è¨­å®šé…åˆ—
   */
  const _buildBookingButtons = booking => {
    const buttons = [];
    const isBookingToday = _isToday(booking.date);

    // ä¼šè¨ˆé–¢é€£ãƒœã‚¿ãƒ³ï¼ˆæ–°ä»•æ§˜ï¼‰
    if (booking.status === window.STATUS.CONFIRMED && isBookingToday) {
      // ã‚ˆã‚„ã ã‹ã¤ å½“æ—¥ â†’ ã€Œä¼šè¨ˆã€ãƒœã‚¿ãƒ³
      buttons.push({
        action: 'goToAccounting',
        text: 'ä¼šè¨ˆ',
        style: 'accounting',
      });
    }

    // ç¢ºèª/ç·¨é›†ãƒœã‚¿ãƒ³
    if (
      booking.status === window.STATUS.CONFIRMED ||
      booking.status === window.STATUS.WAITLISTED
    ) {
      // ã‚ˆã‚„ã â†’ ã€Œç¢ºèª/ç·¨é›†ã€ãƒœã‚¿ãƒ³
      buttons.push({
        action: 'goToEditReservation',
        text: 'ç¢ºèª/ç·¨é›†',
        style: 'edit',
      });
    }

    return buttons;
  };

  /**
   * ãƒ›ãƒ¼ãƒ å±¥æ­´ã‚«ãƒ¼ãƒ‰ã®ãƒœã‚¿ãƒ³é…åˆ—ã‚’ç”Ÿæˆã—ã¾ã™ï¼ˆæ–°ä»•æ§˜ï¼‰ã€‚
   * @param {object} historyItem - å±¥æ­´ãƒ‡ãƒ¼ã‚¿
   * @returns {Array} ãƒœã‚¿ãƒ³è¨­å®šé…åˆ—
   */
  const _buildHistoryButtons = historyItem => {
    const buttons = [];
    const isHistoryToday = _isToday(historyItem.date);

    // ä¼šè¨ˆé–¢é€£ãƒœã‚¿ãƒ³ï¼ˆæ–°ä»•æ§˜ï¼‰
    if (historyItem.status === window.STATUS.COMPLETED) {
      if (isHistoryToday) {
        // ãã‚ã ã‹ã¤ å½“æ—¥ â†’ ã€Œä¼šè¨ˆã‚’ä¿®æ­£ã€ãƒœã‚¿ãƒ³
        buttons.push({
          action: 'editAccountingRecord',
          text: 'ä¼šè¨ˆã‚’ä¿®æ­£',
          style: 'accounting',
        });
      } else {
        // ãã‚ã â†’ ã€Œä¼šè¨ˆè©³ç´°ã€ãƒœã‚¿ãƒ³
        buttons.push({
          action: 'showHistoryAccounting',
          details: historyItem.accountingDetails,
          text: 'ä¼šè¨ˆè©³ç´°',
          style: 'record',
        });
      }
    }

    // ãƒ¡ãƒ¢ç·¨é›†ãƒœã‚¿ãƒ³
    buttons.push({
      action: 'editHistoryMemo',
      text: window.stateManager.getState().constants?.messages?.EDIT || 'ç·¨é›†',
      style: 'edit-small',
    });

    return buttons;
  };

  /**
   * ãƒ¡ã‚¤ãƒ³ã®ãƒ›ãƒ¼ãƒ ç”»é¢ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * ã€æ”¹å–„ã€‘ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã«åˆ†é›¢ã—ã¦å¯èª­æ€§å‘ä¸Š
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getDashboardView = () => {
    // myReservationsã‹ã‚‰ç›´æ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦è¡¨ç¤ºï¼ˆã‚·ãƒ³ãƒ—ãƒ«åŒ–ï¼‰
    const state = stateManager.getState();
    const myReservations = state.myReservations || [];
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // äºˆç´„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã®ã‚«ãƒ¼ãƒ‰é…åˆ—ã‚’æ§‹ç¯‰ï¼šç¢ºå®šãƒ»å¾…æ©Ÿã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã¿è¡¨ç¤º
    const activeReservations = myReservations
      .filter(
        res =>
          res.status === window.STATUS.CONFIRMED ||
          res.status === window.STATUS.WAITLISTED,
      )
      .sort((a, b) => new Date(a.date) - new Date(b.date)); // æ—¥ä»˜é †ã‚½ãƒ¼ãƒˆ

    const bookingCards = activeReservations.map(b => {
      const buttons = _buildBookingButtons(b);
      return Components.listCard({
        type: 'booking',
        item: b,
        today: today,
        buttons: buttons,
      });
    });

    // äºˆç´„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆï¼ˆComponentsã«æ§‹é€ ç”Ÿæˆã‚’å§”ä»»ï¼‰
    const yourBookingsHtml = Components.dashboardSection({
      title: 'ã‚ˆã‚„ã',
      items: bookingCards,
      showNewButton: true,
      newAction: 'showClassroomModal',
    });

    // å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã®ã‚«ãƒ¼ãƒ‰é…åˆ—ã‚’æ§‹ç¯‰ï¼šå®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã¿è¡¨ç¤º
    let historyHtml = '';
    const completedReservations = myReservations
      .filter(res => res.status === window.STATUS.COMPLETED)
      .sort((a, b) => new Date(b.date) - new Date(a.date)); // æ–°ã—ã„é †ã‚½ãƒ¼ãƒˆ

    const recordsToShow = state.recordsToShow || 10;
    const completedRecords = completedReservations.slice(0, recordsToShow);

    if (completedRecords.length > 0) {
      // ã€Œãã‚ãã€ã¯ COMPLETED ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã¿è¡¨ç¤º
      const historyCards = completedRecords.map(h => {
        const buttons = _buildHistoryButtons(h);
        return Components.listCard({
          type: 'history',
          item: h,
          today: null, // å±¥æ­´ã§ã¯ä¸è¦
          buttons: buttons,
        });
      });

      const showMore = recordsToShow < completedReservations.length;

      // Componentsã«æ§‹é€ ç”Ÿæˆã‚’å§”ä»»
      historyHtml = Components.dashboardSection({
        title: 'ãã‚ã',
        items: historyCards,
        showMoreButton: showMore,
        moreAction: 'loadMoreHistory',
      });
    }

    return `
          <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-2">
              <h1 class="text-base sm:text-xl font-bold ${DesignConfig.colors.text} mr-4 mb-1 sm:mb-0">ã‚ˆã†ã“ã <span class="text-xl whitespace-nowrap">${stateManager.getState().currentUser.displayName} <span class="text-base">ã•ã‚“</span></span></h1>
              <button data-action="goToEditProfile" class="${DesignConfig.colors.info} self-end sm:self-auto text-sm text-action-secondary-text px-3 py-0.5 rounded-md active:bg-action-secondary-hover">Profile ç·¨é›†</button>
          </div>
          ${yourBookingsHtml}
          ${historyHtml}
      `;
  };

  /**
   * æ•™å®¤åã«å¿œã˜ãŸè‰²ã‚¯ãƒ©ã‚¹ã‚’å–å¾—ã—ã¾ã™
   * @param {string} classroomName - æ•™å®¤å
   * @returns {string} è‰²ã‚¯ãƒ©ã‚¹æ–‡å­—åˆ—
   */
  const getClassroomColorClass = classroomName => {
    if (classroomName.includes('æ±äº¬')) {
      return DesignConfig.classroomColors.tokyo.colorClass;
    } else if (classroomName.includes('æ²¼æ´¥')) {
      return DesignConfig.classroomColors.numazu.colorClass;
    } else if (classroomName.includes('ã¤ãã°')) {
      return DesignConfig.classroomColors.tsukuba.colorClass;
    } else {
      return DesignConfig.classroomColors.default.colorClass;
    }
  };

  /**
   * æ•™å®¤é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getClassroomSelectionModalContent = () => {
    const classrooms = Object.values(stateManager.getState().classrooms || {});

    if (!classrooms.length) {
      return `<div class="text-center"><p class="text-brand-subtle mb-4">ç¾åœ¨ã€äºˆç´„å¯èƒ½ãªæ•™å®¤ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p></div>`;
    }

    // æŒ‡å®šã•ã‚ŒãŸé †åºã§æ•™å®¤ã‚’ä¸¦ã¹æ›¿ãˆï¼ˆæ±äº¬ã€ã¤ãã°ã€æ²¼æ´¥ï¼‰
    const desiredOrder = ['æ±äº¬æ•™å®¤', 'ã¤ãã°æ•™å®¤', 'æ²¼æ´¥æ•™å®¤'];
    const sortedClassrooms = classrooms.sort((a, b) => {
      const indexA = desiredOrder.indexOf(a);
      const indexB = desiredOrder.indexOf(b);

      // æŒ‡å®šã•ã‚ŒãŸé †åºã«ãªã„æ•™å®¤ã¯æœ€å¾Œã«é…ç½®
      if (indexA === -1 && indexB === -1) return a.localeCompare(b);
      if (indexA === -1) return 1;
      if (indexB === -1) return -1;

      return indexA - indexB;
    });

    const classroomButtonsHtml = sortedClassrooms
      .map(classroomName => {
        const colorClass = getClassroomColorClass(classroomName);
        const fullButtonClass = `w-full h-16 text-center px-6 py-4 rounded-xl mobile-card touch-friendly flex items-center justify-center text-xl font-bold border-2 transition-all duration-200 hover:scale-105 hover:shadow-lg active:scale-95 ${colorClass}`;

        const buttonHtml = Components.button({
          action: 'selectClassroom',
          text: classroomName,
          style: 'none', // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç„¡åŠ¹åŒ–
          customClass: fullButtonClass,
          dataAttributes: {
            classroomName: classroomName,
            classroom: classroomName, // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨
          },
        });

        // ãƒ‡ãƒãƒƒã‚°ç”¨: ç”Ÿæˆã•ã‚ŒãŸHTMLã‚’ç¢ºèª
        if (!window.isProduction && typeof console !== 'undefined') {
          console.log(
            `ğŸ”˜ ${classroomName}ãƒœã‚¿ãƒ³HTML:`,
            buttonHtml.substring(0, 300),
          );
          console.log(`ğŸ”˜ ${classroomName}ã‚«ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹:`, colorClass);
        }

        return buttonHtml;
      })
      .join('');

    return `
        <div class="text-center mb-6">
          <p class="text-brand-subtle text-lg mb-2">æ•™å®¤ ã‚’ ãŠãˆã‚‰ã³ãã ã•ã„</p>
        </div>
        <div class="space-y-4">
          ${classroomButtonsHtml}
        </div>
      `;
  };

  /**
   * æ•™å®¤é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«å…¨ä½“ã®HTMLã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getClassroomSelectionModal = () => {
    return Components.modal({
      id: 'classroom-selection-modal',
      title: '',
      content: getClassroomSelectionModalContent(),
      maxWidth: 'max-w-md', // ã‚ˆã‚Šå¤§ããªã‚µã‚¤ã‚ºã«å¤‰æ›´
    });
  };

  /**
   * ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ç”»é¢ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getEditProfileView = () => getUserFormView({ mode: 'edit' });

  /**
   * äºˆç´„ã‚¹ãƒ­ãƒƒãƒˆã®ãƒªã‚¹ãƒˆã‹ã‚‰HTMLã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * ã“ã®é–¢æ•°ã¯ getBookingView ã¨ getCompleteView ã§å…±æœ‰ã•ã‚Œã¾ã™ã€‚
   * @param {Array<object>} slots - è¡¨ç¤ºã™ã‚‹äºˆç´„ã‚¹ãƒ­ãƒƒãƒˆã®é…åˆ—
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const renderBookingSlots = slots => {
    if (!slots || slots.length === 0) {
      return '';
    }

    // å—ã‘å–ã£ãŸslotsã‚’æœˆåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const slotsByMonth = slots.reduce((acc, slot) => {
      const month = new Date(slot.date).getMonth() + 1;
      if (!acc[month]) acc[month] = [];
      acc[month].push(slot);
      return acc;
    }, {});

    return Object.keys(slotsByMonth)
      .sort((a, b) => a - b)
      .map(month => {
        const monthHeader = `<h4 class="text-lg font-medium ${DesignConfig.colors.textSubtle} mt-4 mb-2 text-center">${month}æœˆ</h4>`;

        const slotsHtml = slotsByMonth[month]
          .map(sl => {
            const state = stateManager.getState();
            const iB = (state.myReservations || []).some(
              b => b.date === sl.date && b.classroom === sl.classroom,
            );
            let cC, sB, act;
            const tag = iB ? 'div' : 'button';

            // åˆå›è€…ãƒ»çµŒé¨“è€…åˆ¥ã®è¡¨ç¤ºåˆ¶å¾¡
            const isFirstTimeBooking = stateManager.getState().isFirstTimeBooking;
            let statusText;

            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
            if (!window.isProduction && isFirstTimeBooking) {
              console.log('ğŸ” åˆå›è€…ã‚¹ãƒ­ãƒƒãƒˆæƒ…å ±:', {
                date: sl.date,
                classroom: sl.classroom,
                firstLectureSlots: sl.firstLectureSlots,
                isFirstTimeBooking,
              });
            }

            if (isFirstTimeBooking) {
              // åˆå›è€…ï¼ˆã¯ã˜ã‚ã¦ã®æ–¹ï¼‰ã®å ´åˆ
              if (sl.beginnerCapacity > 0) {
                // åˆå›è€…ã®å®šå“¡ãŒ1ä»¥ä¸Šã®æ—¥ç¨‹ï¼šåˆå›è€…æ ã«åŸºã¥ãç©ºå¸­æƒ…å ±ã‚’æç¤º
                statusText = `åˆå›è€… ç©ºã ${sl.firstLectureSlots}`;
              } else {
                // åˆå›è€…ã®å®šå“¡ãŒ0ã®æ—¥ç¨‹ï¼šã€ŒçµŒé¨“è€…ã®ã¿ã€ã¨ã—ã¦è¡¨ç¤º
                statusText = 'çµŒé¨“è€…ã®ã¿';
              }
            } else {
              // çµŒé¨“è€…ã®å ´åˆï¼šå…¨ä½“ï¼ˆæœ¬è¬›åº§ï¼‰ã®å‚åŠ è€…æ•°ã«åŸºã¥ãè¡¨ç¤º
              if (
                typeof sl.morningSlots !== 'undefined' &&
                typeof sl.afternoonSlots !== 'undefined'
              ) {
                // ï¼’éƒ¨åˆ¶ã®å ´åˆã®ä¾‹ã€Œç©ºã åˆå‰3 åˆå¾Œ 4ã€
                const morningLabel =
                  stateManager.getState().constants?.sessions?.MORNING || 'åˆå‰';
                const afternoonLabel =
                  stateManager.getState().constants?.sessions?.AFTERNOON ||
                  'åˆå¾Œ';
                statusText = `ç©ºã ${morningLabel}${sl.morningSlots} ${afternoonLabel}${sl.afternoonSlots}`;
              } else if (typeof sl.availableSlots !== 'undefined') {
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¶ã€å…¨æ—¥åˆ¶ã®å ´åˆã®ä¾‹ã€Œç©ºã 3ã€
                statusText = `ç©ºã ${sl.availableSlots}`;
              } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                statusText = 'ç©ºãçŠ¶æ³ä¸æ˜';
              }
              // çµŒé¨“è€…ã«ã¯åˆå›è€…ã®ç©ºãæƒ…å ±ã¯æç¤ºã—ãªã„ï¼ˆæ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
            }

            if (iB) {
              // ã€ä¿®æ­£ã€‘äºˆç´„æ¸ˆã¿ãƒ»è¨˜éŒ²æ¸ˆã¿ã®å ´åˆï¼ˆçµ±ä¸€æ¤œç´¢é–¢æ•°ã‚’ä½¿ç”¨ï¼‰
              const reservationData = findReservationByDateAndClassroom(
                sl.date,
                sl.classroom,
              );

              console.log(
                `ğŸ” Slotæ¤œç´¢çµæœ - ${sl.date} ${sl.classroom}:`,
                reservationData
                  ? {
                      status: reservationData.status,
                      type: reservationData.type,
                    }
                  : 'ãªã—',
              );

              if (
                reservationData &&
                reservationData.status === window.STATUS.COMPLETED
              ) {
                // å®Œäº†æ¸ˆã¿ã®è¨˜éŒ²ã®å ´åˆ
                cC = `${DesignConfig.cards.base} ${DesignConfig.cards.state.booked.card}`;
                sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.booked.text}">å—è¬›æ¸ˆã¿</span>`;
                act = '';
              } else if (
                reservationData &&
                reservationData.status === window.STATUS.WAITLISTED
              ) {
                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡ã®å ´åˆ
                cC = `${DesignConfig.cards.base} ${DesignConfig.cards.state.waitlist.card}`;
                sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.waitlist.text}">ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡ ç™»éŒ²æ¸ˆ</span>`;
                act = '';
              } else {
                // ç¢ºå®šäºˆç´„ã®å ´åˆ
                cC = `${DesignConfig.cards.base} ${DesignConfig.cards.state.booked.card}`;
                sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.booked.text}">äºˆç´„æ¸ˆã¿</span>`;
                act = '';
              }
            } else {
              // åˆå›è€…ãƒ»çµŒé¨“è€…åˆ¥ã®æº€å¸­åˆ¤å®šã¨UIçŠ¶æ…‹æ±ºå®š
              let isSlotFull = false;
              let canBook = true;

              if (isFirstTimeBooking) {
                // åˆå›è€…ã®å ´åˆï¼šåˆå›è€…æ ã«åŸºã¥ãåˆ¤å®š
                if (sl.beginnerCapacity <= 0) {
                  // åˆå›è¬›ç¿’æ ãŒ0ã®å ´åˆã¯ã€ŒçµŒé¨“è€…ã®ã¿ã€ã§ã‚¯ãƒªãƒƒã‚¯ä¸å¯
                  canBook = false;
                }
                // åˆå›è¬›ç¿’æ ãŒæº€å¸­ã®å ´åˆã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡
                isSlotFull = sl.firstLectureIsFull;
              } else {
                // çµŒé¨“è€…ã®å ´åˆï¼šå…¨ä½“æ ã«åŸºã¥ãåˆ¤å®š
                isSlotFull = sl.isFull;
              }

              if (!canBook) {
                // åˆå›è€…ã§åˆå›è¬›ç¿’æ ãŒ0ã®å ´åˆï¼ˆçµŒé¨“è€…ã®ã¿ï¼‰ï¼šã‚¯ãƒªãƒƒã‚¯ä¸å¯
                cC = `${DesignConfig.cards.base} ${DesignConfig.cards.state.waitlist.card} opacity-50`;
                sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.waitlist.text}">${statusText}</span>`;
                act = '';
              } else if (isSlotFull) {
                // æº€å¸­ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡ï¼‰ã®å ´åˆ
                cC = `${DesignConfig.cards.base} ${DesignConfig.cards.state.waitlist.card}`;
                sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.waitlist.text}">æº€å¸­ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡ç”³è¾¼ã¿ï¼‰</span>`;
                act = `data-action="bookSlot" data-classroom="${sl.classroom}" data-date="${sl.date}"`;
              } else {
                // äºˆç´„å¯èƒ½ãªå ´åˆ
                cC = `${DesignConfig.cards.base} ${DesignConfig.cards.state.available.card}`;
                sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.available.text}">${statusText}</span>`;
                act = `data-action="bookSlot" data-classroom="${sl.classroom}" data-date="${sl.date}"`;
              }
            }

            const venueDisplay = sl.venue ? ` ${sl.venue}` : '';
            const text = `<div class="flex justify-between items-center w-full"><span class="${DesignConfig.colors.text}">${formatDate(sl.date)}${venueDisplay}</span>${sB}</div>`;

            // getBookingViewã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€buttonã¨divã‚’ä½¿ã„åˆ†ã‘ã‚‹
            return `<${tag} ${act} class="${cC}">${text}</${tag}>`;
          })
          .join('');

        return monthHeader + slotsHtml;
      })
      .join('');
  };

  /**
   * ç‰¹å®šã®æ•™å®¤ã®äºˆç´„æ ä¸€è¦§ç”»é¢ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {string} classroom - æ•™å®¤å
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getBookingView = classroom => {
    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§è¨ˆç®—æ¸ˆã¿ã®ç©ºãæƒ…å ±ã‚’ç›´æ¥ä½¿ç”¨
    const relevantSlots = stateManager.getState().slots
      ? stateManager.getState().slots.filter(slot => slot.classroom === classroom)
      : [];

    const bookingSlotsHtml = renderBookingSlots(relevantSlots);

    if (!bookingSlotsHtml) {
      return `
          <div class="max-w-md mx-auto">
              <h1 class="text-xl font-bold ${DesignConfig.colors.text} mb-2">${classroom}</h1>
              <p class="${DesignConfig.colors.textSubtle} mb-6">ç¾åœ¨ã€äºˆç´„å¯èƒ½ãªæ—¥ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
              <div class="mt-6">
                  ${Components.createButton({ text: 'ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹', action: 'goBackToDashboard', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
              </div>
          </div>`;
    } else {
      return `
          <div class="max-w-md mx-auto">
              <h1 class="text-xl font-bold ${DesignConfig.colors.text} mb-4">${classroom}</h1>
              <div class="${DesignConfig.cards.container}">${bookingSlotsHtml}</div>
              <div class="mt-6">
                  ${Components.createButton({ text: 'ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹', action: 'goBackToDashboard', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
              </div>
          </div>`;
    }
  };

  /**
   * äºˆç´„ã®è©³ç´°å…¥åŠ›ãƒ»ç·¨é›†ç”»é¢ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {string} mode - 'new' ã¾ãŸã¯ 'edit'
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getReservationFormView = (mode = 'new') => {
    const isEdit = mode === 'edit';

    // --- 1. ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ ---
    // ç·¨é›†æ™‚ã¯ editingReservationDetails ã‹ã‚‰ã€æ–°è¦ä½œæˆæ™‚ã¯ selectedSlot ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const sourceData = isEdit
      ? stateManager.getState().editingReservationDetails
      : stateManager.getState().selectedSlot;
    if (!sourceData) return 'ã‚¨ãƒ©ãƒ¼: äºˆç´„æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';

    const {
      classroom,
      date,
      venue,
      isWaiting,
      firstLecture,
      chiselRental,
      workInProgress,
      materialInfo,
      order,
      messageToTeacher,
    } = sourceData;

    // æ™‚é–“æƒ…å ±ã¯çµ±åˆå®šæ•°ã‚’ä½¿ç”¨ã—ã¦å–å¾—
    const startTime =
      sourceData[window.HEADERS?.RESERVATIONS?.START_TIME] ||
      sourceData.startTime;
    const endTime =
      sourceData[window.HEADERS?.RESERVATIONS?.END_TIME] || sourceData.endTime;
    const {
      currentUser,
      accountingMaster: master,
      isFirstTimeBooking,
    } = window.stateManager.getState();

    // æ—¥ç¨‹ãƒã‚¹ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ•™å®¤å½¢å¼åˆ¤å®šã«å¤‰æ›´
    const isTimeBased = isTimeBasedClassroom(sourceData);

    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
    if (!window.isProduction) {
      console.log('ğŸ” getReservationFormView ãƒ‡ãƒãƒƒã‚°æƒ…å ±:', {
        mode,
        isEdit,
        sourceData: sourceData
          ? {
              classroom: sourceData.classroom,
              date: sourceData.date,
              classroomType: sourceData.classroomType,
              firstStart: sourceData.firstStart,
              firstEnd: sourceData.firstEnd,
            }
          : null,
        isTimeBased,
        scheduleInfoExists: !!(sourceData?.firstStart && sourceData?.firstEnd),
      });
    }

    // æ–°è¦ä½œæˆæ™‚ã®ã¿åˆ©ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿
    const {
      availableSlots,
      morningSlots,
      afternoonSlots,
      firstLectureSlots,
      isFull,
      firstLectureIsFull,
    } = stateManager.getState().selectedSlot || {};

    // --- 2. ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸè¨­å®š ---
    const title = isEdit
      ? 'äºˆç´„å†…å®¹ã®ç·¨é›†'
      : isFull || (isFirstTimeBooking && firstLectureIsFull)
        ? 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡ç”³è¾¼ã¿'
        : 'äºˆç´„è©³ç´°ã®å…¥åŠ›';
    const submitAction = isEdit ? 'updateReservation' : 'confirmBooking';
    const submitButtonText = isEdit
      ? 'ã“ã®å†…å®¹ã§æ›´æ–°ã™ã‚‹'
      : isFull
        ? 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡ã§ç™»éŒ²ã™ã‚‹'
        : 'ã“ã®å†…å®¹ã§äºˆç´„ã™ã‚‹';

    // --- 3. UIç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
    /**
     * äºˆç´„çŠ¶æ³ã®è¡¨ç¤ºã‚’ç”Ÿæˆã—ã¾ã™ã€‚
     */
    const _renderStatusHtml = () => {
      if (isEdit) {
        return sourceData.isWaiting ? 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡' : 'äºˆç´„æ¸ˆã¿';
      }

      if (isFirstTimeBooking) {
        if (firstLectureIsFull) {
          return 'åˆå›è€…æ  æº€å¸­ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡ç”³è¾¼ã¿ï¼‰';
        }
        return `åˆå›è€…æ  ç©ºã ${firstLectureSlots}`;
      }

      if (isFull) return 'æº€å¸­ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡ç”³è¾¼ã¿ï¼‰';

      if (typeof morningSlots !== 'undefined') {
        const morningLabel =
          stateManager.getState().constants?.sessions?.MORNING || 'åˆå‰';
        const afternoonLabel =
          stateManager.getState().constants?.sessions?.AFTERNOON || 'åˆå¾Œ';
        return `${morningLabel}ç©ºã ${morningSlots} | ${afternoonLabel}ç©ºã ${afternoonSlots}`;
      }

      return `ç©ºã ${availableSlots}`;
    };

    /**
     * æˆæ¥­æ–™è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
     */
    const _renderTuitionDisplaySection = () => {
      // æ•™å®¤å½¢å¼ã®åˆ¤å®š
      if (isTimeBased) {
        // æ™‚é–“åˆ¶ã®å ´åˆï¼šåŸºæœ¬æˆæ¥­æ–™ã‚’è¡¨ç¤º
        const basicTuitionRule = master.find(
          item =>
            item[HEADERS.ACCOUNTING.ITEM_NAME] === C.items.MAIN_LECTURE &&
            item[HEADERS.ACCOUNTING.TARGET_CLASSROOM] &&
            item[HEADERS.ACCOUNTING.TARGET_CLASSROOM].includes(classroom),
        );

        if (basicTuitionRule) {
          const price = basicTuitionRule[HEADERS.ACCOUNTING.UNIT_PRICE] || 0;
          return `
              <div class="mt-4 pt-4 border-t">
                <h4 class="font-bold ${DesignConfig.colors.text} mb-2">æˆæ¥­æ–™</h4>
                <div class="mb-3 p-3 bg-blue-50 rounded border-l-4 border-blue-400">
                  <div class="text-base text-blue-800">
                    <span class="font-semibold">${C.items.MAIN_LECTURE}:</span> Â¥${price.toLocaleString()} / 30åˆ†
                  </div>
                </div>
              </div>`;
        }
      } else {
        // å›ºå®šåˆ¶ã®å ´åˆï¼šåˆå›æˆæ¥­æ–™ã¾ãŸã¯åŸºæœ¬æˆæ¥­æ–™ã‚’è¡¨ç¤º
        const targetItemName = isFirstTimeBooking
          ? C.items.FIRST_LECTURE
          : C.items.MAIN_LECTURE;
        const tuitionItem = master.find(
          item =>
            item[HEADERS.ACCOUNTING.TYPE] === C.itemTypes.TUITION &&
            item[HEADERS.ACCOUNTING.ITEM_NAME] === targetItemName &&
            (item[HEADERS.ACCOUNTING.TARGET_CLASSROOM] === 'å…±é€š' ||
              item[HEADERS.ACCOUNTING.TARGET_CLASSROOM]?.includes(classroom)),
        );

        if (tuitionItem) {
          const price = tuitionItem[HEADERS.ACCOUNTING.UNIT_PRICE] || 0;
          const bgColor = isFirstTimeBooking
            ? 'bg-green-50 border-green-400'
            : 'bg-blue-50 border-blue-400';
          const textColor = isFirstTimeBooking
            ? 'text-green-800'
            : 'text-blue-800';
          const label = targetItemName;

          return `
              <div class="mt-4 pt-4 border-t">
                <h4 class="font-bold ${DesignConfig.colors.text} mb-2">æˆæ¥­æ–™</h4>
                <div class="mb-3 p-3 ${bgColor} rounded border-l-4">
                  <div class="text-base ${textColor}">
                    <span class="font-semibold">${label}:</span> Â¥${price.toLocaleString()}
                  </div>
                </div>
              </div>`;
        }
      }
      return '';
    };

    /**
     * äºˆç´„æ™‚é–“é¸æŠã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
     */
    const _renderTimeOptionsSection = () => {
      // æ™‚é–“åˆ¶ã®æ•™å®¤ã®å ´åˆ
      if (isTimeBased) {
        const times = getClassroomTimesFromSchedule(sourceData);
        if (!times || !times.firstStart || !times.firstEnd) {
          return `<div class="text-ui-error-text p-4 bg-ui-error-bg rounded-lg">ã‚¨ãƒ©ãƒ¼: ã“ã®æ•™å®¤ã®æ™‚é–“è¨­å®šãŒä¸æ­£ã§ã™</div>`;
        }

        const startParts = times.firstStart.split(':');
        const endParts =
          !times.secondStart || !times.secondEnd
            ? times.firstEnd.split(':') // 1éƒ¨åˆ¶ã®å ´åˆ
            : times.secondEnd.split(':'); // 2éƒ¨åˆ¶ã®å ´åˆ
        const classStartHour = parseInt(startParts[0] || '0');
        const classEndHour = parseInt(endParts[0] || '0');
        const classEndMinutes = parseInt(endParts[1] || '0');

        // åˆå›è€…ã®å ´åˆã¯é–‹å§‹æ™‚åˆ»ã‚’å›ºå®šï¼ˆæ—¥ç¨‹ãƒã‚¹ã‚¿ã®BEGINNER_STARTé …ç›®ã‚’ä½¿ç”¨ï¼‰
        let fixedStartTime = startTime;
        let isTimeFixed = false;
        if (isFirstTimeBooking && sourceData.beginnerStart) {
          fixedStartTime = sourceData.beginnerStart;
          isTimeFixed = true;
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
        if (!window.isProduction && isFirstTimeBooking) {
          console.log('ğŸ” åˆå›è€…ç”¨æ™‚åˆ»è¨­å®š:', {
            isFirstTimeBooking,
            isEdit,
            firstStart: times.firstStart,
            secondStart: times.secondStart,
            beginnerStart: sourceData.beginnerStart,
            fixedStartTime,
            isTimeFixed,
          });
        }

        // åˆå›è€…ã®å ´åˆã¯å›ºå®šæ™‚åˆ»ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã¿ã€çµŒé¨“è€…ã¯é€šå¸¸ã®é¸æŠè‚¢
        let startTimeOptions;
        if (isTimeFixed) {
          // åˆå›è€…ï¼šå›ºå®šæ™‚åˆ»ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã¿
          startTimeOptions = `
              <option value="${fixedStartTime}"'selected'>
                ${fixedStartTime}
              </option>`;
        } else {
          // çµŒé¨“è€…ï¼šé€šå¸¸ã®é¸æŠè‚¢
          startTimeOptions = getTimeOptionsHtml(
            classStartHour,
            classEndHour,
            C.frontendUi.TIME_SETTINGS.STEP_MINUTES,
            startTime,
          );
        }
        let endTimeOptions = getTimeOptionsHtml(
          classStartHour,
          classEndHour,
          C.frontendUi.TIME_SETTINGS.STEP_MINUTES,
          endTime,
        );
        if (classEndMinutes > 0) {
          const finalEndTime = `${String(classEndHour).padStart(2, '0')}:${String(classEndMinutes).padStart(2, '0')}`;
          endTimeOptions += `<option value="${finalEndTime}">${finalEndTime}</option>`;
        }

        const discountRule = master.find(
          item =>
            item[HEADERS.ACCOUNTING.ITEM_NAME] === C.items.DISCOUNT &&
            item[HEADERS.ACCOUNTING.TARGET_CLASSROOM] &&
            item[HEADERS.ACCOUNTING.TARGET_CLASSROOM].includes(classroom),
        );
        let discountHtml = '';
        if (discountRule && !isFirstTimeBooking) {
          discountHtml = `<p class="${DesignConfig.text.caption}">${discountRule[HEADERS.ACCOUNTING.ITEM_NAME]}: åˆå›å‚åŠ è€…ã¨åŒæ™‚åˆ»ã«å‚åŠ ã®å ´åˆã€Â¥500å‰²å¼•</p>`;
        }

        // åˆå›è€…ã®å ´åˆã®é–‹å§‹æ™‚åˆ»å›ºå®šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const timeFixedMessage = isTimeFixed
          ? `<p class="${DesignConfig.text.caption} mb-2">åˆå›ã®æ–¹ã¯ ${fixedStartTime} ã‚ˆã‚Šé–‹å§‹ã§ã™ã€‚æ˜¼ã‚’ã¾ãŸãå ´åˆã¯ã€1æ™‚é–“ä¼‘æ†©ã‚’æŒŸã¿ã¾ã™</p>`
          : '';

        return `
            <div class="mt-4 pt-4 border-t">
              <h4 class="font-bold ${DesignConfig.colors.text} mb-2">äºˆç´„æ™‚é–“</h4>
              ${timeFixedMessage}
              <div class="grid grid-cols-2 gap-4 mb-2">
                ${Components.select({
                  id: 'res-start-time',
                  label: 'é–‹å§‹äºˆå®š',
                  options: startTimeOptions,
                })}
                ${Components.select({
                  id: 'res-end-time',
                  label: 'çµ‚äº†äºˆå®š',
                  options: endTimeOptions,
                })}
              </div>
              ${discountHtml}
            </div>`;
      }
      return ''; // ä¸Šè¨˜ä»¥å¤–ã®å ´åˆã¯æ™‚é–“é¸æŠãªã—
    };

    /**
     * äºˆç´„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
     */
    const _renderBookingOptionsSection = () => {
      let optionsHtml = '';

      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯å®Ÿéš›ã®äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã€æ–°è¦ä½œæˆæ™‚ã¯åˆå›å—è¬›åˆ¤å®šã‚’ä½¿ç”¨
      const firstLectureChecked = isEdit
        ? firstLecture
          ? 'checked'
          : ''
        : firstLecture || isFirstTimeBooking
          ? 'checked'
          : '';
      const firstLectureDisabled = isEdit
        ? ''
        : isFirstTimeBooking
          ? 'disabled'
          : '';
      const chiselRentalChecked = chiselRental ? 'checked' : '';

      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
      if (!window.isProduction) {
        console.log('ğŸ” ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ - æ•™å®¤ã‚¿ã‚¤ãƒ—åˆ¤å®š:', {
          classroomType: sourceData.classroomType,
          expectedSessionBased: C.classroomTypes?.SESSION_BASED,
          isMatch: sourceData.classroomType === C.classroomTypes?.SESSION_BASED,
          constantsAvailable: !!C.classroomTypes,
          allConstants: Object.keys(C),
        });
      }

      if (sourceData.classroomType === C.classroomTypes.SESSION_BASED) {
        const firstLectureLabel = isFirstTimeBooking
          ? `<span>${C.items.FIRST_LECTURE}</span><span class="${DesignConfig.text.caption} ml-2"></span>`
          : `<span>${C.items.FIRST_LECTURE}</span>`;
        optionsHtml += `<label class="flex items-center space-x-2"><input type="checkbox" id="option-first-lecture" ${firstLectureChecked} ${firstLectureDisabled}>${firstLectureLabel}</label>`;
      }
      optionsHtml += `<div class="mt-2"><label class="flex items-center space-x-2"><input type="checkbox" id="option-rental" ${chiselRentalChecked}><span>${C.items.CHISEL_RENTAL} 1å› Â¥500</span></label></div>`;

      // å‰²å¼•ã®èª¬æ˜ã‚’è¿½åŠ 
      optionsHtml += `<div class="mt-3 pt-2 border-t border-ui-border-light"><p class="${DesignConfig.text.caption}">${C.items.DISCOUNT}: åˆå›å‚åŠ è€…ã¨åŒæ™‚åˆ»ã«å‚åŠ ã®å ´åˆã€Â¥500å‰²å¼•</p></div>`;

      return `
          <div class="mt-4 pt-4 border-t">
            <h4 class="font-bold text-left mb-2">ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h4>
            ${optionsHtml}
          </div>`;
    };

    /**
     * è©³ç´°å…¥åŠ›æ¬„ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
     * è³¼å…¥å¸Œæœ›æ¬„ã‚’æŠ˜ã‚Šç•³ã¿ç‰©è²©ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼‹è‡ªç”±è¨˜å…¥æ¬„ã«å¤‰æ›´
     */
    const _renderDetailsInputSection = () => {
      // ç‰©è²©ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆæŠ˜ã‚Šç•³ã¿ï¼‰
      const salesChecklistHtml =
        typeof buildSalesChecklist === 'function'
          ? buildSalesChecklist(stateManager.getState().accountingMaster)
          : '';

      return `
          <div class="mt-4 pt-4 border-t space-y-4">
            ${Components.createTextArea({
              id: 'wip-input',
              label:
                isFirstTimeBooking && !isEdit
                  ? 'ä»Šå›ã¤ãã‚ŠãŸã„ã‚‚ã®/ã‚„ã‚ŠãŸã„ã“ã¨'
                  : 'ã¤ãã‚ŠãŸã„ã‚‚ã®/ã‚„ã‚ŠãŸã„ã“ã¨/ä½œæ¥­äºˆå®š',
              caption:
                isFirstTimeBooking && !isEdit
                  ? 'æœ€åˆã«ä½œã‚‹ã€Œã ã‚‹ã¾ã€ã®æœ¨å½«ã‚Šä»¥å¤–ã«ã€ä½œã‚ŠãŸã„ã‚‚ã®ãŒã‚ã‚‹æ–¹ã¯ã”è¨˜å…¥ãã ã•ã„ï¼ˆä»®ã§ã‚‚OK!ï¼‰ã€‚æ•™å®¤ã‚µã‚¤ãƒˆã®ä½œä¾‹ãªã©ã¯ä½œã‚Šã‚„ã™ã„ã§ã™ã€‚ãŸã ã—ï¼‘å›ã®å‚åŠ ã§ã¯å®Œæˆã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã”è‡ªèº«ã®ä½œã‚Šé€”ä¸­ã®ä½œå“ã‚„ã€ææ–™ã®æŒã¡è¾¼ã¿ã‚‚å¯ã§ã™ï¼'
                  : '',
              placeholder: 'ã‚ã¨ã‹ã‚‰ã§ã‚‚è¨˜å…¥ã§ãã¾ã™ã€‚å½“æ—¥ã«ç›¸è«‡ã§ã‚‚å¤§ä¸ˆå¤«ï¼',
              value: workInProgress || '',
            })}
            ${Components.createTextArea({
              id: 'material-input',
              label: 'ææ–™ã®ã‚µã‚¤ã‚ºã‚„æ¨¹ç¨®ã®å¸Œæœ›',
              caption:
                'ã”å¸Œæœ›ãŒã‚ã‚Œã°ã”è¨˜å…¥ãã ã•ã„ã€‚å¤§ä½“ã§ã‚‚å¤§ä¸ˆå¤«ï¼ä½œã‚Œã‚‹å¤§ãã•ã¯ ã€è±†ç²’ã€‘ã€œã€æ‰‹ã®ã²ã‚‰ã€‘ãã‚‰ã„',
              placeholder:
                'ä¾‹ï¼š30Ã—30Ã—40mmãã‚‰ã„ã€ã€Œé«˜ã•ãŒ6cmãã‚‰ã„ã€ã€ŒãŸã¾ã”ãã‚‰ã„ã€ ãªã©',
              value: materialInfo || '',
            })}
          </div>
          <div class="mt-4 pt-4 border-t space-y-4">
            ${salesChecklistHtml}
            ${Components.createTextArea({ id: 'order-input', label: 'è³¼å…¥å¸Œæœ›ï¼ˆè‡ªç”±è¨˜å…¥ï¼‰', placeholder: 'ï¼ˆä»»æ„ï¼‰ä¾‹ï¼šå½«åˆ»åˆ€ã‚»ãƒƒãƒˆã€ãƒ†ã‚­ã‚¹ãƒˆ', value: order || '' })}
            ${Components.createTextArea({ id: 'message-input', label: 'ãã®ä»–ã®é€£çµ¡äº‹é …ã‚„è¦æœ›ãªã©', placeholder: '', value: messageToTeacher || '' })}
          </div>`;
    };
    // äºˆç´„é€ä¿¡æ™‚ã«ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸç‰©è²©ã‚’orderã«æ¸¡ã™å‡¦ç†ã‚’è¿½åŠ 
    const _getSelectedSalesOrder = () => {
      const checked = Array.from(
        document.querySelectorAll('input[name="orderSales"]:checked'),
      );
      return checked.map(cb => cb.value).join(', ');
    };

    // é€ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯æ™‚ã«orderå€¤ã‚’ã‚»ãƒƒãƒˆ
    setTimeout(() => {
      const submitBtn = document.querySelector(
        '[data-action="confirmBooking"], [data-action="updateReservation"]',
      );
      if (submitBtn) {
        submitBtn.addEventListener('click', () => {
          const selectedOrder = _getSelectedSalesOrder();
          const orderInput = document.getElementById('order-input');
          if (orderInput) {
            // æ—¢å­˜ã®è‡ªç”±è¨˜å…¥ã¨ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’åˆæˆ
            const freeText = orderInput.value.trim();
            orderInput.value = selectedOrder
              ? freeText
                ? selectedOrder + ', ' + freeText
                : selectedOrder
              : freeText;
          }
        });
      }
    }, 300);

    // --- 4. ãƒ¡ã‚¤ãƒ³HTMLã®çµ„ã¿ç«‹ã¦ ---
    let buttonsHtml = `
        ${Components.createButton({ text: submitButtonText, action: submitAction, colorClass: DesignConfig.colors.primary, widthClass: DesignConfig.buttons.full })}
      `;
    // ç·¨é›†æ™‚ã®ã¿ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    if (isEdit) {
      buttonsHtml += Components.createButton({
        text: 'ã“ã®äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹',
        action: 'cancel',
        colorClass: DesignConfig.colors.danger,
        widthClass: DesignConfig.buttons.full,
        reservationId: sourceData.reservationId, // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¿…è¦ãªæƒ…å ±ã‚’ä»˜ä¸
        classroom: sourceData.classroom,
        date: sourceData.date,
        sheetName: sourceData.sheetName,
      });
    }
    // æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼šç·¨é›†æ™‚ã¯ãƒ›ãƒ¼ãƒ ã¸ã€æ–°è¦ä½œæˆæ™‚ã¯äºˆç´„ä¸€è¦§ã¸
    buttonsHtml += Components.createButton({
      text: 'æˆ»ã‚‹',
      action: isEdit ? 'goBackToDashboard' : 'goBackToBooking',
      colorClass: DesignConfig.colors.secondary,
      widthClass: DesignConfig.buttons.full,
    });

    const venueDisplay = venue ? ` ${venue}` : '';

    const _renderOpeningHoursHtml = () => {
      const times = getClassroomTimesFromSchedule(sourceData);

      if (!times || !times.firstStart || !times.firstEnd) {
        return '<span class="text-ui-error-text">é–‹è¬›æ™‚é–“æœªè¨­å®š</span>';
      }

      if (times.secondStart && times.secondEnd) {
        // 2éƒ¨åˆ¶ã®å ´åˆ
        return `${times.firstStart} ~ ${times.firstEnd} , ${times.secondStart} ~ ${times.secondEnd}`;
      } else {
        // 1éƒ¨åˆ¶ã®å ´åˆ
        return `${times.firstStart} ~ ${times.firstEnd}`;
      }
    };

    // --- Main View Assembly ---
    return `
        <h1 class="text-xl font-bold ${DesignConfig.colors.text} mb-4">${title}</h1>
        <div class="space-y-4 text-left p-4 ${DesignConfig.cards.background} rounded-lg">
          <p><span class="font-bold w-20 inline-block">ãŠåå‰:</span> ${currentUser.displayName}ã•ã‚“</p>
          <p><span class="font-bold w-20 inline-block">æ•™å®¤:</span> ${classroom}${venueDisplay}</p>
          <p><span class="font-bold w-20 inline-block">æ—¥ä»˜:</span> ${formatDate(date)}</p>
          <p><span class="font-bold w-20 inline-block">çŠ¶æ³:</span> ${_renderStatusHtml()}</p>
          <p><span class="font-bold w-20 inline-block">é–‹è¬›æ™‚é–“:</span> ${_renderOpeningHoursHtml()}</p>
          ${_renderTuitionDisplaySection()}
          ${_renderTimeOptionsSection()}
          ${_renderBookingOptionsSection()}
          ${_renderDetailsInputSection()}
        </div>
        <div class="mt-8 flex flex-col space-y-3">
          ${buttonsHtml}
        </div>`;
  };

  /**
   * å®Œäº†ç”»é¢ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {string} msg - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getCompleteView = msg => {
    // æ•™å®¤æƒ…å ±ã‚’å–å¾—ï¼ˆä¼šè¨ˆå‡¦ç†æ™‚ã¯ accountingReservation ã‹ã‚‰ã€äºˆç´„ä½œæˆæ™‚ã¯ selectedSlot ã‹ã‚‰ï¼‰
    const classroom =
      stateManager.getState().accountingReservation?.classroom ||
      stateManager.getState().selectedSlot?.classroom;

    // åˆå›äºˆç´„è€…ã‹ã©ã†ã‹ã‚’åˆ¤å®š
    const wasFirstTimeBooking =
      stateManager.getState().wasFirstTimeBooking || false;
    const currentUser = stateManager.getState().currentUser;
    const studentHasEmail = currentUser && currentUser.email;
    const emailPreference = currentUser && currentUser.wantsEmail;

    // äºˆç´„å®Œäº†ã‹ä¼šè¨ˆå®Œäº†ã‹ã‚’åˆ¤å®š
    const isReservationComplete = msg !== 'ä¼šè¨ˆæƒ…å ±ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚';

    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«é–¢ã™ã‚‹æ¡ˆå†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆäºˆç´„å®Œäº†æ™‚ã®ã¿è¡¨ç¤ºï¼‰
    let emailNoticeHtml = '';
    if (wasFirstTimeBooking && isReservationComplete) {
      emailNoticeHtml = `
          <div class="bg-ui-info-bg border border-ui-info-border rounded-lg p-4 mt-4">
            <div class="flex items-start">
              <svg class="flex-shrink-0 h-5 w-5 text-ui-info-text mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
              </svg>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-ui-info-text">äºˆç´„å—ä»˜å®Œäº†ã®ãƒ¡ãƒ¼ãƒ«ã‚’ãŠé€ã‚Šã—ã¾ã—ãŸï¼</h3>
                <p class="mt-1 text-sm text-ui-info-text">
                  ä¼šå ´ã®ä½æ‰€ã‚„é§è»Šå ´æƒ…å ±ãªã©ã‚‚è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚ãƒ¡ãƒ¼ãƒ«ãŒå±Šã‹ãªã„å ´åˆã¯ã€è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã‚‚ã”ç¢ºèªãã ã•ã„ã€‚<br>
                  äºˆç´„ã®ç¢ºèªã‚„ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ã€ã“ã®ãƒšãƒ¼ã‚¸ï¼ˆWebã‚¢ãƒ—ãƒªä¸Šï¼‰ã§ãŠã“ãªãˆã¾ã™<br>
                  <br>
                  é€ä¿¡å…ƒã‚¢ãƒ‰ãƒ¬ã‚¹: shiawasenehito3000@gmail.com
                </p>
              </div>
            </div>
          </div>
        `;
    } else if (studentHasEmail && emailPreference && isReservationComplete) {
      emailNoticeHtml = `
          <div class="bg-ui-surface rounded-lg p-3 mt-4">
            <p class="text-sm text-brand-subtle text-center">
            äºˆç´„å—ä»˜å®Œäº†ã®ãƒ¡ãƒ¼ãƒ«ã‚’ãŠé€ã‚Šã—ã¾ã—ãŸï¼<br>
            ï¼ˆä¼šå ´ã®ä½æ‰€ã‚„é§è»Šå ´æƒ…å ±ãªã©ã‚‚è¨˜è¼‰ï¼‰<br>
            <br>
            é€ä¿¡å…ƒã‚¢ãƒ‰ãƒ¬ã‚¹: shiawasenehito3000@gmail.com
          </p>
          </div>
        `;
    }

    let nextBookingHtml = '';

    // è©²å½“æ•™å®¤ã®æœªæ¥ã®äºˆç´„æ ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
    if (classroom && stateManager.getState().slots) {
      // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§è¨ˆç®—æ¸ˆã¿ã®ç©ºãæƒ…å ±ã‚’ç›´æ¥ä½¿ç”¨
      const relevantSlots = stateManager
        .getState()
        .slots.filter(slot => slot.classroom === classroom);
      const bookingSlotsHtml = renderBookingSlots(relevantSlots);

      if (bookingSlotsHtml) {
        // äºˆç´„å®Œäº†æ™‚ã¨ä¼šè¨ˆå®Œäº†æ™‚ã§è¡¨è¨˜ã‚’å¤‰æ›´
        const sectionTitle = isReservationComplete
          ? '+ ã•ã‚‰ã« ã¤ãã® ã‚ˆã‚„ã'
          : '+ ã¤ãã® ã‚ˆã‚„ã';

        nextBookingHtml = `
            <div class="mt-10 pt-6 border-t border-gray-200">
                <h3 class="text-xl font-bold text-brand-text text-center mb-4">${sectionTitle}</h3>
                <div class="${DesignConfig.cards.container}">
                ${bookingSlotsHtml}
                </div>
            </div>`;
      }
    }

    return `
      <div class="text-center py-8">
          <svg class="w-16 h-16 mx-auto text-state-available-text" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <h1 class="text-2xl font-bold ${DesignConfig.colors.text} mt-4 mb-2">ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ</h1>
          <p class="${DesignConfig.colors.textSubtle} mb-6">${msg}</p>

          ${emailNoticeHtml}

          <div class="max-w-xs mx-auto mt-8">
               ${Components.createButton({
                 text: 'ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹',
                 action: 'goToDashboard',
                 colorClass: DesignConfig.colors.secondary,
                 widthClass: DesignConfig.buttons.full,
               })}
          </div>

          ${nextBookingHtml}

      </div>`;
  };

  /**
   * ä¼šè¨ˆç”»é¢ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getAccountingView = () => {
    // åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
    const state = stateManager.getState();

    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰
    if (!window.isProduction) {
      console.log('ğŸ” ä¼šè¨ˆç”»é¢ãƒ‡ãƒãƒƒã‚°æƒ…å ±:', {
        accountingMaster: !!state.accountingMaster,
        accountingReservation: !!state.accountingReservation,
        accountingReservationDetails: !!state.accountingReservationDetails,
        accountingScheduleInfo: !!state.accountingScheduleInfo,
        // ã‚ˆã‚Šè©³ç´°ãªæƒ…å ±
        masterLength: state.accountingMaster ? state.accountingMaster.length : 0,
        reservationId: state.accountingReservation
          ? state.accountingReservation.reservationId
          : 'ãªã—',
        reservationDetailsKeys: state.accountingReservationDetails
          ? Object.keys(state.accountingReservationDetails)
          : [],
        scheduleInfoType: state.accountingScheduleInfo
          ? state.accountingScheduleInfo.classroomType
          : 'ãªã—',
      });
    }

    // æœ€ä½é™å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
    if (!state.accountingMaster || !state.accountingReservation) {
      return '<div class="flex justify-center items-center h-full"><div class="spinner"></div><p class="ml-3 text-brand-text">ä¼šè¨ˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p></div>';
    }

    const reservation = state.accountingReservation;
    const master = state.accountingMaster;
    const reservationDetails = state.accountingReservationDetails || {};
    const scheduleInfo = state.accountingScheduleInfo || null;

    // ãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ãªå ´åˆã®ã‚¨ãƒ©ãƒ¼å‡¦ç†
    if (!reservationDetails || Object.keys(reservationDetails).length === 0) {
      console.warn('âš ï¸ reservationDetailsãŒç©ºã§ã™');
    }

    if (!scheduleInfo) {
      console.warn('âš ï¸ scheduleInfoãŒnullã§ã™');
    }
    // ã€ä¿®æ­£ã€‘çµ±ä¸€æ¤œç´¢é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã‚ˆã‚„ããƒ»ãã‚ãä¸¡æ–¹ã‹ã‚‰æ¤œç´¢
    const bookingOrRecord = findReservationById(reservation.reservationId, state);
    if (!bookingOrRecord) {
      return `
          <div class="text-center py-8">
            <p class="text-red-600">äºˆç´„ãƒ»è¨˜éŒ²æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>
            <button onclick="handleAction('goBackToDashboard')"
                    class="mt-4 px-6 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
              æˆ»ã‚‹
            </button>
          </div>
        `;
    }

    // ä¼šè¨ˆæ¸ˆã¿ã®å ´åˆ - å®Œå…¨åˆ†é›¢ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ãªã„å ´åˆã®ã¿ï¼‰
    if (
      bookingOrRecord.status === window.STATUS.COMPLETED &&
      bookingOrRecord.accountingDetails &&
      !state.isEditingAccountingRecord
    ) {
      try {
        const details = JSON.parse(bookingOrRecord.accountingDetails);
        return `
            ${Components.accountingCompleted({ details, reservation })}
            <div class="mt-8 flex flex-col space-y-3">
              ${Components.createButton({
                text: 'æˆ»ã‚‹',
                action: 'goBackToDashboard',
                colorClass: DesignConfig.colors.secondary,
                widthClass: DesignConfig.buttons.full,
              })}
            </div>`;
      } catch (e) {
        return '<div class="text-center text-state-danger-text">ä¼šè¨ˆè©³ç´°ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>';
      }
    }

    // æ–°è¦ä¼šè¨ˆãƒ•ã‚©ãƒ¼ãƒ  - æ¡ä»¶åˆ†å²ã®ç°¡ç´ åŒ–
    const tuitionItemRule = getTuitionItemRule(
      master,
      reservation.classroom,
      C.items.MAIN_LECTURE,
    );
    const isTimeBased =
      tuitionItemRule && tuitionItemRule['å˜ä½'] === C.units.THIRTY_MIN;
    const formType = isTimeBased ? 'timeBased' : 'fixed';

    return `
        ${Components.navigationHeader({ title: 'ä¼šè¨ˆ', backAction: 'goBackToDashboard' })}
        ${Components.accountingForm({
          type: formType,
          master,
          reservation,
          reservationDetails,
          scheduleInfo,
        })}
        <div class="mt-8 flex flex-col space-y-3">
          ${Components.createButton({
            text: 'æˆ»ã‚‹',
            action: 'goBackToDashboard',
            colorClass: DesignConfig.colors.secondary,
            widthClass: DesignConfig.buttons.full,
          })}
        </div>`;
  };


  // =================================================================
  // 14_WebApp_Handlers.js (è‡ªå‹•çµ±åˆ)
  // =================================================================

  // @ts-check
  /// <reference path="../types.d.ts" />

  /**
   * =================================================================
   * ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: 14_WebApp_Handlers.js
   * ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘: 1.6
   * ã€å½¹å‰²ã€‘: WebAppã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«ãŠã‘ã‚‹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œã«å¿œã˜ãŸ
   * ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ã‚’é›†ç´„ã—ã¾ã™ã€‚
   * ã€æ§‹æˆã€‘: 14ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®ã†ã¡ã®14ç•ªç›®
   * ã€v1.6ã§ã®å¤‰æ›´ç‚¹ã€‘:
   * - FE-14: ä¼šè¨ˆå…¥åŠ›ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã‚’è¿½åŠ ã€‚
   *   - localStorageã¸ã®ä¿å­˜ã€èª­ã¿è¾¼ã¿ã€å‰Šé™¤å‡¦ç†ã‚’å®Ÿè£…ã€‚
   *   - ç”»é¢é·ç§»ã€ä¿å­˜ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’é©åˆ‡ã«æ“ä½œã™ã‚‹ã‚ˆã†ä¿®æ­£ã€‚
   * =================================================================
   */

  // =================================================================
  // --- Time Data Helper Functions ---
  // -----------------------------------------------------------------
  // æ™‚åˆ»ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãƒ»å‡¦ç†ã‚’è¡Œã†ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤
  // =================================================================

  /**
   * æ™‚åˆ»ãƒ‡ãƒ¼ã‚¿ã‚’é©åˆ‡ã«å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
   * @param {string} elementId - æ™‚åˆ»å…¥åŠ›è¦ç´ ã®ID
   * @param {object} reservationData - äºˆç´„ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
   * @param {string} timeField - æ™‚åˆ»ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åï¼ˆ'startTime' or 'endTime'ï¼‰
   * @returns {string} æ™‚åˆ»æ–‡å­—åˆ—ï¼ˆHH:mmå½¢å¼ï¼‰
   */
  function getTimeValue(elementId, reservationData, timeField) {
    // 1. HTMLè¦ç´ ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
    const elementValue = document.getElementById(elementId)?.value;
    if (elementValue && elementValue !== '') {
      return elementValue;
    }

    // 2. äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œï¼ˆç·¨é›†æ™‚ï¼‰
    if (reservationData) {
      const headerField =
        window.HEADERS?.RESERVATIONS?.[timeField.toUpperCase()] || timeField;
      const timeValue =
        reservationData[headerField] || reservationData[timeField];
      if (timeValue && timeValue !== '') {
        return timeValue;
      }
    }

    // 3. selectedSlotã‹ã‚‰å–å¾—ã‚’è©¦è¡Œï¼ˆæ–°è¦ä½œæˆæ™‚ï¼‰
    const selectedSlot = stateManager.getState().selectedSlot;
    if (selectedSlot) {
      const headerField =
        window.HEADERS?.RESERVATIONS?.[timeField.toUpperCase()] || timeField;

      // ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¶æ•™å®¤ã®å ´åˆã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ±ã‹ã‚‰å–å¾—
      if (selectedSlot.classroomType === C.classroomTypes.SESSION_BASED) {
        if (timeField === 'startTime') {
          return selectedSlot.firstStart || selectedSlot.secondStart || '';
        } else if (timeField === 'endTime') {
          return selectedSlot.firstEnd || selectedSlot.secondEnd || '';
        }
      }

      // æ™‚é–“åˆ¶æ•™å®¤ã®å ´åˆã€selectedSlotã‹ã‚‰å–å¾—
      const slotValue = selectedSlot[headerField] || selectedSlot[timeField];
      if (slotValue && slotValue !== '') {
        return slotValue;
      }
    }

    return '';
  }

  // =================================================================
  // --- Accounting Cache Helper Functions (FE-14) ---
  // -----------------------------------------------------------------
  // ä¼šè¨ˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤
  // =================================================================

  /**
   * ä¼šè¨ˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç¾åœ¨ã®å…¥åŠ›å†…å®¹ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦å–å¾—ã—ã¾ã™ã€‚
   * @returns {object} ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿
   */
  function getAccountingFormData() {
    const form = document.getElementById('accounting-form');
    if (!form) return {};

    const data = {};
    const elements = form.elements;

    for (let i = 0; i < elements.length; i++) {
      const item = elements[i];
      if (item.name) {
        if (item.type === 'checkbox') {
          data[item.name] = item.checked;
        } else if (item.type === 'radio') {
          if (item.checked) {
            data[item.name] = item.value;
          }
        } else {
          data[item.name] = item.value;
        }
      }
    }
    return data;
  }

  // =================================================================
  // --- Action Handlers ---
  // -----------------------------------------------------------------
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œï¼ˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãªã©ï¼‰ã‚’èµ·ç‚¹ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹
  // å…¨ã¦ã®å‡¦ç†ã‚’å®šç¾©ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚
  // å„ã‚­ãƒ¼ãŒ data-action å±æ€§ã«å¯¾å¿œã—ã¾ã™ã€‚
  // =================================================================
  const actionHandlers = {
    /** ã‚¹ãƒãƒ¼ãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³: å‰ã®ç”»é¢ã«æˆ»ã‚‹ */
    smartGoBack: () => {
      const backState = stateManager.goBack();
      stateManager.dispatch({
        type: 'SET_STATE',
        payload: backState,
      });
    },

    /** ãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯æ–°è¦ç™»éŒ²ã‚’é–‹å§‹ã—ã¾ã™ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ç‰ˆï¼‰ */
    login: () => {
      const p = document.getElementById('phone').value;
      // å…¥åŠ›å€¤ã‚’setStateçµŒç”±ã§ä¿å­˜
      window.stateManager.dispatch({
        type: 'UPDATE_STATE',
        payload: { loginPhone: p },
      });
      if (!p) return showInfo('é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');

      // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§é›»è©±ç•ªå·ã‚’æ­£è¦åŒ–ï¼ˆå³æ™‚ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼‰
      const normalizeResult = window.normalizePhoneNumberFrontend(p);

      if (!normalizeResult.isValid) {
        showInfo(normalizeResult.error || 'é›»è©±ç•ªå·ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }

      showLoading('login');
      // æ­£è¦åŒ–ã«æˆåŠŸã—ãŸå ´åˆã¯ç›´æ¥ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’å®Ÿè¡Œï¼ˆ1å›ã®APIå‘¼ã³å‡ºã—ï¼‰
      actionHandlers.processLoginWithValidatedPhone(normalizeResult.normalized);
    },

    /** æ¤œè¨¼æ¸ˆã¿é›»è©±ç•ªå·ã§ã®ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† */
    processLoginWithValidatedPhone: normalizedPhone => {
      // ç’°å¢ƒåˆ†å²: ãƒ†ã‚¹ãƒˆç’°å¢ƒã®å ´åˆã¯ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨

      // æœ¬ç•ªç’°å¢ƒ: çµ±åˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§åˆæœŸãƒ‡ãƒ¼ã‚¿ã¨ç©ºå¸­æƒ…å ±ã‚’ä¸€æ‹¬å–å¾—
      google.script.run
        .withSuccessHandler(response => {
          // â† ã“ã® response ã«ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã® getLoginData é–¢æ•°ã®æˆ»ã‚Šå€¤ãŒæ ¼ç´ã•ã‚Œã¾ã™ã€‚

          // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ç”»é¢ã«è¡¨ç¤ºï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ç„¡åŠ¹åŒ–ï¼‰
          if (!window.isProduction) {
            debugLog('åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†');
            debugLog('response.success: ' + response.success);
            debugLog('response.userFound: ' + response.userFound);
            debugLog(
              'response.availableSlots: ' +
                (response.availableSlots
                  ? response.availableSlots.length + 'ä»¶'
                  : 'null/undefined'),
            );
            debugLog(
              'response.data: ' + (response.data ? 'ã‚ã‚Š' : 'null/undefined'),
            );
          }

          if (response.success && response.userFound) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆï¼šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰å‡¦ç†ã§çŠ¶æ…‹æ§‹ç¯‰
            const newAppState = processInitialData(
              response.data,
              normalizedPhone,
              response.availableSlots,
              response.data.userReservations,
            );
            debugLog(
              'processInitialDataå®Œäº† - slots: ' +
                (newAppState.slots ? newAppState.slots.length + 'ä»¶' : 'null'),
            );
            debugLog(
              'processInitialDataå®Œäº† - classrooms: ' +
                JSON.stringify(newAppState.classrooms),
            );

            window.stateManager.dispatch({
              type: 'SET_STATE',
              payload: {
                ...newAppState,
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸå®šæ•°ã‚’ä½¿ã£ã¦ã€è¡¨ç¤ºã™ã‚‹å±¥æ­´ã®åˆæœŸä»¶æ•°ã‚’è¨­å®š
                recordsToShow:
                  newAppState.constants?.ui?.HISTORY_INITIAL_RECORDS || 10,
                isDataFresh: true,
              },
            });
          } else {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¾ãŸã¯ç‰¹åˆ¥ã‚³ãƒãƒ³ãƒ‰èªè­˜æ™‚ã®åˆ†å²å‡¦ç†
            if (response.commandRecognized) {
              // ç‰¹æ®Šã‚³ãƒãƒ³ãƒ‰ãŒèªè­˜ã•ã‚ŒãŸå ´åˆã¯userSearchç”»é¢ã«é·ç§»
              window.stateManager.dispatch({
                type: 'SET_STATE',
                payload: {
                  view: 'userSearch',
                  searchedUsers: [],
                  selectedSearchedUser: null,
                  searchAttempted: false,
                },
              });
            } else {
              // é€šå¸¸ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªç™»éŒ²ã®å ´åˆã¯æ–°è¦ç™»éŒ²ç”»é¢ã«é·ç§»
              window.stateManager.dispatch({
                type: 'SET_STATE',
                payload: {
                  view: 'register',
                  registrationPhone: normalizedPhone,
                },
              });
            }
          }
        })
        .withFailureHandler(err => {
          hideLoading();
          if (!window.isProduction) {
            debugLog('åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + err.message);
          }
          handleServerError(err);
        })
        .getLoginData(normalizedPhone);
    },

    /** æ–°ã—ã„ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ï¼ˆãƒ¡ã‚¤ãƒ³ã®loginã«çµ±åˆæ¸ˆã¿ï¼‰ */

    /** æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼šStep1ã‹ã‚‰Step2ã¸ */
    goToStep2: () => {
      const realName = document.getElementById('reg-realname').value;
      const nickname = document.getElementById('reg-nickname').value.trim();
      const phone = document.getElementById('reg-phone').value;

      if (!realName) return showInfo('ãŠåå‰ï¼ˆæœ¬åï¼‰ã¯å¿…é ˆã§ã™ã€‚');

      // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§é›»è©±ç•ªå·ã‚’æ­£è¦åŒ–ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (phone) {
        const normalizeResult = window.normalizePhoneNumberFrontend(phone);
        if (!normalizeResult.isValid) {
          showInfo(normalizeResult.error || 'é›»è©±ç•ªå·ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
          return;
        }
      }

      // å…¥åŠ›å€¤ã‚’setStateçµŒç”±ã§ä¿å­˜
      const updatedRegistrationData = {
        ...stateManager.getState().registrationData,
        phone,
        realName,
        nickname: nickname || realName,
      };
      window.stateManager.dispatch({
        type: 'SET_STATE',
        payload: {
          registrationData: updatedRegistrationData,
          registrationStep: 2,
          view: 'registrationStep2',
        },
      });
    },

    /** æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼šStep2ã‹ã‚‰Step1ã¸æˆ»ã‚‹ */
    backToStep1: () => {
      const realName = document.getElementById('reg-realname')?.value;
      const nickname = document.getElementById('reg-nickname')?.value;
      const phone = document.getElementById('reg-phone')?.value;
      if (realName || nickname || phone) {
        const updatedRegistrationData = {
          ...stateManager.getState().registrationData,
          realName:
            realName || stateManager.getState().registrationData?.realName || '',
          nickname:
            nickname || stateManager.getState().registrationData?.nickname || '',
          phone: phone || stateManager.getState().registrationData?.phone || '',
        };
        window.stateManager.dispatch({
          type: 'SET_STATE',
          payload: { registrationData: updatedRegistrationData },
        });
      }
      window.stateManager.dispatch({
        type: 'SET_STATE',
        payload: { view: 'register', registrationStep: 1 },
      });
    },

    /** æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼šStep2ã‹ã‚‰Step3ã¸é€²ã‚€ */
    goToStep3: () => {
      const email = document.getElementById('q-email').value;
      if (!email || !email.includes('@')) {
        return showInfo('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      }

      const step2Data = {
        email: email,
        wantsEmail: document.getElementById('q-wants-email').checked,
        ageGroup: document.getElementById('q-age-group').value,
        gender:
          document.querySelector('input[name="gender"]:checked')?.value || '',
        dominantHand:
          document.querySelector('input[name="dominantHand"]:checked')?.value ||
          '',
        address: document.getElementById('q-address').value,
      };

      window.stateManager.dispatch({
        type: 'SET_STATE',
        payload: {
          registrationData: {
            ...stateManager.getState().registrationData,
            ...step2Data,
          },
          registrationStep: 3,
          view: 'registrationStep3',
        },
      });
    },

    /** æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼šStep3ã‹ã‚‰Step2ã¸æˆ»ã‚‹ */
    backToStep2: () =>
      window.stateManager.dispatch({
        type: 'SET_STATE',
        payload: { view: 'registrationStep2', registrationStep: 2 },
      }),

    /** æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼šStep3ã‹ã‚‰Step4ã¸é€²ã‚€ */
    proceedToStep4: () => {
      const step3Data = {
        experience:
          document.querySelector('input[name="experience"]:checked')?.value || '',
        pastWork: document.getElementById('q-past-work').value,
        futureGoal: document.getElementById('q-future-goal').value,
      };
      window.stateManager.dispatch({
        type: 'SET_STATE',
        payload: {
          registrationData: {
            ...stateManager.getState().registrationData,
            ...step3Data,
          },
          registrationStep: 4,
          view: 'registrationStep4',
        },
      });
    },

    /** æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼šStep4ã‹ã‚‰Step3ã¸æˆ»ã‚‹ */
    backToStep3: () =>
      window.stateManager.dispatch({
        type: 'SET_STATE',
        payload: { view: 'registrationStep3', registrationStep: 3 },
      }),

    /** æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼šæœ€çµ‚ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ï¼ˆãƒãƒƒãƒå‡¦ç†ç‰ˆï¼‰ */
    submitRegistration: () => {
      const step4Data = {
        futureParticipation:
          document.querySelector('input[name="futureParticipation"]:checked')
            ?.value || '',
        trigger: document.getElementById('q-trigger').value,
        firstMessage: document.getElementById('q-first-message').value,
      };

      const finalUserData = {
        ...stateManager.getState().registrationData,
        ...step4Data,
      };

      showLoading('login');
      google.script.run
        .withSuccessHandler(res => {
          if (res.success) {
            // ç™»éŒ²å¾Œã€ãƒãƒƒãƒå‡¦ç†ã§åˆæœŸãƒ‡ãƒ¼ã‚¿ã¨ç©ºå¸­æƒ…å ±ã‚’ä¸€æ‹¬å–å¾—
            google.script.run
              .withSuccessHandler(batchResult => {
                if (batchResult.success) {
                  const newAppState = processInitialData(
                    batchResult.data.initial,
                    res.user.phone,
                    batchResult.data.slots,
                  );

                  window.stateManager.dispatch({
                    type: 'SET_STATE',
                    payload: {
                      ...newAppState,
                      currentUser: res.user,
                      view: 'dashboard',
                    },
                  });
                  hideLoading();
                } else {
                  hideLoading();
                  showInfo(
                    batchResult.message || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ',
                    'ã‚¨ãƒ©ãƒ¼',
                  );
                }
              })
              .withFailureHandler(handleServerError)
              .getBatchData(['initial', 'slots'], res.user.phone);
          } else {
            hideLoading();
            showInfo(res.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(handleServerError)
        .registerNewUser(finalUserData);
    },

    /** ãã‚ãã‚«ãƒ¼ãƒ‰ã®ç·¨é›†ãƒœã‚¿ãƒ³ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ç‰ˆï¼‰ */
    editHistoryMemo: d => {
      const item = stateManager
        .getState()
        .myReservations.find(h => h.reservationId === d.reservationId);
      if (!item) return;

      const originalMemo = item.workInProgress;

      showConfirm({
        title: 'åˆ¶ä½œãƒ¡ãƒ¢ã®ç·¨é›†',
        message: buildMemoEditModal(item),
        confirmText:
          window.stateManager.getState().constants?.messages?.SAVE || 'ä¿å­˜ã™ã‚‹',
        cancelText:
          window.stateManager.getState().constants?.messages?.CANCEL ||
          'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
        confirmColorClass: DesignConfig.colors.primary,
        onConfirm: () => {
          const newMemo = document.getElementById('memo-edit-textarea').value;

          // æ¥½è¦³çš„UI: ã¾ãšãƒ•ãƒ­ãƒ³ãƒˆã®è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«æ›´æ–°ï¼‰
          const state = window.stateManager.getState();
          const newReservations = state.myReservations.map(h => {
            if (h.reservationId === d.reservationId) {
              return { ...h, workInProgress: newMemo };
            }
            return h;
          });
          window.stateManager.dispatch({
            type: 'UPDATE_STATE',
            payload: { myReservations: newReservations },
          });

          showLoading();

          // ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ï¼ˆçµ±åˆäºˆç´„ã‚·ãƒ¼ãƒˆæ›´æ–° + ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†æ§‹ç¯‰ + æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼‰
          google.script.run
            .withSuccessHandler(r => {
              hideLoading();
              if (r.success) {
                showInfo('åˆ¶ä½œãƒ¡ãƒ¢ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚', 'ä¿å­˜å®Œäº†');
                // ä»–ã®æ“ä½œã¨åŒæ§˜ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§çŠ¶æ…‹ã‚’æ›´æ–°
                if (r.data) {
                  // ãƒ‡ãƒãƒƒã‚°: å—ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ã‚°å‡ºåŠ›
                  console.log('[DEBUG] åˆ¶ä½œãƒ¡ãƒ¢æ›´æ–°å¾Œã®ãƒ‡ãƒ¼ã‚¿:', r.data);
                  console.log('[DEBUG] myReservations:', r.data.myReservations);
                  window.stateManager.dispatch({
                    type: 'SET_STATE',
                    payload: {
                      ...r.data.initialData,
                      myReservations: r.data.myReservations || [],
                      isDataFresh: true, // æœ€æ–°ãƒ‡ãƒ¼ã‚¿å—ä¿¡æ¸ˆã¿
                    },
                  });
                  // æ˜ç¤ºçš„ã«ç”»é¢ã‚’å†æç”»
                  if (typeof window.render === 'function') {
                    setTimeout(() => window.render(), 100);
                  }
                } else {
                  // ãƒ‡ãƒ¼ã‚¿ãªã—ã®å ´åˆã¯æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å¼·åˆ¶å–å¾—
                  updateAppStateFromCache(window.stateManager.getState().view);
                }
              } else {
                // ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å…ƒã«æˆ»ã™ï¼ˆã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«æ›´æ–°ï¼‰
                const errorState = window.stateManager.getState();
                const revertedReservations = errorState.myReservations.map(h => {
                  if (h.reservationId === d.reservationId) {
                    return { ...h, workInProgress: originalMemo };
                  }
                  return h;
                });
                window.stateManager.dispatch({
                  type: 'SET_STATE',
                  payload: { myReservations: revertedReservations },
                });
                showInfo(r.message || 'ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'ã‚¨ãƒ©ãƒ¼');
              }
            })
            .withFailureHandler(err => {
              hideLoading();
              // é€šä¿¡ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å…ƒã«æˆ»ã™ï¼ˆã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«æ›´æ–°ï¼‰
              const failureState = window.stateManager.getState();
              const failureRevertedReservations = failureState.myReservations.map(
                h => {
                  if (h.reservationId === d.reservationId) {
                    return { ...h, workInProgress: originalMemo };
                  }
                  return h;
                },
              );
              window.stateManager.dispatch({
                type: 'SET_STATE',
                payload: { myReservations: failureRevertedReservations },
              });
              handleServerError(err);
            })
            .updateReservationMemoAndGetLatestData(
              d.reservationId,
              stateManager.getState().currentUser.studentId,
              newMemo,
            );
        },
      });
    },

    /** ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã™ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ç‰ˆï¼‰ */
    saveProfile: () => {
      const r = document.getElementById('edit-realname').value;
      let n = document.getElementById('edit-nickname').value.trim();
      if (!r) return showInfo('ãŠåå‰ï¼ˆæœ¬åï¼‰ã¯å¿…é ˆã§ã™ã€‚');
      if (!n) n = r;

      // NF-01: é›»è©±ç•ªå·å…¥åŠ›æ¬„ãŒã‚ã‚Œã°ãã®å€¤ã‚‚å–å¾—
      const phoneInput = document.getElementById('edit-phone');
      const phone = phoneInput
        ? phoneInput.value
        : stateManager.getState().currentUser.phone; // é›»è©±ç•ªå·å…¥åŠ›æ¬„ãŒãªã‘ã‚Œã°æ—¢å­˜ã®é›»è©±ç•ªå·ã‚’ä½¿ç”¨

      // ãƒ¡ãƒ¼ãƒ«æƒ…å ±ã®å–å¾—
      const emailInput = document.getElementById('edit-email');
      const wantsEmailInput = document.getElementById('edit-wants-email');
      const email = emailInput
        ? emailInput.value
        : stateManager.getState().currentUser.email;
      const wantsEmail = wantsEmailInput
        ? wantsEmailInput.checked
        : stateManager.getState().currentUser.wantsEmail;

      const u = {
        ...stateManager.getState().currentUser,
        realName: r,
        displayName: n,
        phone: phone,
        email: email || '',
        wantsEmail: wantsEmail || false,
      };
      showLoading();
      google.script.run
        .withSuccessHandler(res => {
          hideLoading();
          if (res.success) {
            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°å¾Œã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚æ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã®ã§ãã®ã¾ã¾çŠ¶æ…‹æ›´æ–°
            showInfo('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'æ›´æ–°å®Œäº†');
            window.stateManager.dispatch({
              type: 'SET_STATE',
              payload: { currentUser: res.updatedUser, view: 'dashboard' },
            });
          } else {
            showInfo(res.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(handleServerError)
        .updateUserProfile(u);
    },

    /**
     * NF-01: é›»è©±ç•ªå·æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢ã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ç‰ˆï¼‰ã€‚
     */
    searchUserByName: () => {
      const searchInput = document.getElementById('nickname-search-input');
      const searchTerm = searchInput ? searchInput.value.trim() : ''; // æ¤œç´¢èªã‚’searchTermã«å¤‰æ›´

      if (!searchTerm) {
        return showInfo('ãŠåå‰ï¼ˆæœ¬åï¼‰ã¾ãŸã¯ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      }

      showLoading('login');

      // æ¤œç´¢èªã‹ã‚‰ã‚¹ãƒšãƒ¼ã‚¹ã‚’é™¤å»ã—ã¦å°æ–‡å­—åŒ–ã—ã¦æ¯”è¼ƒã«ä½¿ã†
      const normalizedSearchTerm = searchTerm.replace(/\s+/g, '').toLowerCase();

      google.script.run
        .withSuccessHandler(response => {
          hideLoading();
          if (response.success) {
            // ã€çµ±ä¸€ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã€‘ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ä¿®æ­£
            // searchName (ã‚¹ãƒšãƒ¼ã‚¹é™¤å»æ¸ˆã¿ãƒ»å°æ–‡å­—åŒ–ã•ã‚ŒãŸçµåˆå) ã‚’ä½¿ã£ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const filteredUsers = response.data.filter(
              user =>
                user.searchName && user.searchName.includes(normalizedSearchTerm),
            );

            // NF-01: æ¤œç´¢ãŒè©¦è¡Œã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
            window.stateManager.dispatch({
              type: 'SET_STATE',
              payload: { searchedUsers: filteredUsers, searchAttempted: true },
            });

            if (filteredUsers.length === 0) {
              // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒ“ãƒ¥ãƒ¼å´ã§è¡¨ç¤º
            }
          } else {
            showInfo(response.message || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(handleServerError)
        .searchUsersWithoutPhone(searchTerm);
    },

    /**
     * NF-01: æ¤œç´¢çµæœã‹ã‚‰é›»è©±ç•ªå·æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¾ã™ï¼ˆãƒãƒƒãƒå‡¦ç†ç‰ˆï¼‰ã€‚
     */
    selectSearchedUser: d => {
      // ãƒœã‚¿ãƒ³ã«åŸ‹ã‚è¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€ã¾ãšä»®ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä½œæˆ
      const tempUser = {
        studentId: d.studentId,
        realName: d.realName, // ãƒœã‚¿ãƒ³ã®dataå±æ€§ã‹ã‚‰å–å¾—
        displayName: d.nickname, // ãƒœã‚¿ãƒ³ã®dataå±æ€§ã‹ã‚‰å–å¾—
        phone: '', // é›»è©±ç•ªå·ã¯ã¾ã ãªã„ã®ã§ç©º
      };

      showLoading('login');

      // ãƒãƒƒãƒå‡¦ç†ã§åˆæœŸãƒ‡ãƒ¼ã‚¿ã€ç©ºå¸­æƒ…å ±ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬å–å¾—
      google.script.run
        .withSuccessHandler(response => {
          if (response.success) {
            // tempUserã®æƒ…å ±ã§currentUserã‚’ä¸Šæ›¸ãã—ã¤ã¤ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’æ´»ç”¨
            const userFromCache =
              response.data.initial.allStudents[tempUser.studentId];
            const finalUser = userFromCache
              ? {
                  ...userFromCache,
                  displayName: tempUser.displayName,
                  phone: tempUser.phone,
                }
              : tempUser;

            // å€‹äººäºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥å–å¾—ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¯è¡¨ç¤ºæ™‚ã«å®Ÿè¡Œï¼‰
            const { myReservations } = response.data.userReservations || {
              myReservations: [],
            };
            const today = response.data.initial.today;

            window.stateManager.dispatch({
              type: 'SET_STATE',
              payload: {
                currentUser: finalUser,
                slots: response.data.slots,
                myReservations: myReservations,
                accountingMaster: response.data.initial.accountingMaster,
                recordsToShow: 10, // UI.HISTORY_INITIAL_RECORDSã§å¾Œã§æ›´æ–°
                view: 'editProfile', // é›»è©±ç•ªå·ç™»éŒ²ã‚’ä¿ƒã™ãŸã‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ç”»é¢ã¸
                today: today,
                _allStudents: response.data.initial.allStudents,
                _cacheVersions: response.data.initial.cacheVersions,
              },
            });
          } else {
            hideLoading();
            showInfo(response.message || 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(handleServerError)
        .getBatchData(
          ['initial', 'slots', 'reservations'],
          null,
          tempUser.studentId,
        );
    },

    /**
     * NF-01: è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã«æ–°è¦ç™»éŒ²ç”»é¢ã¸é·ç§»ã—ã¾ã™ã€‚
     */
    goToRegisterFromUserSearch: () => {
      // æ–°è¦ç™»éŒ²ç”»é¢ã¸é·ç§»ã€‚é›»è©±ç•ªå·ã¯æœªå…¥åŠ›ã®ã¾ã¾ã€‚
      window.stateManager.dispatch({
        type: 'SET_STATE',
        payload: { view: 'register', registrationPhone: '' },
      });
    },

    /** äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ */
    cancel: d => {
      const message = `
          <div class="text-left space-y-4">
            <p class="text-center"><b>${formatDate(d.date)}</b><br>${d.classroom}<br>ã“ã®äºˆç´„ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ</p>
            <div class="pt-4 border-t">
              <label class="block text-sm font-bold mb-2">å…ˆç”Ÿã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰</label>
              <textarea id="cancel-message" class="w-full p-2 border border-ui-border rounded" rows="3" placeholder=""></textarea>
            </div>
          </div>
        `;
      showConfirm({
        title: 'äºˆç´„ã®å–ã‚Šæ¶ˆã—',
        message: message,
        confirmText: 'ã¯ã„ã€€å–ã‚Šæ¶ˆã—ã¾ã™',
        cancelText: 'ã„ã„ãˆ',
        confirmColorClass: DesignConfig.colors.danger,
        onConfirm: () => {
          showLoading('cancel');
          const cancelMessage =
            document.getElementById('cancel-message')?.value || '';
          const p = {
            ...d,
            studentId: stateManager.getState().currentUser.studentId,
            cancelMessage: cancelMessage,
          };
          google.script.run
            .withSuccessHandler(r => {
              hideLoading();
              if (r.success) {
                if (r.data) {
                  window.stateManager.dispatch({
                    type: 'SET_STATE',
                    payload: {
                      ...r.data.initialData,
                      myReservations: r.data.myReservations || [],
                      slots: r.data.slots || [],
                      view: 'dashboard',
                      isDataFresh: true, // æœ€æ–°ãƒ‡ãƒ¼ã‚¿å—ä¿¡æ¸ˆã¿
                    },
                  });
                } else {
                  window.stateManager.dispatch({
                    type: 'SET_STATE',
                    payload: {
                      view: 'dashboard',
                      isDataFresh: false, // å†èª­ã¿è¾¼ã¿å¿…è¦
                    },
                  });
                }
                showInfo(r.message || 'äºˆç´„ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚', 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†');
              } else {
                showInfo(r.message || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
              }
            })
            .withFailureHandler(err => {
              // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç”»é¢ã‚’æ›´æ–°ã›ãšã€å…ƒã®çŠ¶æ…‹ã‚’ç¶­æŒ
              handleServerError(err);
            })
            .cancelReservationAndGetLatestData(p);
        },
      });
    },

    /** äºˆç´„ã‚’ç¢ºå®šã—ã¾ã™ */
    confirmBooking: () => {
      // åˆå›ã®è‡ªå‹•åˆ¤å®š
      // isFirstTimeBooking ã‚’ stateManager ã‹ã‚‰å–å¾—
      const isFirstTimeBooking = stateManager.getState().isFirstTimeBooking;

      // ç¾åœ¨è¦‹ã¦ã„ã‚‹äºˆç´„æ ã®æ™‚é–“æƒ…å ±ã‚’å–å¾—
      const selectedSlot = stateManager.getState().selectedSlot;

      // æ•™å®¤å½¢å¼ã«å¿œã˜ã¦æ™‚é–“ã‚’è¨­å®šï¼ˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ä½¿ç”¨ï¼‰
      const startTime = getTimeValue('res-start-time', null, 'startTime');
      const endTime = getTimeValue('res-end-time', null, 'endTime');

      // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
      if (selectedSlot?.classroomType === C.classroomTypes.SESSION_BASED) {
        console.log(`[ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¶] æ™‚é–“è¨­å®š: ${startTime} - ${endTime}`);
      } else {
        console.log(`[æ™‚é–“åˆ¶] æ™‚é–“è¨­å®š: ${startTime} - ${endTime}`);
      }

      const bookingOptions = {
        chiselRental: document.getElementById('option-rental')?.checked || false,
        firstLecture:
          document.getElementById('option-first-lecture')?.checked ||
          isFirstTimeBooking, // è‡ªå‹•è¨­å®š
        workInProgress: document.getElementById('wip-input')?.value || '',
        order: document.getElementById('order-input')?.value || '',
        messageToTeacher: document.getElementById('message-input')?.value || '',
        materialInfo: document.getElementById('material-input')?.value || '',
      };

      showLoading('booking');

      const p = {
        ...selectedSlot,
        // æ™‚é–“æƒ…å ±ã‚’ä¸Šæ›¸ãï¼ˆæ•™å®¤å½¢å¼ã«å¿œã˜ã¦èª¿æ•´æ¸ˆã¿ï¼‰
        startTime: startTime,
        endTime: endTime,
        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã®äº’æ›æ€§ã®ãŸã‚ã€ãƒ˜ãƒƒãƒ€ãƒ¼å½¢å¼ã‚‚ä½µè¨˜
        [window.HEADERS?.RESERVATIONS?.START_TIME || 'startTime']: startTime,
        [window.HEADERS?.RESERVATIONS?.END_TIME || 'endTime']: endTime,
        user: stateManager.getState().currentUser,
        studentId: stateManager.getState().currentUser.studentId,
        options: bookingOptions,
      };

      google.script.run
        .withSuccessHandler(r => {
          hideLoading();
          if (r.success) {
            if (r.data) {
              window.stateManager.dispatch({
                type: 'SET_STATE',
                payload: {
                  ...r.data.initialData,
                  myReservations: r.data.myReservations || [],
                  slots: r.data.slots || [],
                  view: 'complete',
                  completionMessage: r.message,
                  isDataFresh: true, // æœ€æ–°ãƒ‡ãƒ¼ã‚¿å—ä¿¡æ¸ˆã¿
                },
              });
            } else {
              window.stateManager.dispatch({
                type: 'SET_STATE',
                payload: {
                  view: 'complete',
                  completionMessage: r.message,
                  isDataFresh: false, // å†èª­ã¿è¾¼ã¿å¿…è¦
                },
              });
            }
          } else {
            showInfo(r.message || 'äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(handleServerError)
        .makeReservationAndGetLatestData(p);
    },

    /** äºˆç´„ç·¨é›†ç”»é¢ã«é·ç§»ã—ã¾ã™ï¼ˆäºˆç´„ãƒ‡ãƒ¼ã‚¿ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—æ¸ˆã¿ï¼‰ */
    goToEditReservation: d => {
      showLoading('dataFetch');
      // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã¯æ—¢ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—æ¸ˆã¿ãªã®ã§ã€ç›´æ¥ç·¨é›†ç”»é¢ã«é·ç§»
      const reservation = stateManager
        .getState()
        .myReservations.find(
          booking =>
            booking.reservationId === d.reservationId &&
            booking.classroom === d.classroom,
        );

      if (reservation) {
        const editingDetails = {
          reservationId: reservation.reservationId,
          classroom: reservation.classroom,
          date: reservation.date,
          venue: reservation.venue,
          chiselRental: reservation.chiselRental || false,
          firstLecture: reservation.firstLecture || false,
          [window.HEADERS?.RESERVATIONS?.START_TIME || 'startTime']:
            reservation[window.HEADERS?.RESERVATIONS?.START_TIME] ||
            reservation.startTime ||
            '',
          [window.HEADERS?.RESERVATIONS?.END_TIME || 'endTime']:
            reservation[window.HEADERS?.RESERVATIONS?.END_TIME] ||
            reservation.endTime ||
            '',
          workInProgress: reservation.workInProgress || '',
          order: reservation.order || '',
          messageToTeacher: reservation.message || '',
          materialInfo: reservation.materialInfo || '',
        };

        // scheduleInfoå–å¾—å®Œäº†å¾Œã«ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        getScheduleInfoFromCache(
          editingDetails.date,
          editingDetails.classroom,
        ).then(scheduleInfo => {
          // editingReservationDetailsã«scheduleInfoæƒ…å ±ã‚’ãƒãƒ¼ã‚¸
          const enrichedDetails = {
            ...editingDetails,
            firstStart: scheduleInfo?.firstStart,
            firstEnd: scheduleInfo?.firstEnd,
            secondStart: scheduleInfo?.secondStart,
            secondEnd: scheduleInfo?.secondEnd,
            classroomType: scheduleInfo?.classroomType,
          };

          // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ±å–å¾—å®Œäº†å¾Œã«ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
          window.stateManager.dispatch({
            type: 'SET_STATE',
            payload: {
              view: 'editReservation',
              editingReservationDetails: enrichedDetails,
            },
          });

          hideLoading();
        });
      } else {
        showInfo('äºˆç´„æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      }
    },

    /** äºˆç´„æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã™ */
    updateReservation: () => {
      const d = stateManager.getState().editingReservationDetails;
      const startTime = getTimeValue('res-start-time', d, 'startTime');
      const endTime = getTimeValue('res-end-time', d, 'endTime');

      const p = {
        reservationId: d.reservationId,
        classroom: d.classroom,
        studentId: stateManager.getState().currentUser.studentId,
        chiselRental: document.getElementById('option-rental')?.checked || false,
        firstLecture:
          document.getElementById('option-first-lecture')?.checked || false,
        startTime: startTime,
        endTime: endTime,
        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã®äº’æ›æ€§ã®ãŸã‚ã€ãƒ˜ãƒƒãƒ€ãƒ¼å½¢å¼ã‚‚ä½µè¨˜
        [window.HEADERS?.RESERVATIONS?.START_TIME || 'startTime']: startTime,
        [window.HEADERS?.RESERVATIONS?.END_TIME || 'endTime']: endTime,
        workInProgress: document.getElementById('wip-input').value,
        order: document.getElementById('order-input').value,
        messageToTeacher: document.getElementById('message-input').value,
        materialInfo: document.getElementById('material-input')?.value || '',
      };
      showLoading('booking');
      google.script.run
        .withSuccessHandler(r => {
          hideLoading();
          if (r.success) {
            if (r.data) {
              window.stateManager.dispatch({
                type: 'SET_STATE',
                payload: {
                  ...r.data.initialData,
                  myReservations: r.data.myReservations || [],
                  slots: r.data.slots || [],
                  view: 'dashboard',
                  isDataFresh: true, // æœ€æ–°ãƒ‡ãƒ¼ã‚¿å—ä¿¡æ¸ˆã¿
                },
              });
            } else {
              window.stateManager.dispatch({
                type: 'SET_STATE',
                payload: {
                  view: 'dashboard',
                  isDataFresh: false, // å†èª­ã¿è¾¼ã¿å¿…è¦
                },
              });
            }
            showInfo(r.message || 'äºˆç´„å†…å®¹ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚', 'æ›´æ–°å®Œäº†');
          } else {
            showInfo(r.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(handleServerError)
        .updateReservationDetailsAndGetLatestData(p);
    },

    /** ä¼šè¨ˆç”»é¢ã«é·ç§»ã—ã¾ã™ï¼ˆäºˆç´„ãƒ‡ãƒ¼ã‚¿ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—æ¸ˆã¿ï¼‰ */
    goToAccounting: d => {
      showLoading('accounting');
      const reservationId = d.reservationId;

      // ã€ä¿®æ­£ã€‘çµ±ä¸€æ¤œç´¢é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã‚ˆã‚„ããƒ»ãã‚ãä¸¡æ–¹ã‹ã‚‰æ¤œç´¢
      const reservationData = findReservationById(reservationId);

      if (reservationData) {
        // äºˆç´„ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’èª­ã¿è¾¼ã¿
        const cachedData = loadAccountingCache(reservationId);
        const baseDetails = {
          firstLecture: reservationData.firstLecture || false,
          chiselRental: reservationData.chiselRental || false,
          [window.HEADERS?.RESERVATIONS?.START_TIME || 'startTime']:
            reservationData[window.HEADERS?.RESERVATIONS?.START_TIME] ||
            reservationData.startTime ||
            null,
          [window.HEADERS?.RESERVATIONS?.END_TIME || 'endTime']:
            reservationData[window.HEADERS?.RESERVATIONS?.END_TIME] ||
            reservationData.endTime ||
            null,
        };

        // äºˆç´„å›ºæœ‰æƒ…å ±ï¼ˆå€‹äººã®äºˆç´„è©³ç´°ï¼‰
        const reservationDetails = { ...baseDetails, ...cachedData };

        // è¬›åº§å›ºæœ‰æƒ…å ±ã‚’å–å¾—å®Œäº†å¾Œã«ç”»é¢ã‚’è¡¨ç¤º
        getScheduleInfoFromCache(
          reservationData.date,
          reservationData.classroom,
        ).then(scheduleInfo => {
          // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ±å–å¾—å®Œäº†å¾Œã«ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
          window.stateManager.dispatch({
            type: 'SET_STATE',
            payload: {
              view: 'accounting',
              accountingReservation: d,
              accountingReservationDetails: reservationDetails,
              accountingScheduleInfo: scheduleInfo,
            },
          });

          // ãƒ“ãƒ¥ãƒ¼é·ç§»å¾Œã«åˆæœŸè¨ˆç®—ã‚’å®Ÿè¡Œï¼ˆDOMæ§‹ç¯‰å®Œäº†ã‚’ç¢ºå®Ÿã«å¾…ã¤ï¼‰
          setTimeout(() => {
            // ä¼šè¨ˆãƒ•ã‚©ãƒ¼ãƒ ã®DOMæ§‹ç¯‰å®Œäº†ã‚’ç¢ºèªã—ã¦ã‹ã‚‰è¨ˆç®—å®Ÿè¡Œ
            const form = document.getElementById('accounting-form');
            if (form) {
              calculateAccountingDetails(); // UIæ›´æ–°ã‚‚å«ã‚€çµ±ä¸€é–¢æ•°ã‚’ä½¿ç”¨
            } else {
              // DOMãŒã¾ã æ§‹ç¯‰ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚‚ã†å°‘ã—å¾…ã¤
              setTimeout(() => {
                calculateAccountingDetails(); // UIæ›´æ–°ã‚‚å«ã‚€çµ±ä¸€é–¢æ•°ã‚’ä½¿ç”¨
              }, 100);
            }
          }, 300);
          hideLoading();
        });
      } else {
        hideLoading();
        showInfo('äºˆç´„ãƒ»è¨˜éŒ²æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      }
    },

    /** å±¥æ­´ã‹ã‚‰ä¼šè¨ˆè©³ç´°ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤ºã—ã¾ã™ï¼ˆãƒ‡ãƒ¼ã‚¿ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—æ¸ˆã¿ï¼‰ */
    showHistoryAccounting: d => {
      const details = JSON.parse(d.details);
      const tuitionItemsHtml = details.tuition.items
        .map(i => `<li>${i.name}: ${i.price.toLocaleString()}å††</li>`)
        .join('');
      const salesItemsHtml = details.sales.items
        .map(i => `<li>${i.name}: ${i.price.toLocaleString()}å††</li>`)
        .join('');
      const message = `
              <div class="p-4 bg-brand-light rounded-lg text-left space-y-4 text-base">
                  ${tuitionItemsHtml ? `<b>æˆæ¥­æ–™</b><ul class="list-disc list-inside">${tuitionItemsHtml}</ul>` : ''}
                  ${salesItemsHtml ? `<b class="mt-1 inline-block">è²©å£²</b><ul class="list-disc list-inside">${salesItemsHtml}</ul>` : ''}
                  <div class="font-bold mt-1 pt-1 border-t">åˆè¨ˆ: ${details.grandTotal.toLocaleString()}å††</div><div class="text-right text-sm pt-1">æ”¯æ‰•æ–¹æ³•: ${details.paymentMethod}</div></div>`;
      showInfo(message, 'ä¼šè¨ˆè¨˜éŒ²');
    },

    /** ãã‚ãã‚«ãƒ¼ãƒ‰ã‹ã‚‰ä¼šè¨ˆæ¸ˆã¿å†…å®¹ã‚’ä¿®æ­£ã—ã¾ã™ */
    editAccountingRecord: d => {
      const reservationId = d.reservationId;

      // ãã‚ãã‹ã‚‰å¯¾è±¡ã®äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const reservationData = findReservationById(reservationId);

      if (!reservationData) {
        showInfo('äºˆç´„ãƒ»è¨˜éŒ²æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
        return;
      }

      // æ—¢å­˜ã®ä¼šè¨ˆãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸå€¤ã¨ã—ã¦è¨­å®š
      const existingAccountingDetails = reservationData.accountingDetails || {};

      // äºˆç´„å›ºæœ‰æƒ…å ±ï¼ˆå€‹äººã®äºˆç´„è©³ç´°ï¼‰
      const reservationDetails = {
        firstLecture: reservationData.firstLecture || false,
        chiselRental: reservationData.chiselRental || false,
        [window.HEADERS?.RESERVATIONS?.START_TIME || 'startTime']:
          reservationData[window.HEADERS?.RESERVATIONS?.START_TIME] ||
          reservationData.startTime ||
          null,
        [window.HEADERS?.RESERVATIONS?.END_TIME || 'endTime']:
          reservationData[window.HEADERS?.RESERVATIONS?.END_TIME] ||
          reservationData.endTime ||
          null,
        // æ—¢å­˜ã®ä¼šè¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦åæ˜ 
        ...existingAccountingDetails,
      };

      showConfirm({
        title: 'ä¼šè¨ˆå†…å®¹ã®ä¿®æ­£',
        message:
          'ã“ã®æ“ä½œã«ã‚ˆã‚Šã€ç¾åœ¨ã®ä¼šè¨ˆè¨˜éŒ²ã¯å‰Šé™¤ã•ã‚Œã€æ–°ã—ã„å†…å®¹ã§å†ç™»éŒ²ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ',
        confirmText: 'ä¿®æ­£ã™ã‚‹',
        cancelText:
          window.stateManager.getState().constants?.messages?.CANCEL ||
          'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
        onConfirm: () => {
          // è¬›åº§å›ºæœ‰æƒ…å ±ã‚’å–å¾—å®Œäº†å¾Œã«ç”»é¢ã‚’è¡¨ç¤º
          getScheduleInfoFromCache(
            reservationData.date,
            reservationData.classroom,
          ).then(scheduleInfo => {
            // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ±å–å¾—å®Œäº†å¾Œã«ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
            window.stateManager.dispatch({
              type: 'SET_STATE',
              payload: {
                view: 'accounting',
                accountingReservation: d,
                accountingReservationDetails: reservationDetails,
                accountingScheduleInfo: scheduleInfo,
                isEditingAccountingRecord: true,
              },
            });

            // ãƒ“ãƒ¥ãƒ¼é·ç§»å¾Œã«åˆæœŸè¨ˆç®—ã‚’å®Ÿè¡Œï¼ˆDOMæ§‹ç¯‰å®Œäº†ã‚’ç¢ºå®Ÿã«å¾…ã¤ï¼‰
            setTimeout(() => {
              // ä¼šè¨ˆãƒ•ã‚©ãƒ¼ãƒ ã®DOMæ§‹ç¯‰å®Œäº†ã‚’ç¢ºèªã—ã¦ã‹ã‚‰è¨ˆç®—å®Ÿè¡Œ
              const form = document.getElementById('accounting-form');
              if (form) {
                calculateAccountingDetails(); // UIæ›´æ–°ã‚‚å«ã‚€çµ±ä¸€é–¢æ•°ã‚’ä½¿ç”¨
              } else {
                // DOMãŒã¾ã æ§‹ç¯‰ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚‚ã†å°‘ã—å¾…ã¤
                setTimeout(() => {
                  calculateAccountingDetails(); // UIæ›´æ–°ã‚‚å«ã‚€çµ±ä¸€é–¢æ•°ã‚’ä½¿ç”¨
                }, 100);
              }
            }, 300);
          });
        },
      });
    },

    /** ä¼šè¨ˆç”»é¢ã§ææ–™å…¥åŠ›è¡Œã‚’è¿½åŠ ã—ã¾ã™ */
    addMaterialRow: () => {
      const container = document.getElementById('materials-container');
      const newIndex = container.querySelectorAll(
        'div[data-material-row-index]',
      ).length;
      const newRow = document.createElement('div');
      newRow.className = 'mt-4 pt-4 border-t border-ui-border-light';
      newRow.dataset.materialRowIndex = newIndex;
      newRow.innerHTML = Components.materialRow({ index: newIndex });
      container.appendChild(newRow);
    },

    /** ä¼šè¨ˆç”»é¢ã§ãã®ä»–è²©å£²å“å…¥åŠ›è¡Œã‚’è¿½åŠ ã—ã¾ã™ */
    addOtherSalesRow: () => {
      const container = document.getElementById('other-sales-container');
      const newIndex = container.querySelectorAll(
        'div[data-other-sales-row]',
      ).length;
      // Components.otherSalesRowãŒè¿”ã™HTMLæ–‡å­—åˆ—ã‚’ã€ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ä»‹ã•ãšç›´æ¥ã‚³ãƒ³ãƒ†ãƒŠã®æœ«å°¾ã«è¿½åŠ ã™ã‚‹
      container.insertAdjacentHTML(
        'beforeend',
        Components.otherSalesRow({ index: newIndex }),
      );
    },

    /** ä¼šè¨ˆç”»é¢ã§åˆè¨ˆé‡‘é¡ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ */
    copyGrandTotal: button => {
      const totalText =
        document.getElementById('grand-total-amount')?.textContent || '';
      const numericTotal = totalText.replace(/[^0-9-]/g, '');
      actionHandlers.copyToClipboard(button, numericTotal);
    },

    /** æŒ‡å®šã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ */
    copyToClipboard: (button, text) => {
      const textToCopy = text || button.dataset.copyText;
      const textArea = document.createElement('textarea');
      textArea.style.position = 'fixed';
      textArea.style.top = '-9999px';
      textArea.style.left = '-9999px';
      textArea.value = textToCopy.replace(/,/g, '');
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          const originalText = button.textContent;
          button.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ!';
          setTimeout(() => {
            button.textContent = originalText;
          }, 2000);
        } else {
          showInfo('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      } catch (err) {
        showInfo('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯é–‹ç™ºç’°å¢ƒã§ã®ã¿å‡ºåŠ›
        if (typeof console !== 'undefined' && console.error) {
          console.error('Clipboard copy failed:', err);
        }
      }
      document.body.removeChild(textArea);
    },

    /** å‚åŠ è¨˜éŒ²ã‚’è¿½åŠ ã§èª­ã¿è¾¼ã¿ã¾ã™ï¼ˆçµ±åˆãƒ›ãƒ¼ãƒ ç”¨ï¼‰ */
    loadMoreHistory: () => {
      const newCount =
        (stateManager.getState().recordsToShow ||
          UI?.HISTORY_INITIAL_RECORDS ||
          10) + (UI?.HISTORY_LOAD_MORE_RECORDS || 10);
      window.stateManager.dispatch({
        type: 'SET_STATE',
        payload: { recordsToShow: newCount },
      });
    },

    /** æ–°è¦äºˆç´„ã®ãŸã‚ã®æ•™å®¤é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™ */
    showClassroomModal: () => {
      if (
        stateManager.getState().classrooms &&
        stateManager.getState().classrooms.length > 0
      ) {
        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã‚ã‚Œã°å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
        const existingModal = document.getElementById(
          'classroom-selection-modal',
        );
        if (existingModal) {
          existingModal.remove();
        }

        // æ–°ã—ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ç”Ÿæˆãƒ»è¿½åŠ 
        const modalHtml = getClassroomSelectionModal();
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        Components.showModal('classroom-selection-modal');

        // ãƒ‡ãƒãƒƒã‚°ç”¨: ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒœã‚¿ãƒ³ã‚’ç¢ºèª
        if (!window.isProduction) {
          setTimeout(() => {
            const modalButtons = document.querySelectorAll(
              '#classroom-selection-modal [data-action="selectClassroom"]',
            );
            console.log('ğŸ”˜ ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ãƒœã‚¿ãƒ³æ•°:', modalButtons.length);
            modalButtons.forEach((btn, index) => {
              console.log(`ğŸ”˜ ãƒœã‚¿ãƒ³${index + 1}:`, {
                action: btn.dataset.action,
                classroomName: btn.dataset.classroomName,
                classroom: btn.dataset.classroom,
                text: btn.textContent,
              });
            });
          }, 100);
        }
      } else {
        // æ•™å®¤æƒ…å ±ãŒãªã„å ´åˆã¯ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        showInfo('æ•™å®¤æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã€‚');
        actionHandlers.goBackToDashboard();
      }
    },

    /** æ•™å®¤é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¾ã™ */
    closeClassroomModal: () => {
      Components.closeModal('classroom-selection-modal');
    },

    /** ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ç”»é¢ã«é·ç§»ã—ã¾ã™ */
    goToEditProfile: () => {
      // ãƒ‡ãƒ¼ã‚¿ãŒå¤ãã€ã‹ã¤æ›´æ–°ä¸­ã§ãªã‘ã‚Œã°ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      if (
        !stateManager.getState().isDataFresh &&
        !stateManager.getState()._dataUpdateInProgress
      ) {
        updateAppStateFromCache('editProfile');
      } else {
        // æ–°ã—ã„dispatchãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨
        if (window.stateManager) {
          window.stateManager.dispatch({
            type: 'CHANGE_VIEW',
            payload: { view: 'editProfile' },
          });
        } else {
          window.stateManager.dispatch({
            type: 'SET_STATE',
            payload: { view: 'editProfile' },
          });
        }
      }
    },

    /** æ•™å®¤ã‚’é¸æŠã—ã€äºˆç´„æ ä¸€è¦§ç”»é¢ã«é·ç§»ã—ã¾ã™ */
    selectClassroom: d => {
      if (!window.isProduction) {
        debugLog(`=== selectClassroomå‘¼ã³å‡ºã—: d=${JSON.stringify(d)} ===`);
      }

      // ãƒ‡ãƒ¼ã‚¿å–å¾—ã®è¤‡æ•°ã®æ–¹æ³•ã‚’è©¦è¡Œ
      let classroomName = null;

      if (d && d.classroomName) {
        classroomName = d.classroomName;
      } else if (d && d.classroom) {
        classroomName = d.classroom;
      } else if (d && d['classroom-name']) {
        classroomName = d['classroom-name'];
      }

      if (!window.isProduction) {
        debugLog(`=== æ•™å®¤å: ${classroomName} ===`);
        debugLog(`=== ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼: ${Object.keys(d || {})} ===`);
      }

      if (classroomName) {
        if (!window.isProduction) {
          debugLog(`=== æ•™å®¤åå–å¾—æˆåŠŸ: ${classroomName} ===`);
        }
        // æ•™å®¤é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        actionHandlers.closeClassroomModal();
        // å¸¸ã«updateSlotsAndGoToBookingã‚’å‘¼ã³å‡ºã—ï¼ˆå†…éƒ¨ã§é®®åº¦ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œï¼‰
        actionHandlers.updateSlotsAndGoToBooking(classroomName);
      } else {
        if (!window.isProduction) {
          debugLog(`=== æ•™å®¤åå–å¾—å¤±æ•—: d=${JSON.stringify(d)} ===`);
        }
        showInfo('äºˆç´„æ ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      }
    },

    /** ã‚¹ãƒ­ãƒƒãƒˆæƒ…å ±ã‚’æ›´æ–°ã—ã¦ã‹ã‚‰äºˆç´„æ ç”»é¢ã«é·ç§»ã—ã¾ã™ï¼ˆè¨­è¨ˆæ›¸æº–æ‹ ï¼‰ */
    updateSlotsAndGoToBooking: classroomName => {
      // æ›´æ–°ä¸­ã®å ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
      if (stateManager.getState()._dataUpdateInProgress) {
        return;
      }

      // ä¸€åº¦ã ã‘ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤º
      showLoading('dataFetch');

      google.script.run
        .withSuccessHandler(versionResponse => {
          if (versionResponse.success && versionResponse.data) {
            const currentSlotsVersion = stateManager.getState()._slotsVersion;
            const serverSlotsVersion = versionResponse.data.slotsComposite;

            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåŒã˜ï¼ˆãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›´ãªã—ï¼‰ã§ã€æ—¢ã«ã‚¹ãƒ­ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯å³åº§ã«é·ç§»
            if (
              currentSlotsVersion === serverSlotsVersion &&
              stateManager.getState().slots &&
              stateManager.getState().slots.length > 0
            ) {
              hideLoading();
              window.stateManager.dispatch({
                type: 'SET_STATE',
                payload: {
                  selectedClassroom: classroomName,
                  view: 'booking',
                  isDataFresh: true,
                },
              });
              return;
            }

            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç•°ãªã‚‹å ´åˆã€ã¾ãŸã¯åˆå›ã®å ´åˆã¯æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯ç¶™ç¶šï¼‰
            actionHandlers.fetchLatestSlotsData(
              classroomName,
              serverSlotsVersion,
            );
          } else {
            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯å¤±æ•—æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿å–å¾—ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯ç¶™ç¶šï¼‰
            actionHandlers.fetchLatestSlotsData(classroomName, null);
          }
        })
        .withFailureHandler(error => {
          // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿å–å¾—ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯ç¶™ç¶šï¼‰
          actionHandlers.fetchLatestSlotsData(classroomName, null);
        })
        .getCacheVersions();
    },

    /** æœ€æ–°ã®ç©ºãæ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ï¼ˆå†…éƒ¨å‡¦ç†ï¼‰ */
    fetchLatestSlotsData: (classroomName, newSlotsVersion) => {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯æ—¢ã«è¦ªé–¢æ•°ã§è¡¨ç¤ºæ¸ˆã¿

      google.script.run
        .withSuccessHandler(response => {
          hideLoading();

          // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ç„¡åŠ¹åŒ–ï¼‰
          if (!window.isProduction) {
            debugLog('fetchLatestSlotsData ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡');
            debugLog('response.success: ' + response.success);
            debugLog('response.data: ' + (response.data ? 'ã‚ã‚Š' : 'ãªã—'));
          }
          if (response.data) {
            debugLog(
              'response.data.slots: ' +
                (response.data.slots
                  ? `${response.data.slots.length}ä»¶`
                  : 'ãªã—'),
            );
          }

          debugLog(
            `=== getBatchData ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${JSON.stringify(response)} ===`,
          );
          debugLog(
            `=== ãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´°: success=${response?.success}, hasData=${!!response?.data}, hasSlots=${!!response?.data?.slots} ===`,
          );

          if (response.success && response.data && response.data.slots) {
            debugLog(`ç©ºãæ ãƒ‡ãƒ¼ã‚¿æ›´æ–°: ${response.data.slots.length}ä»¶`);
            // ç©ºãæ ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’æ›´æ–°
            window.stateManager.dispatch({
              type: 'SET_STATE',
              payload: {
                slots: response.data.slots,
                selectedClassroom: classroomName,
                view: 'booking',
                isDataFresh: true,
                _slotsVersion: newSlotsVersion, // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’ä¿å­˜
              },
            });
          } else {
            debugLog('ç©ºãæ ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—');
            debugLog(`=== å¤±æ•—ã®è©³ç´°: response=${JSON.stringify(response)} ===`);
            if (response.message) {
              debugLog('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + response.message);
            }
            showInfo(
              'äºˆç´„æ ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
            );
          }
        })
        .withFailureHandler(error => {
          hideLoading();
          showInfo(
            'äºˆç´„æ ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
          );
          Logger.log(`fetchLatestSlotsDataã‚¨ãƒ©ãƒ¼: ${error}`);
        })
        .getBatchData(['slots'], stateManager.getState().currentUser.phone);
    },

    /** äºˆç´„æ ã‚’é¸æŠã—ã€äºˆç´„ç¢ºèªç”»é¢ã«é·ç§»ã—ã¾ã™ */
    bookSlot: d => {
      const foundSlot = stateManager
        .getState()
        .slots.find(s => s.classroom === d.classroom && s.date === d.date);
      if (foundSlot) {
        // ç©ºå¸­æ•°ã«åŸºã¥ã„ã¦isFullçŠ¶æ…‹ã‚’ç¢ºå®Ÿã«è¨­å®š
        const isFullSlot =
          foundSlot.isFull ||
          foundSlot.availableSlots === 0 ||
          (typeof foundSlot.morningSlots !== 'undefined' &&
            foundSlot.morningSlots === 0 &&
            foundSlot.afternoonSlots === 0);
        window.stateManager.dispatch({
          type: 'SET_STATE',
          payload: {
            selectedSlot: {
              ...foundSlot,
              isFull: isFullSlot,
            },
            view: 'newReservation',
          },
        });
      } else {
        showInfo('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚é¸æŠã—ãŸäºˆç´„æ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
      }
    },

    /** ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚Šã¾ã™ï¼ˆé›»è©±ç•ªå·å…¥åŠ›å€¤ã‚’ä¿å­˜ï¼‰ */
    goBackToLogin: () => {
      const phoneInput = document.getElementById('phone');
      const loginPhone = phoneInput
        ? phoneInput.value
        : stateManager.getState().loginPhone;
      window.stateManager.dispatch({
        type: 'NAVIGATE',
        payload: { to: 'login', context: { loginPhone: loginPhone } },
      });
    },

    /** ãƒ›ãƒ¼ãƒ ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰ã«é·ç§»ï¼ˆåˆ¥åï¼‰ */
    goBackToDashboard: () => actionHandlers.goToDashboard(),

    /** ãƒ›ãƒ¼ãƒ ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰ã«é·ç§» */
    goToDashboard: () => {
      if (
        !stateManager.getState().isDataFresh &&
        !stateManager.getState()._dataUpdateInProgress
      ) {
        updateAppStateFromCache('dashboard');
      } else {
        window.stateManager.dispatch({
          type: 'SET_STATE',
          payload: { view: 'dashboard' },
        });
      }
    },

    /** äºˆç´„æ ä¸€è¦§ç”»é¢ã«æˆ»ã‚Šã¾ã™ */
    goBackToBooking: () => {
      const targetClassroom =
        stateManager.getState().selectedSlot?.classroom ||
        stateManager.getState().accountingReservation?.classroom ||
        stateManager.getState().editingReservationDetails?.classroom;

      // ã‚¹ãƒ­ãƒƒãƒˆæƒ…å ±ã®é®®åº¦ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦å¿…è¦ã«å¿œã˜ã¦æ›´æ–°
      if (
        !stateManager.getState().isDataFresh &&
        !stateManager.getState()._dataUpdateInProgress
      ) {
        actionHandlers.updateSlotsAndGoToBooking(targetClassroom);
      } else {
        window.stateManager.dispatch({
          type: 'SET_STATE',
          payload: {
            view: 'booking',
            selectedClassroom: targetClassroom,
          },
        });
      }
    },

    /** ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ç¢ºèªãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†ã§ã™ */
    modalConfirm: () => {
      ModalManager.executeCallback();
      hideModal();
    },

    /** ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†ã§ã™ */
    modalCancel: () => hideModal(),
  };

  /**
   * ä¼šè¨ˆã®ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
   */
  actionHandlers.showAccountingConfirmation = () => {
    const accountingDetails = calculateAccountingDetails();
    if (!accountingDetails || accountingDetails.grandTotal <= 0) {
      showInfo('åˆè¨ˆé‡‘é¡ãŒ0å††ã§ã™ã€‚é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    const message = `
          <div class="p-4 bg-brand-light rounded-lg text-left space-y-4 text-base" id="modal-accounting-form">
              <div>
                  <span class="font-bold">åˆè¨ˆé‡‘é¡:</span> ${accountingDetails.grandTotal.toLocaleString()}å††
                  <button data-action="copyGrandTotal" class="ml-2 text-sm bg-action-secondary-bg active:bg-action-secondary-hover text-action-secondary-text font-bold px-2 py-1 rounded">ã‚³ãƒ”ãƒ¼</button>
              </div>
              <div>
                  <span class="font-bold">æ”¯æ‰•ã„æ–¹æ³•:</span>
                  <div class="mt-2 space-y-3">
                      ${getPaymentOptionsHtml()}
                  </div>
              </div>
              <div class="mt-4">
                  <button id="confirm-payment-button" data-action="confirmAndPay" class="w-full bg-action-primary-bg text-action-primary-text font-bold py-2 rounded disabled:bg-brand-muted" disabled>ã“ã®å†…å®¹ã§æ”¯æ‰•ã„ã¾ã—ãŸ</button>
              </div>
              <p class="text-red-700 font-bold mt-2 text-center">å¿…ãšãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­</p>
          </div>
      `;
    showModal({
      title: 'ãŠä¼šè¨ˆ',
      message: message,
      showCancel: true,
      cancelText:
        window.stateManager.getState().constants?.messages?.CANCEL ||
        'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
      onConfirm: null,
    });
  };

  /**
   * ã€Œã“ã®å†…å®¹ã§æ”¯æ‰•ã„ã¾ã—ãŸã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
   */
  actionHandlers.confirmAndPay = () => {
    const reservationId =
      stateManager.getState().accountingReservation.reservationId;
    // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®æ”¯æ‰•ã„æ–¹æ³•ã‚’å–å¾—
    const modalForm = document.getElementById('modal-accounting-form');
    let paymentMethod = PAYMENT.CASH;
    if (modalForm) {
      const selected = modalForm.querySelector(
        'input[name="payment-method"]:checked',
      );
      if (selected) paymentMethod = selected.value;
    }

    // --- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«é€ä¿¡ã™ã‚‹ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ ---
    const form = document.getElementById('accounting-form');
    const userInput = {
      paymentMethod: paymentMethod,
      tuitionItems: [],
      salesItems: [],
      timeBased: null,
    };

    // æˆæ¥­æ–™é …ç›®ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰
    form
      .querySelectorAll(
        `input[type="checkbox"][data-item-type="${C.itemTypes.TUITION}"]:checked`,
      )
      .forEach(cb => {
        userInput.tuitionItems.push(cb.dataset.itemName);
      });

    // æ™‚é–“åˆ¶æˆæ¥­æ–™
    if (document.getElementById('start-time')) {
      const accountingReservation = stateManager.getState().accountingReservation;
      const startTime = getTimeValue(
        'start-time',
        accountingReservation,
        'startTime',
      );
      const endTime = getTimeValue('end-time', accountingReservation, 'endTime');

      userInput.timeBased = {
        startTime: startTime,
        endTime: endTime,
        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã®äº’æ›æ€§ã®ãŸã‚ã€ãƒ˜ãƒƒãƒ€ãƒ¼å½¢å¼ã‚‚ä½µè¨˜
        [window.HEADERS?.RESERVATIONS?.START_TIME || 'startTime']: startTime,
        [window.HEADERS?.RESERVATIONS?.END_TIME || 'endTime']: endTime,
        breakMinutes: parseInt(
          document.getElementById('break-time')?.value || 0,
          10,
        ),
        discountApplied:
          document.getElementById('discount-checkbox')?.checked || false,
      };
    }

    // ç‰©è²©ãƒ»ææ–™è²»é …ç›®
    const materialContainer = document.getElementById('materials-container');
    if (materialContainer) {
      materialContainer
        .querySelectorAll('div[data-material-row-index]')
        .forEach((row, index) => {
          const name = document.getElementById(`material-type-${index}`)?.value;
          const priceText =
            document.getElementById(`material-price-${index}`)?.textContent ||
            '0';
          const price = parseInt(priceText.replace(/[^0-9]/g, ''), 10);
          if (name && price > 0)
            userInput.salesItems.push({ name: name, price: price });
        });
    }

    // ç‰©è²©é …ç›®ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰
    form
      .querySelectorAll(
        `input[type="checkbox"][data-item-type="${C.itemTypes.SALES}"]:checked`,
      )
      .forEach(cb => {
        userInput.salesItems.push({ name: cb.dataset.itemName });
      });

    form.querySelectorAll('div[data-other-sales-row]').forEach((row, index) => {
      const name = document
        .getElementById(`other-sales-name-${index}`)
        ?.value.trim();
      const price = document.getElementById(`other-sales-price-${index}`)?.value;
      if (name && price)
        userInput.salesItems.push({ name: name, price: Number(price) });
    });
    // --- ã“ã“ã¾ã§ ---

    const payload = {
      reservationId: stateManager.getState().accountingReservation.reservationId,
      classroom: stateManager.getState().accountingReservation.classroom,
      studentId: stateManager.getState().currentUser.studentId,
      userInput: userInput,
    };

    showLoading('accounting');
    google.script.run
      .withSuccessHandler(r => {
        if (r.success) {
          clearAccountingCache(reservationId); // <-- ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤
          hideModal(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
          hideLoading();

          // ä¼šè¨ˆå®Œäº†å¾Œã¯å®Œäº†ç”»é¢ã«é·ç§»
          if (r.data) {
            // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã•ã‚ŒãŸå ´åˆ
            window.stateManager.dispatch({
              type: 'SET_STATE',
              payload: {
                ...r.data.initialData,
                myReservations: r.data.myReservations || [],
                slots: r.data.slots || [],
                view: 'complete',
                completionMessage: 'ä¼šè¨ˆæƒ…å ±ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚',
                isDataFresh: true, // æœ€æ–°ãƒ‡ãƒ¼ã‚¿å—ä¿¡æ¸ˆã¿
              },
            });
          } else {
            // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã•ã‚Œãªã‹ã£ãŸå ´åˆã§ã‚‚å®Œäº†ç”»é¢ã«é·ç§»
            const currentState = window.stateManager.getState();
            window.stateManager.dispatch({
              type: 'SET_STATE',
              payload: {
                view: 'complete',
                completionMessage: 'ä¼šè¨ˆæƒ…å ±ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚',
                myReservations: currentState.myReservations || [],
                isDataFresh: false, // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿å¿…è¦
              },
            });
          }
        } else {
          hideLoading();
          showInfo(r.message || 'ä¼šè¨ˆæƒ…å ±ã®è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      })
      .withFailureHandler(handleServerError)
      .saveAccountingDetailsAndGetLatestData(payload);
  };

  // =================================================================
  // --- Phone Number Formatting Helper Functions ---
  // -----------------------------------------------------------------
  // é›»è©±ç•ªå·å…¥åŠ›ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ•´å½¢å‡¦ç†
  // =================================================================

  /**
   * é›»è©±ç•ªå·å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ•´å½¢å‡¦ç†
   * @param {HTMLInputElement} inputElement - é›»è©±ç•ªå·å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
   */
  function handlePhoneInputFormatting(inputElement) {
    if (!inputElement) return;

    const originalValue = inputElement.value;
    const cursorPosition = inputElement.selectionStart;

    // å…¨è§’æ•°å­—ã‚’åŠè§’ã«å¤‰æ›
    let formattedValue = originalValue.replace(/[ï¼-ï¼™]/g, s =>
      String.fromCharCode(s.charCodeAt(0) - 65248),
    );

    // æ•°å­—ä»¥å¤–ã‚’å‰Šé™¤ï¼ˆãƒã‚¤ãƒ•ãƒ³ã¯ä¸€æ™‚çš„ã«æ®‹ã™ï¼‰
    const digitsOnly = formattedValue.replace(/[^\d]/g, '');

    // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé©ç”¨
    let formatted = '';
    if (digitsOnly.length > 0) {
      if (digitsOnly.length <= 3) {
        formatted = digitsOnly;
      } else if (digitsOnly.length <= 7) {
        formatted = `${digitsOnly.slice(0, 3)}-${digitsOnly.slice(3)}`;
      } else if (digitsOnly.length <= 11) {
        if (digitsOnly.length === 10) {
          // 10æ¡ã®å ´åˆ: 03-1234-5678
          formatted = `${digitsOnly.slice(0, 2)}-${digitsOnly.slice(2, 6)}-${digitsOnly.slice(6)}`;
        } else {
          // 11æ¡ã®å ´åˆ: 090-1234-5678
          formatted = `${digitsOnly.slice(0, 3)}-${digitsOnly.slice(3, 7)}-${digitsOnly.slice(7)}`;
        }
      } else {
        // 11æ¡ã‚’è¶…ãˆã‚‹å ´åˆã¯11æ¡ã¾ã§ã«åˆ¶é™
        const truncated = digitsOnly.slice(0, 11);
        formatted = `${truncated.slice(0, 3)}-${truncated.slice(3, 7)}-${truncated.slice(7)}`;
      }
    }

    // å€¤ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿æ›´æ–°
    if (formatted !== originalValue) {
      inputElement.value = formatted;

      // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’èª¿æ•´ï¼ˆãƒã‚¤ãƒ•ãƒ³ã®è¿½åŠ ã‚’è€ƒæ…®ï¼‰
      const newCursorPosition = Math.min(
        cursorPosition + (formatted.length - originalValue.length),
        formatted.length,
      );
      inputElement.setSelectionRange(newCursorPosition, newCursorPosition);
    }
  }

  // =================================================================
  // --- Main Application Logic ---
  // -----------------------------------------------------------------
  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã€ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã€çŠ¶æ…‹ç®¡ç†ã€ç”»é¢æç”»ãªã©ã€
  // å…¨ä½“ã‚’åˆ¶å¾¡ã™ã‚‹ã‚³ã‚¢ã¨ãªã‚‹é–¢æ•°ç¾¤ã§ã™ã€‚
  // =================================================================

  /**
   * æ³¨æ„: setStateé–¢æ•°ã¯StateManagerã‚·ã‚¹ãƒ†ãƒ ã«çµ±åˆã•ã‚Œã¾ã—ãŸ
   * æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã§ã¯ stateManager.dispatch() ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
   *
   * ä¸‹ä½äº’æ›æ€§ã®ãŸã‚ã®setStateé–¢æ•°ã¯12_WebApp_StateManager.htmlã§å®šç¾©ã•ã‚Œã€
   * è‡ªå‹•çš„ã«StateManagerã®dispatch()ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¾ã™
   */

  /**
   * ãƒãƒƒãƒå‡¦ç†ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦appStateã‚’æ›´æ–°
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®äºˆç´„ãƒ»å±¥æ­´ãƒ»ã‚¹ãƒ­ãƒƒãƒˆæƒ…å ±ã‚’ä¸€æ‹¬å–å¾—ã—ã€æŒ‡å®šã•ã‚ŒãŸãƒ“ãƒ¥ãƒ¼ã«é·ç§»
   * @param {string} targetView - ãƒ‡ãƒ¼ã‚¿å–å¾—å¾Œã«é·ç§»ã—ãŸã„ãƒ“ãƒ¥ãƒ¼å
   */
  function updateAppStateFromCache(targetView) {
    if (
      !stateManager.getState().currentUser ||
      !stateManager.getState().currentUser.phone
    ) {
      if (targetView) {
        window.stateManager.dispatch({
          type: 'SET_STATE',
          payload: { view: targetView },
        });
      }
      return;
    }

    // æ›´æ–°ä¸­ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
    window.stateManager.dispatch({
      type: 'SET_STATE',
      payload: { _dataUpdateInProgress: true },
    });

    showLoading('æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
    google.script.run
      .withSuccessHandler(response => {
        hideLoading();
        window.stateManager.dispatch({
          type: 'SET_STATE',
          payload: { _dataUpdateInProgress: false },
        }); // ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢

        if (response.success && response.userFound) {
          // ãƒãƒƒãƒå‡¦ç†çµæœã‹ã‚‰appStateã‚’æ›´æ–°
          const newAppState = processInitialData(
            response.data.initial,
            stateManager.getState().currentUser.phone,
            response.data.slots,
          );
          // ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã¨é‡è¦ãªçŠ¶æ…‹ã¯ä¿æŒã€ãŸã ã—targetViewãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãã¡ã‚‰ã‚’å„ªå…ˆ
          const preservedState = {
            view: targetView || stateManager.getState().view,
            selectedClassroom: stateManager.getState().selectedClassroom,
            selectedSlot: stateManager.getState().selectedSlot,
            editingReservationDetails:
              stateManager.getState().editingReservationDetails,
            accountingReservation: stateManager.getState().accountingReservation,
            isDataFresh: true, // æ–°é®®ãªãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã“ã¨ã‚’è¨˜éŒ²
          };
          window.stateManager.dispatch({
            type: 'SET_STATE',
            payload: { ...newAppState, ...preservedState },
          }); // setStateã«çµ±åˆã—ã€çŠ¶æ…‹æ›´æ–°ã¨å†æç”»ã‚’ä¸€å…ƒåŒ–
        } else {
          // å¤±æ•—æ™‚ã‚‚setStateã‚’ä»‹ã—ã¦çŠ¶æ…‹ã‚’æ›´æ–°ã—ã€å†æç”»ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹
          window.stateManager.dispatch({
            type: 'SET_STATE',
            payload: {
              _dataUpdateInProgress: false,
              view: targetView || stateManager.getState().view,
            },
          });
          showInfo(response.message || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      })
      .withFailureHandler(err => {
        hideLoading();
        window.stateManager.dispatch({
          type: 'SET_STATE',
          payload: {
            _dataUpdateInProgress: false,
            view: targetView || stateManager.getState().view,
          },
        }); // ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
        handleServerError(err);
        // setStateãŒrenderã‚’å‘¼ã³å‡ºã™ã®ã§ã€ã“ã“ã§ã®render()ã¯ä¸è¦
      })
      .getBatchData(
        ['initial', 'slots'],
        stateManager.getState().currentUser.phone,
      );
  }

  /**
   * ç¾åœ¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã«åŸºã¥ã„ã¦ã€é©åˆ‡ãªãƒ“ãƒ¥ãƒ¼ã‚’æç”»ã™ã‚‹
   * ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®å¿…è¦æ€§ã‚’åˆ¤å®šã—ã€å¿…è¦ã«å¿œã˜ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—å¾Œã«å†æç”»
   * stateManager.getState().viewã®å€¤ã«å¿œã˜ã¦å¯¾å¿œã™ã‚‹ãƒ“ãƒ¥ãƒ¼é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦UIã‚’æ›´æ–°
   */
  function render() {
    // appStateã®å®‰å…¨ãªå‚ç…§ç¢ºèª
    const appState = window.stateManager?.getState();
    if (!appState) {
      console.warn('render(): stateManagerãŒæœªåˆæœŸåŒ–ã®ãŸã‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
      return;
    }

    console.log('ğŸ¨ renderå®Ÿè¡Œ:', appState.view);

    // ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’é¿ã‘ã‚‹ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿æ›´æ–°å‡¦ç†ã¯å‰Šé™¤
    // å˜ç´”ã«ãƒ“ãƒ¥ãƒ¼ã‚’æç”»ã™ã‚‹ã ã‘

    let v = '';
    switch (appState.view) {
      case 'login':
        v = getLoginView();
        break;
      case 'register':
        v = getRegisterView(appState.registrationPhone);
        break;
      case 'registrationStep2':
        v = getRegistrationStep2View();
        break;
      case 'registrationStep3':
        v = getRegistrationStep3View();
        break;
      case 'registrationStep4':
        v = getRegistrationStep4View();
        break;
      case 'dashboard':
        v = getDashboardView();
        break;
      case 'editProfile':
        v = getEditProfileView();
        break;
      case 'booking':
        v = getBookingView(appState.selectedClassroom);
        break;
      case 'newReservation':
        v = getReservationFormView('new');
        break;
      case 'editReservation':
        v = getReservationFormView('edit');
        break;
      case 'accounting':
        v = getAccountingView();
        break;
      case 'complete':
        v = getCompleteView(appState.completionMessage);
        break;
      case 'userSearch':
        v = getUserSearchView();
        break;
    }
    document.getElementById('view-container').innerHTML =
      `<div class="fade-in">${v}</div>`;

    // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«æ›´æ–°
    const backButtonContainer = document.getElementById('back-button-container');
    if (backButtonContainer) {
      backButtonContainer.innerHTML = Components.createSmartBackButton(
        appState.view,
        appState,
      );
    }

    // ä¼šè¨ˆç”»é¢ã®å ´åˆã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    if (appState.view === 'accounting') {
      // DOMæ›´æ–°å¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹ãŸã‚ã€æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§å®Ÿè¡Œ
      requestAnimationFrame(() => {
        setupAccountingEventListeners();
        // åˆæœŸè¨ˆç®—ã‚‚å®Ÿè¡Œ
        updateAccountingCalculation();
      });
    }

    window.scrollTo(0, 0);
  }

  /**
   * ä¼šè¨ˆç”»é¢ã§ã®å…¥åŠ›å¤‰æ›´ã‚’å‡¦ç†ã—ã¾ã™ã€‚
   * åˆè¨ˆé‡‘é¡ã®å†è¨ˆç®—ã¨ã€å…¥åŠ›å†…å®¹ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ã‚’è¡Œã„ã¾ã™ã€‚
   */
  function handleAccountingFormChange() {
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åˆè¨ˆé‡‘é¡ã‚’å†è¨ˆç®—
    calculateAccountingDetails();

    // ãƒ•ã‚©ãƒ¼ãƒ å†…å®¹ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã™ã‚‹
    const reservationId =
      stateManager.getState().accountingReservation?.reservationId;
    if (reservationId) {
      const accountingData = getAccountingFormData();
      saveAccountingCache(reservationId, accountingData);
    }
  }

  /**
   * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ç‚¹ã§ã™ã€‚
   * ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å®Ÿè¡Œã•ã‚Œã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
   */
  window.onload = function () {
    const app = document.getElementById('app');

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼é–¢æ•°ã‚’å®šç¾©
    const handleClick = e => {
      // ã€ä¿®æ­£ã€‘buttonã¾ãŸã¯data-actionå±æ€§ã‚’æŒã¤è¦ç´ ã‚’å¯¾è±¡ã«ã™ã‚‹
      const targetElement = e.target.closest('button, [data-action]');
      if (targetElement?.dataset.action) {
        const { action, ...data } = targetElement.dataset;

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¿½åŠ 
        if (!window.isProduction) {
          console.log('ğŸ”˜ ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ:', {
            action,
            data,
            element: targetElement,
            tagName: targetElement.tagName,
            modalContext: e.target.closest('[data-modal-content]')
              ? 'ãƒ¢ãƒ¼ãƒ€ãƒ«å†…'
              : 'é€šå¸¸',
            timestamp: new Date().getTime(),
            eventPhase: e.eventPhase,
          });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®å ´åˆã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’ç¶™ç¶šã™ã‚‹
        if (
          e.target.closest('[data-modal-content]') &&
          targetElement.dataset.action
        ) {
          // ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’åœæ­¢ã—ãªã„ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹ï¼‰
        }

        if (action === 'copyToClipboard' || action === 'copyGrandTotal') {
          actionHandlers[action](targetElement);
        } else if (actionHandlers[action]) {
          actionHandlers[action](data);
        } else {
          // ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ãƒ‡ãƒãƒƒã‚°
          if (!window.isProduction) {
            console.warn('âš ï¸ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', action);
          }
        }
      }
    };

    // ã‚¢ãƒ—ãƒªè¦ç´ ã¨documentä¸¡æ–¹ã§ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ•æ‰ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å¯¾å¿œï¼‰
    // é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ã€documentãƒ¬ãƒ™ãƒ«ã®ã¿ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
    document.addEventListener('click', handleClick);

    // ã‚¢ãƒ—ãƒªå…¨ä½“ã®å…¥åŠ›ãƒ»å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ•æ‰
    app.addEventListener('change', e => {
      // ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã®æ”¯æ‰•ã„æ–¹æ³•é¸æŠ
      if (
        e.target.matches('#modal-accounting-form input[name="payment-method"]')
      ) {
        document
          .getElementById('confirm-payment-button')
          ?.removeAttribute('disabled');

        // é¸æŠã•ã‚ŒãŸæ”¯æ‰•æ–¹æ³•ã«å¿œã˜ã¦æƒ…å ±ã‚’å‹•çš„ã«æ›´æ–°
        const selectedPaymentMethod = e.target.value;
        const paymentInfoContainer = document.getElementById(
          'payment-info-container',
        );
        if (paymentInfoContainer) {
          paymentInfoContainer.innerHTML = getPaymentInfoHtml(
            selectedPaymentMethod,
          );
        }
      }

      // ä¼šè¨ˆç”»é¢ã§ã®å¤‰æ›´ï¼ˆä¸»ã« select ã‚„ checkboxï¼‰
      const accountingForm = e.target.closest('#accounting-form');
      if (stateManager.getState().view === 'accounting' && accountingForm) {
        handleAccountingFormChange();

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
        if (!window.isProduction) {
          console.log('ğŸ”„ ä¼šè¨ˆãƒ•ã‚©ãƒ¼ãƒ å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ:', {
            element: e.target.name || e.target.id,
            value: e.target.value,
            checked: e.target.checked,
          });
        }
      }

      // æ–°è¦ç™»éŒ²Step3ã§ã®çµŒé¨“æœ‰ç„¡ã«ã‚ˆã‚‹è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      if (e.target.name === 'experience') {
        const pastWorkContainer = document.getElementById('past-work-container');
        if (pastWorkContainer) {
          pastWorkContainer.classList.toggle(
            'hidden',
            e.target.value === 'ã¯ã˜ã‚ã¦ï¼',
          );
        }
      }
    });

    // ã‚¢ãƒ—ãƒªå…¨ä½“ã®å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ•æ‰ï¼ˆä¸»ã« text ã‚„ textareaï¼‰
    app.addEventListener('input', e => {
      // ä¼šè¨ˆç”»é¢ã§ã®å¤‰æ›´
      const accountingForm = e.target.closest('#accounting-form');
      if (stateManager.getState().view === 'accounting' && accountingForm) {
        handleAccountingFormChange();
      }

      // é›»è©±ç•ªå·å…¥åŠ›ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ•´å½¢
      if (e.target.id === 'phone' || e.target.id === 'edit-phone') {
        handlePhoneInputFormatting(e.target);
      }
    });

    // åˆæœŸç”»é¢ã‚’æç”»
    render();
  };

</script>
    
    <!-- çŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  -->
    
    <!-- ä¸­æ ¸æ©Ÿèƒ½ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ -->
    
    <!-- UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ -->
    
    <!-- ç”»é¢ç”Ÿæˆé–¢æ•° -->
    
    <!-- ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->

    <script>
      // ç’°å¢ƒåˆ¤å®šï¼šæœ¬ç•ªç’°å¢ƒã‹ãƒ†ã‚¹ãƒˆç’°å¢ƒã‹ã‚’ç¢ºèª
      const isProduction =
        window.location.href.includes('/exec?') ||
        (window.location.href.includes('/macros/s/') &&
          !window.location.href.includes('/dev'));

      // ãƒ‡ãƒãƒƒã‚°åˆ¶å¾¡ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å°‚ç”¨ï¼‰
      const DEBUG_ENABLED = false; // æœ¬ç•ªç’°å¢ƒã§ã¯ false

      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã™ã‚‹é–¢æ•°ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ç„¡åŠ¹åŒ–ï¼‰
      function debugLog(message) {
        if (isProduction || !DEBUG_ENABLED) return; // æœ¬ç•ªç’°å¢ƒã§ã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
        console.log(
          'ğŸ” [DEBUG]',
          new Date().toLocaleTimeString() + ':',
          message,
        );
      }

      // æœ€åˆã®ãƒ†ã‚¹ãƒˆ - ã“ã‚ŒãŒè¡¨ç¤ºã•ã‚Œãªã‘ã‚Œã°HTMLãƒ•ã‚¡ã‚¤ãƒ«è‡ªä½“ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„
      debugLog('HTMLãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç¢ºèªãƒ†ã‚¹ãƒˆå®Œäº†');
      debugLog('ãƒšãƒ¼ã‚¸URL: ' + window.location.href);

      // GASç’°å¢ƒã‹ã©ã†ã‹ã‚’åˆ¤å®š
      const isGAS =
        typeof google !== 'undefined' && typeof google.script !== 'undefined';
      debugLog('GASç’°å¢ƒåˆ¤å®š: ' + isGAS);

      function initializeApp() {
        debugLog('initializeAppå®Ÿè¡Œé–‹å§‹');
        debugLog('isGAS: ' + isGAS);

        // å¿…è¦ãªå¤‰æ•°ã‚„é–¢æ•°ãŒå®šç¾©ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
        const checkReady = setInterval(() => {
          const status = {
            DesignConfig: typeof DesignConfig !== 'undefined',
            stateManager: typeof stateManager !== 'undefined',
            stateManagerDispatch: typeof stateManager?.dispatch === 'function',
            hideLoading: typeof hideLoading === 'function',
          };

          debugLog('åˆæœŸåŒ–æ¡ä»¶ãƒã‚§ãƒƒã‚¯: ' + JSON.stringify(status));

          // DesignConfig, stateManager, hideLoadingãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèª
          if (
            typeof DesignConfig !== 'undefined' &&
            typeof stateManager !== 'undefined' &&
            typeof stateManager?.dispatch === 'function' &&
            typeof hideLoading === 'function'
          ) {
            clearInterval(checkReady);
            debugLog('åˆæœŸåŒ–æ¡ä»¶ã‚’æº€ãŸã—ã¾ã—ãŸï¼');
            debugLog(
              'stateManager.getState().slots: ' +
                (stateManager.getState().slots
                  ? stateManager.getState().slots.length + 'ä»¶'
                  : 'null'),
            );
            debugLog(
              'stateManager.getState().classrooms: ' +
                JSON.stringify(stateManager.getState().classrooms),
            );

            window.stateManager.dispatch({
              type: 'SET_STATE',
              payload: { view: 'login' },
            });
            hideLoading();
          }
        }, 300);
      }

      if (isGAS) {
        // GASæœ¬ç•ªç’°å¢ƒã®ã¿åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', () => {
          initializeApp();
        });
      }
    </script>
  </body>
</html>
