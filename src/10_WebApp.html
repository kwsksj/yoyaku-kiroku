<!--
=================================================================
【ファイル名】: 10_WebApp.html
【バージョン】: 26.0 (モジュール化対応版)
【更新日時】: 2025-08-04
【説明】:
- 設定とモック機能を外部ファイルに分離
- より保守性の高い構造に改善
- テスト環境とプロダクション環境の分離
=================================================================
-->
<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <base target="_top" />
    <title>きぼりの よやく・きろく 川崎誠二木彫り教室</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
  </head>

  <body class="bg-brand-bg min-h-screen">
    <!-- デバッグ情報表示エリア -->
    <div
      id="debug"
      class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 text-xs"
    >
      <strong>デバッグ情報:</strong>
      <div
        id="debug-content"
        class="mt-2 max-h-32 overflow-y-auto border border-red-300 bg-red-50 p-2 rounded text-xs"
      >
        初期化中...
      </div>
    </div>

    <!-- アプリケーションのメインコンテナ -->
    <div id="app" class="container mx-auto px-4 max-w-lg">
      <!-- ローディング画面 -->
      <div
        id="loading"
        class="fixed inset-0 bg-brand-bg flex flex-col items-center justify-center z-50"
      >
        <div class="spinner mb-4"></div>
        <p id="loading-message" class="text-brand-text">
          アプリケーションを読み込み中...
        </p>
      </div>

      <!-- メインコンテンツ -->
      <main id="main-content" class="hidden py-6">
        <div id="view-container"></div>
      </main>

      <!-- モーダルオーバーレイ -->
      <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
          <div id="modal-body"></div>
        </div>
      </div>

      <!-- カスタムモーダル -->
      <div
        id="custom-modal"
        class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50"
      >
        <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
          <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
          <div id="modal-message" class="mb-6"></div>
          <div id="modal-buttons" class="flex gap-3 justify-end"></div>
        </div>
      </div>
      <footer class="text-center text-sm text-brand-muted mt-4">
        きぼりの よやく・きろく
      </footer>
    </div>

    <!-- GAS環境用のJavaScriptファイル読み込み（テンプレート評価対応） -->
    <?!= include('11_WebApp_Config'); ?>
    <!-- 設定・定数 -->
    <?!= include('12_WebApp_StateManager'); ?>
    <!-- 状態管理システム -->
    <?!= include('12_WebApp_Core'); ?>
    <!-- 中核機能・ユーティリティ -->
    <?!= include('13_WebApp_Components'); ?>
    <!-- UIコンポーネント -->
    <?!= include('13_WebApp_Views'); ?>
    <!-- 画面生成関数 -->
    <?!= include('14_WebApp_Handlers'); ?>
    <!-- イベント処理・アクション -->

    <script>
      // 環境判定：本番環境かテスト環境かを確認
      const isProduction = window.location.href.includes('/exec?') || 
                           window.location.href.includes('/macros/s/') && 
                           !window.location.href.includes('/dev');

      // デバッグ情報を画面に表示する関数（本番環境では無効化）
      function debugLog(message) {
        if (isProduction) return; // 本番環境では何も表示しない
        
        const debugContent = document.getElementById('debug-content');
        if (debugContent) {
          debugContent.innerHTML +=
            '<br>' + new Date().toISOString() + ': ' + message;
        }
      }

      // 最初のテスト - これが表示されなければHTMLファイル自体が読み込まれていない
      debugLog('HTMLファイル読み込み確認テスト完了');
      debugLog('ページURL: ' + window.location.href);

      // GAS環境かどうかを判定
      const isGAS =
        typeof google !== 'undefined' && typeof google.script !== 'undefined';
      debugLog('GAS環境判定: ' + isGAS);

      function initializeApp() {
        debugLog('initializeApp実行開始');
        debugLog('isGAS: ' + isGAS);

        // 必要な変数や関数が定義されるまで待機
        const checkReady = setInterval(() => {
          const status = {
            DesignConfig: typeof DesignConfig !== 'undefined',
            stateManager: typeof stateManager !== 'undefined',
            stateManagerDispatch: typeof stateManager?.dispatch === 'function',
            hideLoading: typeof hideLoading === 'function',
          };

          debugLog('初期化条件チェック: ' + JSON.stringify(status));

          // DesignConfig, stateManager, hideLoadingが利用可能か確認
          if (
            typeof DesignConfig !== 'undefined' &&
            typeof stateManager !== 'undefined' &&
            typeof stateManager?.dispatch === 'function' &&
            typeof hideLoading === 'function'
          ) {
            clearInterval(checkReady);
            debugLog('初期化条件を満たしました！');
            debugLog(
              'stateManager.getState().slots: ' +
                (stateManager.getState().slots
                  ? stateManager.getState().slots.length + '件'
                  : 'null'),
            );
            debugLog(
              'stateManager.getState().classrooms: ' +
                JSON.stringify(stateManager.getState().classrooms),
            );

            window.stateManager.dispatch({
              type: 'SET_STATE',
              payload: { view: 'login' },
            });
            hideLoading();
          }
        }, 100);
      }

      if (isGAS) {
        // GAS本番環境のみ初期化
        window.addEventListener('DOMContentLoaded', () => {
          initializeApp();
        });
      }
    </script>
  </body>
</html>
