<script>
  /**
   * =================================================================
   * 【ファイル名】: 13_WebApp_Views.html
   * 【バージョン】: 1.9
   * 【役割】: WebAppの各画面（ビュー）のHTML構造を生成する関数群を集約します。
   * - 各関数は特定の画面（ログイン、予約一覧など）のUI構築を担当します。
   * - appStateの現在の状態に基づき、動的にHTMLを生成します。
   * 【構成】: 14ファイル構成でのビュー管理
   * 【v1.9での変更点】:
   * - FE-14: 会計画面の入力保持機能を実装。
   *   - getAccountingViewでキャッシュされたデータをフォームの初期値として設定するよう修正。
   * =================================================================
   */

  // =================================================================
  // --- View Helper Components ---
  // -----------------------------------------------------------------
  // 各ビューを構成するための、より小さな部品を生成するヘルパー関数群。
  // =================================================================

  /**
   * 時刻選択用の<option>タグ群を生成します。
   * @param {number} startHour - 開始時刻（時）
   * @param {number} endHour - 終了時刻（時）
   * @param {number} step - 間隔（分）
   * @param {string | null} selectedValue - 事前に選択する時刻 (HH:mm)
   * @returns {string} HTMLの<option>タグ文字列
   */
  const getTimeOptionsHtml = (startHour, endHour, step, selectedValue) => {
    let options = [];
    for (let h = startHour; h <= endHour; h++) {
      for (let m = 0; m < 60; m += step) {
        const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        options.push(`<option value="${time}" ${time === selectedValue ? 'selected' : ''}>${time}</option>`);
      }
    }
    return options.join('');
  };

  /**
   * 割引選択用のUIを生成します。
   * @param {object} discountRule - 料金マスタから取得した割引ルールオブジェクト
   * @param {string} selectedValue - 選択済みの値
   * @returns {string} HTML文字列
   */
  const getDiscountHtml = (discountRule, selectedValue) => {
    if (!discountRule) return '';
    const options = [
      { value: C.frontendUi.DISCOUNT_OPTIONS.NONE, text: 'なし' },
      { value: C.frontendUi.DISCOUNT_OPTIONS.THIRTY_MIN, text: `30分 (${Math.abs(Number(discountRule['単価']))}円引)` },
      {
        value: C.frontendUi.DISCOUNT_OPTIONS.SIXTY_MIN,
        text: `60分 (${Math.abs(Number(discountRule['単価'])) * 2}円引)`,
      },
    ];
    return `
        <div class="mt-4 pt-4 border-t border-ui-border-light">
            <label class="${DesignConfig.text.labelBlock}">${discountRule['項目名']}</label>
            <select id="discount-selector" name="discountMinutes" class="${DesignConfig.inputs.base} p-2 text-base accounting-item">
                ${options.map(o => `<option value="${o.value}" ${String(o.value) === selectedValue ? 'selected' : ''}>${o.text}</option>`).join('')}
            </select>
        </div>`;
  };

  /**
   * 支払い情報（ことら送金、振込先）の表示UIを生成します。
   * @returns {string} HTML文字列
   */
  const getPaymentInfoHtml = () => {
    return `
        <div class="bg-ui-surface border border-ui-border p-3 rounded-md">
            <div class="flex justify-between items-center">
                <div class="${DesignConfig.text.body}"><span class="font-bold">${PAYMENT.COTRA}:</span><span class="ml-2">${BANK.COTRA_PHONE}</span></div>
                <button data-action="copyToClipboard" data-copy-text="${BANK.COTRA_PHONE}" class="flex-shrink-0 text-sm bg-action-secondary-bg active:bg-action-secondary-hover text-action-secondary-text font-bold px-2 py-1 rounded mobile-button">コピー</button>
            </div>
        </div>
        <div class="bg-ui-surface border border-ui-border p-3 rounded-md">
            <div class="text-brand-text"><span class="font-bold">振込先:</span><span class="ml-2">${BANK.NAME}</span></div>
            <div class="mt-1 flex justify-between items-center">
                <div class="text-base text-brand-text">店番: ${BANK.BRANCH}</div>
                <button data-action="copyToClipboard" data-copy-text="${BANK.BRANCH}" class="text-sm bg-action-secondary-bg active:bg-action-secondary-hover text-action-secondary-text font-bold px-2 py-1 rounded mobile-button">コピー</button>
            </div>
            <div class="mt-1 flex justify-between items-center">
                <div class="text-base text-brand-text">普通: ${BANK.ACCOUNT}</div>
                <button data-action="copyToClipboard" data-copy-text="${BANK.ACCOUNT}" class="text-sm bg-action-secondary-bg active:bg-action-secondary-hover text-action-secondary-text font-bold px-2 py-1 rounded mobile-button">コピー</button>
            </div>
        </div>`;
  };

  /**
   * 支払い方法の選択肢（ラジオボタン）UIを生成します。
   * @param {string} selectedValue - 選択済みの支払い方法
   * @returns {string} HTML文字列
   */
  const getPaymentOptionsHtml = selectedValue => {
    const cotraDetails = `
        <details class="mt-2 ml-6">
            <summary class="inline-block px-2 py-1 bg-ui-warning-light text-ui-warning-text text-sm font-semibold rounded-md active:bg-ui-warning-bg">
                ことら送金とは？ <span class="arrow">▼</span>
            </summary>
            <p class="mt-2 p-2 bg-ui-warning-bg rounded-md text-sm text-left text-brand-subtle">
                電話番号だけで銀行口座間で送金できるサービスです。手数料無料。対応の銀行アプリから利用できます。<br>
                (例：ゆうちょ通帳アプリ、三井住友銀行アプリ、住信SBIネット銀行アプリなど)
                <a href="https://www.cotra.ne.jp/member/" target="_blank" class="text-ui-link-text">対応アプリ一覧</a>
            </p>
        </details>`;
    const options = [
      {
        value: PAYMENT.CASH,
        text: PAYMENT.CASH,
        details: '',
      },
      {
        value: PAYMENT.COTRA,
        text: PAYMENT.COTRA,
        details: cotraDetails,
      },
      {
        value: PAYMENT.BANK_TRANSFER,
        text: PAYMENT.BANK_TRANSFER,
        details: '',
      },
    ];
    return (
      options
        .map(
          (opt, i) => `
        <div>
            <label class="flex items-center space-x-2 text-brand-text">
                <input type="radio" name="payment-method" value="${opt.value}" class="accounting-item accent-action-primary-bg" ${opt.value === selectedValue ? 'checked' : ''}>
                <span>${opt.text}</span>
            </label>
            ${opt.details}
        </div>`,
        )
        .join('') +
      `
        <div class="mt-4 space-y-2 text-base">${getPaymentInfoHtml()}</div>`
    );
  };

  /**
   * 会計画面の材料入力行を生成します。
   * @param {number} index - 材料行のインデックス
   * @param {object} [data={}] - 初期データ
   * @returns {string} HTML文字列
   */
  const buildMaterialRow = (index, data = {}) => {
    const materialOptions = appState.accountingMaster
      .filter(m => m['種別'] === ITEM_TYPE_MATERIAL)
      .map(m => `<option value="${m['項目名']}" ${data.type === m['項目名'] ? 'selected' : ''}>${m['項目名']}</option>`)
      .join('');
    return `
        <div data-material-row-index="${index}">
            <div class="grid grid-cols-1 gap-y-2">
                <select id="material-type-${index}" name="materialType${index}" class="${DesignConfig.inputs.base} accounting-item">
                    <option value="">-- 樹種を選択 --</option>
                    ${materialOptions}
                </select>
            </div>
            <div class="grid grid-cols-4 gap-2 mt-2 items-center">
                <input type="number" id="material-l-${index}" name="materialL${index}" value="${data.l || ''}" placeholder="縦(mm)" step="5" class="${DesignConfig.inputs.base} accounting-item custom-placeholder">
                <input type="number" id="material-w-${index}" name="materialW${index}" value="${data.w || ''}" placeholder="横(mm)" step="5" class="${DesignConfig.inputs.base} accounting-item custom-placeholder">
                <input type="number" id="material-h-${index}" name="materialH${index}" value="${data.h || ''}" placeholder="厚(mm)" step="5" class="${DesignConfig.inputs.base} accounting-item custom-placeholder">
                <div id="material-price-${index}" class="text-right text-base text-brand-subtle">0円</div>
            </div>
        </div>`;
  };

  /**
   * 会計画面の「その他販売品」入力行を生成します。
   * @param {number} index - 入力行のインデックス
   * @param {object} [data={}] - 初期データ
   * @returns {string} HTML文字列
   */
  const getOtherSalesRowHtml = (index, data = {}) => {
    return `
        <div data-other-sales-row="${index}" class="mt-2 pt-2 border-t border-ui-border grid grid-cols-3 gap-2 items-center">
            <input type="text" id="other-sales-name-${index}" name="otherSalesName${index}" value="${data.name || ''}" placeholder="商品名" class="col-span-2 ${DesignConfig.inputs.base} accounting-item">
            <input type="text" inputmode="decimal" id="other-sales-price-${index}" name="otherSalesPrice${index}" value="${data.price || ''}" placeholder="金額" class="${DesignConfig.inputs.base} accounting-item">
        </div>`;
  };

  /**
   * 予約・履歴カード用の共通カード構造を生成します。
   * @param {object} config - カード設定オブジェクト
   * @returns {string} HTML文字列
   */
  const createReservationCard = config => {
    const {
      type, // 'booking' | 'history'
      item,
      today,
      buttons = [],
    } = config;

    const isBooking = type === 'booking';
    const venueText = item.venue || '';
    const isPastOrToday = isBooking ? new Date(item.date).getTime() <= today.getTime() : true;

    // 時刻表示の生成
    let timeText = '';
    if (item.startTime && item.endTime) {
      timeText = `<span>${item.startTime} - ${item.endTime}</span>`;
    }

    let cardColorClass = 'bg-ui-surface border border-ui-border';
    if (isBooking) {
      const cardColor = item.isWaiting ? DesignConfig.cards.state.waitlist : DesignConfig.cards.state.booked;
      cardColorClass = cardColor.card;
    } else if (type === 'history') {
      cardColorClass = DesignConfig.cards.state.history.card;
    }

    // 制作メモ部分の背景色
    const memoBackgroundClass = isBooking ? 'bg-ui-surface' : 'bg-ui-surface';

    // ステータス表示（予約のみ）
    let statusBadges = '';
    if (isBooking) {
      if (item.firstLecture) {
        statusBadges += `<p class="font-bold text-action-attention-bg text-lg">初回講習</p>`;
      }
      if (item.isWaiting) {
        statusBadges += `<p class="font-bold ${DesignConfig.cards.state.waitlist.text} text-lg">キャンセル待ち</p>`;
      }
      // キャンセル済みstatus は予約・履歴どちらでも表示（英語・日本語両方に対応）
      const isCancelled =
        item.status === STATUS.CANCEL || item.status === 'キャンセル' || item.status === 'キャンセル済み';
      if (isCancelled) {
        statusBadges += `<p class="font-bold text-ui-error-text text-lg">キャンセル済</p>`;
      }
    }

    // ボタン部分の生成
    const buttonsHtml = buttons
      .map(btn =>
        Components.createButton({
          action: btn.action,
          classroom: btn.classroom || item.classroom,
          reservationId: btn.reservationId || item.reservationId,
          date: btn.date || item.date,
          sheetName: btn.sheetName || item.sheetName,
          details: btn.details,
          text: btn.text,
          colorClass: btn.colorClass,
        }),
      )
      .join('');

    return `
      <div class="${cardColorClass || 'bg-ui-surface border border-ui-border'} p-3 rounded-lg flex flex-col space-y-3">
        <div class="flex-shrink-0">
          <div >
            <span class="text-brand-text font-bold text-base sm:text-xl">${formatDate(item.date || '')} </span>
            <span class="text-brand-text text-base time-display">${timeText || ''}</span>
          </div>
          <p class="text-brand-text font-bold text-base break-words">${item.classroom || ''} ${venueText || ''}</p>
          ${statusBadges || ''}
        </div>
        <div class="${memoBackgroundClass || 'bg-ui-surface'} p-3 rounded-md w-full border border-ui-border">
          <div class="w-full min-h-[3rem] flex items-start">
            <p class="text-base text-brand-text whitespace-pre-wrap break-words w-full leading-relaxed">${item.workInProgress != null && item.workInProgress !== '' ? item.workInProgress : `<span class="text-brand-muted">制作メモ</span>`}</p>
          </div>
        </div>
        ${buttonsHtml ? `<div class="flex justify-end items-center space-x-2 flex-shrink-0">${buttonsHtml}</div>` : ''}
      </div>
    `;
  };

  /**
   * 参加記録編集用のモーダルウィンドウの中身を生成します。
   * @param {object} item - 編集対象の履歴オブジェクト
   * @returns {string} HTML文字列
   */
  const buildMemoEditModal = item => {
    return `
        <p class="text-base ${DesignConfig.colors.textSubtle} mb-4">${formatDate(item.date)}  ${item.classroom}</p>
        <textarea id="memo-edit-textarea" class="${DesignConfig.inputs.textarea} h-32" placeholder="制作メモを入力…">${item.workInProgress || ''}</textarea>
    `;
  };

  /**
   * 時間制教室の授業料計算UIを生成します。
   * @param {object} rule - 料金マスタから取得した教室ルール
   * @param {object} initial - 初期値（開始時刻など）
   * @returns {string} HTML文字列
   */
  const getTimeBasedTuitionHtml = (rule, initial) => {
    if (
      !rule ||
      typeof rule['講座開始'] !== 'string' ||
      typeof rule['講座終了'] !== 'string' ||
      !rule['講座開始'].includes(':') ||
      !rule['講座終了'].includes(':')
    ) {
      return `<div class="text-ui-error-text p-4 bg-ui-error-bg rounded-lg">エラー: この教室の講座時間がマスタに正しく設定されていません。</div>`;
    }
    const classStart = parseInt(rule['講座開始'].split(':')[0]);
    const classEnd = parseInt(rule['講座終了'].split(':')[0]);
    const endBuffer = 3;

    const breakOptions = [...Array(5).keys()]
      .map(
        i =>
          `<option value="${i * 30}" ${String(i * 30) === (initial.breakTime || '0') ? 'selected' : ''}>${i * 30}分</option>`,
      )
      .join('');

    const startTimeOptions = getTimeOptionsHtml(classStart, classEnd + endBuffer, 30, initial.startTime);
    const endTimeOptions = getTimeOptionsHtml(classStart, classEnd + endBuffer, 30, initial.endTime);

    const rentalChecked = initial.chiselRental || initial['彫刻刀レンタル'] === true ? 'checked' : '';

    const discountRule = appState.accountingMaster.find(item => item['項目名'] === C.items.DISCOUNT);
    const discountHtml = discountRule
      ? `<div class="mt-4 pt-4 border-t border-gray-200">${getDiscountHtml(discountRule, initial.discountMinutes || '0')}<p class="text-sm ${DesignConfig.colors.textSubtle} mt-2 text-left">${discountRule.説明 || '初回講習と同時刻に参加の場合、30分あたり¥300割引。ただし、初回講習参加者がいる場合のみ'}</p></div>`
      : '';

    return `
        <div class="p-4 ${DesignConfig.cards.background} rounded-lg space-y-3">
            <h3 class="${DesignConfig.text.heading} mb-2">授業料</h3>
            <div class="grid grid-cols-3 gap-2 items-end">
                ${Components.createSelect({ id: 'start-time', name: 'startTime', label: '開始時刻', containerClass: 'col-span-1', options: startTimeOptions })}
                ${Components.createSelect({ id: 'end-time', name: 'endTime', label: '終了時刻', containerClass: 'col-span-1', options: endTimeOptions })}
                ${Components.createSelect({ id: 'break-time', name: 'breakTime', label: '休憩時間', containerClass: 'col-span-1', options: breakOptions })}
            </div>
            <div id="calculated-hours" class="text-left text-base ${DesignConfig.colors.textSubtle} mt-2"></div>
            <div class="pt-3 mt-3 border-t border-gray-200">
                <label class="flex items-center justify-between">
                    <span class="text-brand-text">${C.items.CHISEL_RENTAL}</span>
                    <input type="checkbox" name="chiselRental" data-item-type="${C.itemTypes.TUITION}" data-item-name="${C.items.CHISEL_RENTAL}" class="accounting-item h-5 w-5 rounded border-ui-border text-brand-text focus:ring-brand-text" ${rentalChecked}>
                </label>
            </div>
            ${discountHtml}
            <div id="tuition-breakdown" class="mt-4 pt-4 border-t border-ui-border space-y-1 text-base ${DesignConfig.colors.textSubtle}"></div>
            <div class="text-right font-bold mt-2" id="tuition-subtotal">小計: 0円</div>
        </div>`;
  };

  // =================================================================
  // --- Main Application Views ---
  // -----------------------------------------------------------------
  // アプリケーションの各画面の完全なHTML構造を生成する関数群。
  // =================================================================

  /**
   * ログイン画面のUIを生成します。
   * @returns {string} HTML文字列
   */
  const getLoginView = () => {
    const phoneValue = appState.loginPhone || '';
    return `
      <div class="text-center pt-8 pb-4">
          <h1 class="text-3xl font-bold text-brand-text tracking-tight">きぼりの<br>よやく・きろく</h1>
          <h2 class="text-xl text-brand-subtle mt-2 mb-10">川崎誠二 木彫り教室</h2>
      </div>
      ${Components.createInput({ id: 'phone', label: '電話番号', type: 'tel', placeholder: '090 1234 5678', containerClass: DesignConfig.inputs.container, autocomplete: 'tel', isSrOnly: false, labelClass: `block text-brand-subtle text-sm text-center mb-1`, inputClass: 'text-center', inputmode: 'numeric', pattern: '[0-9]*', value: phoneValue })}
      <p id="phone-display" class="text-brand-subtle text-lg mt-2">${formatPhoneDisplay(phoneValue)}</p>
      <div class="mt-6 flex justify-center">
          <div class="${DesignConfig.inputs.container}">
              ${Components.createButton({ text: 'ログイン または 新規登録', action: 'login', colorClass: DesignConfig.colors.primary, widthClass: DesignConfig.buttons.full })}
          </div>
      </div>`;
  };

  /**
   * ユーザー情報入力フォーム（新規登録・プロフィール編集共通）
   * @param {Object} config - 設定オブジェクト
   * @param {string} config.mode - 'register' または 'edit'
   * @param {string} [config.phone] - 電話番号（新規登録時）
   * @returns {string} HTML文字列
   */
  const getUserFormView = config => {
    const { mode, phone } = config;
    const isEdit = mode === 'edit';
    const u = appState.currentUser || {};

    // 入力値の保持: 新規登録Step1ではappState.registrationDataを参照
    let regData = appState.registrationData || {};
    const realNameValue = isEdit ? u.realName || '' : regData.realName || '';
    const nicknameValue = isEdit ? u.displayName || '' : regData.nickname || '';
    const phoneValue = isEdit ? appState.registrationPhone || u.phone || '' : regData.phone || phone || '';

    // 電話番号表示の判定
    const isPhoneInputNeeded = isEdit && (appState.registrationPhone || !u.phone);

    // タイトルと説明文
    const title = isEdit ? 'プロフィール編集' : '新規登録';
    const description = isEdit ? '' : '<p class="text-brand-subtle mb-6">お名前を登録してください。</p>';

    // 電話番号セクション
    let phoneSection = '';
    if (!isEdit) {
      // 新規登録時：電話番号を表示のみ
      phoneSection = `
        <div class="mb-4">
            <label class="block text-brand-text text-base font-bold mb-2">電話番号</label>
            <input type="tel" id="reg-phone" value="${phoneValue}" class="${DesignConfig.inputs.base}" placeholder="090 1234 5678" autocomplete="tel" inputmode="numeric" pattern="[0-9]*">
            <p id="reg-phone-display" class="text-brand-subtle text-lg mt-2">${formatPhoneDisplay(phoneValue)}</p>
        </div>`;
    } else if (isPhoneInputNeeded) {
      // プロフィール編集時：電話番号入力が必要
      phoneSection = `
        <div class="mb-4">
            <label for="edit-phone" class="block text-brand-text text-base font-bold mb-2">電話番号</label>
            <input type="tel" id="edit-phone" value="${phoneValue}"
                   class="${DesignConfig.inputs.base}" placeholder="090 1234 5678"
                   autocomplete="tel" inputmode="numeric" pattern="[0-9]*">
            <p class="text-sm text-brand-subtle mt-1">電話番号を登録すると次回からスムーズにログインできます。</p>
        </div>`;
    } else {
      // プロフィール編集時：電話番号表示のみ
      phoneSection = `
        <div class="mb-4">
            <label class="block text-brand-text text-base font-bold mb-2">電話番号</label>
            <p class="font-semibold p-3 bg-ui-surface text-brand-text rounded-lg w-auto inline-block">${phoneValue}</p>
        </div>`;
    }

    // ボタン設定
    const buttons = isEdit
      ? [
          { text: 'この内容で更新', action: 'saveProfile', colorClass: DesignConfig.colors.primary },
          { text: '戻る', action: 'goBackToDashboard', colorClass: DesignConfig.colors.secondary },
        ]
      : [
          { text: '次へ進む', action: 'goToStep2', colorClass: DesignConfig.colors.primary },
          { text: '戻る', action: 'goBackToLogin', colorClass: DesignConfig.colors.secondary },
        ];

    const nameIdPrefix = isEdit ? 'edit' : 'reg';

    return `
        <div class="max-w-md mx-auto">
            <h1 class="text-xl font-bold text-brand-text mb-4">${title}</h1>
            ${description}
            <div class="space-y-4">
                ${Components.createInput({
                  id: `${nameIdPrefix}-realname`,
                  label: 'お名前',
                  type: 'text',
                  required: true,
                  value: realNameValue,
                  containerClass: '',
                  autocomplete: 'name',
                })}
                ${Components.createInput({
                  id: `${nameIdPrefix}-nickname`,
                  label: 'ニックネーム（表示名）',
                  caption: '他の生徒さんにも表示されます',
                  type: 'text',
                  value: nicknameValue,
                  placeholder: '空欄の場合はお名前',
                  containerClass: '',
                })}
                ${phoneSection}
            </div>
            <div class="mt-6">
                <div class="space-y-3">
                    ${buttons
                      .map(btn =>
                        Components.createButton({
                          text: btn.text,
                          action: btn.action,
                          colorClass: btn.colorClass,
                          widthClass: DesignConfig.buttons.full,
                        }),
                      )
                      .join('')}
                </div>
            </div>
        </div>`;
  };

  /**
   * 新規登録画面のUIを生成します。
   * @param {string} p - ログイン試行時に入力された電話番号
   * @returns {string} HTML文字列
   */
  const getRegisterView = p => getUserFormView({ mode: 'register', phone: p });

  /**
   * 新規登録フローのステップ2（プロフィール情報）のUIを生成します。
   */
  const getRegistrationStep2View = () => {
    console.log('getRegistrationStep2View called');
    console.log('DesignConfig:', typeof DesignConfig, DesignConfig);
    console.log('Components:', typeof Components, Components); // Componentsのログを追加
    const data = appState.registrationData;
    const genderOptions = ['女性', '男性', 'その他']
      .map(
        opt =>
          `<label class="flex items-center space-x-2"><input type="radio" name="gender" value="${opt}" ${data.gender === opt ? 'checked' : ''}><span class="text-brand-text">${opt}</span></label>`,
      )
      .join('');
    const handOptions = ['右利き', '左利き', '両利き']
      .map(
        opt =>
          `<label class="flex items-center space-x-2"><input type="radio" name="dominantHand" value="${opt}" ${data.dominantHand === opt ? 'checked' : ''}><span class="text-brand-text">${opt}</span></label>`,
      )
      .join('');
    const ageOptions = ['10代（16歳以上）', '20代', '30代', '40代', '50代', '60代', '70代', '80代以上', 'ひみつ']
      .map(opt => `<option value="${opt}" ${data.ageGroup === opt ? 'selected' : ''}>${opt}</option>`)
      .join('');

    return `
    <div class="max-w-md mx-auto text-left">
      <h1 class="text-xl font-bold text-brand-text mb-4 text-center">プロフィール</h1>
      <form id="step2-form" class="space-y-6">
        ${Components.createInput({ id: 'q-email', label: 'メールアドレス（必須）', type: 'email', value: data.email || '', required: true })}
        <div class="p-3 bg-ui-surface rounded-md">
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="q-wants-email" name="wantsEmail" class="h-5 w-5 accent-action-primary-bg" ${data.wantsEmail ? 'checked' : ''}>
            <span class="text-brand-text text-sm">今後の教室日程などの、メール連絡を希望します</span>
          </label>
        </div>
        ${Components.createSelect({ id: 'q-age-group', label: 'お年頃', options: ageOptions })}
        <div><label class="block text-brand-text text-base font-bold mb-2">性別</label><div class="flex space-x-4">${genderOptions}</div></div>
        <div><label class="block text-brand-text text-base font-bold mb-2">利き手</label><div class="flex space-x-4">${handOptions}</div></div>
        ${Components.createInput({ id: 'q-address', label: '住所（市区町村まででOK！）', type: 'text', value: data.address || '' })}
      </form>
      <div class="mt-8 grid grid-cols-2 gap-3">
        ${Components.createButton({ text: '前に戻る', action: 'backToStep1', colorClass: DesignConfig.colors.secondary })}
        ${Components.createButton({ text: '次へ進む', action: 'goToStep3', colorClass: DesignConfig.colors.primary })}
      </div>
    </div>
  `;
  };

  /**
   * 新規登録フローのステップ3（木彫りについて）のUIを生成します。
   */
  const getRegistrationStep3View = () => {
    const data = appState.registrationData;
    const experienceOptions = ['はじめて！', 'ちょっと', 'そこそこ', 'かなり！']
      .map(
        opt =>
          `<label class="flex items-center space-x-2"><input type="radio" name="experience" value="${opt}" ${data.experience === opt ? 'checked' : ''}><span class="text-brand-text">${opt}</span></label>`,
      )
      .join('');

    return `
    <div class="max-w-md mx-auto text-left">
      <h1 class="text-xl font-bold text-brand-text mb-4 text-center">木彫りについて</h1>
      <form id="step3-form" class="space-y-6">
        <div>
          <label class="block text-brand-text text-base font-bold mb-2">木彫りの経験はありますか？</label>
          <div class="space-y-2" id="experience-radio-group">${experienceOptions}</div>
        </div>
        <div id="past-work-container" class="${data.experience === 'はじめて！' ? 'hidden' : ''}">
            ${Components.createTextArea({ id: 'q-past-work', label: 'いつ頃、どこで、何を作りましたか？（だいたいでOK!）', value: data.pastWork || '' })}
        </div>
        ${Components.createTextArea({ id: 'q-future-goal', label: '将来的に制作したいもの（曖昧な内容でも大丈夫！）', value: data.futureGoal || '' })}
      </form>
      <div class="mt-8 flex flex-col space-y-3">
        ${Components.createButton({ text: '登録して予約へ進む', action: 'submitRegistration', colorClass: DesignConfig.colors.primary, widthClass: DesignConfig.buttons.full })}
        ${Components.createButton({ text: '前に戻る', action: 'backToStep2', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
      </div>
    </div>
  `;
  };

  /**
   * NF-01: 電話番号未登録ユーザーの検索・選択画面のUIを生成します。
   * @returns {string} HTML文字列
   */
  const getUserSearchView = () => {
    const users = appState.searchedUsers;
    // NF-01: 検索が実行され、結果が0件の場合にメッセージを表示
    const hasSearchedAndNoResults = appState.searchAttempted && users.length === 0;

    return `
        <h1 class="text-xl font-bold text-brand-text mb-4">アカウントを探す</h1>
        <p class="text-brand-subtle mb-6">お名前（本名）またはニックネームを入力して、あなたのアカウントを見つけてください。<br>
        <span class="text-sm text-brand-muted">（漢字が異なる場合や、姓と名の間が開いている場合でも、スペースを入れずに、苗字だけでも試してみてください）</span></p>

        <div class="${DesignConfig.inputs.container} mb-4">
            ${Components.createInput({
              id: 'nickname-search-input',
              label: 'お名前（本名）またはニックネーム', // ラベルを変更
              type: 'text',
              placeholder: 'お名前またはニックネーム', // プレースホルダーを変更
              inputClass: 'text-center',
              autocomplete: 'off',
            })}
            <div class="mt-4 flex justify-center">
                ${Components.createButton({
                  text: '検索',
                  action: 'searchUserByName',
                  colorClass: DesignConfig.colors.primary,
                  widthClass: DesignConfig.buttons.full,
                })}
            </div>
        </div>

        <div class="mt-8 space-y-3">
            ${
              users.length > 0
                ? `
                <h2 class="text-lg font-bold ${DesignConfig.colors.text} text-center mb-2">見つかったアカウント</h2>
                ${users
                  .map(
                    user => `
                    <div class="${DesignConfig.cards.background} p-3 rounded-lg flex justify-between items-center">
                        <p class="text-base font-semibold">${user.realName}（${user.nickname}）</p> // 本名とニックネームを両方表示
                        ${Components.createButton({
                          text: 'これだ！',
                          action: 'selectSearchedUser',
                          studentId: user.studentId,
                          realName: user.realName,
                          nickname: user.nickname,
                          colorClass:
                            'bg-state-success-bg text-state-success-text text-sm py-1 px-3 rounded active:bg-state-success-hover focus:bg-state-success-hover mobile-button',
                        })}
                    </div>
                `,
                  )
                  .join('')}
            `
                : hasSearchedAndNoResults
                  ? `
                <p class="text-center ${DesignConfig.colors.textSubtle}">一致するアカウントが見つかりませんでした。</p>
            `
                  : ''
            }
        </div>

        <div class="mt-8 pt-4 border-t border-gray-200 flex flex-col space-y-3">
            <h2 class="text-lg font-bold ${DesignConfig.colors.text} text-center mb-2">見つからない場合</h2>
            ${Components.createButton({
              text: '自分のアカウントが見つからないので、新規登録する',
              action: 'goToRegisterFromUserSearch',
              colorClass: DesignConfig.colors.primary,
              widthClass: DesignConfig.buttons.full,
            })}
            ${Components.createButton({
              text: 'ログイン画面に戻る',
              action: 'goBackToLogin',
              colorClass: DesignConfig.colors.secondary,
              widthClass: DesignConfig.buttons.full,
            })}
        </div>
    `;
  };

  /**
   * メインのダッシュボード画面のUIを生成します。
   * ユーザーの予約一覧と履歴一覧を統合表示します。
   * @returns {string} HTML文字列
   */
  const getDashboardView = () => {
    // 計算済みデータを使用（setState()で自動更新済み）
    const sortedBookings = appState.computed.sortedBookings;
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // 【改善】「あたらしく よやく する」ボタンを予約リストの先頭に配置し、デザインを分かりやすく変更
    const newBookingCardHtml = `
        <button data-action="goToClassroomSelection" class="w-full text-center p-4 rounded-lg border-2 border-dashed border-action-primary-border bg-action-primary-light active:bg-action-primary-subtle focus:bg-action-primary-subtle mobile-button touch-friendly">
            <span class="text-xl font-bold text-action-primary-bg">+ あたらしく よやく する</span>
        </button>
    `;

    const yourBookingsHtml = `
        <div class="mb-8 w-full">
            <div class="bg-ui-surface border border-ui-border p-3 rounded-lg space-y-3">
                <h2 class="text-xl font-medium text-brand-text text-center mb-2">よやく</h2>
                ${newBookingCardHtml}
                ${sortedBookings
                  .filter(b => {
                    const isCancelled =
                      b.status === STATUS.CANCEL || b.status === 'キャンセル' || b.status === 'キャンセル済み';
                    return !isCancelled; // キャンセル済み予約を念のため除外
                  })
                  .map(b => {
                    const resDate = new Date(b.date);
                    resDate.setMinutes(resDate.getMinutes() + resDate.getTimezoneOffset());
                    const isPastOrToday = resDate.getTime() <= today.getTime();

                    // ボタン配列を構築
                    const buttons = [];

                    // 会計ボタン
                    if (isPastOrToday) {
                      if (b.accountingDone) {
                        buttons.push({
                          action: 'goToAccounting',
                          text: '会計済',
                          colorClass: `${DesignConfig.colors.paid} text-base font-bold px-3 py-1.5 rounded`,
                        });
                      } else {
                        buttons.push({
                          action: 'goToAccounting',
                          text: '会計',
                          colorClass: `text-base ${DesignConfig.colors.accounting} font-bold px-3 py-1.5 rounded mobile-button`,
                        });
                      }
                    }

                    // 編集ボタン
                    if (!isPastOrToday && !b.accountingDone) {
                      buttons.push({
                        action: 'goToEditReservation',
                        text: '確認/編集',
                        colorClass:
                          'text-base bg-action-secondary-bg text-action-secondary-text font-medium px-3 py-1.5 rounded active:bg-action-secondary-hover focus:bg-action-secondary-hover mobile-button',
                      });
                    }

                    return createReservationCard({
                      type: 'booking',
                      item: b,
                      today: today,
                      buttons: buttons,
                    });
                  })
                  .join('')}
            </div>
        </div>`;

    let historyHtml = '';
    if (appState.history && appState.history.length > 0) {
      // 計算済みデータを使用
      const recordsToShow = appState.computed.displayHistory;
      historyHtml = `
            <div class="mb-8 w-full">
            <div class="bg-ui-surface border border-ui-border p-3 rounded-lg space-y-3">
                    <h2 class="text-xl font-medium text-brand-text text-center mb-2">きろく</h2>
                    ${recordsToShow
                      .filter(h => {
                        const isCancelled =
                          h.status === STATUS.CANCEL || h.status === 'キャンセル' || h.status === 'キャンセル済み';
                        return !isCancelled; // キャンセル済み予約を念のため除外
                      })
                      .map(h => {
                        // ボタン配列を構築
                        const buttons = [];

                        // 会計記録ボタン
                        if (h.accountingDetails) {
                          try {
                            const acc = JSON.parse(h.accountingDetails);
                            buttons.push({
                              action: 'showHistoryAccounting',
                              details: h.accountingDetails,
                              text: '会計記録',
                              colorClass:
                                'text-sm bg-action-paid-bg text-action-paid-text font-bold px-3 py-1.5 rounded',
                            });
                          } catch (e) {
                            // エラーハンドリングは個別に行う
                          }
                        }

                        // 編集ボタン
                        buttons.push({
                          action: 'editHistoryMemo',
                          text: '編集',
                          colorClass:
                            'text-sm bg-action-secondary-bg text-action-secondary-text font-bold px-3 py-1.5 rounded active:bg-action-secondary-hover focus:bg-action-secondary-hover mobile-button',
                        });

                        return createReservationCard({
                          type: 'history',
                          item: h,
                          today: null, // 履歴では不要
                          buttons: buttons,
                        });
                      })
                      .join('')}
                    ${(appState.recordsToShow || 10) < appState.computed.sortedHistory.length ? `<div class="text-center mt-4"><button data-action="loadMoreHistory" class="text-sm bg-action-secondary-bg text-action-secondary-text px-3 py-1.5 rounded-md active:bg-action-secondary-hover mobile-button">もっとみる</button></div>` : ''}
                </div>
            </div>
        `;
    }

    return `
        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-2">
            <h1 class="text-base sm:text-xl font-bold ${DesignConfig.colors.text} mr-4 mb-1 sm:mb-0">ようこそ <span class="text-xl whitespace-nowrap">${appState.currentUser.displayName} <span class="text-base">さん</span></span></h1>
            <button data-action="goToEditProfile" class="${DesignConfig.colors.info} self-end sm:self-auto text-sm text-action-secondary-text px-3 py-0.5 rounded-md active:bg-action-secondary-hover">Profile 編集</button>
        </div>
        ${yourBookingsHtml}
        ${historyHtml}
    `;
  };

  /**
   * 新規予約のための教室選択画面のUIを生成します。
   * @returns {string} HTML文字列
   */
  const getClassroomSelectionView = () => {
    console.log('getClassroomSelectionView - appState.classrooms:', appState.classrooms);
    console.log(
      'getClassroomSelectionView - appState.classrooms length:',
      appState.classrooms ? appState.classrooms.length : 'null/undefined',
    );
    console.log('getClassroomSelectionView - full appState:', appState);

    // デバッグ情報を画面表示用に準備
    const sampleSlots = appState.slots ? appState.slots.slice(0, 2) : [];
    const debugInfo = `
      <div style="background: #fee; border: 1px solid #fcc; padding: 10px; margin: 10px 0; font-size: 12px;">
        <strong>デバッグ情報:</strong><br>
        appState.classrooms: ${JSON.stringify(appState.classrooms)}<br>
        classrooms.length: ${appState.classrooms ? appState.classrooms.length : 'null/undefined'}<br>
        appState.slots.length: ${appState.slots ? appState.slots.length : 'null/undefined'}<br>
        appState.currentUser: ${appState.currentUser ? appState.currentUser.displayName : 'null'}<br>
        appState.view: ${appState.view}<br>
        <strong>サンプルスロットデータ（最初の2件）:</strong><br>
        ${sampleSlots.map((slot, i) => `[${i}] ${JSON.stringify(slot)}<br>`).join('')}
      </div>
    `;

    const classroomButtonsHtml = (appState.classrooms || [])
      .map(n =>
        Components.createButton({
          action: 'selectClassroom',
          classroomName: n,
          text: n,
          colorClass: `w-full h-16 text-left px-4 py-3 rounded-lg mobile-card touch-friendly transition-all duration-150 bg-state-available-bg border border-state-available-border active:bg-state-success-hover flex items-center text-xl font-bold text-brand-text`,
        }),
      )
      .join('');

    // データが取得できていない場合の表示
    if (!appState.classrooms || appState.classrooms.length === 0) {
      return `
        ${debugInfo}
        <h1 class="text-xl font-bold text-brand-text mb-4">あたらしい よやく</h1>
        <div class="max-w-md mx-auto text-center">
          <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-6">
            <strong>データ取得エラー</strong><br>
            教室情報を取得できませんでした。<br>
            ネットワーク接続またはサーバーに問題がある可能性があります。
          </div>
          <div class="space-y-3">
            ${Components.createButton({ text: 'データを再取得', action: 'reloadClassroomData', colorClass: DesignConfig.colors.primary, widthClass: DesignConfig.buttons.full })}
            ${Components.createButton({ text: '戻る', action: 'goBackToDashboard', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
          </div>
        </div>
      `;
    }

    return `
        ${debugInfo}
        <h1 class="text-xl font-bold text-brand-text mb-4">あたらしい よやく</h1>
        <p class="text-brand-subtle text-center mb-6">教室 を おえらびください</p>
        <div class="max-w-md mx-auto space-y-3">
            ${classroomButtonsHtml}
        </div>
        <div class="mt-6 max-w-md mx-auto">
            ${Components.createButton({ text: '戻る', action: 'goBackToDashboard', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
        </div>
    `;
  };

  /**
   * プロフィール編集画面のUIを生成します。
   * @returns {string} HTML文字列
   */
  const getEditProfileView = () => getUserFormView({ mode: 'edit' });

  /**
   * 予約スロットのリストからHTMLを生成します。
   * この関数は getBookingView と getCompleteView で共有されます。
   * @param {Array<object>} slots - 表示する予約スロットの配列
   * @returns {string} HTML文字列
   */
  const renderBookingSlots = slots => {
    if (!slots || slots.length === 0) {
      return '';
    }

    // 受け取ったslotsを月別にグループ化
    const slotsByMonth = slots.reduce((acc, slot) => {
      const month = new Date(slot.date).getMonth() + 1;
      if (!acc[month]) acc[month] = [];
      acc[month].push(slot);
      return acc;
    }, {});

    return Object.keys(slotsByMonth)
      .sort((a, b) => a - b)
      .map(month => {
        const monthHeader = `<h4 class="text-lg font-medium ${DesignConfig.colors.textSubtle} mt-4 mb-2 text-center">${month}月</h4>`;

        const slotsHtml = slotsByMonth[month]
          .map(sl => {
            const iB = appState.computed.sortedBookings.some(b => b.date === sl.date && b.classroom === sl.classroom);
            let cC, sB, act;
            const tag = iB ? 'div' : 'button';

            // 新しいslot構造に対応したステータステキスト生成
            let statusText;
            if (typeof sl.morningSlots !== 'undefined' && typeof sl.afternoonSlots !== 'undefined') {
              // つくば教室: 午前・午後制（統一定数を使用）
              const morningLabel = appState.constants?.sessions?.MORNING || '午前';
              const afternoonLabel = appState.constants?.sessions?.AFTERNOON || '午後';
              statusText = `${morningLabel}空き ${sl.morningSlots} | ${afternoonLabel}空き ${sl.afternoonSlots}`;
            } else if (typeof sl.availableSlots !== 'undefined') {
              // 東京教室・沼津教室: 単一セッション制
              statusText = `空き ${sl.availableSlots}`;
            } else {
              // フォールバック
              statusText = '空き状況不明';
            }

            // 初回講習の空き枠も表示
            if (sl.firstLectureSlots > 0) {
              statusText += ` | 初回 ${sl.firstLectureSlots}`;
            }

            if (iB) {
              // 予約済みの場合
              const booking = appState.computed.sortedBookings.find(
                b => b.date === sl.date && b.classroom === sl.classroom,
              );
              if (booking && booking.status === STATUS.WAITING) {
                cC = `${DesignConfig.cards.base} ${DesignConfig.cards.state.waitlist.card}`;
                sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.waitlist.text}">キャンセル待ち 登録済</span>`;
              } else {
                cC = `${DesignConfig.cards.base} ${DesignConfig.cards.state.booked.card}`;
                sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.booked.text}">予約済み</span>`;
              }
              act = '';
            } else if (sl.isFull) {
              // 満席（キャンセル待ち）の場合
              cC = `${DesignConfig.cards.base} ${DesignConfig.cards.state.waitlist.card}`;
              sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.waitlist.text}">満席（キャンセル待ち申込み）</span>`;
              act = `data-action="bookSlot" data-classroom="${sl.classroom}" data-date="${sl.date}"`;
            } else {
              // 予約可能な場合
              cC = `${DesignConfig.cards.base} ${DesignConfig.cards.state.available.card}`;
              sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.available.text}">${statusText}</span>`;
              act = `data-action="bookSlot" data-classroom="${sl.classroom}" data-date="${sl.date}"`;
            }

            const venueDisplay = sl.venue ? ` ${sl.venue}` : '';
            const text = `<div class="flex justify-between items-center w-full"><span class="${DesignConfig.colors.text}">${formatDate(sl.date)}${venueDisplay}</span>${sB}</div>`;

            // getBookingViewのロジックをベースに、buttonとdivを使い分ける
            return `<${tag} ${act} class="${cC}">${text}</${tag}>`;
          })
          .join('');

        return monthHeader + slotsHtml;
      })
      .join('');
  };

  /**
   * 特定の教室の予約枠一覧画面のUIを生成します。
   * @param {string} classroom - 教室名
   * @returns {string} HTML文字列
   */
  const getBookingView = classroom => {
    // バックエンドで計算済みの空き情報を直接使用
    const relevantSlots = appState.slots ? appState.slots.filter(slot => slot.classroom === classroom) : [];

    // デバッグ用：データ構造を確認
    if (detectEnvironment() === 'test' && relevantSlots.length > 0) {
      console.log('getBookingView - relevantSlots sample:', relevantSlots[0]);
      console.log('getBookingView - appState.slots sample:', appState.slots[0]);
    }

    // デバッグ情報を画面表示用に準備
    const debugInfo = `
      <div style="background: #ffe; border: 1px solid #ffc; padding: 10px; margin: 10px 0; font-size: 12px;">
        <strong>${classroom}のスロット詳細:</strong><br>
        関連スロット数: ${relevantSlots.length}件<br>
        ${relevantSlots
          .slice(0, 3)
          .map(
            (slot, i) =>
              `[${i}] 日付:${slot.date}, 午前:${slot.morningSlots}, 午後:${slot.afternoonSlots}, 空き:${slot.availableSlots}, 満席:${slot.isFull}<br>`,
          )
          .join('')}
      </div>
    `;

    const bookingSlotsHtml = renderBookingSlots(relevantSlots);

    if (!bookingSlotsHtml) {
      return `
        <div class="max-w-md mx-auto">
            <h1 class="text-xl font-bold ${DesignConfig.colors.text} mb-2">${classroom}</h1>
            <p class="${DesignConfig.colors.textSubtle} mb-6">現在、予約可能な日がありません。</p>
            <div class="mt-6">
                ${Components.createButton({ text: 'ダッシュボードに戻る', action: 'goBackToDashboard', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
            </div>
        </div>`;
    } else {
      return `
        <div class="max-w-md mx-auto">
            ${debugInfo}
            <h1 class="text-xl font-bold ${DesignConfig.colors.text} mb-4">${classroom}</h1>
            <div class="${DesignConfig.cards.container}">${bookingSlotsHtml}</div>
            <div class="mt-6">
                ${Components.createButton({ text: 'ダッシュボードに戻る', action: 'goBackToDashboard', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
            </div>
        </div>`;
    }
  };

  /**
   * 予約の詳細入力・編集画面のUIを生成します。
   * @param {string} mode - 'new' または 'edit'
   * @returns {string} HTML文字列
   */
  const getReservationFormView = (mode = 'new') => {
    const isEdit = mode === 'edit';

    // --- 1. データの準備 ---
    // 編集時は editingReservationDetails から、新規作成時は selectedSlot からデータを取得
    const sourceData = isEdit ? appState.editingReservationDetails : appState.selectedSlot;
    if (!sourceData) return 'エラー: 予約情報が見つかりません。';

    const {
      classroom,
      date,
      venue,
      isWaiting,
      startTime,
      endTime,
      firstLecture,
      chiselRental,
      workInProgress,
      materialInfo,
      order,
      messageToTeacher,
    } = sourceData;
    const { currentUser, accountingMaster: master } = appState;
    const tuitionItemRule = getTuitionItemRule(master, classroom, '本講座');

    // 新規作成時のみ利用するデータ
    const { availableSlots, morningSlots, afternoonSlots, isFull } = appState.selectedSlot || {};
    const isFirstTime = appState.isFirstTimeBooking && !isEdit;

    // --- 2. モードに応じた設定 ---
    const title = isEdit ? '予約内容の編集' : isFull ? 'キャンセル待ち申込み' : '予約詳細の入力';
    const submitAction = isEdit ? 'updateReservation' : 'confirmBooking';
    const submitButtonText = isEdit ? 'この内容で更新する' : isFull ? 'キャンセル待ちで登録する' : 'この内容で予約する';

    // --- 3. UI生成ヘルパー関数 ---
    /**
     * 予約状況の表示を生成します。
     */
    const _renderStatusHtml = () => {
      if (isEdit) {
        return sourceData.isWaiting ? 'キャンセル待ち' : '予約済み';
      }
      if (isFull) return '満席（キャンセル待ち申込み）';
      if (typeof morningSlots !== 'undefined') {
        const morningLabel = appState.constants?.sessions?.MORNING || '午前';
        const afternoonLabel = appState.constants?.sessions?.AFTERNOON || '午後';
        return `${morningLabel}空き ${morningSlots} | ${afternoonLabel}空き ${afternoonSlots}`;
      }
      return `空き ${availableSlots}`;
    };

    /**
     * 予約時間選択のUIを生成します。
     */
    const _renderTimeOptionsSection = () => {
      // 30分単位の教室の場合
      if (tuitionItemRule && tuitionItemRule['単位'] === C.units.THIRTY_MIN) {
        const classStartHour = parseInt(tuitionItemRule['講座開始'].split(':')[0]);
        const classEndHour = parseInt(tuitionItemRule['講座終了'].split(':')[0]);
        const classEndMinutes = parseInt(tuitionItemRule['講座終了'].split(':')[1]);

        // Note: 外部で定義されている `getTimeOptionsHtml` を呼び出していると想定
        const startTimeOptions = getTimeOptionsHtml(
          classStartHour,
          classEndHour,
          C.frontendUi.TIME_SETTINGS.STEP_MINUTES,
          startTime,
        );
        let endTimeOptions = getTimeOptionsHtml(
          classStartHour,
          classEndHour,
          C.frontendUi.TIME_SETTINGS.STEP_MINUTES,
          endTime,
        );
        if (classEndMinutes > 0) {
          const finalEndTime = `${String(classEndHour).padStart(2, '0')}:${String(classEndMinutes).padStart(2, '0')}`;
          endTimeOptions += `<option value="${finalEndTime}">${finalEndTime}</option>`;
        }

        const discountRule = getTuitionItemRule(master, classroom, C.items.DISCOUNT);
        let discountHtml = '';
        if (discountRule && (classroom === C.classrooms.TSUKUBA || classroom === C.classrooms.NUMAZU)) {
          const discountAmountText = `${Math.abs(Number(discountRule['単価']))}円`;
          const discountUnitText = discountRule['単位'];
          discountHtml = `<p class="${DesignConfig.text.caption}">${discountRule['項目名']}: ${discountRule.説明 || `参加時間が初回講習と重なる場合、${discountUnitText}あたり${discountAmountText}割引`}</p>`;
        }

        return `
          <div class="mt-4 pt-4 border-t">
            <h4 class="font-bold ${DesignConfig.colors.text} mb-2">予約時間</h4>
            <div class="grid grid-cols-2 gap-4 mb-2">
              ${Components.createSelect({ id: 'res-start-time', caption: '開始予定', options: startTimeOptions })}
              ${Components.createSelect({ id: 'res-end-time', caption: '終了予定', options: endTimeOptions })}
            </div>
            ${discountHtml}
          </div>`;
      }
      return ''; // 上記以外の場合は時間選択なし
    };

    /**
     * 予約オプションのUIを生成します。
     */
    const _renderBookingOptionsSection = () => {
      let optionsHtml = '';
      const firstLectureChecked = firstLecture ? 'checked' : '';
      const rentalChecked = chiselRental ? 'checked' : '';

      if (classroom === C.classrooms.TOKYO) {
        optionsHtml += `<label class="flex items-center space-x-2"><input type="checkbox" id="option-first-lecture" ${firstLectureChecked}><span>${C.items.FIRST_LECTURE}</span></label>`;
      }
      optionsHtml += `<div class="mt-2"><label class="flex items-center space-x-2"><input type="checkbox" id="option-rental" ${rentalChecked}><span>${C.items.CHISEL_RENTAL}</span></label></div>`;

      return `
        <div class="mt-4 pt-4 border-t">
          <h4 class="font-bold text-left mb-2">オプション</h4>
          ${optionsHtml}
        </div>`;
    };

    /**
     * 詳細入力欄のUIを生成します。
     * 購入希望欄を折り畳み物販チェックリスト＋自由記入欄に変更
     */
    const _renderDetailsInputSection = () => {
      const firstTimeGuidance = `
        <p class="${DesignConfig.text.caption}">- 教室サイトの作例などは作りやすいです（特に「だるま」など）</p>
        <p class="${DesignConfig.text.caption}">- 作品のサイズや題材によりますが、**1回の参加では完成しない可能性があります**</p>`;

      // 物販チェックリスト（折り畳み）
      const salesChecklistHtml =
        typeof buildSalesChecklist === 'function' ? buildSalesChecklist(appState.accountingMaster) : '';

      return `
        <div class="mt-4 pt-4 border-t space-y-4">
          ${Components.createTextArea({
            id: 'wip-input',
            label: isFirstTime ? '今回制作したいもの' : 'やりたいこと/作業予定',
            caption: isFirstTime
              ? '作りたいものがある方はご記入ください。仮でもOK! * ご自身の作り途中の作品や、材料の持ち込みも可'
              : '',
            placeholder: 'あとからでも記入できます。当日に相談でも大丈夫！',
            value: workInProgress || '',
          })}
          ${Components.createTextArea({
            id: 'material-input',
            label: '材料のサイズや樹種の希望',
            caption: 'ご希望があればご記入ください。大体でも大丈夫！作れる大きさは 【豆粒】〜【手のひら】くらい',
            placeholder: '例：30×30×40mmくらい」「高さが6cmくらい」「たまごぐらい」 など',
            value: materialInfo || '',
          })}
          ${isFirstTime ? firstTimeGuidance : ''}
        </div>
        <div class="mt-4 pt-4 border-t space-y-4">
          ${salesChecklistHtml}
          ${Components.createInput({ id: 'order-input', label: 'その他・自由記入（購入希望）', type: 'text', placeholder: '（任意）例：彫刻刀セット、テキスト', value: order || '' })}
          ${Components.createTextArea({ id: 'message-input', label: 'その他の連絡事項や要望など', placeholder: '', value: messageToTeacher || '' })}
        </div>`;
    };
    // 予約送信時にチェックされた物販をorderに渡す処理を追加
    const _getSelectedSalesOrder = () => {
      const checked = Array.from(document.querySelectorAll('input[name="orderSales"]:checked'));
      return checked.map(cb => cb.value).join(', ');
    };

    // 送信ボタンのクリック時にorder値をセット
    setTimeout(() => {
      const submitBtn = document.querySelector('[data-action="confirmBooking"], [data-action="updateReservation"]');
      if (submitBtn) {
        submitBtn.addEventListener('click', () => {
          const selectedOrder = _getSelectedSalesOrder();
          const orderInput = document.getElementById('order-input');
          if (orderInput) {
            // 既存の自由記入とチェックリストを合成
            const freeText = orderInput.value.trim();
            orderInput.value = selectedOrder ? (freeText ? selectedOrder + ', ' + freeText : selectedOrder) : freeText;
          }
        });
      }
    }, 300);

    // --- 4. メインHTMLの組み立て ---
    let buttonsHtml = `
      ${Components.createButton({ text: submitButtonText, action: submitAction, colorClass: DesignConfig.colors.primary, widthClass: DesignConfig.buttons.full })}
    `;
    // 編集時のみキャンセルボタンを追加
    if (isEdit) {
      buttonsHtml += Components.createButton({
        text: 'この予約をキャンセルする',
        action: 'cancel',
        colorClass: DesignConfig.colors.danger,
        widthClass: DesignConfig.buttons.full,
        reservationId: sourceData.reservationId, // キャンセルに必要な情報を付与
        classroom: sourceData.classroom,
        date: sourceData.date,
        sheetName: sourceData.sheetName,
      });
    }
    // 戻るボタン：編集時はダッシュボードへ、新規作成時は予約一覧へ
    buttonsHtml += Components.createButton({
      text: '戻る',
      action: isEdit ? 'goBackToDashboard' : 'goBackToBooking',
      colorClass: DesignConfig.colors.secondary,
      widthClass: DesignConfig.buttons.full,
    });

    const venueDisplay = venue ? ` ${venue}` : '';

    const _renderOpeningHoursHtml = () => {
      if (!tuitionItemRule) {
        return '<span class="text-ui-error-text">開講時間未設定</span>';
      }
      const startTime = tuitionItemRule['講座開始'] || '';
      const endTime = tuitionItemRule['講座終了'] || '';
      const breakStart = tuitionItemRule['休憩開始'] || '';
      const breakEnd = tuitionItemRule['休憩終了'] || '';

      if (breakStart && breakEnd) {
        return `${startTime} ~ ${breakStart} ,  ${breakEnd} ~ ${endTime}`;
      }
      return `${startTime} ~ ${endTime}`;
    };

    // --- Main View Assembly ---
    return `
      <h1 class="text-xl font-bold ${DesignConfig.colors.text} mb-4">${title}</h1>
      <div class="space-y-4 text-left p-4 ${DesignConfig.cards.background} rounded-lg">
        <p><span class="font-bold w-20 inline-block">お名前:</span> ${currentUser.displayName}さん</p>
        <p><span class="font-bold w-20 inline-block">教室:</span> ${classroom}${venueDisplay}</p>
        <p><span class="font-bold w-20 inline-block">日付:</span> ${formatDate(date)}</p>
        <p><span class="font-bold w-20 inline-block">状況:</span> ${_renderStatusHtml()}</p>
        <p><span class="font-bold w-20 inline-block">開講時間:</span> ${_renderOpeningHoursHtml()}</p>
        ${_renderTimeOptionsSection()}
        ${_renderBookingOptionsSection()}
        ${_renderDetailsInputSection()}
      </div>
      <div class="mt-8 flex flex-col space-y-3">
        ${buttonsHtml}
      </div>`;
  };

  /**
   * 完了画面のUIを生成します。
   * @param {string} msg - 表示するメッセージ
   * @returns {string} HTML文字列
   */
  const getCompleteView = msg => {
    // 教室情報を取得（会計処理時は accountingReservation から、予約作成時は selectedSlot から）
    const classroom = appState.accountingReservation?.classroom || appState.selectedSlot?.classroom;
    let nextBookingHtml = '';

    // 該当教室の未来の予約枠が存在する場合
    if (classroom && appState.slots) {
      // バックエンドで計算済みの空き情報を直接使用
      const relevantSlots = appState.slots.filter(slot => slot.classroom === classroom);
      const bookingSlotsHtml = renderBookingSlots(relevantSlots);

      if (bookingSlotsHtml) {
        nextBookingHtml = `
          <div class="mt-10 pt-6 border-t border-gray-200">
              <h3 class="text-xl font-bold text-brand-text text-center mb-4">次回の予約</h3>
              <div class="${DesignConfig.cards.container}">
              ${bookingSlotsHtml}
              </div>
          </div>`;
      }
    }

    return `
    <div class="text-center py-8">
        <svg class="w-16 h-16 mx-auto text-state-available-text" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h1 class="text-2xl font-bold ${DesignConfig.colors.text} mt-4 mb-2">ありがとうございました</h1>
        <p class="${DesignConfig.colors.textSubtle} mb-6">${msg}</p>

        ${nextBookingHtml}

        <div class="max-w-xs mx-auto mt-8">
             ${Components.createButton({
               text: 'ダッシュボードへ戻る',
               action: 'goToDashboard',
               colorClass: DesignConfig.colors.secondary,
               widthClass: DesignConfig.buttons.full,
             })}
        </div>
    </div>`;
  };

  /**
   * 会計画面のUIを生成します。
   * @returns {string} HTML文字列
   */
  const getAccountingView = () => {
    if (!appState.accountingMaster || !appState.accountingInitialValues)
      return '<div class="flex justify-center items-center h-full"><div class="spinner"></div></div>';
    const r = appState.accountingReservation;
    // 計算済みデータを使用（setState()で自動更新済み）
    const b = appState.computed.sortedBookings.find(b => b.reservationId === r.reservationId);
    const v = b.venue ? `（${b.venue}）` : '';
    const initial = appState.accountingInitialValues;
    if (b.accountingDone && b.accountingDetails) {
      try {
        const details = JSON.parse(b.accountingDetails);
        const tuitionItemsHtml = details.tuition.items
          .map(
            i =>
              `<div class="flex justify-between"><span>${i.name}</span><span>${i.price.toLocaleString()}円</span></div>`,
          )
          .join('');
        const salesItemsHtml = details.sales.items
          .map(
            i =>
              `<div class="flex justify-between"><span>${i.name}</span><span>${i.price.toLocaleString()}円</span></div>`,
          )
          .join('');
        return `
                <div class="text-center py-4">
                    <h1 class="text-2xl font-bold text-brand-text mt-4 mb-2">会計済み</h1>
                    <p class="text-brand-subtle mb-6"><b>${formatDate(r.date)}</b><br>${r.classroom}${v}</p>
                </div>
                <div class="p-4 bg-ui-surface border border-ui-border rounded-lg text-left space-y-4">
                    <div><h3 class="font-bold text-brand-text border-b border-ui-border mb-1 pb-1">授業料</h3><div class="space-y-1 text-brand-text">${tuitionItemsHtml || 'なし'}</div></div>
                    <div><h3 class="font-bold text-brand-text border-b border-ui-border mb-1 pb-1">販売</h3><div class="space-y-1 text-brand-text">${salesItemsHtml || 'なし'}</div></div>
                    <div class="text-right font-bold text-xl pt-2 border-t border-ui-border text-brand-text">合計: ${details.grandTotal.toLocaleString()}円</div>
                    <div class="text-right text-base pt-2 text-brand-subtle">支払方法: ${details.paymentMethod}</div>
                </div>
                <div class="mt-8 flex flex-col space-y-3">
                    ${Components.createButton({ text: '戻る', action: 'goBackToDashboard', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
                </div>`;
      } catch (e) {
        return '会計詳細の表示に失敗しました。';
      }
    }
    const master = appState.accountingMaster;
    const tuitionItemRule = getTuitionItemRule(master, r.classroom, C.items.MAIN_LECTURE);
    const isTimeBased = tuitionItemRule && tuitionItemRule['単位'] === C.units.THIRTY_MIN;
    let tuitionHtml;
    if (isTimeBased) {
      tuitionHtml = getTimeBasedTuitionHtml(tuitionItemRule, initial);
    } else {
      const tuitionItems = master.filter(
        item =>
          item['種別'] === C.itemTypes.TUITION &&
          (item['対象教室'] === '共通' || (item['対象教室'] && item['対象教室'].includes(r.classroom))),
      );
      tuitionHtml = `<div class="p-4 bg-ui-surface border border-ui-border rounded-lg"> <h3 class="text-xl font-bold mb-3 text-brand-text">授業料</h3> <div class="space-y-3">${tuitionItems
        .map(item => {
          const isMandatory = item['項目名'] === C.items.MAIN_LECTURE;
          let isChecked = isMandatory || initial[item['項目名']] === true;
          if (item['項目名'] === C.items.FIRST_LECTURE && initial.firstLecture) isChecked = true;
          if (item['項目名'] === C.items.CHISEL_RENTAL && initial.chiselRental) isChecked = true;
          return `<div class="flex items-center justify-between mb-2"> <label class="flex items-center space-x-2 text-brand-text"> <input type="checkbox" name="${item['項目名']}" data-item-type="${C.itemTypes.TUITION}" data-item-name="${item['項目名']}" class="accounting-item h-5 w-5 rounded border-ui-border text-brand-text focus:ring-brand-text accent-action-primary-bg" ${isChecked ? 'checked' : ''} ${isMandatory ? 'disabled' : ''}> <span>${item['項目名']}</span> </label> <span class="text-brand-subtle">${item['単価'].toLocaleString()}円</span> </div>`;
        })
        .join(
          '',
        )}</div> <div id="tuition-breakdown" class="mt-4 pt-4 border-t border-ui-border space-y-1 text-base text-brand-subtle"></div> <div class="text-right font-bold mt-2 text-brand-text" id="tuition-subtotal">小計: 0円</div></div>`;
    }
    const salesItems = master.filter(item => item['種別'] === ITEM_TYPE_SALES);
    const salesHtml = `<div class="p-4 bg-ui-surface border border-ui-border rounded-lg"> <h3 class="text-xl font-bold mb-3 text-left text-brand-text">販売</h3> <div class="mb-3 space-y-4"><label class="block text-brand-text text-base font-bold">材料代</label><div id="materials-container">${buildMaterialRow(0, { type: initial.materialType0, l: initial.materialL0, w: initial.materialW0, h: initial.materialH0 })}</div></div> ${Components.createButton({ text: '+ 材料を追加', action: 'addMaterialRow', colorClass: 'bg-action-secondary-bg text-action-secondary-text w-full mt-3 text-base py-2 active:bg-action-secondary-hover' })} <details class="mt-4"> <summary class="font-bold text-brand-text flex items-center"> <span class="arrow mr-2">▶</span> その他の販売品 </summary> <div class="mt-2 space-y-2 pt-2 border-t border-ui-border">${salesItems.map(item => `<div class="flex items-center justify-between"> <label class="flex items-center space-x-2 text-brand-text"><input type="checkbox" name="${item['項目名']}" data-item-type="${ITEM_TYPE_SALES}" data-item-name="${item['項目名']}" class="accounting-item accent-action-primary-bg" ${initial[item['項目名']] ? 'checked' : ''}><span>${item['項目名']}</span></label> <span class="text-brand-subtle">${item['単価'].toLocaleString()}円</span> </div>`).join('')}<div id="other-sales-container" class="mt-2 pt-2 border-t border-ui-border">${getOtherSalesRowHtml(0, { name: initial.otherSalesName0, price: initial.otherSalesPrice0 })}</div></div> ${Components.createButton({ text: '+ 自由入力欄を追加', action: 'addOtherSalesRow', colorClass: 'bg-action-secondary-bg text-action-secondary-text w-full mt-3 text-base py-2 active:bg-action-secondary-hover' })} </details> <div class="text-right font-bold mt-2 text-brand-text" id="sales-subtotal">小計: 0円</div></div>`;
    return `
        <div class="flex justify-between items-center">
            <h1 class="text-2xl font-bold text-brand-text">会計</h1>
            <button data-action="goBackToDashboard" class="text-sm bg-action-secondary-bg text-action-secondary-text px-3 py-1.5 rounded-md active:bg-action-secondary-hover mobile-button">戻る</button>
        </div>
        <div class="text-center py-4">
            <p class="text-brand-subtle mb-6"><b>${formatDate(r.date)}</b><br>${r.classroom}${v}</p>
        </div>
        <form id="accounting-form" class="space-y-6">
            ${tuitionHtml}
            ${salesHtml}
            <div class="text-right text-2xl font-bold py-4 border-t-2 border-ui-border flex flex-col items-end">
                <span id="grand-total-amount" class="text-brand-text">合計: 0円</span>
            </div>
            <div class="mt-4 text-center">
                <p class="text-base text-state-danger-text font-bold mb-2">金額を、先生に確認してもらってください</p>
                <div class="space-y-3">
                    ${Components.createButton({ text: '先生の確認が完了しました', action: 'showAccountingConfirmation', colorClass: DesignConfig.colors.primary, widthClass: DesignConfig.buttons.full })}
                    ${Components.createButton({ text: '戻る', action: 'goBackToDashboard', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
                </div>
            </div>
        </form>`;
  };
</script>
