<script>
  /**
   * =================================================================
   * ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: 12_WebApp_Core.html
   * ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘: 1.2
   * ã€å½¹å‰²ã€‘: WebAppã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«ãŠã‘ã‚‹ä¸­æ ¸æ©Ÿèƒ½ã‚’é›†ç´„ã—ã¾ã™ã€‚
   * - çŠ¶æ…‹ç®¡ç† (State Management)
   * - UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç”Ÿæˆ (UI Components)
   * - æ±ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ (Utilities)
   * - ä¼šè¨ˆè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (Calculation Logic)
   * ã€æ§‹æˆã€‘: 14ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®ã†ã¡ã®12ç•ªç›®
   * ã€v1.2ã§ã®å¤‰æ›´ç‚¹ã€‘:
   * - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°: æ—¥ä»˜ãƒ»ã‚¹ãƒ­ãƒƒãƒˆå‡¦ç†ã®å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã‚’è¿½åŠ ã€‚
   * - filterFutureAvailableSlots, groupSlotsByMonth é–¢æ•°ã‚’æ–°è¦è¿½åŠ ã€‚
   * - ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã‚’å‘ä¸Šã€‚
   * =================================================================
   */

  // =================================================================
  // --- Application State Management ---
  // -----------------------------------------------------------------
  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®å‹•çš„ãªçŠ¶æ…‹ã‚’ä¸€å…ƒç®¡ç†ã—ã¾ã™ã€‚
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€äºˆç´„ãƒ‡ãƒ¼ã‚¿ã€ç¾åœ¨ã®è¡¨ç¤ºç”»é¢ãªã©ãŒå«ã¾ã‚Œã¾ã™ã€‚
  // =================================================================

  // =================================================================
  // --- Environment Detection & Data Management ---
  // -----------------------------------------------------------------
  // å®Ÿè¡Œç’°å¢ƒã‚’è‡ªå‹•æ¤œå‡ºã—ã€é©åˆ‡ãªãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’é¸æŠã—ã¾ã™ã€‚
  // ãƒ†ã‚¹ãƒˆç’°å¢ƒ: ãƒ–ãƒ©ã‚¦ã‚¶ + ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
  // æœ¬ç•ªç’°å¢ƒ: Google Apps Script + å®Ÿãƒ‡ãƒ¼ã‚¿
  // =================================================================

  /**
   * å®Ÿè¡Œç’°å¢ƒã®æ¤œå‡º
   * @returns {string} 'test' | 'production'
   */
  const detectEnvironment = () => {
    try {
      // GASç’°å¢ƒã®æ¤œå‡º
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        return 'production';
      }
      return 'test';
    } catch (error) {
      return 'test';
    }
  };

  /**
   * ç’°å¢ƒã«å¿œã˜ãŸãƒ‡ãƒ¼ã‚¿å–å¾—
   * @param {string} dataType - ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—
   * @param {any} fallback - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
   */
  const getEnvironmentData = (dataType, fallback = null) => {
    const env = detectEnvironment();

    if (env === 'test' && typeof MockData !== 'undefined') {
      return MockData[dataType] || fallback;
    }

    // GASç’°å¢ƒã§ã¯åˆæœŸå€¤ã®ã¿è¿”ã—ã€ãƒ‡ãƒ¼ã‚¿ã¯å¾Œã§APIå‘¼ã³å‡ºã—ã§å–å¾—
    return fallback;
  };

  // ç’°å¢ƒæƒ…å ±
  const isTestEnvironment = detectEnvironment() === 'test';

  // é–‹ç™ºæ™‚ã®ãƒ­ã‚°å‡ºåŠ›
  if (isTestEnvironment) {
    console.log('ğŸ§ª Test Environment Detected');
    console.log('MockData available:', typeof MockData !== 'undefined');
  }

  const appState = {
    currentUser: getEnvironmentData('currentUser'),
    slots: getEnvironmentData('slots', []),
    myBookings: getEnvironmentData('myBookings', []),
    history: getEnvironmentData('history', []),
    historyTotal: getEnvironmentData('history', []).length,
    view: isTestEnvironment ? 'login' : 'login',
    selectedClassroom: null,
    selectedSlot: null,
    phoneForRegistration: null,
    completionMessage: '',
    newlyBookedReservation: null,
    editingReservationDetails: null,
    accountingReservation: null,
    accountingMaster: getEnvironmentData('accountingMaster'),
    accountingInitialValues: null,
    editingHistoryItem: null,
    classrooms: getEnvironmentData('classrooms', ['æ±äº¬æ•™å®¤', 'ã¤ãã°æ•™å®¤', 'æ²¼æ´¥æ•™å®¤']),
    // NF-01: é›»è©±ç•ªå·æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒ•ãƒ­ãƒ¼ç”¨ã®çŠ¶æ…‹
    noPhoneUsers: [], // æ¤œç´¢çµæœã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ
    selectedNoPhoneUser: null, // é¸æŠã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼
    searchAttempted: false, // NF-01: æ¤œç´¢ãŒä¸€åº¦è©¦è¡Œã•ã‚ŒãŸã‹ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
  };
  let onConfirmCallback = null; // ãƒ¢ãƒ¼ãƒ€ãƒ«ç¢ºèªæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’ä¿æŒ

  // ãƒ†ã‚¹ãƒˆç’°å¢ƒã®åˆæœŸåŒ–ãƒ­ã‚°
  if (isTestEnvironment) {
    console.log('[TEST] ãƒ†ã‚¹ãƒˆç’°å¢ƒã§å®Ÿè¡Œä¸­ã§ã™');
    console.log('[TEST] appStateåˆæœŸåŒ–:', {
      currentUser: appState.currentUser,
      slotsCount: appState.slots.length,
      bookingsCount: appState.myBookings.length,
      historyCount: appState.history.length,
      classrooms: appState.classrooms,
    });
  }

  // =================================================================
  // --- UI Component Generators ---
  // -----------------------------------------------------------------
  // ã‚¢ãƒ—ãƒªå†…ã§ä½¿ç”¨ã•ã‚Œã‚‹ãƒœã‚¿ãƒ³ã‚„å…¥åŠ›æ¬„ã¨ã„ã£ãŸã€å†åˆ©ç”¨å¯èƒ½ãª
  // UIéƒ¨å“ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ç¾¤ã§ã™ã€‚
  // =================================================================
  const Components = {
    createButton: c =>
      `<button data-action="${c.action || ''}" data-classroom="${c.classroom || ''}" data-classroom-name="${c.classroomName || ''}" data-date="${c.date || ''}" data-reservation-id="${c.reservationId || ''}" data-sheet-name="${c.sheetName || ''}" data-copy-text="${c.copyText || ''}" data-details='${c.details || ''}' data-student-id="${c.studentId || ''}" data-real-name="${c.realName || ''}" data-nickname="${c.nickname || ''}" class="${DesignConfig.buttons.base} ${c.widthClass || ''} ${c.colorClass}" ${c.disabled ? 'disabled' : ''}>${c.text}</button>`,
    createInput: c =>
      `<div class="${c.containerClass || ''} mb-4"><label for="${c.id}" class="${c.labelClass || 'block text-brand-text text-base font-bold mb-2'} ${c.isSrOnly ? 'sr-only' : ''}">${c.label}</label><input type="${c.type}" id="${c.id}" value="${c.value || ''}" class="${DesignConfig.inputs.base} ${c.inputClass || ''}" placeholder="${c.placeholder || ''}" ${c.required ? 'required' : ''} autocomplete="${c.autocomplete || 'off'}" ${c.step ? `step="${c.step}"` : ''}></div>`,
    createTextArea: c =>
      `<div class="${c.containerClass || ''} mb-4"><label for="${c.id}" class="block text-brand-text text-base font-bold mb-2">${c.label}</label><textarea id="${c.id}" class="${DesignConfig.inputs.textarea}" placeholder="${c.placeholder || ''}">${c.value || ''}</textarea></div>`,
    createSelect: c =>
      `<div class="${c.containerClass || ''}"><label for="${c.id}" class="block text-brand-text text-base font-bold mb-2">${c.label}</label><select id="${c.id}" class="${DesignConfig.inputs.base} ${c.sizeClass || ''} accounting-item">${c.options}</select></div>`,
    createCheckbox: c =>
      `<label class="flex items-center space-x-2 text-brand-text"><input type="checkbox" id="${c.id}" ${c.checked ? 'checked' : ''} class="accent-action-primary-bg"><span>${c.label}</span></label>`,
  };

  // =================================================================
  // --- Loading Message System ---
  // -----------------------------------------------------------------
  // UI-11: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¤šæ§˜åŒ–æ©Ÿèƒ½
  // çŠ¶æ³ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒ¦ãƒ¼ãƒ¢ãƒ©ã‚¹ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¡¨ç¤ºã—ã€
  // æ•°ç§’ã”ã¨ã«è‡ªå‹•ã§åˆ‡ã‚Šæ›¿ãˆã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚
  // =================================================================
  let loadingMessageTimer = null;

  const LoadingMessages = {
    // ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    login: [
      'ã‚ã„ã¼ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã‚ã„ã¼ ã˜ãŸã„ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ãã‚ã ã‚’ ã‹ãã«ã‚“ ã¡ã‚…ã†ã§ã™...',
      'ãªã¾ãˆ ã‚’ ã‹ãã«ã‚“ ã—ã¦ã„ã¾ã™...',
      'ã¨ã†ã‚ã ãŒ ã‚ã‚‹ã‹ ã—ã‚‰ã¹ã¦ã„ã¾ã™...',
    ],

    // ç”³ã—è¾¼ã¿æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    booking: [
      'ã‚ˆã‚„ã ã‚’ ã‚‚ã†ã—ã“ã¿ ã¡ã‚…ã†ã§ã™...',
      'ã—ã‚“ã›ã„ã—ã‚‡ ã‚’ ã¦ã„ã—ã‚…ã¤ã—ã¦ã„ã¾ã™...',
      'ã¯ã‚“ã“ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã²ã¥ã‘ ã‚’ ã‹ãã«ã‚“ã—ã¦ã„ã¾ã™...',
      'ã‹ã‚Œã‚“ã ãƒ¼ ã« ã‹ãã“ã‚“ã§ã„ã¾ã™...',
    ],

    // äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    cancel: [
      'ã‚ˆã‚„ã ã‚’ ã¨ã‚Šã‘ã—ã¦ã„ã¾ã™...',
      'ã‘ã—ã”ã‚€ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã¨ã‚Šã‘ã—ã›ã‚“ ã‚’ ã²ã„ã¦ã„ã¾ã™...',
    ],

    // äºˆç´„ç·¨é›†æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    edit: [
      'ã¸ã‚“ã“ã† ã‚’ ã»ãã‚“ã—ã¦ã„ã¾ã™...',
      'ã‚ãŸã‚‰ã—ã„ ãªã„ã‚ˆã† ã« ã‹ãã‹ãˆã¦ã„ã¾ã™...',
      'ã¾ã¡ãŒã„ ãŒ ãªã„ã‹ ã‹ãã«ã‚“ã—ã¦ã„ã¾ã™...',
    ],

    // ä¼šè¨ˆæ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    accounting: [
      'ã§ã‚“ã´ã‚‡ã† ã‚’ ãŠãã£ã¦ã„ã¾ã™...',
      'ã¡ã‚‡ã†ã¼ ã‚’ ã¤ã‘ã¦ã„ã¾ã™...',
      'ãŠã‹ã­ ã‚’ ã‹ããˆã¦ã„ã¾ã™...',
      'ãŠã¤ã‚Š ã‚’ ã˜ã‚…ã‚“ã³ã—ã¦ã„ã¾ã™...',
    ],

    // ãƒ‡ãƒ¼ã‚¿å–å¾—æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    dataFetch: [
      'ãƒ‡ãƒ¼ã‚¿ ã‚’ ã‚ˆã¿ã“ã‚“ã§ã„ã¾ã™...',
      'ã˜ã‚‡ã†ã»ã† ã‚’ ã‚ã¤ã‚ã¦ã„ã¾ã™...',
      'ã²ã¤ã‚ˆã†ãª ã‚‚ã® ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
    ],

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    default: [
      'ã›ã‚“ã›ã„ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã—ã‚‡ã‚‹ã„ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã—ã‚‡ã‚‹ã„ ã‚’ ãªãŒã‚ã¦ã„ã¾ã™...',
      'ãããš ã‚’ ã‹ãŸãšã‘ã¦ã„ã¾ã™...',
      'ã“ã¨ã° ã‚’ ãˆã‚‰ã‚“ã§ã„ã¾ã™...',
      'ã¦ã„ã•ã„ ã‚’ ã¨ã¨ã®ãˆã¦ã„ã¾ã™...',
      'ã¿ã ã® ã‚‚ã® ã‚’ ã²ã ã‚Š ã« ã†ã”ã‹ã—ã¦ã„ã¾ã™...',
      'ã²ã ã‚Š ã® ã‚‚ã® ã‚’ ã¿ã ã« ã†ã”ã‹ã—ã¦ã„ã¾ã™...',
      'ã“ãƒ¼ã²ãƒ¼ ã‚’ ã„ã‚Œã¦ã„ã¾ã™...',
      'ã™ã“ã— ãã‚…ã†ã‘ã„ ã—ã¦ã„ã¾ã™...',
      'ã­ã“ ã® ã¦ ã‚’ ã‹ã‚Šã‚ˆã†ã¨ã—ã¦ã„ã¾ã™...',
      'ã¯ã‚€ã™ãŸãƒ¼ ã® ã¦ ã‚’ ã‹ã‚Šã‚ˆã†ã¨ã—ã¦ã„ã¾ã™...',
      'ã¯ã‚‚ã® ã‚’ ã¨ã¨ã®ãˆã¦ã„ã¾ã™...',
    ],
  };

  const getRandomMessage = (category = 'default') => {
    const messages = [...(LoadingMessages[category] || []), ...LoadingMessages.default];
    return messages[Math.floor(Math.random() * messages.length)];
  };

  const updateLoadingMessage = (category = 'default') => {
    const messageElement = document.getElementById('loading-message');
    if (messageElement) {
      messageElement.textContent = getRandomMessage(category);
    }
  };

  const startLoadingMessageRotation = (category = 'default') => {
    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
    updateLoadingMessage(category);

    // 3ç§’ã”ã¨ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
    loadingMessageTimer = setInterval(() => {
      updateLoadingMessage(category);
    }, 3500);
  };

  const stopLoadingMessageRotation = () => {
    if (loadingMessageTimer) {
      clearInterval(loadingMessageTimer);
      loadingMessageTimer = null;
    }
  };

  const showLoading = (category = 'default') => {
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('main-content').classList.add('hidden');
    startLoadingMessageRotation(category);
  };

  const hideLoading = () => {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('main-content').classList.remove('hidden');
    stopLoadingMessageRotation();
  };

  // =================================================================
  // --- General Utilities ---
  // -----------------------------------------------------------------
  // æ—¥ä»˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãªã©ã€
  // ã‚¢ãƒ—ãƒªå…¨ä½“ã§æ±ç”¨çš„ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤ã§ã™ã€‚
  // =================================================================
  const formatDate = dStr => {
    if (!dStr) return '';
    const d = new Date(dStr);
    if (isNaN(d)) return '';
    d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
    const day = d.getDay();
    const wd = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
    return `${d.getMonth() + 1}/${d.getDate()} <span class="font-bold ${day === 0 ? 'text-ui-weekend-sunday' : day === 6 ? 'text-ui-weekend-saturday' : ''}">${wd[day]}</span>`;
  };
  const showModal = c => {
    const m = document.getElementById('custom-modal'),
      b = document.getElementById('modal-buttons');
    b.innerHTML = '';
    if (c.showCancel) {
      b.innerHTML += Components.createButton({
        text: c.cancelText || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
        action: 'modalCancel',
        colorClass: DesignConfig.colors.secondary,
        widthClass: DesignConfig.buttons.auto,
      });
    }
    if (c.confirmText) {
      b.innerHTML += `<div class="w-3"></div>${Components.createButton({ text: c.confirmText, action: 'modalConfirm', colorClass: c.confirmColorClass, widthClass: DesignConfig.buttons.auto, disabled: c.disableConfirm })}`;
    }
    onConfirmCallback = c.onConfirm;
    document.getElementById('modal-title').textContent = c.title;
    document.getElementById('modal-message').innerHTML = c.message;
    m.classList.add('active');
  };
  const hideModal = () => {
    document.getElementById('custom-modal').classList.remove('active');
    onConfirmCallback = null;
  };
  const showInfo = (msg, t = 'æƒ…å ±', cb = null) =>
    showModal({
      title: t,
      message: msg,
      confirmText: 'OK',
      confirmColorClass: DesignConfig.colors.primary,
      onConfirm: cb,
    });
  const showConfirm = c => showModal({ ...c, showCancel: true });

  // =================================================================
  // --- Date and Slot Utilities ---
  // -----------------------------------------------------------------
  // æ—¥ä»˜ã‚„ã‚¹ãƒ­ãƒƒãƒˆæ“ä½œã«é–¢ã™ã‚‹å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ç¾¤ã§ã™ã€‚
  // =================================================================

  /**
   * æŒ‡å®šã•ã‚ŒãŸæ•™å®¤ã®ã€ä»Šæ—¥ä»¥é™ã®ç©ºãã‚¹ãƒ­ãƒƒãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
   * @param {Array} slots - å…¨ã‚¹ãƒ­ãƒƒãƒˆã®é…åˆ—
   * @param {string} classroom - æ•™å®¤å
   * @returns {Array} ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸã‚¹ãƒ­ãƒƒãƒˆé…åˆ—
   */
  const filterFutureAvailableSlots = (slots, classroom) => {
    if (!slots || !classroom) return [];

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    return slots.filter(s => {
      const slotDate = new Date(s.date);
      slotDate.setMinutes(slotDate.getMinutes() + slotDate.getTimezoneOffset());
      return s.classroom === classroom && slotDate >= today && !s.isFull && s.session !== 'åˆå›è¬›ç¿’';
    });
  };

  /**
   * ã‚¹ãƒ­ãƒƒãƒˆã‚’æœˆåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¾ã™ã€‚
   * @param {Array} slots - ã‚¹ãƒ­ãƒƒãƒˆã®é…åˆ—
   * @returns {Object} æœˆã‚’ã‚­ãƒ¼ã¨ã—ãŸã‚¹ãƒ­ãƒƒãƒˆã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  const groupSlotsByMonth = slots => {
    return slots.reduce((acc, slot) => {
      const month = new Date(slot.date).getMonth() + 1;
      if (!acc[month]) acc[month] = [];
      acc[month].push(slot);
      return acc;
    }, {});
  };

  // =================================================================
  // --- Accounting Calculation Logic ---
  // -----------------------------------------------------------------
  // ä¼šè¨ˆç”»é¢ã§ã®è¤‡é›‘ãªæ–™é‡‘è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã§ã™ã€‚
  // æˆæ¥­æ–™ã€ææ–™è²»ã€å‰²å¼•ãªã©ã‚’å‹•çš„ã«è¨ˆç®—ã—ã€åˆè¨ˆé‡‘é¡ã‚’ç®—å‡ºã—ã¾ã™ã€‚
  // =================================================================
  function calculateAccountingDetails() {
    if (!appState.accountingMaster) return null;
    let tuitionSubtotal = 0;
    let salesSubtotal = 0;
    const details = {
      tuition: { items: [] },
      sales: { items: [] },
      grandTotal: 0,
      paymentMethod: '',
      items: [],
    };
    const form = document.getElementById('accounting-form');
    if (!form) return null;

    const r = appState.accountingReservation;
    const classroomRule = appState.accountingMaster.find(
      item => item['å¯¾è±¡æ•™å®¤'] && item['å¯¾è±¡æ•™å®¤'].includes(r.classroom) && item['ç¨®åˆ¥'] === 'æˆæ¥­æ–™',
    );
    const isTimeBased = classroomRule && classroomRule['å˜ä½'] === '30åˆ†';
    let tuitionBreakdownHtml = '';

    if (isTimeBased) {
      const startTime = document.getElementById('start-time')?.value;
      const endTime = document.getElementById('end-time')?.value;
      const breakMinutes = parseInt(document.getElementById('break-time')?.value || 0, 10);

      if (startTime && endTime && startTime < endTime) {
        const start = new Date(`1970-01-01T${startTime}:00`);
        const end = new Date(`1970-01-01T${endTime}:00`);
        let diffMinutes = (end - start) / 60000 - breakMinutes;

        if (diffMinutes > 0) {
          const billableUnits = Math.ceil(diffMinutes / 30);
          const price = billableUnits * Number(classroomRule['å˜ä¾¡']);
          tuitionSubtotal += price;
          //ã€FE-16ã€‘é …ç›®åã«åˆ©ç”¨æ™‚é–“ã‚’è¿½åŠ 
          const tuitionItem = { name: `æˆæ¥­æ–™ (${startTime} - ${endTime})`, price: price };
          details.tuition.items.push(tuitionItem);
          document.getElementById('calculated-hours').textContent =
            `å—è¬›æ™‚é–“: ${billableUnits * 0.5}æ™‚é–“ Ã— ${2.0 * classroomRule['å˜ä¾¡']}å††`;
        } else {
          document.getElementById('calculated-hours').textContent = ``;
        }
      }
    }

    form.querySelectorAll('input[type="checkbox"].accounting-item').forEach(cb => {
      if (cb.checked || cb.disabled) {
        const itemName = cb.dataset.itemName;
        const itemType = cb.dataset.itemType;
        const masterItem = appState.accountingMaster.find(m => m['é …ç›®å'] === itemName && m['ç¨®åˆ¥'] === itemType);
        if (!masterItem) return;
        const price = Number(masterItem['å˜ä¾¡']);
        const itemDetail = { name: itemName, price: price };
        details.items.push(itemDetail);

        if (itemType === 'æˆæ¥­æ–™') {
          tuitionSubtotal += price;
          details.tuition.items.push(itemDetail);
          tuitionBreakdownHtml += `<div class="flex justify-between"><span>${itemDetail.name}</span><span>${itemDetail.price.toLocaleString()}å††</span></div>`;
        } else {
          salesSubtotal += price;
          details.sales.items.push(itemDetail);
        }
      }
    });

    const discountSelector = document.getElementById('discount-selector');
    if (discountSelector) {
      const discountRule = appState.accountingMaster.find(item => item['é …ç›®å'] === 'åˆå›è¬›ç¿’åŒæ™‚é–“å‰²å¼•');
      if (discountRule) {
        const discountMinutes = parseInt(discountSelector.value, 10);
        if (discountMinutes > 0) {
          const discountAmount = (discountMinutes / 30) * Math.abs(Number(discountRule['å˜ä¾¡']));
          tuitionSubtotal -= discountAmount;
          const discountItem = {
            name: `åˆå›è¬›ç¿’åŒæ™‚é–“å‰²å¼• (${discountMinutes}åˆ†)`,
            price: -discountAmount,
          };
          details.tuition.items.push(discountItem);
          tuitionBreakdownHtml += `<div class="flex justify-between text-red-600"><span>${discountItem.name}</span><span>${discountItem.price.toLocaleString()}å††</span></div>`;
        }
      }
    }

    if (isTimeBased) document.getElementById('tuition-breakdown').innerHTML = tuitionBreakdownHtml;

    const materialContainer = document.getElementById('materials-container');
    if (materialContainer) {
      const materialRows = materialContainer.querySelectorAll('div[data-material-row-index]');
      materialRows.forEach((row, index) => {
        const type = document.getElementById(`material-type-${index}`)?.value;
        const masterItem = appState.accountingMaster.find(m => m['é …ç›®å'] === type);
        const priceEl = document.getElementById(`material-price-${index}`);
        if (!masterItem) {
          if (priceEl) priceEl.textContent = '0å††';
          return;
        }
        const unitPrice = Number(masterItem['å˜ä¾¡']);
        let finalName = type;
        let price = 0;
        if (masterItem['å˜ä½'] === 'cmÂ³') {
          const l = document.getElementById(`material-l-${index}`)?.value || 0;
          const w = document.getElementById(`material-w-${index}`)?.value || 0;
          const h = document.getElementById(`material-h-${index}`)?.value || 0;
          if (l > 0 && w > 0 && h > 0) {
            const volumeCm = (l / 10) * (w / 10) * (h / 10);
            let calculatedPrice = Math.round((volumeCm * unitPrice) / 100) * 100;
            price = Math.max(100, calculatedPrice);
            finalName = `${type} (${l}x${w}x${h}mm)`;
          }
        } else {
          if (type) price = unitPrice;
        }
        if (priceEl) priceEl.textContent = `${price.toLocaleString()}å††`;
        if (price > 0) {
          const itemDetail = { name: finalName, price: price };
          salesSubtotal += price;
          details.sales.items.push(itemDetail);
        }
      });
    }
    const otherSalesContainer = document.getElementById('other-sales-container');
    if (otherSalesContainer) {
      const otherSalesRows = otherSalesContainer.querySelectorAll('div[data-other-sales-row]');
      otherSalesRows.forEach((row, index) => {
        const name = document.getElementById(`other-sales-name-${index}`)?.value.trim();
        const priceInput = document.getElementById(`other-sales-price-${index}`);
        let priceValue = priceInput.value
          .replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xfee0))
          .replace(/[^0-9.-]/g, '');
        priceInput.value = priceValue;
        const price = Number(priceValue || 0);
        if (name && price !== 0) {
          const itemDetail = { name: name, price: price };
          salesSubtotal += price;
          details.sales.items.push(itemDetail);
        }
      });
    }
    details.tuition.subtotal = tuitionSubtotal;
    details.sales.subtotal = salesSubtotal;
    details.grandTotal = tuitionSubtotal + salesSubtotal;
    document.getElementById('tuition-subtotal').textContent = `å°è¨ˆ: ${tuitionSubtotal.toLocaleString()}å††`;
    document.getElementById('sales-subtotal').textContent = `å°è¨ˆ: ${salesSubtotal.toLocaleString()}å††`;
    document.getElementById('grand-total-amount').textContent = `åˆè¨ˆ: ${details.grandTotal.toLocaleString()}å††`;
    details.paymentMethod = form.querySelector('input[name="payment-method"]:checked')?.value || 'ç¾é‡‘';
    return details;
  }
</script>
