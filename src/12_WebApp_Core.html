<script>
  /**
   * =================================================================
   * ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: 12_WebApp_Core.html
   * ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘: 1.2
   * ã€å½¹å‰²ã€‘: WebAppã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«ãŠã‘ã‚‹ä¸­æ ¸æ©Ÿèƒ½ã‚’é›†ç´„ã—ã¾ã™ã€‚
   * - çŠ¶æ…‹ç®¡ç† (State Management)
   * - UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç”Ÿæˆ (UI Components)
   * - æ±ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ (Utilities)
   * - ä¼šè¨ˆè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (Calculation Logic)
   * ã€æ§‹æˆã€‘: 14ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®ã†ã¡ã®12ç•ªç›®
   * ã€v1.2ã§ã®å¤‰æ›´ç‚¹ã€‘:
   * - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°: æ—¥ä»˜ãƒ»ã‚¹ãƒ­ãƒƒãƒˆå‡¦ç†ã®å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã‚’è¿½åŠ ã€‚
   * - filterFutureSlots, groupSlotsByMonth é–¢æ•°ã‚’æ–°è¦è¿½åŠ ã€‚
   * - ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã‚’å‘ä¸Šã€‚
   * =================================================================
   */

  /**
   * =================================================================
   * --- New Data Model Client-Side Processing (2025-08-19) ---
   * =================================================================
   */

  // calculateSlotsFromReservationsé–¢æ•°ã¨transformReservationArrayToObjecté–¢æ•°ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ
  // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã¯å…¨ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã€getAvailableSlots()ã¨getUserReservations()ã‚’ä½¿ç”¨ã—ã¾ã™

  /**
   * æ–°ã—ã„åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§å‡¦ç†ã—ã¦appStateã‚’æ§‹ç¯‰ã™ã‚‹
   * @param {object} data - getAppInitialDataã‹ã‚‰è¿”ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   * @param {string} phone - ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã•ã‚ŒãŸé›»è©±ç•ªå·
   * @param {Array} availableSlots - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å–å¾—æ¸ˆã¿ã®ç©ºå¸­æƒ…å ±
   * @returns {object} setStateã«æ¸¡ã™ãŸã‚ã®æ–°ã—ã„çŠ¶æ…‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  function processInitialData(data, phone, availableSlots, userReservations = null) {
    const { allStudents, accountingMaster, cacheVersions, today, constants } = data;

    // 1. é›»è©±ç•ªå·ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
    const currentUser = Object.values(allStudents).find(student => student.phone === phone);

    if (!currentUser) {
      return { currentUser: null }; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„
    }

    // currentUserã®displayNameã‚’ã‚»ãƒƒãƒˆ
    currentUser.displayName = currentUser.nickname || currentUser.realName;

    // 2. å€‹äººäºˆç´„ãƒ‡ãƒ¼ã‚¿ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å–å¾—æ¸ˆã¿
    const myBookings = userReservations ? userReservations.myBookings : [];
    const myHistory = userReservations ? userReservations.myHistory : [];

    // 3. ã‚¹ãƒ­ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ•™å®¤ä¸€è¦§ã‚’å‹•çš„ã«å–å¾—
    console.log('processInitialData - availableSlots:', availableSlots);
    console.log(
      'processInitialData - availableSlots length:',
      availableSlots ? availableSlots.length : 'null/undefined',
    );

    const classroomsFromSlots =
      availableSlots && availableSlots.length > 0 ? [...new Set(availableSlots.map(slot => slot.classroom))] : [];

    console.log('processInitialData - classroomsFromSlots:', classroomsFromSlots);

    // 4. appStateã‚’æ§‹ç¯‰
    return {
      view: 'dashboard',
      currentUser: currentUser,
      myBookings: myBookings,
      history: myHistory,
      slots: availableSlots,
      classrooms: classroomsFromSlots,
      accountingMaster: accountingMaster,
      today: today,
      constants: constants, // çµ±ä¸€å®šæ•°ã‚’è¿½åŠ 
      _allStudents: allStudents,
      _cacheVersions: cacheVersions,
    };
  }

  // =================================================================
  // --- Application State Management ---
  // -----------------------------------------------------------------
  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®å‹•çš„ãªçŠ¶æ…‹ã‚’ä¸€å…ƒç®¡ç†ã—ã¾ã™ã€‚
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€äºˆç´„ãƒ‡ãƒ¼ã‚¿ã€ç¾åœ¨ã®è¡¨ç¤ºç”»é¢ãªã©ãŒå«ã¾ã‚Œã¾ã™ã€‚
  // =================================================================

  // =================================================================
  // --- Environment Detection & Data Management ---
  // -----------------------------------------------------------------
  // å®Ÿè¡Œç’°å¢ƒã‚’è‡ªå‹•æ¤œå‡ºã—ã€é©åˆ‡ãªãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’é¸æŠã—ã¾ã™ã€‚
  // ãƒ†ã‚¹ãƒˆç’°å¢ƒ: ãƒ–ãƒ©ã‚¦ã‚¶ + ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
  // æœ¬ç•ªç’°å¢ƒ: Google Apps Script + å®Ÿãƒ‡ãƒ¼ã‚¿
  // =================================================================

  /**
   * å®Ÿè¡Œç’°å¢ƒã®æ¤œå‡º
   * @returns {string} 'test' | 'production'
   */
  const detectEnvironment = () => {
    try {
      // GASç’°å¢ƒã®æ¤œå‡º
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        return 'production';
      }
      return 'test';
    } catch (error) {
      return 'test';
    }
  };

  /**
   * ç’°å¢ƒã«å¿œã˜ãŸãƒ‡ãƒ¼ã‚¿å–å¾—
   * @param {string} dataType - ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—
   * @param {any} fallback - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
   */
  const getEnvironmentData = (dataType, fallback = null) => {
    const env = detectEnvironment();

    if (env === 'test' && typeof MockData !== 'undefined') {
      return MockData[dataType] || fallback;
    }

    // GASç’°å¢ƒã§ã¯åˆæœŸå€¤ã®ã¿è¿”ã—ã€ãƒ‡ãƒ¼ã‚¿ã¯å¾Œã§APIå‘¼ã³å‡ºã—ã§å–å¾—
    return fallback;
  };

  // ç’°å¢ƒæƒ…å ±
  const isTestEnvironment = detectEnvironment() === 'test';

  // é–‹ç™ºæ™‚ã®ãƒ­ã‚°å‡ºåŠ›
  if (isTestEnvironment) {
    console.log('ğŸ§ª Test Environment Detected');
    console.log('MockData available:', typeof MockData !== 'undefined');
  } else {
    console.log('ğŸš€ Production Environment Detected');
  }

  const appState = {
    // åŸºæœ¬ãƒ‡ãƒ¼ã‚¿
    currentUser: getEnvironmentData('currentUser'),
    slots: getEnvironmentData('slots', []),
    myBookings: getEnvironmentData('myBookings', []),
    history: getEnvironmentData('history', []),
    historyTotal: getEnvironmentData('history', []).length,
    accountingMaster: getEnvironmentData('accountingMaster'),
    classrooms: [], // ã‚¹ãƒ­ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‹•çš„ã«å–å¾—

    // è¨ˆç®—æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ç”¨ï¼‰
    computed: {
      slotsByClassroom: {}, // æ•™å®¤åˆ¥ã‚¹ãƒ­ãƒƒãƒˆ: { '${CONSTANTS.CLASSROOMS.TOKYO}': [...], ... }
      slotsByMonth: {}, // æœˆåˆ¥ã‚¹ãƒ­ãƒƒãƒˆ: { 1: [...], 2: [...], ... }
      filteredSlots: {}, // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿ã‚¹ãƒ­ãƒƒãƒˆï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ï¼‰
      sortedBookings: [], // ã‚½ãƒ¼ãƒˆæ¸ˆã¿äºˆç´„ãƒªã‚¹ãƒˆ
      sortedHistory: [], // ã‚½ãƒ¼ãƒˆæ¸ˆã¿å±¥æ­´ãƒªã‚¹ãƒˆ
      displayHistory: [], // è¡¨ç¤ºç”¨å±¥æ­´ï¼ˆrecordsToShowåˆ†ï¼‰
      classroomBookingStatus: {}, // æ•™å®¤åˆ¥äºˆç´„çŠ¶æ³
      accountingCalculation: null, // ä¼šè¨ˆè¨ˆç®—çµæœ
    },

    // UIçŠ¶æ…‹
    view: isTestEnvironment ? 'login' : 'login',
    selectedClassroom: null,
    selectedSlot: null,
    registrationPhone: null,
    completionMessage: '',
    recordsToShow: 10, // UI.HISTORY_INITIAL_RECORDSã§å¾Œã§æ›´æ–°

    // ç·¨é›†ãƒ»æ“ä½œçŠ¶æ…‹
    newlyBookedReservation: null,
    editingReservationDetails: null,
    accountingReservation: null,
    accountingInitialValues: null,
    editingHistoryItem: null,

    // NF-01: é›»è©±ç•ªå·æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒ•ãƒ­ãƒ¼ç”¨ã®çŠ¶æ…‹
    searchedUsers: [], // æ¤œç´¢çµæœã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ
    selectedSearchedUser: null, // é¸æŠã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼
    searchAttempted: false, // NF-01: æ¤œç´¢ãŒä¸€åº¦è©¦è¡Œã•ã‚ŒãŸã‹ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°

    // NF-04: æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ•ãƒ­ãƒ¼ç”¨ã®çŠ¶æ…‹
    registrationStep: 1, // æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼ã®ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ— (1, 2, 3)
    registrationData: {}, // å„ã‚¹ãƒ†ãƒƒãƒ—ã§å…¥åŠ›ã•ã‚ŒãŸæƒ…å ±ã‚’ä¸€æ™‚çš„ã«è“„ç©ã™ã‚‹
    isFirstTimeBooking: false, // åˆå›äºˆç´„ã‹ã©ã†ã‹ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°

    // ã‚·ã‚¹ãƒ†ãƒ å†…éƒ¨çŠ¶æ…‹
    today: null,
    loginPhone: '',
    isDataFresh: false,
    _dataUpdateInProgress: false,
    _allReservations: [],
    _allStudents: {},
    _cacheVersions: {},
  };
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ç®¡ç†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ - ã‚«ãƒ—ã‚»ãƒ«åŒ–ã•ã‚ŒãŸæ–¹å¼ã§ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ç®¡ç†
  const ModalManager = {
    onConfirmCallback: null,
    setCallback: function (callback) {
      this.onConfirmCallback = callback;
    },
    clearCallback: function () {
      this.onConfirmCallback = null;
    },
    executeCallback: function () {
      if (this.onConfirmCallback) {
        this.onConfirmCallback();
        this.clearCallback();
      }
    },
  };

  // =================================================================
  // --- çµ±ä¸€å®šæ•°ã‚·ã‚¹ãƒ†ãƒ çŸ­ç¸®ã‚¢ã‚¯ã‚»ã‚¹å‚ç…§ ---
  // -----------------------------------------------------------------
  // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®å®šæ•°ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç°¡æ½”ã«ã™ã‚‹ãŸã‚ã®çŸ­ç¸®å‚ç…§ãƒ‘ã‚¿ãƒ¼ãƒ³
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®ä¹±ç”¨ã‚’é¿ã‘ãªãŒã‚‰ã€appState.constantsã‹ã‚‰ã®å‚ç…§ã‚’çŸ­ç¸®
  // =================================================================

  /**
   * çµ±ä¸€å®šæ•°ã‚·ã‚¹ãƒ†ãƒ ã®çŸ­ç¸®ã‚¢ã‚¯ã‚»ã‚¹ç”¨å‚ç…§
   * appState.constants ãŒåˆ©ç”¨å¯èƒ½ã«ãªã£ãŸå¾Œã«åˆæœŸåŒ–ã•ã‚Œã‚‹
   */
  let C, STATUS, UI, BANK, PAYMENT; // çŸ­ç¸®å‚ç…§ç”¨å¤‰æ•°

  /**
   * çµ±ä¸€å®šæ•°ã®çŸ­ç¸®å‚ç…§ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
   * appState.constants ãŒåˆ©ç”¨å¯èƒ½ã«ãªã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‘¼ã³å‡ºã•ã‚Œã‚‹
   */
  function initializeConstantShortcuts() {
    if (appState.constants) {
      C = appState.constants; // çŸ­ç¸®ã‚¢ã‚¯ã‚»ã‚¹ç”¨ã®å‚ç…§

      // ã‚ˆãä½¿ç”¨ã•ã‚Œã‚‹å®šæ•°ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹
      STATUS = C.status || {};
      UI = C.ui || {};
      BANK = C.bankInfo || {};
      PAYMENT = C.paymentDisplay || {};

      // åˆæœŸåŒ–å¾Œã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã—ãŸå€¤ã‚’UIå®šæ•°ã§æ›´æ–°
      if (appState.recordsToShow === 10) {
        appState.recordsToShow = UI.HISTORY_INITIAL_RECORDS;
      }

      console.log('çµ±ä¸€å®šæ•°ã®çŸ­ç¸®å‚ç…§ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ');
    }
  }

  // åˆæœŸappStateç¢ºèªãƒ­ã‚°
  console.log('appStateåˆæœŸåŒ–å®Œäº†:', appState);
  console.log('appState.view:', appState.view);
  console.log('appState.slots:', appState.slots);
  console.log('appState.classrooms:', appState.classrooms);

  // ãƒ†ã‚¹ãƒˆç’°å¢ƒã®åˆæœŸåŒ–ãƒ­ã‚°
  if (isTestEnvironment) {
    console.log('[TEST] ãƒ†ã‚¹ãƒˆç’°å¢ƒã§å®Ÿè¡Œä¸­ã§ã™');
    console.log('[TEST] appStateåˆæœŸåŒ–:', {
      currentUser: appState.currentUser,
      slotsCount: appState.slots.length,
      bookingsCount: appState.myBookings.length,
      historyCount: appState.history.length,
      classrooms: appState.classrooms,
    });
  }

  // =================================================================
  // --- UI Component Generators ---
  // -----------------------------------------------------------------
  // ã‚¢ãƒ—ãƒªå†…ã§ä½¿ç”¨ã•ã‚Œã‚‹ãƒœã‚¿ãƒ³ã‚„å…¥åŠ›æ¬„ã¨ã„ã£ãŸã€å†åˆ©ç”¨å¯èƒ½ãª
  // UIéƒ¨å“ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ç¾¤ã§ã™ã€‚
  // =================================================================

  /**
   * HTMLæ–‡å­—åˆ—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¾ã™ã€‚
   * @param {string} str ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹æ–‡å­—åˆ—
   * @returns {string} ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸæ–‡å­—åˆ—
   */
  window.escapeHTML = str => {
    if (typeof str !== 'string') {
      return str;
    }
    return str.replace(/[&<>"']/g, function (match) {
      return {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
      }[match];
    });
  };

  const Components = {
    createButton: c =>
      `<button type="button"
        data-action="${escapeHTML(c.action || '')}"
        data-classroom="${escapeHTML(c.classroom || '')}"
        data-classroom-name="${escapeHTML(c.classroomName || '')}"
        data-date="${escapeHTML(c.date || '')}"
        data-reservation-id="${escapeHTML(c.reservationId || '')}"
        data-sheet-name="${escapeHTML(c.sheetName || '')}"
        data-copy-text="${escapeHTML(c.copyText || '')}"
        data-details="${escapeHTML(c.details || '')}"
        data-student-id="${escapeHTML(c.studentId || '')}"
        data-real-name="${escapeHTML(c.realName || '')}"
        data-nickname="${escapeHTML(c.nickname || '')}"
        class="${DesignConfig.buttons.base} ${c.widthClass || ''} ${c.colorClass}"
        ${c.disabled ? 'disabled' : ''}
      >${escapeHTML(c.text)}</button>`,

    createInput: c =>
      `<div class="${c.containerClass || ''} mb-4">
        <label
          for="${c.id}"
          class="${c.labelClass || DesignConfig.text.labelBlock} ${c.isSrOnly ? 'sr-only' : ''}"
        >${escapeHTML(c.label)}</label>
        ${c.caption ? `<p class="${DesignConfig.text.caption} mb-2">${escapeHTML(c.caption)}</p>` : ''}
        <input
          type="${c.type}"
          id="${c.id}"
          value="${escapeHTML(c.value || '')}"
          class="${DesignConfig.inputs.base} ${c.inputClass || ''}"
          placeholder="${escapeHTML(c.placeholder || '')}"
          ${c.required ? 'required' : ''}
          autocomplete="${c.autocomplete || 'off'}"
          ${c.step ? `step="${c.step}"` : ''}
        >
      </div>`,

    createTextArea: c =>
      `<div class="${c.containerClass || ''} mb-4">
        <label for="${c.id}" class="${DesignConfig.text.labelBlock}">${escapeHTML(c.label)}</label>
        ${c.caption ? `<p class="${DesignConfig.text.caption} mb-2">${escapeHTML(c.caption)}</p>` : ''}
        <textarea
          id="${c.id}"
          class="${DesignConfig.inputs.textarea}"
          placeholder="${escapeHTML(c.placeholder || '')}"
        >${escapeHTML(c.value || '')}</textarea>
      </div>`,

    createSelect: c =>
      `<div class="${c.containerClass || ''}">
        ${c.label ? `<label for="${c.id}" class="${DesignConfig.text.labelBlock}">${escapeHTML(c.label)}</label>` : ''}
        ${c.caption ? `<p class="${DesignConfig.text.caption} mb-2">${escapeHTML(c.caption)}</p>` : ''}
        <select
          id="${c.id}"
          class="${DesignConfig.inputs.base} ${c.sizeClass || ''} accounting-item"
        >${c.options}</select>
      </div>`,

    createCheckbox: c =>
      `<label class="flex items-center space-x-2 ${DesignConfig.colors.text}">
        <input
          type="checkbox"
          id="${c.id}"
          ${c.checked ? 'checked' : ''}
          class="accent-action-primary-bg"
        >
        <span>${escapeHTML(c.label)}</span>
      </label>`,
  };

  // =================================================================
  // --- Loading Message System ---
  // -----------------------------------------------------------------
  // UI-11: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¤šæ§˜åŒ–æ©Ÿèƒ½
  // çŠ¶æ³ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒ¦ãƒ¼ãƒ¢ãƒ©ã‚¹ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¡¨ç¤ºã—ã€
  // æ•°ç§’ã”ã¨ã«è‡ªå‹•ã§åˆ‡ã‚Šæ›¿ãˆã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚
  // =================================================================
  let loadingMessageTimer = null;

  const LoadingMessages = {
    // ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    login: [
      'ã‚ã„ã¼ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã‚ã„ã¼ ã˜ãŸã„ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ãã‚ã ã‚’ ã‹ãã«ã‚“ ã¡ã‚…ã†ã§ã™...',
      'ãªã¾ãˆ ã‚’ ã‹ãã«ã‚“ ã—ã¦ã„ã¾ã™...',
      'ã¨ã†ã‚ã ãŒ ã‚ã‚‹ã‹ ã—ã‚‰ã¹ã¦ã„ã¾ã™...',
    ],

    // ç”³ã—è¾¼ã¿æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    booking: [
      'ã‚ˆã‚„ã ã‚’ ã‚‚ã†ã—ã“ã¿ ã¡ã‚…ã†ã§ã™...',
      'ã—ã‚“ã›ã„ã—ã‚‡ ã‚’ ã¦ã„ã—ã‚…ã¤ã—ã¦ã„ã¾ã™...',
      'ã¯ã‚“ã“ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã²ã¥ã‘ ã‚’ ã‹ãã«ã‚“ã—ã¦ã„ã¾ã™...',
      'ã‹ã‚Œã‚“ã ãƒ¼ ã« ã‹ãã“ã‚“ã§ã„ã¾ã™...',
    ],

    // äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    cancel: ['ã‚ˆã‚„ã ã‚’ ã¨ã‚Šã‘ã—ã¦ã„ã¾ã™...', 'ã‘ã—ã”ã‚€ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...', 'ã¨ã‚Šã‘ã—ã›ã‚“ ã‚’ ã²ã„ã¦ã„ã¾ã™...'],

    // äºˆç´„ç·¨é›†æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    edit: [
      'ã¸ã‚“ã“ã† ã‚’ ã»ãã‚“ã—ã¦ã„ã¾ã™...',
      'ã‚ãŸã‚‰ã—ã„ ãªã„ã‚ˆã† ã« ã‹ãã‹ãˆã¦ã„ã¾ã™...',
      'ã¾ã¡ãŒã„ ãŒ ãªã„ã‹ ã‹ãã«ã‚“ã—ã¦ã„ã¾ã™...',
    ],

    // ä¼šè¨ˆæ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    accounting: [
      'ã§ã‚“ã´ã‚‡ã† ã‚’ ãŠãã£ã¦ã„ã¾ã™...',
      'ã¡ã‚‡ã†ã¼ ã‚’ ã¤ã‘ã¦ã„ã¾ã™...',
      'ãŠã‹ã­ ã‚’ ã‹ããˆã¦ã„ã¾ã™...',
      'ãŠã¤ã‚Š ã‚’ ã˜ã‚…ã‚“ã³ã—ã¦ã„ã¾ã™...',
    ],

    // ãƒ‡ãƒ¼ã‚¿å–å¾—æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    dataFetch: [
      'ãƒ‡ãƒ¼ã‚¿ ã‚’ ã‚ˆã¿ã“ã‚“ã§ã„ã¾ã™...',
      'ã˜ã‚‡ã†ã»ã† ã‚’ ã‚ã¤ã‚ã¦ã„ã¾ã™...',
      'ã²ã¤ã‚ˆã†ãª ã‚‚ã® ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
    ],

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    default: [
      'ã›ã‚“ã›ã„ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã—ã‚‡ã‚‹ã„ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã—ã‚‡ã‚‹ã„ ã‚’ ãªãŒã‚ã¦ã„ã¾ã™...',
      'ãããš ã‚’ ã‹ãŸãšã‘ã¦ã„ã¾ã™...',
      'ã“ã¨ã° ã‚’ ãˆã‚‰ã‚“ã§ã„ã¾ã™...',
      'ã¦ã„ã•ã„ ã‚’ ã¨ã¨ã®ãˆã¦ã„ã¾ã™...',
      'ã¿ã ã® ã‚‚ã® ã‚’ ã²ã ã‚Š ã« ã†ã”ã‹ã—ã¦ã„ã¾ã™...',
      'ã²ã ã‚Š ã® ã‚‚ã® ã‚’ ã¿ã ã« ã†ã”ã‹ã—ã¦ã„ã¾ã™...',
      'ã“ãƒ¼ã²ãƒ¼ ã‚’ ã„ã‚Œã¦ã„ã¾ã™...',
      'ã™ã“ã— ãã‚…ã†ã‘ã„ ã—ã¦ã„ã¾ã™...',
      'ã­ã“ ã® ã¦ ã‚’ ã‹ã‚Šã‚ˆã†ã¨ã—ã¦ã„ã¾ã™...',
      'ã¯ã‚€ã™ãŸãƒ¼ ã® ã¦ ã‚’ ã‹ã‚Šã‚ˆã†ã¨ã—ã¦ã„ã¾ã™...',
      'ã¯ã‚‚ã® ã‚’ ã¨ã¨ã®ãˆã¦ã„ã¾ã™...',
    ],
  };

  const getRandomMessage = (category = 'default') => {
    const messages = [...(LoadingMessages[category] || []), ...LoadingMessages.default];
    return messages[Math.floor(Math.random() * messages.length)];
  };

  const updateLoadingMessage = (category = 'default') => {
    const messageElement = document.getElementById('loading-message');
    if (messageElement) {
      messageElement.textContent = getRandomMessage(category);
    }
  };

  const startLoadingMessageRotation = (category = 'default') => {
    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
    updateLoadingMessage(category);

    // 3ç§’ã”ã¨ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
    loadingMessageTimer = setInterval(() => {
      updateLoadingMessage(category);
    }, UI?.LOADING_MESSAGE_INTERVAL || 3000);
  };

  const stopLoadingMessageRotation = () => {
    if (loadingMessageTimer) {
      clearInterval(loadingMessageTimer);
      loadingMessageTimer = null;
    }
  };

  const showLoading = (category = 'default') => {
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('main-content').classList.add('hidden');
    startLoadingMessageRotation(category);
  };

  const hideLoading = () => {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('main-content').classList.remove('hidden');
    stopLoadingMessageRotation();
  };

  // =================================================================
  // --- General Utilities ---
  /**
   * è²©å£²å“ãƒã‚¹ã‚¿ã‹ã‚‰ç‰©è²©ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆæŠ˜ã‚Šç•³ã¿å¯èƒ½ï¼‰ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
   * @param {Array} accountingMaster - è²©å£²å“ãƒã‚¹ã‚¿
   * @param {Array} checkedValues - ãƒã‚§ãƒƒã‚¯æ¸ˆã¿é …ç›®åé…åˆ—ï¼ˆä»»æ„ï¼‰
   * @param {string} [title='è²©å£²å“ãƒªã‚¹ãƒˆ'] - è¦‹å‡ºã—ã‚¿ã‚¤ãƒˆãƒ«
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  function buildSalesChecklist(accountingMaster, checkedValues = [], title = 'è²©å£²å“ãƒªã‚¹ãƒˆ') {
    const salesList = (accountingMaster || []).filter(item => item['ç¨®åˆ¥'] === 'ç‰©è²©');
    if (!salesList.length) return '';
    const checklistHtml = getSalesCheckboxListHtml(salesList, checkedValues);
    return `
    <details class="mt-4">
      <summary class="cursor-pointer font-bold text-base py-2 px-3 bg-ui-surface border border-ui-border rounded hover:bg-ui-hover">${title} <span class="ml-2 text-sm text-brand-subtle">ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</span></summary>
      <div class="pt-2">${checklistHtml}</div>
    </details>
  `;
  }
  /**
   * ç‰©è²©ãƒªã‚¹ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§è¡¨ç¤ºã™ã‚‹HTMLã‚’è¿”ã™ï¼ˆå†åˆ©ç”¨å¯èƒ½ï¼‰
   * @param {Array} salesList - ç‰©è²©ã‚¢ã‚¤ãƒ†ãƒ é…åˆ—
   * @param {Array} checkedValues - ãƒã‚§ãƒƒã‚¯æ¸ˆã¿é …ç›®åé…åˆ—ï¼ˆä»»æ„ï¼‰
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  function getSalesCheckboxListHtml(salesList, checkedValues = []) {
    if (!salesList || salesList.length === 0) return '';
    return `
    <div class="mt-4 pt-4 border-t">
      <label class="font-bold mb-2 block">è³¼å…¥å¸Œæœ›ï¼ˆãƒã‚§ãƒƒã‚¯å¯ï¼‰</label>
      <div class="grid grid-cols-2 gap-2">
        ${salesList
          .map(
            item => `
          <label class="flex items-center space-x-2">
            <input type="checkbox" name="orderSales" value="${item['é …ç›®å']}" class="accent-action-primary-bg" ${checkedValues.includes(item['é …ç›®å']) ? 'checked' : ''}>
            <span>${item['é …ç›®å']}${item['å˜ä¾¡'] ? `ï¼ˆ${item['å˜ä¾¡']}å††ï¼‰` : ''}</span>
          </label>
        `,
          )
          .join('')}
      </div>
    </div>`;
  }
  // -----------------------------------------------------------------
  // æ—¥ä»˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãªã©ã€
  // ã‚¢ãƒ—ãƒªå…¨ä½“ã§æ±ç”¨çš„ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤ã§ã™ã€‚
  // =================================================================

  /**
   * é›»è©±ç•ªå·ã‚’ 090 1234 5678 ã®ã‚ˆã†ãªå½¢å¼ã§è¡¨ç¤ºã™ã‚‹
   */
  function formatPhoneDisplay(phone) {
    const digits = String(phone).replace(/[^0-9]/g, '');
    return `${digits.slice(0, 3)} ${digits.slice(3, 7)} ${digits.slice(7)}`;
  }

  // =================================================================
  // çµ±ä¸€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ08_ErrorHandler.jsã‹ã‚‰çµ±åˆï¼‰
  // =================================================================

  /**
   * ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±ä¸€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
   */
  class FrontendErrorHandler {
    /**
     * ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é©åˆ‡ã«é€šçŸ¥
     * @param {Error} error - ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {string} context - ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
     * @param {Object} additionalInfo - è¿½åŠ æƒ…å ±
     */
    static handle(error, context = '', additionalInfo = {}) {
      hideLoading(); // æ—¢å­˜ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤ºå‡¦ç†

      const errorInfo = {
        message: error.message || 'Unknown error',
        stack: error.stack || 'No stack trace available',
        context: context,
        timestamp: new Date().toISOString(),
        userId: appState.currentUser?.studentId || 'anonymous',
        userAgent: navigator.userAgent,
        url: window.location.href,
        additionalInfo: additionalInfo,
      };

      // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã«å‡ºåŠ›
      console.error('[ERROR]', context, errorInfo);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥
      const userMessage = this.getUserFriendlyMessage(error, context);
      showInfo(userMessage, 'ã‚¨ãƒ©ãƒ¼');

      // é‡è¦ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯è©³ç´°ãƒ­ã‚°ã‚’é€ä¿¡ï¼ˆå°†æ¥çš„ã«Sentryãªã©ã¸ï¼‰
      if (this.isCriticalError(error)) {
        this.reportError(errorInfo);
      }
    }

    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
     * @param {Error} error - ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {string} context - ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
     * @returns {string} ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     */
    static getUserFriendlyMessage(error, context) {
      // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«åŸºã¥ã„ã¦é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
      const contextMessages = {
        login: 'ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚é›»è©±ç•ªå·ã‚’ç¢ºèªã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
        booking: 'äºˆç´„å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
        cancel: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
        accounting: 'ä¼šè¨ˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
        'data-load': 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
      };

      return (
        contextMessages[context] || `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}\n\næ™‚é–“ã‚’ãŠã„ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`
      );
    }

    /**
     * é‡è¦ãªã‚¨ãƒ©ãƒ¼ã‹ã©ã†ã‹ã‚’åˆ¤å®š
     * @param {Error} error - ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @returns {boolean}
     */
    static isCriticalError(error) {
      const criticalMessages = [
        'Script runtime exceeded',
        'Service invoked too many times',
        'Network error',
        'Timeout',
      ];

      return criticalMessages.some(msg => error.message && error.message.includes(msg));
    }

    /**
     * ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡ï¼ˆå°†æ¥çš„ã«Sentryãªã©ã®ç›£è¦–ã‚µãƒ¼ãƒ“ã‚¹ã¸ï¼‰
     * @param {Object} errorInfo - ã‚¨ãƒ©ãƒ¼æƒ…å ±
     */
    static reportError(errorInfo) {
      // ç¾åœ¨ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®ã¿
      // å°†æ¥çš„ã«Sentryã€Bugsnagã€LogRocketãªã©ã«é€ä¿¡
      console.log('[CRITICAL ERROR REPORT]', errorInfo);

      // ç®¡ç†è€…ã¸ã®ç·Šæ€¥é€šçŸ¥ã‚‚æ¤œè¨
      // ã“ã®éƒ¨åˆ†ã¯å°†æ¥çš„ã«å®Ÿè£…äºˆå®š
    }
  }

  /**
   * æ—¢å­˜ã®handleServerErroré–¢æ•°ã¨ã®äº’æ›æ€§ã‚’ä¿ã¤ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°
   * æ®µéšçš„ç§»è¡Œã®ãŸã‚æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®äº’æ›æ€§ã‚’ç¶­æŒ
   * @param {Error} err - ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  function handleServerError(err) {
    FrontendErrorHandler.handle(err, 'server-error');
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®è¨­å®š
  window.addEventListener('error', event => {
    FrontendErrorHandler.handle(event.error, 'global-error', {
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno,
    });
  });

  // Promiseæ‹’å¦ã‚¨ãƒ©ãƒ¼ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  window.addEventListener('unhandledrejection', event => {
    FrontendErrorHandler.handle(new Error(event.reason), 'unhandled-promise-rejection');
  });

  const formatDate = dStr => {
    if (!dStr) return '';
    const d = new Date(dStr);
    if (isNaN(d)) return '';
    d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
    const day = d.getDay();
    const wd = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
    return `${d.getMonth() + 1}/${d.getDate()} <span class="font-bold ${day === 0 ? 'text-ui-weekend-sunday' : day === 6 ? 'text-ui-weekend-saturday' : ''}">${wd[day]}</span>`;
  };
  const showModal = c => {
    const m = document.getElementById('custom-modal'),
      b = document.getElementById('modal-buttons');
    b.innerHTML = '';
    if (c.showCancel) {
      b.innerHTML += Components.createButton({
        text: c.cancelText || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
        action: 'modalCancel',
        colorClass: DesignConfig.colors.secondary,
        widthClass: DesignConfig.buttons.auto,
      });
    }
    if (c.confirmText) {
      b.innerHTML += `<div class="w-3"></div>${Components.createButton({ text: c.confirmText, action: 'modalConfirm', colorClass: c.confirmColorClass, widthClass: DesignConfig.buttons.auto, disabled: c.disableConfirm })}`;
    }
    ModalManager.setCallback(c.onConfirm);
    document.getElementById('modal-title').textContent = c.title;
    document.getElementById('modal-message').innerHTML = c.message;
    m.classList.add('active');
  };
  const hideModal = () => {
    document.getElementById('custom-modal').classList.remove('active');
    ModalManager.clearCallback();
  };
  const showInfo = (msg, t = 'æƒ…å ±', cb = null) =>
    showModal({
      title: t,
      message: msg,
      confirmText: 'OK',
      confirmColorClass: DesignConfig.colors.primary,
      onConfirm: cb,
    });
  const showConfirm = c => showModal({ ...c, showCancel: true });

  // =================================================================
  // --- Computed Data Management ---
  // -----------------------------------------------------------------
  // appState.computedã®è¨ˆç®—ãƒ»æ›´æ–°å‡¦ç†ã‚’ç®¡ç†ã—ã¾ã™ã€‚
  // =================================================================

  /**
   * appState.computedã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å†è¨ˆç®—ã—ã¾ã™ã€‚
   * ãƒ‡ãƒ¼ã‚¿ãŒå¤‰æ›´ã•ã‚ŒãŸéš›ã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
   */
  function updateComputedData() {
    // çµ±ä¸€å®šæ•°ãŒæœªåˆæœŸåŒ–ã®å ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
    if (!C || !C.items) {
      console.warn('çµ±ä¸€å®šæ•°ãŒæœªåˆæœŸåŒ–ã®ãŸã‚ã€updateComputedData()ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
      return;
    }

    const state = appState;

    // åŸºæœ¬ãƒã‚§ãƒƒã‚¯
    if (!state.slots) state.slots = [];
    if (!state.myBookings) state.myBookings = [];
    if (!state.history) state.history = [];

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // 0. ã‚¹ãƒ­ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ•™å®¤ä¸€è¦§ã‚’å‹•çš„ã«å–å¾—
    const classroomsFromSlots = [...new Set(state.slots.map(slot => slot.classroom))];
    if (classroomsFromSlots.length > 0) {
      state.classrooms = classroomsFromSlots;
    }

    // 1. æ•™å®¤åˆ¥ã‚¹ãƒ­ãƒƒãƒˆ
    state.computed.slotsByClassroom = {};
    state.classrooms.forEach(classroom => {
      state.computed.slotsByClassroom[classroom] = state.slots.filter(s => {
        const slotDate = new Date(s.date);
        slotDate.setMinutes(slotDate.getMinutes() + slotDate.getTimezoneOffset());
        const isClassroomMatch = s.classroom === classroom;
        const isDateFuture = slotDate >= today;
        const isNotFirstLecture = s.session !== C.items.FIRST_LECTURE;

        // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰
        if (detectEnvironment() === 'test' && s.classroom && classroom === C.classrooms.TOKYO) {
          console.log(
            `ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è©³ç´° - ã‚¹ãƒ­ãƒƒãƒˆæ•™å®¤: "${s.classroom}", æ¤œç´¢æ•™å®¤: "${classroom}", ä¸€è‡´: ${isClassroomMatch}, æ—¥ä»˜: ${s.date}, æœªæ¥: ${isDateFuture}, ã‚»ãƒƒã‚·ãƒ§ãƒ³: "${s.session}", åˆå›é™¤å¤–: ${isNotFirstLecture}`,
          );
        }

        return isClassroomMatch && isDateFuture && isNotFirstLecture;
      });
    });

    // 2. æœˆåˆ¥ã‚¹ãƒ­ãƒƒãƒˆ
    state.computed.slotsByMonth = state.slots.reduce((acc, slot) => {
      const month = new Date(slot.date).getMonth() + 1;
      if (!acc[month]) acc[month] = [];
      acc[month].push(slot);
      return acc;
    }, {});

    // 3. ã‚½ãƒ¼ãƒˆæ¸ˆã¿äºˆç´„ãƒªã‚¹ãƒˆ
    state.computed.sortedBookings = [...state.myBookings].sort((a, b) => new Date(b.date) - new Date(a.date));

    // 4. ã‚½ãƒ¼ãƒˆæ¸ˆã¿å±¥æ­´ãƒªã‚¹ãƒˆ
    state.computed.sortedHistory = [...state.history].sort((a, b) => new Date(b.date) - new Date(a.date));

    // 5. è¡¨ç¤ºç”¨å±¥æ­´ï¼ˆrecordsToShowåˆ†ï¼‰
    state.computed.displayHistory = state.computed.sortedHistory.slice(
      0,
      state.recordsToShow || UI?.HISTORY_INITIAL_RECORDS || 10,
    );

    // 6. æ•™å®¤åˆ¥äºˆç´„çŠ¶æ³
    state.computed.classroomBookingStatus = {};
    state.classrooms.forEach(classroom => {
      const classroomSlots = state.computed.slotsByClassroom[classroom] || [];
      state.computed.classroomBookingStatus[classroom] = {
        totalSlots: classroomSlots.length,
        availableSlots: classroomSlots.filter(s => !s.isFull).length,
        myBookingsCount: state.myBookings.filter(b => b.classroom === classroom).length,
        slotsByMonth: classroomSlots.reduce((acc, slot) => {
          const month = new Date(slot.date).getMonth() + 1;
          if (!acc[month]) acc[month] = [];
          acc[month].push(slot);
          return acc;
        }, {}),
      };
    });
  }

  // =================================================================
  // --- Legacy Utilities (Backward Compatibility) ---
  // -----------------------------------------------------------------
  // æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®äº’æ›æ€§ã®ãŸã‚ã®é–¢æ•°ç¾¤ã§ã™ã€‚
  // =================================================================

  /**
   * æŒ‡å®šã•ã‚ŒãŸæ•™å®¤ã®ã€ä»Šæ—¥ä»¥é™ã®ç©ºãã‚¹ãƒ­ãƒƒãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
   * @param {Array} slots - å…¨ã‚¹ãƒ­ãƒƒãƒˆã®é…åˆ—ï¼ˆæœªä½¿ç”¨ã€äº’æ›æ€§ã®ãŸã‚æ®‹å­˜ï¼‰
   * @param {string} classroom - æ•™å®¤å
   * @returns {Array} ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸã‚¹ãƒ­ãƒƒãƒˆé…åˆ—
   */
  const filterFutureSlots = (slots, classroom) => {
    updateComputedData(); // è¨ˆç®—ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
    return appState.computed.slotsByClassroom[classroom] || [];
  };

  /**
   * ã‚¹ãƒ­ãƒƒãƒˆã‚’æœˆåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¾ã™ã€‚
   * @param {Array} slots - ã‚¹ãƒ­ãƒƒãƒˆã®é…åˆ—ï¼ˆæœªä½¿ç”¨ã€äº’æ›æ€§ã®ãŸã‚æ®‹å­˜ï¼‰
   * @returns {Object} æœˆã‚’ã‚­ãƒ¼ã¨ã—ãŸã‚¹ãƒ­ãƒƒãƒˆã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  const groupSlotsByMonth = slots => {
    updateComputedData(); // è¨ˆç®—ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
    return appState.computed.slotsByMonth;
  };

  // =================================================================
  // --- Accounting Cache Utilities ---
  // -----------------------------------------------------------------
  // FE-14: ä¼šè¨ˆå…¥åŠ›å†…å®¹ã‚’localStorageã«ä¸€æ™‚ä¿å­˜ã™ã‚‹æ©Ÿèƒ½
  // =================================================================

  /**
   * ä¼šè¨ˆå…¥åŠ›ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’localStorageã«ä¿å­˜ã™ã‚‹
   * @param {string} reservationId - äºˆç´„ID
   * @param {object} accountingData - ä¿å­˜ã™ã‚‹ä¼šè¨ˆãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  function saveAccountingCache(reservationId, accountingData) {
    if (!reservationId || !accountingData) return;
    const cacheKey = `accounting_cache_${reservationId}`;
    try {
      localStorage.setItem(cacheKey, JSON.stringify(accountingData));
    } catch (e) {
      console.error('Failed to save accounting cache:', e);
    }
  }

  /**
   * localStorageã‹ã‚‰ä¼šè¨ˆå…¥åŠ›ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
   * @param {string} reservationId - äºˆç´„ID
   * @returns {object|null} - èª­ã¿è¾¼ã‚“ã ä¼šè¨ˆãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã¾ãŸã¯null
   */
  function loadAccountingCache(reservationId) {
    if (!reservationId) return null;
    const cacheKey = `accounting_cache_${reservationId}`;
    try {
      const cachedData = localStorage.getItem(cacheKey);
      return cachedData ? JSON.parse(cachedData) : null;
    } catch (e) {
      console.error('Failed to load accounting cache:', e);
      return null;
    }
  }

  /**
   * localStorageã‹ã‚‰ä¼šè¨ˆå…¥åŠ›ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹
   * @param {string} reservationId - äºˆç´„ID
   */
  function clearAccountingCache(reservationId) {
    if (!reservationId) return;
    const cacheKey = `accounting_cache_${reservationId}`;
    try {
      localStorage.removeItem(cacheKey);
    } catch (e) {
      console.error('Failed to clear accounting cache:', e);
    }
  }

  // =================================================================
  // --- Accounting Utilities ---
  // -----------------------------------------------------------------

  /**
   * æ–™é‡‘ãƒã‚¹ã‚¿ã‹ã‚‰ã€æŒ‡å®šã•ã‚ŒãŸæ•™å®¤ã¨é …ç›®åã«åˆè‡´ã™ã‚‹æˆæ¥­æ–™ãƒ«ãƒ¼ãƒ«ã‚’å–å¾—ã—ã¾ã™ã€‚
   * @param {Array} master - æ–™é‡‘ãƒã‚¹ã‚¿ (appState.accountingMaster)
   * @param {string} classroom - æ•™å®¤å
   * @param {string} itemName - é …ç›®å
   * @returns {object|undefined} - è©²å½“ã™ã‚‹æˆæ¥­æ–™ãƒ«ãƒ¼ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  const getTuitionItemRule = (master, classroom, itemName) => {
    if (!master || !classroom || !itemName) return undefined;
    return master.find(
      item =>
        item['ç¨®åˆ¥'] === C.itemTypes.TUITION &&
        item['é …ç›®å'] === itemName &&
        item['å¯¾è±¡æ•™å®¤'] &&
        item['å¯¾è±¡æ•™å®¤'].includes(classroom),
    );
  };

  // =================================================================
  // --- Accounting Calculation Logic ---
  // -----------------------------------------------------------------
  // ä¼šè¨ˆç”»é¢ã§ã®è¤‡é›‘ãªæ–™é‡‘è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã§ã™ã€‚
  // æˆæ¥­æ–™ã€ææ–™è²»ã€å‰²å¼•ãªã©ã‚’å‹•çš„ã«è¨ˆç®—ã—ã€åˆè¨ˆé‡‘é¡ã‚’ç®—å‡ºã—ã¾ã™ã€‚
  // =================================================================

  /**
   * ä¼šè¨ˆè¨ˆç®—ã‚’å®Ÿè¡Œã—ã€appState.computed.accountingCalculationã«çµæœã‚’ä¿å­˜ã—ã¾ã™ã€‚
   * @returns {object} è¨ˆç®—çµæœè©³ç´°
   */
  function calculateAccountingDetails() {
    if (!appState.accountingMaster) return null;

    const details = calculateAccountingDetailsFromForm();

    // appState.computedã«çµæœã‚’ä¿å­˜
    appState.computed.accountingCalculation = details;

    // UIè¦ç´ ã®æ›´æ–°
    updateAccountingUI(details);

    return details;
  }

  /**
   * ãƒ•ã‚©ãƒ¼ãƒ ã®å†…å®¹ã‹ã‚‰ä¼šè¨ˆè¨ˆç®—ã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆappStateç‹¬ç«‹ï¼‰ã€‚
   * @returns {object} è¨ˆç®—çµæœè©³ç´°
   */
  function calculateAccountingDetailsFromForm() {
    let tuitionSubtotal = 0;
    let salesSubtotal = 0;
    const details = {
      tuition: { items: [] },
      sales: { items: [] },
      grandTotal: 0,
      paymentMethod: '',
      items: [],
    };
    const form = document.getElementById('accounting-form');
    if (!form) return details;

    const r = appState.accountingReservation;
    const tuitionItemRule = getTuitionItemRule(appState.accountingMaster, r.classroom, C.items.MAIN_LECTURE);
    const isTimeBased = tuitionItemRule && tuitionItemRule['å˜ä½'] === C.units.THIRTY_MIN;

    // æ™‚é–“åˆ¶æˆæ¥­æ–™è¨ˆç®—
    if (isTimeBased) {
      const timeBasedResult = calculateTimeBasedTuition(tuitionItemRule);
      if (timeBasedResult) {
        tuitionSubtotal += timeBasedResult.price;
        details.tuition.items.push(timeBasedResult.item);
      }
    }

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é …ç›®è¨ˆç®—
    const checkboxResult = calculateCheckboxItems();
    tuitionSubtotal += checkboxResult.tuitionSubtotal;
    salesSubtotal += checkboxResult.salesSubtotal;
    details.tuition.items.push(...checkboxResult.tuitionItems);
    details.sales.items.push(...checkboxResult.salesItems);
    details.items.push(...checkboxResult.allItems);

    // å‰²å¼•è¨ˆç®—
    const discountResult = calculateDiscount();
    if (discountResult) {
      tuitionSubtotal -= discountResult.amount;
      details.tuition.items.push(discountResult.item);
    }

    // ææ–™è²»è¨ˆç®—
    const materialResult = calculateMaterials();
    salesSubtotal += materialResult.subtotal;
    details.sales.items.push(...materialResult.items);

    // ãã®ä»–è²©å£²å“è¨ˆç®—
    const otherSalesResult = calculateOtherSales();
    salesSubtotal += otherSalesResult.subtotal;
    details.sales.items.push(...otherSalesResult.items);

    // åˆè¨ˆè¨ˆç®—
    details.tuition.subtotal = tuitionSubtotal;
    details.sales.subtotal = salesSubtotal;
    details.grandTotal = tuitionSubtotal + salesSubtotal;
    details.paymentMethod = form.querySelector('input[name="payment-method"]:checked')?.value || 'ç¾é‡‘';

    return details;
  }

  /**
   * æ™‚é–“åˆ¶æˆæ¥­æ–™ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
   */
  function calculateTimeBasedTuition(tuitionItemRule) {
    const startTime = document.getElementById('start-time')?.value;
    const endTime = document.getElementById('end-time')?.value;
    const breakMinutes = parseInt(document.getElementById('break-time')?.value || 0, 10);

    if (startTime && endTime && startTime < endTime) {
      const start = new Date(`1970-01-01T${startTime}:00`);
      const end = new Date(`1970-01-01T${endTime}:00`);
      let diffMinutes = (end - start) / 60000 - breakMinutes;

      if (diffMinutes > 0) {
        const billableUnits = Math.ceil(diffMinutes / 30);
        const price = billableUnits * Number(tuitionItemRule['å˜ä¾¡']);
        return {
          price: price,
          item: { name: `æˆæ¥­æ–™ (${startTime} - ${endTime})`, price: price },
          billableUnits: billableUnits,
        };
      }
    }
    return null;
  }

  /**
   * ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é …ç›®ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
   */
  function calculateCheckboxItems() {
    let tuitionSubtotal = 0;
    let salesSubtotal = 0;
    const tuitionItems = [];
    const salesItems = [];
    const allItems = [];

    const form = document.getElementById('accounting-form');
    form.querySelectorAll('input[type="checkbox"].accounting-item').forEach(cb => {
      if (cb.checked || cb.disabled) {
        const itemName = cb.dataset.itemName;
        const itemType = cb.dataset.itemType;
        const masterItem = appState.accountingMaster.find(m => m['é …ç›®å'] === itemName && m['ç¨®åˆ¥'] === itemType);
        if (!masterItem) return;

        const price = Number(masterItem['å˜ä¾¡']);
        const itemDetail = { name: itemName, price: price };
        allItems.push(itemDetail);

        if (itemType === C.itemTypes.TUITION) {
          tuitionSubtotal += price;
          tuitionItems.push(itemDetail);
        } else {
          salesSubtotal += price;
          salesItems.push(itemDetail);
        }
      }
    });

    return { tuitionSubtotal, salesSubtotal, tuitionItems, salesItems, allItems };
  }

  /**
   * å‰²å¼•ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
   */
  function calculateDiscount() {
    const discountSelector = document.getElementById('discount-selector');
    if (discountSelector) {
      const discountRule = appState.accountingMaster.find(item => item['é …ç›®å'] === C.items.DISCOUNT);
      if (discountRule) {
        const discountMinutes = parseInt(discountSelector.value, 10);
        if (discountMinutes > 0) {
          const discountAmount = (discountMinutes / 30) * Math.abs(Number(discountRule['å˜ä¾¡']));
          return {
            amount: discountAmount,
            item: {
              name: `${C.items.DISCOUNT} (${discountMinutes}åˆ†)`,
              price: -discountAmount,
            },
          };
        }
      }
    }
    return null;
  }

  /**
   * ææ–™è²»ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
   */
  function calculateMaterials() {
    let subtotal = 0;
    const items = [];

    const materialContainer = document.getElementById('materials-container');
    if (materialContainer) {
      const materialRows = materialContainer.querySelectorAll('div[data-material-row-index]');
      materialRows.forEach((row, index) => {
        const type = document.getElementById(`material-type-${index}`)?.value;
        const masterItem = appState.accountingMaster.find(m => m['é …ç›®å'] === type);
        const priceEl = document.getElementById(`material-price-${index}`);

        if (!masterItem) {
          if (priceEl) priceEl.textContent = '0å††';
          return;
        }

        const unitPrice = Number(masterItem['å˜ä¾¡']);
        let finalName = type;
        let price = 0;

        if (masterItem['å˜ä½'] === UNIT_CM3) {
          const l = document.getElementById(`material-l-${index}`)?.value || 0;
          const w = document.getElementById(`material-w-${index}`)?.value || 0;
          const h = document.getElementById(`material-h-${index}`)?.value || 0;
          if (l > 0 && w > 0 && h > 0) {
            const volumeCm = (l / 10) * (w / 10) * (h / 10);
            let calculatedPrice = Math.round((volumeCm * unitPrice) / 100) * 100;
            price = Math.max(100, calculatedPrice);
            finalName = `${type} (${l}x${w}x${h}mm)`;
          }
        } else {
          if (type) price = unitPrice;
        }

        if (priceEl) priceEl.textContent = `${price.toLocaleString()}å††`;
        if (price > 0) {
          const itemDetail = { name: finalName, price: price };
          subtotal += price;
          items.push(itemDetail);
        }
      });
    }

    return { subtotal, items };
  }

  /**
   * ãã®ä»–è²©å£²å“ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
   */
  function calculateOtherSales() {
    let subtotal = 0;
    const items = [];

    const otherSalesContainer = document.getElementById('other-sales-container');
    if (otherSalesContainer) {
      const otherSalesRows = otherSalesContainer.querySelectorAll('div[data-other-sales-row]');
      otherSalesRows.forEach((row, index) => {
        const name = document.getElementById(`other-sales-name-${index}`)?.value.trim();
        const priceInput = document.getElementById(`other-sales-price-${index}`);
        let priceValue = priceInput.value
          .replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xfee0))
          .replace(/[^0-9.-]/g, '');
        priceInput.value = priceValue;
        const price = Number(priceValue || 0);

        if (name && price !== 0) {
          const itemDetail = { name: name, price: price };
          subtotal += price;
          items.push(itemDetail);
        }
      });
    }

    return { subtotal, items };
  }

  /**
   * ä¼šè¨ˆUIã‚’æ›´æ–°ã—ã¾ã™ã€‚
   */
  function updateAccountingUI(details) {
    const tuitionBreakdownEl = document.getElementById('tuition-breakdown');
    const calculatedHoursEl = document.getElementById('calculated-hours');
    const tuitionSubtotalEl = document.getElementById('tuition-subtotal');
    const salesSubtotalEl = document.getElementById('sales-subtotal');
    const grandTotalEl = document.getElementById('grand-total-amount');

    // æ™‚é–“åˆ¶æˆæ¥­æ–™ã®è¡¨ç¤ºæ›´æ–°
    if (tuitionBreakdownEl) {
      const tuitionBreakdownHtml = details.tuition.items
        .map(
          item =>
            `<div class="flex justify-between${item.price < 0 ? ' text-red-600' : ''}"><span>${item.name}</span><span>${item.price.toLocaleString()}å††</span></div>`,
        )
        .join('');
      tuitionBreakdownEl.innerHTML = tuitionBreakdownHtml;
    }

    // å—è¬›æ™‚é–“è¡¨ç¤ºã®æ›´æ–°
    if (calculatedHoursEl && appState.computed.accountingCalculation) {
      const timeBasedItems = details.tuition.items.filter(item => item.name.includes('æˆæ¥­æ–™ ('));
      if (timeBasedItems.length > 0) {
        const r = appState.accountingReservation;
        const tuitionItemRule = getTuitionItemRule(appState.accountingMaster, r.classroom, C.items.MAIN_LECTURE);
        if (tuitionItemRule) {
          const billableUnits = Math.ceil(timeBasedItems[0].price / Number(tuitionItemRule['å˜ä¾¡']));
          calculatedHoursEl.textContent = `å—è¬›æ™‚é–“: ${billableUnits * 0.5}æ™‚é–“ Ã— ${2.0 * tuitionItemRule['å˜ä¾¡']}å††`;
        }
      } else {
        calculatedHoursEl.textContent = '';
      }
    }

    // å°è¨ˆãƒ»åˆè¨ˆã®è¡¨ç¤ºæ›´æ–°
    if (tuitionSubtotalEl) tuitionSubtotalEl.textContent = `å°è¨ˆ: ${details.tuition.subtotal.toLocaleString()}å††`;
    if (salesSubtotalEl) salesSubtotalEl.textContent = `å°è¨ˆ: ${details.sales.subtotal.toLocaleString()}å††`;
    if (grandTotalEl) grandTotalEl.textContent = `åˆè¨ˆ: ${details.grandTotal.toLocaleString()}å††`;
  }
</script>
