<script>
  /**
   * =================================================================
   * ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: 12_WebApp_StateManager.html
   * ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘: 2.0 (ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ)
   * ã€å½¹å‰²ã€‘: ã‚·ãƒ³ãƒ—ãƒ«ã§ç¢ºå®ŸãªçŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
   * - ç„¡é™ãƒ«ãƒ¼ãƒ—ã®å®Œå…¨å›é¿
   * - æ—¢å­˜äº’æ›æ€§ã¯ç„¡è¦–ã€æ–°ã—ã„è¨­è¨ˆ
   * - ãƒ†ã‚¹ãƒˆç’°å¢ƒç‰¹åŒ–
   * =================================================================
   */

  /**
   * ã‚·ãƒ³ãƒ—ãƒ«ãªçŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
   */
  class SimpleStateManager {
    constructor() {
      this.state = {
        // åŸºæœ¬ãƒ‡ãƒ¼ã‚¿
        currentUser: null,
        slots: [],
        myBookings: [],
        history: [],
        accountingMaster: null,
        classrooms: [],
        constants: null,

        // ãã®ä»–å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
        today: null,
        isFirstTimeBooking: false,
        registrationPhone: null,
        completionMessage: '',
        recordsToShow: 10,
        editingReservationDetails: null,
        accountingReservation: null,

        // UIçŠ¶æ…‹
        view: 'login',
        selectedClassroom: null,
        selectedSlot: null,
        loading: false,

        // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹
        isDataFresh: false,

        // è¨ˆç®—æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿
        computed: {
          sortedBookings: [],
          sortedHistory: [],
          displayHistory: [],
        }
      };

      this.isUpdating = false; // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ãƒ•ãƒ©ã‚°

      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµ±ä¸€å®šæ•°ã‚’å³åº§ã«è¨­å®šï¼ˆã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
      this.initializeFallbackConstants();
    }

    /**
     * çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
     * @param {Object} newState - æ–°ã—ã„çŠ¶æ…‹
     */
    updateState(newState) {
      if (this.isUpdating) {
        console.warn('çŠ¶æ…‹æ›´æ–°ä¸­ã®ãŸã‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }

      this.isUpdating = true;

      try {
        // çŠ¶æ…‹ã‚’ç›´æ¥æ›´æ–°
        Object.assign(this.state, newState);

        // çµ±ä¸€å®šæ•°ãŒè¨­å®šã•ã‚ŒãŸå ´åˆã€ã‚°ãƒ­ãƒ¼ãƒãƒ«çŸ­ç¸®å‚ç…§ã‚’åˆæœŸåŒ–
        // window.CãŒãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ{}ã§åˆæœŸåŒ–ã•ã‚Œã‚‹ãŸã‚ã€
        // !window.Cã§ã¯æ­£ã—ãåˆ¤å®šã§ããªã„ã€‚
        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç©ºã‹ã©ã†ã‹ã‚‚ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã€‚
        if (newState.constants && (!window.C || Object.keys(window.C).length === 0)) {
          this.initializeGlobalConstants();
        }

        // åŸºæœ¬çš„ãªè¨ˆç®—æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        this.updateComputed();

        console.log('âœ… çŠ¶æ…‹æ›´æ–°å®Œäº†:', Object.keys(newState));
      } catch (error) {
        console.error('âŒ çŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      } finally {
        this.isUpdating = false;
      }
    }

    /**
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«çµ±ä¸€å®šæ•°ã®çŸ­ç¸®å‚ç…§ã‚’åˆæœŸåŒ–
     */
    initializeGlobalConstants() {
      if (!this.state.constants) return;

      const constants = this.state.constants;

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŸ­ç¸®å‚ç…§ã‚’è¨­å®š
      window.C = constants;
      window.STATUS = constants.status || {};
      window.UI = constants.ui || {};
      window.BANK = constants.bankInfo || {};
      window.PAYMENT = constants.paymentDisplay || {};

      console.log('ğŸ“‹ çµ±ä¸€å®šæ•°ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ã‚’åˆæœŸåŒ–:', Object.keys(constants));
    }

    /**
     * è¨ˆç®—æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®åŸºæœ¬æ›´æ–°
     */
    updateComputed() {
      if (!this.state.myBookings || !this.state.history) return;

      // åŸºæœ¬çš„ãªã‚½ãƒ¼ãƒˆå‡¦ç†
      this.state.computed.sortedBookings = [...this.state.myBookings]
        .sort((a, b) => new Date(b.date) - new Date(a.date));

      this.state.computed.sortedHistory = [...this.state.history]
        .sort((a, b) => new Date(b.date) - new Date(a.date));

      // è¡¨ç¤ºã™ã‚‹å±¥æ­´ã®æ•°ã‚’ recordsToShow ã«åŸºã¥ã„ã¦å‹•çš„ã«è¨ˆç®—
      this.state.computed.displayHistory = this.state.computed.sortedHistory.slice(0, this.state.recordsToShow);
    }

    /**
     * ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å®šæ•°ã‚’åˆæœŸåŒ–ã™ã‚‹
     * ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ¬ç‰©ã®å®šæ•°ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§ã®é–“ã®ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹
     */
    initializeFallbackConstants() {
      if (window.C && Object.keys(window.C).length > 0) return; // æ—¢ã«è¨­å®šæ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„

      window.C = {};
      window.STATUS = {
        CANCEL: 'cancel',
        WAITING: 'waiting',
      };
      window.UI = {
        HISTORY_INITIAL_RECORDS: 10,
        HISTORY_LOAD_MORE_RECORDS: 10,
        LOADING_MESSAGE_INTERVAL: 3000,
      };
      window.BANK = {};
      window.PAYMENT = { CASH: 'ç¾é‡‘' };
      console.log('ğŸ“‹ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®šæ•°ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ');
    }

    /**
     * ç¾åœ¨ã®çŠ¶æ…‹ã‚’å–å¾—
     */
    getState() {
      return this.state;
    }
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
  window.stateManager = new SimpleStateManager();

  // ã‚·ãƒ³ãƒ—ãƒ«ãªappStateï¼ˆãƒ—ãƒ­ã‚­ã‚·ãªã—ï¼‰
  window.appState = window.stateManager.state;

  // ã‚·ãƒ³ãƒ—ãƒ«ãªsetStateï¼ˆrenderå‘¼ã³å‡ºã—ãªã—ï¼‰
  window.setState = function(newState) {
    console.log('ğŸ”„ setState:', Object.keys(newState));
    window.stateManager.updateState(newState);

    // renderé–¢æ•°ã¯å‘¼ã³å‡ºã—å…ƒãŒæ˜ç¤ºçš„ã«å®Ÿè¡Œ
    console.log('ğŸ’¡ render()ã‚’æ‰‹å‹•ã§å‘¼ã³å‡ºã—ã¦ãã ã•ã„');
  };

</script>
