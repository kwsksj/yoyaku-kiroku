<!--
=================================================================
【ファイル名】: 10_WebApp.html
【バージョン】: 26.0 (モジュール化対応版)
【更新日時】: 2025-08-04
【説明】:
- 設定とモック機能を外部ファイルに分離
- より保守性の高い構造に改善
- テスト環境とプロダクション環境の分離
=================================================================
-->
<!doctype html>
<html lang="ja" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <base target="_top" />
    <title>きぼりの よやく・きろく 川崎誠二木彫り教室</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
      media="print"
      onload="this.media='all'"
    />
    <noscript>
      <link
        href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet"
      />
    </noscript>
    <style>
      body {
        font-family: 'Zen Kaku Gothic New', sans-serif;
      }
      .markdown-content h1,
      .markdown-content h2,
      .markdown-content h3 {
        margin-top: 1.2em;
        margin-bottom: 0.6em;
        font-weight: bold;
      }
      .markdown-content h1 {
        font-size: 1.5em;
      }
      .markdown-content h2 {
        font-size: 1.25em;
      }
      .markdown-content h3 {
        font-size: 1.1em;
      }
      .markdown-content p {
        margin-bottom: 1em;
      }
      .markdown-content ul {
        list-style-type: disc;
        margin-left: 1.5em;
        margin-bottom: 1em;
      }
      .markdown-content li {
        margin-bottom: 0.25em;
      }
      .markdown-content a {
        color: #2563eb; /* blue-600 */
        text-decoration: underline;
      }
      .markdown-content strong {
        font-weight: bold;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>

  <body class="bg-brand-bg h-full">
    <!-- デバッグ情報表示エリア（本番環境では非表示） -->

    <!-- アプリケーションのメインコンテナ -->
    <div id="app" class="container mx-auto px-4 max-w-lg">
      <!-- ローディング画面 -->
      <div
        id="loading"
        class="loading-fade fixed inset-0 flex flex-col items-center justify-center z-50"
      >
        <div class="spinner mb-4"></div>
        <p id="loading-message" class="text-brand-text">
          アプリケーションを読み込み中...
        </p>
      </div>

      <!-- メインコンテンツ -->
      <main id="main-content" class="py-6 embedded-no-padding">
        <div id="view-container"></div>
      </main>

      <!-- モーダルオーバーレイ -->
      <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
          <div id="modal-body"></div>
        </div>
      </div>

      <!-- カスタムモーダル -->
      <div
        id="custom-modal"
        class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50"
      >
        <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
          <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
          <div id="modal-message" class="mb-6"></div>
          <div id="modal-buttons" class="flex gap-3 justify-end"></div>
        </div>
      </div>
      <footer class="text-center text-sm text-brand-muted mt-4">
        <p>きぼりの よやく・きろく</p>
        <p class="mt-2">
          <span
            id="privacy-policy-link"
            data-action="showPrivacyPolicy"
            class="text-brand-muted underline hover:text-brand-text cursor-pointer"
            >プライバシーポリシー</span
          >
        </p>
      </footer>
    </div>

    <!-- 統合JavaScriptはビルド時にここに挿入されます -->
    <!-- 設定・定数 -->

    <script>
      // 環境判定：本番環境かテスト環境かを確認
      const isProduction =
        window.location.href.includes('/exec?') ||
        (window.location.href.includes('/macros/s/') &&
          !window.location.href.includes('/dev'));

      // デバッグ制御（フロントエンド専用）
      const DEBUG_ENABLED = false; // 本番環境では false

      // デバッグ情報をコンソールに出力する関数（本番環境では無効化）
      function debugLog(message) {
        if (isProduction || !DEBUG_ENABLED) return; // 本番環境では何も表示しない
        console.log(
          '🔍 [DEBUG]',
          new Date().toLocaleTimeString() + ':',
          message,
        );
      }

      // 最初のテスト - これが表示されなければHTMLファイル自体が読み込まれていない
      debugLog('HTMLファイル読み込み確認テスト完了');
      debugLog('ページURL: ' + window.location.href);

      // GAS環境かどうかを判定
      const isGAS =
        typeof google !== 'undefined' && typeof google.script !== 'undefined';
      debugLog('GAS環境判定: ' + isGAS);

      // 事前取得システムを削除しました
      // シンプルなログインフローに変更したため不要

      // startPreloadInitialData関数を削除しました

      // updatePreloadStatus関数を削除しました

      function isPreloadedDataValid() {
        if (!window.appCache.initialData || !window.appCache.timestamp) {
          return false;
        }

        var age = Date.now() - window.appCache.timestamp;
        return age < window.appCache.maxAge;
      }

      function initializeApp() {
        debugLog('initializeApp実行開始');
        debugLog('isGAS: ' + isGAS);

        // 最適化された初期化チェック（アプローチ2改良版）
        function safeInitializeApp() {
          // 必要なコンポーネントの確認
          var allReady = true;
          var missingComponents = [];

          if (typeof DesignConfig === 'undefined') {
            allReady = false;
            missingComponents.push('DesignConfig');
          }
          if (typeof window.stateManager === 'undefined') {
            allReady = false;
            missingComponents.push('stateManager');
          }
          if (
            typeof window.stateManager !== 'undefined' &&
            typeof window.stateManager.dispatch !== 'function'
          ) {
            allReady = false;
            missingComponents.push('stateManager.dispatch');
          }
          if (typeof hideLoading !== 'function') {
            allReady = false;
            missingComponents.push('hideLoading');
          }

          debugLog(
            '初期化条件チェック - 不足: ' + missingComponents.join(', '),
          );

          if (allReady) {
            // 全て準備完了 - 即座に初期化実行
            debugLog('⚡ 高速初期化実行 - 全コンポーネント準備完了！');
            debugLog(
              'stateManager.getState().lessons: ' +
                (window.stateManager.getState().lessons
                  ? window.stateManager.getState().lessons.length + '件'
                  : 'null'),
            );
            debugLog(
              'CONSTANTS.CLASSROOMS: ' + JSON.stringify(CONSTANTS.CLASSROOMS),
            );

            window.stateManager.dispatch({
              type: 'SET_STATE',
              payload: { view: 'login' },
            });
            hideLoading();

            // 事前取得システムを削除しました
            // シンプルなログインフローに変更
          } else {
            // 一部未準備 - 100ms間隔でリトライ（300ms → 100ms に短縮）
            setTimeout(safeInitializeApp, 100);
          }
        }

        // 最適化された初期化開始
        safeInitializeApp();
      }

      if (isGAS) {
        // GAS本番環境のみ初期化
        window.addEventListener('DOMContentLoaded', () => {
          initializeApp();
        });
      }
    </script>
  </body>
</html>
