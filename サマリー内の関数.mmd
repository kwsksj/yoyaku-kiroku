---
config:
  layout: elk
  theme: neutral
  look: handDrawn
---
flowchart TD
    subgraph "エントリーポイント (外部からの呼び出し)"
        A["<b>UIメニュー実行</b><br>rebuildSummarySheet"]
        B["<b>シート手動編集</b><br>triggerSummaryUpdateFromEdit"]
        C["<b>WebApp/バッチ処理</b><br>updateSummaryAndForm"]
    end

    subgraph "オーケストレーター (処理の振り分け)"
        D[rebuildSummarySheet<br><b>(全再構築)</b>]
        E[triggerSummaryUpdateFromEdit<br><b>(部分更新トリガー)</b>]
        F[updateSummaryAndForm<br><b>(統合更新)</b>]
    end

    subgraph "コアロジック (中核処理)"
        G["_updateSummaryForDate<br><b>(特定日のサマリー更新)</b>"]
    end

    subgraph "データ集計・生成 (計算と整形)"
        H["_getReservationCountsForDate<br>予約シートを読み、<br>セッション毎の予約数を集計"]
        I["_createSummaryRowData<br>予約数から空席を計算し、<br>サマリー行のデータ配列を生成"]
        J["_calculateTokyoAvailability<br>東京教室の特殊な<br>空席計算ロジック"]
    end

    subgraph "データアクセス (シート操作)"
        K["_writeOrUpdateSummaryRow<br>サマリーシートの<br>特定行を更新/追加"]
        L["_getVenueForDate<br>予約シートから<br>会場名を取得"]
    end
    
    subgraph "外部連携"
        M["<b>06_ExternalServices.js</b><br>setCheckboxChoices()"]
    end

    %% --- フローの定義 ---

    %% エントリーポイントからオーケストレーターへ
    A --> D
    B --> E
    C --> F

    %% オーケストレーターからコアロジックへ
    E -- "影響のあった日付毎にループ" --> G
    F -- "サマリー更新" --> G
    F -- "フォーム更新" --> M

    %% コアロジックからデータ集計・生成へ (時系列)
    G -- "1. 予約数を取得" --> H
    G -- "2. 会場名を取得" --> L
    G -- "4. 行データを生成" --> I
    
    %% 全再構築フロー
    D -- "1. 全予約シートを<br>スキャン・集計" --> H
    D -- "2. 集計結果を元に<br>全サマリー行を生成" --> I
    D -- "3. 全行をシートに<br>一括書き込み" --> K

    %% データ生成の内部フロー
    I -- "東京教室の場合" --> J
    
    %% コアロジックからデータアクセスへ
    G -- "5. シートに書き込み" --> K

    %% 戻り値の表現 (データフロー)
    H -- "予約数(Map)を返す" --> G
    L -- "会場名(string)を返す" --> G
    J -- "空席数(object)を返す" --> I
    I -- "行データ(Array)を返す" --> G
    I -- "行データ(Array)を返す" --> D

    %% スタイルの定義
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#f9f,stroke:#333,stroke-width:2px
    style C fill:#f9f,stroke:#333,stroke-width:2px
    
    style D fill:#cff,stroke:#333,stroke-width:2px
    style E fill:#cff,stroke:#333,stroke-width:2px
    style F fill:#cff,stroke:#333,stroke-width:2px

    style G fill:#e6ffc2,stroke:#333,stroke-width:2px