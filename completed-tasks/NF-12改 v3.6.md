# **【作業計画書】予約キャッシュの差分更新による即時反映 (NF-12改) v3.6**

【発行セッションID】: 統括-GAS予約システム改訂-羅針盤
【作業セッションID】: 作業-キャッシュ差分更新-v3.6

**【担当ファイル】**:

* 02-1\_BusinessLogic\_Batch.gs
* 02-2\_BusinessLogic\_Handlers.gs  
* 02-3\_BusinessLogic\_SheetUtils.gs  
* 05-2\_Backend\_Write.gs  
* 09\_Backend\_Endpoints.gs  
* 14\_WebApp\_Handlers.html

【タスク概要】:  
WebAppからの予約作成・キャンセル・**更新**時に、全シートをスキャンするのではなく、**既存のキャッシュをメモリ上で直接更新（差分更新）**し、その結果を書き戻す方式に変更する。これにより、ユーザーの体感速度を劇的に向上させつつ、データの一貫性を確保する。

**【具体的な指示（ハイブリッド方式）】**:
高速な**差分更新**を基本としつつ、データの乖離リスクを抑えるため、特定のタイミングでは信頼性の高い**全スキャン更新**を行う。

1. **ヘルパー関数の再定義(02-3_BusinessLogic_SheetUtils.gs)**:
    * **リネーム**: 既存の `_updateFutureBookingsCache(studentId)` を `_rebuildFutureBookingsCacheForStudent(studentId)` にリネームする。これは**全シートをスキャン**する信頼性が高いが重い処理と位置づける。
    * **新規作成**: `_getExistingCache(studentId)` を作成する。責務は、生徒名簿から**既存のキャッシュ(JSON文字列)を読み込み、パースして返す**ことのみ。
    * **新規作成**: `_writeCache(studentId, bookingsArray)` を作成する。責務は、引数の配列をJSON化し、名簿のキャッシュ列に書き込むことのみ。
    * **【最重要】新規作成**: `_updateFutureBookingsCacheIncrementally(studentId, changeType, payload)` を作成する。これが**差分更新のコアロジック**となる。
        * `changeType`: `'add'`, `'remove'`, `'update'` のいずれか。
        * `payload`: 追加・更新時は予約オブジェクト、削除時は `{ reservationId }`。
        * **処理内容**:
            a. `_getExistingCache` で既存キャッシュを取得。
            b. `changeType` に応じて配列をメモリ上で操作（追加、削除、更新）。
            c. 更新後の配列を日付でソート。
            d. `_writeCache` で書き戻し、更新後の配列を返す。

2. **コアロジックの改修（差分更新）  (05-2_Backend_Write.gs)**:
    * `makeReservation`, `cancelReservation`, `updateReservationDetails` の各関数を修正する。
    * これらの関数は、予約シートへの書き込み処理が成功した後、**新しく作成したヘルパー関数 `_updateFutureBookingsCacheIncrementally` を呼び出す**だけのシンプルな構成に変更する。
    * **makeReservation**:
        * シート書き込み後、新しい予約情報をオブジェクトとして構築する。
        * `_updateFutureBookingsCacheIncrementally(studentId, 'add', newBookingObject)` を呼び出す。
    * **cancelReservation**:
        * シート書き込み後、`_updateFutureBookingsCacheIncrementally(studentId, 'remove', { reservationId })` を呼び出す。
    * **updateReservationDetails**:
        * シート書き込み後、更新後の予約情報をオブジェクトとして構築する。
        * `_updateFutureBookingsCacheIncrementally(studentId, 'update', updatedBookingObject)` を呼び出す。
    * 各関数は、ヘルパー関数から返された**更新後のキャッシュ**を、自身の戻り値に含めてフロントエンドに返す。

3. **エンドポイントの改修 (09_Backend_Endpoints.gs)**:
    * `makeReservationAndGetLatestData`, `cancelReservationAndGetLatestData`, `updateReservationDetails` に関連するエンドポイントを修正する。
    * `05-2`の各関数 (`makeReservation`, `cancelReservation`, `updateReservationDetails`) から返された `newBookingsCache` を、そのままフロントエンドへの戻り値に含めるようにする。

4. **フロントエンドの改修 (14_WebApp_Handlers.html)**:
    * `confirmBooking`, `cancel`, `updateReservation` の各アクションハンドラを修正する。
    * サーバーからの成功応答 (`r`) を受け取った後、`appState.myBookings` を `r.newBookingsCache` で**直接上書き**するロジックに変更する。これにより、楽観的UI更新を廃止し、サーバーの正データを信頼する構成が完了する。

5. **バッチ処理との同期（全スキャン更新） (02-1_BusinessLogic_Batch.gs)**:
    * `transferPastReservationsToArchive` 関数を修正する。
    * 処理の最後に、アーカイブ対象となった**全てのユニークな生徒ID**のリストを作成する。
    * そのリストをループし、各生徒IDに対して、信頼性重視の `_rebuildFutureBookingsCacheForStudent(studentId)` を呼び出す。

6. **手動編集との同期（全スキャン更新） (02-2_BusinessLogic_Handlers.gs)**:
    * `handleReservationSheetEdit` 関数内のキャッシュ更新処理を、リネーム後の `_rebuildFutureBookingsCacheForStudent(studentId)` の呼び出しに修正する。

7. **プロトコルの遵守**:
    * 全ての修正内容は、『記録の書』に定められた**「差分パッチ・プロトコル」**に厳密に従い、まず**パッチとして提案**すること。承認を得るまで、最終的なコードを反映させてはならない。
