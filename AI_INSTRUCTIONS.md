# GEMINI.md (Geminiへの指示書)

> このファイルは、このリポジトリでGeminiが開発作業を行う際の、ルールとガイドラインを定義します。

## 最重要ルール (Top Priority Rules)

このセクションは、このプロジェクトで作業する上での最も重要なルールです。何をするにも、まずこれらのルールを最優先してください。

1. **編集対象は `src/` のみ:**
   - **絶対に `build-output/` ディレクトリ内のファイルは編集しないでください。** すべての開発作業は `src/` ディレクトリで行います。

2. **ビルドを常に実行:**
   - `src/` 内のファイルを編集した後は、**必ずビルドコマンドを実行**して変更を `build-output/` に反映させる必要があります。
   - テスト環境への反映には `npm run dev:test` を使用します。

3. **定義済みのワークフローに従う:**
   - 開発、テスト、本番反映の一連の作業は、後述の `開発ワークフローと主要コマンド` に記載された手順とコマンドに厳密に従ってください。

4. **UIコンポーネントの再利用:**
   - フロントエンドのUI要素を追加・変更する際は、必ず `src/frontend/13_WebApp_Components.js` に定義された既存のコンポーネントと `src/frontend/11_WebApp_Config.js` のデザイン定義を再利用してください。ゼロからHTMLを作成しないでください。

---

## 開発ワークフローと主要コマンド

開発からデプロイまでの基本的な流れは以下の通りです。原則として、ここに記載されたコマンドを使用してください。

**1. 開発**

- `src/` ディレクトリ内のファイルを編集します。
- JSDocの追加・修正を行った場合は、`npm run types:refresh` を実行して型定義を更新・チェックします。

**2. 品質チェックとビルド**

- `npm run build`
  - **コミット前の推奨コマンド。**
  - `check`（フォーマット、Lint、型定義生成・チェック）を実行後、`build-output`に成果物を生成します。
  - エラーがある場合はビルドが停止します。

**3. テスト環境への反映と確認**

- `npm run dev:test`
  - `build` を実行し、テスト環境へプッシュします。
  - ブラウザで動作確認が必要な場合は `npm run dev:open:test` を使用します。

**4. 本番環境へのデプロイ**

- `npm run dev:prod`
  - テスト環境で問題がないことを確認した後、このコマンドでビルドと本番環境へのプッシュを行います。
  - ブラウザでの確認も同時に行う場合は `npm run dev:open:prod` を使用します。

---

## コマンドリファレンス

**主要コマンド**

- `npm run check`: フォーマット、Lint、型定義の生成・チェックをすべて実行します。
- `npm run build`: `check` を実行後、問題がなければビルドを実行します。
- `npm run build:force`: 品質チェックをスキップして強制的にビルドを実行します。
- `npm run watch`: ファイル変更を監視し、自動でビルド（`build:force`）を実行します。

**型定義関連**

- `npm run types:refresh`: 型定義を再生成し、型チェックを実行します。JSDocを編集した際の必須コマンドです。
- `npm run types:generate`: 型定義のファイル（`.d.ts`）のみを再生成します。
- `npm run types:check`: 型チェックのみを実行します。

**補助コマンド**

- `npm run format`: Prettierによるコードフォーマット。
- `npm run lint:fix`: ESLintによる自動修正。
- `npm run switch:env -- prod|test`: `.clasp.json`を切り替えて、作業環境を変更します。

---

## Geminiへの指示

### 基本原則

- **最重要ルールの遵守**: ファイル冒頭の「最重要ルール」を常に最優先してください。
- **ワークフローの遵守**: `開発ワークフローと主要コマンド` に記載された手順に厳密に従ってください。
- **既存コードの尊重**: 既存のコードスタイル、命名規則、アーキテクチャを尊重し、一貫性を保ってください。

### コミュニケーションと言語

- **主要言語**: 可能な限り日本語で応答してください。
- **コードコメント**: 新しいコメントを追加する際は、日本語で記述してください。
- **ユーザーの好み**: 開発者は、より深い理解のために日本語でのコミュニケーションを好みます。

### コミット管理

- **積極的なコミット**: 機能の完成、バグ修正、アーキテクチャの変更など、適切な節目でコミットを行ってください。
- **ユーザーへの確認**: コミットする前に、常に「適切な節目でコミットしますか？」などとユーザーに確認を取ってください。
- **コミットの品質**: 変更内容とその影響について、明確な説明を含む包括的な日本語のコミットメッセージを記述してください。

### Markdown品質ガイドライン

- **見出しの使用**: セクションタイトルには、強調（**太字**）ではなく、適切なレベルの見出し（`##`など）を使用してください。
- **見出しの重複**: 同じ内容の見出しを複数作成しないでください（例: `## まとめ` が複数あるなど）。
- **コードブロックの言語指定**: コードブロックには常に言語（javascript, text, json, bash, htmlなど）を指定してください。

---

## プロジェクト概要

このプロジェクトは、木彫り教室の予約管理システム「きぼりの よやく・きろく」です。Google Apps Script（GAS）で構築されており、Googleスプレッドシートをデータベースとして使用し、Webアプリケーションのインターフェースを提供します。

開発者は、木彫り教室の唯一の講師であり、経営者であり、このシステムの管理者です。

### ✅ データモデル再設計 完了

教室ごとに分散していたデータ構造から、統合・正規化されたデータモデルへの移行に成功し、大幅なパフォーマンス改善を実現しました。詳細設計: **[DATA_MODEL.md](docs/DATA_MODEL.md)**

### 🚀 JavaScript分離開発アーキテクチャ (2025年9月6日導入)

**HTML内JavaScript問題の根本解決**: 開発時は純粋なJavaScriptファイルで作業し、デプロイ時に自動的にHTML形式に変換するハイブリッドアーキテクチャを導入しました。 **詳細設計**: [JS_TO_HTML_ARCHITECTURE.md](docs/JS_TO_HTML_ARCHITECTURE.md)

---

## アーキテクチャ概要

### 開発環境: JSDoc + checkJs + 型定義自動生成

このプロジェクトは、GASの制約下でモダンな開発体験を実現するため、以下の3つの技術を組み合わせた特殊な開発環境を採用しています。

1. **JSDocによる型付け:** ソースコード（`.js`）内にJSDoc形式で`@param`や`@type`などを記述し、型情報を定義します。
2. **`checkJs`によるリアルタイム検証:** `tsconfig.json`の`checkJs`設定により、TypeScriptコンパイラがJSDocとコードの間に矛盾がないかを常に監視します。
3. **型定義ファイルの自動生成:** `npm run types:generate`コマンドにより、JSDocからTypeScriptの型定義ファイル（`.d.ts`）を自動生成します。これにより、ファイル間でのコード補完や型参照が可能になります。

### ビルドプロセスによるコード変換

開発のしやすさとGAS環境の互換性を両立させるため、ビルドプロセス (`npm run build` など) 実行時に以下のコード自動変換が行われます。

1. **`export`文の除去:**
   - 開発時に使用する `export` キーワードは、GAS環境ではサポートされていません。
   - ビルド時にすべての `export` 文は自動的に除去され、GASのグローバルスコープで関数や変数が定義される形式に変換されます。
   - これにより、開発者はモダンなモジュール構文を使いながら、GASへのデプロイが可能です。

2. **定数ファイルの注入:**
   - `src/shared/00_Constants.js` は、フロントエンドとバックエンドの両方に自動的に組み込まれます。（詳細は「フロントエンドとバックエンドの境界」を参照）

3. **環境変数の設定:**
   - `CONSTANTS.ENVIRONMENT.PRODUCTION_MODE` の値が、ビルドターゲット（本番 or テスト）に応じて `true` または `false` に自動的に設定されます。

### ファイル構成

開発はすべて `src/` ディレクトリ内で行います。ビルド後、この構造が `build-output/` に反映されます。

- **`src/backend/`**
  - サーバーサイド（Googleのサーバー上）で実行されるロジックです。APIエンドポイント、データベース（スプレッドシート）操作、GASのコア機能が含まれます。
  - 例: `01_Code.js`, `05-2_Backend_Write.js`, `07_CacheManager.js`

- **`src/frontend/`**
  - フロントエンド（ユーザーのブラウザ上）で実行されるロジックです。UIのビュー、コンポーネント、イベントハンドラなどが含まれます。
  - 例: `11_WebApp_Config.js`, `13_WebApp_Components.js`, `14_WebApp_Handlers.js`

- **`src/shared/`**
  - **（最重要）** フロントエンドとバックエンドの両方で共有されるコードを配置します。
  - `00_Constants.js`: プロジェクト全体の定数ファイル。ビルド時に両方の環境に組み込まれる**唯一の共有ファイル**です。

- **`src/templates/`**
  - フロントエンドのベースとなるHTMLテンプレートです。ビルドプロセスで、`frontend/` と `shared/` のJavaScriptファイルがこのHTMLに統合されます。
  - `10_WebApp.html`

### フロントエンドとバックエンドの境界

- **原則:** フロントエンドとバックエンドは物理的に異なる環境で動作するため、互いの関数や変数を直接参照することはできません。
- **通信:** フロントエンドからバックエンドへの通信は、必ず `google.script.run` を介して非同期で行います。
- **唯一の例外:** `src/shared/00_Constants.js` のみ、ビルドプロセスによって両環境でグローバルな `CONSTANTS` オブジェクトとして利用可能になります。**他のファイルや変数はこの仕組みの対象外です。**

### データモデルとキャッシュ

Googleスプレッドシートをベースにした統合データモデル。詳細は [DATA_MODEL.md](docs/DATA_MODEL.md) を参照。

**多層キャッシュ**:

- **CacheService**: GASの組み込みキャッシュ。予約、生徒名簿などを6-24時間保持。
  - **差分更新システム (v5.0)**: 予約変更時に全件リロードせず、差分のみを更新することで95%以上の高速化を実現。
  - **分割キャッシュシステム (v5.5)**: 90KBを超えるデータを自動で分割し、100KBの制限を回避。
- **SpreadsheetManager**: スプレッドシートオブジェクトのセッション内キャッシュ。

### フロントエンドアーキテクチャ

**UIコンポーネントシステム (アトミックデザイン)**

- **場所**: `src/frontend/13_WebApp_Components.js`
- **設計原則**: 小さな部品（Atomic）から大きなUI（Organisms）を構築。再利用性を重視。
- **主要コンポーネント**: `Components.button`, `Components.modal`, `Components.cardContainer` など、定義済みのUI部品を常に使用してください。

**デザインシステム (DesignConfig)**

- **場所**: `src/frontend/11_WebApp_Config.js`
- **設計原則**: 色、余白、タイポグラフィなどのデザイン要素を定数として一元管理。ハードコードは禁止。
