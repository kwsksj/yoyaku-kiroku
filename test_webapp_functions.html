<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>WebApp Functions Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      .test-result {
        margin: 10px 0;
        padding: 5px;
        border-left: 3px solid #ddd;
      }
      .test-result.pass {
        border-left-color: green;
        background-color: #f0f8f0;
      }
      .test-result.fail {
        border-left-color: red;
        background-color: #f8f0f0;
      }
    </style>
  </head>
  <body>
    <h1>WebApp Functions Test Suite</h1>
    <div id="test-results"></div>

    <script>
      // DesignConfig のモック
      const DesignConfig = {
        colors: {
          text: 'text-brand-text',
          textSubtle: 'text-brand-subtle',
          primary: 'bg-action-primary-bg text-action-primary-text',
          secondary: 'bg-action-secondary-bg text-action-secondary-text',
        },
        cards: {
          base: 'w-full text-left p-3 rounded-lg',
          container: 'max-w-md mx-auto space-y-3',
          state: {
            available: { card: 'bg-gray-50', text: 'text-state-available-text' },
          },
        },
        buttons: {
          base: 'font-bold py-2.5 px-5 rounded-md transition-transform active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2',
          full: 'w-full',
        },
      };

      // Components のモック
      const Components = {
        createButton: (config) => {
          return `<button class="${config.colorClass} ${config.widthClass || ''}" data-action="${config.action || ''}" data-classroom="${config.classroom || ''}" data-date="${config.date || ''}">${config.text}</button>`;
        },
      };

      // formatDate のモック
      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        if (isNaN(d)) return '';
        return `${d.getMonth() + 1}/${d.getDate()}`;
      };

      // appState のモック
      const appState = {
        accountingReservation: { classroom: '東京教室' },
        slots: [
          {
            classroom: '東京教室',
            date: '2025-08-01',
            availableSlots: 5,
            isFull: false,
            venue: 'テスト会場',
          },
          {
            classroom: '東京教室',
            date: '2025-09-15',
            availableSlots: 3,
            isFull: false,
            venue: null,
          },
          {
            classroom: '沼津教室',
            date: '2025-08-10',
            availableSlots: 2,
            isFull: false,
            venue: null,
          },
          {
            classroom: '東京教室',
            date: '2025-07-20', // 過去の日付
            availableSlots: 1,
            isFull: false,
            venue: null,
          },
          {
            classroom: '東京教室',
            date: '2025-08-20',
            availableSlots: 0,
            isFull: true, // 満席
            venue: null,
          },
        ],
      };

      // テスト対象の関数をここに貼り付け
      const filterFutureAvailableSlots = (slots, classroom) => {
        if (!slots || !classroom) return [];

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        return slots.filter((s) => {
          const slotDate = new Date(s.date);
          slotDate.setMinutes(slotDate.getMinutes() + slotDate.getTimezoneOffset());
          return s.classroom === classroom && slotDate >= today && !s.isFull;
        });
      };

      const groupSlotsByMonth = (slots) => {
        return slots.reduce((acc, slot) => {
          const month = new Date(slot.date).getMonth() + 1;
          if (!acc[month]) acc[month] = [];
          acc[month].push(slot);
          return acc;
        }, {});
      };

      // テスト関数
      function runTests() {
        const results = [];

        // Test 1: filterFutureAvailableSlots
        console.log('Running filterFutureAvailableSlots tests...');

        const filteredSlots = filterFutureAvailableSlots(appState.slots, '東京教室');
        const expectedCount = 2; // 2025-08-01 と 2025-09-15 のみ（過去と満席は除外）

        if (filteredSlots.length === expectedCount) {
          results.push({
            name: 'filterFutureAvailableSlots - 件数テスト',
            status: 'pass',
            message: `期待値 ${expectedCount} 件, 実際 ${filteredSlots.length} 件`,
          });
        } else {
          results.push({
            name: 'filterFutureAvailableSlots - 件数テスト',
            status: 'fail',
            message: `期待値 ${expectedCount} 件, 実際 ${filteredSlots.length} 件`,
          });
        }

        // 過去の日付と満席が除外されているかチェック
        const pastDateExists = filteredSlots.some((s) => s.date === '2025-07-20');
        const fullSlotExists = filteredSlots.some((s) => s.isFull === true);

        if (!pastDateExists && !fullSlotExists) {
          results.push({
            name: 'filterFutureAvailableSlots - フィルタリング',
            status: 'pass',
            message: '過去の日付と満席が正しく除外されています',
          });
        } else {
          results.push({
            name: 'filterFutureAvailableSlots - フィルタリング',
            status: 'fail',
            message: '過去の日付または満席の除外に失敗',
          });
        }

        // Test 2: groupSlotsByMonth
        console.log('Running groupSlotsByMonth tests...');

        const groupedSlots = groupSlotsByMonth(filteredSlots);
        const monthKeys = Object.keys(groupedSlots);

        if (monthKeys.includes('8') && monthKeys.includes('9')) {
          results.push({
            name: 'groupSlotsByMonth - 月別グループ化',
            status: 'pass',
            message: '8月と9月のグループが作成されています',
          });
        } else {
          results.push({
            name: 'groupSlotsByMonth - 月別グループ化',
            status: 'fail',
            message: `作成された月: ${monthKeys.join(', ')}`,
          });
        }

        // Test 3: 統合テスト - getCompleteViewの一部ロジック
        console.log('Running integration tests...');

        const classroom = appState.accountingReservation?.classroom;
        if (classroom && appState.slots) {
          const relevantSlots = filterFutureAvailableSlots(appState.slots, classroom);
          const slotsByMonth = groupSlotsByMonth(relevantSlots);

          if (relevantSlots.length > 0 && Object.keys(slotsByMonth).length > 0) {
            results.push({
              name: '統合テスト - 完了画面ロジック',
              status: 'pass',
              message: '次回予約リストが正常に生成されます',
            });
          } else {
            results.push({
              name: '統合テスト - 完了画面ロジック',
              status: 'fail',
              message: '次回予約リストの生成に失敗',
            });
          }
        }

        // Test 4: エッジケースのテスト
        console.log('Running edge case tests...');

        // 空の配列
        const emptyResult = filterFutureAvailableSlots([], '東京教室');
        if (emptyResult.length === 0) {
          results.push({
            name: 'エッジケース - 空配列',
            status: 'pass',
            message: '空配列を正しく処理',
          });
        } else {
          results.push({
            name: 'エッジケース - 空配列',
            status: 'fail',
            message: '空配列の処理に失敗',
          });
        }

        // null パラメータ
        const nullResult = filterFutureAvailableSlots(null, '東京教室');
        if (nullResult.length === 0) {
          results.push({
            name: 'エッジケース - null パラメータ',
            status: 'pass',
            message: 'null パラメータを正しく処理',
          });
        } else {
          results.push({
            name: 'エッジケース - null パラメータ',
            status: 'fail',
            message: 'null パラメータの処理に失敗',
          });
        }

        // 存在しない教室
        const nonExistentClassroom = filterFutureAvailableSlots(appState.slots, '存在しない教室');
        if (nonExistentClassroom.length === 0) {
          results.push({
            name: 'エッジケース - 存在しない教室',
            status: 'pass',
            message: '存在しない教室を正しく処理',
          });
        } else {
          results.push({
            name: 'エッジケース - 存在しない教室',
            status: 'fail',
            message: '存在しない教室の処理に失敗',
          });
        }

        return results;
      }

      // テスト結果を表示
      function displayResults(results) {
        const container = document.getElementById('test-results');
        let html = '';

        const passed = results.filter((r) => r.status === 'pass').length;
        const total = results.length;

        html += `<div class="test-section">
                <h2>テスト結果概要</h2>
                <p><strong>${passed}/${total}</strong> テストが成功しました</p>
            </div>`;

        results.forEach((result) => {
          html += `<div class="test-result ${result.status}">
                    <strong>${result.name}</strong>: ${result.status === 'pass' ? '✅ 成功' : '❌ 失敗'}
                    <br><em>${result.message}</em>
                </div>`;
        });

        container.innerHTML = html;
      }

      // テスト実行
      window.onload = function () {
        console.log('Starting tests...');
        const results = runTests();
        displayResults(results);
        console.log('Tests completed. Results:', results);
      };
    </script>
  </body>
</html>
