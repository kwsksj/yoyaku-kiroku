# 📋 Backlog (タスク管理)

## Inbox (未整理メモ)

<!-- ここに思いついたことを自由に書いてください。AIが後で整理・分類します。 -->

---

## Bugs (不具合)

- [ ] **インクリメンタルキャッシュ更新の検証**
  - `src/backend/05-2_Backend_Write.js` の `addReservationToCache` 使用箇所(L545付近)に「要確認」コメントあり
  - 新規予約時のキャッシュ更新と `rowForCache` のデータ形式を確認

### リロード・デプロイ時の安定性

- [ ] **リロード時のローディング状態管理改善** ⭐
  - 現状: データ再取得中に古いデータが一瞬表示される可能性
  - 改善: `needsDataRefresh()` が `true` の場合、`render()` を遅延実行
  - 対象ファイル: `src/frontend/14_WebApp_Handlers.js` (L1377-1476)
  - 優先度: 高（UX改善、ちらつき防止）

- [ ] **状態復元時のビュー不整合対策**
  - 現状: sessionStorage復元時、ビューとデータの不整合が発生する可能性
  - 改善: 復元後のビュー検証ロジック追加（データ不足時は安全なビューへ遷移）
  - 対象ファイル: `src/frontend/12_WebApp_StateManager.js` (L705-758)
  - 優先度: 中（エッジケース対応）

- [ ] **管理者ログイン時のビュー遷移タイミング改善**
  - 現状: データ取得完了前にビュー遷移が発生し、空のログビューが表示される可能性
  - 改善: `goToLogView()` 呼び出し前にデータ取得完了を確認
  - 対象ファイル: `src/frontend/14_WebApp_Handlers_Auth.js` (L124-176)
  - 優先度: 中（管理者UX改善）

---

## UI Improvements (UI改善)

### 認証・登録関連

- [ ] **新規登録画面にウェルカムメッセージ表示**
  - 入力画面の前に簡単な説明を表示

### セッション終了フロー関連

- [ ] **会計画面のUIを統一**
  - 他の画面との統一感を持たせる

### ダッシュボード関連

### 予約画面関連

- [ ] セッション終了フローの予約画面と似たデザインにする

### 参加者ビュー関連

- [ ] **みんなのよやく・きろく UI/UX検討**
  - 予約と記録の分離を検討
  - 参加者ビューの整理
- [ ] PC表示時のレイアウト調整
- [ ] コンテナの表示幅を広く固定し、スクロールをコンテナ全体に対しておこなうようにする

---

## Features (機能追加)

### ログ関連

- [ ] ユーザーのページ遷移・画面表示ログの取得・可視化

### 進捗共有関連

- [ ] **画像アップロード機能**
  - 進捗状況を写真でアップしてもらう仕組み
  - 講師が生徒について思い出しやすくなる
  - 生徒自身が進捗を振り返れる
  - 生徒同士で進捗を共有できる
  - ストレージ: Google Drive（2TB中79GB使用、余裕あり）

### データ管理関連

- [ ] **`setDataFreshness` 機能の実装**
  - 予約完了時などに再取得を防ぐフラグ管理機能
  - `SimpleStateManager` に `setDataFreshness(key, boolean)` メソッド追加

---

## Performance Improvements (パフォーマンス改善)

### データ保存・復元

- [ ] **終了フロー中の入力をリアルタイム保存**
  - 現状: ステップ移動時にのみキャッシュ更新
  - 改善: 各ステップの textarea/input に `input` イベントリスナーを追加
  - 対象: きろく、もくひょう、よやく（材料/注文品）、会計
  - 優先度: 低（現状でも大きな問題なし）

- [ ] **必要な情報をローカルに事前保存** ⭐
  - `lessons`, `myReservations`, `accountingMaster` を sessionStorage に追加保存
  - リロード時のデータ再取得を削減
  - サイズ制限は余裕あり（ユーザー確認済み）
  - 注意: データ不整合リスクへの対応（バージョン管理・有効期限）
  - 優先度: 中（UX向上、ただしデータ不整合リスク要対策）
  - 📄 実装詳細: [docs/RELOAD_OPTIMIZATION.md](docs/RELOAD_OPTIMIZATION.md)

- [ ] **リロード時の二重データ取得防止**
  - 現状: リロード時に `needsDataRefresh()` と初回 `render()` で二重にデータ取得される可能性
  - 改善: データ取得フラグ（`_dataFetchInProgress`）の活用を強化
  - 対象ファイル: `src/frontend/12_WebApp_StateManager.js` (L831-883)
  - 優先度: 中（パフォーマンス改善、API呼び出し削減）

- [ ] **sessionStorageサイズ監視機能**
  - `saveStateToStorage()` で保存サイズを監視
  - 4MB超過時に警告ログ出力
  - QuotaExceededError のエラーハンドリング追加
  - 優先度: 中（上記「ローカル事前保存」実装時に必須）
  - 📄 実装詳細: [docs/RELOAD_OPTIMIZATION.md](docs/RELOAD_OPTIMIZATION.md)

- [ ] **データ再取得のタイムアウト処理**
  - リロード時のデータ再取得に30秒タイムアウトを追加
  - タイムアウト時はログイン画面へ遷移しユーザーに通知
  - 優先度: 中（ネットワーク不安定時のUX改善）
  - 📄 実装詳細: [docs/RELOAD_OPTIMIZATION.md](docs/RELOAD_OPTIMIZATION.md)

### API最適化

- [ ] **参加者ビューとログビューのデータ同時取得**
  - バックエンドに統合エンドポイント追加
  - または既存エンドポイント拡張で1回のAPI呼び出しに
  - 対象: `getAdminLogsWithMetadata` と参加者データ取得の統合
  - 優先度: 低（現状でも十分高速）

---

## Refactoring (リファクタリング)

### 状態管理・データフロー

- [ ] **状態復元ロジックの整理**
  - 現状: `restoreStateFromStorage()` と `needsDataRefresh()` の責務が不明確
  - 改善: 復元フローを明確化、エラーハンドリング強化
  - 対象ファイル: `src/frontend/12_WebApp_StateManager.js` (L705-997)
  - 優先度: 中（保守性向上、バグ予防）
  - 備考: ログイン種別の追加により、データ再取得のログ記録は改善済み

### コード品質

- [ ] **フォーム入力キャッシュの重複コード削減**
  - ダッシュボード・履歴ビューで重複している `input` イベントリスナー設定を共通化
  - `SimpleStateManager` に `setupTextareaCache(textarea, cacheKey)` メソッド追加
  - 優先度: 低（動作に問題なし、保守性向上のため）
  - 📄 実装詳細: [docs/RELOAD_OPTIMIZATION.md](docs/RELOAD_OPTIMIZATION.md)

- [ ] **型定義の整備（formInputCache）**
  - `UIState` インターフェースに `formInputCache` プロパティを明示的に追加
  - ブラケット表記（`state['formInputCache']`）から通常のプロパティアクセスへ変更
  - 型安全性の向上
  - 優先度: 低（TypeScript型チェックの恩恵を受けるため）
  - 📄 実装詳細: [docs/RELOAD_OPTIMIZATION.md](docs/RELOAD_OPTIMIZATION.md)

- [ ] 不要なコードを削除する

---

## Completed (完了済み)

<!-- 完了後は日付とともにここに移動 -->

### 2026/01

- [x] **ログイン種別の追加** (2026-01-15)
  - 初回ログイン、リロード時のデータ再取得を区別できるようログ記録を改善
  - 新しいログアクション定数 `USER_DATA_REFRESH` を追加
  - `authenticateUser()`, `getLoginData()` にデータ再取得フラグを追加
  - テスト環境にデプロイ済み（APP_VERSION: 2026.01.15.0012）
- [x] **ログイン処理とデータ再取得の分離** (2026-01-15)
  - `authenticateUser()` にデータ再取得フラグ (`isDataRefresh`) を追加
  - ログ記録を適切なアクション（ログイン/データ再取得）で実行
  - 認証とデータ取得の責務を明確に分離
- [x] **リロード時データ再取得エラーのユーザー通知** (2026-01-11)
  - データ再取得失敗時にエラーメッセージを表示
  - UX改善とデバッグ支援
- [x] **初回判定ロジック調査・切り替えスイッチ改善** (2026-01-11)
  - 初回判定ロジックは仕様通り実装済みを確認
  - 切り替えスイッチをピル型デザインに変更（`Components.pillToggle`追加）
- [x] **画面リロード時のデータ復元**
  - sessionStorage復元後にデータがない場合は自動で再取得
  - 管理者ログビューでもリロード後に正しくログが表示される
- [x] **セッション終了フロー改善**
  - 予約ステップのボタン文言を条件分岐（新規予約 vs 既存予約/スキップ）
  - 確認画面で複数の将来予約をすべて表示
  - 「きょう の まとめ」ボタンを2カラム幅に拡大
- [x] **管理者モードでログ内容をアプリ内で確認可能にする**
  - 操作ログビューを追加、参加者ビューから遷移可能
- [x] **ログシートの記載内容改善**
  - ログ詳細(`details`)のキーを定数化(`CONSTANTS`)
  - メッセージ列の内容調整
- [x] **ログビューの改善**
  - ユーザー名クリックで生徒詳細モーダルを表示
- [x] **セッション終了フロー予約画面UI改善**
  - スロットカード: `renderSlotCard` 統一、経験者のみラベル、満席表示改善
  - 日程リスト: よやく済/空き通知とうろく中マーク、満席表示、★おすすめ削除
  - 既存予約: 進むボタンバグ修正、予約済み表示切替、時間選択プルダウン
- [x] **SessionConclusionリファクタリング**
  - `getLessonInfo` 統合、`getSlotDescriptionText` 削除
  - 予約後のけいかく更新バグ修正
- [x] **フォーム入力保持機能**
  - `formInputCache` による統一的な入力データ管理
  - ダッシュボード目標・メモ編集中のリロード復元
  - セッション終了フロー中のリロード復元（ステップ移動時にキャッシュ）

### 2025/12

- [x] 売上自動転載バグ修正
- [x] ログシート空行バグ修正
- [x] ログ/予約シート昇順ソート対応
- [x] ログシート自動スクロール機能追加
- [x] きろくカードのシンプル化
- [x] きろくカードのリストビュー化
