# 📋 Backlog (タスク管理)

## Inbox (未整理メモ)

<!-- ここに思いついたことを自由に書いてください。AIが後で整理・分類します。 -->

- 参加者ビュー、ログビューで表示しているデータの取得日時を上部に控えめに表示する
- よやく詳細画面の、販売品項目の見え方を調整
- ログイン時に、参加者ビューのデータも取得するのは？

---

## Bugs (不具合)

- [ ] **インクリメンタルキャッシュ更新の検証**
  - `src/backend/05-2_Backend_Write.js` の `addReservationToCache` 使用箇所(L545付近)に「要確認」コメントあり
  - 新規予約時のキャッシュ更新と `rowForCache` のデータ形式を確認

### リロード・デプロイ時の安定性

- [x] **リロード時のローディング状態管理改善** ⭐ (2026-01-15)
  - view-containerクリア後にローディング画面を表示、データ取得完了後にrender()実行
  - 既存実装で対応済み

- [x] **状態復元時のビュー不整合対策** (2026-01-15)
  - `_validateRestoredView()` メソッドを追加
  - ログイン必須ビュー・コンテキスト必須ビューの検証を実装
  - データ不足時は安全なビュー（dashboard/login）へフォールバック

- [ ] **管理者ログイン時のビュー遷移タイミング改善**
  - 現状: データ取得完了前にビュー遷移が発生し、空のログビューが表示される可能性
  - 改善: `goToLogView()` 呼び出し前にデータ取得完了を確認
  - 対象ファイル: `src/frontend/14_WebApp_Handlers_Auth.js` (L124-176)
  - 優先度: 中（管理者UX改善）

---

## UI Improvements (UI改善)

### 認証・登録関連

- [ ] **新規登録画面にウェルカムメッセージ表示**
  - 入力画面の前に簡単な説明を表示

### セッション終了フロー関連

- [ ] **会計画面のUIを統一**
  - 他の画面との統一感を持たせる

### ダッシュボード関連

### 予約画面関連

- [ ] セッション終了フローの予約画面と似たデザインにする

### 参加者ビュー関連

- [ ] **みんなのよやく・きろく UI/UX検討**
  - [ ] PC表示時のレイアウト調整
  - [ ] コンテナの表示幅を広く固定し、スクロールをコンテナ全体に対しておこなうようにする
- [ ] システム全体で、PC表示時の状態について調査検討と修正

---

## Features (機能追加)

### ログ関連

- [ ] ユーザーのページ遷移・画面表示ログの取得・可視化

### 進捗共有関連

- [ ] **画像アップロード機能**
  - 進捗状況を写真でアップしてもらう仕組み
  - 講師が生徒について思い出しやすくなる
  - 生徒自身が進捗を振り返れる
  - 生徒同士で進捗を共有できる
  - ストレージ: Google Drive（2TB中79GB使用、余裕あり）

### データ管理関連

- [ ] **`setDataFreshness` 機能の実装**
  - 予約完了時などに再取得を防ぐフラグ管理機能
  - `SimpleStateManager` に `setDataFreshness(key, boolean)` メソッド追加

---

## Performance Improvements (パフォーマンス改善)

### データ保存・復元

- [ ] **終了フロー中の入力をリアルタイム保存**
  - 現状: ステップ移動時にのみキャッシュ更新
  - 改善: 各ステップの textarea/input に `input` イベントリスナーを追加
  - 対象: きろく、もくひょう、よやく（材料/注文品）、会計
  - 優先度: 低（現状でも大きな問題なし）

- [x] **リロード時の二重データ取得防止** (2026-01-15)
  - `restorationInfo.state === 'RESTORED_NEEDS_REFRESH'` チェックで既に対応済み
  - render()はデータ取得成功/失敗後のみ呼び出される設計

- [x] **データ再取得のタイムアウト処理** (2026-01-15)
  - リロード時のデータ再取得に15秒タイムアウトを追加
  - タイムアウト時はログイン画面へ遷移しユーザーに通知
  - 📄 実装詳細: [docs/RELOAD_OPTIMIZATION.md](docs/RELOAD_OPTIMIZATION.md)

### API最適化

- [ ] **参加者ビューとログビューのデータ同時取得**
  - バックエンドに統合エンドポイント追加
  - または既存エンドポイント拡張で1回のAPI呼び出しに
  - 対象: `getAdminLogsWithMetadata` と参加者データ取得の統合
  - 優先度: 低（現状でも十分高速）

---

## Refactoring (リファクタリング)

### コード品質

- [ ] **フォーム入力キャッシュの重複コード削減**
  - ダッシュボード・履歴ビューで重複している `input` イベントリスナー設定を共通化
  - `SimpleStateManager` に `setupTextareaCache(textarea, cacheKey)` メソッド追加
  - 優先度: 低（動作に問題なし、保守性向上のため）
  - 📄 実装詳細: [docs/RELOAD_OPTIMIZATION.md](docs/RELOAD_OPTIMIZATION.md)

- [ ] **型定義の整備（formInputCache）**
  - `UIState` インターフェースに `formInputCache` プロパティを明示的に追加
  - ブラケット表記（`state['formInputCache']`）から通常のプロパティアクセスへ変更
  - 型安全性の向上
  - 優先度: 低（TypeScript型チェックの恩恵を受けるため）
  - 📄 実装詳細: [docs/RELOAD_OPTIMIZATION.md](docs/RELOAD_OPTIMIZATION.md)

- [ ] 不要なコードを削除する

---

## Completed (完了済み)

<!-- 完了後は日付とともにここに移動 -->

### 2026/01

- [x] **ローカルデータキャッシュ機能** (2026-01-15)
  - `lessons`, `myReservations`, `accountingMaster` をsessionStorageに保存
  - リロード時のデータ再取得を削減（2-3秒 → 0.5秒未満）
  - sessionStorageサイズ監視機能（4MB超過警告、QuotaExceededErrorフォールバック）
  - データ鮮度チェック（有効期限30分、バージョンチェック）
  - データ再取得判定の最適化
  - テスト環境にデプロイ済み、動作確認完了
- [x] **参加者ビューのフィルター切り替えをピルトグルに変更** (2026-01-15)
  - `tabGroup`から`pillToggle`コンポーネントに変更
  - ラベルを「みんな の よやく」「みんな の きろく」に変更
  - 教室フィルターと同じ形式で統一感を向上
  - テスト環境にデプロイ済み（APP_VERSION: 2026.01.15.1819）
- [x] **参加者ビューデータの保存とリロード復元** (2026-01-16)
  - `participantLessons`, `participantReservationsMap`等をsessionStorageに保存
  - リロード時に参加者ビューがそのまま復元される
  - 容量超過時は既存のQuotaExceededErrorハンドリングでフォールバック
- [x] **参加者ビューの更新ボタンを全ユーザーに表示** (2026-01-16)
  - 更新ボタン: 全ユーザーに表示
  - 操作ログ・ログアウトボタン: 管理者のみ表示
- [x] **状態復元ロジックの整理** (2026-01-15)
  - Phase 1: 明確な状態機械、詳細なエラー情報、統合API (`getRestorationInfo()`) 追加
  - Phase 2: 復元理由のログ記録、フロントエンドを新しいAPIに移行
  - ログシートの詳細列に復元理由を記録（デバッグ性向上）
  - テスト環境にデプロイ済み（APP_VERSION: 2026.01.15.0735）
- [x] **ログイン種別の追加** (2026-01-15)
  - 初回ログイン、リロード時のデータ再取得を区別できるようログ記録を改善
  - 新しいログアクション定数 `USER_DATA_REFRESH` を追加
  - `authenticateUser()`, `getLoginData()` にデータ再取得フラグを追加
  - テスト環境にデプロイ済み（APP_VERSION: 2026.01.15.0012）
- [x] **ログイン処理とデータ再取得の分離** (2026-01-15)
  - `authenticateUser()` にデータ再取得フラグ (`isDataRefresh`) を追加
  - ログ記録を適切なアクション（ログイン/データ再取得）で実行
  - 認証とデータ取得の責務を明確に分離
- [x] **リロード時データ再取得エラーのユーザー通知** (2026-01-11)
  - データ再取得失敗時にエラーメッセージを表示
  - UX改善とデバッグ支援
- [x] **初回判定ロジック調査・切り替えスイッチ改善** (2026-01-11)
  - 初回判定ロジックは仕様通り実装済みを確認
  - 切り替えスイッチをピル型デザインに変更（`Components.pillToggle`追加）
- [x] **画面リロード時のデータ復元**
  - sessionStorage復元後にデータがない場合は自動で再取得
  - 管理者ログビューでもリロード後に正しくログが表示される
- [x] **セッション終了フロー改善**
  - 予約ステップのボタン文言を条件分岐（新規予約 vs 既存予約/スキップ）
  - 確認画面で複数の将来予約をすべて表示
  - 「きょう の まとめ」ボタンを2カラム幅に拡大
- [x] **管理者モードでログ内容をアプリ内で確認可能にする**
  - 操作ログビューを追加、参加者ビューから遷移可能
- [x] **ログシートの記載内容改善**
  - ログ詳細(`details`)のキーを定数化(`CONSTANTS`)
  - メッセージ列の内容調整
- [x] **ログビューの改善**
  - ユーザー名クリックで生徒詳細モーダルを表示
- [x] **セッション終了フロー予約画面UI改善**
  - スロットカード: `renderSlotCard` 統一、経験者のみラベル、満席表示改善
  - 日程リスト: よやく済/空き通知とうろく中マーク、満席表示、★おすすめ削除
  - 既存予約: 進むボタンバグ修正、予約済み表示切替、時間選択プルダウン
- [x] **SessionConclusionリファクタリング**
  - `getLessonInfo` 統合、`getSlotDescriptionText` 削除
  - 予約後のけいかく更新バグ修正
- [x] **フォーム入力保持機能**
  - `formInputCache` による統一的な入力データ管理
  - ダッシュボード目標・メモ編集中のリロード復元
  - セッション終了フロー中のリロード復元（ステップ移動時にキャッシュ）

### 2025/12

- [x] 売上自動転載バグ修正
- [x] ログシート空行バグ修正
- [x] ログ/予約シート昇順ソート対応
- [x] ログシート自動スクロール機能追加
- [x] きろくカードのシンプル化
- [x] きろくカードのリストビュー化
