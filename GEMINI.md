# GEMINI.md (Geminiへの指示書)

> このファイルは、このリポジトリでGeminiが開発作業を行う際の、ルールとガイドラインを定義します。

## 最重要ルール (Top Priority Rules)

このセクションは、このプロジェクトで作業する上での最も重要なルールです。何をするにも、まずこれらのルールを最優先してください。

1. **編集対象は `src/` のみ:**
    - **絶対に `build-output/` ディレクトリ内のファイルは編集しないでください。** すべての開発作業は `src/` ディレクトリで行います。

2. **ビルドを常に実行:**
    - `src/` 内のファイルを編集した後は、**必ずビルドコマンドを実行**して変更を `build-output/` に反映させる必要があります。
    - テスト環境への反映には `npm run dev:test` を使用します。

3. **定義済みのワークフローに従う:**
    - 開発、テスト、本番反映の一連の作業は、後述の `開発ワークフローと主要コマンド` に記載された手順とコマンドに厳密に従ってください。

4. **UIコンポーネントの再利用:**
    - フロントエンドのUI要素を追加・変更する際は、必ず `src/frontend/13_WebApp_Components.js` に定義された既存のコンポーネントと `src/frontend/11_WebApp_Config.js` のデザイン定義を再利用してください。ゼロからHTMLを作成しないでください。

---

## 開発ワークフローと主要コマンド

開発からデプロイまでの基本的な流れは以下の通りです。原則として、ここに記載されたコマンドを使用してください。

**1. 開発**

- `src/` ディレクトリ内のファイルを編集します。

**2. 品質チェック（コミット前）**

- `npm run check`
  - Prettier, ESLint, Markdownlint, 型チェックをまとめて実行します。

**3. テスト環境への反映と確認**

- `npm run dev:test`
  - 変更をビルドし、テスト環境へプッシュします。
  - ブラウザで動作確認が必要な場合は `npm run dev:open:test` を使用します。

**4. 本番環境へのデプロイ**

- `npm run dev:prod`
  - テスト環境で問題がないことを確認した後、このコマンドでビルドと本番環境へのプッシュを行います。
  - ブラウザでの確認も同時に行う場合は `npm run dev:open:prod` を使用します。

**環境判定機能:**

- ビルド時に `PRODUCTION_MODE` が自動で設定されます（本番環境: `true`, テスト環境: `false`）。
- テスト環境では、管理者への通知メールの件名に `[テスト]` というプレフィックスが自動で追加されます。

---

## コマンドリファレンス

**補助コマンド**

- `npm run format`: Prettierによるコードフォーマット。
- `npm run lint:fix`: ESLintによる自動修正。
- `npm run dev:build`: ビルドのみを実行します（通常は`dev:test`や`dev:prod`に含まれます）。
- `npm run dev:watch`: ファイル変更を監視し、自動でビルドを実行します。
- `npm run switch:env -- prod|test`: `.clasp.json`を切り替えて、作業環境を変更します。

---

## Geminiへの指示

### 基本原則

- **最重要ルールの遵守**: ファイル冒頭の「最重要ルール」を常に最優先してください。
- **ワークフローの遵守**: `開発ワークフローと主要コマンド` に記載された手順に厳密に従ってください。
- **既存コードの尊重**: 既存のコードスタイル、命名規則、アーキテクチャを尊重し、一貫性を保ってください。

### コミュニケーションと言語

- **主要言語**: 可能な限り日本語で応答してください。
- **コードコメント**: 新しいコメントを追加する際は、日本語で記述してください。
- **ユーザーの好み**: 開発者は、より深い理解のために日本語でのコミュニケーションを好みます。

### コミット管理

- **積極的なコミット**: 機能の完成、バグ修正、アーキテクチャの変更など、適切な節目でコミットを行ってください。
- **ユーザーへの確認**: コミットする前に、常に「適切な節目でコミットしますか？」などとユーザーに確認を取ってください。
- **コミットの品質**: 変更内容とその影響について、明確な説明を含む包括的な日本語のコミットメッセージを記述してください。

### Markdown品質ガイドライン

- **見出しの使用**: セクションタイトルには、強調（**太字**）ではなく、適切なレベルの見出し（`##`など）を使用してください。
- **見出しの重複**: 同じ内容の見出しを複数作成しないでください（例: `## まとめ` が複数あるなど）。
- **コードブロックの言語指定**: コードブロックには常に言語（javascript, text, json, bash, htmlなど）を指定してください。

---

## プロジェクト概要

このプロジェクトは、木彫り教室の予約管理システム「きぼりの よやく・きろく」です。Google Apps Script（GAS）で構築されており、Googleスプレッドシートをデータベースとして使用し、Webアプリケーションのインターフェースを提供します。

開発者は、木彫り教室の唯一の講師であり、経営者であり、このシステムの管理者です。

### ✅ データモデル再設計 完了

教室ごとに分散していたデータ構造から、統合・正規化されたデータモデルへの移行に成功し、大幅なパフォーマンス改善を実現しました。
詳細設計: **[DATA_MODEL.md](docs/DATA_MODEL.md)**

### 🚀 JavaScript分離開発アーキテクチャ (2025年9月6日導入)

**HTML内JavaScript問題の根本解決**: 開発時は純粋なJavaScriptファイルで作業し、デプロイ時に自動的にHTML形式に変換するハイブリッドアーキテクチャを導入しました。
**詳細設計**: [JS_TO_HTML_ARCHITECTURE.md](docs/JS_TO_HTML_ARCHITECTURE.md)  

---

## アーキテクチャ概要

### ファイル構成

開発はすべて `src/` ディレクトリ内で行います。ビルド後、この構造が `build-output/` に反映されます。

- **`src/backend/`**
  - サーバーサイドのロジック、APIエンドポイント、Google Apps Scriptのコア機能に関連するファイルが含まれます。
  - 例: `01_Code.js`, `05-2_Backend_Write.js`, `07_CacheManager.js`
  - **（重要）**: このディレクトリにある `00_Constants.js` は、サーバーサイドとフロントエンドの両方から利用されるグローバルな定数ファイルです。ビルド時にフロントエンドのHTMLにも統合されます。

- **`src/frontend/`**
  - Webアプリのフロントエンドを構成するJavaScriptファイルが含まれます。UIのビュー、コンポーネント、イベントハンドラなどがここにあります。
  - 例: `11_WebApp_Config.js`, `13_WebApp_Components.js`, `14_WebApp_Handlers.js`

- **`src/templates/`**
  - フロントエンドのベースとなるHTMLテンプレートファイルが含まれます。ビルドプロセスで、`frontend/` のJavaScriptファイルがこのHTMLに統合されます。
  - `10_WebApp.html`

### データモデルとキャッシュ

Googleスプレッドシートをベースにした統合データモデル。詳細は [DATA_MODEL.md](docs/DATA_MODEL.md) を参照。

**多層キャッシュ**:

- **CacheService**: GASの組み込みキャッシュ。予約、生徒名簿などを6-24時間保持。
  - **差分更新システム (v5.0)**: 予約変更時に全件リロードせず、差分のみを更新することで95%以上の高速化を実現。
  - **分割キャッシュシステム (v5.5)**: 90KBを超えるデータを自動で分割し、100KBの制限を回避。
- **SpreadsheetManager**: スプレッドシートオブジェクトのセッション内キャッシュ。

### フロントエンドアーキテクチャ

**UIコンポーネントシステム (アトミックデザイン)**

- **場所**: `src/frontend/13_WebApp_Components.js`
- **設計原則**: 小さな部品（Atomic）から大きなUI（Organisms）を構築。再利用性を重視。
- **主要コンポーネント**: `Components.button`, `Components.modal`, `Components.cardContainer` など、定義済みのUI部品を常に使用してください。

**デザインシステム (DesignConfig)**

- **場所**: `src/frontend/11_WebApp_Config.js`
- **設計原則**: 色、余白、タイポグラフィなどのデザイン要素を定数として一元管理。ハードコードは禁止。
