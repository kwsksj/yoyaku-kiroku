# gemini.md: プロフィール編集フローの高速化

## 1. 目的

プロフィールの更新処理後に発生する、アプリケーション全体のデータ再取得通信をなくします。これにより、サーバーとの通信を2回から1回に削減し、更新完了からダッシュボード表示までの時間を短縮します。

## 2. 解決策の概要

バックエンドの`updateUserProfile`関数が、成功時に更新後のユーザー情報を戻り値として返すように修正します。フロントエンドは、その戻り値を使ってローカルの`appState`を直接更新し、ダッシュボード画面に遷移します。これにより、データ再取得のための2回目の通信が不要になります。

---

## 3. ファイル別の具体的な作業内容

### 3.1. バックエンドの修正 (`src/04_Backend_User.js`)

`updateUserProfile`関数が、成功時に更新後のユーザー情報を返すように変更します。

#### 3.1.1. 変更点 (差分パッチ)

```diff
--- a/src/04_Backend_User.js
+++ b/src/04_Backend_User.js
@@ -342,7 +342,12 @@
         '成功',
         `本名: ${userInfo.realName}, 電話番号: ${userInfo.phone || 'N/A'}`,
       );
-      return { success: true, message: 'プロフィールを更新しました。' };
+      // ★★★ 変更点 ★★★
+      // 更新後のユーザー情報を戻り値に追加
+      return {
+        success: true,
+        message: 'プロフィールを更新しました。',
+        updatedUser: userInfo };
     } else {
       logActivity(userInfo.studentId, 'プロフィール更新', 'エラー', details);
       return { success: false, message: '更新対象のユーザーが見つかりませんでした。' };

```

### 3.2. フロントエンドの修正 (`src/14_WebApp_Handlers.html`)

`saveProfile`アクションの成功時のコールバック処理を変更し、不要になった`fetchInitialData`の呼び出しを削除します。

#### 3.2.1. 変更点 (差分パッチ)

```diff
--- a/src/14_WebApp_Handlers.html
+++ b/src/14_WebApp_Handlers.html
@@ -107,11 +107,11 @@
       google.script.run
         .withSuccessHandler((res) => {
           hideLoading();
           if (res.success) {
-            showInfo('プロフィールを更新しました', '更新完了', () => {
-              // After showing the success message, fetch all initial data again
-              // to ensure the state is fresh and complete, then go to the dashboard.
-              fetchInitialData(u);
-            });
+            // ★★★ 変更点 ★★★
+            // 戻り値の更新されたユーザー情報でローカルの状態を更新し、
+            // 追加通信なしでダッシュボードに遷移する
+            showInfo('プロフィールを更新しました', '更新完了');
+            setState({ currentUser: res.updatedUser, view: 'classroomSelect' });
           } else {
             showInfo(res.message || '更新に失敗しました');
           }
         })

```
