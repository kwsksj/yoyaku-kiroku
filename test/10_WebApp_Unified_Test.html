<!--
=================================================================
ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: 10_WebApp.html
ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘: 26.0 (ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–å¯¾å¿œç‰ˆ)
ã€æ›´æ–°æ—¥æ™‚ã€‘: 2025-08-04
ã€èª¬æ˜ã€‘:
- è¨­å®šã¨ãƒ¢ãƒƒã‚¯æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†é›¢
- ã‚ˆã‚Šä¿å®ˆæ€§ã®é«˜ã„æ§‹é€ ã«æ”¹å–„
- ãƒ†ã‚¹ãƒˆç’°å¢ƒã¨ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã®åˆ†é›¢
=================================================================
-->
<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <base target="_top" />
    <title>ãã¼ã‚Šã® ã‚ˆã‚„ããƒ»ãã‚ã å·å´èª äºŒæœ¨å½«ã‚Šæ•™å®¤</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="bg-brand-bg min-h-screen">
    <!-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="app" class="container mx-auto px-4 max-w-lg">
      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
      <div id="loading" class="fixed inset-0 bg-brand-bg flex flex-col items-center justify-center z-50">
        <div class="spinner mb-4"></div>
        <p id="loading-message" class="text-brand-text">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>

      <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <main id="main-content" class="hidden py-6">
        <div id="view-container"></div>
      </main>

      <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
      <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
          <div id="modal-body"></div>
        </div>
      </div>

      <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
      <div id="custom-modal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
          <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
          <div id="modal-message" class="mb-6"></div>
          <div id="modal-buttons" class="flex gap-3 justify-end"></div>
        </div>
      </div>
      <footer class="text-center text-sm text-brand-muted mt-4">ãã¼ã‚Šã® ã‚ˆã‚„ããƒ»ãã‚ã</footer>
    </div>

    <!-- çµ±åˆã•ã‚ŒãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ -->
    <script>
      console.log('[çµ±åˆç‰ˆ] çµ±åˆã•ã‚ŒãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œé–‹å§‹');

      
    // ========== 10_WebApp_Mock.html ==========

  /**
   * =================================================================
   * ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: 10_WebApp_Mock.html
   * ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘: 2.0
   * ã€å½¹å‰²ã€‘: Google Apps Scriptç’°å¢ƒã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§æ¨¡æ“¬ã™ã‚‹ãƒ¢ãƒƒã‚¯æ©Ÿèƒ½
   * - google.script.run API ã®å®Œå…¨ãªæ¨¡æ“¬
   * - ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æä¾›
   * - ãƒã‚§ãƒ¼ãƒ³å¯èƒ½ãªAPIæ§‹é€ ã®ã‚µãƒãƒ¼ãƒˆ
   * =================================================================
   */

  // ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã®æ¤œå‡º
  if (typeof window !== 'undefined' && !window.google) {
    console.log('[TEST] ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã‚’æ¤œå‡ºã—ã¾ã—ãŸ');

    // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã®å®šç¾©
    window.MockData = {
      currentUser: {
        studentId: 'TEST001',
        nickname: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
        realName: 'å±±ç”°å¤ªéƒ',
        phone: '09012345678',
      },
      slots: [
        {
          classroom: 'æ±äº¬æ•™å®¤',
          date: '2025-08-10',
          time: '09:00-12:00',
          session: 'åˆå‰',
          availableSlots: 3,
          venue: 'æ±äº¬ã‚¹ã‚¿ã‚¸ã‚ª',
          maxCapacity: 6,
          teacher: 'ç”°ä¸­å…ˆç”Ÿ',
        },
        {
          classroom: 'æ±äº¬æ•™å®¤',
          date: '2025-08-10',
          time: '13:00-16:00',
          session: 'åˆå¾Œ',
          availableSlots: 2,
          venue: 'æ±äº¬ã‚¹ã‚¿ã‚¸ã‚ª',
          maxCapacity: 6,
          teacher: 'ä½è—¤å…ˆç”Ÿ',
        },
        {
          classroom: 'ã¤ãã°æ•™å®¤',
          date: '2025-08-15',
          time: '09:00-12:00',
          session: 'åˆå‰',
          availableSlots: 4,
          venue: 'ã¤ãã°ã‚¹ã‚¿ã‚¸ã‚ª',
          maxCapacity: 8,
          teacher: 'éˆ´æœ¨å…ˆç”Ÿ',
        },
        {
          classroom: 'æ²¼æ´¥æ•™å®¤',
          date: '2025-08-20',
          time: '14:00-17:00',
          session: 'åˆå¾Œ',
          availableSlots: 1,
          venue: 'æ²¼æ´¥ã‚¹ã‚¿ã‚¸ã‚ª',
          maxCapacity: 4,
          teacher: 'é«˜æ©‹å…ˆç”Ÿ',
        },
      ],
      myBookings: [
        {
          reservationId: 'RES001',
          date: '2025-08-05',
          time: '09:00-12:00',
          classroom: 'æ±äº¬æ•™å®¤',
          venue: 'æ±äº¬ã‚¹ã‚¿ã‚¸ã‚ª',
          teacher: 'å±±ç”°å…ˆç”Ÿ',
          studentId: 'TEST001',
          studentName: 'ãƒ†ã‚¹ãƒˆå¤ªéƒ',
          status: 'confirmed',
          accountingDone: false,
          accountingDetails: null,
        },
      ],
      history: [
        {
          date: '2025-07-25',
          studentId: 'TEST001',
          studentName: 'ãƒ†ã‚¹ãƒˆå¤ªéƒ',
          amount: 2000,
          items: ['æ•™æè²»', 'æ–½è¨­åˆ©ç”¨æ–™'],
          status: 'completed',
        },
      ],
      classrooms: ['æ±äº¬æ•™å®¤', 'ã¤ãã°æ•™å®¤', 'æ²¼æ´¥æ•™å®¤'],
      accountingMaster: [
        // æˆæ¥­æ–™ - æ±äº¬æ•™å®¤
        { ç¨®åˆ¥: 'æˆæ¥­æ–™', é …ç›®å: 'åˆå›è¬›ç¿’', å˜ä¾¡: 2000, å˜ä½: 'å›', å¯¾è±¡æ•™å®¤: 'æ±äº¬æ•™å®¤' },
        { ç¨®åˆ¥: 'æˆæ¥­æ–™', é …ç›®å: 'æ—©å‡º', å˜ä¾¡: 600, å˜ä½: 'å›', å¯¾è±¡æ•™å®¤: 'æ±äº¬æ•™å®¤' },
        { ç¨®åˆ¥: 'æˆæ¥­æ–™', é …ç›®å: 'æœ¬è¬›åº§', å˜ä¾¡: 6600, å˜ä½: 'å›', å¯¾è±¡æ•™å®¤: 'æ±äº¬æ•™å®¤' },

        // æˆæ¥­æ–™ - ã¤ãã°æ•™å®¤
        { ç¨®åˆ¥: 'æˆæ¥­æ–™', é …ç›®å: '30åˆ†ã‚ãŸã‚Š', å˜ä¾¡: 600, å˜ä½: '30åˆ†', å¯¾è±¡æ•™å®¤: 'ã¤ãã°æ•™å®¤' },
        { ç¨®åˆ¥: 'æˆæ¥­æ–™', é …ç›®å: 'åˆå›è¬›ç¿’', å˜ä¾¡: 600, å˜ä½: '30åˆ†', å¯¾è±¡æ•™å®¤: 'ã¤ãã°æ•™å®¤' },
        { ç¨®åˆ¥: 'æˆæ¥­æ–™', é …ç›®å: 'åˆå›è¬›ç¿’åŒæ™‚é–“å‰²å¼•', å˜ä¾¡: -300, å˜ä½: '30åˆ†', å¯¾è±¡æ•™å®¤: 'ã¤ãã°æ•™å®¤' },

        // æˆæ¥­æ–™ - æ²¼æ´¥æ•™å®¤
        { ç¨®åˆ¥: 'æˆæ¥­æ–™', é …ç›®å: '30åˆ†ã‚ãŸã‚Š', å˜ä¾¡: 600, å˜ä½: '30åˆ†', å¯¾è±¡æ•™å®¤: 'æ²¼æ´¥æ•™å®¤' },
        { ç¨®åˆ¥: 'æˆæ¥­æ–™', é …ç›®å: 'åˆå›è¬›ç¿’', å˜ä¾¡: 600, å˜ä½: '30åˆ†', å¯¾è±¡æ•™å®¤: 'æ²¼æ´¥æ•™å®¤' },
        { ç¨®åˆ¥: 'æˆæ¥­æ–™', é …ç›®å: 'åˆå›è¬›ç¿’åŒæ™‚é–“å‰²å¼•', å˜ä¾¡: -300, å˜ä½: '30åˆ†', å¯¾è±¡æ•™å®¤: 'æ²¼æ´¥æ•™å®¤' },

        // å…±é€šæˆæ¥­æ–™
        { ç¨®åˆ¥: 'æˆæ¥­æ–™', é …ç›®å: 'å½«åˆ»åˆ€ãƒ¬ãƒ³ã‚¿ãƒ«', å˜ä¾¡: 500, å˜ä½: 'å›', å¯¾è±¡æ•™å®¤: 'å…±é€š' },

        // ç‰©è²©
        { ç¨®åˆ¥: 'ç‰©è²©', é …ç›®å: 'ãƒã‚¤ã‚¹é‹¼ å½«åˆ»åˆ€ 5æœ¬set æ¡ç®±ä»˜ã', å˜ä¾¡: 17000, å˜ä½: 'å€‹', å¯¾è±¡æ•™å®¤: 'å…±é€š' },
        { ç¨®åˆ¥: 'ç‰©è²©', é …ç›®å: 'ãƒã‚¤ã‚¹é‹¼ å½«åˆ»åˆ€3æœ¬set', å˜ä¾¡: 9800, å˜ä½: 'å€‹', å¯¾è±¡æ•™å®¤: 'å…±é€š' },
        { ç¨®åˆ¥: 'ç‰©è²©', é …ç›®å: 'åˆƒç‰©é‹¼ å½«åˆ»åˆ€ 5æœ¬set', å˜ä¾¡: 10200, å˜ä½: 'å€‹', å¯¾è±¡æ•™å®¤: 'å…±é€š' },
        { ç¨®åˆ¥: 'ç‰©è²©', é …ç›®å: 'åˆƒç‰©é‹¼ å½«åˆ»åˆ€3æœ¬set', å˜ä¾¡: 6200, å˜ä½: 'å€‹', å¯¾è±¡æ•™å®¤: 'å…±é€š' },
        { ç¨®åˆ¥: 'ç‰©è²©', é …ç›®å: 'ãƒ†ã‚­ã‚¹ãƒˆ', å˜ä¾¡: 1650, å˜ä½: 'å€‹', å¯¾è±¡æ•™å®¤: 'å…±é€š' },
        { ç¨®åˆ¥: 'ç‰©è²©', é …ç›®å: 'ä½œæ¥­å°ï¼ˆæœ€æ–°ç‰ˆï¼‰', å˜ä¾¡: 3500, å˜ä½: 'å€‹', å¯¾è±¡æ•™å®¤: 'å…±é€š' },
        { ç¨®åˆ¥: 'ç‰©è²©', é …ç›®å: 'ä½œæ¥­å° ä¸­å¤', å˜ä¾¡: 1000, å˜ä½: 'å€‹', å¯¾è±¡æ•™å®¤: 'å…±é€š' },
        { ç¨®åˆ¥: 'ç‰©è²©', é …ç›®å: 'ã‚³ãƒ«ã‚¯æ¿', å˜ä¾¡: 500, å˜ä½: 'å€‹', å¯¾è±¡æ•™å®¤: 'å…±é€š' },
        { ç¨®åˆ¥: 'ç‰©è²©', é …ç›®å: 'è€åˆ‡å‰µæ‰‹è¢‹ï¼ˆç‰‡æ‰‹ï¼‰', å˜ä¾¡: 1000, å˜ä½: 'å€‹', å¯¾è±¡æ•™å®¤: 'å…±é€š' },
        { ç¨®åˆ¥: 'ç‰©è²©', é …ç›®å: 'é©ç ¥ã‚»ãƒƒãƒˆ', å˜ä¾¡: 3000, å˜ä½: 'å€‹', å¯¾è±¡æ•™å®¤: 'å…±é€š' },
        { ç¨®åˆ¥: 'ç‰©è²©', é …ç›®å: 'ãƒã‚³ã‚®ãƒªã‚»ãƒƒãƒˆ', å˜ä¾¡: 2300, å˜ä½: 'å€‹', å¯¾è±¡æ•™å®¤: 'å…±é€š' },
        { ç¨®åˆ¥: 'ç‰©è²©', é …ç›®å: 'é‡‘å…·é¡ 1çµ„', å˜ä¾¡: 100, å˜ä½: 'å€‹', å¯¾è±¡æ•™å®¤: 'å…±é€š' },
        { ç¨®åˆ¥: 'ç‰©è²©', é …ç›®å: 'ã‚¬ãƒãƒ£ï¼‘ï¼ˆï¼–ä½“ã‚»ãƒƒãƒˆï¼‰', å˜ä¾¡: 2000, å˜ä½: 'å€‹', å¯¾è±¡æ•™å®¤: 'å…±é€š' },
        { ç¨®åˆ¥: 'ç‰©è²©', é …ç›®å: 'ã‚¬ãƒãƒ£ï¼’ï¼ˆï¼–ä½“ã‚»ãƒƒãƒˆï¼‰', å˜ä¾¡: 2000, å˜ä½: 'å€‹', å¯¾è±¡æ•™å®¤: 'å…±é€š' },
        { ç¨®åˆ¥: 'ç‰©è²©', é …ç›®å: 'ã‚¬ãƒãƒ£ï¼“ï¼ˆï¼•ä½“ã‚»ãƒƒãƒˆï¼‰', å˜ä¾¡: 2000, å˜ä½: 'å€‹', å¯¾è±¡æ•™å®¤: 'å…±é€š' },

        // ææ–™ï¼ˆå›ºå®šæ–™é‡‘ï¼‰
        {
          ç¨®åˆ¥: 'ææ–™',
          é …ç›®å: 'ææ–™ä»£ Â¥100ï¼ˆå›ºå®šï¼‰',
          å˜ä¾¡: 100,
          å˜ä½: 'å€‹',
          å¯¾è±¡æ•™å®¤: 'å…±é€š',
          å‚™è€ƒ: 'è¨ˆç®—ä¸è¦ã®ææ–™',
        },
        {
          ç¨®åˆ¥: 'ææ–™',
          é …ç›®å: 'ææ–™ä»£ Â¥200ï¼ˆå›ºå®šï¼‰',
          å˜ä¾¡: 200,
          å˜ä½: 'å€‹',
          å¯¾è±¡æ•™å®¤: 'å…±é€š',
          å‚™è€ƒ: 'è¨ˆç®—ä¸è¦ã®ææ–™',
        },
        {
          ç¨®åˆ¥: 'ææ–™',
          é …ç›®å: 'ææ–™ä»£ Â¥300ï¼ˆå›ºå®šï¼‰',
          å˜ä¾¡: 300,
          å˜ä½: 'å€‹',
          å¯¾è±¡æ•™å®¤: 'å…±é€š',
          å‚™è€ƒ: 'è¨ˆç®—ä¸è¦ã®ææ–™',
        },

        // ææ–™ï¼ˆä½“ç©è¨ˆç®—ï¼‰
        { ç¨®åˆ¥: 'ææ–™', é …ç›®å: 'ãƒã‚¹ã‚¦ãƒƒãƒ‰ãƒ»ã‚·ãƒŠ', å˜ä¾¡: 2, å˜ä½: 'cmÂ³', å¯¾è±¡æ•™å®¤: 'å…±é€š' },
        { ç¨®åˆ¥: 'ææ–™', é …ç›®å: 'ã‚¸ã‚§ãƒ«ãƒˆãƒ³', å˜ä¾¡: 2, å˜ä½: 'cmÂ³', å¯¾è±¡æ•™å®¤: 'å…±é€š' },
        { ç¨®åˆ¥: 'ææ–™', é …ç›®å: 'æœ¨æ›½æ¡§', å˜ä¾¡: 6, å˜ä½: 'cmÂ³', å¯¾è±¡æ•™å®¤: 'å…±é€š' },
        { ç¨®åˆ¥: 'ææ–™', é …ç›®å: 'ç±³ãƒ’ãƒ', å˜ä¾¡: 3, å˜ä½: 'cmÂ³', å¯¾è±¡æ•™å®¤: 'å…±é€š' },
      ],
    };

    // Google Apps Script APIã®ãƒ¢ãƒƒã‚¯
    window.google = {
      script: {
        run: new Proxy(
          {},
          {
            get: function (target, prop) {
              if (prop === 'withSuccessHandler') {
                return function (successCallback) {
                  return {
                    withFailureHandler: function (failureCallback) {
                      return createMockFunctions(successCallback, failureCallback);
                    },
                  };
                };
              }
              if (prop === 'withFailureHandler') {
                return function (failureCallback) {
                  return {
                    withSuccessHandler: function (successCallback) {
                      return createMockFunctions(successCallback, failureCallback);
                    },
                  };
                };
              }
              return createMockFunctions(null, null)[prop];
            },
          },
        ),
      },
    };

    // ãƒ¢ãƒƒã‚¯é–¢æ•°ã®ç”Ÿæˆ
    function createMockFunctions(successCallback, failureCallback) {
      const mockFunctions = {};

      const gasFunctions = [
        'authenticateUser',
        'getInitialWebApp_Data',
        'getReservationDetails',
        'registerNewUser',
        'updateUserProfile',
        'makeReservationAndGetLatestData',
        'cancelReservationAndGetLatestData',
        'makeAccountingAndGetLatestData',
        'saveAccountingDetails',
        'searchNoPhoneUsersByFilterForWebApp',
        'updateHistoryMemoAndGetData',
        'editProfileAndGetData',
        'removeAccountingItemFromPendingAndGetData',
      ];

      gasFunctions.forEach(funcName => {
        mockFunctions[funcName] = function (...args) {
          console.log(`[MOCK] ${funcName} called with:`, args);

          let response;
          switch (funcName) {
            case 'authenticateUser':
              response = {
                success: true,
                user: window.MockData.currentUser,
                initialData: {
                  availableSlots: window.MockData.slots,
                  myBookings: window.MockData.myBookings,
                  accountingMaster: window.MockData.accountingMaster,
                  myHistory: window.MockData.history,
                },
              };
              break;
            case 'getInitialWebApp_Data':
              response = {
                success: true,
                user: window.MockData.currentUser,
                initialData: {
                  availableSlots: window.MockData.slots,
                  myBookings: window.MockData.myBookings,
                  accountingMaster: window.MockData.accountingMaster,
                  myHistory: window.MockData.history,
                },
              };
              break;
            case 'getReservationDetails':
              const reservationData = args[0] || {};
              const classroom = reservationData.classroom || 'æ±äº¬æ•™å®¤';
              const tuitionItems = window.MockData.accountingMaster.filter(
                item => item['ç¨®åˆ¥'] === 'æˆæ¥­æ–™' && (item['å¯¾è±¡æ•™å®¤'] === classroom || item['å¯¾è±¡æ•™å®¤'] === 'å…±é€š'),
              );
              const salesItems = window.MockData.accountingMaster.filter(
                item => item['ç¨®åˆ¥'] === 'ç‰©è²©' && item['å¯¾è±¡æ•™å®¤'] === 'å…±é€š',
              );
              const materialItems = window.MockData.accountingMaster.filter(
                item => item['ç¨®åˆ¥'] === 'ææ–™' && item['å¯¾è±¡æ•™å®¤'] === 'å…±é€š',
              );
              response = {
                success: true,
                details: {
                  currentBookings: window.MockData.myBookings,
                  pendingAccountingItems: [],
                  accountingMaster: window.MockData.accountingMaster,
                  tuitionItems: tuitionItems,
                  salesItems: salesItems,
                  materialItems: materialItems,
                  selectedClassroom: classroom,
                  myHistory: window.MockData.history,
                },
              };
              break;
            case 'registerNewUser':
              const [newUserData] = args;
              const newUser = {
                studentId: 'NEW_USER_' + Date.now(),
                realName: newUserData.realName,
                displayName: newUserData.nickname,
                phone: newUserData.phone,
              };
              // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’currentUserã«åæ˜ 
              window.MockData.currentUser = newUser;
              response = {
                success: true,
                message: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ',
                user: newUser,
              };
              break;
            case 'updateUserProfile':
              const [profileUpdateData] = args;
              Object.assign(window.MockData.currentUser, profileUpdateData);
              response = {
                success: true,
                message: 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ',
                user: window.MockData.currentUser,
              };
              break;
            case 'makeReservationAndGetLatestData':
              const [slotData] = args;
              const newBooking = {
                reservationId: 'RES' + Date.now(),
                date: slotData.date,
                time: slotData.time || '09:00-12:00',
                classroom: slotData.classroom,
                venue: slotData.venue || slotData.classroom + 'ã‚¹ã‚¿ã‚¸ã‚ª',
                teacher: slotData.teacher || 'è¬›å¸«',
                studentId: window.MockData.currentUser.studentId,
                studentName: window.MockData.currentUser.realName,
                status: 'confirmed',
                accountingDone: false,
                accountingDetails: null,
                workInProgress: '',
              };
              window.MockData.myBookings.push(newBooking);
              response = {
                success: true,
                message: 'äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸ',
                availableSlots: window.MockData.slots,
                myBookings: window.MockData.myBookings,
                accountingMaster: window.MockData.accountingMaster,
              };
              break;
            case 'cancelReservationAndGetLatestData':
              const [cancelData] = args;
              const beforeCount = window.MockData.myBookings.length;
              window.MockData.myBookings = window.MockData.myBookings.filter(booking => {
                if (cancelData.reservationId) {
                  return booking.reservationId !== cancelData.reservationId;
                } else {
                  return !(booking.date === cancelData.date && booking.time === cancelData.time);
                }
              });
              const canceled = beforeCount > window.MockData.myBookings.length;
              response = {
                success: canceled,
                message: canceled ? 'äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ' : 'å¯¾è±¡ã®äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ',
                availableSlots: window.MockData.slots,
                myBookings: window.MockData.myBookings,
                accountingMaster: window.MockData.accountingMaster,
              };
              break;
            case 'makeAccountingAndGetLatestData':
              const [accountingData] = args;
              const newAccountingRecord = {
                date: new Date().toISOString().split('T')[0],
                studentId: window.MockData.currentUser.studentId,
                studentName: window.MockData.currentUser.realName,
                amount: accountingData.amount || 1000,
                items: accountingData.items || ['ãƒ†ã‚¹ãƒˆé …ç›®'],
                status: 'completed',
              };
              window.MockData.history.push(newAccountingRecord);
              response = {
                success: true,
                message: 'ä¼šè¨ˆå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ',
                myHistory: window.MockData.history,
                accountingMaster: window.MockData.accountingMaster,
              };
              break;
            case 'saveAccountingDetails':
              const [saveAccountingData] = args;
              const targetBooking = window.MockData.myBookings.find(
                booking => booking.reservationId === saveAccountingData.reservationId,
              );
              if (targetBooking) {
                targetBooking.accountingDone = true;
                targetBooking.accountingDetails = JSON.stringify(saveAccountingData.details || {});
              }
              const detailedRecord = {
                date: new Date().toISOString().split('T')[0],
                studentId: window.MockData.currentUser.studentId,
                studentName: window.MockData.currentUser.realName,
                reservationId: saveAccountingData.reservationId,
                details: saveAccountingData.details,
                totalAmount: saveAccountingData.totalAmount || 0,
                status: 'completed',
              };
              window.MockData.history.push(detailedRecord);
              response = {
                success: true,
                message: 'ä¼šè¨ˆè©³ç´°ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ',
                myBookings: window.MockData.myBookings,
                myHistory: window.MockData.history,
              };
              break;
            case 'searchNoPhoneUsersByFilterForWebApp':
              response = {
                success: true,
                users: [
                  { studentId: 'NO_PHONE_001', realName: 'æœªç™»éŒ²å¤ªéƒ', displayName: 'æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼1' },
                  { studentId: 'NO_PHONE_002', realName: 'æœªç™»éŒ²èŠ±å­', displayName: 'æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼2' },
                ],
              };
              break;
            case 'updateHistoryMemoAndGetData':
              const [memoData] = args;
              // historyã®è©²å½“é …ç›®ã«memoã‚’è¿½åŠ 
              const targetHistory = window.MockData.history.find(h => h.date === memoData.date);
              if (targetHistory) targetHistory.memo = memoData.memo;
              response = {
                success: true,
                message: 'ãƒ¡ãƒ¢ã‚’æ›´æ–°ã—ã¾ã—ãŸ',
                myHistory: window.MockData.history,
              };
              break;
            case 'editProfileAndGetData':
              const [profileData] = args;
              Object.assign(window.MockData.currentUser, profileData);
              response = {
                success: true,
                message: 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ',
                user: window.MockData.currentUser,
              };
              break;
            case 'removeAccountingItemFromPendingAndGetData':
              const [removeData] = args;
              // accountingMasterã‹ã‚‰è©²å½“é …ç›®ã‚’å‰Šé™¤
              window.MockData.accountingMaster = window.MockData.accountingMaster.filter(
                item => item.é …ç›®å !== removeData.itemName,
              );
              response = {
                success: true,
                message: 'é …ç›®ã‚’å‰Šé™¤ã—ã¾ã—ãŸ',
                accountingMaster: window.MockData.accountingMaster,
              };
              break;
            default:
              response = { success: true, message: `Mock response for ${funcName}` };
          }

          setTimeout(() => {
            if (successCallback) {
              successCallback(response);
            }
          }, 100);
        };
      });

      return mockFunctions;
    }

    console.log('[TEST] æ‹¡å¼µãƒ¢ãƒƒã‚¯ç’°å¢ƒãŒè¨­å®šã•ã‚Œã¾ã—ãŸ');
  }

    // ========== /10_WebApp_Mock.html ==========

    // ========== 11_WebApp_Config.html ==========

  /**
   * =================================================================
   * ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: 11_WebApp_Config.html
   * ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘: 1.7
   * ã€å½¹å‰²ã€‘: WebAppã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ä½¿ç”¨ã•ã‚Œã‚‹è¨­å®šã¨ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
   * ã€æ§‹æˆã€‘: 14ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®ã†ã¡ã®11ç•ªç›®
   * ã€v1.7ã§ã®å¤‰æ›´ç‚¹ã€‘:
   * - å…¨ä½“çš„ãªé…è‰²ã‚’ã‚ˆã‚Šã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ã§æ¸©ã‹ã¿ã®ã‚ã‚‹ãƒ†ãƒ¼ãƒã«æ›´æ–°
   * - ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã®å¯èª­æ€§ã‚’å‘ä¸Š
   * - ä¼šè¨ˆãƒœã‚¿ãƒ³ã«é»„è‰²ç³»ã®é…è‰²ã‚’é©ç”¨
   * - è¨˜éŒ²ã‚«ãƒ¼ãƒ‰ã«èƒŒæ™¯è‰²ã‚’è¿½åŠ 
   * =================================================================
   */

  // =================================================================
  // 1. APPLICATION CONSTANTS
  // =================================================================
  const TOKYO_CLASSROOM_NAME = 'æ±äº¬æ•™å®¤';
  const NUMAZU_CLASSROOM_NAME = 'æ²¼æ´¥æ•™å®¤';
  const TSUKUBA_CLASSROOM_NAME = 'ã¤ãã°æ•™å®¤';
  const ITEM_NAME_DISCOUNT = 'åˆå›è¬›ç¿’åŒæ™‚é–“å‰²å¼•';

  // =================================================================
  // 2. DESIGN CONFIGURATION
  // =================================================================
  const DesignConfig = {
    // ãƒ†ã‚­ã‚¹ãƒˆã‚„èƒŒæ™¯ã®è‰²è¨­å®šï¼ˆæ¸©ã‹ã¿ã¨æ´»æ°—ã®ã‚ã‚‹é…è‰²ï¼‰
    colors: {
      text: 'text-brand-text', // ãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
      textSubtle: 'text-brand-subtle', // ã‚µãƒ–ãƒ†ã‚­ã‚¹ãƒˆ
      textMuted: 'text-brand-muted', // è–„ã„ãƒ†ã‚­ã‚¹ãƒˆ
      primary: 'bg-action-primary-bg text-action-primary-text active:bg-action-primary-hover', // ãƒ—ãƒ©ã‚¤ãƒãƒª (ãƒ†ãƒ©ã‚³ãƒƒã‚¿)
      secondary: 'bg-action-secondary-bg text-action-secondary-text active:bg-action-secondary-hover', // ã‚»ã‚«ãƒ³ãƒ€ãƒª (æ˜ã‚‹ã„ãƒ™ãƒ¼ã‚¸ãƒ¥)
      attention: 'bg-action-attention-bg text-action-attention-text active:bg-action-attention-hover', // æ³¨æ„ (è‹¥è‘‰è‰²)
      accounting: 'bg-action-accounting-bg text-action-accounting-text active:bg-action-accounting-hover', // ä¼šè¨ˆ (ã‚¢ãƒ³ãƒãƒ¼)
      danger: 'bg-state-danger-bg text-state-danger-text active:bg-state-danger-hover', // å±é™º (è½ã¡ç€ã„ãŸèµ¤)
      success: 'bg-state-success-bg text-state-success-text active:bg-state-success-hover', // æˆåŠŸ (è‹¥è‘‰è‰²)
      paid: 'bg-action-paid-bg text-action-paid-text', // æ”¯æ‰•ã„æ¸ˆã¿ (è–„ã„ç·‘)
      info: 'bg-ui-surface text-brand-text border border-ui-border',
      warning: 'bg-ui-warning-bg text-ui-warning-text border border-ui-warning-border',
      error: 'bg-ui-error-bg text-ui-error-text border border-ui-error-border',
    },

    // ãƒœã‚¿ãƒ³ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«
    buttons: {
      base: 'font-bold py-2.5 px-5 rounded-md transition-all duration-150 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 mobile-button touch-friendly',
      full: 'w-[250px] mx-auto block',
      auto: 'w-auto',
      primary:
        'font-bold py-2.5 px-5 rounded-md transition-all duration-150 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 mobile-button touch-friendly bg-action-primary-bg text-action-primary-text active:bg-action-primary-hover',
      secondary:
        'font-bold py-2.5 px-5 rounded-md transition-all duration-150 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 mobile-button touch-friendly bg-action-secondary-bg text-action-secondary-text active:bg-action-secondary-hover',
      attention:
        'font-bold py-2.5 px-5 rounded-md transition-all duration-150 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 mobile-button touch-friendly bg-action-attention-bg text-action-attention-text active:bg-action-attention-hover',
      accounting:
        'font-bold py-2.5 px-5 rounded-md transition-all duration-150 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 mobile-button touch-friendly bg-action-accounting-bg text-action-accounting-text active:bg-action-accounting-hover',
    },

    // ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
    text: {
      heading: 'text-xl font-bold text-brand-text',
      subheading: 'text-lg font-medium text-brand-text',
      body: 'text-base text-brand-text',
      bodySubtle: 'text-base text-brand-subtle',
      caption: 'text-sm text-brand-subtle',
      label: 'text-base font-bold text-brand-text',
      labelBlock: 'block text-brand-text text-base font-bold mb-2',
    },

    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    layout: {
      container: 'max-w-screen-sm mx-auto p-4',
      containerNoPadding: 'max-w-screen-sm mx-auto',
      section: 'mb-8',
      card: 'shadow-card rounded-lg border border-solid border-card-border',
      centerContent: 'flex items-center justify-center',
      spaceBetween: 'flex items-center justify-between',
    },

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹
    utils: {
      hidden: 'hidden',
      loading: 'opacity-50 pointer-events-none',
      mobileFriendly: 'mobile-button touch-friendly',
      flexCenter: 'flex items-center justify-center',
      flexBetween: 'flex items-center justify-between',
      fullWidth: 'w-full',
      autoMargin: 'mx-auto',
    },

    // ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«
    cards: {
      base: 'w-full text-left p-3 rounded-lg mobile-card touch-friendly transition-all duration-150',
      container: 'max-w-md mx-auto space-y-3',
      background: 'bg-ui-surface border border-ui-border',
      state: {
        available: {
          card: 'bg-state-available-bg border border-state-available-border mobile-card active:bg-state-success-hover',
          text: 'text-state-available-text',
        },
        waitlist: {
          card: 'bg-state-waitlist-bg border border-state-waitlist-border mobile-card',
          text: 'text-state-waitlist-text',
        },
        booked: {
          card: 'bg-state-booked-bg border border-state-booked-border mobile-card',
          text: 'text-state-booked-text',
        },
        history: {
          card: 'bg-brand-light border border-ui-border mobile-card',
        },
      },
    },

    // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ«
    inputs: {
      container: 'max-w-md mx-auto',
      base: 'text-lg w-full p-3 border border-ui-border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-text mobile-input touch-friendly bg-ui-input focus:bg-ui-input-focus transition-all duration-150',
      textarea:
        'text-lg w-full p-3 border border-ui-border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-text h-24 mobile-input bg-ui-input focus:bg-ui-input-focus transition-all duration-150',
    },
  };

  // =================================================================
  // 3. CSS STYLES SETUP
  // =================================================================
  const addCustomStyles = () => {
    const style = document.createElement('style');
    style.textContent = `
      /* ========== CSS Variables ========== */
      :root {
        /* Energetic and warm theme for a wood carving school */
        --brand-text: #4E342E;       /* Dark Brown for high readability */
        --brand-subtle: #785A4E;     /* Medium Brown for sub-text */
        --brand-muted: #A1887F;      /* Lighter, soft brown */
        --brand-bg: #FFFDF5;         /* Warm, very light cream background */
        --brand-surface: #FFFFFF;    /* White for card backgrounds for a clean look */
        --brand-light: #F5F1ED;      /* Light, warm beige for hover states */

        --action-primary: #C86F34;   /* Energetic terracotta for main actions */
        --action-secondary: #E4CDBA; /* Light, warm beige for secondary actions */
        --action-attention: #5A8C36; /* Lively, fresh green for attention */
        --action-accounting: #F59E0B;/* Bright amber for accounting actions */
        --action-danger: #B91C1C;    /* A clear, strong red for danger */

        --state-available: #5A8C36;  /* Lively green for available slots */
        --state-waitlist: #F59E0B;   /* Bright amber for waitlist */
        --state-booked: #785A4E;     /* Medium brown for booked slots */

        --ui-border: #E4CDBA;        /* Soft, warm beige for borders */
        --ui-input: #FAFAFA;         /* Neutral light gray for inputs */
        --ui-surface: #FFFFFF;

        --modal-overlay: rgba(0, 0, 0, 0.5);
        --spinner-border: #f3f4f6;
      }

      /* ========== Base Styles ========== */
      body {
        font-family: 'Zen Kaku Gothic New', sans-serif;
        color: var(--brand-text);
        background-color: var(--brand-bg);
        line-height: 1.6;
      }

      /* ========== Mobile-Friendly Components ========== */
      .mobile-button, .mobile-input, .mobile-card {
        min-height: 48px;
      }
      .touch-friendly {
        touch-action: manipulation;
      }

      /* ========== Animations ========== */
      .fade-in { animation: fadeInUp 0.3s ease-out; }
      @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .spinner {
        border: 4px solid var(--spinner-border);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border-left-color: var(--brand-text);
        animation: spin 1s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }

      /* ========== Layout Components ========== */
      #loading { z-index: 100; }
      .modal-overlay {
        position: fixed; inset: 0; background-color: var(--modal-overlay);
        display: flex; align-items: center; justify-content: center;
        z-index: 50; opacity: 0; transition: opacity 0.3s ease;
        pointer-events: none; backdrop-filter: blur(3px);
      }
      .modal-overlay.active { opacity: 1; pointer-events: auto; }
      #custom-modal {
        opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
      }
      #custom-modal.active { opacity: 1; pointer-events: auto; }
      .modal-content {
        background: white; padding: 1.5rem; border-radius: 0.75rem;
        width: 90%; max-width: 400px; text-align: center;
        max-height: 85vh; overflow-y: auto;
      }
      .modal-content p { margin-bottom: 1.25rem; }
      .modal-content .modal-buttons { justify-content: center; }

      /* ========== Custom Components ========== */
      details > summary { list-style: none; cursor: pointer; }
      details > summary::-webkit-details-marker { display: none; }

      .accounting-item, .reservation-card {
        background-color: var(--brand-surface);
        border: 1px solid var(--ui-border);
        transition: all 0.2s ease;
      }
      .accounting-item:hover, .reservation-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        border-color: var(--brand-muted);
      }

      /* ========== Responsive Design ========== */
      @media (max-width: 640px) {
        .modal-content { width: 95%; padding: 1rem; }
        .mobile-button, .mobile-input { font-size: 16px; }
      }
    `;
    document.head.appendChild(style);
  };

  // =================================================================
  // 4. TAILWIND CSS SETUP
  // =================================================================
  const setupTailwindCSS = () => {
    const tailwindScript = document.createElement('script');
    tailwindScript.src = 'https://cdn.tailwindcss.com';

    tailwindScript.onload = function () {
      if (window.tailwind) {
        window.tailwind.config = {
          theme: {
            extend: {
              fontSize: { '2xs': '0.625rem' },
              fontFamily: { sans: ['Zen Kaku Gothic New', 'sans-serif'] },
              colors: {
                brand: {
                  bg: '#FFFDF5',
                  surface: '#FFFFFF',
                  text: '#4E342E',
                  subtle: '#785A4E',
                  light: '#F5F1ED',
                  dark: '#4E342E',
                  muted: '#A1887F',
                },
                action: {
                  'primary-bg': '#C86F34',
                  'primary-text': '#FFFFFF',
                  'primary-hover': '#A95B2A',
                  'secondary-bg': '#E4CDBA',
                  'secondary-text': '#4E342E', // Improved contrast
                  'secondary-hover': '#D7BCA9',
                  'attention-bg': '#5A8C36',
                  'attention-text': '#FFFFFF',
                  'attention-hover': '#4A732C',
                  'accounting-bg': '#F59E0B', // Amber
                  'accounting-text': '#4E342E', // Dark text for readability
                  'accounting-hover': '#D97706',
                  'danger-bg': '#B91C1C',
                  'danger-text': '#FFFFFF',
                  'danger-hover': '#991B1B',
                  'paid-bg': '#F0FDF4',
                  'paid-text': '#166534',
                },
                state: {
                  'available-text': '#166534',
                  'available-bg': '#F0FDF4',
                  'available-border': '#A7F3D0',
                  'available-hover': '#D1FAE5',
                  'waitlist-text': '#B45309',
                  'waitlist-bg': '#FFFBEB',
                  'waitlist-border': '#FDE68A',
                  'booked-text': '#44403C',
                  'booked-bg': '#F5F5F4',
                  'booked-border': '#E7E5E4',
                  'success-bg': '#F0FDF4',
                  'success-text': '#166534',
                  'success-border': '#A7F3D0',
                  'success-hover': '#D1FAE5',
                  'danger-bg': '#FEF2F2',
                  'danger-text': '#B91C1C',
                  'danger-border': '#FECACA',
                  'danger-hover': '#FEE2E2',
                },
                ui: {
                  border: '#E4CDBA',
                  'border-light': '#F5F1ED',
                  surface: '#FFFFFF',
                  input: '#FAFAFA',
                  'input-focus': '#FFFFFF',
                  'error-text': '#B91C1C',
                  'error-bg': '#FEF2F2',
                  'error-border': '#FECACA',
                  'warning-text': '#B45309',
                  'warning-bg': '#FFFBEB',
                  'warning-border': '#FDE68A',
                  'link-text': '#0369A1',
                },
              },
            },
          },
        };
        console.log('[CONFIG] Tailwind CSSè¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ');
      }
    };

    tailwindScript.onerror = function () {
      console.warn('[CONFIG] Tailwind CSSèª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    };

    document.head.appendChild(tailwindScript);
  };

  // =================================================================
  // 5. INITIALIZATION
  // =================================================================
  console.log('[CONFIG] è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');
  addCustomStyles();
  setupTailwindCSS();
  console.log('[CONFIG] è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ');

    // ========== /11_WebApp_Config.html ==========

    // ========== 12_WebApp_Core.html ==========

  /**
   * =================================================================
   * ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: 12_WebApp_Core.html
   * ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘: 1.2
   * ã€å½¹å‰²ã€‘: WebAppã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«ãŠã‘ã‚‹ä¸­æ ¸æ©Ÿèƒ½ã‚’é›†ç´„ã—ã¾ã™ã€‚
   * - çŠ¶æ…‹ç®¡ç† (State Management)
   * - UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç”Ÿæˆ (UI Components)
   * - æ±ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ (Utilities)
   * - ä¼šè¨ˆè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (Calculation Logic)
   * ã€æ§‹æˆã€‘: 14ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®ã†ã¡ã®12ç•ªç›®
   * ã€v1.2ã§ã®å¤‰æ›´ç‚¹ã€‘:
   * - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°: æ—¥ä»˜ãƒ»ã‚¹ãƒ­ãƒƒãƒˆå‡¦ç†ã®å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã‚’è¿½åŠ ã€‚
   * - filterFutureAvailableSlots, groupSlotsByMonth é–¢æ•°ã‚’æ–°è¦è¿½åŠ ã€‚
   * - ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã‚’å‘ä¸Šã€‚
   * =================================================================
   */

  // =================================================================
  // --- Application State Management ---
  // -----------------------------------------------------------------
  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®å‹•çš„ãªçŠ¶æ…‹ã‚’ä¸€å…ƒç®¡ç†ã—ã¾ã™ã€‚
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€äºˆç´„ãƒ‡ãƒ¼ã‚¿ã€ç¾åœ¨ã®è¡¨ç¤ºç”»é¢ãªã©ãŒå«ã¾ã‚Œã¾ã™ã€‚
  // =================================================================

  // =================================================================
  // --- Environment Detection & Data Management ---
  // -----------------------------------------------------------------
  // å®Ÿè¡Œç’°å¢ƒã‚’è‡ªå‹•æ¤œå‡ºã—ã€é©åˆ‡ãªãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’é¸æŠã—ã¾ã™ã€‚
  // ãƒ†ã‚¹ãƒˆç’°å¢ƒ: ãƒ–ãƒ©ã‚¦ã‚¶ + ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
  // æœ¬ç•ªç’°å¢ƒ: Google Apps Script + å®Ÿãƒ‡ãƒ¼ã‚¿
  // =================================================================

  /**
   * å®Ÿè¡Œç’°å¢ƒã®æ¤œå‡º
   * @returns {string} 'test' | 'production'
   */
  const detectEnvironment = () => {
    try {
      // GASç’°å¢ƒã®æ¤œå‡º
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        return 'production';
      }
      return 'test';
    } catch (error) {
      return 'test';
    }
  };

  /**
   * ç’°å¢ƒã«å¿œã˜ãŸãƒ‡ãƒ¼ã‚¿å–å¾—
   * @param {string} dataType - ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—
   * @param {any} fallback - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
   */
  const getEnvironmentData = (dataType, fallback = null) => {
    const env = detectEnvironment();

    if (env === 'test' && typeof MockData !== 'undefined') {
      return MockData[dataType] || fallback;
    }

    // GASç’°å¢ƒã§ã¯åˆæœŸå€¤ã®ã¿è¿”ã—ã€ãƒ‡ãƒ¼ã‚¿ã¯å¾Œã§APIå‘¼ã³å‡ºã—ã§å–å¾—
    return fallback;
  };

  // ç’°å¢ƒæƒ…å ±
  const isTestEnvironment = detectEnvironment() === 'test';

  // é–‹ç™ºæ™‚ã®ãƒ­ã‚°å‡ºåŠ›
  if (isTestEnvironment) {
    console.log('ğŸ§ª Test Environment Detected');
    console.log('MockData available:', typeof MockData !== 'undefined');
  }

  window.appState = {
    currentUser: getEnvironmentData('currentUser'),
    slots: getEnvironmentData('slots', []),
    myBookings: getEnvironmentData('myBookings', []),
    history: getEnvironmentData('history', []),
    historyTotal: getEnvironmentData('history', []).length,
    view: isTestEnvironment ? 'login' : 'login',
    selectedClassroom: null,
    selectedSlot: null,
    phoneForRegistration: null,
    completionMessage: '',
    newlyBookedReservation: null,
    editingReservationDetails: null,
    accountingReservation: null,
    accountingMaster: getEnvironmentData('accountingMaster'),
    accountingInitialValues: null,
    editingHistoryItem: null,
    classrooms: getEnvironmentData('classrooms', ['æ±äº¬æ•™å®¤', 'ã¤ãã°æ•™å®¤', 'æ²¼æ´¥æ•™å®¤']),
    // NF-01: é›»è©±ç•ªå·æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒ•ãƒ­ãƒ¼ç”¨ã®çŠ¶æ…‹
    noPhoneUsers: [], // æ¤œç´¢çµæœã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ
    selectedNoPhoneUser: null, // é¸æŠã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼
    searchAttempted: false, // NF-01: æ¤œç´¢ãŒä¸€åº¦è©¦è¡Œã•ã‚ŒãŸã‹ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
    // NF-04: æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ•ãƒ­ãƒ¼ç”¨ã®çŠ¶æ…‹
    registrationStep: 1, // æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼ã®ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ— (1, 2, 3)
    registrationData: {}, // å„ã‚¹ãƒ†ãƒƒãƒ—ã§å…¥åŠ›ã•ã‚ŒãŸæƒ…å ±ã‚’ä¸€æ™‚çš„ã«è“„ç©ã™ã‚‹
    isFirstTimeBooking: false, // åˆå›äºˆç´„ã‹ã©ã†ã‹ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
  };
  let onConfirmCallback = null; // ãƒ¢ãƒ¼ãƒ€ãƒ«ç¢ºèªæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’ä¿æŒ

  // ãƒ†ã‚¹ãƒˆç’°å¢ƒã®åˆæœŸåŒ–ãƒ­ã‚°
  if (isTestEnvironment) {
    console.log('[TEST] ãƒ†ã‚¹ãƒˆç’°å¢ƒã§å®Ÿè¡Œä¸­ã§ã™');
    console.log('[TEST] appStateåˆæœŸåŒ–:', {
      currentUser: appState.currentUser,
      slotsCount: appState.slots.length,
      bookingsCount: appState.myBookings.length,
      historyCount: appState.history.length,
      classrooms: appState.classrooms,
    });
  }

  // =================================================================
  // --- UI Component Generators ---
  // -----------------------------------------------------------------
  // ã‚¢ãƒ—ãƒªå†…ã§ä½¿ç”¨ã•ã‚Œã‚‹ãƒœã‚¿ãƒ³ã‚„å…¥åŠ›æ¬„ã¨ã„ã£ãŸã€å†åˆ©ç”¨å¯èƒ½ãª
  // UIéƒ¨å“ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ç¾¤ã§ã™ã€‚
  // =================================================================

  /**
   * HTMLæ–‡å­—åˆ—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¾ã™ã€‚
   * @param {string} str ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹æ–‡å­—åˆ—
   * @returns {string} ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸæ–‡å­—åˆ—
   */
  const escapeHTML = str => {
    if (typeof str !== 'string') {
      return str;
    }
    return str.replace(/[&<>"']/g, function (match) {
      return {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
      }[match];
    });
  };

  const Components = {
    createButton: c =>
      `<button
        data-action="${escapeHTML(c.action || '')}"
        data-classroom="${escapeHTML(c.classroom || '')}"
        data-classroom-name="${escapeHTML(c.classroomName || '')}"
        data-date="${escapeHTML(c.date || '')}"
        data-reservation-id="${escapeHTML(c.reservationId || '')}"
        data-sheet-name="${escapeHTML(c.sheetName || '')}"
        data-copy-text="${escapeHTML(c.copyText || '')}"
        data-details="${escapeHTML(c.details || '')}"
        data-student-id="${escapeHTML(c.studentId || '')}"
        data-real-name="${escapeHTML(c.realName || '')}"
        data-nickname="${escapeHTML(c.nickname || '')}"
        class="${DesignConfig.buttons.base} ${c.widthClass || ''} ${c.colorClass}"
        ${c.disabled ? 'disabled' : ''}
      >${escapeHTML(c.text)}</button>`,

    createInput: c =>
      `<div class="${c.containerClass || ''} mb-4">
        <label
          for="${c.id}"
          class="${c.labelClass || DesignConfig.text.labelBlock} ${c.isSrOnly ? 'sr-only' : ''}"
        >${escapeHTML(c.label)}</label>
        ${c.caption ? `<p class="${DesignConfig.text.caption} mb-2">${escapeHTML(c.caption)}</p>` : ''}
        <input
          type="${c.type}"
          id="${c.id}"
          value="${escapeHTML(c.value || '')}"
          class="${DesignConfig.inputs.base} ${c.inputClass || ''}"
          placeholder="${escapeHTML(c.placeholder || '')}"
          ${c.required ? 'required' : ''}
          autocomplete="${c.autocomplete || 'off'}"
          ${c.step ? `step="${c.step}"` : ''}
        >
      </div>`,

    createTextArea: c =>
      `<div class="${c.containerClass || ''} mb-4">
        <label for="${c.id}" class="${DesignConfig.text.labelBlock}">${escapeHTML(c.label)}</label>
        ${c.caption ? `<p class="${DesignConfig.text.caption} mb-2">${escapeHTML(c.caption)}</p>` : ''}
        <textarea
          id="${c.id}"
          class="${DesignConfig.inputs.textarea}"
          placeholder="${escapeHTML(c.placeholder || '')}"
        >${escapeHTML(c.value || '')}</textarea>
      </div>`,

    createSelect: c =>
      `<div class="${c.containerClass || ''}">
        <label for="${c.id}" class="${DesignConfig.text.labelBlock}">${escapeHTML(c.label)}</label>
        <select
          id="${c.id}"
          class="${DesignConfig.inputs.base} ${c.sizeClass || ''} accounting-item"
        >${c.options}</select>
      </div>`,

    createCheckbox: c =>
      `<label class="flex items-center space-x-2 ${DesignConfig.colors.text}">
        <input
          type="checkbox"
          id="${c.id}"
          ${c.checked ? 'checked' : ''}
          class="accent-action-primary-bg"
        >
        <span>${escapeHTML(c.label)}</span>
      </label>`,
  };

  // =================================================================
  // --- Loading Message System ---
  // -----------------------------------------------------------------
  // UI-11: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¤šæ§˜åŒ–æ©Ÿèƒ½
  // çŠ¶æ³ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒ¦ãƒ¼ãƒ¢ãƒ©ã‚¹ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¡¨ç¤ºã—ã€
  // æ•°ç§’ã”ã¨ã«è‡ªå‹•ã§åˆ‡ã‚Šæ›¿ãˆã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚
  // =================================================================
  let loadingMessageTimer = null;

  const LoadingMessages = {
    // ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    login: [
      'ã‚ã„ã¼ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã‚ã„ã¼ ã˜ãŸã„ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ãã‚ã ã‚’ ã‹ãã«ã‚“ ã¡ã‚…ã†ã§ã™...',
      'ãªã¾ãˆ ã‚’ ã‹ãã«ã‚“ ã—ã¦ã„ã¾ã™...',
      'ã¨ã†ã‚ã ãŒ ã‚ã‚‹ã‹ ã—ã‚‰ã¹ã¦ã„ã¾ã™...',
    ],

    // ç”³ã—è¾¼ã¿æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    booking: [
      'ã‚ˆã‚„ã ã‚’ ã‚‚ã†ã—ã“ã¿ ã¡ã‚…ã†ã§ã™...',
      'ã—ã‚“ã›ã„ã—ã‚‡ ã‚’ ã¦ã„ã—ã‚…ã¤ã—ã¦ã„ã¾ã™...',
      'ã¯ã‚“ã“ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã²ã¥ã‘ ã‚’ ã‹ãã«ã‚“ã—ã¦ã„ã¾ã™...',
      'ã‹ã‚Œã‚“ã ãƒ¼ ã« ã‹ãã“ã‚“ã§ã„ã¾ã™...',
    ],

    // äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    cancel: ['ã‚ˆã‚„ã ã‚’ ã¨ã‚Šã‘ã—ã¦ã„ã¾ã™...', 'ã‘ã—ã”ã‚€ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...', 'ã¨ã‚Šã‘ã—ã›ã‚“ ã‚’ ã²ã„ã¦ã„ã¾ã™...'],

    // äºˆç´„ç·¨é›†æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    edit: [
      'ã¸ã‚“ã“ã† ã‚’ ã»ãã‚“ã—ã¦ã„ã¾ã™...',
      'ã‚ãŸã‚‰ã—ã„ ãªã„ã‚ˆã† ã« ã‹ãã‹ãˆã¦ã„ã¾ã™...',
      'ã¾ã¡ãŒã„ ãŒ ãªã„ã‹ ã‹ãã«ã‚“ã—ã¦ã„ã¾ã™...',
    ],

    // ä¼šè¨ˆæ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    accounting: [
      'ã§ã‚“ã´ã‚‡ã† ã‚’ ãŠãã£ã¦ã„ã¾ã™...',
      'ã¡ã‚‡ã†ã¼ ã‚’ ã¤ã‘ã¦ã„ã¾ã™...',
      'ãŠã‹ã­ ã‚’ ã‹ããˆã¦ã„ã¾ã™...',
      'ãŠã¤ã‚Š ã‚’ ã˜ã‚…ã‚“ã³ã—ã¦ã„ã¾ã™...',
    ],

    // ãƒ‡ãƒ¼ã‚¿å–å¾—æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    dataFetch: [
      'ãƒ‡ãƒ¼ã‚¿ ã‚’ ã‚ˆã¿ã“ã‚“ã§ã„ã¾ã™...',
      'ã˜ã‚‡ã†ã»ã† ã‚’ ã‚ã¤ã‚ã¦ã„ã¾ã™...',
      'ã²ã¤ã‚ˆã†ãª ã‚‚ã® ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
    ],

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    default: [
      'ã›ã‚“ã›ã„ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã—ã‚‡ã‚‹ã„ ã‚’ ã•ãŒã—ã¦ã„ã¾ã™...',
      'ã—ã‚‡ã‚‹ã„ ã‚’ ãªãŒã‚ã¦ã„ã¾ã™...',
      'ãããš ã‚’ ã‹ãŸãšã‘ã¦ã„ã¾ã™...',
      'ã“ã¨ã° ã‚’ ãˆã‚‰ã‚“ã§ã„ã¾ã™...',
      'ã¦ã„ã•ã„ ã‚’ ã¨ã¨ã®ãˆã¦ã„ã¾ã™...',
      'ã¿ã ã® ã‚‚ã® ã‚’ ã²ã ã‚Š ã« ã†ã”ã‹ã—ã¦ã„ã¾ã™...',
      'ã²ã ã‚Š ã® ã‚‚ã® ã‚’ ã¿ã ã« ã†ã”ã‹ã—ã¦ã„ã¾ã™...',
      'ã“ãƒ¼ã²ãƒ¼ ã‚’ ã„ã‚Œã¦ã„ã¾ã™...',
      'ã™ã“ã— ãã‚…ã†ã‘ã„ ã—ã¦ã„ã¾ã™...',
      'ã­ã“ ã® ã¦ ã‚’ ã‹ã‚Šã‚ˆã†ã¨ã—ã¦ã„ã¾ã™...',
      'ã¯ã‚€ã™ãŸãƒ¼ ã® ã¦ ã‚’ ã‹ã‚Šã‚ˆã†ã¨ã—ã¦ã„ã¾ã™...',
      'ã¯ã‚‚ã® ã‚’ ã¨ã¨ã®ãˆã¦ã„ã¾ã™...',
    ],
  };

  const getRandomMessage = (category = 'default') => {
    const messages = [...(LoadingMessages[category] || []), ...LoadingMessages.default];
    return messages[Math.floor(Math.random() * messages.length)];
  };

  const updateLoadingMessage = (category = 'default') => {
    const messageElement = document.getElementById('loading-message');
    if (messageElement) {
      messageElement.textContent = getRandomMessage(category);
    }
  };

  const startLoadingMessageRotation = (category = 'default') => {
    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
    updateLoadingMessage(category);

    // 3ç§’ã”ã¨ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
    loadingMessageTimer = setInterval(() => {
      updateLoadingMessage(category);
    }, 3500);
  };

  const stopLoadingMessageRotation = () => {
    if (loadingMessageTimer) {
      clearInterval(loadingMessageTimer);
      loadingMessageTimer = null;
    }
  };

  const showLoading = (category = 'default') => {
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('main-content').classList.add('hidden');
    startLoadingMessageRotation(category);
  };

  const hideLoading = () => {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('main-content').classList.remove('hidden');
    stopLoadingMessageRotation();
  };

  // =================================================================
  // --- General Utilities ---
  // -----------------------------------------------------------------
  // æ—¥ä»˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãªã©ã€
  // ã‚¢ãƒ—ãƒªå…¨ä½“ã§æ±ç”¨çš„ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤ã§ã™ã€‚
  // =================================================================
  const formatDate = dStr => {
    if (!dStr) return '';
    const d = new Date(dStr);
    if (isNaN(d)) return '';
    d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
    const day = d.getDay();
    const wd = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
    return `${d.getMonth() + 1}/${d.getDate()} <span class="font-bold ${day === 0 ? 'text-ui-weekend-sunday' : day === 6 ? 'text-ui-weekend-saturday' : ''}">${wd[day]}</span>`;
  };
  const showModal = c => {
    const m = document.getElementById('custom-modal'),
      b = document.getElementById('modal-buttons');
    b.innerHTML = '';
    if (c.showCancel) {
      b.innerHTML += Components.createButton({
        text: c.cancelText || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
        action: 'modalCancel',
        colorClass: DesignConfig.colors.secondary,
        widthClass: DesignConfig.buttons.auto,
      });
    }
    if (c.confirmText) {
      b.innerHTML += `<div class="w-3"></div>${Components.createButton({ text: c.confirmText, action: 'modalConfirm', colorClass: c.confirmColorClass, widthClass: DesignConfig.buttons.auto, disabled: c.disableConfirm })}`;
    }
    onConfirmCallback = c.onConfirm;
    document.getElementById('modal-title').textContent = c.title;
    document.getElementById('modal-message').innerHTML = c.message;
    m.classList.add('active');
  };
  const hideModal = () => {
    document.getElementById('custom-modal').classList.remove('active');
    onConfirmCallback = null;
  };
  const showInfo = (msg, t = 'æƒ…å ±', cb = null) =>
    showModal({
      title: t,
      message: msg,
      confirmText: 'OK',
      confirmColorClass: DesignConfig.colors.primary,
      onConfirm: cb,
    });
  const showConfirm = c => showModal({ ...c, showCancel: true });

  // =================================================================
  // --- Date and Slot Utilities ---
  // -----------------------------------------------------------------
  // æ—¥ä»˜ã‚„ã‚¹ãƒ­ãƒƒãƒˆæ“ä½œã«é–¢ã™ã‚‹å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ç¾¤ã§ã™ã€‚
  // =================================================================

  /**
   * æŒ‡å®šã•ã‚ŒãŸæ•™å®¤ã®ã€ä»Šæ—¥ä»¥é™ã®ç©ºãã‚¹ãƒ­ãƒƒãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
   * @param {Array} slots - å…¨ã‚¹ãƒ­ãƒƒãƒˆã®é…åˆ—
   * @param {string} classroom - æ•™å®¤å
   * @returns {Array} ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸã‚¹ãƒ­ãƒƒãƒˆé…åˆ—
   */
  const filterFutureAvailableSlots = (slots, classroom) => {
    if (!slots || !classroom) return [];

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    return slots.filter(s => {
      const slotDate = new Date(s.date);
      slotDate.setMinutes(slotDate.getMinutes() + slotDate.getTimezoneOffset());
      return s.classroom === classroom && slotDate >= today && !s.isFull && s.session !== 'åˆå›è¬›ç¿’';
    });
  };

  /**
   * ã‚¹ãƒ­ãƒƒãƒˆã‚’æœˆåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¾ã™ã€‚
   * @param {Array} slots - ã‚¹ãƒ­ãƒƒãƒˆã®é…åˆ—
   * @returns {Object} æœˆã‚’ã‚­ãƒ¼ã¨ã—ãŸã‚¹ãƒ­ãƒƒãƒˆã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  const groupSlotsByMonth = slots => {
    return slots.reduce((acc, slot) => {
      const month = new Date(slot.date).getMonth() + 1;
      if (!acc[month]) acc[month] = [];
      acc[month].push(slot);
      return acc;
    }, {});
  };

  // =================================================================
  // --- Accounting Cache Utilities ---
  // -----------------------------------------------------------------
  // FE-14: ä¼šè¨ˆå…¥åŠ›å†…å®¹ã‚’localStorageã«ä¸€æ™‚ä¿å­˜ã™ã‚‹æ©Ÿèƒ½
  // =================================================================

  /**
   * ä¼šè¨ˆå…¥åŠ›ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’localStorageã«ä¿å­˜ã™ã‚‹
   * @param {string} reservationId - äºˆç´„ID
   * @param {object} accountingData - ä¿å­˜ã™ã‚‹ä¼šè¨ˆãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  function saveAccountingCache(reservationId, accountingData) {
    if (!reservationId || !accountingData) return;
    const cacheKey = `accounting_cache_${reservationId}`;
    try {
      localStorage.setItem(cacheKey, JSON.stringify(accountingData));
    } catch (e) {
      console.error('Failed to save accounting cache:', e);
    }
  }

  /**
   * localStorageã‹ã‚‰ä¼šè¨ˆå…¥åŠ›ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
   * @param {string} reservationId - äºˆç´„ID
   * @returns {object|null} - èª­ã¿è¾¼ã‚“ã ä¼šè¨ˆãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã¾ãŸã¯null
   */
  function loadAccountingCache(reservationId) {
    if (!reservationId) return null;
    const cacheKey = `accounting_cache_${reservationId}`;
    try {
      const cachedData = localStorage.getItem(cacheKey);
      return cachedData ? JSON.parse(cachedData) : null;
    } catch (e) {
      console.error('Failed to load accounting cache:', e);
      return null;
    }
  }

  /**
   * localStorageã‹ã‚‰ä¼šè¨ˆå…¥åŠ›ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹
   * @param {string} reservationId - äºˆç´„ID
   */
  function clearAccountingCache(reservationId) {
    if (!reservationId) return;
    const cacheKey = `accounting_cache_${reservationId}`;
    try {
      localStorage.removeItem(cacheKey);
    } catch (e) {
      console.error('Failed to clear accounting cache:', e);
    }
  }

  // =================================================================
  // --- Accounting Calculation Logic ---
  // -----------------------------------------------------------------
  // ä¼šè¨ˆç”»é¢ã§ã®è¤‡é›‘ãªæ–™é‡‘è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã§ã™ã€‚
  // æˆæ¥­æ–™ã€ææ–™è²»ã€å‰²å¼•ãªã©ã‚’å‹•çš„ã«è¨ˆç®—ã—ã€åˆè¨ˆé‡‘é¡ã‚’ç®—å‡ºã—ã¾ã™ã€‚
  // =================================================================
  function calculateAccountingDetails() {
    if (!appState.accountingMaster) return null;
    let tuitionSubtotal = 0;
    let salesSubtotal = 0;
    const details = {
      tuition: { items: [] },
      sales: { items: [] },
      grandTotal: 0,
      paymentMethod: '',
      items: [],
    };
    const form = document.getElementById('accounting-form');
    if (!form) return null;

    const r = appState.accountingReservation;
    const classroomRule = appState.accountingMaster.find(
      item => item['å¯¾è±¡æ•™å®¤'] && item['å¯¾è±¡æ•™å®¤'].includes(r.classroom) && item['ç¨®åˆ¥'] === 'æˆæ¥­æ–™',
    );
    const isTimeBased = classroomRule && classroomRule['å˜ä½'] === '30åˆ†';
    let tuitionBreakdownHtml = '';

    if (isTimeBased) {
      const startTime = document.getElementById('start-time')?.value;
      const endTime = document.getElementById('end-time')?.value;
      const breakMinutes = parseInt(document.getElementById('break-time')?.value || 0, 10);

      if (startTime && endTime && startTime < endTime) {
        const start = new Date(`1970-01-01T${startTime}:00`);
        const end = new Date(`1970-01-01T${endTime}:00`);
        let diffMinutes = (end - start) / 60000 - breakMinutes;

        if (diffMinutes > 0) {
          const billableUnits = Math.ceil(diffMinutes / 30);
          const price = billableUnits * Number(classroomRule['å˜ä¾¡']);
          tuitionSubtotal += price;
          //ã€FE-16ã€‘é …ç›®åã«åˆ©ç”¨æ™‚é–“ã‚’è¿½åŠ 
          const tuitionItem = { name: `æˆæ¥­æ–™ (${startTime} - ${endTime})`, price: price };
          details.tuition.items.push(tuitionItem);
          document.getElementById('calculated-hours').textContent =
            `å—è¬›æ™‚é–“: ${billableUnits * 0.5}æ™‚é–“ Ã— ${2.0 * classroomRule['å˜ä¾¡']}å††`;
        } else {
          document.getElementById('calculated-hours').textContent = ``;
        }
      }
    }

    form.querySelectorAll('input[type="checkbox"].accounting-item').forEach(cb => {
      if (cb.checked || cb.disabled) {
        const itemName = cb.dataset.itemName;
        const itemType = cb.dataset.itemType;
        const masterItem = appState.accountingMaster.find(m => m['é …ç›®å'] === itemName && m['ç¨®åˆ¥'] === itemType);
        if (!masterItem) return;
        const price = Number(masterItem['å˜ä¾¡']);
        const itemDetail = { name: itemName, price: price };
        details.items.push(itemDetail);

        if (itemType === 'æˆæ¥­æ–™') {
          tuitionSubtotal += price;
          details.tuition.items.push(itemDetail);
          tuitionBreakdownHtml += `<div class="flex justify-between"><span>${itemDetail.name}</span><span>${itemDetail.price.toLocaleString()}å††</span></div>`;
        } else {
          salesSubtotal += price;
          details.sales.items.push(itemDetail);
        }
      }
    });

    const discountSelector = document.getElementById('discount-selector');
    if (discountSelector) {
      const discountRule = appState.accountingMaster.find(item => item['é …ç›®å'] === 'åˆå›è¬›ç¿’åŒæ™‚é–“å‰²å¼•');
      if (discountRule) {
        const discountMinutes = parseInt(discountSelector.value, 10);
        if (discountMinutes > 0) {
          const discountAmount = (discountMinutes / 30) * Math.abs(Number(discountRule['å˜ä¾¡']));
          tuitionSubtotal -= discountAmount;
          const discountItem = {
            name: `åˆå›è¬›ç¿’åŒæ™‚é–“å‰²å¼• (${discountMinutes}åˆ†)`,
            price: -discountAmount,
          };
          details.tuition.items.push(discountItem);
          tuitionBreakdownHtml += `<div class="flex justify-between text-red-600"><span>${discountItem.name}</span><span>${discountItem.price.toLocaleString()}å††</span></div>`;
        }
      }
    }

    if (isTimeBased) document.getElementById('tuition-breakdown').innerHTML = tuitionBreakdownHtml;

    const materialContainer = document.getElementById('materials-container');
    if (materialContainer) {
      const materialRows = materialContainer.querySelectorAll('div[data-material-row-index]');
      materialRows.forEach((row, index) => {
        const type = document.getElementById(`material-type-${index}`)?.value;
        const masterItem = appState.accountingMaster.find(m => m['é …ç›®å'] === type);
        const priceEl = document.getElementById(`material-price-${index}`);
        if (!masterItem) {
          if (priceEl) priceEl.textContent = '0å††';
          return;
        }
        const unitPrice = Number(masterItem['å˜ä¾¡']);
        let finalName = type;
        let price = 0;
        if (masterItem['å˜ä½'] === 'cmÂ³') {
          const l = document.getElementById(`material-l-${index}`)?.value || 0;
          const w = document.getElementById(`material-w-${index}`)?.value || 0;
          const h = document.getElementById(`material-h-${index}`)?.value || 0;
          if (l > 0 && w > 0 && h > 0) {
            const volumeCm = (l / 10) * (w / 10) * (h / 10);
            let calculatedPrice = Math.round((volumeCm * unitPrice) / 100) * 100;
            price = Math.max(100, calculatedPrice);
            finalName = `${type} (${l}x${w}x${h}mm)`;
          }
        } else {
          if (type) price = unitPrice;
        }
        if (priceEl) priceEl.textContent = `${price.toLocaleString()}å††`;
        if (price > 0) {
          const itemDetail = { name: finalName, price: price };
          salesSubtotal += price;
          details.sales.items.push(itemDetail);
        }
      });
    }
    const otherSalesContainer = document.getElementById('other-sales-container');
    if (otherSalesContainer) {
      const otherSalesRows = otherSalesContainer.querySelectorAll('div[data-other-sales-row]');
      otherSalesRows.forEach((row, index) => {
        const name = document.getElementById(`other-sales-name-${index}`)?.value.trim();
        const priceInput = document.getElementById(`other-sales-price-${index}`);
        let priceValue = priceInput.value
          .replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xfee0))
          .replace(/[^0-9.-]/g, '');
        priceInput.value = priceValue;
        const price = Number(priceValue || 0);
        if (name && price !== 0) {
          const itemDetail = { name: name, price: price };
          salesSubtotal += price;
          details.sales.items.push(itemDetail);
        }
      });
    }
    details.tuition.subtotal = tuitionSubtotal;
    details.sales.subtotal = salesSubtotal;
    details.grandTotal = tuitionSubtotal + salesSubtotal;
    document.getElementById('tuition-subtotal').textContent = `å°è¨ˆ: ${tuitionSubtotal.toLocaleString()}å††`;
    document.getElementById('sales-subtotal').textContent = `å°è¨ˆ: ${salesSubtotal.toLocaleString()}å††`;
    document.getElementById('grand-total-amount').textContent = `åˆè¨ˆ: ${details.grandTotal.toLocaleString()}å††`;
    details.paymentMethod = form.querySelector('input[name="payment-method"]:checked')?.value || 'ç¾é‡‘';
    return details;
  }

    // ========== /12_WebApp_Core.html ==========

    // ========== 13_WebApp_Views.html ==========

  /**
   * =================================================================
   * ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: 13_WebApp_Views.html
   * ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘: 1.9
   * ã€å½¹å‰²ã€‘: WebAppã®å„ç”»é¢ï¼ˆãƒ“ãƒ¥ãƒ¼ï¼‰ã®HTMLæ§‹é€ ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ç¾¤ã‚’é›†ç´„ã—ã¾ã™ã€‚
   * - å„é–¢æ•°ã¯ç‰¹å®šã®ç”»é¢ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã€äºˆç´„ä¸€è¦§ãªã©ï¼‰ã®UIæ§‹ç¯‰ã‚’æ‹…å½“ã—ã¾ã™ã€‚
   * - appStateã®ç¾åœ¨ã®çŠ¶æ…‹ã«åŸºã¥ãã€å‹•çš„ã«HTMLã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * ã€æ§‹æˆã€‘: 14ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã§ã®ãƒ“ãƒ¥ãƒ¼ç®¡ç†
   * ã€v1.9ã§ã®å¤‰æ›´ç‚¹ã€‘:
   * - FE-14: ä¼šè¨ˆç”»é¢ã®å…¥åŠ›ä¿æŒæ©Ÿèƒ½ã‚’å®Ÿè£…ã€‚
   *   - getAccountingViewã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸå€¤ã¨ã—ã¦è¨­å®šã™ã‚‹ã‚ˆã†ä¿®æ­£ã€‚
   * =================================================================
   */

  // =================================================================
  // --- View Helper Components ---
  // -----------------------------------------------------------------
  // å„ãƒ“ãƒ¥ãƒ¼ã‚’æ§‹æˆã™ã‚‹ãŸã‚ã®ã€ã‚ˆã‚Šå°ã•ãªéƒ¨å“ã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤ã€‚
  // =================================================================

  /**
   * é›»è©±ç•ªå·ã‚’ 090 1234 5678 ã®ã‚ˆã†ãªå½¢å¼ã§è¡¨ç¤ºã™ã‚‹
   */
  function formatPhoneDisplay(phone) {
    const digits = String(phone).replace(/[^0-9]/g, '');
    return `${digits.slice(0, 3)} ${digits.slice(3, 7)} ${digits.slice(7)}`;
  }

  /**
   * æ™‚åˆ»é¸æŠç”¨ã®<option>ã‚¿ã‚°ç¾¤ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {number} startHour - é–‹å§‹æ™‚åˆ»ï¼ˆæ™‚ï¼‰
   * @param {number} endHour - çµ‚äº†æ™‚åˆ»ï¼ˆæ™‚ï¼‰
   * @param {number} step - é–“éš”ï¼ˆåˆ†ï¼‰
   * @param {string | null} selectedValue - äº‹å‰ã«é¸æŠã™ã‚‹æ™‚åˆ» (HH:mm)
   * @returns {string} HTMLã®<option>ã‚¿ã‚°æ–‡å­—åˆ—
   */
  const getTimeOptionsHtml = (startHour, endHour, step, selectedValue) => {
    let options = [];
    for (let h = startHour; h <= endHour; h++) {
      for (let m = 0; m < 60; m += step) {
        const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        options.push(`<option value="${time}" ${time === selectedValue ? 'selected' : ''}>${time}</option>`);
      }
    }
    return options.join('');
  };

  /**
   * å‰²å¼•é¸æŠç”¨ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {object} discountRule - æ–™é‡‘ãƒã‚¹ã‚¿ã‹ã‚‰å–å¾—ã—ãŸå‰²å¼•ãƒ«ãƒ¼ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   * @param {string} selectedValue - é¸æŠæ¸ˆã¿ã®å€¤
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getDiscountHtml = (discountRule, selectedValue) => {
    if (!discountRule) return '';
    const options = [
      { value: 0, text: 'ãªã—' },
      { value: 30, text: `30åˆ† (${Math.abs(Number(discountRule['å˜ä¾¡']))}å††å¼•)` },
      { value: 60, text: `60åˆ† (${Math.abs(Number(discountRule['å˜ä¾¡'])) * 2}å††å¼•)` },
    ];
    return `
        <div class="mt-4 pt-4 border-t border-ui-border-light">
            <label class="${DesignConfig.text.labelBlock}">${discountRule['é …ç›®å']}</label>
            <select id="discount-selector" name="discountMinutes" class="${DesignConfig.inputs.base} p-2 text-base accounting-item">
                ${options.map(o => `<option value="${o.value}" ${String(o.value) === selectedValue ? 'selected' : ''}>${o.text}</option>`).join('')}
            </select>
        </div>`;
  };

  /**
   * æ”¯æ‰•ã„æƒ…å ±ï¼ˆã“ã¨ã‚‰é€é‡‘ã€æŒ¯è¾¼å…ˆï¼‰ã®è¡¨ç¤ºUIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getPaymentInfoHtml = () => {
    return `
        <div class="bg-ui-surface border border-ui-border p-3 rounded-md">
            <div class="flex justify-between items-center">
                <div class="${DesignConfig.text.body}"><span class="font-bold">ã“ã¨ã‚‰é€é‡‘:</span><span class="ml-2">09013755977</span></div>
                <button data-action="copyToClipboard" data-copy-text="09013755977" class="flex-shrink-0 text-sm bg-action-secondary-bg active:bg-action-secondary-hover text-action-secondary-text font-bold px-2 py-1 rounded mobile-button">ã‚³ãƒ”ãƒ¼</button>
            </div>
        </div>
        <div class="bg-ui-surface border border-ui-border p-3 rounded-md">
            <div class="text-brand-text"><span class="font-bold">æŒ¯è¾¼å…ˆ:</span><span class="ml-2">ã‚†ã†ã¡ã‚‡éŠ€è¡Œ</span></div>
            <div class="mt-1 flex justify-between items-center">
                <div class="text-base text-brand-text">åº—ç•ª: 818</div>
                <button data-action="copyToClipboard" data-copy-text="818" class="text-sm bg-action-secondary-bg active:bg-action-secondary-hover text-action-secondary-text font-bold px-2 py-1 rounded mobile-button">ã‚³ãƒ”ãƒ¼</button>
            </div>
            <div class="mt-1 flex justify-between items-center">
                <div class="text-base text-brand-text">æ™®é€š: 2661797</div>
                <button data-action="copyToClipboard" data-copy-text="2661797" class="text-sm bg-action-secondary-bg active:bg-action-secondary-hover text-action-secondary-text font-bold px-2 py-1 rounded mobile-button">ã‚³ãƒ”ãƒ¼</button>
            </div>
        </div>`;
  };

  /**
   * æ”¯æ‰•ã„æ–¹æ³•ã®é¸æŠè‚¢ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼‰UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {string} selectedValue - é¸æŠæ¸ˆã¿ã®æ”¯æ‰•ã„æ–¹æ³•
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getPaymentOptionsHtml = selectedValue => {
    const cotraDetails = `
        <details class="mt-2 ml-6">
            <summary class="inline-block px-2 py-1 bg-ui-warning-light text-ui-warning-text text-sm font-semibold rounded-md active:bg-ui-warning-bg">
                ã“ã¨ã‚‰é€é‡‘ã¨ã¯ï¼Ÿ <span class="arrow">â–¼</span>
            </summary>
            <p class="mt-2 p-2 bg-ui-warning-bg rounded-md text-sm text-left text-brand-subtle">
                é›»è©±ç•ªå·ã ã‘ã§éŠ€è¡Œå£åº§é–“ã§é€é‡‘ã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚æ‰‹æ•°æ–™ç„¡æ–™ã€‚å¯¾å¿œã®éŠ€è¡Œã‚¢ãƒ—ãƒªã‹ã‚‰åˆ©ç”¨ã§ãã¾ã™ã€‚<br>
                (ä¾‹ï¼šã‚†ã†ã¡ã‚‡é€šå¸³ã‚¢ãƒ—ãƒªã€ä¸‰äº•ä½å‹éŠ€è¡Œã‚¢ãƒ—ãƒªã€ä½ä¿¡SBIãƒãƒƒãƒˆéŠ€è¡Œã‚¢ãƒ—ãƒªãªã©)
                <a href="https://www.cotra.ne.jp/member/" target="_blank" class="text-ui-link-text">å¯¾å¿œã‚¢ãƒ—ãƒªä¸€è¦§</a>
            </p>
        </details>`;
    const options = [
      { value: 'ç¾é‡‘', text: 'ç¾é‡‘', details: '' },
      { value: 'ã“ã¨ã‚‰é€é‡‘', text: 'ã“ã¨ã‚‰é€é‡‘', details: cotraDetails },
      { value: 'æŒ¯è¾¼', text: 'æŒ¯è¾¼', details: '' },
    ];
    return (
      options
        .map(
          (opt, i) => `
        <div>
            <label class="flex items-center space-x-2 text-brand-text">
                <input type="radio" name="payment-method" value="${opt.value}" class="accounting-item accent-action-primary-bg" ${opt.value === selectedValue ? 'checked' : ''}>
                <span>${opt.text}</span>
            </label>
            ${opt.details}
        </div>`,
        )
        .join('') +
      `
        <div class="mt-4 space-y-2 text-base">${getPaymentInfoHtml()}</div>`
    );
  };

  /**
   * ä¼šè¨ˆç”»é¢ã®ææ–™å…¥åŠ›è¡Œã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {number} index - ææ–™è¡Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
   * @param {object} [data={}] - åˆæœŸãƒ‡ãƒ¼ã‚¿
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getMaterialRowHtml = (index, data = {}) => {
    const materialOptions = appState.accountingMaster
      .filter(m => m['ç¨®åˆ¥'] === 'ææ–™')
      .map(m => `<option value="${m['é …ç›®å']}" ${data.type === m['é …ç›®å'] ? 'selected' : ''}>${m['é …ç›®å']}</option>`)
      .join('');
    return `
        <div data-material-row-index="${index}">
            <div class="grid grid-cols-1 gap-y-2">
                <select id="material-type-${index}" name="materialType${index}" class="${DesignConfig.inputs.base} accounting-item">
                    <option value="">-- æ¨¹ç¨®ã‚’é¸æŠ --</option>
                    ${materialOptions}
                </select>
            </div>
            <div class="grid grid-cols-4 gap-2 mt-2 items-center">
                <input type="number" id="material-l-${index}" name="materialL${index}" value="${data.l || ''}" placeholder="ç¸¦(mm)" step="5" class="${DesignConfig.inputs.base} accounting-item custom-placeholder">
                <input type="number" id="material-w-${index}" name="materialW${index}" value="${data.w || ''}" placeholder="æ¨ª(mm)" step="5" class="${DesignConfig.inputs.base} accounting-item custom-placeholder">
                <input type="number" id="material-h-${index}" name="materialH${index}" value="${data.h || ''}" placeholder="åš(mm)" step="5" class="${DesignConfig.inputs.base} accounting-item custom-placeholder">
                <div id="material-price-${index}" class="text-right text-base text-brand-subtle">0å††</div>
            </div>
        </div>`;
  };

  /**
   * ä¼šè¨ˆç”»é¢ã®ã€Œãã®ä»–è²©å£²å“ã€å…¥åŠ›è¡Œã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {number} index - å…¥åŠ›è¡Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
   * @param {object} [data={}] - åˆæœŸãƒ‡ãƒ¼ã‚¿
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getOtherSalesRowHtml = (index, data = {}) => {
    return `
        <div data-other-sales-row="${index}" class="mt-2 pt-2 border-t border-ui-border grid grid-cols-3 gap-2 items-center">
            <input type="text" id="other-sales-name-${index}" name="otherSalesName${index}" value="${data.name || ''}" placeholder="å•†å“å" class="col-span-2 ${DesignConfig.inputs.base} accounting-item">
            <input type="text" inputmode="decimal" id="other-sales-price-${index}" name="otherSalesPrice${index}" value="${data.price || ''}" placeholder="é‡‘é¡" class="${DesignConfig.inputs.base} accounting-item">
        </div>`;
  };

  /**
   * äºˆç´„ãƒ»å±¥æ­´ã‚«ãƒ¼ãƒ‰ç”¨ã®å…±é€šã‚«ãƒ¼ãƒ‰æ§‹é€ ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {object} config - ã‚«ãƒ¼ãƒ‰è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const createReservationCard = config => {
    const {
      type, // 'booking' | 'history'
      item,
      today,
      buttons = [],
    } = config;

    const isBooking = type === 'booking';
    const venueText = item.venue || '';
    const isPastOrToday = isBooking ? new Date(item.date).getTime() <= today.getTime() : true;

    // æ™‚åˆ»è¡¨ç¤ºã®ç”Ÿæˆ
    let timeText = '';
    if (item.startTime && item.endTime) {
      timeText = `<span>${item.startTime} - ${item.endTime}</span>`;
    }

    let cardColorClass = 'bg-ui-surface border border-ui-border';
    if (isBooking) {
      const cardColor = item.isWaiting ? DesignConfig.cards.state.waitlist : DesignConfig.cards.state.booked;
      cardColorClass = cardColor.card;
    } else if (type === 'history') {
      cardColorClass = DesignConfig.cards.state.history.card;
    }

    // åˆ¶ä½œãƒ¡ãƒ¢éƒ¨åˆ†ã®èƒŒæ™¯è‰²
    const memoBackgroundClass = isBooking ? 'bg-ui-surface' : 'bg-ui-surface';

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼ˆäºˆç´„ã®ã¿ï¼‰
    let statusBadges = '';
    if (isBooking) {
      if (item.firstLecture) {
        statusBadges += `<p class="font-bold text-action-attention-bg text-lg">åˆå›è¬›ç¿’</p>`;
      }
      if (item.isWaiting) {
        statusBadges += `<p class="font-bold ${DesignConfig.cards.state.waitlist.text} text-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡</p>`;
      }
    }

    // ãƒœã‚¿ãƒ³éƒ¨åˆ†ã®ç”Ÿæˆ
    const buttonsHtml = buttons
      .map(btn =>
        Components.createButton({
          action: btn.action,
          classroom: btn.classroom || item.classroom,
          reservationId: btn.reservationId || item.reservationId,
          date: btn.date || item.date,
          sheetName: btn.sheetName || item.sheetName,
          details: btn.details,
          text: btn.text,
          colorClass: btn.colorClass,
        }),
      )
      .join('');

    return `
      <div class="${cardColorClass || 'bg-ui-surface border border-ui-border'} p-3 rounded-lg flex flex-col space-y-3">
        <div class="flex-shrink-0">
          <div >
            <span class="text-brand-text font-bold text-base sm:text-xl">${formatDate(item.date || '')} </span>
            <span class="text-brand-text text-base time-display">${timeText || ''}</span>
          </div>
          <p class="text-brand-text font-bold text-base break-words">${item.classroom || ''} ${venueText || ''}</p>
          ${statusBadges || ''}
        </div>
        <div class="${memoBackgroundClass || 'bg-ui-surface'} p-3 rounded-md w-full border border-ui-border">
          <div class="w-full min-h-[3rem] flex items-start">
            <p class="text-base text-brand-text whitespace-pre-wrap break-words w-full leading-relaxed">${item.workInProgress != null && item.workInProgress !== '' ? item.workInProgress : `<span class="text-brand-muted">åˆ¶ä½œãƒ¡ãƒ¢</span>`}</p>
          </div>
        </div>
        ${buttonsHtml ? `<div class="flex justify-end items-center space-x-2 flex-shrink-0">${buttonsHtml}</div>` : ''}
      </div>
    `;
  };

  /**
   * å‚åŠ è¨˜éŒ²ç·¨é›†ç”¨ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ä¸­èº«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {object} item - ç·¨é›†å¯¾è±¡ã®å±¥æ­´ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getMemoEditModalHtml = item => {
    return `
        <p class="text-base ${DesignConfig.colors.textSubtle} mb-4">${formatDate(item.date)}  ${item.classroom}</p>
        <textarea id="memo-edit-textarea" class="${DesignConfig.inputs.textarea} h-32" placeholder="åˆ¶ä½œãƒ¡ãƒ¢ã‚’å…¥åŠ›â€¦">${item.workInProgress || ''}</textarea>
    `;
  };

  /**
   * æ™‚é–“åˆ¶æ•™å®¤ã®æˆæ¥­æ–™è¨ˆç®—UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {object} rule - æ–™é‡‘ãƒã‚¹ã‚¿ã‹ã‚‰å–å¾—ã—ãŸæ•™å®¤ãƒ«ãƒ¼ãƒ«
   * @param {object} initial - åˆæœŸå€¤ï¼ˆé–‹å§‹æ™‚åˆ»ãªã©ï¼‰
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getTimeBasedTuitionHtml = (rule, initial) => {
    if (
      !rule ||
      typeof rule['è¬›åº§é–‹å§‹'] !== 'string' ||
      typeof rule['è¬›åº§çµ‚äº†'] !== 'string' ||
      !rule['è¬›åº§é–‹å§‹'].includes(':') ||
      !rule['è¬›åº§çµ‚äº†'].includes(':')
    ) {
      return `<div class="text-ui-error-text p-4 bg-ui-error-bg rounded-lg">ã‚¨ãƒ©ãƒ¼: ã“ã®æ•™å®¤ã®è¬›åº§æ™‚é–“ãŒãƒã‚¹ã‚¿ã«æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>`;
    }
    const classStart = parseInt(rule['è¬›åº§é–‹å§‹'].split(':')[0]);
    const classEnd = parseInt(rule['è¬›åº§çµ‚äº†'].split(':')[0]);
    const endBuffer = 3;

    const breakOptions = [...Array(5).keys()]
      .map(
        i =>
          `<option value="${i * 30}" ${String(i * 30) === (initial.breakTime || '0') ? 'selected' : ''}>${i * 30}åˆ†</option>`,
      )
      .join('');

    const startTimeOptions = getTimeOptionsHtml(classStart, classEnd + endBuffer, 30, initial.startTime);
    const endTimeOptions = getTimeOptionsHtml(classStart, classEnd + endBuffer, 30, initial.endTime);

    const rentalChecked = initial.chiselRental || initial['å½«åˆ»åˆ€ãƒ¬ãƒ³ã‚¿ãƒ«'] === true ? 'checked' : '';

    const discountRule = appState.accountingMaster.find(item => item['é …ç›®å'] === ITEM_NAME_DISCOUNT);
    const discountHtml = discountRule
      ? `<div class="mt-4 pt-4 border-t border-gray-200">${getDiscountHtml(discountRule, initial.discountMinutes || '0')}<p class="text-sm ${DesignConfig.colors.textSubtle} mt-2 text-left">${discountRule.èª¬æ˜ || 'åˆå›è¬›ç¿’ã¨åŒæ™‚åˆ»ã«å‚åŠ ã®å ´åˆã€30åˆ†ã‚ãŸã‚ŠÂ¥300å‰²å¼•ã€‚ãŸã ã—ã€åˆå›è¬›ç¿’å‚åŠ è€…ãŒã„ã‚‹å ´åˆã®ã¿'}</p></div>`
      : '';

    return `
        <div class="p-4 ${DesignConfig.cards.background} rounded-lg space-y-3">
            <h3 class="${DesignConfig.text.heading} mb-2">æˆæ¥­æ–™</h3>
            <div class="grid grid-cols-3 gap-2 items-end">
                ${Components.createSelect({ id: 'start-time', name: 'startTime', label: 'é–‹å§‹æ™‚åˆ»', containerClass: 'col-span-1', options: startTimeOptions })}
                ${Components.createSelect({ id: 'end-time', name: 'endTime', label: 'çµ‚äº†æ™‚åˆ»', containerClass: 'col-span-1', options: endTimeOptions })}
                ${Components.createSelect({ id: 'break-time', name: 'breakTime', label: 'ä¼‘æ†©æ™‚é–“', containerClass: 'col-span-1', options: breakOptions })}
            </div>
            <div id="calculated-hours" class="text-left text-base ${DesignConfig.colors.textSubtle} mt-2"></div>
            <div class="pt-3 mt-3 border-t border-gray-200">
                <label class="flex items-center justify-between">
                    <span class="text-brand-text">å½«åˆ»åˆ€ãƒ¬ãƒ³ã‚¿ãƒ«</span>
                    <input type="checkbox" name="chiselRental" data-item-type="æˆæ¥­æ–™" data-item-name="å½«åˆ»åˆ€ãƒ¬ãƒ³ã‚¿ãƒ«" class="accounting-item h-5 w-5 rounded border-ui-border text-brand-text focus:ring-brand-text" ${rentalChecked}>
                </label>
            </div>
            ${discountHtml}
            <div id="tuition-breakdown" class="mt-4 pt-4 border-t border-ui-border space-y-1 text-base ${DesignConfig.colors.textSubtle}"></div>
            <div class="text-right font-bold mt-2" id="tuition-subtotal">å°è¨ˆ: 0å††</div>
        </div>`;
  };

  // =================================================================
  // --- Main Application Views ---
  // -----------------------------------------------------------------
  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å„ç”»é¢ã®å®Œå…¨ãªHTMLæ§‹é€ ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ç¾¤ã€‚
  // =================================================================

  /**
   * ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getLoginView = () => {
    const phoneValue = appState.loginPhone || '';
    return `
      <div class="text-center pt-8 pb-4">
          <h1 class="text-3xl font-bold text-brand-text tracking-tight">ãã¼ã‚Šã®<br>ã‚ˆã‚„ããƒ»ãã‚ã</h1>
          <h2 class="text-xl text-brand-subtle mt-2 mb-10">å·å´èª äºŒ æœ¨å½«ã‚Šæ•™å®¤</h2>
      </div>
      ${Components.createInput({ id: 'phone', label: 'é›»è©±ç•ªå·', type: 'tel', placeholder: '090 1234 5678', containerClass: DesignConfig.inputs.container, autocomplete: 'tel', isSrOnly: false, labelClass: `block text-brand-subtle text-sm text-center mb-1`, inputClass: 'text-center', inputmode: 'numeric', pattern: '[0-9]*', value: phoneValue })}
      <p id="phone-display" class="text-brand-subtle text-lg mt-2">${formatPhoneDisplay(phoneValue)}</p>
      <div class="mt-6 flex justify-center">
          <div class="${DesignConfig.inputs.container}">
              ${Components.createButton({ text: 'ãƒ­ã‚°ã‚¤ãƒ³ ã¾ãŸã¯ æ–°è¦ç™»éŒ²', action: 'login', colorClass: DesignConfig.colors.primary, widthClass: DesignConfig.buttons.full })}
          </div>
      </div>`;
  };

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæ–°è¦ç™»éŒ²ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†å…±é€šï¼‰
   * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   * @param {string} config.mode - 'register' ã¾ãŸã¯ 'edit'
   * @param {string} [config.phone] - é›»è©±ç•ªå·ï¼ˆæ–°è¦ç™»éŒ²æ™‚ï¼‰
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getUserFormView = config => {
    const { mode, phone } = config;
    const isEdit = mode === 'edit';
    const u = appState.currentUser || {};

    // å…¥åŠ›å€¤ã®ä¿æŒ: æ–°è¦ç™»éŒ²Step1ã§ã¯appState.registrationDataã‚’å‚ç…§
    let regData = appState.registrationData || {};
    const realNameValue = isEdit ? u.realName || '' : regData.realName || '';
    const nicknameValue = isEdit ? u.displayName || '' : regData.nickname || '';
    const phoneValue = isEdit ? appState.phoneForRegistration || u.phone || '' : regData.phone || phone || '';

    // é›»è©±ç•ªå·è¡¨ç¤ºã®åˆ¤å®š
    const isPhoneInputNeeded = isEdit && (appState.phoneForRegistration || !u.phone);

    // ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜æ–‡
    const title = isEdit ? 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†' : 'æ–°è¦ç™»éŒ²';
    const description = isEdit ? '' : '<p class="text-brand-subtle mb-6">ãŠåå‰ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>';

    // é›»è©±ç•ªå·ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    let phoneSection = '';
    if (!isEdit) {
      // æ–°è¦ç™»éŒ²æ™‚ï¼šé›»è©±ç•ªå·ã‚’è¡¨ç¤ºã®ã¿
      phoneSection = `
        <div class="mb-4">
            <label class="block text-brand-text text-base font-bold mb-2">é›»è©±ç•ªå·</label>
            <input type="tel" id="reg-phone" value="${phoneValue}" class="${DesignConfig.inputs.base}" placeholder="090 1234 5678" autocomplete="tel" inputmode="numeric" pattern="[0-9]*">
            <p id="reg-phone-display" class="text-brand-subtle text-lg mt-2">${formatPhoneDisplay(phoneValue)}</p>
        </div>`;
    } else if (isPhoneInputNeeded) {
      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†æ™‚ï¼šé›»è©±ç•ªå·å…¥åŠ›ãŒå¿…è¦
      phoneSection = `
        <div class="mb-4">
            <label for="edit-phone" class="block text-brand-text text-base font-bold mb-2">é›»è©±ç•ªå·</label>
            <input type="tel" id="edit-phone" value="${phoneValue}"
                   class="${DesignConfig.inputs.base}" placeholder="090 1234 5678"
                   autocomplete="tel" inputmode="numeric" pattern="[0-9]*">
            <p class="text-sm text-brand-subtle mt-1">é›»è©±ç•ªå·ã‚’ç™»éŒ²ã™ã‚‹ã¨æ¬¡å›ã‹ã‚‰ã‚¹ãƒ ãƒ¼ã‚ºã«ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚</p>
        </div>`;
    } else {
      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†æ™‚ï¼šé›»è©±ç•ªå·è¡¨ç¤ºã®ã¿
      phoneSection = `
        <div class="mb-4">
            <label class="block text-brand-text text-base font-bold mb-2">é›»è©±ç•ªå·</label>
            <p class="font-semibold p-3 bg-ui-surface text-brand-text rounded-lg w-auto inline-block">${phoneValue}</p>
        </div>`;
    }

    // ãƒœã‚¿ãƒ³è¨­å®š
    const buttons = isEdit
      ? [
          { text: 'ã“ã®å†…å®¹ã§æ›´æ–°', action: 'saveProfile', colorClass: DesignConfig.colors.primary },
          { text: 'æˆ»ã‚‹', action: 'goBackToClassroomSelect', colorClass: DesignConfig.colors.secondary },
        ]
      : [
          { text: 'æ¬¡ã¸é€²ã‚€', action: 'goToStep2', colorClass: DesignConfig.colors.primary },
          { text: 'æˆ»ã‚‹', action: 'goBackToLogin', colorClass: DesignConfig.colors.secondary },
        ];

    const nameIdPrefix = isEdit ? 'edit' : 'reg';

    return `
        <div class="max-w-md mx-auto">
            <h1 class="text-xl font-bold text-brand-text mb-4">${title}</h1>
            ${description}
            <div class="space-y-4">
                ${Components.createInput({
                  id: `${nameIdPrefix}-realname`,
                  label: 'ãŠåå‰ï¼ˆæœ¬å å¿…é ˆé …ç›®ï¼‰',
                  type: 'text',
                  required: true,
                  value: realNameValue,
                  containerClass: '',
                  autocomplete: 'name',
                })}
                ${Components.createInput({
                  id: `${nameIdPrefix}-nickname`,
                  label: 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆè¡¨ç¤ºå ä»–ã®ç”Ÿå¾’ã•ã‚“ã«ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰',
                  type: 'text',
                  value: nicknameValue,
                  placeholder: 'ç©ºæ¬„ã®å ´åˆã¯æœ¬å',
                  containerClass: '',
                })}
                ${phoneSection}
            </div>
            <div class="mt-6">
                <div class="space-y-3">
                    ${buttons
                      .map(btn =>
                        Components.createButton({
                          text: btn.text,
                          action: btn.action,
                          colorClass: btn.colorClass,
                          widthClass: DesignConfig.buttons.full,
                        }),
                      )
                      .join('')}
                </div>
            </div>
        </div>`;
  };

  /**
   * æ–°è¦ç™»éŒ²ç”»é¢ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {string} p - ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œæ™‚ã«å…¥åŠ›ã•ã‚ŒãŸé›»è©±ç•ªå·
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getRegisterView = p => getUserFormView({ mode: 'register', phone: p });

  /**
   * æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼ã®ã‚¹ãƒ†ãƒƒãƒ—2ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ï¼‰ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   */
  const getRegistrationStep2View = () => {
    console.log('getRegistrationStep2View called');
    console.log('DesignConfig:', typeof DesignConfig, DesignConfig);
    console.log('Components:', typeof Components, Components); // Componentsã®ãƒ­ã‚°ã‚’è¿½åŠ 
    const data = appState.registrationData;
    const genderOptions = ['å¥³æ€§', 'ç”·æ€§', 'ãã®ä»–']
      .map(
        opt =>
          `<label class="flex items-center space-x-2"><input type="radio" name="gender" value="${opt}" ${data.gender === opt ? 'checked' : ''}><span class="text-brand-text">${opt}</span></label>`,
      )
      .join('');
    const handOptions = ['å³åˆ©ã', 'å·¦åˆ©ã', 'ä¸¡åˆ©ã']
      .map(
        opt =>
          `<label class="flex items-center space-x-2"><input type="radio" name="dominantHand" value="${opt}" ${data.dominantHand === opt ? 'checked' : ''}><span class="text-brand-text">${opt}</span></label>`,
      )
      .join('');
    const ageOptions = ['10ä»£ï¼ˆ16æ­³ä»¥ä¸Šï¼‰', '20ä»£', '30ä»£', '40ä»£', '50ä»£', '60ä»£', '70ä»£', '80ä»£ä»¥ä¸Š', 'ã²ã¿ã¤']
      .map(opt => `<option value="${opt}" ${data.ageGroup === opt ? 'selected' : ''}>${opt}</option>`)
      .join('');

    return `
    <div class="max-w-md mx-auto text-left">
      <h1 class="text-xl font-bold text-brand-text mb-4 text-center">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h1>
      <form id="step2-form" class="space-y-6">
        ${Components.createInput({ id: 'q-email', label: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆå¿…é ˆï¼‰', type: 'email', value: data.email || '', required: true })}
        <div class="p-3 bg-ui-surface rounded-md">
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="q-wants-email" name="wantsEmail" class="h-5 w-5 accent-action-primary-bg" ${data.wantsEmail ? 'checked' : ''}>
            <span class="text-brand-text text-sm">ä»Šå¾Œã®æ•™å®¤æ—¥ç¨‹ãªã©ã®ã€ãƒ¡ãƒ¼ãƒ«é€£çµ¡ã‚’å¸Œæœ›ã—ã¾ã™</span>
          </label>
        </div>
        ${Components.createSelect({ id: 'q-age-group', label: 'ãŠå¹´é ƒ', options: ageOptions })}
        <div><label class="block text-brand-text text-base font-bold mb-2">æ€§åˆ¥</label><div class="flex space-x-4">${genderOptions}</div></div>
        <div><label class="block text-brand-text text-base font-bold mb-2">åˆ©ãæ‰‹</label><div class="flex space-x-4">${handOptions}</div></div>
        ${Components.createInput({ id: 'q-address', label: 'ä½æ‰€ï¼ˆå¸‚åŒºç”ºæ‘ã¾ã§ã§OKï¼ï¼‰', type: 'text', value: data.address || '' })}
      </form>
      <div class="mt-8 grid grid-cols-2 gap-3">
        ${Components.createButton({ text: 'å‰ã«æˆ»ã‚‹', action: 'backToStep1', colorClass: DesignConfig.colors.secondary })}
        ${Components.createButton({ text: 'æ¬¡ã¸é€²ã‚€', action: 'goToStep3', colorClass: DesignConfig.colors.primary })}
      </div>
    </div>
  `;
  };

  /**
   * æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼ã®ã‚¹ãƒ†ãƒƒãƒ—3ï¼ˆæœ¨å½«ã‚Šã«ã¤ã„ã¦ï¼‰ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   */
  const getRegistrationStep3View = () => {
    const data = appState.registrationData;
    const experienceOptions = ['ã¯ã˜ã‚ã¦ï¼', 'ã¡ã‚‡ã£ã¨', 'ãã“ãã“', 'ã‹ãªã‚Šï¼']
      .map(
        opt =>
          `<label class="flex items-center space-x-2"><input type="radio" name="experience" value="${opt}" ${data.experience === opt ? 'checked' : ''}><span class="text-brand-text">${opt}</span></label>`,
      )
      .join('');

    return `
    <div class="max-w-md mx-auto text-left">
      <h1 class="text-xl font-bold text-brand-text mb-4 text-center">æœ¨å½«ã‚Šã«ã¤ã„ã¦</h1>
      <form id="step3-form" class="space-y-6">
        <div>
          <label class="block text-brand-text text-base font-bold mb-2">æœ¨å½«ã‚Šã®çµŒé¨“ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</label>
          <div class="space-y-2" id="experience-radio-group">${experienceOptions}</div>
        </div>
        <div id="past-work-container" class="${data.experience === 'ã¯ã˜ã‚ã¦ï¼' ? 'hidden' : ''}">
            ${Components.createTextArea({ id: 'q-past-work', label: 'ã„ã¤é ƒã€ã©ã“ã§ã€ä½•ã‚’ä½œã‚Šã¾ã—ãŸã‹ï¼Ÿï¼ˆã ã„ãŸã„ã§OK!ï¼‰', value: data.pastWork || '' })}
        </div>
        ${Components.createTextArea({ id: 'q-future-goal', label: 'å°†æ¥çš„ã«åˆ¶ä½œã—ãŸã„ã‚‚ã®ï¼ˆæ›–æ˜§ãªå†…å®¹ã§ã‚‚å¤§ä¸ˆå¤«ï¼ï¼‰', value: data.futureGoal || '' })}
      </form>
      <div class="mt-8 flex flex-col space-y-3">
        ${Components.createButton({ text: 'ç™»éŒ²ã—ã¦äºˆç´„ã¸é€²ã‚€', action: 'submitRegistration', colorClass: DesignConfig.colors.primary, widthClass: DesignConfig.buttons.full })}
        ${Components.createButton({ text: 'å‰ã«æˆ»ã‚‹', action: 'backToStep2', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
      </div>
    </div>
  `;
  };

  /**
   * NF-01: é›»è©±ç•ªå·æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢ãƒ»é¸æŠç”»é¢ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getNoPhoneUserSelectView = () => {
    const users = appState.noPhoneUsers;
    // NF-01: æ¤œç´¢ãŒå®Ÿè¡Œã•ã‚Œã€çµæœãŒ0ä»¶ã®å ´åˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    const hasSearchedAndNoResults = appState.searchAttempted && users.length === 0;

    return `
        <h1 class="text-xl font-bold text-brand-text mb-4">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æ¢ã™</h1>
        <p class="text-brand-subtle mb-6">ãŠåå‰ï¼ˆæœ¬åï¼‰ã¾ãŸã¯ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ã€ã‚ãªãŸã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚<br>
        <span class="text-sm text-brand-muted">ï¼ˆæ¼¢å­—ãŒç•°ãªã‚‹å ´åˆã‚„ã€å§“ã¨åã®é–“ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã§ã‚‚ã€ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¥ã‚Œãšã«ã€è‹—å­—ã ã‘ã§ã‚‚è©¦ã—ã¦ã¿ã¦ãã ã•ã„ï¼‰</span></p>

        <div class="${DesignConfig.inputs.container} mb-4">
            ${Components.createInput({
              id: 'nickname-search-input',
              label: 'ãŠåå‰ï¼ˆæœ¬åï¼‰ã¾ãŸã¯ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ', // ãƒ©ãƒ™ãƒ«ã‚’å¤‰æ›´
              type: 'text',
              placeholder: 'ãŠåå‰ã¾ãŸã¯ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ', // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å¤‰æ›´
              inputClass: 'text-center',
              autocomplete: 'off',
            })}
            <div class="mt-4 flex justify-center">
                ${Components.createButton({
                  text: 'æ¤œç´¢',
                  action: 'searchNoPhoneUser',
                  colorClass: DesignConfig.colors.primary,
                  widthClass: DesignConfig.buttons.full,
                })}
            </div>
        </div>

        <div class="mt-8 space-y-3">
            ${
              users.length > 0
                ? `
                <h2 class="text-lg font-bold ${DesignConfig.colors.text} text-center mb-2">è¦‹ã¤ã‹ã£ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h2>
                ${users
                  .map(
                    user => `
                    <div class="${DesignConfig.cards.background} p-3 rounded-lg flex justify-between items-center">
                        <p class="text-base font-semibold">${user.realName}ï¼ˆ${user.nickname}ï¼‰</p> // æœ¬åã¨ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ä¸¡æ–¹è¡¨ç¤º
                        ${Components.createButton({
                          text: 'ã“ã‚Œã ï¼',
                          action: 'selectNoPhoneUser',
                          studentId: user.studentId,
                          realName: user.realName,
                          nickname: user.nickname,
                          colorClass:
                            'bg-state-success-bg text-state-success-text text-sm py-1 px-3 rounded active:bg-state-success-hover focus:bg-state-success-hover mobile-button',
                        })}
                    </div>
                `,
                  )
                  .join('')}
            `
                : hasSearchedAndNoResults
                  ? `
                <p class="text-center ${DesignConfig.colors.textSubtle}">ä¸€è‡´ã™ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
            `
                  : ''
            }
        </div>

        <div class="mt-8 pt-4 border-t border-gray-200 flex flex-col space-y-3">
            <h2 class="text-lg font-bold ${DesignConfig.colors.text} text-center mb-2">è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ</h2>
            ${Components.createButton({
              text: 'è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„ã®ã§ã€æ–°è¦ç™»éŒ²ã™ã‚‹',
              action: 'goToRegisterFromNoPhoneSearch',
              colorClass: DesignConfig.colors.primary,
              widthClass: DesignConfig.buttons.full,
            })}
            ${Components.createButton({
              text: 'ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹',
              action: 'goBackToLogin',
              colorClass: DesignConfig.colors.secondary,
              widthClass: DesignConfig.buttons.full,
            })}
        </div>
    `;
  };

  /**
   * ãƒ¡ã‚¤ãƒ³ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®äºˆç´„ä¸€è¦§ã¨å±¥æ­´ä¸€è¦§ã‚’çµ±åˆè¡¨ç¤ºã—ã¾ã™ã€‚
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getDashboardView = () => {
    // ã€æ™‚ç³»åˆ—çµ±ä¸€ã€‘äºˆç´„ã¨å±¥æ­´ã‚’æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆã—ã¦çµ±åˆè¡¨ç¤º
    // ä¸Šã»ã©æœªæ¥ã€ä¸‹ã»ã©éå»ã«ãªã‚‹ã‚ˆã†ã«é…ç½®
    const sortedBookings = [...appState.myBookings].sort((a, b) => new Date(b.date) - new Date(a.date));
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // ã€æ”¹å–„ã€‘ã€Œã‚ãŸã‚‰ã—ã ã‚ˆã‚„ã ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’äºˆç´„ãƒªã‚¹ãƒˆã®å…ˆé ­ã«é…ç½®ã—ã€ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’åˆ†ã‹ã‚Šã‚„ã™ãå¤‰æ›´
    const newBookingCardHtml = `
        <button data-action="goToNewBookingView" class="w-full text-center p-4 rounded-lg border-2 border-dashed border-action-primary-border bg-action-primary-light active:bg-action-primary-subtle focus:bg-action-primary-subtle mobile-button touch-friendly">
            <span class="text-xl font-bold text-action-primary-bg">+ ã‚ãŸã‚‰ã—ã ã‚ˆã‚„ã ã™ã‚‹</span>
        </button>
    `;

    const yourBookingsHtml = `
        <div class="mb-8 w-full">
            <div class="bg-ui-surface border border-ui-border p-3 rounded-lg space-y-3">
                <h2 class="text-xl font-medium text-brand-text text-center mb-2">ã‚ˆã‚„ã</h2>
                ${newBookingCardHtml}
                ${sortedBookings
                  .map(b => {
                    const resDate = new Date(b.date);
                    resDate.setMinutes(resDate.getMinutes() + resDate.getTimezoneOffset());
                    const isPastOrToday = resDate.getTime() <= today.getTime();

                    // ãƒœã‚¿ãƒ³é…åˆ—ã‚’æ§‹ç¯‰
                    const buttons = [];

                    // ä¼šè¨ˆãƒœã‚¿ãƒ³
                    if (isPastOrToday) {
                      if (b.accountingDone) {
                        buttons.push({
                          action: 'goToAccounting',
                          text: 'ä¼šè¨ˆæ¸ˆ',
                          colorClass: `${DesignConfig.colors.paid} text-base font-bold px-3 py-1.5 rounded`,
                        });
                      } else {
                        buttons.push({
                          action: 'goToAccounting',
                          text: 'ä¼šè¨ˆ',
                          colorClass: `text-base ${DesignConfig.colors.accounting} font-bold px-3 py-1.5 rounded mobile-button`,
                        });
                      }
                    }

                    // ç·¨é›†ãƒœã‚¿ãƒ³
                    if (!isPastOrToday && !b.accountingDone) {
                      buttons.push({
                        action: 'goToEditReservation',
                        text: 'ç·¨é›†',
                        colorClass:
                          'text-base bg-action-secondary-bg text-action-secondary-text font-bold px-3 py-1.5 rounded active:bg-action-secondary-hover focus:bg-action-secondary-hover mobile-button',
                      });
                    }

                    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
                    if (!b.accountingDone) {
                      buttons.push({
                        action: 'cancel',
                        text: 'cancel',
                        colorClass:
                          'text-base bg-state-danger-bg text-state-danger-text font-bold px-3 py-1.5 rounded active:bg-state-danger-hover focus:bg-state-danger-hover mobile-button',
                      });
                    }

                    return createReservationCard({
                      type: 'booking',
                      item: b,
                      today: today,
                      buttons: buttons,
                    });
                  })
                  .join('')}
            </div>
        </div>`;

    let historyHtml = '';
    if (appState.history && appState.history.length > 0) {
      // ã€ä¿®æ­£ã€‘å±¥æ­´ã‚‚æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæ—¥ä»˜é™é †ï¼‰ã§æ™‚ç³»åˆ—ã‚’çµ±ä¸€
      const sortedHistory = [...appState.history].sort((a, b) => new Date(b.date) - new Date(a.date));
      const recordsToShow = sortedHistory.slice(0, appState.recordsToShow || 20);
      historyHtml = `
            <div class="mb-8 w-full">
            <div class="bg-ui-surface border border-ui-border p-3 rounded-lg space-y-3">
                    <h2 class="text-xl font-medium text-brand-text text-center mb-2">ãã‚ã</h2>
                    ${recordsToShow
                      .map(h => {
                        // ãƒœã‚¿ãƒ³é…åˆ—ã‚’æ§‹ç¯‰
                        const buttons = [];

                        // ä¼šè¨ˆè¨˜éŒ²ãƒœã‚¿ãƒ³
                        if (h.accountingDetails) {
                          try {
                            const acc = JSON.parse(h.accountingDetails);
                            buttons.push({
                              action: 'showHistoryAccounting',
                              details: h.accountingDetails,
                              text: 'ä¼šè¨ˆè¨˜éŒ²',
                              colorClass:
                                'text-sm bg-action-paid-bg text-action-paid-text font-bold px-3 py-1.5 rounded',
                            });
                          } catch (e) {
                            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯å€‹åˆ¥ã«è¡Œã†
                          }
                        }

                        // ç·¨é›†ãƒœã‚¿ãƒ³
                        buttons.push({
                          action: 'editHistoryMemo',
                          text: 'ç·¨é›†',
                          colorClass:
                            'text-sm bg-action-secondary-bg text-action-secondary-text font-bold px-3 py-1.5 rounded active:bg-action-secondary-hover focus:bg-action-secondary-hover mobile-button',
                        });

                        return createReservationCard({
                          type: 'history',
                          item: h,
                          today: null, // å±¥æ­´ã§ã¯ä¸è¦
                          buttons: buttons,
                        });
                      })
                      .join('')}
                    ${(appState.recordsToShow || 20) < sortedHistory.length ? `<div class="text-center mt-4"><button data-action="loadMoreHistory" class="text-sm bg-action-secondary-bg text-action-secondary-text px-3 py-1.5 rounded-md active:bg-action-secondary-hover mobile-button">ã‚‚ã£ã¨ã¿ã‚‹</button></div>` : ''}
                </div>
            </div>
        `;
    }

    return `
        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4">
            <h1 class="text-xl sm:text-xl font-bold ${DesignConfig.colors.text} mr-4 mb-2 sm:mb-0">ã‚ˆã†ã“ã <span class="whitespace-nowrap">${appState.currentUser.displayName} ã•ã‚“</span></h1>
            <button data-action="goToEditProfile" class="self-end sm:self-auto text-sm bg-action-secondary-bg text-action-secondary-text px-3 py-1.5 rounded-md active:bg-action-secondary-hover mobile-button">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</button>
        </div>
        ${yourBookingsHtml}
        ${historyHtml}
    `;
  };

  /**
   * æ–°è¦äºˆç´„ã®ãŸã‚ã®æ•™å®¤é¸æŠç”»é¢ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getNewBookingView = () => {
    const classroomButtonsHtml = appState.classrooms
      .map(n =>
        Components.createButton({
          action: 'selectClassroom',
          classroomName: n,
          text: n,
          colorClass: `w-full h-16 text-left px-4 py-3 rounded-lg mobile-card touch-friendly transition-all duration-150 bg-state-available-bg border border-state-available-border active:bg-state-success-hover flex items-center text-xl font-bold text-brand-text`,
        }),
      )
      .join('');

    return `
        <h1 class="text-xl font-bold text-brand-text mb-4">ã‚ãŸã‚‰ã—ã„ ã‚ˆã‚„ã</h1>
        <p class="text-brand-subtle text-center mb-6">æ•™å®¤ ã‚’ ãŠãˆã‚‰ã³ãã ã•ã„</p>
        <div class="max-w-md mx-auto space-y-3">
            ${classroomButtonsHtml}
        </div>
        <div class="mt-6 max-w-md mx-auto">
            ${Components.createButton({ text: 'æˆ»ã‚‹', action: 'goBackToClassroomSelect', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
        </div>
    `;
  };

  /**
   * ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ç”»é¢ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getEditProfileView = () => getUserFormView({ mode: 'edit' });

  /**
   * ç‰¹å®šã®æ•™å®¤ã®äºˆç´„æ ä¸€è¦§ç”»é¢ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {string} c - æ•™å®¤å
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getBookingView = c => {
    const s = appState.slots.filter(sl => sl.classroom === c && sl.session !== 'åˆå›è¬›ç¿’');
    if (s.length === 0) {
      return `
            <div class="max-w-md mx-auto">
                <h1 class="text-xl font-bold ${DesignConfig.colors.text} mb-2">${c}</h1>
                <p class="${DesignConfig.colors.textSubtle} mb-6">ç¾åœ¨ã€äºˆç´„å¯èƒ½ãªæ—¥ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                <div class="mt-6">
                    ${Components.createButton({ text: 'æ•™å®¤é¸æŠã«æˆ»ã‚‹', action: 'goBackToClassroomSelect', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
                </div>
            </div>`;
    }
    let currentMonth = null;
    const bHtml = s
      .map(sl => {
        const slotDate = new Date(sl.date);
        const month = slotDate.getMonth() + 1;
        let monthHeader = '';
        if (month !== currentMonth) {
          monthHeader = `<h3 class="text-xl font-medium text-brand-subtle mt-6 mb-2 text-center">${month}æœˆ</h3>`;
          currentMonth = month;
        }
        const iB = appState.myBookings.some(b => b.date === sl.date && b.classroom === sl.classroom);
        let cC,
          sB,
          tag = 'button',
          act = `data-action="bookSlot" data-classroom="${sl.classroom}" data-date="${sl.date}"`;
        let statusText;
        if (typeof sl.morningSlots !== 'undefined') {
          statusText = `åˆå‰ ${sl.morningSlots} | åˆå¾Œ ${sl.afternoonSlots}`;
        } else {
          statusText = `ç©ºã ${sl.availableSlots}`;
        }
        if (iB) {
          if (sl.isWaiting) {
            cC = `${DesignConfig.cards.base} ${DesignConfig.cards.state.waitlist.card}`;
            sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.waitlist.text}">ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡ ç™»éŒ²æ¸ˆ</span>`;
          } else {
            cC = `${DesignConfig.cards.base} ${DesignConfig.cards.state.booked.card}`;
            sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.booked.text}">äºˆç´„æ¸ˆã¿</span>`;
          }
          tag = 'div';
          act = '';
        } else if (sl.isFull || sl.availableSlots === 0 || (sl.morningSlots === 0 && sl.afternoonSlots === 0)) {
          cC = `${DesignConfig.cards.base} ${DesignConfig.cards.state.waitlist.card}`;
          sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.waitlist.text}">æº€å¸­ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡ç”³è¾¼ã¿ï¼‰</span>`;
        } else {
          cC = `${DesignConfig.cards.base} ${DesignConfig.cards.state.available.card}`;
          sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.available.text}">${statusText}</span>`;
        }
        const venueDisplay = sl.venue ? ` ${sl.venue}` : '';
        return `${monthHeader}<${tag} ${act} class="${cC}"><div class="flex justify-between items-center"><span class="${DesignConfig.colors.text}">${formatDate(sl.date)}${venueDisplay}</span>${sB}</div></${tag}>`;
      })
      .join('');
    return `
        <div class="max-w-md mx-auto">
            <h1 class="text-xl font-bold ${DesignConfig.colors.text} mb-4">${c}</h1>
            <div class="${DesignConfig.cards.container}">${bHtml}</div>
            <div class="mt-6">
                ${Components.createButton({ text: 'æ•™å®¤é¸æŠã«æˆ»ã‚‹', action: 'goBackToClassroomSelect', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
            </div>
        </div>`;
  };

  /**
   * äºˆç´„ç¢ºèªç”»é¢ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getConfirmationView = () => {
    // --- State and Data Preparation ---
    const { classroom, date, availableSlots, venue, morningSlots, afternoonSlots, isFull } = appState.selectedSlot;
    const { isFirstTimeBooking: isFirstTime, currentUser, accountingMaster: master } = appState;
    const venueDisplay = venue ? `ï¼ˆ${venue}ï¼‰` : '';

    const classroomRule = master.find(
      item => item['å¯¾è±¡æ•™å®¤'] && item['å¯¾è±¡æ•™å®¤'].includes(classroom) && item['ç¨®åˆ¥'] === 'æˆæ¥­æ–™',
    );

    // --- Helper Functions for UI Sections ---

    /**
     * äºˆç´„çŠ¶æ³ã®è¡¨ç¤ºã‚’ç”Ÿæˆã—ã¾ã™ã€‚
     */
    const _renderStatusHtml = () => {
      if (isFull) return 'æº€å¸­ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡ç”³è¾¼ã¿ï¼‰';
      if (typeof morningSlots !== 'undefined') {
        return `ç©ºã åˆå‰ ${morningSlots} | åˆå¾Œ ${afternoonSlots}`;
      }
      return `ç©ºã ${availableSlots}`;
    };

    /**
     * äºˆç´„æ™‚é–“é¸æŠã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
     */
    const _renderTimeOptionsSection = () => {
      // 30åˆ†å˜ä½ã®æ•™å®¤ã®å ´åˆ
      if (classroomRule && classroomRule['å˜ä½'] === '30åˆ†') {
        const classStartHour = parseInt(classroomRule['è¬›åº§é–‹å§‹'].split(':')[0]);
        const classEndHour = parseInt(classroomRule['è¬›åº§çµ‚äº†'].split(':')[0]);
        const classEndMinutes = parseInt(classroomRule['è¬›åº§çµ‚äº†'].split(':')[1]);

        // Note: å¤–éƒ¨ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ `getTimeOptionsHtml` ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã¨æƒ³å®š
        const startTimeOptions = getTimeOptionsHtml(classStartHour, classEndHour, 30, null);
        let endTimeOptions = getTimeOptionsHtml(classStartHour, classEndHour, 30, null);
        if (classEndMinutes > 0) {
          const finalEndTime = `${String(classEndHour).padStart(2, '0')}:${String(classEndMinutes).padStart(2, '0')}`;
          endTimeOptions += `<option value="${finalEndTime}">${finalEndTime}</option>`;
        }

        const discountRule = master.find(item => item['é …ç›®å'] === ITEM_NAME_DISCOUNT);
        let discountHtml = '';
        if (discountRule && (classroom === TSUKUBA_CLASSROOM_NAME || classroom === NUMAZU_CLASSROOM_NAME)) {
          const discountAmountText = `${Math.abs(Number(discountRule['å˜ä¾¡']))}å††`;
          const discountUnitText = discountRule['å˜ä½'];
          discountHtml = `<p class="${DesignConfig.text.caption}">${discountRule['é …ç›®å']}: ${discountRule.èª¬æ˜ || `å‚åŠ æ™‚é–“ãŒåˆå›è¬›ç¿’ã¨é‡ãªã‚‹å ´åˆã€${discountUnitText}ã‚ãŸã‚Š${discountAmountText}å‰²å¼•`}</p>`;
        }

        return `
          <div class="mt-4 pt-4 border-t">
            <h4 class="font-bold ${DesignConfig.colors.text} mb-2">äºˆç´„æ™‚é–“</h4>
            <div class="grid grid-cols-2 gap-4">
              ${Components.createSelect({ id: 'res-start-time', caption: 'é–‹å§‹äºˆå®š', options: startTimeOptions })}
              ${Components.createSelect({ id: 'res-end-time', caption: 'çµ‚äº†äºˆå®š', options: endTimeOptions })}
            </div>
            ${discountHtml}
          </div>`;
      }
      return ''; // ä¸Šè¨˜ä»¥å¤–ã®å ´åˆã¯æ™‚é–“é¸æŠãªã—
    };

    /**
     * äºˆç´„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
     */
    const _renderBookingOptionsSection = () => {
      let optionsHtml = '';
      if (classroom === TOKYO_CLASSROOM_NAME) {
        optionsHtml += `<label class="flex items-center space-x-2"><input type="checkbox" id="option-first-lecture"><span>åˆå›è¬›ç¿’</span></label>`;
        optionsHtml += `<label class="flex items-center space-x-2 mt-2"><input type="checkbox" id="option-hayade"><span>æ—©å‡º<span class="text-sm ${DesignConfig.colors.textSubtle}">ï¼ˆåˆå›è¬›ç¿’ã®æ™‚é–“ã«åŠè‡ªç¿’çš„ã«å‚åŠ ã§ãã¾ã™ï¼‰</span></span></label>`;
      }
      optionsHtml += `<div class="mt-2"><label class="flex items-center space-x-2"><input type="checkbox" id="option-rental"><span>å½«åˆ»åˆ€ãƒ¬ãƒ³ã‚¿ãƒ«</span></label></div>`;

      return `
        <div class="mt-4 pt-4 border-t">
          <h4 class="font-bold text-left mb-2">ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h4>
          ${optionsHtml}
        </div>`;
    };

    /**
     * è©³ç´°å…¥åŠ›æ¬„ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
     */
    const _renderDetailsInputSection = () => {
      const firstTimeGuidance = `
        <p class="${DesignConfig.text.caption}">- æ•™å®¤ã‚µã‚¤ãƒˆã®ä½œä¾‹ãªã©ã¯ä½œã‚Šã‚„ã™ã„ã§ã™ï¼ˆç‰¹ã«ã€Œã ã‚‹ã¾ã€ãªã©ï¼‰</p>
        <p class="${DesignConfig.text.caption}">- ä½œå“ã®ã‚µã‚¤ã‚ºã‚„é¡Œæã«ã‚ˆã‚Šã¾ã™ãŒã€**1å›ã®å‚åŠ ã§ã¯å®Œæˆã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**</p>`;

      return `
        <div class="mt-4 pt-4 border-t space-y-4">
          ${Components.createTextArea({
            id: 'wip-input',
            label: isFirstTime ? 'ä»Šå›åˆ¶ä½œã—ãŸã„ã‚‚ã®' : 'ã‚„ã‚ŠãŸã„ã“ã¨/ä½œæ¥­äºˆå®š',
            caption: isFirstTime
              ? 'ä½œã‚ŠãŸã„ã‚‚ã®ãŒã‚ã‚‹æ–¹ã¯ã”è¨˜å…¥ãã ã•ã„ã€‚ä»®ã§ã‚‚OK! * ã”è‡ªèº«ã®ä½œã‚Šé€”ä¸­ã®ä½œå“ã‚„ã€ææ–™ã®æŒã¡è¾¼ã¿ã‚‚å¯'
              : '',
            placeholder: 'ã‚ã¨ã‹ã‚‰ã§ã‚‚è¨˜å…¥ã§ãã¾ã™ã€‚å½“æ—¥ã«ç›¸è«‡ã§ã‚‚å¤§ä¸ˆå¤«ï¼',
          })}
          ${Components.createTextArea({
            id: 'material-input',
            label: 'ææ–™ã®ã‚µã‚¤ã‚ºã‚„æ¨¹ç¨®ã®å¸Œæœ›',
            caption: 'ã”å¸Œæœ›ãŒã‚ã‚Œã°ã”è¨˜å…¥ãã ã•ã„ã€‚å¤§ä½“ã§ã‚‚å¤§ä¸ˆå¤«ï¼ä½œã‚Œã‚‹å¤§ãã•ã¯ ã€è±†ç²’ã€‘ã€œã€æ‰‹ã®ã²ã‚‰ã€‘ãã‚‰ã„',
            placeholder: 'ä¾‹ï¼š30Ã—30Ã—40mmãã‚‰ã„ã€ã€Œé«˜ã•ãŒ6cmãã‚‰ã„ã€ã€ŒãŸã¾ã”ãã‚‰ã„ã€ ãªã©',
          })}
          ${isFirstTime ? firstTimeGuidance : ''}
        </div>
        <div class="mt-4 pt-4 border-t space-y-4">
          ${Components.createInput({ id: 'order-input', label: 'è³¼å…¥å¸Œæœ›', type: 'text', placeholder: 'ï¼ˆä»»æ„ï¼‰ä¾‹ï¼šå½«åˆ»åˆ€ã‚»ãƒƒãƒˆã€ãƒ†ã‚­ã‚¹ãƒˆ' })}
          ${Components.createTextArea({ id: 'message-input', label: 'ãã®ä»–ã®é€£çµ¡äº‹é …ã‚„è¦æœ›ãªã©', placeholder: '' })}
        </div>`;
    };

    // --- Main View Assembly ---
    const title = isFull ? 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡ç”³è¾¼ã¿ã®ç¢ºèª' : 'äºˆç´„è©³ç´°';
    const submitButtonText = isFull ? 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡ã§ç™»éŒ²' : 'ã“ã®å†…å®¹ã§äºˆç´„';

    return `
      <h1 class="text-xl font-bold ${DesignConfig.colors.text} mb-4">${title}</h1>
      <div class="space-y-4 text-left p-4 ${DesignConfig.cards.background} rounded-lg">
        <p><span class="font-bold w-20 inline-block">ãŠåå‰:</span> ${currentUser.displayName}ã•ã‚“</p>
        <p><span class="font-bold w-20 inline-block">æ•™å®¤:</span> ${classroom}${venueDisplay}</p>
        <p><span class="font-bold w-20 inline-block">æ—¥ä»˜:</span> ${formatDate(date)}</p>
        <p><span class="font-bold w-20 inline-block">çŠ¶æ³:</span> ${_renderStatusHtml()}</p>
        <p><span class="font-bold w-20 inline-block">é–‹è¬›æ™‚é–“:</span>${classroomRule['è¬›åº§é–‹å§‹']} - ${classroomRule['ä¼‘æ†©é–‹å§‹'] || ''}${classroomRule['ä¼‘æ†©é–‹å§‹'] ? ',â€¦,' : ''}  ${classroomRule['ä¼‘æ†©çµ‚äº†'] || ''}${classroomRule['ä¼‘æ†©çµ‚äº†'] ? ' - ' : ''}${classroomRule['è¬›åº§çµ‚äº†']}</p>
        ${_renderTimeOptionsSection()}
        ${_renderBookingOptionsSection()}
        ${_renderDetailsInputSection()}
      </div>
      <div class="mt-8 flex flex-col space-y-3">
        ${Components.createButton({ text: submitButtonText, action: 'confirmBooking', colorClass: DesignConfig.colors.primary, widthClass: DesignConfig.buttons.full })}
        ${Components.createButton({ text: 'æˆ»ã‚‹', action: 'goBackToBooking', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
      </div>`;
  };

  /**
   * å®Œäº†ç”»é¢ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @param {string} msg - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getCompleteView = msg => {
    // ä¼šè¨ˆå‡¦ç†ã‚’è¡Œã£ãŸæ•™å®¤ã®æƒ…å ±ã‚’å–å¾—
    const classroom = appState.accountingReservation?.classroom;
    let nextBookingHtml = '';

    // è©²å½“æ•™å®¤ã®æœªæ¥ã®äºˆç´„æ ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
    if (classroom && appState.slots) {
      // æ–°ã—ã„ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã‚¹ãƒ­ãƒƒãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const relevantSlots = filterFutureAvailableSlots(appState.slots, classroom);

      if (relevantSlots.length > 0) {
        // getBookingViewã¨åŒæ§˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã§äºˆç´„ã‚«ãƒ¼ãƒ‰ã®HTMLã‚’ç”Ÿæˆ
        const slotsByMonth = groupSlotsByMonth(relevantSlots);

        nextBookingHtml = `
          <div class="mt-10 pt-6 border-t border-gray-200">
              <h3 class="text-xl font-bold text-brand-text text-center mb-4">æ¬¡å›ã®äºˆç´„</h3>
              <div class="${DesignConfig.cards.container}">
              ${Object.keys(slotsByMonth)
                .sort((a, b) => a - b)
                .map(month => {
                  const monthHeader = `<h4 class="text-lg font-medium ${DesignConfig.colors.textSubtle} mt-4 mb-2 text-center">${month}æœˆ</h4>`;
                  const slotsHtml = slotsByMonth[month]
                    .map(sl => {
                      let statusText = `ç©ºã ${sl.availableSlots}`;
                      if (typeof sl.morningSlots !== 'undefined') {
                        statusText = `åˆå‰ ${sl.morningSlots} | åˆå¾Œ ${sl.afternoonSlots}`;
                      }
                      const sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.available.text}">${statusText}</span>`;
                      const venueDisplay = sl.venue ? ` ${sl.venue}` : '';
                      return Components.createButton({
                        action: 'bookSlot',
                        classroom: sl.classroom,
                        date: sl.date,
                        text: `<div class="flex justify-between items-center w-full"><span class="${DesignConfig.colors.text}">${formatDate(sl.date)}${venueDisplay}</span>${sB}</div>`,
                        colorClass: `${DesignConfig.cards.base} ${DesignConfig.cards.state.available.card}`,
                      });
                    })
                    .join('');
                  return monthHeader + slotsHtml;
                })
                .join('')}
              </div>
          </div>`;
      }
    }

    return `
    <div class="text-center py-8">
        <svg class="w-16 h-16 mx-auto text-state-available-text" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h1 class="text-2xl font-bold ${DesignConfig.colors.text} mt-4 mb-2">ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ</h1>
        <p class="${DesignConfig.colors.textSubtle} mb-6">${msg}</p>

        ${nextBookingHtml}

        <div class="max-w-xs mx-auto mt-8">
             ${Components.createButton({
               text: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸æˆ»ã‚‹',
               action: 'goToDashboard',
               colorClass: DesignConfig.colors.secondary,
               widthClass: DesignConfig.buttons.full,
             })}
        </div>
    </div>`;
  };

  /**
   * ä¼šè¨ˆç”»é¢ã®UIã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * @returns {string} HTMLæ–‡å­—åˆ—
   */
  const getAccountingView = () => {
    if (!appState.accountingMaster || !appState.accountingInitialValues)
      return '<div class="flex justify-center items-center h-full"><div class="spinner"></div></div>';
    const r = appState.accountingReservation;
    const b = appState.myBookings.find(b => b.reservationId === r.reservationId);
    const v = b.venue ? `ï¼ˆ${b.venue}ï¼‰` : '';
    const initial = appState.accountingInitialValues;
    if (b.accountingDone && b.accountingDetails) {
      try {
        const details = JSON.parse(b.accountingDetails);
        const tuitionItemsHtml = details.tuition.items
          .map(
            i =>
              `<div class="flex justify-between"><span>${i.name}</span><span>${i.price.toLocaleString()}å††</span></div>`,
          )
          .join('');
        const salesItemsHtml = details.sales.items
          .map(
            i =>
              `<div class="flex justify-between"><span>${i.name}</span><span>${i.price.toLocaleString()}å††</span></div>`,
          )
          .join('');
        return `
                <div class="text-center py-4">
                    <h1 class="text-2xl font-bold text-brand-text mt-4 mb-2">ä¼šè¨ˆæ¸ˆã¿</h1>
                    <p class="text-brand-subtle mb-6"><b>${formatDate(r.date)}</b><br>${r.classroom}${v}</p>
                </div>
                <div class="p-4 bg-ui-surface border border-ui-border rounded-lg text-left space-y-4">
                    <div><h3 class="font-bold text-brand-text border-b border-ui-border mb-1 pb-1">æˆæ¥­æ–™</h3><div class="space-y-1 text-brand-text">${tuitionItemsHtml || 'ãªã—'}</div></div>
                    <div><h3 class="font-bold text-brand-text border-b border-ui-border mb-1 pb-1">è²©å£²</h3><div class="space-y-1 text-brand-text">${salesItemsHtml || 'ãªã—'}</div></div>
                    <div class="text-right font-bold text-xl pt-2 border-t border-ui-border text-brand-text">åˆè¨ˆ: ${details.grandTotal.toLocaleString()}å††</div>
                    <div class="text-right text-base pt-2 text-brand-subtle">æ”¯æ‰•æ–¹æ³•: ${details.paymentMethod}</div>
                </div>
                <div class="mt-8 flex flex-col space-y-3">
                    ${Components.createButton({ text: 'æˆ»ã‚‹', action: 'goBackToClassroomSelect', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
                </div>`;
      } catch (e) {
        return 'ä¼šè¨ˆè©³ç´°ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      }
    }
    const master = appState.accountingMaster;
    const classroomRule = master.find(
      item => item['å¯¾è±¡æ•™å®¤'] && item['å¯¾è±¡æ•™å®¤'].includes(r.classroom) && item['ç¨®åˆ¥'] === 'æˆæ¥­æ–™',
    );
    const isTimeBased = classroomRule && classroomRule['å˜ä½'] === '30åˆ†';
    let tuitionHtml;
    if (isTimeBased) {
      tuitionHtml = getTimeBasedTuitionHtml(classroomRule, initial);
    } else {
      const tuitionItems = master.filter(
        item =>
          item['ç¨®åˆ¥'] === 'æˆæ¥­æ–™' &&
          (item['å¯¾è±¡æ•™å®¤'] === 'å…±é€š' || (item['å¯¾è±¡æ•™å®¤'] && item['å¯¾è±¡æ•™å®¤'].includes(r.classroom))),
      );
      tuitionHtml = `<div class="p-4 bg-ui-surface border border-ui-border rounded-lg"> <h3 class="text-xl font-bold mb-3 text-brand-text">æˆæ¥­æ–™</h3> <div class="space-y-3">${tuitionItems
        .map(item => {
          const isMandatory = item['é …ç›®å'] === 'æœ¬è¬›åº§';
          let isChecked = isMandatory || initial[item['é …ç›®å']] === true;
          if (item['é …ç›®å'] === 'åˆå›è¬›ç¿’' && initial.firstLecture) isChecked = true;
          if (item['é …ç›®å'] === 'æ—©å‡º' && initial.earlyArrival) isChecked = true;
          if (item['é …ç›®å'] === 'å½«åˆ»åˆ€ãƒ¬ãƒ³ã‚¿ãƒ«' && initial.chiselRental) isChecked = true;
          return `<div class="flex items-center justify-between mb-2"> <label class="flex items-center space-x-2 text-brand-text"> <input type="checkbox" name="${item['é …ç›®å']}" data-item-type="æˆæ¥­æ–™" data-item-name="${item['é …ç›®å']}" class="accounting-item h-5 w-5 rounded border-ui-border text-brand-text focus:ring-brand-text accent-action-primary-bg" ${isChecked ? 'checked' : ''} ${isMandatory ? 'disabled' : ''}> <span>${item['é …ç›®å']}</span> </label> <span class="text-brand-subtle">${item['å˜ä¾¡'].toLocaleString()}å††</span> </div>`;
        })
        .join(
          '',
        )}</div> <div id="tuition-breakdown" class="mt-4 pt-4 border-t border-ui-border space-y-1 text-base text-brand-subtle"></div> <div class="text-right font-bold mt-2 text-brand-text" id="tuition-subtotal">å°è¨ˆ: 0å††</div></div>`;
    }
    const salesItems = master.filter(item => item['ç¨®åˆ¥'] === 'ç‰©è²©');
    const salesHtml = `<div class="p-4 bg-ui-surface border border-ui-border rounded-lg"> <h3 class="text-xl font-bold mb-3 text-left text-brand-text">è²©å£²</h3> <div class="mb-3 space-y-4"><label class="block text-brand-text text-base font-bold">ææ–™ä»£</label><div id="materials-container">${getMaterialRowHtml(0, { type: initial.materialType0, l: initial.materialL0, w: initial.materialW0, h: initial.materialH0 })}</div></div> ${Components.createButton({ text: '+ ææ–™ã‚’è¿½åŠ ', action: 'addMaterialRow', colorClass: 'bg-action-secondary-bg text-action-secondary-text w-full mt-3 text-base py-2 active:bg-action-secondary-hover' })} <details class="mt-4"> <summary class="font-bold text-brand-text flex items-center"> <span class="arrow mr-2">â–¶</span> ãã®ä»–ã®è²©å£²å“ </summary> <div class="mt-2 space-y-2 pt-2 border-t border-ui-border">${salesItems.map(item => `<div class="flex items-center justify-between"> <label class="flex items-center space-x-2 text-brand-text"><input type="checkbox" name="${item['é …ç›®å']}" data-item-type="ç‰©è²©" data-item-name="${item['é …ç›®å']}" class="accounting-item accent-action-primary-bg" ${initial[item['é …ç›®å']] ? 'checked' : ''}><span>${item['é …ç›®å']}</span></label> <span class="text-brand-subtle">${item['å˜ä¾¡'].toLocaleString()}å††</span> </div>`).join('')}<div id="other-sales-container" class="mt-2 pt-2 border-t border-ui-border">${getOtherSalesRowHtml(0, { name: initial.otherSalesName0, price: initial.otherSalesPrice0 })}</div></div> ${Components.createButton({ text: '+ è‡ªç”±å…¥åŠ›æ¬„ã‚’è¿½åŠ ', action: 'addOtherSalesRow', colorClass: 'bg-action-secondary-bg text-action-secondary-text w-full mt-3 text-base py-2 active:bg-action-secondary-hover' })} </details> <div class="text-right font-bold mt-2 text-brand-text" id="sales-subtotal">å°è¨ˆ: 0å††</div></div>`;
    return `
        <div class="flex justify-between items-center">
            <h1 class="text-2xl font-bold text-brand-text">ä¼šè¨ˆ</h1>
            <button data-action="goBackToClassroomSelect" class="text-sm bg-action-secondary-bg text-action-secondary-text px-3 py-1.5 rounded-md active:bg-action-secondary-hover mobile-button">æˆ»ã‚‹</button>
        </div>
        <div class="text-center py-4">
            <p class="text-brand-subtle mb-6"><b>${formatDate(r.date)}</b><br>${r.classroom}${v}</p>
        </div>
        <form id="accounting-form" class="space-y-6">
            ${tuitionHtml}
            ${salesHtml}
            <div class="text-right text-2xl font-bold py-4 border-t-2 border-ui-border flex flex-col items-end">
                <span id="grand-total-amount" class="text-brand-text">åˆè¨ˆ: 0å††</span>
            </div>
            <div class="mt-4 text-center">
                <p class="text-base text-state-danger-text font-bold mb-2">é‡‘é¡ã‚’ã€å…ˆç”Ÿã«ç¢ºèªã—ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„</p>
                <div class="space-y-3">
                    ${Components.createButton({ text: 'å…ˆç”Ÿã®ç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸ', action: 'showAccountingConfirmation', colorClass: DesignConfig.colors.primary, widthClass: DesignConfig.buttons.full })}
                    ${Components.createButton({ text: 'æˆ»ã‚‹', action: 'goBackToClassroomSelect', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
                </div>
            </div>
        </form>`;
  };

    // ========== /13_WebApp_Views.html ==========

    // ========== 14_WebApp_Handlers.html ==========

  /**
   * =================================================================
   * ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: 14_WebApp_Handlers.html
   * ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘: 1.6
   * ã€å½¹å‰²ã€‘: WebAppã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«ãŠã‘ã‚‹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œã«å¿œã˜ãŸ
   * ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ã‚’é›†ç´„ã—ã¾ã™ã€‚
   * ã€æ§‹æˆã€‘: 14ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®ã†ã¡ã®14ç•ªç›®
   * ã€v1.6ã§ã®å¤‰æ›´ç‚¹ã€‘:
   * - FE-14: ä¼šè¨ˆå…¥åŠ›ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã‚’è¿½åŠ ã€‚
   *   - localStorageã¸ã®ä¿å­˜ã€èª­ã¿è¾¼ã¿ã€å‰Šé™¤å‡¦ç†ã‚’å®Ÿè£…ã€‚
   *   - ç”»é¢é·ç§»ã€ä¿å­˜ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’é©åˆ‡ã«æ“ä½œã™ã‚‹ã‚ˆã†ä¿®æ­£ã€‚
   * =================================================================
   */

  // =================================================================
  // --- Accounting Cache Helper Functions (FE-14) ---
  // -----------------------------------------------------------------
  // ä¼šè¨ˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤
  // =================================================================

  /**
   * ä¼šè¨ˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç¾åœ¨ã®å…¥åŠ›å†…å®¹ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦å–å¾—ã—ã¾ã™ã€‚
   * @returns {object} ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿
   */
  function getAccountingFormData() {
    const form = document.getElementById('accounting-form');
    if (!form) return {};

    const data = {};
    const elements = form.elements;

    for (let i = 0; i < elements.length; i++) {
      const item = elements[i];
      if (item.name) {
        if (item.type === 'checkbox') {
          data[item.name] = item.checked;
        } else if (item.type === 'radio') {
          if (item.checked) {
            data[item.name] = item.value;
          }
        } else {
          data[item.name] = item.value;
        }
      }
    }
    return data;
  }

  /**
   * ä¼šè¨ˆç”»é¢ã®å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
   * @param {string} reservationId - äºˆç´„ID
   */
  function setupAccountingFormListeners(reservationId) {
    const form = document.getElementById('accounting-form');
    if (!form) return;

    form.addEventListener('input', () => {
      const accountingData = getAccountingFormData();
      saveAccountingCache(reservationId, accountingData);
    });
  }

  // =================================================================
  // --- Action Handlers ---
  // -----------------------------------------------------------------
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œï¼ˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãªã©ï¼‰ã‚’èµ·ç‚¹ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹
  // å…¨ã¦ã®å‡¦ç†ã‚’å®šç¾©ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚
  // å„ã‚­ãƒ¼ãŒ data-action å±æ€§ã«å¯¾å¿œã—ã¾ã™ã€‚
  // =================================================================
  window.actionHandlers = {
    /** ãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯æ–°è¦ç™»éŒ²ã‚’é–‹å§‹ã—ã¾ã™ */
    login: () => {
      const p = document.getElementById('phone').value;
      // å…¥åŠ›å€¤ã‚’appStateã«ä¿å­˜
      appState.loginPhone = p;
      if (!p) return showInfo('é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      const n = p.replace(/[â€ï¼-]/g, '').replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 65248));
      showLoading('login');

      // ç’°å¢ƒåˆ†å²: ãƒ†ã‚¹ãƒˆç’°å¢ƒã®å ´åˆã¯ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
      if (isTestEnvironment) {
        console.log('ğŸ§ª Using mock login data');
        setTimeout(() => {
          hideLoading();
          setState({
            currentUser: getEnvironmentData('currentUser', { displayName: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼', phone: n }),
            slots: getEnvironmentData('slots', []),
            myBookings: getEnvironmentData('myBookings', []),
            accountingMaster: getEnvironmentData('accountingMaster', {}),
            history: getEnvironmentData('history', []),
            historyTotal: getEnvironmentData('history', []).length,
            recordsToShow: 20,
            view: 'dashboard', // ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç›´æ¥é·ç§»
          });
        }, 300);
        return;
      }

      // æœ¬ç•ªç’°å¢ƒ: å®Ÿéš›ã®GASé–¢æ•°ã‚’å‘¼ã³å‡ºã—
      google.script.run
        .withSuccessHandler(r => {
          hideLoading();
          if (r.success) {
            // NF-04.2: åˆå›äºˆç´„åˆ¤å®š
            const isFirstTime =
              (!r.initialData.myBookings || r.initialData.myBookings.length === 0) &&
              (!r.initialData.myHistory || r.initialData.myHistory.length === 0);
            setState({
              currentUser: r.user,
              slots: r.initialData.availableSlots,
              myBookings: r.initialData.myBookings,
              accountingMaster: r.initialData.accountingMaster,
              history: r.initialData.myHistory,
              historyTotal: r.initialData.myHistory.length,
              recordsToShow: 20,
              isFirstTimeBooking: isFirstTime,
              view: 'classroomSelect',
            });
          } else if (r.commandRecognized) {
            setState({
              view: 'noPhoneUserSelect',
              noPhoneUsers: [],
              selectedNoPhoneUser: null,
              searchAttempted: false,
            });
          } else {
            // èªè¨¼å¤±æ•—æ™‚
            if (r.phoneForRegistration) {
              // æ–°è¦ç™»éŒ²ç”»é¢ã«é·ç§»ã™ã‚‹éš›ã€æœ€æ–°ã®é›»è©±ç•ªå·ã‚’registrationData.phoneã«ã‚»ãƒƒãƒˆ
              appState.registrationData = {
                ...appState.registrationData,
                phone: r.phoneForRegistration || appState.loginPhone || n,
              };
              setState({ view: 'register', phoneForRegistration: n });
            } else {
              showInfo(
                r.message || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é›»è©±ç•ªå·ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„ã‹ã€å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚',
                'ã‚¨ãƒ©ãƒ¼',
              );
            }
          }
        })
        .withFailureHandler(handleServerError)
        .authenticateUser(n);
    },

    /** æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼šStep1ã‹ã‚‰Step2ã¸ */
    goToStep2: () => {
      const realName = document.getElementById('reg-realname').value;
      const nickname = document.getElementById('reg-nickname').value.trim();
      const phone = document.getElementById('reg-phone').value;
      // å…¥åŠ›å€¤ã‚’appState.registrationDataã«ä¿å­˜
      appState.registrationData = {
        ...appState.registrationData,
        phone,
        realName,
        nickname: nickname || realName,
      };
      if (!realName) return showInfo('ãŠåå‰ï¼ˆæœ¬åï¼‰ã¯å¿…é ˆã§ã™ã€‚');
      setState({
        registrationData: { ...appState.registrationData },
        registrationStep: 2,
        view: 'registrationStep2',
      });
    },

    /** æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼šStep2ã‹ã‚‰Step1ã¸æˆ»ã‚‹ */
    backToStep1: () => setState({ view: 'register', registrationStep: 1 }),
    // Step2ã‹ã‚‰Step1ã¸æˆ»ã‚‹æ™‚ã‚‚å…¥åŠ›å€¤ã‚’ä¿å­˜
    backToStep1: () => {
      const realName = document.getElementById('reg-realname')?.value;
      const nickname = document.getElementById('reg-nickname')?.value;
      const phone = document.getElementById('reg-phone')?.value;
      if (realName || nickname || phone) {
        appState.registrationData = {
          ...appState.registrationData,
          realName: realName || appState.registrationData?.realName || '',
          nickname: nickname || appState.registrationData?.nickname || '',
          phone: phone || appState.registrationData?.phone || '',
        };
      }
      setState({ view: 'register', registrationStep: 1 });
    },

    /** æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼šStep2ã‹ã‚‰Step3ã¸é€²ã‚€ */
    goToStep3: () => {
      const email = document.getElementById('q-email').value;
      if (!email || !email.includes('@')) {
        return showInfo('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      }

      const step2Data = {
        email: email,
        wantsEmail: document.getElementById('q-wants-email').checked,
        ageGroup: document.getElementById('q-age-group').value,
        gender: document.querySelector('input[name="gender"]:checked')?.value || '',
        dominantHand: document.querySelector('input[name="dominantHand"]:checked')?.value || '',
        address: document.getElementById('q-address').value,
      };

      setState({
        registrationData: { ...appState.registrationData, ...step2Data },
        registrationStep: 3,
        view: 'registrationStep3',
      });
    },

    /** æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼šStep3ã‹ã‚‰Step2ã¸æˆ»ã‚‹ */
    backToStep2: () => setState({ view: 'registrationStep2', registrationStep: 2 }),

    /** æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼šæœ€çµ‚ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ */
    submitRegistration: () => {
      const step3Data = {
        experience: document.querySelector('input[name="experience"]:checked')?.value || '',
        pastWork: document.getElementById('q-past-work').value,
        futureGoal: document.getElementById('q-future-goal').value,
      };

      const finalUserData = { ...appState.registrationData, ...step3Data };

      showLoading('login');
      google.script.run
        .withSuccessHandler(res => {
          hideLoading();
          if (res.success) {
            setState({
              currentUser: res.user,
              slots: res.initialData.availableSlots,
              myBookings: res.initialData.myBookings,
              accountingMaster: res.initialData.accountingMaster,
              history: res.initialData.myHistory,
              view: 'newBooking',
            });
          } else {
            showInfo(res.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(handleServerError)
        .registerNewUser(finalUserData);
    },

    /** ãã‚ãã‚«ãƒ¼ãƒ‰ã®ç·¨é›†ãƒœã‚¿ãƒ³ */
    editHistoryMemo: d => {
      const item = appState.history.find(h => h.reservationId === d.reservationId);
      if (!item) return;

      const originalMemo = item.workInProgress;

      showConfirm({
        title: 'åˆ¶ä½œãƒ¡ãƒ¢ã®ç·¨é›†',
        message: getMemoEditModalHtml(item),
        confirmText: 'ä¿å­˜ã™ã‚‹',
        cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
        confirmColorClass: DesignConfig.colors.primary,
        onConfirm: () => {
          const newMemo = document.getElementById('memo-edit-textarea').value;

          // æ¥½è¦³çš„UI: ã¾ãšãƒ•ãƒ­ãƒ³ãƒˆã®è¡¨ç¤ºã‚’æ›´æ–°
          item.workInProgress = newMemo;
          setState({ history: [...appState.history] });

          showLoading();

          // ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã—ã€æœ€æ–°ã®å±¥æ­´ã‚’å–å¾—
          google.script.run
            .withSuccessHandler(result => {
              hideLoading();
              if (result.success) {
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã§çŠ¶æ…‹ã‚’æ›´æ–°
                setState({
                  history: result.history || appState.history,
                  historyTotal: result.total || appState.historyTotal,
                });
                showInfo('åˆ¶ä½œãƒ¡ãƒ¢ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚', 'ä¿å­˜å®Œäº†');
              } else {
                // ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å…ƒã«æˆ»ã™
                item.workInProgress = originalMemo;
                setState({ history: [...appState.history] });
                showInfo(result.message || 'ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'ã‚¨ãƒ©ãƒ¼');
              }
            })
            .withFailureHandler(err => {
              hideLoading();
              // é€šä¿¡ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å…ƒã«æˆ»ã™
              item.workInProgress = originalMemo;
              setState({ history: [...appState.history] });
              handleServerError(err);
            })
            .updateMemo(d.reservationId, d.sheetName, newMemo, appState.currentUser.studentId);
        },
      });
    },

    /** ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã™ */
    saveProfile: () => {
      const r = document.getElementById('edit-realname').value;
      let n = document.getElementById('edit-nickname').value.trim();
      if (!r) return showInfo('ãŠåå‰ï¼ˆæœ¬åï¼‰ã¯å¿…é ˆã§ã™ã€‚');
      if (!n) n = r;

      // NF-01: é›»è©±ç•ªå·å…¥åŠ›æ¬„ãŒã‚ã‚Œã°ãã®å€¤ã‚‚å–å¾—
      const phoneInput = document.getElementById('edit-phone');
      const phone = phoneInput ? phoneInput.value : appState.currentUser.phone; // é›»è©±ç•ªå·å…¥åŠ›æ¬„ãŒãªã‘ã‚Œã°æ—¢å­˜ã®é›»è©±ç•ªå·ã‚’ä½¿ç”¨

      const u = { ...appState.currentUser, realName: r, displayName: n, phone: phone }; // é›»è©±ç•ªå·ã‚‚è¿½åŠ 
      showLoading();
      google.script.run
        .withSuccessHandler(res => {
          hideLoading();
          if (res.success) {
            // â˜…â˜…â˜… å¤‰æ›´ç‚¹ â˜…â˜…â˜…
            // æˆ»ã‚Šå€¤ã®æ›´æ–°ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã§ãƒ­ãƒ¼ã‚«ãƒ«ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã€
            // è¿½åŠ é€šä¿¡ãªã—ã§ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«é·ç§»ã™ã‚‹
            showInfo('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'æ›´æ–°å®Œäº†');
            setState({ currentUser: res.updatedUser, view: 'classroomSelect' });
          } else {
            showInfo(res.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(handleServerError)
        .updateUserProfile(u);
    },

    /**
     * NF-01: é›»è©±ç•ªå·æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
     */
    searchNoPhoneUser: () => {
      const searchInput = document.getElementById('nickname-search-input');
      const searchTerm = searchInput ? searchInput.value.trim() : ''; // æ¤œç´¢èªã‚’searchTermã«å¤‰æ›´

      if (!searchTerm) {
        return showInfo('ãŠåå‰ï¼ˆæœ¬åï¼‰ã¾ãŸã¯ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      }

      showLoading('login');

      // æ¤œç´¢èªã‹ã‚‰ã‚¹ãƒšãƒ¼ã‚¹ã‚’é™¤å»ã—ã¦å°æ–‡å­—åŒ–ã—ã¦æ¯”è¼ƒã«ä½¿ã†
      const normalizedSearchTerm = searchTerm.replace(/\s+/g, '').toLowerCase();

      google.script.run
        .withSuccessHandler(users => {
          hideLoading();
          // searchName (ã‚¹ãƒšãƒ¼ã‚¹é™¤å»æ¸ˆã¿ãƒ»å°æ–‡å­—åŒ–ã•ã‚ŒãŸçµåˆå) ã‚’ä½¿ã£ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
          const filteredUsers = users.filter(user => user.searchName && user.searchName.includes(normalizedSearchTerm));

          // NF-01: æ¤œç´¢ãŒè©¦è¡Œã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
          setState({ noPhoneUsers: filteredUsers, searchAttempted: true });

          if (filteredUsers.length === 0) {
            // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒ“ãƒ¥ãƒ¼å´ã§è¡¨ç¤º
          }
        })
        .withFailureHandler(handleServerError)
        .searchNoPhoneUsersByFilterForWebApp();
    },

    /**
     * NF-01: æ¤œç´¢çµæœã‹ã‚‰é›»è©±ç•ªå·æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¾ã™ã€‚
     */
    selectNoPhoneUser: d => {
      // ãƒœã‚¿ãƒ³ã«åŸ‹ã‚è¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€ã¾ãšä»®ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä½œæˆ
      const tempUser = {
        studentId: d.studentId,
        realName: d.realName, // ãƒœã‚¿ãƒ³ã®dataå±æ€§ã‹ã‚‰å–å¾—
        displayName: d.nickname, // ãƒœã‚¿ãƒ³ã®dataå±æ€§ã‹ã‚‰å–å¾—
        phone: '', // é›»è©±ç•ªå·ã¯ã¾ã ãªã„ã®ã§ç©º
      };

      showLoading('login');

      // studentIdã‚’ä½¿ã£ã¦ã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰äºˆç´„æƒ…å ±ã‚„å±¥æ­´ãªã©ã®å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(initialData => {
          console.log('[APP] Received initialData:', initialData);
          console.log('[APP] availableSlots check:', initialData.availableSlots);
          hideLoading();
          if (initialData.success) {
            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã¨ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã®åå‰æƒ…å ±ã‚’çµ„ã¿åˆã‚ã›ã¦å®Œå…¨ãªçŠ¶æ…‹ã‚’æ§‹ç¯‰
            setState({
              currentUser: tempUser, // åå‰æƒ…å ±ã‚’å«ã‚€ä»®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
              slots: initialData.availableSlots,
              myBookings: initialData.myBookings,
              accountingMaster: initialData.accountingMaster,
              history: initialData.myHistory,
              historyTotal: initialData.myHistory.length,
              recordsToShow: 20,
              view: 'editProfile', // é›»è©±ç•ªå·ç™»éŒ²ã‚’ä¿ƒã™ãŸã‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ç”»é¢ã¸
            });
          } else {
            showInfo('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(handleServerError)
        .getInitialWebApp_Data(tempUser.studentId);
    },

    /**
     * NF-01: è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã«æ–°è¦ç™»éŒ²ç”»é¢ã¸é·ç§»ã—ã¾ã™ã€‚
     */
    goToRegisterFromNoPhoneSearch: () => {
      // æ–°è¦ç™»éŒ²ç”»é¢ã¸é·ç§»ã€‚é›»è©±ç•ªå·ã¯æœªå…¥åŠ›ã®ã¾ã¾ã€‚
      setState({ view: 'register', phoneForRegistration: '' });
    },

    /** äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ */
    cancel: d => {
      const message = `
        <div class="text-left space-y-4">
          <p class="text-center"><b>${formatDate(d.date)}</b><br>${d.classroom}<br>ã“ã®äºˆç´„ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ</p>
          <div class="pt-4 border-t">
            <label class="block text-sm font-bold mb-2">å…ˆç”Ÿã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="cancel-message" class="w-full p-2 border border-ui-border rounded" rows="3" placeholder=""></textarea>
          </div>
        </div>
      `;
      showConfirm({
        title: 'äºˆç´„ã®å–ã‚Šæ¶ˆã—',
        message: message,
        confirmText: 'ã¯ã„<br>å–ã‚Šæ¶ˆã—ã¾ã™',
        cancelText: 'ã„ã„ãˆ',
        confirmColorClass: DesignConfig.colors.danger,
        onConfirm: () => {
          showLoading('cancel');
          const cancelMessage = document.getElementById('cancel-message')?.value || '';
          const p = {
            ...d,
            studentId: appState.currentUser.studentId,
            cancelMessage: cancelMessage,
          };
          google.script.run
            .withSuccessHandler(r => {
              hideLoading();
              if (r.success) {
                // ã€NF-12ã€‘ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸæœ€æ–°ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§çŠ¶æ…‹ã‚’æ›´æ–°
                setState({ myBookings: r.newBookingsCache });
                showInfo('äºˆç´„ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚', 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†');
              } else {
                showInfo(r.message || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
              }
            })
            .withFailureHandler(err => {
              // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç”»é¢ã‚’æ›´æ–°ã›ãšã€å…ƒã®çŠ¶æ…‹ã‚’ç¶­æŒ
              handleServerError(err);
            })
            .cancelReservationAndGetLatestData(p);
        },
      });
    },

    /** äºˆç´„ã‚’ç¢ºå®šã—ã¾ã™ */
    confirmBooking: () => {
      const bookingOptions = {
        earlyArrival: document.getElementById('option-hayade')?.checked || false,
        chiselRental: document.getElementById('option-rental')?.checked || false,
        firstLecture: document.getElementById('option-first-lecture')?.checked || false,
        startTime: document.getElementById('res-start-time')?.value || '',
        endTime: document.getElementById('res-end-time')?.value || '',
        workInProgress: document.getElementById('wip-input')?.value || '',
        order: document.getElementById('order-input')?.value || '',
        messageToTeacher: document.getElementById('message-input')?.value || '',
        materialInfo: document.getElementById('material-input')?.value || '',
      };
      // åˆå›äºˆç´„æ™‚
      if (appState.isFirstTimeBooking) {
        bookingOptions.isNewUser = true;
      }
      showLoading('booking');
      const p = { ...appState.selectedSlot, user: appState.currentUser, options: bookingOptions };

      google.script.run
        .withSuccessHandler(r => {
          hideLoading();
          if (r.success) {
            // ã€NF-12ã€‘ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸæœ€æ–°ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§çŠ¶æ…‹ã‚’æ›´æ–°
            setState({
              view: 'complete',
              completionMessage: r.message,
              myBookings: r.newBookingsCache,
              // accountingReservationã¯ã‚»ãƒƒãƒˆã—ãªã„
            });
          } else {
            showInfo(r.message || 'äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(handleServerError)
        .makeReservationAndGetLatestData(p);
    },

    /** äºˆç´„ç·¨é›†ç”»é¢ã«é·ç§»ã—ã¾ã™ */
    goToEditReservation: d => {
      showLoading();
      google.script.run
        .withSuccessHandler(r => {
          hideLoading();
          if (r.success) {
            setState({ view: 'editReservation', editingReservationDetails: r.details });
          } else {
            showInfo(r.message || 'äºˆç´„è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(handleServerError)
        .getReservationDetailsForEdit(d.reservationId, d.classroom);
    },

    /** äºˆç´„æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã™ */
    updateReservation: () => {
      const d = appState.editingReservationDetails;
      const p = {
        reservationId: d.reservationId,
        classroom: d.classroom,
        studentId: appState.currentUser.studentId,
        earlyArrival: document.getElementById('edit-option-hayade')?.checked || false,
        chiselRental: document.getElementById('edit-option-rental')?.checked || false,
        startTime: document.getElementById('edit-start-time')?.value || '',
        endTime: document.getElementById('edit-end-time')?.value || '',
        workInProgress: document.getElementById('edit-wip-input').value,
        order: document.getElementById('edit-order-input').value,
        messageToTeacher: document.getElementById('edit-message-input').value,
      };

      showLoading('booking');
      google.script.run
        .withSuccessHandler(r => {
          hideLoading();
          if (r.success) {
            // ã€NF-12ã€‘ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸæœ€æ–°ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§çŠ¶æ…‹ã‚’æ›´æ–°
            setState({ view: 'classroomSelect', myBookings: r.newBookingsCache });
            showInfo('äºˆç´„å†…å®¹ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚', 'æ›´æ–°å®Œäº†');
          } else {
            showInfo(r.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(handleServerError)
        .updateReservationDetailsAndGetLatestData(p);
    },

    /** ä¼šè¨ˆç”»é¢ã«é·ç§»ã—ã¾ã™ */
    goToAccounting: d => {
      showLoading('accounting');
      google.script.run
        .withSuccessHandler(res => {
          hideLoading();
          if (res.success) {
            const reservationId = d.reservationId;
            const cachedData = loadAccountingCache(reservationId);

            // ã‚µãƒ¼ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸ (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å„ªå…ˆ)
            const initialValues = { ...res.details, ...cachedData };

            setState({
              view: 'accounting',
              accountingReservation: d,
              accountingInitialValues: initialValues,
            });
          } else {
            showInfo(res.message || 'äºˆç´„è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(handleServerError)
        .getReservationDetails(d);
    },

    /** å±¥æ­´ã‹ã‚‰ä¼šè¨ˆè©³ç´°ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤ºã—ã¾ã™ */
    showHistoryAccounting: d => {
      const details = JSON.parse(d.details);
      const tuitionItemsHtml = details.tuition.items
        .map(i => `<li>${i.name}: ${i.price.toLocaleString()}å††</li>`)
        .join('');
      const salesItemsHtml = details.sales.items.map(i => `<li>${i.name}: ${i.price.toLocaleString()}å††</li>`).join('');
      const message = `
            <div class="p-4 bg-brand-light rounded-lg text-left space-y-4 text-base">
                ${tuitionItemsHtml ? `<b>æˆæ¥­æ–™</b><ul class="list-disc list-inside">${tuitionItemsHtml}</ul>` : ''}
                ${salesItemsHtml ? `<b class="mt-1 inline-block">è²©å£²</b><ul class="list-disc list-inside">${salesItemsHtml}</ul>` : ''}
                <div class="font-bold mt-1 pt-1 border-t">åˆè¨ˆ: ${details.grandTotal.toLocaleString()}å††</div><div class="text-right text-sm pt-1">æ”¯æ‰•æ–¹æ³•: ${details.paymentMethod}</div></div>`;
      showInfo(message, 'ä¼šè¨ˆè¨˜éŒ²');
    },

    /** ä¼šè¨ˆç”»é¢ã§ææ–™å…¥åŠ›è¡Œã‚’è¿½åŠ ã—ã¾ã™ */
    addMaterialRow: () => {
      const container = document.getElementById('materials-container');
      const newIndex = container.querySelectorAll('div[data-material-row-index]').length;
      const newRow = document.createElement('div');
      newRow.className = 'mt-4 pt-4 border-t border-ui-border-light';
      newRow.dataset.materialRowIndex = newIndex;
      newRow.innerHTML = getMaterialRowHtml(newIndex);
      container.appendChild(newRow);
    },

    /** ä¼šè¨ˆç”»é¢ã§ãã®ä»–è²©å£²å“å…¥åŠ›è¡Œã‚’è¿½åŠ ã—ã¾ã™ */
    addOtherSalesRow: () => {
      const container = document.getElementById('other-sales-container');
      const newIndex = container.querySelectorAll('div[data-other-sales-row]').length;
      // getOtherSalesRowHtmlãŒè¿”ã™HTMLæ–‡å­—åˆ—ã‚’ã€ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ä»‹ã•ãšç›´æ¥ã‚³ãƒ³ãƒ†ãƒŠã®æœ«å°¾ã«è¿½åŠ ã™ã‚‹
      container.insertAdjacentHTML('beforeend', getOtherSalesRowHtml(newIndex));
    },

    /** ä¼šè¨ˆç”»é¢ã§åˆè¨ˆé‡‘é¡ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ */
    copyGrandTotal: button => {
      const totalText = document.getElementById('grand-total-amount')?.textContent || '';
      const numericTotal = totalText.replace(/[^0-9-]/g, '');
      actionHandlers.copyToClipboard(button, numericTotal);
    },

    /** æŒ‡å®šã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ */
    copyToClipboard: (button, text) => {
      const textToCopy = text || button.dataset.copyText;
      const textArea = document.createElement('textarea');
      textArea.style.position = 'fixed';
      textArea.style.top = '-9999px';
      textArea.style.left = '-9999px';
      textArea.value = textToCopy.replace(/,/g, '');
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          const originalText = button.textContent;
          button.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ!';
          setTimeout(() => {
            button.textContent = originalText;
          }, 2000);
        } else {
          showInfo('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      } catch (err) {
        showInfo('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯é–‹ç™ºç’°å¢ƒã§ã®ã¿å‡ºåŠ›
        if (typeof console !== 'undefined' && console.error) {
          console.error('Clipboard copy failed:', err);
        }
      }
      document.body.removeChild(textArea);
    },

    // ã€LEGACY REMOVEDã€‘å¤ã„å€‹åˆ¥å±¥æ­´ãƒšãƒ¼ã‚¸é–¢æ•°ã‚’å‰Šé™¤
    // goToHistory, forceGoToHistory ã¯çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç§»è¡Œæ¸ˆã¿

    /** å‚åŠ è¨˜éŒ²ã‚’è¿½åŠ ã§èª­ã¿è¾¼ã¿ã¾ã™ï¼ˆçµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ï¼‰ */
    loadMoreHistory: () => {
      const newCount = (appState.recordsToShow || 20) + 20;
      setState({ recordsToShow: newCount });
    },

    /** æ–°è¦äºˆç´„ã®ãŸã‚ã®æ•™å®¤é¸æŠç”»é¢ã«é·ç§»ã—ã¾ã™ */
    goToNewBookingView: () => setState({ view: 'newBooking' }),

    /** ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ç”»é¢ã«é·ç§»ã—ã¾ã™ */
    goToEditProfile: () => setState({ view: 'editProfile' }),

    /** æ•™å®¤ã‚’é¸æŠã—ã€äºˆç´„æ ä¸€è¦§ç”»é¢ã«é·ç§»ã—ã¾ã™ */
    selectClassroom: d => setState({ selectedClassroom: d.classroomName, view: 'booking' }),

    /** äºˆç´„æ ã‚’é¸æŠã—ã€äºˆç´„ç¢ºèªç”»é¢ã«é·ç§»ã—ã¾ã™ */
    bookSlot: d => {
      const foundSlot = appState.slots.find(s => s.classroom === d.classroom && s.date === d.date);
      if (foundSlot) {
        // ç©ºå¸­æ•°ã«åŸºã¥ã„ã¦isFullçŠ¶æ…‹ã‚’ç¢ºå®Ÿã«è¨­å®š
        const isFullSlot =
          foundSlot.isFull ||
          foundSlot.availableSlots === 0 ||
          (typeof foundSlot.morningSlots !== 'undefined' &&
            foundSlot.morningSlots === 0 &&
            foundSlot.afternoonSlots === 0);
        setState({
          selectedSlot: {
            ...foundSlot,
            isFull: isFullSlot,
          },
          view: 'confirm',
        });
      } else {
        showInfo('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚é¸æŠã—ãŸäºˆç´„æ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
      }
    },

    /** ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚Šã¾ã™ */
    goBackToLogin: () => setState({ view: 'login' }),
    // ã€Œæˆ»ã‚‹ã€æ™‚ã‚‚é›»è©±ç•ªå·å…¥åŠ›å€¤ã‚’ä¿å­˜
    goBackToLogin: () => {
      const phoneInput = document.getElementById('phone');
      if (phoneInput) appState.loginPhone = phoneInput.value;
      setState({ view: 'login' });
    },

    /** ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰ã«æˆ»ã‚Šã¾ã™ */
    goBackToClassroomSelect: () => setState({ view: 'classroomSelect' }),

    /** ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰ã«æˆ»ã‚Šã¾ã™ï¼ˆåˆ¥åï¼‰ */
    goToDashboard: () => setState({ view: 'classroomSelect' }),

    /** äºˆç´„æ ä¸€è¦§ç”»é¢ã«æˆ»ã‚Šã¾ã™ */
    goBackToBooking: () => {
      if (appState.view === 'accounting') {
        showConfirm({
          title: 'ç¢ºèª',
          message: 'ä¼šè¨ˆå…¥åŠ›ã‚’ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ<br>ï¼ˆå…¥åŠ›å†…å®¹ã¯ã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™ï¼‰',
          confirmText: 'ã¯ã„',
          cancelText: 'ã„ã„ãˆ',
          confirmColorClass: DesignConfig.colors.danger,
          onConfirm: () => {
            clearAccountingCache(appState.accountingReservation.reservationId);
            setState({
              view: 'booking',
              selectedClassroom:
                appState.selectedSlot?.classroom ||
                appState.accountingReservation?.classroom ||
                appState.editingReservationDetails?.classroom,
            });
          },
        });
      } else {
        setState({
          view: 'booking',
          selectedClassroom:
            appState.selectedSlot?.classroom ||
            appState.accountingReservation?.classroom ||
            appState.editingReservationDetails?.classroom,
        });
      }
    },

    /** ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆæ•™å®¤é¸æŠç”»é¢ï¼‰ã«æˆ»ã‚Šã¾ã™ */
    goToDashboard: () => setState({ view: 'classroomSelect' }),

    /** ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ç¢ºèªãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†ã§ã™ */
    modalConfirm: () => {
      if (onConfirmCallback) onConfirmCallback();
      hideModal();
    },

    /** ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†ã§ã™ */
    modalCancel: () => hideModal(),

    /** ã€Œæ¬¡ã®äºˆç´„ã‚’ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã®å‡¦ç†ï¼ˆäºˆç´„ä¸€è¦§ç”»é¢ã¸é·ç§»ï¼‰ */
    goToBooking: d => {
      // data-classroomå±æ€§ã‹ã‚‰æ•™å®¤åã‚’å–å¾—
      const classroom = d.classroom || appState.accountingReservation?.classroom;
      if (classroom) {
        setState({ selectedClassroom: classroom, view: 'booking' });
      } else {
        showInfo('æ•™å®¤åãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
      }
    },
  };

  /**
   * ä¼šè¨ˆã®ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
   */
  actionHandlers.showAccountingConfirmation = () => {
    const accountingDetails = calculateAccountingDetails();
    if (!accountingDetails || accountingDetails.grandTotal <= 0) {
      showInfo('åˆè¨ˆé‡‘é¡ãŒ0å††ã§ã™ã€‚é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    const message = `
        <div class="p-4 bg-brand-light rounded-lg text-left space-y-4 text-base" id="modal-accounting-form">
            <div>
                <span class="font-bold">åˆè¨ˆé‡‘é¡:</span> ${accountingDetails.grandTotal.toLocaleString()}å††
                <button data-action="copyGrandTotal" class="ml-2 text-sm bg-action-secondary-bg active:bg-action-secondary-hover text-action-secondary-text font-bold px-2 py-1 rounded">ã‚³ãƒ”ãƒ¼</button>
            </div>
            <div>
                <span class="font-bold">æ”¯æ‰•ã„æ–¹æ³•:</span>
                <div class="mt-2 space-y-3">
                    ${getPaymentOptionsHtml()}
                </div>
            </div>
            <div class="mt-4">
                <button id="confirm-payment-button" data-action="confirmAndPay" class="w-full bg-action-primary-bg text-action-primary-text font-bold py-2 rounded disabled:bg-brand-muted" disabled>ã“ã®å†…å®¹ã§æ”¯æ‰•ã„ã¾ã—ãŸ</button>
            </div>
            <p class="text-red-700 font-bold mt-2 text-center">å¿…ãšãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­</p>
        </div>
    `;
    showModal({
      title: 'ãŠä¼šè¨ˆ',
      message: message,
      showCancel: true,
      cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
      onConfirm: null,
    });
  };

  /**
   * ã€Œã“ã®å†…å®¹ã§æ”¯æ‰•ã„ã¾ã—ãŸã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
   */
  actionHandlers.confirmAndPay = () => {
    const reservationId = appState.accountingReservation.reservationId;
    // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®æ”¯æ‰•ã„æ–¹æ³•ã‚’å–å¾—
    const modalForm = document.getElementById('modal-accounting-form');
    let paymentMethod = 'ç¾é‡‘';
    if (modalForm) {
      const selected = modalForm.querySelector('input[name="payment-method"]:checked');
      if (selected) paymentMethod = selected.value;
    }

    // --- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«é€ä¿¡ã™ã‚‹ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ ---
    const form = document.getElementById('accounting-form');
    const userInput = {
      paymentMethod: paymentMethod,
      tuitionItems: [],
      salesItems: [],
      timeBased: null,
    };

    // æˆæ¥­æ–™é …ç›®ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰
    form.querySelectorAll('input[type="checkbox"][data-item-type="æˆæ¥­æ–™"]:checked').forEach(cb => {
      userInput.tuitionItems.push(cb.dataset.itemName);
    });

    // æ™‚é–“åˆ¶æˆæ¥­æ–™
    if (document.getElementById('start-time')) {
      userInput.timeBased = {
        startTime: document.getElementById('start-time').value,
        endTime: document.getElementById('end-time').value,
        breakMinutes: parseInt(document.getElementById('break-time')?.value || 0, 10),
        discountMinutes: parseInt(document.getElementById('discount-selector')?.value || 0, 10),
      };
    }

    // ç‰©è²©ãƒ»ææ–™è²»é …ç›®
    const materialContainer = document.getElementById('materials-container');
    if (materialContainer) {
      materialContainer.querySelectorAll('div[data-material-row-index]').forEach((row, index) => {
        const name = document.getElementById(`material-type-${index}`)?.value;
        const priceText = document.getElementById(`material-price-${index}`)?.textContent || '0';
        const price = parseInt(priceText.replace(/[^0-9]/g, ''), 10);
        if (name && price > 0) userInput.salesItems.push({ name: name, price: price });
      });
    }

    // ç‰©è²©é …ç›®ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰
    form.querySelectorAll('input[type="checkbox"][data-item-type="ç‰©è²©"]:checked').forEach(cb => {
      userInput.salesItems.push({ name: cb.dataset.itemName });
    });

    form.querySelectorAll('div[data-other-sales-row]').forEach((row, index) => {
      const name = document.getElementById(`other-sales-name-${index}`)?.value.trim();
      const price = document.getElementById(`other-sales-price-${index}`)?.value;
      if (name && price) userInput.salesItems.push({ name: name, price: Number(price) });
    });
    // --- ã“ã“ã¾ã§ ---

    const payload = {
      reservationId: appState.accountingReservation.reservationId,
      classroom: appState.accountingReservation.classroom,
      studentId: appState.currentUser.studentId,
      userInput: userInput,
    };

    showLoading('accounting');
    google.script.run
      .withSuccessHandler(r => {
        if (r.success) {
          clearAccountingCache(reservationId); // <-- ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤
          hideModal(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
          hideLoading();
          setState({
            view: 'complete',
            completionMessage: 'ä¼šè¨ˆæƒ…å ±ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚',
            myBookings: r.newBookingsCache,
            history: r.newHistory,
            historyTotal: r.newHistoryTotal,
            slots: r.updatedSlots, // <--- ã“ã‚Œã‚’è¿½åŠ 
            accountingReservation: appState.accountingReservation,
          });
        } else {
          hideLoading();
          showInfo(r.message || 'ä¼šè¨ˆæƒ…å ±ã®è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      })
      .withFailureHandler(handleServerError)
      .saveAccountingDetails(payload);
  };

  // =================================================================
  // --- Main Application Logic ---
  // -----------------------------------------------------------------
  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã€ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã€çŠ¶æ…‹ç®¡ç†ã€ç”»é¢æç”»ãªã©ã€
  // å…¨ä½“ã‚’åˆ¶å¾¡ã™ã‚‹ã‚³ã‚¢ã¨ãªã‚‹é–¢æ•°ç¾¤ã§ã™ã€‚
  // =================================================================

  /**
   * ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸéš›ã®å…±é€šå‡¦ç†ã§ã™ã€‚
   * @param {Error} err - ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  function handleServerError(err) {
    hideLoading();

    // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯é–‹ç™ºç’°å¢ƒã§ã®ã¿å‡ºåŠ›
    if (typeof console !== 'undefined' && console.error) {
      console.error('Server Error:', err);
    }

    const errorMessage = typeof err === 'object' && err.message ? err.message : JSON.stringify(err);
    showInfo(`ã‚µãƒ¼ãƒãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br><br>è©³ç´°: ${errorMessage}`, 'ã‚¨ãƒ©ãƒ¼');
  }

  /**
   * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã€ç”»é¢ã‚’å†æç”»ã—ã¾ã™ã€‚
   * @param {object} newState - æ›´æ–°ã™ã‚‹æ–°ã—ã„çŠ¶æ…‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  function setState(newState) {
    // ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®ã¿ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’è¡¨ç¤º
    const isTestEnvironment =
      typeof window !== 'undefined' &&
      (window.location.protocol === 'file:' || window.location.hostname === 'localhost');

    if (isTestEnvironment) {
      console.log('[DEBUG] setState called with:', newState);
      console.log('[DEBUG] Current appState before update:', appState);
    }

    Object.assign(appState, newState);

    // myBookingsãŒé…åˆ—ã§ãªã„å ´åˆã®é˜²å¾¡çš„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã‚‚é‡è¦ï¼‰
    if (appState.myBookings && !Array.isArray(appState.myBookings)) {
      if (isTestEnvironment) {
        console.warn('[DEBUG] myBookings is not an array, converting:', appState.myBookings);
      }
      appState.myBookings = [];
    }

    // myBookingsãŒundefinedã®å ´åˆã‚‚é…åˆ—ã§åˆæœŸåŒ–
    if (!appState.myBookings) {
      appState.myBookings = [];
    }

    if (isTestEnvironment) {
      console.log('[DEBUG] Updated appState:', appState);
    }

    render();
  }
  window.setState = setState;
  this.setState = setState;
  self.setState = setState;

  /**
   * ç¾åœ¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã«åŸºã¥ã„ã¦ã€é©åˆ‡ãªãƒ“ãƒ¥ãƒ¼ã‚’æç”»ã—ã¾ã™ã€‚
   */
  function render() {
    let v = '';
    switch (appState.view) {
      case 'login':
        v = getLoginView();
        break;
      case 'register':
        v = getRegisterView(appState.phoneForRegistration);
        break;
      case 'registrationStep2':
        v = getRegistrationStep2View();
        break;
      case 'registrationStep3':
        v = getRegistrationStep3View();
        break;
      case 'classroomSelect':
        v = getDashboardView();
        break;
      case 'newBooking':
        v = getNewBookingView();
        break;
      case 'editProfile':
        v = getEditProfileView();
        break;
      case 'booking':
        v = getBookingView(appState.selectedClassroom);
        break;
      case 'confirm':
        v = getConfirmationView();
        break;
      case 'editReservation':
        v = getEditReservationView();
        break;
      case 'accounting':
        v = getAccountingView();
        break;
      // ã€LEGACY REMOVEDã€‘ case 'history' - çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç§»è¡Œæ¸ˆã¿
      case 'complete':
        v = getCompleteView(appState.completionMessage);
        break;
      case 'noPhoneUserSelect':
        v = getNoPhoneUserSelectView();
        break; // NF-01: æ–°ã—ã„ãƒ“ãƒ¥ãƒ¼ã‚’è¿½åŠ 
    }
    console.log('Rendered view HTML:', v);
    document.getElementById('view-container').innerHTML = `<div class="fade-in">${v}</div>`;
    console.log('view-container innerHTML after update:', document.getElementById('view-container').innerHTML);

    if (appState.view === 'accounting') {
      requestAnimationFrame(() => {
        calculateAccountingDetails();
        setupAccountingFormListeners(appState.accountingReservation.reservationId);
      });
    }

    window.scrollTo(0, 0);
  }

  /**
   * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ç‚¹ã§ã™ã€‚
   * ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å®Ÿè¡Œã•ã‚Œã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
   */
  window.onload = function () {
    const app = document.getElementById('app');

    // ä¼šè¨ˆè¨ˆç”»é¢ã§ã®å…¥åŠ›å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å†è¨ˆç®—
    ['input', 'change'].forEach(eventName => {
      app.addEventListener(eventName, e => {
        if (appState.view === 'accounting' && e.target.closest('#accounting-form')) {
          calculateAccountingDetails();
        }
        // changeã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã®ã¿ã€æ”¯æ‰•ã„æ–¹æ³•é¸æŠã‚’ãƒã‚§ãƒƒã‚¯
        if (eventName === 'change' && e.target.matches('#modal-accounting-form input[name="payment-method"]')) {
          document.getElementById('confirm-payment-button')?.removeAttribute('disabled');
        }
      });
    });

    // ã‚¢ãƒ—ãƒªå…¨ä½“ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ•æ‰
    app.addEventListener('click', e => {
      const targetButton = e.target.closest('button');
      if (targetButton?.dataset.action) {
        const { action, ...data } = targetButton.dataset;
        if (action === 'copyToClipboard' || action === 'copyGrandTotal') {
          actionHandlers[action](targetButton);
        } else if (actionHandlers[action]) {
          actionHandlers[action](data);
        }
      }
    });

    // NF-04: æœ¨å½«ã‚ŠçµŒé¨“ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å¤‰æ›´ã‚’ç›£è¦–
    app.addEventListener('change', e => {
      if (e.target.closest('#experience-radio-group')) {
        const container = document.getElementById('past-work-container');
        if (container) {
          if (e.target.value === 'ã¯ã˜ã‚ã¦ï¼') {
            container.classList.add('hidden');
          } else {
            container.classList.remove('hidden');
          }
        }
      }
    });

    // åˆæœŸç”»é¢ã‚’æç”»
    render();
  };

    // ========== /14_WebApp_Handlers.html ==========


      // çµ±åˆç‰ˆåˆæœŸåŒ–
      console.log('[çµ±åˆç‰ˆ] å…¨ãƒ•ã‚¡ã‚¤ãƒ«çµ±åˆå®Œäº†ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–é–‹å§‹');

      // ãƒ†ã‚¹ãƒˆç’°å¢ƒç”¨ã®åˆæœŸåŒ–ï¼ˆhideLoading/setStateã‚’æ˜ç¤ºçš„ã«å‘¼ã¶ï¼‰
      setTimeout(() => {
        if (typeof setState === 'function') {
          setState({ view: 'login' });
        }
        if (typeof hideLoading === 'function') {
          hideLoading();
        }
        if (typeof window.onload === 'function') {
          window.onload();
        } else if (typeof render === 'function') {
          render();
        }

       }, 100);
    </script>
  </body>
</html>
