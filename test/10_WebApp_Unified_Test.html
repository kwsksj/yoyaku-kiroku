<!--
=================================================================
【ファイル名】: 10_WebApp.html
【バージョン】: 26.0 (モジュール化対応版)
【更新日時】: 2025-08-04
【説明】:
- 設定とモック機能を外部ファイルに分離
- より保守性の高い構造に改善
- テスト環境とプロダクション環境の分離
=================================================================
-->
<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <base target="_top" />
    <title>きぼりの よやく・きろく 川崎誠二木彫り教室</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="bg-brand-bg min-h-screen">
    <!-- アプリケーションのメインコンテナ -->
    <div id="app" class="container mx-auto px-4 max-w-lg">
      <!-- ローディング画面 -->
      <div id="loading" class="fixed inset-0 bg-brand-bg flex flex-col items-center justify-center z-50">
        <div class="spinner mb-4"></div>
        <p id="loading-message" class="text-brand-text">アプリケーションを読み込み中...</p>
      </div>

      <!-- メインコンテンツ -->
      <main id="main-content" class="hidden py-6">
        <div id="view-container"></div>
      </main>

      <!-- モーダルオーバーレイ -->
      <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
          <div id="modal-body"></div>
        </div>
      </div>

      <!-- カスタムモーダル -->
      <div id="custom-modal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
          <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
          <div id="modal-message" class="mb-6"></div>
          <div id="modal-buttons" class="flex gap-3 justify-end"></div>
        </div>
      </div>
      <footer class="text-center text-sm text-brand-muted mt-4">きぼりの よやく・きろく</footer>
    </div>

    <!-- 統合されたソースコード -->
    <script>
      console.log('[統合版] 統合されたソースコードを実行開始');

      
    // ========== 10_WebApp_Mock.html ==========

  /**
   * =================================================================
   * 【ファイル名】: 10_WebApp_Mock.html
   * 【バージョン】: 2.0
   * 【役割】: Google Apps Script環境をブラウザで模擬するモック機能
   * - google.script.run API の完全な模擬
   * - テストデータの提供
   * - チェーン可能なAPI構造のサポート
   * =================================================================
   */

  // ブラウザ環境の検出
  if (typeof window !== 'undefined' && !window.google) {
    console.log('[TEST] ブラウザ環境を検出しました');

    // モックデータの定義
    window.MockData = {
      currentUser: {
        studentId: 'TEST001',
        nickname: 'テストユーザー',
        realName: '山田太郎',
        phone: '09012345678',
      },
      slots: [
        {
          classroom: '東京教室',
          date: '2025-08-10',
          time: '09:00-12:00',
          session: '午前',
          availableSlots: 3,
          venue: '東京スタジオ',
          maxCapacity: 6,
          teacher: '田中先生',
        },
        {
          classroom: '東京教室',
          date: '2025-08-10',
          time: '13:00-16:00',
          session: '午後',
          availableSlots: 2,
          venue: '東京スタジオ',
          maxCapacity: 6,
          teacher: '佐藤先生',
        },
        {
          classroom: 'つくば教室',
          date: '2025-08-15',
          time: '09:00-12:00',
          session: '午前',
          availableSlots: 4,
          venue: 'つくばスタジオ',
          maxCapacity: 8,
          teacher: '鈴木先生',
        },
        {
          classroom: '沼津教室',
          date: '2025-08-20',
          time: '14:00-17:00',
          session: '午後',
          availableSlots: 1,
          venue: '沼津スタジオ',
          maxCapacity: 4,
          teacher: '高橋先生',
        },
      ],
      myBookings: [
        {
          reservationId: 'RES001',
          date: '2025-08-05',
          time: '09:00-12:00',
          classroom: '東京教室',
          venue: '東京スタジオ',
          teacher: '山田先生',
          studentId: 'TEST001',
          studentName: 'テスト太郎',
          status: 'confirmed',
          accountingDone: false,
          accountingDetails: null,
        },
      ],
      history: [
        {
          date: '2025-07-25',
          studentId: 'TEST001',
          studentName: 'テスト太郎',
          amount: 2000,
          items: ['教材費', '施設利用料'],
          status: 'completed',
        },
      ],
      classrooms: ['東京教室', 'つくば教室', '沼津教室'],
      accountingMaster: [
        // 授業料 - 東京教室
        { 種別: '授業料', 項目名: '初回講習', 単価: 2000, 単位: '回', 対象教室: '東京教室' },
        { 種別: '授業料', 項目名: '早出', 単価: 600, 単位: '回', 対象教室: '東京教室' },
        { 種別: '授業料', 項目名: '本講座', 単価: 6600, 単位: '回', 対象教室: '東京教室' },

        // 授業料 - つくば教室
        { 種別: '授業料', 項目名: '30分あたり', 単価: 600, 単位: '30分', 対象教室: 'つくば教室' },
        { 種別: '授業料', 項目名: '初回講習', 単価: 600, 単位: '30分', 対象教室: 'つくば教室' },
        { 種別: '授業料', 項目名: '初回講習同時間割引', 単価: -300, 単位: '30分', 対象教室: 'つくば教室' },

        // 授業料 - 沼津教室
        { 種別: '授業料', 項目名: '30分あたり', 単価: 600, 単位: '30分', 対象教室: '沼津教室' },
        { 種別: '授業料', 項目名: '初回講習', 単価: 600, 単位: '30分', 対象教室: '沼津教室' },
        { 種別: '授業料', 項目名: '初回講習同時間割引', 単価: -300, 単位: '30分', 対象教室: '沼津教室' },

        // 共通授業料
        { 種別: '授業料', 項目名: '彫刻刀レンタル', 単価: 500, 単位: '回', 対象教室: '共通' },

        // 物販
        { 種別: '物販', 項目名: 'ハイス鋼 彫刻刀 5本set 桐箱付き', 単価: 17000, 単位: '個', 対象教室: '共通' },
        { 種別: '物販', 項目名: 'ハイス鋼 彫刻刀3本set', 単価: 9800, 単位: '個', 対象教室: '共通' },
        { 種別: '物販', 項目名: '刃物鋼 彫刻刀 5本set', 単価: 10200, 単位: '個', 対象教室: '共通' },
        { 種別: '物販', 項目名: '刃物鋼 彫刻刀3本set', 単価: 6200, 単位: '個', 対象教室: '共通' },
        { 種別: '物販', 項目名: 'テキスト', 単価: 1650, 単位: '個', 対象教室: '共通' },
        { 種別: '物販', 項目名: '作業台（最新版）', 単価: 3500, 単位: '個', 対象教室: '共通' },
        { 種別: '物販', 項目名: '作業台 中古', 単価: 1000, 単位: '個', 対象教室: '共通' },
        { 種別: '物販', 項目名: 'コルク板', 単価: 500, 単位: '個', 対象教室: '共通' },
        { 種別: '物販', 項目名: '耐切創手袋（片手）', 単価: 1000, 単位: '個', 対象教室: '共通' },
        { 種別: '物販', 項目名: '革砥セット', 単価: 3000, 単位: '個', 対象教室: '共通' },
        { 種別: '物販', 項目名: 'ノコギリセット', 単価: 2300, 単位: '個', 対象教室: '共通' },
        { 種別: '物販', 項目名: '金具類 1組', 単価: 100, 単位: '個', 対象教室: '共通' },
        { 種別: '物販', 項目名: 'ガチャ１（６体セット）', 単価: 2000, 単位: '個', 対象教室: '共通' },
        { 種別: '物販', 項目名: 'ガチャ２（６体セット）', 単価: 2000, 単位: '個', 対象教室: '共通' },
        { 種別: '物販', 項目名: 'ガチャ３（５体セット）', 単価: 2000, 単位: '個', 対象教室: '共通' },

        // 材料（固定料金）
        {
          種別: '材料',
          項目名: '材料代 ¥100（固定）',
          単価: 100,
          単位: '個',
          対象教室: '共通',
          備考: '計算不要の材料',
        },
        {
          種別: '材料',
          項目名: '材料代 ¥200（固定）',
          単価: 200,
          単位: '個',
          対象教室: '共通',
          備考: '計算不要の材料',
        },
        {
          種別: '材料',
          項目名: '材料代 ¥300（固定）',
          単価: 300,
          単位: '個',
          対象教室: '共通',
          備考: '計算不要の材料',
        },

        // 材料（体積計算）
        { 種別: '材料', 項目名: 'バスウッド・シナ', 単価: 2, 単位: 'cm³', 対象教室: '共通' },
        { 種別: '材料', 項目名: 'ジェルトン', 単価: 2, 単位: 'cm³', 対象教室: '共通' },
        { 種別: '材料', 項目名: '木曽桧', 単価: 6, 単位: 'cm³', 対象教室: '共通' },
        { 種別: '材料', 項目名: '米ヒバ', 単価: 3, 単位: 'cm³', 対象教室: '共通' },
      ],
    };

    // Google Apps Script APIのモック
    window.google = {
      script: {
        run: new Proxy(
          {},
          {
            get: function (target, prop) {
              if (prop === 'withSuccessHandler') {
                return function (successCallback) {
                  return {
                    withFailureHandler: function (failureCallback) {
                      return createMockFunctions(successCallback, failureCallback);
                    },
                  };
                };
              }
              if (prop === 'withFailureHandler') {
                return function (failureCallback) {
                  return {
                    withSuccessHandler: function (successCallback) {
                      return createMockFunctions(successCallback, failureCallback);
                    },
                  };
                };
              }
              return createMockFunctions(null, null)[prop];
            },
          },
        ),
      },
    };

    // モック関数の生成
    function createMockFunctions(successCallback, failureCallback) {
      const mockFunctions = {};

      const gasFunctions = [
        'authenticateUser',
        'getInitialWebApp_Data',
        'getReservationDetails',
        'registerNewUser',
        'updateUserProfile',
        'makeReservationAndGetLatestData',
        'cancelReservationAndGetLatestData',
        'makeAccountingAndGetLatestData',
        'saveAccountingDetails',
        'searchNoPhoneUsersByFilterForWebApp',
        'updateHistoryMemoAndGetData',
        'editProfileAndGetData',
        'removeAccountingItemFromPendingAndGetData',
      ];

      gasFunctions.forEach(funcName => {
        mockFunctions[funcName] = function (...args) {
          console.log(`[MOCK] ${funcName} called with:`, args);

          let response;
          switch (funcName) {
            case 'authenticateUser':
              response = {
                success: true,
                user: window.MockData.currentUser,
                initialData: {
                  availableSlots: window.MockData.slots,
                  myBookings: window.MockData.myBookings,
                  accountingMaster: window.MockData.accountingMaster,
                  myHistory: window.MockData.history,
                },
              };
              break;
            case 'getInitialWebApp_Data':
              response = {
                success: true,
                user: window.MockData.currentUser,
                initialData: {
                  availableSlots: window.MockData.slots,
                  myBookings: window.MockData.myBookings,
                  accountingMaster: window.MockData.accountingMaster,
                  myHistory: window.MockData.history,
                },
              };
              break;
            case 'getReservationDetails':
              const reservationData = args[0] || {};
              const classroom = reservationData.classroom || '東京教室';
              const tuitionItems = window.MockData.accountingMaster.filter(
                item => item['種別'] === '授業料' && (item['対象教室'] === classroom || item['対象教室'] === '共通'),
              );
              const salesItems = window.MockData.accountingMaster.filter(
                item => item['種別'] === '物販' && item['対象教室'] === '共通',
              );
              const materialItems = window.MockData.accountingMaster.filter(
                item => item['種別'] === '材料' && item['対象教室'] === '共通',
              );
              response = {
                success: true,
                details: {
                  currentBookings: window.MockData.myBookings,
                  pendingAccountingItems: [],
                  accountingMaster: window.MockData.accountingMaster,
                  tuitionItems: tuitionItems,
                  salesItems: salesItems,
                  materialItems: materialItems,
                  selectedClassroom: classroom,
                  myHistory: window.MockData.history,
                },
              };
              break;
            case 'registerNewUser':
              const [newUserData] = args;
              const newUser = {
                studentId: 'NEW_USER_' + Date.now(),
                realName: newUserData.realName,
                displayName: newUserData.nickname,
                phone: newUserData.phone,
              };
              // 新規ユーザーをcurrentUserに反映
              window.MockData.currentUser = newUser;
              response = {
                success: true,
                message: 'ユーザー登録が完了しました',
                user: newUser,
              };
              break;
            case 'updateUserProfile':
              const [profileUpdateData] = args;
              Object.assign(window.MockData.currentUser, profileUpdateData);
              response = {
                success: true,
                message: 'プロフィールを更新しました',
                user: window.MockData.currentUser,
              };
              break;
            case 'makeReservationAndGetLatestData':
              const [slotData] = args;
              const newBooking = {
                reservationId: 'RES' + Date.now(),
                date: slotData.date,
                time: slotData.time || '09:00-12:00',
                classroom: slotData.classroom,
                venue: slotData.venue || slotData.classroom + 'スタジオ',
                teacher: slotData.teacher || '講師',
                studentId: window.MockData.currentUser.studentId,
                studentName: window.MockData.currentUser.realName,
                status: 'confirmed',
                accountingDone: false,
                accountingDetails: null,
                workInProgress: '',
              };
              window.MockData.myBookings.push(newBooking);
              response = {
                success: true,
                message: '予約が完了しました',
                availableSlots: window.MockData.slots,
                myBookings: window.MockData.myBookings,
                accountingMaster: window.MockData.accountingMaster,
              };
              break;
            case 'cancelReservationAndGetLatestData':
              const [cancelData] = args;
              const beforeCount = window.MockData.myBookings.length;
              window.MockData.myBookings = window.MockData.myBookings.filter(booking => {
                if (cancelData.reservationId) {
                  return booking.reservationId !== cancelData.reservationId;
                } else {
                  return !(booking.date === cancelData.date && booking.time === cancelData.time);
                }
              });
              const canceled = beforeCount > window.MockData.myBookings.length;
              response = {
                success: canceled,
                message: canceled ? '予約をキャンセルしました' : '対象の予約が見つかりませんでした',
                availableSlots: window.MockData.slots,
                myBookings: window.MockData.myBookings,
                accountingMaster: window.MockData.accountingMaster,
              };
              break;
            case 'makeAccountingAndGetLatestData':
              const [accountingData] = args;
              const newAccountingRecord = {
                date: new Date().toISOString().split('T')[0],
                studentId: window.MockData.currentUser.studentId,
                studentName: window.MockData.currentUser.realName,
                amount: accountingData.amount || 1000,
                items: accountingData.items || ['テスト項目'],
                status: 'completed',
              };
              window.MockData.history.push(newAccountingRecord);
              response = {
                success: true,
                message: '会計処理が完了しました',
                myHistory: window.MockData.history,
                accountingMaster: window.MockData.accountingMaster,
              };
              break;
            case 'saveAccountingDetails':
              const [saveAccountingData] = args;
              const targetBooking = window.MockData.myBookings.find(
                booking => booking.reservationId === saveAccountingData.reservationId,
              );
              if (targetBooking) {
                targetBooking.accountingDone = true;
                targetBooking.accountingDetails = JSON.stringify(saveAccountingData.details || {});
              }
              const detailedRecord = {
                date: new Date().toISOString().split('T')[0],
                studentId: window.MockData.currentUser.studentId,
                studentName: window.MockData.currentUser.realName,
                reservationId: saveAccountingData.reservationId,
                details: saveAccountingData.details,
                totalAmount: saveAccountingData.totalAmount || 0,
                status: 'completed',
              };
              window.MockData.history.push(detailedRecord);
              response = {
                success: true,
                message: '会計詳細が保存されました',
                myBookings: window.MockData.myBookings,
                myHistory: window.MockData.history,
              };
              break;
            case 'searchNoPhoneUsersByFilterForWebApp':
              response = {
                success: true,
                users: [
                  { studentId: 'NO_PHONE_001', realName: '未登録太郎', displayName: '未登録ユーザー1' },
                  { studentId: 'NO_PHONE_002', realName: '未登録花子', displayName: '未登録ユーザー2' },
                ],
              };
              break;
            case 'updateHistoryMemoAndGetData':
              const [memoData] = args;
              // historyの該当項目にmemoを追加
              const targetHistory = window.MockData.history.find(h => h.date === memoData.date);
              if (targetHistory) targetHistory.memo = memoData.memo;
              response = {
                success: true,
                message: 'メモを更新しました',
                myHistory: window.MockData.history,
              };
              break;
            case 'editProfileAndGetData':
              const [profileData] = args;
              Object.assign(window.MockData.currentUser, profileData);
              response = {
                success: true,
                message: 'プロフィールを更新しました',
                user: window.MockData.currentUser,
              };
              break;
            case 'removeAccountingItemFromPendingAndGetData':
              const [removeData] = args;
              // accountingMasterから該当項目を削除
              window.MockData.accountingMaster = window.MockData.accountingMaster.filter(
                item => item.項目名 !== removeData.itemName,
              );
              response = {
                success: true,
                message: '項目を削除しました',
                accountingMaster: window.MockData.accountingMaster,
              };
              break;
            default:
              response = { success: true, message: `Mock response for ${funcName}` };
          }

          setTimeout(() => {
            if (successCallback) {
              successCallback(response);
            }
          }, 100);
        };
      });

      return mockFunctions;
    }

    console.log('[TEST] 拡張モック環境が設定されました');
  }

    // ========== /10_WebApp_Mock.html ==========

    // ========== 11_WebApp_Config.html ==========

  /**
   * =================================================================
   * 【ファイル名】: 11_WebApp_Config.html
   * 【バージョン】: 1.7
   * 【役割】: WebAppのフロントエンドで使用される設定とスタイル定義
   * 【構成】: 14ファイル構成のうちの11番目
   * 【v1.7での変更点】:
   * - 全体的な配色をよりエネルギッシュで温かみのあるテーマに更新
   * - ボタンのテキストの可読性を向上
   * - 会計ボタンに黄色系の配色を適用
   * - 記録カードに背景色を追加
   * =================================================================
   */

  // =================================================================
  // 1. APPLICATION CONSTANTS
  // =================================================================
  const TOKYO_CLASSROOM_NAME = '東京教室';
  const NUMAZU_CLASSROOM_NAME = '沼津教室';
  const TSUKUBA_CLASSROOM_NAME = 'つくば教室';
  const ITEM_NAME_DISCOUNT = '初回講習同時間割引';

  // =================================================================
  // 2. DESIGN CONFIGURATION
  // =================================================================
  const DesignConfig = {
    // テキストや背景の色設定（温かみと活気のある配色）
    colors: {
      text: 'text-brand-text', // メインテキスト
      textSubtle: 'text-brand-subtle', // サブテキスト
      textMuted: 'text-brand-muted', // 薄いテキスト
      primary: 'bg-action-primary-bg text-action-primary-text active:bg-action-primary-hover', // プライマリ (テラコッタ)
      secondary: 'bg-action-secondary-bg text-action-secondary-text active:bg-action-secondary-hover', // セカンダリ (明るいベージュ)
      attention: 'bg-action-attention-bg text-action-attention-text active:bg-action-attention-hover', // 注意 (若葉色)
      accounting: 'bg-action-accounting-bg text-action-accounting-text active:bg-action-accounting-hover', // 会計 (アンバー)
      danger: 'bg-state-danger-bg text-state-danger-text active:bg-state-danger-hover', // 危険 (落ち着いた赤)
      success: 'bg-state-success-bg text-state-success-text active:bg-state-success-hover', // 成功 (若葉色)
      paid: 'bg-action-paid-bg text-action-paid-text', // 支払い済み (薄い緑)
      info: 'bg-ui-surface text-brand-text border border-ui-border',
      warning: 'bg-ui-warning-bg text-ui-warning-text border border-ui-warning-border',
      error: 'bg-ui-error-bg text-ui-error-text border border-ui-error-border',
    },

    // ボタンの基本スタイル
    buttons: {
      base: 'font-bold py-2.5 px-5 rounded-md transition-all duration-150 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 mobile-button touch-friendly',
      full: 'w-[250px] mx-auto block',
      auto: 'w-auto',
      primary:
        'font-bold py-2.5 px-5 rounded-md transition-all duration-150 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 mobile-button touch-friendly bg-action-primary-bg text-action-primary-text active:bg-action-primary-hover',
      secondary:
        'font-bold py-2.5 px-5 rounded-md transition-all duration-150 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 mobile-button touch-friendly bg-action-secondary-bg text-action-secondary-text active:bg-action-secondary-hover',
      attention:
        'font-bold py-2.5 px-5 rounded-md transition-all duration-150 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 mobile-button touch-friendly bg-action-attention-bg text-action-attention-text active:bg-action-attention-hover',
      accounting:
        'font-bold py-2.5 px-5 rounded-md transition-all duration-150 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 mobile-button touch-friendly bg-action-accounting-bg text-action-accounting-text active:bg-action-accounting-hover',
    },

    // テキストスタイル設定
    text: {
      heading: 'text-xl font-bold text-brand-text',
      subheading: 'text-lg font-medium text-brand-text',
      body: 'text-base text-brand-text',
      bodySubtle: 'text-base text-brand-subtle',
      caption: 'text-sm text-brand-subtle',
      label: 'text-base font-bold text-brand-text',
      labelBlock: 'block text-brand-text text-base font-bold mb-2',
    },

    // レイアウトユーティリティ
    layout: {
      container: 'max-w-screen-sm mx-auto p-4',
      containerNoPadding: 'max-w-screen-sm mx-auto',
      section: 'mb-8',
      card: 'shadow-card rounded-lg border border-solid border-card-border',
      centerContent: 'flex items-center justify-center',
      spaceBetween: 'flex items-center justify-between',
    },

    // ユーティリティクラス
    utils: {
      hidden: 'hidden',
      loading: 'opacity-50 pointer-events-none',
      mobileFriendly: 'mobile-button touch-friendly',
      flexCenter: 'flex items-center justify-center',
      flexBetween: 'flex items-center justify-between',
      fullWidth: 'w-full',
      autoMargin: 'mx-auto',
    },

    // カードスタイル
    cards: {
      base: 'w-full text-left p-3 rounded-lg mobile-card touch-friendly transition-all duration-150',
      container: 'max-w-md mx-auto space-y-3',
      background: 'bg-ui-surface border border-ui-border',
      state: {
        available: {
          card: 'bg-state-available-bg border border-state-available-border mobile-card active:bg-state-success-hover',
          text: 'text-state-available-text',
        },
        waitlist: {
          card: 'bg-state-waitlist-bg border border-state-waitlist-border mobile-card',
          text: 'text-state-waitlist-text',
        },
        booked: {
          card: 'bg-state-booked-bg border border-state-booked-border mobile-card',
          text: 'text-state-booked-text',
        },
        history: {
          card: 'bg-brand-light border border-ui-border mobile-card',
        },
      },
    },

    // 入力フォームのスタイル
    inputs: {
      container: 'max-w-md mx-auto',
      base: 'text-lg w-full p-3 border border-ui-border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-text mobile-input touch-friendly bg-ui-input focus:bg-ui-input-focus transition-all duration-150',
      textarea:
        'text-lg w-full p-3 border border-ui-border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-text h-24 mobile-input bg-ui-input focus:bg-ui-input-focus transition-all duration-150',
    },
  };

  // =================================================================
  // 3. CSS STYLES SETUP
  // =================================================================
  const addCustomStyles = () => {
    const style = document.createElement('style');
    style.textContent = `
      /* ========== CSS Variables ========== */
      :root {
        /* Energetic and warm theme for a wood carving school */
        --brand-text: #4E342E;       /* Dark Brown for high readability */
        --brand-subtle: #785A4E;     /* Medium Brown for sub-text */
        --brand-muted: #A1887F;      /* Lighter, soft brown */
        --brand-bg: #FFFDF5;         /* Warm, very light cream background */
        --brand-surface: #FFFFFF;    /* White for card backgrounds for a clean look */
        --brand-light: #F5F1ED;      /* Light, warm beige for hover states */

        --action-primary: #C86F34;   /* Energetic terracotta for main actions */
        --action-secondary: #E4CDBA; /* Light, warm beige for secondary actions */
        --action-attention: #5A8C36; /* Lively, fresh green for attention */
        --action-accounting: #F59E0B;/* Bright amber for accounting actions */
        --action-danger: #B91C1C;    /* A clear, strong red for danger */

        --state-available: #5A8C36;  /* Lively green for available slots */
        --state-waitlist: #F59E0B;   /* Bright amber for waitlist */
        --state-booked: #785A4E;     /* Medium brown for booked slots */

        --ui-border: #E4CDBA;        /* Soft, warm beige for borders */
        --ui-input: #FAFAFA;         /* Neutral light gray for inputs */
        --ui-surface: #FFFFFF;

        --modal-overlay: rgba(0, 0, 0, 0.5);
        --spinner-border: #f3f4f6;
      }

      /* ========== Base Styles ========== */
      body {
        font-family: 'Zen Kaku Gothic New', sans-serif;
        color: var(--brand-text);
        background-color: var(--brand-bg);
        line-height: 1.6;
      }

      /* ========== Mobile-Friendly Components ========== */
      .mobile-button, .mobile-input, .mobile-card {
        min-height: 48px;
      }
      .touch-friendly {
        touch-action: manipulation;
      }

      /* ========== Animations ========== */
      .fade-in { animation: fadeInUp 0.3s ease-out; }
      @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .spinner {
        border: 4px solid var(--spinner-border);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border-left-color: var(--brand-text);
        animation: spin 1s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }

      /* ========== Layout Components ========== */
      #loading { z-index: 100; }
      .modal-overlay {
        position: fixed; inset: 0; background-color: var(--modal-overlay);
        display: flex; align-items: center; justify-content: center;
        z-index: 50; opacity: 0; transition: opacity 0.3s ease;
        pointer-events: none; backdrop-filter: blur(3px);
      }
      .modal-overlay.active { opacity: 1; pointer-events: auto; }
      #custom-modal {
        opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
      }
      #custom-modal.active { opacity: 1; pointer-events: auto; }
      .modal-content {
        background: white; padding: 1.5rem; border-radius: 0.75rem;
        width: 90%; max-width: 400px; text-align: center;
        max-height: 85vh; overflow-y: auto;
      }
      .modal-content p { margin-bottom: 1.25rem; }
      .modal-content .modal-buttons { justify-content: center; }

      /* ========== Custom Components ========== */
      details > summary { list-style: none; cursor: pointer; }
      details > summary::-webkit-details-marker { display: none; }

      .accounting-item, .reservation-card {
        background-color: var(--brand-surface);
        border: 1px solid var(--ui-border);
        transition: all 0.2s ease;
      }
      .accounting-item:hover, .reservation-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        border-color: var(--brand-muted);
      }

      /* ========== Responsive Design ========== */
      @media (max-width: 640px) {
        .modal-content { width: 95%; padding: 1rem; }
        .mobile-button, .mobile-input { font-size: 16px; }
      }
    `;
    document.head.appendChild(style);
  };

  // =================================================================
  // 4. TAILWIND CSS SETUP
  // =================================================================
  const setupTailwindCSS = () => {
    const tailwindScript = document.createElement('script');
    tailwindScript.src = 'https://cdn.tailwindcss.com';

    tailwindScript.onload = function () {
      if (window.tailwind) {
        window.tailwind.config = {
          theme: {
            extend: {
              fontSize: { '2xs': '0.625rem' },
              fontFamily: { sans: ['Zen Kaku Gothic New', 'sans-serif'] },
              colors: {
                brand: {
                  bg: '#FFFDF5',
                  surface: '#FFFFFF',
                  text: '#4E342E',
                  subtle: '#785A4E',
                  light: '#F5F1ED',
                  dark: '#4E342E',
                  muted: '#A1887F',
                },
                action: {
                  'primary-bg': '#C86F34',
                  'primary-text': '#FFFFFF',
                  'primary-hover': '#A95B2A',
                  'secondary-bg': '#E4CDBA',
                  'secondary-text': '#4E342E', // Improved contrast
                  'secondary-hover': '#D7BCA9',
                  'attention-bg': '#5A8C36',
                  'attention-text': '#FFFFFF',
                  'attention-hover': '#4A732C',
                  'accounting-bg': '#F59E0B', // Amber
                  'accounting-text': '#4E342E', // Dark text for readability
                  'accounting-hover': '#D97706',
                  'danger-bg': '#B91C1C',
                  'danger-text': '#FFFFFF',
                  'danger-hover': '#991B1B',
                  'paid-bg': '#F0FDF4',
                  'paid-text': '#166534',
                },
                state: {
                  'available-text': '#166534',
                  'available-bg': '#F0FDF4',
                  'available-border': '#A7F3D0',
                  'available-hover': '#D1FAE5',
                  'waitlist-text': '#B45309',
                  'waitlist-bg': '#FFFBEB',
                  'waitlist-border': '#FDE68A',
                  'booked-text': '#44403C',
                  'booked-bg': '#F5F5F4',
                  'booked-border': '#E7E5E4',
                  'success-bg': '#F0FDF4',
                  'success-text': '#166534',
                  'success-border': '#A7F3D0',
                  'success-hover': '#D1FAE5',
                  'danger-bg': '#FEF2F2',
                  'danger-text': '#B91C1C',
                  'danger-border': '#FECACA',
                  'danger-hover': '#FEE2E2',
                },
                ui: {
                  border: '#E4CDBA',
                  'border-light': '#F5F1ED',
                  surface: '#FFFFFF',
                  input: '#FAFAFA',
                  'input-focus': '#FFFFFF',
                  'error-text': '#B91C1C',
                  'error-bg': '#FEF2F2',
                  'error-border': '#FECACA',
                  'warning-text': '#B45309',
                  'warning-bg': '#FFFBEB',
                  'warning-border': '#FDE68A',
                  'link-text': '#0369A1',
                },
              },
            },
          },
        };
        console.log('[CONFIG] Tailwind CSS設定が完了しました');
      }
    };

    tailwindScript.onerror = function () {
      console.warn('[CONFIG] Tailwind CSS読み込みに失敗しました');
    };

    document.head.appendChild(tailwindScript);
  };

  // =================================================================
  // 5. INITIALIZATION
  // =================================================================
  console.log('[CONFIG] 設定ファイルを読み込み中...');
  addCustomStyles();
  setupTailwindCSS();
  console.log('[CONFIG] 設定ファイルの読み込みが完了しました');

    // ========== /11_WebApp_Config.html ==========

    // ========== 12_WebApp_Core.html ==========

  /**
   * =================================================================
   * 【ファイル名】: 12_WebApp_Core.html
   * 【バージョン】: 1.2
   * 【役割】: WebAppのフロントエンドにおける中核機能を集約します。
   * - 状態管理 (State Management)
   * - UIコンポーネント生成 (UI Components)
   * - 汎用ユーティリティ (Utilities)
   * - 会計計算ロジック (Calculation Logic)
   * 【構成】: 14ファイル構成のうちの12番目
   * 【v1.2での変更点】:
   * - リファクタリング: 日付・スロット処理の共通ユーティリティ関数を追加。
   * - filterFutureAvailableSlots, groupSlotsByMonth 関数を新規追加。
   * - コードの可読性とメンテナンス性を向上。
   * =================================================================
   */

  // =================================================================
  // --- Application State Management ---
  // -----------------------------------------------------------------
  // アプリケーション全体の動的な状態を一元管理します。
  // ユーザー情報、予約データ、現在の表示画面などが含まれます。
  // =================================================================

  // =================================================================
  // --- Environment Detection & Data Management ---
  // -----------------------------------------------------------------
  // 実行環境を自動検出し、適切なデータソースを選択します。
  // テスト環境: ブラウザ + モックデータ
  // 本番環境: Google Apps Script + 実データ
  // =================================================================

  /**
   * 実行環境の検出
   * @returns {string} 'test' | 'production'
   */
  const detectEnvironment = () => {
    try {
      // GAS環境の検出
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        return 'production';
      }
      return 'test';
    } catch (error) {
      return 'test';
    }
  };

  /**
   * 環境に応じたデータ取得
   * @param {string} dataType - データタイプ
   * @param {any} fallback - フォールバックデータ
   */
  const getEnvironmentData = (dataType, fallback = null) => {
    const env = detectEnvironment();

    if (env === 'test' && typeof MockData !== 'undefined') {
      return MockData[dataType] || fallback;
    }

    // GAS環境では初期値のみ返し、データは後でAPI呼び出しで取得
    return fallback;
  };

  // 環境情報
  const isTestEnvironment = detectEnvironment() === 'test';

  // 開発時のログ出力
  if (isTestEnvironment) {
    console.log('🧪 Test Environment Detected');
    console.log('MockData available:', typeof MockData !== 'undefined');
  }

  window.appState = {
    currentUser: getEnvironmentData('currentUser'),
    slots: getEnvironmentData('slots', []),
    myBookings: getEnvironmentData('myBookings', []),
    history: getEnvironmentData('history', []),
    historyTotal: getEnvironmentData('history', []).length,
    view: isTestEnvironment ? 'login' : 'login',
    selectedClassroom: null,
    selectedSlot: null,
    phoneForRegistration: null,
    completionMessage: '',
    newlyBookedReservation: null,
    editingReservationDetails: null,
    accountingReservation: null,
    accountingMaster: getEnvironmentData('accountingMaster'),
    accountingInitialValues: null,
    editingHistoryItem: null,
    classrooms: getEnvironmentData('classrooms', ['東京教室', 'つくば教室', '沼津教室']),
    // NF-01: 電話番号未登録ユーザー選択フロー用の状態
    noPhoneUsers: [], // 検索結果のユーザーリスト
    selectedNoPhoneUser: null, // 選択されたユーザー
    searchAttempted: false, // NF-01: 検索が一度試行されたかを示すフラグ
    // NF-04: 新規ユーザー登録フロー用の状態
    registrationStep: 1, // 新規登録フローの現在のステップ (1, 2, 3)
    registrationData: {}, // 各ステップで入力された情報を一時的に蓄積する
    isFirstTimeBooking: false, // 初回予約かどうかを示すフラグ
  };
  let onConfirmCallback = null; // モーダル確認時のコールバック関数を保持

  // テスト環境の初期化ログ
  if (isTestEnvironment) {
    console.log('[TEST] テスト環境で実行中です');
    console.log('[TEST] appState初期化:', {
      currentUser: appState.currentUser,
      slotsCount: appState.slots.length,
      bookingsCount: appState.myBookings.length,
      historyCount: appState.history.length,
      classrooms: appState.classrooms,
    });
  }

  // =================================================================
  // --- UI Component Generators ---
  // -----------------------------------------------------------------
  // アプリ内で使用されるボタンや入力欄といった、再利用可能な
  // UI部品を生成する関数群です。
  // =================================================================

  /**
   * HTML文字列をエスケープします。
   * @param {string} str エスケープする文字列
   * @returns {string} エスケープされた文字列
   */
  const escapeHTML = str => {
    if (typeof str !== 'string') {
      return str;
    }
    return str.replace(/[&<>"']/g, function (match) {
      return {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
      }[match];
    });
  };

  const Components = {
    createButton: c =>
      `<button
        data-action="${escapeHTML(c.action || '')}"
        data-classroom="${escapeHTML(c.classroom || '')}"
        data-classroom-name="${escapeHTML(c.classroomName || '')}"
        data-date="${escapeHTML(c.date || '')}"
        data-reservation-id="${escapeHTML(c.reservationId || '')}"
        data-sheet-name="${escapeHTML(c.sheetName || '')}"
        data-copy-text="${escapeHTML(c.copyText || '')}"
        data-details="${escapeHTML(c.details || '')}"
        data-student-id="${escapeHTML(c.studentId || '')}"
        data-real-name="${escapeHTML(c.realName || '')}"
        data-nickname="${escapeHTML(c.nickname || '')}"
        class="${DesignConfig.buttons.base} ${c.widthClass || ''} ${c.colorClass}"
        ${c.disabled ? 'disabled' : ''}
      >${escapeHTML(c.text)}</button>`,

    createInput: c =>
      `<div class="${c.containerClass || ''} mb-4">
        <label
          for="${c.id}"
          class="${c.labelClass || DesignConfig.text.labelBlock} ${c.isSrOnly ? 'sr-only' : ''}"
        >${escapeHTML(c.label)}</label>
        ${c.caption ? `<p class="${DesignConfig.text.caption} mb-2">${escapeHTML(c.caption)}</p>` : ''}
        <input
          type="${c.type}"
          id="${c.id}"
          value="${escapeHTML(c.value || '')}"
          class="${DesignConfig.inputs.base} ${c.inputClass || ''}"
          placeholder="${escapeHTML(c.placeholder || '')}"
          ${c.required ? 'required' : ''}
          autocomplete="${c.autocomplete || 'off'}"
          ${c.step ? `step="${c.step}"` : ''}
        >
      </div>`,

    createTextArea: c =>
      `<div class="${c.containerClass || ''} mb-4">
        <label for="${c.id}" class="${DesignConfig.text.labelBlock}">${escapeHTML(c.label)}</label>
        ${c.caption ? `<p class="${DesignConfig.text.caption} mb-2">${escapeHTML(c.caption)}</p>` : ''}
        <textarea
          id="${c.id}"
          class="${DesignConfig.inputs.textarea}"
          placeholder="${escapeHTML(c.placeholder || '')}"
        >${escapeHTML(c.value || '')}</textarea>
      </div>`,

    createSelect: c =>
      `<div class="${c.containerClass || ''}">
        <label for="${c.id}" class="${DesignConfig.text.labelBlock}">${escapeHTML(c.label)}</label>
        <select
          id="${c.id}"
          class="${DesignConfig.inputs.base} ${c.sizeClass || ''} accounting-item"
        >${c.options}</select>
      </div>`,

    createCheckbox: c =>
      `<label class="flex items-center space-x-2 ${DesignConfig.colors.text}">
        <input
          type="checkbox"
          id="${c.id}"
          ${c.checked ? 'checked' : ''}
          class="accent-action-primary-bg"
        >
        <span>${escapeHTML(c.label)}</span>
      </label>`,
  };

  // =================================================================
  // --- Loading Message System ---
  // -----------------------------------------------------------------
  // UI-11: ローディングメッセージの多様化機能
  // 状況に応じたメッセージとユーモラスなメッセージをランダムに表示し、
  // 数秒ごとに自動で切り替える機能を提供します。
  // =================================================================
  let loadingMessageTimer = null;

  const LoadingMessages = {
    // ログイン時のメッセージ
    login: [
      'めいぼ を さがしています...',
      'めいぼ じたい を さがしています...',
      'きろく を かくにん ちゅうです...',
      'なまえ を かくにん しています...',
      'とうろく が あるか しらべています...',
    ],

    // 申し込み時のメッセージ
    booking: [
      'よやく を もうしこみ ちゅうです...',
      'しんせいしょ を ていしゅつしています...',
      'はんこ を さがしています...',
      'ひづけ を かくにんしています...',
      'かれんだー に かきこんでいます...',
    ],

    // 予約キャンセル時のメッセージ
    cancel: ['よやく を とりけしています...', 'けしごむ を さがしています...', 'とりけしせん を ひいています...'],

    // 予約編集時のメッセージ
    edit: [
      'へんこう を ほぞんしています...',
      'あたらしい ないよう に かきかえています...',
      'まちがい が ないか かくにんしています...',
    ],

    // 会計時のメッセージ
    accounting: [
      'でんぴょう を おくっています...',
      'ちょうぼ を つけています...',
      'おかね を かぞえています...',
      'おつり を じゅんびしています...',
    ],

    // データ取得時のメッセージ
    dataFetch: [
      'データ を よみこんでいます...',
      'じょうほう を あつめています...',
      'ひつような もの を さがしています...',
    ],

    // デフォルトのメッセージ
    default: [
      'せんせい を さがしています...',
      'しょるい を さがしています...',
      'しょるい を ながめています...',
      'きくず を かたずけています...',
      'ことば を えらんでいます...',
      'ていさい を ととのえています...',
      'みぎ の もの を ひだり に うごかしています...',
      'ひだり の もの を みぎ に うごかしています...',
      'こーひー を いれています...',
      'すこし きゅうけい しています...',
      'ねこ の て を かりようとしています...',
      'はむすたー の て を かりようとしています...',
      'はもの を ととのえています...',
    ],
  };

  const getRandomMessage = (category = 'default') => {
    const messages = [...(LoadingMessages[category] || []), ...LoadingMessages.default];
    return messages[Math.floor(Math.random() * messages.length)];
  };

  const updateLoadingMessage = (category = 'default') => {
    const messageElement = document.getElementById('loading-message');
    if (messageElement) {
      messageElement.textContent = getRandomMessage(category);
    }
  };

  const startLoadingMessageRotation = (category = 'default') => {
    // 初期メッセージを設定
    updateLoadingMessage(category);

    // 3秒ごとにメッセージを更新
    loadingMessageTimer = setInterval(() => {
      updateLoadingMessage(category);
    }, 3500);
  };

  const stopLoadingMessageRotation = () => {
    if (loadingMessageTimer) {
      clearInterval(loadingMessageTimer);
      loadingMessageTimer = null;
    }
  };

  const showLoading = (category = 'default') => {
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('main-content').classList.add('hidden');
    startLoadingMessageRotation(category);
  };

  const hideLoading = () => {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('main-content').classList.remove('hidden');
    stopLoadingMessageRotation();
  };

  // =================================================================
  // --- General Utilities ---
  // -----------------------------------------------------------------
  // 日付のフォーマット、モーダルダイアログなど、
  // アプリ全体で汎用的に使用されるヘルパー関数群です。
  // =================================================================
  const formatDate = dStr => {
    if (!dStr) return '';
    const d = new Date(dStr);
    if (isNaN(d)) return '';
    d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
    const day = d.getDay();
    const wd = ['日', '月', '火', '水', '木', '金', '土'];
    return `${d.getMonth() + 1}/${d.getDate()} <span class="font-bold ${day === 0 ? 'text-ui-weekend-sunday' : day === 6 ? 'text-ui-weekend-saturday' : ''}">${wd[day]}</span>`;
  };
  const showModal = c => {
    const m = document.getElementById('custom-modal'),
      b = document.getElementById('modal-buttons');
    b.innerHTML = '';
    if (c.showCancel) {
      b.innerHTML += Components.createButton({
        text: c.cancelText || 'キャンセル',
        action: 'modalCancel',
        colorClass: DesignConfig.colors.secondary,
        widthClass: DesignConfig.buttons.auto,
      });
    }
    if (c.confirmText) {
      b.innerHTML += `<div class="w-3"></div>${Components.createButton({ text: c.confirmText, action: 'modalConfirm', colorClass: c.confirmColorClass, widthClass: DesignConfig.buttons.auto, disabled: c.disableConfirm })}`;
    }
    onConfirmCallback = c.onConfirm;
    document.getElementById('modal-title').textContent = c.title;
    document.getElementById('modal-message').innerHTML = c.message;
    m.classList.add('active');
  };
  const hideModal = () => {
    document.getElementById('custom-modal').classList.remove('active');
    onConfirmCallback = null;
  };
  const showInfo = (msg, t = '情報', cb = null) =>
    showModal({
      title: t,
      message: msg,
      confirmText: 'OK',
      confirmColorClass: DesignConfig.colors.primary,
      onConfirm: cb,
    });
  const showConfirm = c => showModal({ ...c, showCancel: true });

  // =================================================================
  // --- Date and Slot Utilities ---
  // -----------------------------------------------------------------
  // 日付やスロット操作に関する共通ユーティリティ関数群です。
  // =================================================================

  /**
   * 指定された教室の、今日以降の空きスロットをフィルタリングします。
   * @param {Array} slots - 全スロットの配列
   * @param {string} classroom - 教室名
   * @returns {Array} フィルタリングされたスロット配列
   */
  const filterFutureAvailableSlots = (slots, classroom) => {
    if (!slots || !classroom) return [];

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    return slots.filter(s => {
      const slotDate = new Date(s.date);
      slotDate.setMinutes(slotDate.getMinutes() + slotDate.getTimezoneOffset());
      return s.classroom === classroom && slotDate >= today && !s.isFull && s.session !== '初回講習';
    });
  };

  /**
   * スロットを月別にグループ化します。
   * @param {Array} slots - スロットの配列
   * @returns {Object} 月をキーとしたスロットのオブジェクト
   */
  const groupSlotsByMonth = slots => {
    return slots.reduce((acc, slot) => {
      const month = new Date(slot.date).getMonth() + 1;
      if (!acc[month]) acc[month] = [];
      acc[month].push(slot);
      return acc;
    }, {});
  };

  // =================================================================
  // --- Accounting Cache Utilities ---
  // -----------------------------------------------------------------
  // FE-14: 会計入力内容をlocalStorageに一時保存する機能
  // =================================================================

  /**
   * 会計入力のキャッシュデータをlocalStorageに保存する
   * @param {string} reservationId - 予約ID
   * @param {object} accountingData - 保存する会計データオブジェクト
   */
  function saveAccountingCache(reservationId, accountingData) {
    if (!reservationId || !accountingData) return;
    const cacheKey = `accounting_cache_${reservationId}`;
    try {
      localStorage.setItem(cacheKey, JSON.stringify(accountingData));
    } catch (e) {
      console.error('Failed to save accounting cache:', e);
    }
  }

  /**
   * localStorageから会計入力のキャッシュデータを読み込む
   * @param {string} reservationId - 予約ID
   * @returns {object|null} - 読み込んだ会計データオブジェクト、またはnull
   */
  function loadAccountingCache(reservationId) {
    if (!reservationId) return null;
    const cacheKey = `accounting_cache_${reservationId}`;
    try {
      const cachedData = localStorage.getItem(cacheKey);
      return cachedData ? JSON.parse(cachedData) : null;
    } catch (e) {
      console.error('Failed to load accounting cache:', e);
      return null;
    }
  }

  /**
   * localStorageから会計入力のキャッシュデータを削除する
   * @param {string} reservationId - 予約ID
   */
  function clearAccountingCache(reservationId) {
    if (!reservationId) return;
    const cacheKey = `accounting_cache_${reservationId}`;
    try {
      localStorage.removeItem(cacheKey);
    } catch (e) {
      console.error('Failed to clear accounting cache:', e);
    }
  }

  // =================================================================
  // --- Accounting Calculation Logic ---
  // -----------------------------------------------------------------
  // 会計画面での複雑な料金計算ロジックです。
  // 授業料、材料費、割引などを動的に計算し、合計金額を算出します。
  // =================================================================
  function calculateAccountingDetails() {
    if (!appState.accountingMaster) return null;
    let tuitionSubtotal = 0;
    let salesSubtotal = 0;
    const details = {
      tuition: { items: [] },
      sales: { items: [] },
      grandTotal: 0,
      paymentMethod: '',
      items: [],
    };
    const form = document.getElementById('accounting-form');
    if (!form) return null;

    const r = appState.accountingReservation;
    const classroomRule = appState.accountingMaster.find(
      item => item['対象教室'] && item['対象教室'].includes(r.classroom) && item['種別'] === '授業料',
    );
    const isTimeBased = classroomRule && classroomRule['単位'] === '30分';
    let tuitionBreakdownHtml = '';

    if (isTimeBased) {
      const startTime = document.getElementById('start-time')?.value;
      const endTime = document.getElementById('end-time')?.value;
      const breakMinutes = parseInt(document.getElementById('break-time')?.value || 0, 10);

      if (startTime && endTime && startTime < endTime) {
        const start = new Date(`1970-01-01T${startTime}:00`);
        const end = new Date(`1970-01-01T${endTime}:00`);
        let diffMinutes = (end - start) / 60000 - breakMinutes;

        if (diffMinutes > 0) {
          const billableUnits = Math.ceil(diffMinutes / 30);
          const price = billableUnits * Number(classroomRule['単価']);
          tuitionSubtotal += price;
          //【FE-16】項目名に利用時間を追加
          const tuitionItem = { name: `授業料 (${startTime} - ${endTime})`, price: price };
          details.tuition.items.push(tuitionItem);
          document.getElementById('calculated-hours').textContent =
            `受講時間: ${billableUnits * 0.5}時間 × ${2.0 * classroomRule['単価']}円`;
        } else {
          document.getElementById('calculated-hours').textContent = ``;
        }
      }
    }

    form.querySelectorAll('input[type="checkbox"].accounting-item').forEach(cb => {
      if (cb.checked || cb.disabled) {
        const itemName = cb.dataset.itemName;
        const itemType = cb.dataset.itemType;
        const masterItem = appState.accountingMaster.find(m => m['項目名'] === itemName && m['種別'] === itemType);
        if (!masterItem) return;
        const price = Number(masterItem['単価']);
        const itemDetail = { name: itemName, price: price };
        details.items.push(itemDetail);

        if (itemType === '授業料') {
          tuitionSubtotal += price;
          details.tuition.items.push(itemDetail);
          tuitionBreakdownHtml += `<div class="flex justify-between"><span>${itemDetail.name}</span><span>${itemDetail.price.toLocaleString()}円</span></div>`;
        } else {
          salesSubtotal += price;
          details.sales.items.push(itemDetail);
        }
      }
    });

    const discountSelector = document.getElementById('discount-selector');
    if (discountSelector) {
      const discountRule = appState.accountingMaster.find(item => item['項目名'] === '初回講習同時間割引');
      if (discountRule) {
        const discountMinutes = parseInt(discountSelector.value, 10);
        if (discountMinutes > 0) {
          const discountAmount = (discountMinutes / 30) * Math.abs(Number(discountRule['単価']));
          tuitionSubtotal -= discountAmount;
          const discountItem = {
            name: `初回講習同時間割引 (${discountMinutes}分)`,
            price: -discountAmount,
          };
          details.tuition.items.push(discountItem);
          tuitionBreakdownHtml += `<div class="flex justify-between text-red-600"><span>${discountItem.name}</span><span>${discountItem.price.toLocaleString()}円</span></div>`;
        }
      }
    }

    if (isTimeBased) document.getElementById('tuition-breakdown').innerHTML = tuitionBreakdownHtml;

    const materialContainer = document.getElementById('materials-container');
    if (materialContainer) {
      const materialRows = materialContainer.querySelectorAll('div[data-material-row-index]');
      materialRows.forEach((row, index) => {
        const type = document.getElementById(`material-type-${index}`)?.value;
        const masterItem = appState.accountingMaster.find(m => m['項目名'] === type);
        const priceEl = document.getElementById(`material-price-${index}`);
        if (!masterItem) {
          if (priceEl) priceEl.textContent = '0円';
          return;
        }
        const unitPrice = Number(masterItem['単価']);
        let finalName = type;
        let price = 0;
        if (masterItem['単位'] === 'cm³') {
          const l = document.getElementById(`material-l-${index}`)?.value || 0;
          const w = document.getElementById(`material-w-${index}`)?.value || 0;
          const h = document.getElementById(`material-h-${index}`)?.value || 0;
          if (l > 0 && w > 0 && h > 0) {
            const volumeCm = (l / 10) * (w / 10) * (h / 10);
            let calculatedPrice = Math.round((volumeCm * unitPrice) / 100) * 100;
            price = Math.max(100, calculatedPrice);
            finalName = `${type} (${l}x${w}x${h}mm)`;
          }
        } else {
          if (type) price = unitPrice;
        }
        if (priceEl) priceEl.textContent = `${price.toLocaleString()}円`;
        if (price > 0) {
          const itemDetail = { name: finalName, price: price };
          salesSubtotal += price;
          details.sales.items.push(itemDetail);
        }
      });
    }
    const otherSalesContainer = document.getElementById('other-sales-container');
    if (otherSalesContainer) {
      const otherSalesRows = otherSalesContainer.querySelectorAll('div[data-other-sales-row]');
      otherSalesRows.forEach((row, index) => {
        const name = document.getElementById(`other-sales-name-${index}`)?.value.trim();
        const priceInput = document.getElementById(`other-sales-price-${index}`);
        let priceValue = priceInput.value
          .replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xfee0))
          .replace(/[^0-9.-]/g, '');
        priceInput.value = priceValue;
        const price = Number(priceValue || 0);
        if (name && price !== 0) {
          const itemDetail = { name: name, price: price };
          salesSubtotal += price;
          details.sales.items.push(itemDetail);
        }
      });
    }
    details.tuition.subtotal = tuitionSubtotal;
    details.sales.subtotal = salesSubtotal;
    details.grandTotal = tuitionSubtotal + salesSubtotal;
    document.getElementById('tuition-subtotal').textContent = `小計: ${tuitionSubtotal.toLocaleString()}円`;
    document.getElementById('sales-subtotal').textContent = `小計: ${salesSubtotal.toLocaleString()}円`;
    document.getElementById('grand-total-amount').textContent = `合計: ${details.grandTotal.toLocaleString()}円`;
    details.paymentMethod = form.querySelector('input[name="payment-method"]:checked')?.value || '現金';
    return details;
  }

    // ========== /12_WebApp_Core.html ==========

    // ========== 13_WebApp_Views.html ==========

  /**
   * =================================================================
   * 【ファイル名】: 13_WebApp_Views.html
   * 【バージョン】: 1.9
   * 【役割】: WebAppの各画面（ビュー）のHTML構造を生成する関数群を集約します。
   * - 各関数は特定の画面（ログイン、予約一覧など）のUI構築を担当します。
   * - appStateの現在の状態に基づき、動的にHTMLを生成します。
   * 【構成】: 14ファイル構成でのビュー管理
   * 【v1.9での変更点】:
   * - FE-14: 会計画面の入力保持機能を実装。
   *   - getAccountingViewでキャッシュされたデータをフォームの初期値として設定するよう修正。
   * =================================================================
   */

  // =================================================================
  // --- View Helper Components ---
  // -----------------------------------------------------------------
  // 各ビューを構成するための、より小さな部品を生成するヘルパー関数群。
  // =================================================================

  /**
   * 電話番号を 090 1234 5678 のような形式で表示する
   */
  function formatPhoneDisplay(phone) {
    const digits = String(phone).replace(/[^0-9]/g, '');
    return `${digits.slice(0, 3)} ${digits.slice(3, 7)} ${digits.slice(7)}`;
  }

  /**
   * 時刻選択用の<option>タグ群を生成します。
   * @param {number} startHour - 開始時刻（時）
   * @param {number} endHour - 終了時刻（時）
   * @param {number} step - 間隔（分）
   * @param {string | null} selectedValue - 事前に選択する時刻 (HH:mm)
   * @returns {string} HTMLの<option>タグ文字列
   */
  const getTimeOptionsHtml = (startHour, endHour, step, selectedValue) => {
    let options = [];
    for (let h = startHour; h <= endHour; h++) {
      for (let m = 0; m < 60; m += step) {
        const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        options.push(`<option value="${time}" ${time === selectedValue ? 'selected' : ''}>${time}</option>`);
      }
    }
    return options.join('');
  };

  /**
   * 割引選択用のUIを生成します。
   * @param {object} discountRule - 料金マスタから取得した割引ルールオブジェクト
   * @param {string} selectedValue - 選択済みの値
   * @returns {string} HTML文字列
   */
  const getDiscountHtml = (discountRule, selectedValue) => {
    if (!discountRule) return '';
    const options = [
      { value: 0, text: 'なし' },
      { value: 30, text: `30分 (${Math.abs(Number(discountRule['単価']))}円引)` },
      { value: 60, text: `60分 (${Math.abs(Number(discountRule['単価'])) * 2}円引)` },
    ];
    return `
        <div class="mt-4 pt-4 border-t border-ui-border-light">
            <label class="${DesignConfig.text.labelBlock}">${discountRule['項目名']}</label>
            <select id="discount-selector" name="discountMinutes" class="${DesignConfig.inputs.base} p-2 text-base accounting-item">
                ${options.map(o => `<option value="${o.value}" ${String(o.value) === selectedValue ? 'selected' : ''}>${o.text}</option>`).join('')}
            </select>
        </div>`;
  };

  /**
   * 支払い情報（ことら送金、振込先）の表示UIを生成します。
   * @returns {string} HTML文字列
   */
  const getPaymentInfoHtml = () => {
    return `
        <div class="bg-ui-surface border border-ui-border p-3 rounded-md">
            <div class="flex justify-between items-center">
                <div class="${DesignConfig.text.body}"><span class="font-bold">ことら送金:</span><span class="ml-2">09013755977</span></div>
                <button data-action="copyToClipboard" data-copy-text="09013755977" class="flex-shrink-0 text-sm bg-action-secondary-bg active:bg-action-secondary-hover text-action-secondary-text font-bold px-2 py-1 rounded mobile-button">コピー</button>
            </div>
        </div>
        <div class="bg-ui-surface border border-ui-border p-3 rounded-md">
            <div class="text-brand-text"><span class="font-bold">振込先:</span><span class="ml-2">ゆうちょ銀行</span></div>
            <div class="mt-1 flex justify-between items-center">
                <div class="text-base text-brand-text">店番: 818</div>
                <button data-action="copyToClipboard" data-copy-text="818" class="text-sm bg-action-secondary-bg active:bg-action-secondary-hover text-action-secondary-text font-bold px-2 py-1 rounded mobile-button">コピー</button>
            </div>
            <div class="mt-1 flex justify-between items-center">
                <div class="text-base text-brand-text">普通: 2661797</div>
                <button data-action="copyToClipboard" data-copy-text="2661797" class="text-sm bg-action-secondary-bg active:bg-action-secondary-hover text-action-secondary-text font-bold px-2 py-1 rounded mobile-button">コピー</button>
            </div>
        </div>`;
  };

  /**
   * 支払い方法の選択肢（ラジオボタン）UIを生成します。
   * @param {string} selectedValue - 選択済みの支払い方法
   * @returns {string} HTML文字列
   */
  const getPaymentOptionsHtml = selectedValue => {
    const cotraDetails = `
        <details class="mt-2 ml-6">
            <summary class="inline-block px-2 py-1 bg-ui-warning-light text-ui-warning-text text-sm font-semibold rounded-md active:bg-ui-warning-bg">
                ことら送金とは？ <span class="arrow">▼</span>
            </summary>
            <p class="mt-2 p-2 bg-ui-warning-bg rounded-md text-sm text-left text-brand-subtle">
                電話番号だけで銀行口座間で送金できるサービスです。手数料無料。対応の銀行アプリから利用できます。<br>
                (例：ゆうちょ通帳アプリ、三井住友銀行アプリ、住信SBIネット銀行アプリなど)
                <a href="https://www.cotra.ne.jp/member/" target="_blank" class="text-ui-link-text">対応アプリ一覧</a>
            </p>
        </details>`;
    const options = [
      { value: '現金', text: '現金', details: '' },
      { value: 'ことら送金', text: 'ことら送金', details: cotraDetails },
      { value: '振込', text: '振込', details: '' },
    ];
    return (
      options
        .map(
          (opt, i) => `
        <div>
            <label class="flex items-center space-x-2 text-brand-text">
                <input type="radio" name="payment-method" value="${opt.value}" class="accounting-item accent-action-primary-bg" ${opt.value === selectedValue ? 'checked' : ''}>
                <span>${opt.text}</span>
            </label>
            ${opt.details}
        </div>`,
        )
        .join('') +
      `
        <div class="mt-4 space-y-2 text-base">${getPaymentInfoHtml()}</div>`
    );
  };

  /**
   * 会計画面の材料入力行を生成します。
   * @param {number} index - 材料行のインデックス
   * @param {object} [data={}] - 初期データ
   * @returns {string} HTML文字列
   */
  const getMaterialRowHtml = (index, data = {}) => {
    const materialOptions = appState.accountingMaster
      .filter(m => m['種別'] === '材料')
      .map(m => `<option value="${m['項目名']}" ${data.type === m['項目名'] ? 'selected' : ''}>${m['項目名']}</option>`)
      .join('');
    return `
        <div data-material-row-index="${index}">
            <div class="grid grid-cols-1 gap-y-2">
                <select id="material-type-${index}" name="materialType${index}" class="${DesignConfig.inputs.base} accounting-item">
                    <option value="">-- 樹種を選択 --</option>
                    ${materialOptions}
                </select>
            </div>
            <div class="grid grid-cols-4 gap-2 mt-2 items-center">
                <input type="number" id="material-l-${index}" name="materialL${index}" value="${data.l || ''}" placeholder="縦(mm)" step="5" class="${DesignConfig.inputs.base} accounting-item custom-placeholder">
                <input type="number" id="material-w-${index}" name="materialW${index}" value="${data.w || ''}" placeholder="横(mm)" step="5" class="${DesignConfig.inputs.base} accounting-item custom-placeholder">
                <input type="number" id="material-h-${index}" name="materialH${index}" value="${data.h || ''}" placeholder="厚(mm)" step="5" class="${DesignConfig.inputs.base} accounting-item custom-placeholder">
                <div id="material-price-${index}" class="text-right text-base text-brand-subtle">0円</div>
            </div>
        </div>`;
  };

  /**
   * 会計画面の「その他販売品」入力行を生成します。
   * @param {number} index - 入力行のインデックス
   * @param {object} [data={}] - 初期データ
   * @returns {string} HTML文字列
   */
  const getOtherSalesRowHtml = (index, data = {}) => {
    return `
        <div data-other-sales-row="${index}" class="mt-2 pt-2 border-t border-ui-border grid grid-cols-3 gap-2 items-center">
            <input type="text" id="other-sales-name-${index}" name="otherSalesName${index}" value="${data.name || ''}" placeholder="商品名" class="col-span-2 ${DesignConfig.inputs.base} accounting-item">
            <input type="text" inputmode="decimal" id="other-sales-price-${index}" name="otherSalesPrice${index}" value="${data.price || ''}" placeholder="金額" class="${DesignConfig.inputs.base} accounting-item">
        </div>`;
  };

  /**
   * 予約・履歴カード用の共通カード構造を生成します。
   * @param {object} config - カード設定オブジェクト
   * @returns {string} HTML文字列
   */
  const createReservationCard = config => {
    const {
      type, // 'booking' | 'history'
      item,
      today,
      buttons = [],
    } = config;

    const isBooking = type === 'booking';
    const venueText = item.venue || '';
    const isPastOrToday = isBooking ? new Date(item.date).getTime() <= today.getTime() : true;

    // 時刻表示の生成
    let timeText = '';
    if (item.startTime && item.endTime) {
      timeText = `<span>${item.startTime} - ${item.endTime}</span>`;
    }

    let cardColorClass = 'bg-ui-surface border border-ui-border';
    if (isBooking) {
      const cardColor = item.isWaiting ? DesignConfig.cards.state.waitlist : DesignConfig.cards.state.booked;
      cardColorClass = cardColor.card;
    } else if (type === 'history') {
      cardColorClass = DesignConfig.cards.state.history.card;
    }

    // 制作メモ部分の背景色
    const memoBackgroundClass = isBooking ? 'bg-ui-surface' : 'bg-ui-surface';

    // ステータス表示（予約のみ）
    let statusBadges = '';
    if (isBooking) {
      if (item.firstLecture) {
        statusBadges += `<p class="font-bold text-action-attention-bg text-lg">初回講習</p>`;
      }
      if (item.isWaiting) {
        statusBadges += `<p class="font-bold ${DesignConfig.cards.state.waitlist.text} text-lg">キャンセル待ち</p>`;
      }
    }

    // ボタン部分の生成
    const buttonsHtml = buttons
      .map(btn =>
        Components.createButton({
          action: btn.action,
          classroom: btn.classroom || item.classroom,
          reservationId: btn.reservationId || item.reservationId,
          date: btn.date || item.date,
          sheetName: btn.sheetName || item.sheetName,
          details: btn.details,
          text: btn.text,
          colorClass: btn.colorClass,
        }),
      )
      .join('');

    return `
      <div class="${cardColorClass || 'bg-ui-surface border border-ui-border'} p-3 rounded-lg flex flex-col space-y-3">
        <div class="flex-shrink-0">
          <div >
            <span class="text-brand-text font-bold text-base sm:text-xl">${formatDate(item.date || '')} </span>
            <span class="text-brand-text text-base time-display">${timeText || ''}</span>
          </div>
          <p class="text-brand-text font-bold text-base break-words">${item.classroom || ''} ${venueText || ''}</p>
          ${statusBadges || ''}
        </div>
        <div class="${memoBackgroundClass || 'bg-ui-surface'} p-3 rounded-md w-full border border-ui-border">
          <div class="w-full min-h-[3rem] flex items-start">
            <p class="text-base text-brand-text whitespace-pre-wrap break-words w-full leading-relaxed">${item.workInProgress != null && item.workInProgress !== '' ? item.workInProgress : `<span class="text-brand-muted">制作メモ</span>`}</p>
          </div>
        </div>
        ${buttonsHtml ? `<div class="flex justify-end items-center space-x-2 flex-shrink-0">${buttonsHtml}</div>` : ''}
      </div>
    `;
  };

  /**
   * 参加記録編集用のモーダルウィンドウの中身を生成します。
   * @param {object} item - 編集対象の履歴オブジェクト
   * @returns {string} HTML文字列
   */
  const getMemoEditModalHtml = item => {
    return `
        <p class="text-base ${DesignConfig.colors.textSubtle} mb-4">${formatDate(item.date)}  ${item.classroom}</p>
        <textarea id="memo-edit-textarea" class="${DesignConfig.inputs.textarea} h-32" placeholder="制作メモを入力…">${item.workInProgress || ''}</textarea>
    `;
  };

  /**
   * 時間制教室の授業料計算UIを生成します。
   * @param {object} rule - 料金マスタから取得した教室ルール
   * @param {object} initial - 初期値（開始時刻など）
   * @returns {string} HTML文字列
   */
  const getTimeBasedTuitionHtml = (rule, initial) => {
    if (
      !rule ||
      typeof rule['講座開始'] !== 'string' ||
      typeof rule['講座終了'] !== 'string' ||
      !rule['講座開始'].includes(':') ||
      !rule['講座終了'].includes(':')
    ) {
      return `<div class="text-ui-error-text p-4 bg-ui-error-bg rounded-lg">エラー: この教室の講座時間がマスタに正しく設定されていません。</div>`;
    }
    const classStart = parseInt(rule['講座開始'].split(':')[0]);
    const classEnd = parseInt(rule['講座終了'].split(':')[0]);
    const endBuffer = 3;

    const breakOptions = [...Array(5).keys()]
      .map(
        i =>
          `<option value="${i * 30}" ${String(i * 30) === (initial.breakTime || '0') ? 'selected' : ''}>${i * 30}分</option>`,
      )
      .join('');

    const startTimeOptions = getTimeOptionsHtml(classStart, classEnd + endBuffer, 30, initial.startTime);
    const endTimeOptions = getTimeOptionsHtml(classStart, classEnd + endBuffer, 30, initial.endTime);

    const rentalChecked = initial.chiselRental || initial['彫刻刀レンタル'] === true ? 'checked' : '';

    const discountRule = appState.accountingMaster.find(item => item['項目名'] === ITEM_NAME_DISCOUNT);
    const discountHtml = discountRule
      ? `<div class="mt-4 pt-4 border-t border-gray-200">${getDiscountHtml(discountRule, initial.discountMinutes || '0')}<p class="text-sm ${DesignConfig.colors.textSubtle} mt-2 text-left">${discountRule.説明 || '初回講習と同時刻に参加の場合、30分あたり¥300割引。ただし、初回講習参加者がいる場合のみ'}</p></div>`
      : '';

    return `
        <div class="p-4 ${DesignConfig.cards.background} rounded-lg space-y-3">
            <h3 class="${DesignConfig.text.heading} mb-2">授業料</h3>
            <div class="grid grid-cols-3 gap-2 items-end">
                ${Components.createSelect({ id: 'start-time', name: 'startTime', label: '開始時刻', containerClass: 'col-span-1', options: startTimeOptions })}
                ${Components.createSelect({ id: 'end-time', name: 'endTime', label: '終了時刻', containerClass: 'col-span-1', options: endTimeOptions })}
                ${Components.createSelect({ id: 'break-time', name: 'breakTime', label: '休憩時間', containerClass: 'col-span-1', options: breakOptions })}
            </div>
            <div id="calculated-hours" class="text-left text-base ${DesignConfig.colors.textSubtle} mt-2"></div>
            <div class="pt-3 mt-3 border-t border-gray-200">
                <label class="flex items-center justify-between">
                    <span class="text-brand-text">彫刻刀レンタル</span>
                    <input type="checkbox" name="chiselRental" data-item-type="授業料" data-item-name="彫刻刀レンタル" class="accounting-item h-5 w-5 rounded border-ui-border text-brand-text focus:ring-brand-text" ${rentalChecked}>
                </label>
            </div>
            ${discountHtml}
            <div id="tuition-breakdown" class="mt-4 pt-4 border-t border-ui-border space-y-1 text-base ${DesignConfig.colors.textSubtle}"></div>
            <div class="text-right font-bold mt-2" id="tuition-subtotal">小計: 0円</div>
        </div>`;
  };

  // =================================================================
  // --- Main Application Views ---
  // -----------------------------------------------------------------
  // アプリケーションの各画面の完全なHTML構造を生成する関数群。
  // =================================================================

  /**
   * ログイン画面のUIを生成します。
   * @returns {string} HTML文字列
   */
  const getLoginView = () => {
    const phoneValue = appState.loginPhone || '';
    return `
      <div class="text-center pt-8 pb-4">
          <h1 class="text-3xl font-bold text-brand-text tracking-tight">きぼりの<br>よやく・きろく</h1>
          <h2 class="text-xl text-brand-subtle mt-2 mb-10">川崎誠二 木彫り教室</h2>
      </div>
      ${Components.createInput({ id: 'phone', label: '電話番号', type: 'tel', placeholder: '090 1234 5678', containerClass: DesignConfig.inputs.container, autocomplete: 'tel', isSrOnly: false, labelClass: `block text-brand-subtle text-sm text-center mb-1`, inputClass: 'text-center', inputmode: 'numeric', pattern: '[0-9]*', value: phoneValue })}
      <p id="phone-display" class="text-brand-subtle text-lg mt-2">${formatPhoneDisplay(phoneValue)}</p>
      <div class="mt-6 flex justify-center">
          <div class="${DesignConfig.inputs.container}">
              ${Components.createButton({ text: 'ログイン または 新規登録', action: 'login', colorClass: DesignConfig.colors.primary, widthClass: DesignConfig.buttons.full })}
          </div>
      </div>`;
  };

  /**
   * ユーザー情報入力フォーム（新規登録・プロフィール編集共通）
   * @param {Object} config - 設定オブジェクト
   * @param {string} config.mode - 'register' または 'edit'
   * @param {string} [config.phone] - 電話番号（新規登録時）
   * @returns {string} HTML文字列
   */
  const getUserFormView = config => {
    const { mode, phone } = config;
    const isEdit = mode === 'edit';
    const u = appState.currentUser || {};

    // 入力値の保持: 新規登録Step1ではappState.registrationDataを参照
    let regData = appState.registrationData || {};
    const realNameValue = isEdit ? u.realName || '' : regData.realName || '';
    const nicknameValue = isEdit ? u.displayName || '' : regData.nickname || '';
    const phoneValue = isEdit ? appState.phoneForRegistration || u.phone || '' : regData.phone || phone || '';

    // 電話番号表示の判定
    const isPhoneInputNeeded = isEdit && (appState.phoneForRegistration || !u.phone);

    // タイトルと説明文
    const title = isEdit ? 'プロフィール編集' : '新規登録';
    const description = isEdit ? '' : '<p class="text-brand-subtle mb-6">お名前を登録してください。</p>';

    // 電話番号セクション
    let phoneSection = '';
    if (!isEdit) {
      // 新規登録時：電話番号を表示のみ
      phoneSection = `
        <div class="mb-4">
            <label class="block text-brand-text text-base font-bold mb-2">電話番号</label>
            <input type="tel" id="reg-phone" value="${phoneValue}" class="${DesignConfig.inputs.base}" placeholder="090 1234 5678" autocomplete="tel" inputmode="numeric" pattern="[0-9]*">
            <p id="reg-phone-display" class="text-brand-subtle text-lg mt-2">${formatPhoneDisplay(phoneValue)}</p>
        </div>`;
    } else if (isPhoneInputNeeded) {
      // プロフィール編集時：電話番号入力が必要
      phoneSection = `
        <div class="mb-4">
            <label for="edit-phone" class="block text-brand-text text-base font-bold mb-2">電話番号</label>
            <input type="tel" id="edit-phone" value="${phoneValue}"
                   class="${DesignConfig.inputs.base}" placeholder="090 1234 5678"
                   autocomplete="tel" inputmode="numeric" pattern="[0-9]*">
            <p class="text-sm text-brand-subtle mt-1">電話番号を登録すると次回からスムーズにログインできます。</p>
        </div>`;
    } else {
      // プロフィール編集時：電話番号表示のみ
      phoneSection = `
        <div class="mb-4">
            <label class="block text-brand-text text-base font-bold mb-2">電話番号</label>
            <p class="font-semibold p-3 bg-ui-surface text-brand-text rounded-lg w-auto inline-block">${phoneValue}</p>
        </div>`;
    }

    // ボタン設定
    const buttons = isEdit
      ? [
          { text: 'この内容で更新', action: 'saveProfile', colorClass: DesignConfig.colors.primary },
          { text: '戻る', action: 'goBackToClassroomSelect', colorClass: DesignConfig.colors.secondary },
        ]
      : [
          { text: '次へ進む', action: 'goToStep2', colorClass: DesignConfig.colors.primary },
          { text: '戻る', action: 'goBackToLogin', colorClass: DesignConfig.colors.secondary },
        ];

    const nameIdPrefix = isEdit ? 'edit' : 'reg';

    return `
        <div class="max-w-md mx-auto">
            <h1 class="text-xl font-bold text-brand-text mb-4">${title}</h1>
            ${description}
            <div class="space-y-4">
                ${Components.createInput({
                  id: `${nameIdPrefix}-realname`,
                  label: 'お名前（本名 必須項目）',
                  type: 'text',
                  required: true,
                  value: realNameValue,
                  containerClass: '',
                  autocomplete: 'name',
                })}
                ${Components.createInput({
                  id: `${nameIdPrefix}-nickname`,
                  label: 'ニックネーム（表示名 他の生徒さんにも表示されます）',
                  type: 'text',
                  value: nicknameValue,
                  placeholder: '空欄の場合は本名',
                  containerClass: '',
                })}
                ${phoneSection}
            </div>
            <div class="mt-6">
                <div class="space-y-3">
                    ${buttons
                      .map(btn =>
                        Components.createButton({
                          text: btn.text,
                          action: btn.action,
                          colorClass: btn.colorClass,
                          widthClass: DesignConfig.buttons.full,
                        }),
                      )
                      .join('')}
                </div>
            </div>
        </div>`;
  };

  /**
   * 新規登録画面のUIを生成します。
   * @param {string} p - ログイン試行時に入力された電話番号
   * @returns {string} HTML文字列
   */
  const getRegisterView = p => getUserFormView({ mode: 'register', phone: p });

  /**
   * 新規登録フローのステップ2（プロフィール情報）のUIを生成します。
   */
  const getRegistrationStep2View = () => {
    console.log('getRegistrationStep2View called');
    console.log('DesignConfig:', typeof DesignConfig, DesignConfig);
    console.log('Components:', typeof Components, Components); // Componentsのログを追加
    const data = appState.registrationData;
    const genderOptions = ['女性', '男性', 'その他']
      .map(
        opt =>
          `<label class="flex items-center space-x-2"><input type="radio" name="gender" value="${opt}" ${data.gender === opt ? 'checked' : ''}><span class="text-brand-text">${opt}</span></label>`,
      )
      .join('');
    const handOptions = ['右利き', '左利き', '両利き']
      .map(
        opt =>
          `<label class="flex items-center space-x-2"><input type="radio" name="dominantHand" value="${opt}" ${data.dominantHand === opt ? 'checked' : ''}><span class="text-brand-text">${opt}</span></label>`,
      )
      .join('');
    const ageOptions = ['10代（16歳以上）', '20代', '30代', '40代', '50代', '60代', '70代', '80代以上', 'ひみつ']
      .map(opt => `<option value="${opt}" ${data.ageGroup === opt ? 'selected' : ''}>${opt}</option>`)
      .join('');

    return `
    <div class="max-w-md mx-auto text-left">
      <h1 class="text-xl font-bold text-brand-text mb-4 text-center">プロフィール</h1>
      <form id="step2-form" class="space-y-6">
        ${Components.createInput({ id: 'q-email', label: 'メールアドレス（必須）', type: 'email', value: data.email || '', required: true })}
        <div class="p-3 bg-ui-surface rounded-md">
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="q-wants-email" name="wantsEmail" class="h-5 w-5 accent-action-primary-bg" ${data.wantsEmail ? 'checked' : ''}>
            <span class="text-brand-text text-sm">今後の教室日程などの、メール連絡を希望します</span>
          </label>
        </div>
        ${Components.createSelect({ id: 'q-age-group', label: 'お年頃', options: ageOptions })}
        <div><label class="block text-brand-text text-base font-bold mb-2">性別</label><div class="flex space-x-4">${genderOptions}</div></div>
        <div><label class="block text-brand-text text-base font-bold mb-2">利き手</label><div class="flex space-x-4">${handOptions}</div></div>
        ${Components.createInput({ id: 'q-address', label: '住所（市区町村まででOK！）', type: 'text', value: data.address || '' })}
      </form>
      <div class="mt-8 grid grid-cols-2 gap-3">
        ${Components.createButton({ text: '前に戻る', action: 'backToStep1', colorClass: DesignConfig.colors.secondary })}
        ${Components.createButton({ text: '次へ進む', action: 'goToStep3', colorClass: DesignConfig.colors.primary })}
      </div>
    </div>
  `;
  };

  /**
   * 新規登録フローのステップ3（木彫りについて）のUIを生成します。
   */
  const getRegistrationStep3View = () => {
    const data = appState.registrationData;
    const experienceOptions = ['はじめて！', 'ちょっと', 'そこそこ', 'かなり！']
      .map(
        opt =>
          `<label class="flex items-center space-x-2"><input type="radio" name="experience" value="${opt}" ${data.experience === opt ? 'checked' : ''}><span class="text-brand-text">${opt}</span></label>`,
      )
      .join('');

    return `
    <div class="max-w-md mx-auto text-left">
      <h1 class="text-xl font-bold text-brand-text mb-4 text-center">木彫りについて</h1>
      <form id="step3-form" class="space-y-6">
        <div>
          <label class="block text-brand-text text-base font-bold mb-2">木彫りの経験はありますか？</label>
          <div class="space-y-2" id="experience-radio-group">${experienceOptions}</div>
        </div>
        <div id="past-work-container" class="${data.experience === 'はじめて！' ? 'hidden' : ''}">
            ${Components.createTextArea({ id: 'q-past-work', label: 'いつ頃、どこで、何を作りましたか？（だいたいでOK!）', value: data.pastWork || '' })}
        </div>
        ${Components.createTextArea({ id: 'q-future-goal', label: '将来的に制作したいもの（曖昧な内容でも大丈夫！）', value: data.futureGoal || '' })}
      </form>
      <div class="mt-8 flex flex-col space-y-3">
        ${Components.createButton({ text: '登録して予約へ進む', action: 'submitRegistration', colorClass: DesignConfig.colors.primary, widthClass: DesignConfig.buttons.full })}
        ${Components.createButton({ text: '前に戻る', action: 'backToStep2', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
      </div>
    </div>
  `;
  };

  /**
   * NF-01: 電話番号未登録ユーザーの検索・選択画面のUIを生成します。
   * @returns {string} HTML文字列
   */
  const getNoPhoneUserSelectView = () => {
    const users = appState.noPhoneUsers;
    // NF-01: 検索が実行され、結果が0件の場合にメッセージを表示
    const hasSearchedAndNoResults = appState.searchAttempted && users.length === 0;

    return `
        <h1 class="text-xl font-bold text-brand-text mb-4">アカウントを探す</h1>
        <p class="text-brand-subtle mb-6">お名前（本名）またはニックネームを入力して、あなたのアカウントを見つけてください。<br>
        <span class="text-sm text-brand-muted">（漢字が異なる場合や、姓と名の間が開いている場合でも、スペースを入れずに、苗字だけでも試してみてください）</span></p>

        <div class="${DesignConfig.inputs.container} mb-4">
            ${Components.createInput({
              id: 'nickname-search-input',
              label: 'お名前（本名）またはニックネーム', // ラベルを変更
              type: 'text',
              placeholder: 'お名前またはニックネーム', // プレースホルダーを変更
              inputClass: 'text-center',
              autocomplete: 'off',
            })}
            <div class="mt-4 flex justify-center">
                ${Components.createButton({
                  text: '検索',
                  action: 'searchNoPhoneUser',
                  colorClass: DesignConfig.colors.primary,
                  widthClass: DesignConfig.buttons.full,
                })}
            </div>
        </div>

        <div class="mt-8 space-y-3">
            ${
              users.length > 0
                ? `
                <h2 class="text-lg font-bold ${DesignConfig.colors.text} text-center mb-2">見つかったアカウント</h2>
                ${users
                  .map(
                    user => `
                    <div class="${DesignConfig.cards.background} p-3 rounded-lg flex justify-between items-center">
                        <p class="text-base font-semibold">${user.realName}（${user.nickname}）</p> // 本名とニックネームを両方表示
                        ${Components.createButton({
                          text: 'これだ！',
                          action: 'selectNoPhoneUser',
                          studentId: user.studentId,
                          realName: user.realName,
                          nickname: user.nickname,
                          colorClass:
                            'bg-state-success-bg text-state-success-text text-sm py-1 px-3 rounded active:bg-state-success-hover focus:bg-state-success-hover mobile-button',
                        })}
                    </div>
                `,
                  )
                  .join('')}
            `
                : hasSearchedAndNoResults
                  ? `
                <p class="text-center ${DesignConfig.colors.textSubtle}">一致するアカウントが見つかりませんでした。</p>
            `
                  : ''
            }
        </div>

        <div class="mt-8 pt-4 border-t border-gray-200 flex flex-col space-y-3">
            <h2 class="text-lg font-bold ${DesignConfig.colors.text} text-center mb-2">見つからない場合</h2>
            ${Components.createButton({
              text: '自分のアカウントが見つからないので、新規登録する',
              action: 'goToRegisterFromNoPhoneSearch',
              colorClass: DesignConfig.colors.primary,
              widthClass: DesignConfig.buttons.full,
            })}
            ${Components.createButton({
              text: 'ログイン画面に戻る',
              action: 'goBackToLogin',
              colorClass: DesignConfig.colors.secondary,
              widthClass: DesignConfig.buttons.full,
            })}
        </div>
    `;
  };

  /**
   * メインのダッシュボード画面のUIを生成します。
   * ユーザーの予約一覧と履歴一覧を統合表示します。
   * @returns {string} HTML文字列
   */
  const getDashboardView = () => {
    // 【時系列統一】予約と履歴を日付順にソートして統合表示
    // 上ほど未来、下ほど過去になるように配置
    const sortedBookings = [...appState.myBookings].sort((a, b) => new Date(b.date) - new Date(a.date));
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // 【改善】「あたらしく よやく する」ボタンを予約リストの先頭に配置し、デザインを分かりやすく変更
    const newBookingCardHtml = `
        <button data-action="goToNewBookingView" class="w-full text-center p-4 rounded-lg border-2 border-dashed border-action-primary-border bg-action-primary-light active:bg-action-primary-subtle focus:bg-action-primary-subtle mobile-button touch-friendly">
            <span class="text-xl font-bold text-action-primary-bg">+ あたらしく よやく する</span>
        </button>
    `;

    const yourBookingsHtml = `
        <div class="mb-8 w-full">
            <div class="bg-ui-surface border border-ui-border p-3 rounded-lg space-y-3">
                <h2 class="text-xl font-medium text-brand-text text-center mb-2">よやく</h2>
                ${newBookingCardHtml}
                ${sortedBookings
                  .map(b => {
                    const resDate = new Date(b.date);
                    resDate.setMinutes(resDate.getMinutes() + resDate.getTimezoneOffset());
                    const isPastOrToday = resDate.getTime() <= today.getTime();

                    // ボタン配列を構築
                    const buttons = [];

                    // 会計ボタン
                    if (isPastOrToday) {
                      if (b.accountingDone) {
                        buttons.push({
                          action: 'goToAccounting',
                          text: '会計済',
                          colorClass: `${DesignConfig.colors.paid} text-base font-bold px-3 py-1.5 rounded`,
                        });
                      } else {
                        buttons.push({
                          action: 'goToAccounting',
                          text: '会計',
                          colorClass: `text-base ${DesignConfig.colors.accounting} font-bold px-3 py-1.5 rounded mobile-button`,
                        });
                      }
                    }

                    // 編集ボタン
                    if (!isPastOrToday && !b.accountingDone) {
                      buttons.push({
                        action: 'goToEditReservation',
                        text: '編集',
                        colorClass:
                          'text-base bg-action-secondary-bg text-action-secondary-text font-bold px-3 py-1.5 rounded active:bg-action-secondary-hover focus:bg-action-secondary-hover mobile-button',
                      });
                    }

                    // キャンセルボタン
                    if (!b.accountingDone) {
                      buttons.push({
                        action: 'cancel',
                        text: 'cancel',
                        colorClass:
                          'text-base bg-state-danger-bg text-state-danger-text font-bold px-3 py-1.5 rounded active:bg-state-danger-hover focus:bg-state-danger-hover mobile-button',
                      });
                    }

                    return createReservationCard({
                      type: 'booking',
                      item: b,
                      today: today,
                      buttons: buttons,
                    });
                  })
                  .join('')}
            </div>
        </div>`;

    let historyHtml = '';
    if (appState.history && appState.history.length > 0) {
      // 【修正】履歴も新しい順にソート（日付降順）で時系列を統一
      const sortedHistory = [...appState.history].sort((a, b) => new Date(b.date) - new Date(a.date));
      const recordsToShow = sortedHistory.slice(0, appState.recordsToShow || 20);
      historyHtml = `
            <div class="mb-8 w-full">
            <div class="bg-ui-surface border border-ui-border p-3 rounded-lg space-y-3">
                    <h2 class="text-xl font-medium text-brand-text text-center mb-2">きろく</h2>
                    ${recordsToShow
                      .map(h => {
                        // ボタン配列を構築
                        const buttons = [];

                        // 会計記録ボタン
                        if (h.accountingDetails) {
                          try {
                            const acc = JSON.parse(h.accountingDetails);
                            buttons.push({
                              action: 'showHistoryAccounting',
                              details: h.accountingDetails,
                              text: '会計記録',
                              colorClass:
                                'text-sm bg-action-paid-bg text-action-paid-text font-bold px-3 py-1.5 rounded',
                            });
                          } catch (e) {
                            // エラーハンドリングは個別に行う
                          }
                        }

                        // 編集ボタン
                        buttons.push({
                          action: 'editHistoryMemo',
                          text: '編集',
                          colorClass:
                            'text-sm bg-action-secondary-bg text-action-secondary-text font-bold px-3 py-1.5 rounded active:bg-action-secondary-hover focus:bg-action-secondary-hover mobile-button',
                        });

                        return createReservationCard({
                          type: 'history',
                          item: h,
                          today: null, // 履歴では不要
                          buttons: buttons,
                        });
                      })
                      .join('')}
                    ${(appState.recordsToShow || 20) < sortedHistory.length ? `<div class="text-center mt-4"><button data-action="loadMoreHistory" class="text-sm bg-action-secondary-bg text-action-secondary-text px-3 py-1.5 rounded-md active:bg-action-secondary-hover mobile-button">もっとみる</button></div>` : ''}
                </div>
            </div>
        `;
    }

    return `
        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4">
            <h1 class="text-xl sm:text-xl font-bold ${DesignConfig.colors.text} mr-4 mb-2 sm:mb-0">ようこそ <span class="whitespace-nowrap">${appState.currentUser.displayName} さん</span></h1>
            <button data-action="goToEditProfile" class="self-end sm:self-auto text-sm bg-action-secondary-bg text-action-secondary-text px-3 py-1.5 rounded-md active:bg-action-secondary-hover mobile-button">プロフィール編集</button>
        </div>
        ${yourBookingsHtml}
        ${historyHtml}
    `;
  };

  /**
   * 新規予約のための教室選択画面のUIを生成します。
   * @returns {string} HTML文字列
   */
  const getNewBookingView = () => {
    const classroomButtonsHtml = appState.classrooms
      .map(n =>
        Components.createButton({
          action: 'selectClassroom',
          classroomName: n,
          text: n,
          colorClass: `w-full h-16 text-left px-4 py-3 rounded-lg mobile-card touch-friendly transition-all duration-150 bg-state-available-bg border border-state-available-border active:bg-state-success-hover flex items-center text-xl font-bold text-brand-text`,
        }),
      )
      .join('');

    return `
        <h1 class="text-xl font-bold text-brand-text mb-4">あたらしい よやく</h1>
        <p class="text-brand-subtle text-center mb-6">教室 を おえらびください</p>
        <div class="max-w-md mx-auto space-y-3">
            ${classroomButtonsHtml}
        </div>
        <div class="mt-6 max-w-md mx-auto">
            ${Components.createButton({ text: '戻る', action: 'goBackToClassroomSelect', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
        </div>
    `;
  };

  /**
   * プロフィール編集画面のUIを生成します。
   * @returns {string} HTML文字列
   */
  const getEditProfileView = () => getUserFormView({ mode: 'edit' });

  /**
   * 特定の教室の予約枠一覧画面のUIを生成します。
   * @param {string} c - 教室名
   * @returns {string} HTML文字列
   */
  const getBookingView = c => {
    const s = appState.slots.filter(sl => sl.classroom === c && sl.session !== '初回講習');
    if (s.length === 0) {
      return `
            <div class="max-w-md mx-auto">
                <h1 class="text-xl font-bold ${DesignConfig.colors.text} mb-2">${c}</h1>
                <p class="${DesignConfig.colors.textSubtle} mb-6">現在、予約可能な日がありません。</p>
                <div class="mt-6">
                    ${Components.createButton({ text: '教室選択に戻る', action: 'goBackToClassroomSelect', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
                </div>
            </div>`;
    }
    let currentMonth = null;
    const bHtml = s
      .map(sl => {
        const slotDate = new Date(sl.date);
        const month = slotDate.getMonth() + 1;
        let monthHeader = '';
        if (month !== currentMonth) {
          monthHeader = `<h3 class="text-xl font-medium text-brand-subtle mt-6 mb-2 text-center">${month}月</h3>`;
          currentMonth = month;
        }
        const iB = appState.myBookings.some(b => b.date === sl.date && b.classroom === sl.classroom);
        let cC,
          sB,
          tag = 'button',
          act = `data-action="bookSlot" data-classroom="${sl.classroom}" data-date="${sl.date}"`;
        let statusText;
        if (typeof sl.morningSlots !== 'undefined') {
          statusText = `午前 ${sl.morningSlots} | 午後 ${sl.afternoonSlots}`;
        } else {
          statusText = `空き ${sl.availableSlots}`;
        }
        if (iB) {
          if (sl.isWaiting) {
            cC = `${DesignConfig.cards.base} ${DesignConfig.cards.state.waitlist.card}`;
            sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.waitlist.text}">キャンセル待ち 登録済</span>`;
          } else {
            cC = `${DesignConfig.cards.base} ${DesignConfig.cards.state.booked.card}`;
            sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.booked.text}">予約済み</span>`;
          }
          tag = 'div';
          act = '';
        } else if (sl.isFull || sl.availableSlots === 0 || (sl.morningSlots === 0 && sl.afternoonSlots === 0)) {
          cC = `${DesignConfig.cards.base} ${DesignConfig.cards.state.waitlist.card}`;
          sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.waitlist.text}">満席（キャンセル待ち申込み）</span>`;
        } else {
          cC = `${DesignConfig.cards.base} ${DesignConfig.cards.state.available.card}`;
          sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.available.text}">${statusText}</span>`;
        }
        const venueDisplay = sl.venue ? ` ${sl.venue}` : '';
        return `${monthHeader}<${tag} ${act} class="${cC}"><div class="flex justify-between items-center"><span class="${DesignConfig.colors.text}">${formatDate(sl.date)}${venueDisplay}</span>${sB}</div></${tag}>`;
      })
      .join('');
    return `
        <div class="max-w-md mx-auto">
            <h1 class="text-xl font-bold ${DesignConfig.colors.text} mb-4">${c}</h1>
            <div class="${DesignConfig.cards.container}">${bHtml}</div>
            <div class="mt-6">
                ${Components.createButton({ text: '教室選択に戻る', action: 'goBackToClassroomSelect', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
            </div>
        </div>`;
  };

  /**
   * 予約確認画面のUIを生成します。
   * @returns {string} HTML文字列
   */
  const getConfirmationView = () => {
    // --- State and Data Preparation ---
    const { classroom, date, availableSlots, venue, morningSlots, afternoonSlots, isFull } = appState.selectedSlot;
    const { isFirstTimeBooking: isFirstTime, currentUser, accountingMaster: master } = appState;
    const venueDisplay = venue ? `（${venue}）` : '';

    const classroomRule = master.find(
      item => item['対象教室'] && item['対象教室'].includes(classroom) && item['種別'] === '授業料',
    );

    // --- Helper Functions for UI Sections ---

    /**
     * 予約状況の表示を生成します。
     */
    const _renderStatusHtml = () => {
      if (isFull) return '満席（キャンセル待ち申込み）';
      if (typeof morningSlots !== 'undefined') {
        return `空き 午前 ${morningSlots} | 午後 ${afternoonSlots}`;
      }
      return `空き ${availableSlots}`;
    };

    /**
     * 予約時間選択のUIを生成します。
     */
    const _renderTimeOptionsSection = () => {
      // 30分単位の教室の場合
      if (classroomRule && classroomRule['単位'] === '30分') {
        const classStartHour = parseInt(classroomRule['講座開始'].split(':')[0]);
        const classEndHour = parseInt(classroomRule['講座終了'].split(':')[0]);
        const classEndMinutes = parseInt(classroomRule['講座終了'].split(':')[1]);

        // Note: 外部で定義されている `getTimeOptionsHtml` を呼び出していると想定
        const startTimeOptions = getTimeOptionsHtml(classStartHour, classEndHour, 30, null);
        let endTimeOptions = getTimeOptionsHtml(classStartHour, classEndHour, 30, null);
        if (classEndMinutes > 0) {
          const finalEndTime = `${String(classEndHour).padStart(2, '0')}:${String(classEndMinutes).padStart(2, '0')}`;
          endTimeOptions += `<option value="${finalEndTime}">${finalEndTime}</option>`;
        }

        const discountRule = master.find(item => item['項目名'] === ITEM_NAME_DISCOUNT);
        let discountHtml = '';
        if (discountRule && (classroom === TSUKUBA_CLASSROOM_NAME || classroom === NUMAZU_CLASSROOM_NAME)) {
          const discountAmountText = `${Math.abs(Number(discountRule['単価']))}円`;
          const discountUnitText = discountRule['単位'];
          discountHtml = `<p class="${DesignConfig.text.caption}">${discountRule['項目名']}: ${discountRule.説明 || `参加時間が初回講習と重なる場合、${discountUnitText}あたり${discountAmountText}割引`}</p>`;
        }

        return `
          <div class="mt-4 pt-4 border-t">
            <h4 class="font-bold ${DesignConfig.colors.text} mb-2">予約時間</h4>
            <div class="grid grid-cols-2 gap-4">
              ${Components.createSelect({ id: 'res-start-time', caption: '開始予定', options: startTimeOptions })}
              ${Components.createSelect({ id: 'res-end-time', caption: '終了予定', options: endTimeOptions })}
            </div>
            ${discountHtml}
          </div>`;
      }
      return ''; // 上記以外の場合は時間選択なし
    };

    /**
     * 予約オプションのUIを生成します。
     */
    const _renderBookingOptionsSection = () => {
      let optionsHtml = '';
      if (classroom === TOKYO_CLASSROOM_NAME) {
        optionsHtml += `<label class="flex items-center space-x-2"><input type="checkbox" id="option-first-lecture"><span>初回講習</span></label>`;
        optionsHtml += `<label class="flex items-center space-x-2 mt-2"><input type="checkbox" id="option-hayade"><span>早出<span class="text-sm ${DesignConfig.colors.textSubtle}">（初回講習の時間に半自習的に参加できます）</span></span></label>`;
      }
      optionsHtml += `<div class="mt-2"><label class="flex items-center space-x-2"><input type="checkbox" id="option-rental"><span>彫刻刀レンタル</span></label></div>`;

      return `
        <div class="mt-4 pt-4 border-t">
          <h4 class="font-bold text-left mb-2">オプション</h4>
          ${optionsHtml}
        </div>`;
    };

    /**
     * 詳細入力欄のUIを生成します。
     */
    const _renderDetailsInputSection = () => {
      const firstTimeGuidance = `
        <p class="${DesignConfig.text.caption}">- 教室サイトの作例などは作りやすいです（特に「だるま」など）</p>
        <p class="${DesignConfig.text.caption}">- 作品のサイズや題材によりますが、**1回の参加では完成しない可能性があります**</p>`;

      return `
        <div class="mt-4 pt-4 border-t space-y-4">
          ${Components.createTextArea({
            id: 'wip-input',
            label: isFirstTime ? '今回制作したいもの' : 'やりたいこと/作業予定',
            caption: isFirstTime
              ? '作りたいものがある方はご記入ください。仮でもOK! * ご自身の作り途中の作品や、材料の持ち込みも可'
              : '',
            placeholder: 'あとからでも記入できます。当日に相談でも大丈夫！',
          })}
          ${Components.createTextArea({
            id: 'material-input',
            label: '材料のサイズや樹種の希望',
            caption: 'ご希望があればご記入ください。大体でも大丈夫！作れる大きさは 【豆粒】〜【手のひら】くらい',
            placeholder: '例：30×30×40mmくらい」「高さが6cmくらい」「たまごぐらい」 など',
          })}
          ${isFirstTime ? firstTimeGuidance : ''}
        </div>
        <div class="mt-4 pt-4 border-t space-y-4">
          ${Components.createInput({ id: 'order-input', label: '購入希望', type: 'text', placeholder: '（任意）例：彫刻刀セット、テキスト' })}
          ${Components.createTextArea({ id: 'message-input', label: 'その他の連絡事項や要望など', placeholder: '' })}
        </div>`;
    };

    // --- Main View Assembly ---
    const title = isFull ? 'キャンセル待ち申込みの確認' : '予約詳細';
    const submitButtonText = isFull ? 'キャンセル待ちで登録' : 'この内容で予約';

    return `
      <h1 class="text-xl font-bold ${DesignConfig.colors.text} mb-4">${title}</h1>
      <div class="space-y-4 text-left p-4 ${DesignConfig.cards.background} rounded-lg">
        <p><span class="font-bold w-20 inline-block">お名前:</span> ${currentUser.displayName}さん</p>
        <p><span class="font-bold w-20 inline-block">教室:</span> ${classroom}${venueDisplay}</p>
        <p><span class="font-bold w-20 inline-block">日付:</span> ${formatDate(date)}</p>
        <p><span class="font-bold w-20 inline-block">状況:</span> ${_renderStatusHtml()}</p>
        <p><span class="font-bold w-20 inline-block">開講時間:</span>${classroomRule['講座開始']} - ${classroomRule['休憩開始'] || ''}${classroomRule['休憩開始'] ? ',…,' : ''}  ${classroomRule['休憩終了'] || ''}${classroomRule['休憩終了'] ? ' - ' : ''}${classroomRule['講座終了']}</p>
        ${_renderTimeOptionsSection()}
        ${_renderBookingOptionsSection()}
        ${_renderDetailsInputSection()}
      </div>
      <div class="mt-8 flex flex-col space-y-3">
        ${Components.createButton({ text: submitButtonText, action: 'confirmBooking', colorClass: DesignConfig.colors.primary, widthClass: DesignConfig.buttons.full })}
        ${Components.createButton({ text: '戻る', action: 'goBackToBooking', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
      </div>`;
  };

  /**
   * 完了画面のUIを生成します。
   * @param {string} msg - 表示するメッセージ
   * @returns {string} HTML文字列
   */
  const getCompleteView = msg => {
    // 会計処理を行った教室の情報を取得
    const classroom = appState.accountingReservation?.classroom;
    let nextBookingHtml = '';

    // 該当教室の未来の予約枠が存在する場合
    if (classroom && appState.slots) {
      // 新しいユーティリティ関数を使用してスロットをフィルタリング
      const relevantSlots = filterFutureAvailableSlots(appState.slots, classroom);

      if (relevantSlots.length > 0) {
        // getBookingViewと同様のロジックで予約カードのHTMLを生成
        const slotsByMonth = groupSlotsByMonth(relevantSlots);

        nextBookingHtml = `
          <div class="mt-10 pt-6 border-t border-gray-200">
              <h3 class="text-xl font-bold text-brand-text text-center mb-4">次回の予約</h3>
              <div class="${DesignConfig.cards.container}">
              ${Object.keys(slotsByMonth)
                .sort((a, b) => a - b)
                .map(month => {
                  const monthHeader = `<h4 class="text-lg font-medium ${DesignConfig.colors.textSubtle} mt-4 mb-2 text-center">${month}月</h4>`;
                  const slotsHtml = slotsByMonth[month]
                    .map(sl => {
                      let statusText = `空き ${sl.availableSlots}`;
                      if (typeof sl.morningSlots !== 'undefined') {
                        statusText = `午前 ${sl.morningSlots} | 午後 ${sl.afternoonSlots}`;
                      }
                      const sB = `<span class="text-sm font-bold ${DesignConfig.cards.state.available.text}">${statusText}</span>`;
                      const venueDisplay = sl.venue ? ` ${sl.venue}` : '';
                      return Components.createButton({
                        action: 'bookSlot',
                        classroom: sl.classroom,
                        date: sl.date,
                        text: `<div class="flex justify-between items-center w-full"><span class="${DesignConfig.colors.text}">${formatDate(sl.date)}${venueDisplay}</span>${sB}</div>`,
                        colorClass: `${DesignConfig.cards.base} ${DesignConfig.cards.state.available.card}`,
                      });
                    })
                    .join('');
                  return monthHeader + slotsHtml;
                })
                .join('')}
              </div>
          </div>`;
      }
    }

    return `
    <div class="text-center py-8">
        <svg class="w-16 h-16 mx-auto text-state-available-text" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h1 class="text-2xl font-bold ${DesignConfig.colors.text} mt-4 mb-2">ありがとうございました</h1>
        <p class="${DesignConfig.colors.textSubtle} mb-6">${msg}</p>

        ${nextBookingHtml}

        <div class="max-w-xs mx-auto mt-8">
             ${Components.createButton({
               text: 'ダッシュボードへ戻る',
               action: 'goToDashboard',
               colorClass: DesignConfig.colors.secondary,
               widthClass: DesignConfig.buttons.full,
             })}
        </div>
    </div>`;
  };

  /**
   * 会計画面のUIを生成します。
   * @returns {string} HTML文字列
   */
  const getAccountingView = () => {
    if (!appState.accountingMaster || !appState.accountingInitialValues)
      return '<div class="flex justify-center items-center h-full"><div class="spinner"></div></div>';
    const r = appState.accountingReservation;
    const b = appState.myBookings.find(b => b.reservationId === r.reservationId);
    const v = b.venue ? `（${b.venue}）` : '';
    const initial = appState.accountingInitialValues;
    if (b.accountingDone && b.accountingDetails) {
      try {
        const details = JSON.parse(b.accountingDetails);
        const tuitionItemsHtml = details.tuition.items
          .map(
            i =>
              `<div class="flex justify-between"><span>${i.name}</span><span>${i.price.toLocaleString()}円</span></div>`,
          )
          .join('');
        const salesItemsHtml = details.sales.items
          .map(
            i =>
              `<div class="flex justify-between"><span>${i.name}</span><span>${i.price.toLocaleString()}円</span></div>`,
          )
          .join('');
        return `
                <div class="text-center py-4">
                    <h1 class="text-2xl font-bold text-brand-text mt-4 mb-2">会計済み</h1>
                    <p class="text-brand-subtle mb-6"><b>${formatDate(r.date)}</b><br>${r.classroom}${v}</p>
                </div>
                <div class="p-4 bg-ui-surface border border-ui-border rounded-lg text-left space-y-4">
                    <div><h3 class="font-bold text-brand-text border-b border-ui-border mb-1 pb-1">授業料</h3><div class="space-y-1 text-brand-text">${tuitionItemsHtml || 'なし'}</div></div>
                    <div><h3 class="font-bold text-brand-text border-b border-ui-border mb-1 pb-1">販売</h3><div class="space-y-1 text-brand-text">${salesItemsHtml || 'なし'}</div></div>
                    <div class="text-right font-bold text-xl pt-2 border-t border-ui-border text-brand-text">合計: ${details.grandTotal.toLocaleString()}円</div>
                    <div class="text-right text-base pt-2 text-brand-subtle">支払方法: ${details.paymentMethod}</div>
                </div>
                <div class="mt-8 flex flex-col space-y-3">
                    ${Components.createButton({ text: '戻る', action: 'goBackToClassroomSelect', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
                </div>`;
      } catch (e) {
        return '会計詳細の表示に失敗しました。';
      }
    }
    const master = appState.accountingMaster;
    const classroomRule = master.find(
      item => item['対象教室'] && item['対象教室'].includes(r.classroom) && item['種別'] === '授業料',
    );
    const isTimeBased = classroomRule && classroomRule['単位'] === '30分';
    let tuitionHtml;
    if (isTimeBased) {
      tuitionHtml = getTimeBasedTuitionHtml(classroomRule, initial);
    } else {
      const tuitionItems = master.filter(
        item =>
          item['種別'] === '授業料' &&
          (item['対象教室'] === '共通' || (item['対象教室'] && item['対象教室'].includes(r.classroom))),
      );
      tuitionHtml = `<div class="p-4 bg-ui-surface border border-ui-border rounded-lg"> <h3 class="text-xl font-bold mb-3 text-brand-text">授業料</h3> <div class="space-y-3">${tuitionItems
        .map(item => {
          const isMandatory = item['項目名'] === '本講座';
          let isChecked = isMandatory || initial[item['項目名']] === true;
          if (item['項目名'] === '初回講習' && initial.firstLecture) isChecked = true;
          if (item['項目名'] === '早出' && initial.earlyArrival) isChecked = true;
          if (item['項目名'] === '彫刻刀レンタル' && initial.chiselRental) isChecked = true;
          return `<div class="flex items-center justify-between mb-2"> <label class="flex items-center space-x-2 text-brand-text"> <input type="checkbox" name="${item['項目名']}" data-item-type="授業料" data-item-name="${item['項目名']}" class="accounting-item h-5 w-5 rounded border-ui-border text-brand-text focus:ring-brand-text accent-action-primary-bg" ${isChecked ? 'checked' : ''} ${isMandatory ? 'disabled' : ''}> <span>${item['項目名']}</span> </label> <span class="text-brand-subtle">${item['単価'].toLocaleString()}円</span> </div>`;
        })
        .join(
          '',
        )}</div> <div id="tuition-breakdown" class="mt-4 pt-4 border-t border-ui-border space-y-1 text-base text-brand-subtle"></div> <div class="text-right font-bold mt-2 text-brand-text" id="tuition-subtotal">小計: 0円</div></div>`;
    }
    const salesItems = master.filter(item => item['種別'] === '物販');
    const salesHtml = `<div class="p-4 bg-ui-surface border border-ui-border rounded-lg"> <h3 class="text-xl font-bold mb-3 text-left text-brand-text">販売</h3> <div class="mb-3 space-y-4"><label class="block text-brand-text text-base font-bold">材料代</label><div id="materials-container">${getMaterialRowHtml(0, { type: initial.materialType0, l: initial.materialL0, w: initial.materialW0, h: initial.materialH0 })}</div></div> ${Components.createButton({ text: '+ 材料を追加', action: 'addMaterialRow', colorClass: 'bg-action-secondary-bg text-action-secondary-text w-full mt-3 text-base py-2 active:bg-action-secondary-hover' })} <details class="mt-4"> <summary class="font-bold text-brand-text flex items-center"> <span class="arrow mr-2">▶</span> その他の販売品 </summary> <div class="mt-2 space-y-2 pt-2 border-t border-ui-border">${salesItems.map(item => `<div class="flex items-center justify-between"> <label class="flex items-center space-x-2 text-brand-text"><input type="checkbox" name="${item['項目名']}" data-item-type="物販" data-item-name="${item['項目名']}" class="accounting-item accent-action-primary-bg" ${initial[item['項目名']] ? 'checked' : ''}><span>${item['項目名']}</span></label> <span class="text-brand-subtle">${item['単価'].toLocaleString()}円</span> </div>`).join('')}<div id="other-sales-container" class="mt-2 pt-2 border-t border-ui-border">${getOtherSalesRowHtml(0, { name: initial.otherSalesName0, price: initial.otherSalesPrice0 })}</div></div> ${Components.createButton({ text: '+ 自由入力欄を追加', action: 'addOtherSalesRow', colorClass: 'bg-action-secondary-bg text-action-secondary-text w-full mt-3 text-base py-2 active:bg-action-secondary-hover' })} </details> <div class="text-right font-bold mt-2 text-brand-text" id="sales-subtotal">小計: 0円</div></div>`;
    return `
        <div class="flex justify-between items-center">
            <h1 class="text-2xl font-bold text-brand-text">会計</h1>
            <button data-action="goBackToClassroomSelect" class="text-sm bg-action-secondary-bg text-action-secondary-text px-3 py-1.5 rounded-md active:bg-action-secondary-hover mobile-button">戻る</button>
        </div>
        <div class="text-center py-4">
            <p class="text-brand-subtle mb-6"><b>${formatDate(r.date)}</b><br>${r.classroom}${v}</p>
        </div>
        <form id="accounting-form" class="space-y-6">
            ${tuitionHtml}
            ${salesHtml}
            <div class="text-right text-2xl font-bold py-4 border-t-2 border-ui-border flex flex-col items-end">
                <span id="grand-total-amount" class="text-brand-text">合計: 0円</span>
            </div>
            <div class="mt-4 text-center">
                <p class="text-base text-state-danger-text font-bold mb-2">金額を、先生に確認してもらってください</p>
                <div class="space-y-3">
                    ${Components.createButton({ text: '先生の確認が完了しました', action: 'showAccountingConfirmation', colorClass: DesignConfig.colors.primary, widthClass: DesignConfig.buttons.full })}
                    ${Components.createButton({ text: '戻る', action: 'goBackToClassroomSelect', colorClass: DesignConfig.colors.secondary, widthClass: DesignConfig.buttons.full })}
                </div>
            </div>
        </form>`;
  };

    // ========== /13_WebApp_Views.html ==========

    // ========== 14_WebApp_Handlers.html ==========

  /**
   * =================================================================
   * 【ファイル名】: 14_WebApp_Handlers.html
   * 【バージョン】: 1.6
   * 【役割】: WebAppのフロントエンドにおける、ユーザーの操作に応じた
   * アクションと、アプリケーション全体の制御フローを集約します。
   * 【構成】: 14ファイル構成のうちの14番目
   * 【v1.6での変更点】:
   * - FE-14: 会計入力のキャッシュ機能を追加。
   *   - localStorageへの保存、読み込み、削除処理を実装。
   *   - 画面遷移、保存、キャンセル時にキャッシュを適切に操作するよう修正。
   * =================================================================
   */

  // =================================================================
  // --- Accounting Cache Helper Functions (FE-14) ---
  // -----------------------------------------------------------------
  // 会計フォームのデータを操作するためのヘルパー関数群
  // =================================================================

  /**
   * 会計フォームから現在の入力内容をオブジェクトとして取得します。
   * @returns {object} フォームデータ
   */
  function getAccountingFormData() {
    const form = document.getElementById('accounting-form');
    if (!form) return {};

    const data = {};
    const elements = form.elements;

    for (let i = 0; i < elements.length; i++) {
      const item = elements[i];
      if (item.name) {
        if (item.type === 'checkbox') {
          data[item.name] = item.checked;
        } else if (item.type === 'radio') {
          if (item.checked) {
            data[item.name] = item.value;
          }
        } else {
          data[item.name] = item.value;
        }
      }
    }
    return data;
  }

  /**
   * 会計画面の入力イベントを監視するリスナーを設定します。
   * @param {string} reservationId - 予約ID
   */
  function setupAccountingFormListeners(reservationId) {
    const form = document.getElementById('accounting-form');
    if (!form) return;

    form.addEventListener('input', () => {
      const accountingData = getAccountingFormData();
      saveAccountingCache(reservationId, accountingData);
    });
  }

  // =================================================================
  // --- Action Handlers ---
  // -----------------------------------------------------------------
  // ユーザーの操作（ボタンクリックなど）を起点として実行される
  // 全ての処理を定義するオブジェクトです。
  // 各キーが data-action 属性に対応します。
  // =================================================================
  window.actionHandlers = {
    /** ログインまたは新規登録を開始します */
    login: () => {
      const p = document.getElementById('phone').value;
      // 入力値をappStateに保存
      appState.loginPhone = p;
      if (!p) return showInfo('電話番号を入力してください。');
      const n = p.replace(/[‐－-]/g, '').replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 65248));
      showLoading('login');

      // 環境分岐: テスト環境の場合はモックデータを使用
      if (isTestEnvironment) {
        console.log('🧪 Using mock login data');
        setTimeout(() => {
          hideLoading();
          setState({
            currentUser: getEnvironmentData('currentUser', { displayName: 'テストユーザー', phone: n }),
            slots: getEnvironmentData('slots', []),
            myBookings: getEnvironmentData('myBookings', []),
            accountingMaster: getEnvironmentData('accountingMaster', {}),
            history: getEnvironmentData('history', []),
            historyTotal: getEnvironmentData('history', []).length,
            recordsToShow: 20,
            view: 'dashboard', // テスト環境ではダッシュボードに直接遷移
          });
        }, 300);
        return;
      }

      // 本番環境: 実際のGAS関数を呼び出し
      google.script.run
        .withSuccessHandler(r => {
          hideLoading();
          if (r.success) {
            // NF-04.2: 初回予約判定
            const isFirstTime =
              (!r.initialData.myBookings || r.initialData.myBookings.length === 0) &&
              (!r.initialData.myHistory || r.initialData.myHistory.length === 0);
            setState({
              currentUser: r.user,
              slots: r.initialData.availableSlots,
              myBookings: r.initialData.myBookings,
              accountingMaster: r.initialData.accountingMaster,
              history: r.initialData.myHistory,
              historyTotal: r.initialData.myHistory.length,
              recordsToShow: 20,
              isFirstTimeBooking: isFirstTime,
              view: 'classroomSelect',
            });
          } else if (r.commandRecognized) {
            setState({
              view: 'noPhoneUserSelect',
              noPhoneUsers: [],
              selectedNoPhoneUser: null,
              searchAttempted: false,
            });
          } else {
            // 認証失敗時
            if (r.phoneForRegistration) {
              // 新規登録画面に遷移する際、最新の電話番号をregistrationData.phoneにセット
              appState.registrationData = {
                ...appState.registrationData,
                phone: r.phoneForRegistration || appState.loginPhone || n,
              };
              setState({ view: 'register', phoneForRegistration: n });
            } else {
              showInfo(
                r.message || 'ログインに失敗しました。電話番号が登録されていないか、形式が正しくありません。',
                'エラー',
              );
            }
          }
        })
        .withFailureHandler(handleServerError)
        .authenticateUser(n);
    },

    /** 新規ユーザー登録：Step1からStep2へ */
    goToStep2: () => {
      const realName = document.getElementById('reg-realname').value;
      const nickname = document.getElementById('reg-nickname').value.trim();
      const phone = document.getElementById('reg-phone').value;
      // 入力値をappState.registrationDataに保存
      appState.registrationData = {
        ...appState.registrationData,
        phone,
        realName,
        nickname: nickname || realName,
      };
      if (!realName) return showInfo('お名前（本名）は必須です。');
      setState({
        registrationData: { ...appState.registrationData },
        registrationStep: 2,
        view: 'registrationStep2',
      });
    },

    /** 新規ユーザー登録：Step2からStep1へ戻る */
    backToStep1: () => setState({ view: 'register', registrationStep: 1 }),
    // Step2からStep1へ戻る時も入力値を保存
    backToStep1: () => {
      const realName = document.getElementById('reg-realname')?.value;
      const nickname = document.getElementById('reg-nickname')?.value;
      const phone = document.getElementById('reg-phone')?.value;
      if (realName || nickname || phone) {
        appState.registrationData = {
          ...appState.registrationData,
          realName: realName || appState.registrationData?.realName || '',
          nickname: nickname || appState.registrationData?.nickname || '',
          phone: phone || appState.registrationData?.phone || '',
        };
      }
      setState({ view: 'register', registrationStep: 1 });
    },

    /** 新規ユーザー登録：Step2からStep3へ進む */
    goToStep3: () => {
      const email = document.getElementById('q-email').value;
      if (!email || !email.includes('@')) {
        return showInfo('有効なメールアドレスを入力してください。');
      }

      const step2Data = {
        email: email,
        wantsEmail: document.getElementById('q-wants-email').checked,
        ageGroup: document.getElementById('q-age-group').value,
        gender: document.querySelector('input[name="gender"]:checked')?.value || '',
        dominantHand: document.querySelector('input[name="dominantHand"]:checked')?.value || '',
        address: document.getElementById('q-address').value,
      };

      setState({
        registrationData: { ...appState.registrationData, ...step2Data },
        registrationStep: 3,
        view: 'registrationStep3',
      });
    },

    /** 新規ユーザー登録：Step3からStep2へ戻る */
    backToStep2: () => setState({ view: 'registrationStep2', registrationStep: 2 }),

    /** 新規ユーザー登録：最終データをサーバーに送信 */
    submitRegistration: () => {
      const step3Data = {
        experience: document.querySelector('input[name="experience"]:checked')?.value || '',
        pastWork: document.getElementById('q-past-work').value,
        futureGoal: document.getElementById('q-future-goal').value,
      };

      const finalUserData = { ...appState.registrationData, ...step3Data };

      showLoading('login');
      google.script.run
        .withSuccessHandler(res => {
          hideLoading();
          if (res.success) {
            setState({
              currentUser: res.user,
              slots: res.initialData.availableSlots,
              myBookings: res.initialData.myBookings,
              accountingMaster: res.initialData.accountingMaster,
              history: res.initialData.myHistory,
              view: 'newBooking',
            });
          } else {
            showInfo(res.message || '登録に失敗しました');
          }
        })
        .withFailureHandler(handleServerError)
        .registerNewUser(finalUserData);
    },

    /** きろくカードの編集ボタン */
    editHistoryMemo: d => {
      const item = appState.history.find(h => h.reservationId === d.reservationId);
      if (!item) return;

      const originalMemo = item.workInProgress;

      showConfirm({
        title: '制作メモの編集',
        message: getMemoEditModalHtml(item),
        confirmText: '保存する',
        cancelText: 'キャンセル',
        confirmColorClass: DesignConfig.colors.primary,
        onConfirm: () => {
          const newMemo = document.getElementById('memo-edit-textarea').value;

          // 楽観的UI: まずフロントの表示を更新
          item.workInProgress = newMemo;
          setState({ history: [...appState.history] });

          showLoading();

          // サーバーに保存し、最新の履歴を取得
          google.script.run
            .withSuccessHandler(result => {
              hideLoading();
              if (result.success) {
                // サーバーから最新の履歴データで状態を更新
                setState({
                  history: result.history || appState.history,
                  historyTotal: result.total || appState.historyTotal,
                });
                showInfo('制作メモを更新しました。', '保存完了');
              } else {
                // サーバーエラーの場合は元に戻す
                item.workInProgress = originalMemo;
                setState({ history: [...appState.history] });
                showInfo(result.message || 'メモの保存に失敗しました。', 'エラー');
              }
            })
            .withFailureHandler(err => {
              hideLoading();
              // 通信エラーの場合は元に戻す
              item.workInProgress = originalMemo;
              setState({ history: [...appState.history] });
              handleServerError(err);
            })
            .updateMemo(d.reservationId, d.sheetName, newMemo, appState.currentUser.studentId);
        },
      });
    },

    /** プロフィール情報を保存します */
    saveProfile: () => {
      const r = document.getElementById('edit-realname').value;
      let n = document.getElementById('edit-nickname').value.trim();
      if (!r) return showInfo('お名前（本名）は必須です。');
      if (!n) n = r;

      // NF-01: 電話番号入力欄があればその値も取得
      const phoneInput = document.getElementById('edit-phone');
      const phone = phoneInput ? phoneInput.value : appState.currentUser.phone; // 電話番号入力欄がなければ既存の電話番号を使用

      const u = { ...appState.currentUser, realName: r, displayName: n, phone: phone }; // 電話番号も追加
      showLoading();
      google.script.run
        .withSuccessHandler(res => {
          hideLoading();
          if (res.success) {
            // ★★★ 変更点 ★★★
            // 戻り値の更新されたユーザー情報でローカルの状態を更新し、
            // 追加通信なしでダッシュボードに遷移する
            showInfo('プロフィールを更新しました', '更新完了');
            setState({ currentUser: res.updatedUser, view: 'classroomSelect' });
          } else {
            showInfo(res.message || '更新に失敗しました');
          }
        })
        .withFailureHandler(handleServerError)
        .updateUserProfile(u);
    },

    /**
     * NF-01: 電話番号未登録ユーザーの検索を実行します。
     */
    searchNoPhoneUser: () => {
      const searchInput = document.getElementById('nickname-search-input');
      const searchTerm = searchInput ? searchInput.value.trim() : ''; // 検索語をsearchTermに変更

      if (!searchTerm) {
        return showInfo('お名前（本名）またはニックネームを入力してください。');
      }

      showLoading('login');

      // 検索語からスペースを除去して小文字化して比較に使う
      const normalizedSearchTerm = searchTerm.replace(/\s+/g, '').toLowerCase();

      google.script.run
        .withSuccessHandler(users => {
          hideLoading();
          // searchName (スペース除去済み・小文字化された結合名) を使ってフィルタリング
          const filteredUsers = users.filter(user => user.searchName && user.searchName.includes(normalizedSearchTerm));

          // NF-01: 検索が試行されたことを示すフラグをセット
          setState({ noPhoneUsers: filteredUsers, searchAttempted: true });

          if (filteredUsers.length === 0) {
            // アカウントが見つからなかった場合のメッセージはビュー側で表示
          }
        })
        .withFailureHandler(handleServerError)
        .searchNoPhoneUsersByFilterForWebApp();
    },

    /**
     * NF-01: 検索結果から電話番号未登録ユーザーを選択します。
     */
    selectNoPhoneUser: d => {
      // ボタンに埋め込まれたデータから、まず仮のユーザー情報を作成
      const tempUser = {
        studentId: d.studentId,
        realName: d.realName, // ボタンのdata属性から取得
        displayName: d.nickname, // ボタンのdata属性から取得
        phone: '', // 電話番号はまだないので空
      };

      showLoading('login');

      // studentIdを使って、サーバーから予約情報や履歴などの完全なデータを取得
      google.script.run
        .withSuccessHandler(initialData => {
          console.log('[APP] Received initialData:', initialData);
          console.log('[APP] availableSlots check:', initialData.availableSlots);
          hideLoading();
          if (initialData.success) {
            // サーバーからのデータと、ボタンからの名前情報を組み合わせて完全な状態を構築
            setState({
              currentUser: tempUser, // 名前情報を含む仮ユーザー情報
              slots: initialData.availableSlots,
              myBookings: initialData.myBookings,
              accountingMaster: initialData.accountingMaster,
              history: initialData.myHistory,
              historyTotal: initialData.myHistory.length,
              recordsToShow: 20,
              view: 'editProfile', // 電話番号登録を促すためプロフィール編集画面へ
            });
          } else {
            showInfo('ユーザーデータの読み込みに失敗しました。');
          }
        })
        .withFailureHandler(handleServerError)
        .getInitialWebApp_Data(tempUser.studentId);
    },

    /**
     * NF-01: 自分のアカウントが見つからなかった場合に新規登録画面へ遷移します。
     */
    goToRegisterFromNoPhoneSearch: () => {
      // 新規登録画面へ遷移。電話番号は未入力のまま。
      setState({ view: 'register', phoneForRegistration: '' });
    },

    /** 予約をキャンセルします */
    cancel: d => {
      const message = `
        <div class="text-left space-y-4">
          <p class="text-center"><b>${formatDate(d.date)}</b><br>${d.classroom}<br>この予約を取り消しますか？</p>
          <div class="pt-4 border-t">
            <label class="block text-sm font-bold mb-2">先生へのメッセージ（任意）</label>
            <textarea id="cancel-message" class="w-full p-2 border border-ui-border rounded" rows="3" placeholder=""></textarea>
          </div>
        </div>
      `;
      showConfirm({
        title: '予約の取り消し',
        message: message,
        confirmText: 'はい<br>取り消します',
        cancelText: 'いいえ',
        confirmColorClass: DesignConfig.colors.danger,
        onConfirm: () => {
          showLoading('cancel');
          const cancelMessage = document.getElementById('cancel-message')?.value || '';
          const p = {
            ...d,
            studentId: appState.currentUser.studentId,
            cancelMessage: cancelMessage,
          };
          google.script.run
            .withSuccessHandler(r => {
              hideLoading();
              if (r.success) {
                // 【NF-12】サーバーから返された最新のキャッシュで状態を更新
                setState({ myBookings: r.newBookingsCache });
                showInfo('予約を取り消しました。', 'キャンセル完了');
              } else {
                showInfo(r.message || 'キャンセル処理に失敗しました。');
              }
            })
            .withFailureHandler(err => {
              // エラー時は画面を更新せず、元の状態を維持
              handleServerError(err);
            })
            .cancelReservationAndGetLatestData(p);
        },
      });
    },

    /** 予約を確定します */
    confirmBooking: () => {
      const bookingOptions = {
        earlyArrival: document.getElementById('option-hayade')?.checked || false,
        chiselRental: document.getElementById('option-rental')?.checked || false,
        firstLecture: document.getElementById('option-first-lecture')?.checked || false,
        startTime: document.getElementById('res-start-time')?.value || '',
        endTime: document.getElementById('res-end-time')?.value || '',
        workInProgress: document.getElementById('wip-input')?.value || '',
        order: document.getElementById('order-input')?.value || '',
        messageToTeacher: document.getElementById('message-input')?.value || '',
        materialInfo: document.getElementById('material-input')?.value || '',
      };
      // 初回予約時
      if (appState.isFirstTimeBooking) {
        bookingOptions.isNewUser = true;
      }
      showLoading('booking');
      const p = { ...appState.selectedSlot, user: appState.currentUser, options: bookingOptions };

      google.script.run
        .withSuccessHandler(r => {
          hideLoading();
          if (r.success) {
            // 【NF-12】サーバーから返された最新のキャッシュで状態を更新
            setState({
              view: 'complete',
              completionMessage: r.message,
              myBookings: r.newBookingsCache,
              // accountingReservationはセットしない
            });
          } else {
            showInfo(r.message || '予約に失敗しました。');
          }
        })
        .withFailureHandler(handleServerError)
        .makeReservationAndGetLatestData(p);
    },

    /** 予約編集画面に遷移します */
    goToEditReservation: d => {
      showLoading();
      google.script.run
        .withSuccessHandler(r => {
          hideLoading();
          if (r.success) {
            setState({ view: 'editReservation', editingReservationDetails: r.details });
          } else {
            showInfo(r.message || '予約詳細の取得に失敗しました。');
          }
        })
        .withFailureHandler(handleServerError)
        .getReservationDetailsForEdit(d.reservationId, d.classroom);
    },

    /** 予約情報を更新します */
    updateReservation: () => {
      const d = appState.editingReservationDetails;
      const p = {
        reservationId: d.reservationId,
        classroom: d.classroom,
        studentId: appState.currentUser.studentId,
        earlyArrival: document.getElementById('edit-option-hayade')?.checked || false,
        chiselRental: document.getElementById('edit-option-rental')?.checked || false,
        startTime: document.getElementById('edit-start-time')?.value || '',
        endTime: document.getElementById('edit-end-time')?.value || '',
        workInProgress: document.getElementById('edit-wip-input').value,
        order: document.getElementById('edit-order-input').value,
        messageToTeacher: document.getElementById('edit-message-input').value,
      };

      showLoading('booking');
      google.script.run
        .withSuccessHandler(r => {
          hideLoading();
          if (r.success) {
            // 【NF-12】サーバーから返された最新のキャッシュで状態を更新
            setState({ view: 'classroomSelect', myBookings: r.newBookingsCache });
            showInfo('予約内容を更新しました。', '更新完了');
          } else {
            showInfo(r.message || '更新に失敗しました。');
          }
        })
        .withFailureHandler(handleServerError)
        .updateReservationDetailsAndGetLatestData(p);
    },

    /** 会計画面に遷移します */
    goToAccounting: d => {
      showLoading('accounting');
      google.script.run
        .withSuccessHandler(res => {
          hideLoading();
          if (res.success) {
            const reservationId = d.reservationId;
            const cachedData = loadAccountingCache(reservationId);

            // サーバーデータとキャッシュデータをマージ (キャッシュを優先)
            const initialValues = { ...res.details, ...cachedData };

            setState({
              view: 'accounting',
              accountingReservation: d,
              accountingInitialValues: initialValues,
            });
          } else {
            showInfo(res.message || '予約詳細の取得に失敗しました。');
          }
        })
        .withFailureHandler(handleServerError)
        .getReservationDetails(d);
    },

    /** 履歴から会計詳細をモーダルで表示します */
    showHistoryAccounting: d => {
      const details = JSON.parse(d.details);
      const tuitionItemsHtml = details.tuition.items
        .map(i => `<li>${i.name}: ${i.price.toLocaleString()}円</li>`)
        .join('');
      const salesItemsHtml = details.sales.items.map(i => `<li>${i.name}: ${i.price.toLocaleString()}円</li>`).join('');
      const message = `
            <div class="p-4 bg-brand-light rounded-lg text-left space-y-4 text-base">
                ${tuitionItemsHtml ? `<b>授業料</b><ul class="list-disc list-inside">${tuitionItemsHtml}</ul>` : ''}
                ${salesItemsHtml ? `<b class="mt-1 inline-block">販売</b><ul class="list-disc list-inside">${salesItemsHtml}</ul>` : ''}
                <div class="font-bold mt-1 pt-1 border-t">合計: ${details.grandTotal.toLocaleString()}円</div><div class="text-right text-sm pt-1">支払方法: ${details.paymentMethod}</div></div>`;
      showInfo(message, '会計記録');
    },

    /** 会計画面で材料入力行を追加します */
    addMaterialRow: () => {
      const container = document.getElementById('materials-container');
      const newIndex = container.querySelectorAll('div[data-material-row-index]').length;
      const newRow = document.createElement('div');
      newRow.className = 'mt-4 pt-4 border-t border-ui-border-light';
      newRow.dataset.materialRowIndex = newIndex;
      newRow.innerHTML = getMaterialRowHtml(newIndex);
      container.appendChild(newRow);
    },

    /** 会計画面でその他販売品入力行を追加します */
    addOtherSalesRow: () => {
      const container = document.getElementById('other-sales-container');
      const newIndex = container.querySelectorAll('div[data-other-sales-row]').length;
      // getOtherSalesRowHtmlが返すHTML文字列を、ラッパーを介さず直接コンテナの末尾に追加する
      container.insertAdjacentHTML('beforeend', getOtherSalesRowHtml(newIndex));
    },

    /** 会計画面で合計金額をクリップボードにコピーします */
    copyGrandTotal: button => {
      const totalText = document.getElementById('grand-total-amount')?.textContent || '';
      const numericTotal = totalText.replace(/[^0-9-]/g, '');
      actionHandlers.copyToClipboard(button, numericTotal);
    },

    /** 指定されたテキストをクリップボードにコピーします */
    copyToClipboard: (button, text) => {
      const textToCopy = text || button.dataset.copyText;
      const textArea = document.createElement('textarea');
      textArea.style.position = 'fixed';
      textArea.style.top = '-9999px';
      textArea.style.left = '-9999px';
      textArea.value = textToCopy.replace(/,/g, '');
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          const originalText = button.textContent;
          button.textContent = 'コピーしました!';
          setTimeout(() => {
            button.textContent = originalText;
          }, 2000);
        } else {
          showInfo('コピーに失敗しました。');
        }
      } catch (err) {
        showInfo('コピーに失敗しました。');
        // エラーログは開発環境でのみ出力
        if (typeof console !== 'undefined' && console.error) {
          console.error('Clipboard copy failed:', err);
        }
      }
      document.body.removeChild(textArea);
    },

    // 【LEGACY REMOVED】古い個別履歴ページ関数を削除
    // goToHistory, forceGoToHistory は統合ダッシュボードに移行済み

    /** 参加記録を追加で読み込みます（統合ダッシュボード用） */
    loadMoreHistory: () => {
      const newCount = (appState.recordsToShow || 20) + 20;
      setState({ recordsToShow: newCount });
    },

    /** 新規予約のための教室選択画面に遷移します */
    goToNewBookingView: () => setState({ view: 'newBooking' }),

    /** プロフィール編集画面に遷移します */
    goToEditProfile: () => setState({ view: 'editProfile' }),

    /** 教室を選択し、予約枠一覧画面に遷移します */
    selectClassroom: d => setState({ selectedClassroom: d.classroomName, view: 'booking' }),

    /** 予約枠を選択し、予約確認画面に遷移します */
    bookSlot: d => {
      const foundSlot = appState.slots.find(s => s.classroom === d.classroom && s.date === d.date);
      if (foundSlot) {
        // 空席数に基づいてisFull状態を確実に設定
        const isFullSlot =
          foundSlot.isFull ||
          foundSlot.availableSlots === 0 ||
          (typeof foundSlot.morningSlots !== 'undefined' &&
            foundSlot.morningSlots === 0 &&
            foundSlot.afternoonSlots === 0);
        setState({
          selectedSlot: {
            ...foundSlot,
            isFull: isFullSlot,
          },
          view: 'confirm',
        });
      } else {
        showInfo('エラーが発生しました。選択した予約枠が見つかりません。');
      }
    },

    /** ログイン画面に戻ります */
    goBackToLogin: () => setState({ view: 'login' }),
    // 「戻る」時も電話番号入力値を保存
    goBackToLogin: () => {
      const phoneInput = document.getElementById('phone');
      if (phoneInput) appState.loginPhone = phoneInput.value;
      setState({ view: 'login' });
    },

    /** ダッシュボード（メイン画面）に戻ります */
    goBackToClassroomSelect: () => setState({ view: 'classroomSelect' }),

    /** ダッシュボード（メイン画面）に戻ります（別名） */
    goToDashboard: () => setState({ view: 'classroomSelect' }),

    /** 予約枠一覧画面に戻ります */
    goBackToBooking: () => {
      if (appState.view === 'accounting') {
        showConfirm({
          title: '確認',
          message: '会計入力を破棄しますか？<br>（入力内容はクリアされます）',
          confirmText: 'はい',
          cancelText: 'いいえ',
          confirmColorClass: DesignConfig.colors.danger,
          onConfirm: () => {
            clearAccountingCache(appState.accountingReservation.reservationId);
            setState({
              view: 'booking',
              selectedClassroom:
                appState.selectedSlot?.classroom ||
                appState.accountingReservation?.classroom ||
                appState.editingReservationDetails?.classroom,
            });
          },
        });
      } else {
        setState({
          view: 'booking',
          selectedClassroom:
            appState.selectedSlot?.classroom ||
            appState.accountingReservation?.classroom ||
            appState.editingReservationDetails?.classroom,
        });
      }
    },

    /** ダッシュボード（教室選択画面）に戻ります */
    goToDashboard: () => setState({ view: 'classroomSelect' }),

    /** モーダルの確認ボタンを押したときの処理です */
    modalConfirm: () => {
      if (onConfirmCallback) onConfirmCallback();
      hideModal();
    },

    /** モーダルのキャンセルボタンを押したときの処理です */
    modalCancel: () => hideModal(),

    /** 「次の予約をする」ボタンの処理（予約一覧画面へ遷移） */
    goToBooking: d => {
      // data-classroom属性から教室名を取得
      const classroom = d.classroom || appState.accountingReservation?.classroom;
      if (classroom) {
        setState({ selectedClassroom: classroom, view: 'booking' });
      } else {
        showInfo('教室名が取得できませんでした。');
      }
    },
  };

  /**
   * 会計の確認モーダルを表示
   */
  actionHandlers.showAccountingConfirmation = () => {
    const accountingDetails = calculateAccountingDetails();
    if (!accountingDetails || accountingDetails.grandTotal <= 0) {
      showInfo('合計金額が0円です。項目を選択してください。');
      return;
    }

    const message = `
        <div class="p-4 bg-brand-light rounded-lg text-left space-y-4 text-base" id="modal-accounting-form">
            <div>
                <span class="font-bold">合計金額:</span> ${accountingDetails.grandTotal.toLocaleString()}円
                <button data-action="copyGrandTotal" class="ml-2 text-sm bg-action-secondary-bg active:bg-action-secondary-hover text-action-secondary-text font-bold px-2 py-1 rounded">コピー</button>
            </div>
            <div>
                <span class="font-bold">支払い方法:</span>
                <div class="mt-2 space-y-3">
                    ${getPaymentOptionsHtml()}
                </div>
            </div>
            <div class="mt-4">
                <button id="confirm-payment-button" data-action="confirmAndPay" class="w-full bg-action-primary-bg text-action-primary-text font-bold py-2 rounded disabled:bg-brand-muted" disabled>この内容で支払いました</button>
            </div>
            <p class="text-red-700 font-bold mt-2 text-center">必ずボタンを押してね</p>
        </div>
    `;
    showModal({
      title: 'お会計',
      message: message,
      showCancel: true,
      cancelText: 'キャンセル',
      onConfirm: null,
    });
  };

  /**
   * 「この内容で支払いました」ボタン押下時の処理
   */
  actionHandlers.confirmAndPay = () => {
    const reservationId = appState.accountingReservation.reservationId;
    // モーダル内の支払い方法を取得
    const modalForm = document.getElementById('modal-accounting-form');
    let paymentMethod = '現金';
    if (modalForm) {
      const selected = modalForm.querySelector('input[name="payment-method"]:checked');
      if (selected) paymentMethod = selected.value;
    }

    // --- バックエンドに送信する「ユーザー入力」オブジェクトを構築 ---
    const form = document.getElementById('accounting-form');
    const userInput = {
      paymentMethod: paymentMethod,
      tuitionItems: [],
      salesItems: [],
      timeBased: null,
    };

    // 授業料項目（チェックボックス）
    form.querySelectorAll('input[type="checkbox"][data-item-type="授業料"]:checked').forEach(cb => {
      userInput.tuitionItems.push(cb.dataset.itemName);
    });

    // 時間制授業料
    if (document.getElementById('start-time')) {
      userInput.timeBased = {
        startTime: document.getElementById('start-time').value,
        endTime: document.getElementById('end-time').value,
        breakMinutes: parseInt(document.getElementById('break-time')?.value || 0, 10),
        discountMinutes: parseInt(document.getElementById('discount-selector')?.value || 0, 10),
      };
    }

    // 物販・材料費項目
    const materialContainer = document.getElementById('materials-container');
    if (materialContainer) {
      materialContainer.querySelectorAll('div[data-material-row-index]').forEach((row, index) => {
        const name = document.getElementById(`material-type-${index}`)?.value;
        const priceText = document.getElementById(`material-price-${index}`)?.textContent || '0';
        const price = parseInt(priceText.replace(/[^0-9]/g, ''), 10);
        if (name && price > 0) userInput.salesItems.push({ name: name, price: price });
      });
    }

    // 物販項目（チェックボックス）
    form.querySelectorAll('input[type="checkbox"][data-item-type="物販"]:checked').forEach(cb => {
      userInput.salesItems.push({ name: cb.dataset.itemName });
    });

    form.querySelectorAll('div[data-other-sales-row]').forEach((row, index) => {
      const name = document.getElementById(`other-sales-name-${index}`)?.value.trim();
      const price = document.getElementById(`other-sales-price-${index}`)?.value;
      if (name && price) userInput.salesItems.push({ name: name, price: Number(price) });
    });
    // --- ここまで ---

    const payload = {
      reservationId: appState.accountingReservation.reservationId,
      classroom: appState.accountingReservation.classroom,
      studentId: appState.currentUser.studentId,
      userInput: userInput,
    };

    showLoading('accounting');
    google.script.run
      .withSuccessHandler(r => {
        if (r.success) {
          clearAccountingCache(reservationId); // <-- キャッシュ削除
          hideModal(); // モーダルを閉じる
          hideLoading();
          setState({
            view: 'complete',
            completionMessage: '会計情報を記録しました。',
            myBookings: r.newBookingsCache,
            history: r.newHistory,
            historyTotal: r.newHistoryTotal,
            slots: r.updatedSlots, // <--- これを追加
            accountingReservation: appState.accountingReservation,
          });
        } else {
          hideLoading();
          showInfo(r.message || '会計情報の記録に失敗しました。');
        }
      })
      .withFailureHandler(handleServerError)
      .saveAccountingDetails(payload);
  };

  // =================================================================
  // --- Main Application Logic ---
  // -----------------------------------------------------------------
  // アプリケーションの起動、サーバーとの通信、状態管理、画面描画など、
  // 全体を制御するコアとなる関数群です。
  // =================================================================

  /**
   * サーバーサイドでエラーが発生した際の共通処理です。
   * @param {Error} err - サーバーから返されたエラーオブジェクト
   */
  function handleServerError(err) {
    hideLoading();

    // エラーログは開発環境でのみ出力
    if (typeof console !== 'undefined' && console.error) {
      console.error('Server Error:', err);
    }

    const errorMessage = typeof err === 'object' && err.message ? err.message : JSON.stringify(err);
    showInfo(`サーバーでエラーが発生しました。<br><br>詳細: ${errorMessage}`, 'エラー');
  }

  /**
   * アプリケーションの状態を更新し、画面を再描画します。
   * @param {object} newState - 更新する新しい状態オブジェクト
   */
  function setState(newState) {
    // テスト環境でのみデバッグログを表示
    const isTestEnvironment =
      typeof window !== 'undefined' &&
      (window.location.protocol === 'file:' || window.location.hostname === 'localhost');

    if (isTestEnvironment) {
      console.log('[DEBUG] setState called with:', newState);
      console.log('[DEBUG] Current appState before update:', appState);
    }

    Object.assign(appState, newState);

    // myBookingsが配列でない場合の防御的プログラミング（本番環境でも重要）
    if (appState.myBookings && !Array.isArray(appState.myBookings)) {
      if (isTestEnvironment) {
        console.warn('[DEBUG] myBookings is not an array, converting:', appState.myBookings);
      }
      appState.myBookings = [];
    }

    // myBookingsがundefinedの場合も配列で初期化
    if (!appState.myBookings) {
      appState.myBookings = [];
    }

    if (isTestEnvironment) {
      console.log('[DEBUG] Updated appState:', appState);
    }

    render();
  }
  window.setState = setState;
  this.setState = setState;
  self.setState = setState;

  /**
   * 現在のアプリケーションの状態に基づいて、適切なビューを描画します。
   */
  function render() {
    let v = '';
    switch (appState.view) {
      case 'login':
        v = getLoginView();
        break;
      case 'register':
        v = getRegisterView(appState.phoneForRegistration);
        break;
      case 'registrationStep2':
        v = getRegistrationStep2View();
        break;
      case 'registrationStep3':
        v = getRegistrationStep3View();
        break;
      case 'classroomSelect':
        v = getDashboardView();
        break;
      case 'newBooking':
        v = getNewBookingView();
        break;
      case 'editProfile':
        v = getEditProfileView();
        break;
      case 'booking':
        v = getBookingView(appState.selectedClassroom);
        break;
      case 'confirm':
        v = getConfirmationView();
        break;
      case 'editReservation':
        v = getEditReservationView();
        break;
      case 'accounting':
        v = getAccountingView();
        break;
      // 【LEGACY REMOVED】 case 'history' - 統合ダッシュボードに移行済み
      case 'complete':
        v = getCompleteView(appState.completionMessage);
        break;
      case 'noPhoneUserSelect':
        v = getNoPhoneUserSelectView();
        break; // NF-01: 新しいビューを追加
    }
    console.log('Rendered view HTML:', v);
    document.getElementById('view-container').innerHTML = `<div class="fade-in">${v}</div>`;
    console.log('view-container innerHTML after update:', document.getElementById('view-container').innerHTML);

    if (appState.view === 'accounting') {
      requestAnimationFrame(() => {
        calculateAccountingDetails();
        setupAccountingFormListeners(appState.accountingReservation.reservationId);
      });
    }

    window.scrollTo(0, 0);
  }

  /**
   * アプリケーションの起動点です。
   * ページ読み込み完了時に実行され、イベントリスナーを設定します。
   */
  window.onload = function () {
    const app = document.getElementById('app');

    // 会計計画面での入力変更を検知し、リアルタイムで再計算
    ['input', 'change'].forEach(eventName => {
      app.addEventListener(eventName, e => {
        if (appState.view === 'accounting' && e.target.closest('#accounting-form')) {
          calculateAccountingDetails();
        }
        // changeイベントの場合のみ、支払い方法選択をチェック
        if (eventName === 'change' && e.target.matches('#modal-accounting-form input[name="payment-method"]')) {
          document.getElementById('confirm-payment-button')?.removeAttribute('disabled');
        }
      });
    });

    // アプリ全体のクリックイベントを捕捉
    app.addEventListener('click', e => {
      const targetButton = e.target.closest('button');
      if (targetButton?.dataset.action) {
        const { action, ...data } = targetButton.dataset;
        if (action === 'copyToClipboard' || action === 'copyGrandTotal') {
          actionHandlers[action](targetButton);
        } else if (actionHandlers[action]) {
          actionHandlers[action](data);
        }
      }
    });

    // NF-04: 木彫り経験ラジオボタンの変更を監視
    app.addEventListener('change', e => {
      if (e.target.closest('#experience-radio-group')) {
        const container = document.getElementById('past-work-container');
        if (container) {
          if (e.target.value === 'はじめて！') {
            container.classList.add('hidden');
          } else {
            container.classList.remove('hidden');
          }
        }
      }
    });

    // 初期画面を描画
    render();
  };

    // ========== /14_WebApp_Handlers.html ==========


      // 統合版初期化
      console.log('[統合版] 全ファイル統合完了、アプリケーション初期化開始');

      // テスト環境用の初期化（hideLoading/setStateを明示的に呼ぶ）
      setTimeout(() => {
        if (typeof setState === 'function') {
          setState({ view: 'login' });
        }
        if (typeof hideLoading === 'function') {
          hideLoading();
        }
        if (typeof window.onload === 'function') {
          window.onload();
        } else if (typeof render === 'function') {
          render();
        }

       }, 100);
    </script>
  </body>
</html>
