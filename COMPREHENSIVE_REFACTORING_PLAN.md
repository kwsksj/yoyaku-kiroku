# 包括的リファクタリング計画書

## 1. はじめに

この計画書は、`DATA_ACCESS_PRINCIPLES.md` にて定義された設計原則に基づき、プロジェクト全体のコードベースを改善するための具体的な手順を定義するものである。

既存の `PERFORMANCE_OPTIMIZATION_PLAN.md` および `ADDITIONAL_PERFORMANCE_OPTIMIZATIONS.md` の内容を統合し、実行可能なタスクリストとして再構成した。

## 2. 全体方針

リファクタリングは、以下のフェーズに分けて段階的に実施する。

- **フェーズ1: データ読み取りのキャッシュ移行** - 全てのシート直接読み取りをキャッシュ経由に置き換える。
- **フェーズ2: データ書き込み処理の最適化** - 更新処理の効率化と、バッチ処理への移行。
- **フェーズ3: ロジックとデータ構造の統一** - 業務ロジックの重複排除と、マスタデータの一元化。

---

## フェーズ1: データ読み取りのキャッシュ移行（優先度：極高）

**目的**: アプリケーションの応答速度に最も影響を与える、シートからの直接読み取り処理を撲滅する。

| ファイル                               | 関数                                      | 問題点                                                                                                     | 修正案                                                                                                                                    |
| :------------------------------------- | :---------------------------------------- | :--------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------- |
| `05-2_Backend_Write.js`                | `checkCapacityFull`                       | 予約の定員チェックの際に、統合予約シートを直接読み込んでいる。                                             | `getCachedData(CACHE_KEYS.ALL_RESERVATIONS)` を利用して予約データを取得するように変更する。                                               |
| `05-2_Backend_Write.js`                | `cancelReservation`                       | 予約キャンセルの際に、生徒名簿シートを直接読み込んでいる。                                                 | `getCachedData(CACHE_KEYS.ALL_STUDENTS_BASIC)` を利用して生徒情報を取得する。                                                             |
| `04_Backend_User.js`                   | `getUsersWithoutPhoneNumber`              | 電話番号未登録ユーザーを探すために、生徒名簿シートを直接読み込んでいる。                                   | `getCachedData(CACHE_KEYS.ALL_STUDENTS_BASIC)` を利用し、キャッシュデータからフィルタリングする。                                         |
| `08_Utilities.js`                      | `getSheetData` / `getSheetDataWithSearch` | シートデータを直接取得する汎用関数。多くの箇所から呼び出されており、キャッシュ原則違反の温床となっている。 | これらの関数の呼び出し元を特定し、個別にキャッシュ利用（`getCachedData`）に置き換えていく。最終的にこれらの関数が不要になることを目指す。 |
| `02-4_BusinessLogic_ScheduleMaster.js` | `getScheduleDataFromSheet`                | 日程マстаをシートから直接読み込んでいる。                                                                  | `getAllScheduledDates` がキャッシュを利用する設計になっているため、この関数の直接呼び出しを避け、キャッシュ経由での取得に統一する。       |

## フェーズ2: データ書き込み処理の最適化（優先度：高）

**目的**: データの書き込み・更新処理を効率化し、APIの実行時間と競合リスクを低減する。

### 2.1. 【事前準備】キャッシュ構造の改善

| 対象ファイル         | 対象キャッシュ         | 修正内容                                                                                                                                                                                                    |
| :------------------- | :--------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `07_CacheManager.js` | **生徒名簿キャッシュ** | `rebuildAllStudentsBasicCache`を修正し、キャッシュされる生徒オブジェクトに、シート上の**行番号(`rowIndex`)**を追加する。                                                                                    |
| `07_CacheManager.js` | **予約キャッシュ**     | `rebuildAllReservationsCache`を修正し、従来の**配列(`reservations`)**に加え、IDで高速検索できる**オブジェクト(`reservationsById`)**も保持するハイブリッド構造にする。オブジェクトには`rowIndex`も追加する。 |

### 2.2. 書き込み・ソート戦略の定義

| ファイル                | 関数                          | 戦略・決定事項                                                                                               |
| :---------------------- | :---------------------------- | :----------------------------------------------------------------------------------------------------------- |
| `05-2_Backend_Write.js` | `makeReservation`             | 新規予約の追加は、負荷の低い**`appendRow()`（末尾追加）を継続**する。シートの物理的な並び順は保証しない。    |
| `07_CacheManager.js`    | `rebuildAllReservationsCache` | キャッシュ構築時に、シートから読み込んだ全データを**日付順でソートしてからキャッシュに保存**する責務を持つ。 |

### 2.3. 書き込み関数のリファクタリング

| ファイル                      | 関数                                             | 問題点                                                                         | 修正案                                                                                                                                       |
| :---------------------------- | :----------------------------------------------- | :----------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------- |
| `04_Backend_User.js`          | `updateUserProfile`                              | プロフィール更新時に、シートの全データを読み書きしている。                     | **【事前準備】**で改善された生徒キャッシュを使い、`rowIndex`を取得。対象行の変更があったセル範囲のみを `getRange().setValues()` で更新する。 |
| `05-2_Backend_Write.js`       | `cancelReservation` / `updateReservationDetails` | 予約のキャンセル・編集時に、対象行を特定するためにシートを読み込んでいる。     | **【事前準備】**で改善された予約キャッシュを使い、`rowIndex`を取得。対象行の変更があったセル範囲のみをピンポイントで更新する。               |
| `02-1_BusinessLogic_Batch.js` | `logSalesFromArchivedData`                       | 売上ログを、処理のたびに別スプレッドシート（`openById`）に直接書き込んでいる。 | 売上ログデータを `PropertiesService` のキューに一時保存し、定期的なトリガーで一括書き込みするバッチ処理方式に変更する。                      |

## フェーズ3: ロジックとデータ構造の統一（優先度：中）

**目的**: コードの重複を排除し、データソースを一元化することで、保守性と信頼性を向上させる。

| 項目                               | 対象ファイル・関数                                     | 問題点                                                                                                                                       | 修正案                                                                                                                                        |
| :--------------------------------- | :----------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------- |
| **タイムゾーン取得の統一**         | `05-3`, `07`, `02-4`, `08` など複数                    | `getSpreadsheetTimezone()` API呼び出しが散在し、非効率。                                                                                     | `CONSTANTS.TIMEZONE` 定数（`Asia/Tokyo`）に全面的に移行し、API呼び出しをなくす。                                                              |
| **セッション判定ロジックの統一**   | `05-2_Backend_Write.js` (`checkCapacityFull`)          | 古い固定13時での午前・午後判定ロジックが残っている。                                                                                         | `05-3_Backend_AvailableSlots.js` で使用されている、日程マスタの時間を正とする新しい判定ロジックに統一する。                                   |
| **マスタデータの一元化**           | `05-2`, `05-3`, `06` など複数                          | 授業時間や定員といった情報が、会計マスタや定数ファイルに分散して定義されており、不整合のリスクがある。                                       | **日程マスタをSingle Source of Truth**とし、関連情報はすべて日程マスタキャッシュから取得するように、各関数の参照先を変更する。                |
| **レガシー関数のリファクタリング** | `09_Backend_Endpoints.js` (`extractUserDataFromBatch`) | 古いデータ変換関数 `transformReservationArrayToObject` に依存している。                                                                      | ヘッダーマップを正しく利用する `transformReservationArrayToObjectWithHeaders` を使うように修正する。                                          |
| **不要なソート処理の削除**         | `05-3_Backend_AvailableSlots.js`                       | キャッシュがソート済みになった後では不要になる冗長なソート処理が残っている。パフォーマンスへの影響は軽微だが、コードの可読性を損なっている。 | キャッシュ構築時にソートを実装した後、`getAvailableSlots`内の冗長な`.sort()`呼び出しを削除する。（`myHistory`の逆順ソートは意図的なので残す） |

---

**作成日**: 2025-08-29
