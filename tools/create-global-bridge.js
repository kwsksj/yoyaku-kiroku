#!/usr/bin/env node

/**
 * =================================================================
 * ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€‘: tools/create-global-bridge.js
 * ã€å½¹å‰²ã€‘: è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸå‹å®šç¾©ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹ãƒ–ãƒªãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
 * ã€ç›®çš„ã€‘: export const ã‚„ export namespace ã‚’ `declare global` ã§ãƒ©ãƒƒãƒ—ã™ã‚‹
 * =================================================================
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// è¨­å®š
const TARGET_DIRS = [
  path.join(__dirname, '../types/generated-backend-globals'),
  path.join(__dirname, '../types/generated-frontend-globals'),
  path.join(__dirname, '../types/generated-shared-globals'),
];

/**
 * .d.tsãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰exportå®£è¨€ã‚’æŠ½å‡º
 * @param {string} filePath - å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
 * @returns {Array<{name: string}>}
 */
function extractExports(filePath) {
  const content = fs.readFileSync(filePath, 'utf8');
  const exports = [];
  const exportRegex = /^export (?:const|class|namespace|interface|type|function) (\w+)/gm;
  let match;

  while ((match = exportRegex.exec(content)) !== null) {
    exports.push({ name: match[1] });
  }
  return exports;
}

/**
 * ãƒ–ãƒªãƒƒã‚¸å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
 */
function generateBridgeFiles() {
  console.log('ğŸ” Scanning generated type definitions to create global bridges...');

  for (const dir of TARGET_DIRS) {
    if (!fs.existsSync(dir)) {
      console.log(`- Skipping non-existent directory: ${path.basename(dir)}`);
      continue;
    }

    const files = fs.readdirSync(dir).filter(f => f.endsWith('.d.ts') && f !== 'index.d.ts' && f !== '_globals.d.ts');

    if (files.length === 0) {
      console.log(`- No .d.ts files to process in: ${path.basename(dir)}`);
      continue;
    }

    const allExports = [];
    for (const file of files) {
      const filePath = path.join(dir, file);
      const exports = extractExports(filePath);
      if (exports.length > 0) {
        allExports.push(...exports);
      }
    }

    if (allExports.length === 0) {
      console.log(`- No exports found in: ${path.basename(dir)}`);
      continue;
    }

    const globalDeclarations = allExports
      .map(exp => `  const ${exp.name}: typeof import('.').${exp.name};`)
      .join('\n');

    const content = `/**
 * @file This file is auto-generated by tools/create-global-bridge.js.
 * Do not edit this file manually.
 */

declare global {
${globalDeclarations}
}

export {};
`;

    const outputFile = path.join(dir, '_globals.d.ts');
    fs.writeFileSync(outputFile, content, 'utf8');
    console.log(`âœ… Created _globals.d.ts for '${path.basename(dir)}' with ${allExports.length} declarations.`);
  }

  console.log('\nâœ¨ Global bridge file generation complete.');
}

// ãƒ¡ã‚¤ãƒ³å‡¦ç†
try {
  generateBridgeFiles();
} catch (error) {
  console.error('âŒ Error generating bridge files:', error.message);
  process.exit(1);
}