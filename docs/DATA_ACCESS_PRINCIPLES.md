# データアクセス設計原則

## 1. 目的

この資料は、本アプリケーションにおけるデータアクセス（スプレッドシートとキャッシュ）の統一的なルールを定義するものである。

この原則に従うことで、アプリケーションのパフォーマンス、保守性、信頼性を最大化することを目的とする。

## 2. 基本原則

アプリケーション内のすべてのデータアクセスは、以下の2つのルールに厳密に従うものとする。

### ルール1: データの「読み取り」は、常にキャッシュから行う

- **原則**: データを参照・利用したい場合は、必ず `07_CacheManager.js` の `getCachedData()` 関数を経由して取得する。
- **具体例**: 生徒情報を取得する場合、`getSheetByName('生徒名簿').getDataRange().getValues()` のようなコードは書かず、`getCachedData(CACHE_KEYS.ALL_STUDENTS_BASIC)` を利用する。
- **メリット**: Google Apps Script の実行時間の大半を占めるスプレッドシートAPIの呼び出しを最小限に抑え、アプリケーションの応答速度を劇的に向上させる。

### ルール2: データの「書き込み」と「キャッシュ更新」のみ、シートを直接操作する

シートを直接操作（`SpreadsheetManager`, `getSheetByName`, `getRange`, `setValues` など）して良いのは、以下の2つの例外的なケースのみとする。

1. **データの永続化（書き込み）**
    - **目的**: ユーザーの操作によって発生したデータの変更（予約作成、更新、キャンセルなど）を、マスターデータであるスプレッドシートに保存する。
    - **責務**: 書き込み処理を行った関数は、その直後に**関連するキャッシュを更新または無効化する責務を持つ**。例えば、予約を作成した後は `rebuildAllReservationsCache()` を呼び出し、キャッシュとシートの状態を一致させる。

2. **キャッシュの再構築**
    - **目的**: `07_CacheManager.js` が、キャッシュ自体を構築・更新するために、マスターデータであるスプレッドシートを読み込む。
    - **詳細**: これは、キャッシュにデータを「仕入れる」ための唯一の正当な一括読み取り処理である。

## 3. 設計原則のまとめ

| 操作の種類         | 実行方法                         | 担当モジュール           |
| :----------------- | :------------------------------- | :----------------------- |
| **読み取り**       | **キャッシュ** (`getCachedData`) | アプリケーション全体     |
| **書き込み**       | **シート** (`setValues`など)     | Backend関数 (`05-2`など) |
| **キャッシュ更新** | **シート** (`getValues`など)     | `CacheManager` (`07`)    |

この原則を徹底することで、コードの属人性を排除し、誰が開発してもパフォーマンスと一貫性が保たれるアプリケーションを目指す。

---
**作成日**: 2025-08-29
