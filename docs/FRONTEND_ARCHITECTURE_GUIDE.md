# フロントエンドアーキテクチャガイド

## 1. 概要

このアプリケーションのフロントエンドは、Google Apps Script（GAS）環境で動作するWebアプリケーションとして設計されています。コードの可読性、保守性、拡張性を重視し、以下の設計原則に基づいて構築されています。

## 2. 設計原則

- **番号付きファイル管理**: プロジェクト全体の一貫性を保つため、10〜14番台の番号付きファイル構成を採用
- **関心の分離（SoC）**: 各ファイルは明確な単一責任を持ち、機能別に適切に分離
- **モジュール化設計**: 再利用可能なコンポーネントと明確な依存関係により保守性を確保
- **統一定数システム連携**: バックエンドの定数システムとの緊密な統合

## 3. ファイル構成

現在のフロントエンドは以下の7個のファイルで構成されています。

| ファイル名                    | 役割                 | 説明                                                                       |
| :---------------------------- | :------------------- | :------------------------------------------------------------------------- |
| `10_WebApp.html`              | **HTMLテンプレート** | ユーザーがアクセスする基本HTML構造。全JavaScriptファイルの読み込みを管理。 |
| `11_WebApp_Config.html`       | **設定・定数管理**   | フロントエンド固有の設定値と統一定数システムとの連携を担当。               |
| `12_WebApp_Core.html`         | **中核機能集約**     | 汎用ユーティリティ、統一検索関数、会計計算ロジックなどの中核機能を集約。   |
| `12_WebApp_StateManager.html` | **状態管理システム** | `SimpleStateManager`クラスによるアプリケーション全体の状態管理を担当。     |
| `13_WebApp_Components.html`   | **UIコンポーネント** | 再利用可能なUI部品を3層構造（Atomic→Molecular→Organisms）で管理。          |
| `13_WebApp_Views.html`        | **画面生成**         | 各画面（ログイン、予約一覧等）の完全なHTML構築を担当する関数群。           |
| `14_WebApp_Handlers.html`     | **イベント処理**     | ユーザー操作の処理、フォーム管理、バックエンドAPI呼び出しを集約。          |

## 4. ファイル読み込み順序と依存関係

`10_WebApp.html`で以下の順序でファイルを読み込みます：

```html
<?!= include('11_WebApp_Config'); ?>
<!-- 設定・定数 -->
<?!= include('12_WebApp_StateManager'); ?>
<!-- 状態管理システム -->
<?!= include('12_WebApp_Core'); ?>
<!-- 中核機能・ユーティリティ -->
<?!= include('13_WebApp_Components'); ?>
<!-- UIコンポーネント -->
<?!= include('13_WebApp_Views'); ?>
<!-- 画面生成関数 -->
<?!= include('14_WebApp_Handlers'); ?>
<!-- イベント処理・アクション -->
```

### 読み込み順序の設計原則

1. **基盤→構成要素→処理**の順序
2. **依存関係の解決**: 後続ファイルは前のファイルに依存可能
3. **状態管理の早期初期化**: StateManagerを優先的に読み込み
4. **UI構築の階層**: Components→Views→Handlersの順序でUI層を構築

## 5. 各ファイルの詳細責任

### `10_WebApp.html`（HTMLテンプレート）

- 基本HTML構造とCSSスタイル定義
- 全JavaScriptファイルの`<?!= include() ?>`による読み込み
- デバッグ情報表示、ローディング画面、モーダルなどの基礎UI要素
- Tailwind CSSクラスを使用したレスポンシブデザイン

### `11_WebApp_Config.html`（設定・定数管理）

- フロントエンド専用の設定値管理
- バックエンド統一定数システム（`00_Constants.js`）との連携説明
- UI設計関連の定数とスタイル設定
- 統一定数アクセス方法の説明とサンプル

### `12_WebApp_Core.html`（中核機能集約）

- 統一検索関数システム（`findReservationById`等）
- 「よやく」と「きろく」の統合処理機能
- 汎用ユーティリティ関数群
- 会計計算ロジック
- 日付・スロット処理の共通関数

### `12_WebApp_StateManager.html`（状態管理システム）

- `SimpleStateManager`クラスの定義と実装
- アプリケーション全体の状態一元管理
- UI更新の自動化と無限ループ回避機能
- `window.stateManager`インスタンスの生成
- リアクティブな画面更新システム

### `13_WebApp_Components.html`（UIコンポーネント）

- 3層構造のコンポーネント設計：
  - **Atomic**: 基本要素（ボタン、入力フィールド等）
  - **Molecular**: 複合要素（フォームグループ、カード等）
  - **Organisms**: 複雑な構造（ヘッダー、フッター等）
- HTMLエスケープ機能（`window.escapeHTML`）
- 再利用可能なUI部品の標準化

### `13_WebApp_Views.html`（画面生成）

- `get...View()`形式の画面生成関数群
- 各画面（ログイン、予約一覧、会計等）の完全HTML構築
- `Components`を組み合わせた複合画面の構築
- 状態に基づく動的コンテンツ生成

### `14_WebApp_Handlers.html`（イベント処理）

- `actionHandlers`オブジェクトによるイベント管理
- `data-action`属性に対応する具体的処理の実装
- バックエンドAPI（`google.script.run`）の呼び出し
- フォームデータの管理（会計入力キャッシュ機能等）
- 状態変更とUI更新の制御

## 6. アーキテクチャの特徴

### 統一定数システム連携

- バックエンドの`00_Constants.js`で定義された統一定数を`stateManager.getState().constants`でアクセス
- フロントエンド固有定数は`11_WebApp_Config.html`で管理
- 定数の重複を避け、一元的なデータ管理を実現

### 状態管理パターン

- `SimpleStateManager`による一元的な状態管理
- UI更新の自動化と無限ループ回避
- リアクティブな画面更新システム
- 状態変更の追跡とデバッグ支援

### コンポーネント設計

- Atomic Design原則に基づく3層構造
- 再利用可能性とメンテナンス性の両立
- HTMLエスケープによるセキュリティ対策
- 型安全性を意識したパラメータ設計

### データアクセス抽象化

- バックエンドの新しいデータアクセス層（`repositories.*`、`*Service`）との連携
- 統一検索関数による「よやく」と「きろく」の統合処理
- キャッシュ機能との適切な連携

## 7. 開発ガイドライン

### 新機能追加時の指針

1. **適切なファイルの選択**: 機能の性質に応じて適切なファイルに配置
2. **依存関係の考慮**: 読み込み順序と依存関係を意識した実装
3. **状態管理の活用**: `stateManager`を通じた一元的なデータ管理
4. **コンポーネント再利用**: 既存UIコンポーネントの積極的な活用

### コード品質の維持

- HTMLエスケープの徹底
- 統一定数システムの活用
- エラーハンドリングとデバッグ機能の活用
- レスポンシブデザインとアクセシビリティの配慮

### テスト戦略

- 直接GAS環境での動作確認
- テスト環境（`npm run push:test`）での段階的検証
- 各ファイル変更後の全体動作確認
- 状態管理システムの動作検証

## 8. パフォーマンス考慮事項

- **読み込み順序の最適化**: 依存関係を考慮した効率的な読み込み
- **状態管理の効率化**: 不要な再描画の回避
- **コンポーネント再利用**: 重複コードの削減
- **キャッシュ機能活用**: フォームデータの適切な管理

このアーキテクチャにより、保守性が高く、拡張しやすいフロントエンドシステムを実現しています。
