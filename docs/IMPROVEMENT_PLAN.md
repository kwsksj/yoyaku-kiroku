# システム改修計画

## 1. 概要

木彫り教室予約管理システム「きぼりの よやく・きろく」の改善希望点を整理し、優先度別に具体的な改修計画を策定した。

## 2. 改修項目の分類と優先度

### 2.1. 🔴 高優先度（即座に対応すべき項目）

#### 2.1.1. バグ修正・エラー対応

- [ ] **#1 予約エラー修正**
  - **問題**: 予約しようとするとモーダルに「Cannot read properties of undefined (reading '2')」エラー
  - **対象ファイル**: `14_WebApp_Handlers.html`, `13_WebApp_Views.html`
  - **具体的対応**:
    - [ ] エラー発生箇所の特定（配列アクセスでの未定義値参照）
    - [ ] 予約処理関連のactionHandlersを調査
    - [ ] getReservationViewでのデータ構造確認
    - [ ] 適切なnullチェックとエラーハンドリング追加
  - **テスト方法**: テスト環境で予約操作を実行し、エラーが解消されることを確認

- [ ] **#2 会計処理性能改善**
  - **問題**: `saveAccountingDetails`でのシート呼び出し多数による処理遅延
  - **対象ファイル**: `05-2_Backend_Write.js`, `03_DataAccess.js`
  - **具体的対応**:
    - [ ] `saveAccountingDetails`関数の処理フローを分析
    - [ ] シート呼び出し回数の計測
    - [ ] バッチ処理による一括更新への変更
    - [ ] キャッシュ活用による読み取り処理最適化
    - [ ] 不要なシート操作の削除
  - **パフォーマンス目標**: 処理時間を50%短縮

- [ ] **#3 電話番号整形の正確性向上**
  - **問題**: 電話番号入力時のフォーマット処理が不正確
  - **対象ファイル**: `14_WebApp_Handlers.html`, `08_Utilities.js`
  - **具体的対応**:
    - [ ] 現在の電話番号正規化処理を確認
    - [ ] 全角・半角・ハイフン処理ロジックの見直し
    - [ ] 入力時リアルタイム整形機能の実装
    - [ ] バリデーション強化（11桁固定、先頭0必須など）
    - [ ] エラーメッセージの改善

#### 2.1.2. 重要なUX改善

- [ ] **#4 デバッグ表示削除**
  - **問題**: 本番環境でデバッグ情報が表示されている
  - **対象ファイル**: 全HTMLファイル、JSファイル
  - **具体的対応**:
    - [ ] `console.log`, `console.debug`の削除または条件分岐化
    - [ ] デバッグ用UI要素の除去
    - [ ] 本番/テスト環境分岐でのデバッグ制御実装
    - [ ] `00_Constants.js`に環境判定フラグ追加
  - **確認方法**: 本番環境でコンソールログが出力されないことを確認

- [ ] **#5 文字ちらつき改善**
  - **問題**: アプリページを開いた瞬間に整形されない文字がちらつく
  - **対象ファイル**: `10_WebApp.html`, `11_WebApp_Config.html`
  - **具体的対応**:
    - [ ] CSS読み込み順序の最適化
    - [ ] FOUTによる問題の特定
    - [ ] プリローダー実装でちらつき隠蔽
    - [ ] フォント読み込み最適化
    - [ ] 初期表示用のスケルトンUI実装

- [ ] **#6 モバイル表示問題解決**
  - **問題**: Googleサイト埋め込み時、スマホでメニューバーがアプリ上部を隠す
  - **対象ファイル**: `11_WebApp_Config.html`
  - **具体的対応**:
    - [ ] モバイル表示時の上部マージン追加
    - [ ] `viewport`メタタグ設定見直し
    - [ ] レスポンシブデザインの調整
    - [ ] Googleサイト埋め込み用のCSS調整
    - [ ] 実機テストでの確認

### 2.2. 🟡 中優先度（ビジネス価値の高い機能改善）

#### 2.2.1. UI配置最適化

- [ ] **#7 戻るボタン配置変更**
  - **現状**: 戻るボタンの位置が使いづらい
  - **対象ファイル**: `13_WebApp_Components.html`, `13_WebApp_Views.html`
  - **具体的対応**:
    - [ ] 現在の戻るボタン実装箇所を特定
    - [ ] 右上固定配置のCSSスタイル定義
    - [ ] 全画面での統一的な配置実装
    - [ ] モバイル表示での最適化
    - [ ] アクセシビリティ確保（タップ領域確保）

- [ ] **#8 予約カードボタン配置変更**
  - **現状**: 予約カードのボタンが見つけにくい
  - **対象ファイル**: `13_WebApp_Views.html`, `13_WebApp_Components.html`
  - **具体的対応**:
    - [ ] 予約カードコンポーネントの特定
    - [ ] ボタン配置を右上に変更
    - [ ] カードレイアウトの調整
    - [ ] ボタンの視認性向上（色、サイズ調整）
    - [ ] レスポンシブ対応

- [ ] **#9 ボタン配置修正**
  - **問題**: オレンジ色のボタンが左寄りになりすべてのボタンがくっついている
  - **対象ファイル**: `11_WebApp_Config.html`
  - **具体的対応**:
    - [ ] オレンジボタンの該当箇所特定
    - [ ] `DesignConfig.colors.accounting`関連のスタイル確認
    - [ ] フレックスボックスレイアウトの調整
    - [ ] ボタン間のマージン・パディング設定
    - [ ] ボタングループのセンタリング実装

#### 2.2.2. 機能拡張

- [ ] **#10 初回講習自動設定機能**
  - **要求**: 初回の人の予約は自動的に初回講習にする
  - **対象ファイル**: `05-2_Backend_Write.js`, `13_WebApp_Views.html`
  - **具体的対応**:
    - [ ] ユーザーの予約履歴確認ロジック実装
    - [ ] 初回判定フラグの追加
    - [ ] 予約作成時の自動初回講習設定
    - [ ] UIでの初回講習バッジ表示
    - [ ] 料金計算への反映

- [ ] **#11 予約スロット動的表示制御**
  - **要求**: 当日の講座は終了2時間前から非表示
  - **対象ファイル**: `05-3_Backend_AvailableSlots.js`, `13_WebApp_Views.html`
  - **具体的対応**:
    - [ ] 現在時刻と講座開始時刻の比較ロジック実装
    - [ ] 2時間前判定の実装
    - [ ] 動的フィルタリング機能の追加
    - [ ] フロントエンドでの表示制御
    - [ ] リアルタイム更新機能の実装

- [ ] **#12 キャンセル待ち状態表示**
  - **問題**: キャンセル待ちの状態が表示されていない
  - **対象ファイル**: `13_WebApp_Views.html`, `13_WebApp_Components.html`
  - **具体的対応**:
    - [ ] キャンセル待ち状態のデータ構造確認
    - [ ] 状態表示コンポーネントの実装
    - [ ] カードUIでの状態別表示
    - [ ] 色分けとアイコンによる視覚的区別
    - [ ] 状態変更時の動的更新

#### 2.2.3. 操作性向上

- [ ] **#13 電話番号入力整形（リアルタイム）**
  - **要求**: 3-4-4桁の区切りで見やすくする
  - **対象ファイル**: `13_WebApp_Views.html`, `14_WebApp_Handlers.html`
  - **具体的対応**:
    - [ ] 入力フィールドでのリアルタイム整形実装
    - [ ] `input`イベントリスナーの追加
    - [ ] ハイフン自動挿入ロジック
    - [ ] カーソル位置調整
    - [ ] コピペ時の適切な処理

- [ ] **#14 新規登録時入力値永続化**
  - **要求**: ページを離れても入力値が維持される
  - **対象ファイル**: `14_WebApp_Handlers.html`, `12_WebApp_StateManager.html`
  - **具体的対応**:
    - [ ] LocalStorageを使用した値保存実装
    - [ ] 入力値の自動保存機能
    - [ ] ページ読み込み時の値復元
    - [ ] 登録完了時のキャッシュクリア
    - [ ] プライバシー配慮（有効期限設定）

### 2.3. 🟢 低優先度（将来的な改善項目）

#### 2.3.1. 追加機能

- [ ] **#15 キャンセル待ち通知機能**
  - **要求**: キャンセル待ちの人に空きが出たときに通知
  - **実装方針**:
    - [ ] メール通知システムの設計
    - [ ] 通知送信トリガーの実装
    - [ ] 通知履歴管理
    - [ ] 通知設定のユーザー選択機能

- [ ] **#16 日程アップデート通知**
  - **要求**: 希望者に日程がアップした場合の通知
  - **実装方針**:
    - [ ] 通知希望者管理機能
    - [ ] 新規日程検知システム
    - [ ] 一括通知機能
    - [ ] 通知停止機能

- [ ] **#17 初回予約者アンケート機能**
  - **要求**: 初めて予約する人にアンケート
  - **実装方針**:
    - [ ] アンケートフォーム作成
    - [ ] 回答データ保存機能
    - [ ] 分析・集計機能
    - [ ] 管理画面での確認機能

- [ ] **#18 複数人予約・会計対応**
  - **要求**: 複数人の予約と一括会計処理
  - **実装方針**:
    - [ ] データ構造の拡張
    - [ ] UI/UXの大幅変更
    - [ ] 料金計算ロジックの複雑化対応
    - [ ] 管理画面での対応

#### 2.3.2. UI/UX改善

- [ ] **#19 デザイン全体刷新**
  - **要求**: 全体の色味やデザインの刷新（<https://www.kibori-class.net/booking> に合わせて）
  - **実装方針**:
    - [ ] 既存サイトのデザイン分析
    - [ ] 新カラーパレット策定
    - [ ] コンポーネントデザインの統一
    - [ ] ブランドガイドライン作成

- [ ] **#20 画面遷移位置調整**
  - **問題**: ページ遷移したとき画面位置がズレたまま
  - **実装方針**:
    - [ ] スクロール位置の記憶機能
    - [ ] 画面遷移時の位置リセット
    - [ ] スムーススクロール実装

- [ ] **#21 会計モーダル調整**
  - **問題**: 会計画面でモーダルが長すぎて画面からはみ出す
  - **実装方針**:
    - [ ] モーダルの最大高さ制限
    - [ ] スクロール可能領域の実装
    - [ ] レスポンシブ対応強化

#### 2.3.3. その他

- [ ] **#22 ログアウト機能追加**
  - **要求**: セキュリティ向上のためのログアウト機能
  - **実装方針**:
    - [ ] セッション管理の実装
    - [ ] ログアウトボタンの配置
    - [ ] データクリア処理

- [ ] **#23 キャッシュ再構築改善**
  - **問題**: メニューからのキャッシュ再構築時に確認不要
  - **実装方針**:
    - [ ] 確認ダイアログのスキップ設定
    - [ ] 管理者権限による制御

## 3. 実装フェーズ計画

### 3.1. フェーズ1：緊急修正（1-2週間）

- バグ修正・エラー対応（#1-3）
- デバッグ表示削除（#4）
- 文字ちらつき改善（#5）

### 3.2. フェーズ2：UX改善（2-3週間）

- モバイル表示問題解決（#6）
- UI配置最適化（#7-9）
- 基本機能拡張（#10-12）

### 3.3. フェーズ3：操作性向上（1-2週間）

- 入力システム改善（#13-14）
- その他重要機能

### 3.4. フェーズ4：将来機能（3-4週間）

- 通知システム（#15-16）
- 高度な機能拡張（#17-18）

### 3.5. フェーズ5：全体最適化（2-3週間）

- デザイン刷新（#19）
- 最終調整（#20-23）

## 4. 技術的考慮事項

### 4.1. アーキテクチャ活用

- 既存のデータアクセス抽象化層（`03_DataAccess.js`）の活用
- サービス層（`02-5_BusinessLogic_ReservationService.js`）の拡張
- 統一定数システム（`00_Constants.js`）による設定一元管理
- StateManager（`12_WebApp_StateManager.html`）による状態管理

### 4.2. パフォーマンス

- キャッシュシステムの最適化
- バッチ処理による効率化
- 不要なAPI呼び出しの削減

### 4.3. モバイル対応

- レスポンシブデザインの強化
- タッチ操作の最適化
- 表示領域の効率的活用

## 5. テスト戦略

### 5.1. 各フェーズ共通

1. `npm run push:test` でテスト環境にデプロイ
2. 機能テスト実行
3. `npm run push:prod` で本番環境展開
4. 本番環境での動作確認

### 5.2. 重点テスト項目

- モバイル実機でのUI/UX確認
- 予約・会計フローの完全テスト
- パフォーマンス測定
- エラーハンドリングの検証

## 6. リスク管理

### 6.1. 高リスク項目

- 会計処理の性能改善（業務影響大）
- データ構造変更を伴う機能追加
- UI全体の大幅変更

### 6.2. 対策

- 段階的リリース
- ロールバック計画の準備
- 十分なテスト期間の確保
- ユーザーへの事前告知

## 7. 成功指標

### 7.1. 定量指標

- エラー発生率の削減
- ページ表示速度の改善
- ユーザー操作完了率の向上

### 7.2. 定性指標

- ユーザビリティの向上
- 管理者の運用効率改善
- モバイル体験の向上

---

**更新履歴**

- 2024-08-31: 初版作成
