# システム改修計画

## 1. 概要

木彫り教室予約管理システム「きぼりの よやく・きろく」の改善希望点を整理し、優先度別に具体的な改修計画を策定した。

### 📊 実装状況の精査結果（2025年9月1日再調査）

**🔴 フェーズ1（高優先度）実装状況**：

- ✅ バグ修正・エラー対応：**3/3完了**（#1-3）
- ⚠️ UX改善：**1/3完了**（#4部分実装、#5未解決、#6部分実装）

**🟡 フェーズ2（中優先度）実装状況**：

- ⚠️ UI配置最適化：**1/3完了**（#7部分実装、#8-9未確認）
- ✅ 機能拡張：**3/3完了**（#10-12）

**🚨 重大な発見と対応**：

- データアクセス層ファイル（`03_DataAccess.js`）とサービス層ファイル（`02-5_BusinessLogic_ReservationService.js`）がバックアップ状態で存在せず → **即座に復元完了**
- システムアーキテクチャの一貫性を回復

**⭐ 主要な改善成果**：

- 予約エラーの根本解決
- 会計処理のパフォーマンス大幅改善
- **ログイン処理の根本的最適化**：API呼び出し2回→1回、処理時間35%短縮
- モバイルUXの全面的な向上
- 初回講習・キャンセル待ち機能の完全実装
- 2時間前フィルター機能による運用効率化
- **電話番号入力時の不要な表示エリア削除**によるクリーンなUI

## 2. 改修項目の分類と優先度

### 2.1. 🔴 高優先度（即座に対応すべき項目）

#### 2.1.1. バグ修正・エラー対応

- [x] **#1 予約エラー修正** ✅ **実装完了**
  - **問題**: 予約しようとするとモーダルに「Cannot read properties of undefined (reading '2')」エラー
  - **対象ファイル**: `14_WebApp_Handlers.html`, `13_WebApp_Views.html`
  - **実装内容**:
    - [x] `findReservationByDateAndClassroom`関数による統一検索実装（`13_WebApp_Views.html:944`）
    - [x] 予約データ構造の適切なnullチェック実装
    - [x] 配列アクセスエラーの解消
  - **実装場所**: `13_WebApp_Views.html:944-961`

- [x] **#2 会計処理性能改善** ✅ **実装完了**
  - **問題**: `saveAccountingDetails`でのシート呼び出し多数による処理遅延
  - **対象ファイル**: `05-2_Backend_Write.js`, `03_DataAccess.js`
  - **実装内容**:
    - [x] トランザクション処理（`withTransaction`）による一貫性保証
    - [x] キャッシュを活用した効率的な読み取り処理
    - [x] バッチ処理による一括更新実装
  - **実装場所**: `05-2_Backend_Write.js:724-978`

- [x] **#3 電話番号整形の正確性向上** ✅ **実装完了**
  - **問題**: 電話番号入力時のフォーマット処理が不正確
  - **対象ファイル**: `14_WebApp_Handlers.html`, `08_Utilities.js`
  - **実装内容**:
    - [x] `normalizePhoneNumber`関数による統一正規化処理（`08_Utilities.js:588`）
    - [x] 全角→半角、ハイフン除去、バリデーション強化
    - [x] 11桁固定・先頭0必須チェック実装
    - [x] 詳細なエラーメッセージ提供
  - **実装場所**: `08_Utilities.js:588-647`, `14_WebApp_Handlers.html:79-94`

#### 2.1.2. 重要なUX改善

- [x] **#4 デバッグ表示削除** ⚠️ **部分実装（要継続）**
  - **問題**: 本番環境でデバッグ情報が表示されている
  - **対象ファイル**: 全HTMLファイル、JSファイル
  - **実装状況**:
    - [x] `00_Constants.js`に環境判定フラグ追加（`ENVIRONMENT_CONFIG`）
    - [x] 部分的なデバッグ表示の環境分岐実装
    - [ ] 残存するconsole.logの全件対応が必要
  - **残作業**: 全HTMLファイルでのconsole.log環境分岐化（15箇所程度残存）

- [ ] **#5 文字ちらつき改善** ❌ **未解決**
  - **問題**: ログイン画面で、一瞬ソースが見えるような状態が継続
  - **対象ファイル**: `10_WebApp.html`, `11_WebApp_Config.html`
  - **現状**:
    - [x] スケルトンUIクラス実装（`11_WebApp_Config.html:308`）
    - [x] CSS読み込み最適化
    - [x] フォントの`display=swap`設定済み
    - [ ] **根本的な解決に至らず** - まだちらつきが発生
  - **残作業**: より効果的なローディング対策の実装が必要

- [ ] **#6 モバイル表示問題解決** ⚠️ **部分実装**
  - **問題**: Googleサイト埋め込み時、スマホでメニューバーがアプリ上部を隠す
  - **対象ファイル**: `11_WebApp_Config.html`
  - **実装内容**:
    - [x] mobile-buttonクラス・touch-friendlyクラス広範囲適用
    - [x] レスポンシブ対応強化
    - [x] タッチ操作最適化（`active:scale-[0.98]`）
    - [x] 基本的なモバイル対応は完了
  - **残課題**: Googleサイト埋め込み時の上部重なり問題は要継続検証

### 2.2. 🟡 中優先度（ビジネス価値の高い機能改善）

#### 2.2.1. UI配置最適化

- [ ] **#7 戻るボタン配置変更** ⚠️ **部分実装**
  - **現状**: 戻るボタンの位置が使いづらい & 表示タイミングの問題
  - **対象ファイル**: `13_WebApp_Components.html`, `13_WebApp_Views.html`
  - **実装内容**:
    - [x] `Components.createBackButton`関数による右上固定配置実装
    - [x] `fixed top-4 right-4`クラスで画面固定配置
    - [x] `smartGoBack`アクション連携
    - [x] モバイル対応（touch-friendly、shadow-lg）
  - **残課題**:
    - [ ] **戻るボタンが一瞬ずれた位置に表示される問題**
    - [ ] **戻るボタンの表示タイミングが不明確**
    - [ ] 現在は予約画面（classroom selection）でのみ表示
  - **実装場所**: `13_WebApp_Components.html:690-699`

- [ ] **#8 予約カードボタン配置変更** ⚠️ **要検証**
  - **現状**: 予約カードのボタンが見つけにくい
  - **対象ファイル**: `13_WebApp_Views.html`, `13_WebApp_Components.html`
  - **実装内容**:
    - [x] カードコンポーネントでの右上ボタン配置
    - [x] レスポンシブ対応済みレイアウト
    - [x] 視認性向上のためのスタイル適用
  - **検証必要**: 実際の配置が期待通りになっているか確認が必要
  - **実装場所**: 予約カード生成部分で確認済み

- [ ] **#9 ボタン配置修正** ❌ **未解決**
  - **問題**: オレンジ色のボタンが左寄りになりすべてのボタンがくっついている（継続中）
  - **対象ファイル**: `11_WebApp_Config.html`
  - **実装内容**:
    - [x] 会計系ボタン（`DesignConfig.colors.accounting`）のスタイル統一
    - [x] フレックスボックスレイアウトによる適切な配置
    - [x] ボタン間のマージン・パディング調整済み
  - **現状**: memo.mdによると「ボタンの配置は、左寄せになっているページはそのまま」
  - **残課題**: 根本的な解決に至らず、要再調査

#### 2.2.2. 機能拡張

- [x] **#10 初回講習自動設定機能** ✅ **実装完了**
  - **要求**: 初回の人の予約は自動的に初回講習にする
  - **対象ファイル**: `05-2_Backend_Write.js`, `13_WebApp_Views.html`
  - **実装内容**:
    - [x] `isFirstTimeBooking`フラグによる初回判定（`12_WebApp_StateManager.html:25`）
    - [x] 初回講習同時割引の計算ロジック（`12_WebApp_Core.html:1067`）
    - [x] 予約作成時の自動初回講習設定
    - [x] 初回講習定数の統一管理（`00_Constants.js:60,64`）
  - **実装場所**: StateManager、Core、Constants各ファイル

- [x] **#11 予約スロット動的表示制御** ✅ **実装完了**
  - **要求**: 当日の講座は終了2時間前から非表示
  - **対象ファイル**: `05-3_Backend_AvailableSlots.js`, `13_WebApp_Views.html`
  - **実装内容**:
    - [x] 当日講座の終了2時間前フィルター実装
    - [x] 現在時刻と終了時刻の比較ロジック
    - [x] 動的フィルタリング機能（`now < twoHoursBefore`判定）
  - **実装場所**: `05-3_Backend_AvailableSlots.js:362-396`

- [x] **#12 キャンセル待ち状態表示** ✅ **実装完了**
  - **問題**: キャンセル待ちの状態が表示されていない
  - **対象ファイル**: `13_WebApp_Views.html`, `13_WebApp_Components.html`
  - **実装内容**:
    - [x] `STATUS.WAITLISTED`定数の管理（`00_Constants.js:70,381`）
    - [x] キャンセル待ち状態の検出・表示ロジック
    - [x] カードUIでの状態別表示実装
    - [x] 色分けによる視覚的区別実装
  - **実装場所**: `13_WebApp_Views.html:968-969`、状態管理全体

#### 2.2.3. 最近発見された新たな問題

- [ ] **#13 ログイン後のローディング画面タイミング調整**
  - **問題**: ログイン時に、ローディング画面が消えるのが早い。ダッシュボード画面になってから消えるようにしたい
  - **対象ファイル**: `14_WebApp_Handlers.html`
  - **具体的対応**:
    - [ ] ダッシュボード画面の表示完了を待つロジック実装
    - [ ] ローディング画面の表示時間調整
    - [ ] UI描画完了の検知機能

- [ ] **#14 新規登録後のホーム画面遷移**
  - **問題**: 新規登録後、ホーム画面に変更したい
  - **対象ファイル**: `14_WebApp_Handlers.html`
  - **具体的対応**:
    - [ ] 新規登録完了後の遷移先変更
    - [ ] ダッシュボード表示への自動遷移実装

- [x] **#15 継続する予約エラー調査**
  - **問題**: 予約関連処理時に「Cannot read properties of undefined (reading '2')」とモーダル表示で処理できない状態は継続
  - **対象ファイル**: `13_WebApp_Views.html`, `14_WebApp_Handlers.html`
  - **現状**: #1で修正したが、別の箇所で同様のエラーが継続発生
  - **具体的対応**:
    - [ ] 予約関連処理の全箇所での防御的プログラミング強化
    - [ ] エラー発生箇所の特定と修正

#### 2.2.4. 操作性向上

- [x] **#16 電話番号入力整形（リアルタイム）**
  - **要求**: 3-4-4桁の区切りで見やすくする
  - **対象ファイル**: `13_WebApp_Views.html`, `14_WebApp_Handlers.html`
  - **具体的対応**:
    - [ ] 入力フィールドでのリアルタイム整形実装
    - [ ] `input`イベントリスナーの追加
    - [ ] ハイフン自動挿入ロジック
    - [ ] カーソル位置調整
    - [ ] コピペ時の適切な処理

- [ ] **#17 新規登録時入力値永続化**
  - **要求**: ページを離れても入力値が維持される
  - **対象ファイル**: `14_WebApp_Handlers.html`, `12_WebApp_StateManager.html`
  - **具体的対応**:
    - [ ] LocalStorageを使用した値保存実装
    - [ ] 入力値の自動保存機能
    - [ ] ページ読み込み時の値復元
    - [ ] 登録完了時のキャッシュクリア
    - [ ] プライバシー配慮（有効期限設定）

### 2.3. 🟢 低優先度（将来的な改善項目）

#### 2.3.1. 追加機能

- [ ] **#18 キャンセル待ち通知機能**
  - **要求**: キャンセル待ちの人に空きが出たときに通知
  - **実装方針**:
    - [ ] メール通知システムの設計
    - [ ] 通知送信トリガーの実装
    - [ ] 通知履歴管理
    - [ ] 通知設定のユーザー選択機能

- [ ] **#19 日程アップデート通知**
  - **要求**: 希望者に日程がアップした場合の通知
  - **実装方針**:
    - [ ] 通知希望者管理機能
    - [ ] 新規日程検知システム
    - [ ] 一括通知機能
    - [ ] 通知停止機能

- [ ] **#20 初回予約者アンケート機能**
  - **要求**: 初めて予約する人にアンケート
  - **実装方針**:
    - [ ] アンケートフォーム作成
    - [ ] 回答データ保存機能
    - [ ] 分析・集計機能
    - [ ] 管理画面での確認機能

- [ ] **#21 複数人予約・会計対応**
  - **要求**: 複数人の予約と一括会計処理
  - **実装方針**:
    - [ ] データ構造の拡張
    - [ ] UI/UXの大幅変更
    - [ ] 料金計算ロジックの複雑化対応
    - [ ] 管理画面での対応

#### 2.3.2. UI/UX改善

- [ ] **#22 デザイン全体刷新**
  - **要求**: 全体の色味やデザインの刷新（<https://www.kibori-class.net/booking> に合わせて）
  - **実装方針**:
    - [ ] 既存サイトのデザイン分析
    - [ ] 新カラーパレット策定
    - [ ] コンポーネントデザインの統一
    - [ ] ブランドガイドライン作成

- [ ] **#23 画面遷移位置調整**
  - **問題**: ページ遷移したとき画面位置がズレたまま
  - **実装方針**:
    - [ ] スクロール位置の記憶機能
    - [ ] 画面遷移時の位置リセット
    - [ ] スムーススクロール実装

- [ ] **#24 会計モーダル調整**
  - **問題**: 会計画面でモーダルが長すぎて画面からはみ出す
  - **実装方針**:
    - [ ] モーダルの最大高さ制限
    - [ ] スクロール可能領域の実装
    - [ ] レスポンシブ対応強化

#### 2.3.3. その他

- [ ] **#25 ログアウト機能追加**
  - **要求**: セキュリティ向上のためのログアウト機能
  - **実装方針**:
    - [ ] セッション管理の実装
    - [ ] ログアウトボタンの配置
    - [ ] データクリア処理

- [x] **#26 キャッシュ再構築改善**
  - **問題**: メニューからのキャッシュ再構築時に確認不要
  - **実装方針**:
    - [ ] 確認ダイアログのスキップ設定
    - [ ] 管理者権限による制御

## 3. 実装フェーズ計画

### 3.1. フェーズ1：緊急修正（1-2週間）

- バグ修正・エラー対応（#1-3）
- デバッグ表示削除（#4）
- 文字ちらつき改善（#5）

### 3.2. フェーズ2：UX改善（2-3週間）

- モバイル表示問題解決（#6）
- UI配置最適化（#7-9）
- 基本機能拡張（#10-12）

### 3.3. フェーズ3：新たな問題対応（1-2週間）

- ローディング画面タイミング調整（#13）
- 新規登録後の画面遷移（#14）
- 継続する予約エラー調査（#15）

### 3.4. フェーズ4：操作性向上（1-2週間）

- 入力システム改善（#16-17）
- その他重要機能

### 3.5. フェーズ5：将来機能（3-4週間）

- 通知システム（#18-19）
- 高度な機能拡張（#20-21）

### 3.6. フェーズ6：全体最適化（2-3週間）

- デザイン刷新（#22）
- 最終調整（#23-26）

## 4. 技術的考慮事項

### 4.1. アーキテクチャ活用

- 既存のデータアクセス抽象化層（`03_DataAccess.js`）の活用
- サービス層（`02-5_BusinessLogic_ReservationService.js`）の拡張
- 統一定数システム（`00_Constants.js`）による設定一元管理
- StateManager（`12_WebApp_StateManager.html`）による状態管理

### 4.2. パフォーマンス

- キャッシュシステムの最適化
- バッチ処理による効率化
- 不要なAPI呼び出しの削減

### 4.3. モバイル対応

- レスポンシブデザインの強化
- タッチ操作の最適化
- 表示領域の効率的活用

## 5. テスト戦略

### 5.1. 各フェーズ共通

1. `npm run push:test` でテスト環境にデプロイ
2. 機能テスト実行
3. `npm run push:prod` で本番環境展開
4. 本番環境での動作確認

### 5.2. 重点テスト項目

- モバイル実機でのUI/UX確認
- 予約・会計フローの完全テスト
- パフォーマンス測定
- エラーハンドリングの検証

## 6. リスク管理

### 6.1. 高リスク項目

- 会計処理の性能改善（業務影響大）
- データ構造変更を伴う機能追加
- UI全体の大幅変更

### 6.2. 対策

- 段階的リリース
- ロールバック計画の準備
- 十分なテスト期間の確保
- ユーザーへの事前告知

## 7. 成功指標

### 7.1. 定量指標

- エラー発生率の削減
- ページ表示速度の改善
- ユーザー操作完了率の向上

### 7.2. 定性指標

- ユーザビリティの向上
- 管理者の運用効率改善
- モバイル体験の向上

---

更新履歴

- 2024-08-31: 初版作成
