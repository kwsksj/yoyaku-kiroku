# Stateç®¡ç†ã®ç¾çŠ¶åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

## èª¿æŸ»æ¦‚è¦

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®stateç®¡ç†ã«ã¤ã„ã¦ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®åˆ©ç”¨çŠ¶æ³ã€è¨­å®šç®‡æ‰€ã€é‡è¤‡ãƒ»æœªä½¿ç”¨ã®æœ‰ç„¡ã‚’èª¿æŸ»ã—ã€ä¸æ•´åˆãŒãªã„ã‹ç¢ºèªã—ã¾ã—ãŸã€‚

## StateManagerã®stateå®šç¾©

### ä¸»è¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ä¸€è¦§

#### User & Session Data

| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£           | å‹           | åˆæœŸå€¤ | ç”¨é€”                         | åˆ©ç”¨çŠ¶æ³      |
| -------------------- | ------------ | ------ | ---------------------------- | ------------- |
| `currentUser`        | Object\|null | null   | ãƒ­ã‚°ã‚¤ãƒ³ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±       | âœ… é »ç¹ã«ä½¿ç”¨ |
| `loginPhone`         | string       | ''     | ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®é›»è©±ç•ªå·å…¥åŠ›å€¤ | âœ… ä½¿ç”¨ä¸­     |
| `isFirstTimeBooking` | boolean      | false  | åˆå›äºˆç´„åˆ¤å®šãƒ•ãƒ©ã‚°           | âœ… ä½¿ç”¨ä¸­     |
| `registrationData`   | Object       | {}     | æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿       | âœ… ä½¿ç”¨ä¸­     |
| `registrationPhone`  | string\|null | null   | ç™»éŒ²æ™‚é›»è©±ç•ªå·               | âœ… ä½¿ç”¨ä¸­     |

#### Core Application Data

| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£         | å‹           | åˆæœŸå€¤ | ç”¨é€”                                       | åˆ©ç”¨çŠ¶æ³      |
| ------------------ | ------------ | ------ | ------------------------------------------ | ------------- |
| `slots`            | Array        | []     | åˆ©ç”¨å¯èƒ½ã‚¹ãƒ­ãƒƒãƒˆä¸€è¦§                       | âœ… é »ç¹ã«ä½¿ç”¨ |
| `myReservations`   | Array        | []     | **çµ±åˆäºˆç´„ãƒ‡ãƒ¼ã‚¿**ï¼ˆæ—§myBookings+historyï¼‰ | âœ… é »ç¹ã«ä½¿ç”¨ |
| `accountingMaster` | Array        | []     | ä¼šè¨ˆãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿                           | âœ… ä½¿ç”¨ä¸­     |
| `classrooms`       | Array        | []     | æ•™å®¤ä¸€è¦§                                   | âœ… ä½¿ç”¨ä¸­     |
| `constants`        | Object\|null | null   | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®šæ•°                           | âœ… ä½¿ç”¨ä¸­     |

#### UI State

| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£                     | å‹           | åˆæœŸå€¤  | ç”¨é€”                 | åˆ©ç”¨çŠ¶æ³            |
| ------------------------------ | ------------ | ------- | -------------------- | ------------------- |
| `view`                         | string       | 'login' | ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼         | âœ… é »ç¹ã«ä½¿ç”¨       |
| `selectedClassroom`            | string\|null | null    | é¸æŠä¸­æ•™å®¤           | âœ… ä½¿ç”¨ä¸­           |
| `selectedSlot`                 | Object\|null | null    | é¸æŠä¸­ã‚¹ãƒ­ãƒƒãƒˆ       | âœ… ä½¿ç”¨ä¸­           |
| `editingReservationDetails`    | Object\|null | null    | ç·¨é›†ä¸­äºˆç´„è©³ç´°       | âœ… ä½¿ç”¨ä¸­           |
| `accountingReservation`        | Object\|null | null    | ä¼šè¨ˆç”»é¢åŸºæœ¬æƒ…å ±     | âœ… ä½¿ç”¨ä¸­           |
| `accountingReservationDetails` | Object       | {}      | ä¼šè¨ˆäºˆç´„è©³ç´°         | âš ï¸ å‚ç…§å°‘ãªã‚       |
| `accountingScheduleInfo`       | Object\|null | null    | ä¼šè¨ˆè¬›åº§æƒ…å ±         | âš ï¸ å‚ç…§å°‘ãªã‚       |
| `completionMessage`            | string       | ''      | å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸       | âœ… å®Œäº†ç”»é¢ã§ä½¿ç”¨ä¸­ |
| `recordsToShow`                | number       | 10      | å±¥æ­´è¡¨ç¤ºä»¶æ•°         | âœ… ä½¿ç”¨ä¸­           |
| `registrationStep`             | number       | 1       | æ–°è¦ç™»éŒ²ã‚¹ãƒ†ãƒƒãƒ—ç•ªå· | âœ… ä½¿ç”¨ä¸­           |
| `searchedUsers`                | Array        | []      | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢çµæœ     | âœ… ä½¿ç”¨ä¸­           |
| `searchAttempted`              | boolean      | false   | æ¤œç´¢å®Ÿè¡Œæ¸ˆã¿ãƒ•ãƒ©ã‚°   | âœ… ä½¿ç”¨ä¸­           |

#### Navigation History

| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£          | å‹    | åˆæœŸå€¤ | ç”¨é€”         | åˆ©ç”¨çŠ¶æ³  |
| ------------------- | ----- | ------ | ------------ | --------- |
| `navigationHistory` | Array | []     | ç”»é¢é·ç§»å±¥æ­´ | âœ… ä½¿ç”¨ä¸­ |

#### System State

| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£              | å‹           | åˆæœŸå€¤ | ç”¨é€”               | åˆ©ç”¨çŠ¶æ³  |
| ----------------------- | ------------ | ------ | ------------------ | --------- |
| `isDataFresh`           | boolean      | false  | ãƒ‡ãƒ¼ã‚¿æ–°é®®åº¦ãƒ•ãƒ©ã‚° | âœ… ä½¿ç”¨ä¸­ |
| `_dataUpdateInProgress` | boolean      | false  | ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­ãƒ•ãƒ©ã‚° | âœ… ä½¿ç”¨ä¸­ |
| `_slotsVersion`         | string\|null | null   | ã‚¹ãƒ­ãƒƒãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ | âœ… ä½¿ç”¨ä¸­ |

#### Computed Data

| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ | å‹     | åˆæœŸå€¤ | ç”¨é€”                                             | åˆ©ç”¨çŠ¶æ³ |
| ---------- | ------ | ------ | ------------------------------------------------ | -------- |
| `computed` | Object | {}     | **ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ï¼ˆå‰å›ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã§å‰Šé™¤ï¼‰ | âœ… æ­£å¸¸  |

## ç™ºè¦‹ã•ã‚ŒãŸå•é¡Œã¨ä¿®æ­£æ¸ˆã¿äº‹é …

### âŒ ä¿®æ­£æ¸ˆã¿ï¼šãƒ¬ã‚¬ã‚·ãƒ¼ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å‚ç…§ã‚¨ãƒ©ãƒ¼

**å•é¡Œ**: ä»¥ä¸‹ã®ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¸ã®å‚ç…§ãŒæ®‹å­˜ã—ã¦ã„ãŸ

- `state.history` â†’ `state.myReservations`ã«çµ±åˆæ¸ˆã¿
- `state.myBookings` â†’ `state.myReservations`ã«çµ±åˆæ¸ˆã¿

**ä¿®æ­£ç®‡æ‰€**:

1. `12_WebApp_StateManager.js:146` - `newState.myBookings` â†’ `newState.myReservations`
2. `14_WebApp_Handlers.js:424` - `state.history.find()` â†’ `state.myReservations.find()`
3. `14_WebApp_Handlers.js:841` - `state.myBookings.find()` â†’ `state.myReservations.find()`
4. æ¥½è¦³çš„UIæ›´æ–°å‡¦ç†ã§ã®ãƒ¬ã‚¬ã‚·ãƒ¼å‚ç…§ã‚’ä¿®æ­£ï¼ˆ3ç®‡æ‰€ï¼‰

### âœ… ä¿®æ­£å®Œäº†ï¼šStateå®šç¾©ã®å®Œå…¨åŒ–

#### `registrationStep`

- **ä¿®æ­£å‰**: ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å†…ã§è¨­å®šã•ã‚Œã¦ã„ã‚‹ãŒã€Stateå®šç¾©ã«ãªã—
- **ä¿®æ­£å¾Œ**: StateManagerå†…ã« `registrationStep: 1` ã¨ã—ã¦è¿½åŠ 
- **çµæœ**: å‹å®‰å…¨æ€§ãŒå‘ä¸Šã€å‹•çš„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å•é¡Œã‚’è§£æ¶ˆ

#### `accountingReservationDetails`

- **å®šç¾©**: ä¼šè¨ˆäºˆç´„è©³ç´°ç”¨
- **å‚ç…§**: éå¸¸ã«é™å®šçš„
- **æ¨å¥¨**: åˆ©ç”¨çŠ¶æ³ã®è©³ç´°ç¢ºèªãŒå¿…è¦

### âœ… ç¢ºèªæ¸ˆã¿ï¼šcompletionMessageã®æ­£å½“ãªç”¨é€”

#### `completionMessage`

- **ç”¨é€”**: å®Œäº†ç”»é¢ï¼ˆ`view: 'complete'`ï¼‰ã§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
- **ä½¿ç”¨ç®‡æ‰€**: äºˆç´„å®Œäº†ãƒ»ä¼šè¨ˆå®Œäº†æ™‚ã®æˆåŠŸ/ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆ7ç®‡æ‰€ï¼‰
- **çµæœ**: å‰Šé™¤ä¸è¦ã€æ­£å¸¸ã«æ´»ç”¨ã•ã‚Œã¦ã„ã‚‹

## Stateè¨­å®šãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆ†æ

### è¨­å®šãƒ‘ã‚¿ãƒ¼ãƒ³1ï¼šå˜ä¸€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æ›´æ–°

```javascript
window.stateManager.dispatch({
  type: 'UPDATE_STATE',
  payload: { loginPhone: p },
});
```

**ä½¿ç”¨é »åº¦**: å¤šæ•°ï¼ˆ35ç®‡æ‰€ä»¥ä¸Šï¼‰

### è¨­å®šãƒ‘ã‚¿ãƒ¼ãƒ³2ï¼šè¤‡æ•°ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æ›´æ–°

```javascript
window.stateManager.dispatch({
  type: 'SET_STATE',
  payload: {
    view: 'dashboard',
    myReservations: data.myReservations,
    isDataFresh: true,
  },
});
```

**ä½¿ç”¨é »åº¦**: ä¸­ç¨‹åº¦ï¼ˆ15ç®‡æ‰€ç¨‹åº¦ï¼‰

### è¨­å®šãƒ‘ã‚¿ãƒ¼ãƒ³3ï¼šã‚¹ãƒ†ãƒƒãƒ—ç®¡ç†

```javascript
payload: {
  registrationStep: 2,
  view: 'registrationStep2'
}
```

**ä¿®æ­£æ¸ˆã¿**: `registrationStep`ã‚’Stateå®šç¾©ã«è¿½åŠ å®Œäº†

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼æ•´åˆæ€§

### âœ… æ­£å¸¸ãªãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

1. **ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼**: `loginPhone` â†’ `currentUser` â†’ `view: 'dashboard'`
2. **äºˆç´„ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**: `slots` â†’ `selectedSlot` â†’ `myReservations`
3. **ä¼šè¨ˆãƒ•ãƒ­ãƒ¼**: `accountingReservation` â†’ `accountingMaster` â†’ è¨ˆç®—å‡¦ç†

### âœ… ä¿®æ­£æ¸ˆã¿ãƒ•ãƒ­ãƒ¼

1. **ç™»éŒ²ãƒ•ãƒ­ãƒ¼**:
   - `registrationData` â† è¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—ã§æ®µéšçš„è“„ç©
   - `registrationStep` â† **Stateå®šç¾©è¿½åŠ å®Œäº†**
   - å‹å®‰å…¨æ€§ãŒå‘ä¸Šã€å®Œå…¨ã«æ­£å¸¸åŒ–

## ä¿®æ­£å®Œäº†äº‹é …

### âœ… Stateå®šç¾©ã®å®Œå…¨åŒ–

```javascript
// 12_WebApp_StateManager.js ã«è¿½åŠ å®Œäº†
/** @type {number} */
registrationStep: 1,
```

### âœ… completionMessageã®ç”¨é€”ç¢ºèª

- äºˆç´„å®Œäº†ãƒ»ä¼šè¨ˆå®Œäº†æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã«æ­£å¸¸ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹
- å‰Šé™¤ä¸è¦ã€ç¶™ç¶šåˆ©ç”¨

### ğŸŸ¢ å„ªå…ˆåº¦ä½ï¼šå‹å®‰å…¨æ€§ã®å‘ä¸Š

- TypeScriptå°å…¥æ™‚ã®Stateå‹å®šç¾©æº–å‚™
- JSDocå‹æ³¨è¨˜ã®å……å®ŸåŒ–

## çµè«–

### âœ… è‰¯å¥½ãªç‚¹

1. **ãƒ‡ãƒ¼ã‚¿çµ±åˆå®Œäº†**: `myReservations`ã¸ã®çµ±åˆãŒæ­£å¸¸ã«å®Œäº†
2. **ä¸€è²«ã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³**: `dispatch()`ã«ã‚ˆã‚‹çŠ¶æ…‹æ›´æ–°ãŒçµ±ä¸€
3. **é©åˆ‡ãªåˆ†é›¢**: UI State / Application Data / System Stateã®æ˜ç¢ºãªåˆ†é›¢

### âœ… ä¿®æ­£å®Œäº†æ¸ˆã¿

1. **Stateå®šç¾©ã®å®Œå…¨åŒ–**: `registrationStep`ã‚’æ­£å¼ã«Stateå®šç¾©ã«è¿½åŠ 
2. **ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ç”¨é€”ç¢ºèª**: `completionMessage`ãŒæ­£å¸¸ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
3. **å‹å®‰å…¨æ€§å‘ä¸Š**: å‹•çš„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å•é¡Œã‚’è§£æ¶ˆ

**ç·åˆè©•ä¾¡**: Stateç®¡ç†ãŒå®Œå…¨ã«æ­£å¸¸åŒ–ã€‚ã™ã¹ã¦ã®ä¸æ•´åˆãŒè§£æ¶ˆã•ã‚Œã€å‹å®‰å…¨æ€§ã‚‚å‘ä¸Šã€‚

---

**èª¿æŸ»æ—¥æ™‚**: 2025-09-08  
**èª¿æŸ»ç¯„å›²**: dev/frontend/ å…¨ãƒ•ã‚¡ã‚¤ãƒ«  
**èª¿æŸ»æ–¹æ³•**: grep pattern matching + æ‰‹å‹•ã‚³ãƒ¼ãƒ‰è§£æ
