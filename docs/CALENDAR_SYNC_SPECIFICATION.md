# 日程マスタ→Googleカレンダー同期機能 仕様書

## 1. 概要

この機能は、手動実行されるバッチ処理として、「日程マスタ」シートを正（Single Source of Truth）とし、その内容をGoogleカレンダーに反映させるものである。

従来の「カレンダーから予定を読み込む」一方通行の処理を置き換え、より正確なデータ管理を実現する。

## 2. 機能要件

- **イベントの作成**: 「日程マスタ」に新規追加された日程を、対応するGoogleカレンダーに新しいイベントとして作成する。
- **イベントの更新**: 「日程マスタ」で既存の日程情報（時間、会場など）が変更された場合、対応するカレンダーイベントも更新する。
- **イベントの削除**: 「日程マスタ」で日程が削除されたり、ステータスが「キャンセル」に変更されたりした場合、対応するカレンダーイベントを削除する。
- **冪等性の担保**: 関数を何度実行しても、カレンダーが意図せず重複して作成されたり、不要な更新がかかったりしないようにする。

## 3. 仕様詳細

### 3.1. 「日程マスタ」シートの変更

- **`カレンダーイベントID` 列の追加**: 現在の「日程マスタ」シートの最終列（例: N列）に、`カレンダーイベントID` というヘッダーの列を新しく追加する。
  - **目的**: この列に、作成したGoogleカレンダーのイベントIDを保存する。これにより、マスタの各行とカレンダーの各イベントが一対一で紐づき、更新・削除処理が確実に行えるようになる。

### 3.2. 同期処理のロジック (`syncScheduleMasterToCalendar` 関数)

1. **処理の開始**: スプレッドシートのメニューから手動で実行される。
2. **ロックの取得**: `LockService` を使用して、処理の多重実行を防止する。
3. **データ読み込み**: 「日程マスタ」シートの全データを一括で読み込む。
4. **ループ処理**: 読み込んだデータを1行ずつ処理する。
   - **`カレンダーイベントID` が空の場合 (新規作成)**:
     1. 行データ（日付、時間、教室、会場など）を取得する。
     2. `CALENDAR_IDS` 定数から教室名に対応するカレンダーIDを特定する。
     3. `CalendarApp.getCalendarById(id).createEvent()` を使い、カレンダーに新しいイベントを作成する。
     4. イベントのタイトルは `【東京教室】木彫り教室` のように、教室名を含めて分かりやすく設定する。
     5. 作成が成功したら、戻り値として得られるイベントIDを、処理中の行の `カレンダーイベントID` 列に書き込む。
   - **`カレンダーイベントID` に値がある場合 (既存・更新・削除)**:
     1. `カレンダーイベントID` を使って、カレンダーから既存のイベントを取得する。
     2. イベントが見つからない場合、IDが無効になっていると判断し、IDのセルをクリアして次の実行で再作成されるようにする。
     3. イベントが見つかった場合：
        - マスタのステータスが `キャンセル` になっていたら、`event.deleteEvent()` でカレンダーのイベントを削除し、`カレンダーイベントID` 列をクリアする。
        - ステータスが `キャンセル` でない場合、マスタ上の情報（時間、会場など）とカレンダーのイベント情報を比較する。
        - 情報に差異があれば、`event.setTime()` や `event.setLocation()` などを使ってイベント情報を更新する。
5. **処理の完了**: 処理件数（作成、更新、削除）をUIでユーザーに通知する。

### 3.3. メニューへの追加

- `onOpen()` 関数に処理を追加し、スプレッドシートのカスタムメニューに「日程マスタをカレンダーへ同期」といった項目でこの新機能を追加する。

---

**作成日**: 2025-08-29
