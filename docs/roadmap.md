# プロジェクトロードマップ: GAS予約管理システム

**最終更新日**: 2025/07/31

## 1. プロジェクト概要 (Overview)

このドキュメントは、GAS予約管理システムの開発・改修タスクを管理するためのロードマップです。ユーザーから提示された資料と、ソースコード分析に基づき、タスクを整理・追加し、プロジェクト全体の可視性を高めることを目的とします。

### カテゴリ定義

* **UX/UI改善 (UI):** ユーザー体験とインターフェースの視覚的な改善に関するタスク。
* **機能改善・拡張 (FE):** 既存機能の改善や、より便利にするための拡張に関するタスク。
* **不具合修正 (BUG):** 明確な不具合の修正に関するタスク。
* **新規機能開発 (NF):** 全く新しい機能の開発に関するタスク。
* **アーキテクチャ・コード品質 (ARC):** コードの構造、データモデル、保守性、堅牢性の向上に関するタスク。
* **運用・テスト (OPS):** ログ、設定、テスト、保守運用に関するタスク。

## 2. 戦略的提言 (Strategic Recommendations)

1. **体験価値の飛躍的向上:** 【信頼性の盤石化】フェーズが完了した今、プロジェクトの主軸は【体験価値の向上】へと移行します。NF-08（先生へのメッセージ機能）とUI-15（制作メモの楽観的UI編集）の完了により、基本的なユーザー体験は大幅に向上しました。次のフェーズでは、FE-14（会計入力内容の保持）やNF-07（代理入力機能）といった管理者体験の向上と、UI-19（非同期ローディング改善）等のパフォーマンス強化に集中すべきです。
2. **品質基盤の段階的強化:** OPS-05（自動テストの部分導入）により、フロントエンド関数のテスト基盤が整いました。次はOPS-051（バックエンド関数の包括的テスト）により、makeReservation、saveAccountingDetails等の重要な関数の品質保証を強化することが重要です。ARC-14（ハードコードID移行）の完了により、セキュリティ基盤も改善されました。
3. **データ整合性の継続的監視:** ARC-09（予約可否判定ロジックの統一）は、依然として重要な課題です。現在のコードでは、WebAppでの空席確認（サマリー参照）と実際の予約実行時（シート直接スキャン）で異なるロジックが使用されており、統一が必要です。全体として、GASの制約（実行時間制限）を考慮したクラウド移行（NF-10）を中長期目標に据える必要があります。

---

## 3. タスクリスト (Task List)s

| ID        | 状態  | 優先度 | タスク名                                               | 詳細・メモ                                                                                                                                                                 | 難易度 | 担当ファイル                                       | 関連グループ     |
| :-------- | :---- | :----- | :----------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----- | :------------------------------------------------- | :--------------- |
| `NF-07`   | `[ ]` | 最高   | **[管理者向け] シート上での代理入力機能**              | アプリが苦手な方向けに、管理者がシート上で直接予約や会計情報を代理入力できる、高速なインターフェースを開発する。（モバイル対応も考慮）                                     | 最高   | (新規 or 既存ファイル)                             | GRP-運用基盤     |
| `NF-06`   | `[ ]` | 最高   | **[データ管理] 名寄せ機能（アカウント統合）**          | 電話番号未登録で予約した旧データと、後に本登録した新データを、同一人物として統合する管理者向け機能を開発する。                                                             | 最高   | (新規ファイル), 04_Backend_User.gs                 | GRP-データ基盤   |
| `OPS-06`  | `[ ]` | 最高   | **[データ移行] 過去データの一括インポート機能**        | 異なる形式の過去の予約データを整形し、現在のシステムに一括で取り込み、生徒IDを付与する管理者向け機能を開発する。                                                           | 最高   | (新規ファイル)                                     | GRP-データ基盤   |
| `ARC-09`  | `[ ]` | 高     | **[アーキテクチャ] 予約可否判定ロジックの統一**        | WebAppでの空席確認（サマリー参照）と、実際の予約実行時（シート直接スキャン）の定員チェックロジックを統一し、不整合のリスクを排除する。                                     | 高     | 05-2_Backend_Write.gs, 03_BusinessLogic_Summary.gs | GRP-データ基盤   |
| `FE-14`   | `[ ]` | 高     | **[会計機能] 会計入力内容の保持**                      | 会計画面の入力内容を、ページを離れても保持する機能を実装する。                                                                                                             | 中     | 12_WebApp_Core.html, 14_WebApp_Handlers.html       | GRP-会計機能     |
| `NF-09`   | `[ ]` | 高     | **[管理者向け] 当日の支払い状況確認ダッシュボード**    | 管理者がその日の参加者全員の支払い状況を一覧で確認できる機能を追加する。                                                                                                   | 高     | (新規ファイル), 13_WebApp_Views.html               | GRP-運用基盤     |
| `NF-03`   | `[ ]` | 高     | **[管理者向け] 管理者用WebAppの開発**                  | スプレッドシート不要で管理業務が完結するWeb UIを開発する。                                                                                                                 | 最高   | (新規ファイル群)                                   | -                |
| `OPS-051` | `[ ]` | 高     | **[品質] バックエンド関数の包括的テスト導入**          | makeReservation、saveAccountingDetails、updateMemoAndGetLatestHistory等の主要バックエンド関数の単体テストを作成し、品質保証を強化する。                                    | 高     | (新規テストファイル)                               | GRP-運用基盤     |
| `ARC-141` | `[ ]` | 中     | **[セキュリティ] OTP認証の導入**                       | 電話番号認証にOTP（ワンタイムパスワード）機能を追加し、認証セキュリティを強化する。                                                                                        | 高     | 04_Backend_User.js, (新規OTP管理ファイル)          | GRP-データ基盤   |
| `ARC-13`  | `[ ]` | 高     | **[パフォーマンス] CacheServiceの拡張活用**            | 短期キャッシュ（生徒名リストなど）をCacheServiceで追加し、シート読み込みを最小化。PropertiesServiceで永続化。                                                              | 中     | 07_CacheManager.gs, 08_Utilities.gs                | GRP-データ基盤   |
| `OPS-07`  | `[ ]` | 高     | **[エラーハンドリング] ログ拡張と通知**                | エラーにスタックトレース追加。Slack/Email通知でアラート。                                                                                                                  | 中     | 08_Utilities.gs                                    | GRP-運用基盤     |
| `ARC-15`  | `[ ]` | 高     | **[コード品質] リファクタリングとES6統一**             | 長い関数を小関数に分割。ES6構文を統一し、テスト追加。                                                                                                                      | 中     | 全ファイル                                         | GRP-運用基盤     |
| `ARC-17`  | `[ ]` | 高     | **[アーキテクチャ] 会計後続処理の非同期化**            | 【BUG-16の調査結果に依存】ロック競合が主要因と特定された場合に実施する、最も効果的な解決策。ユーザーへの応答に必須でない処理を非同期化し、ロック保持時間を最小限に抑える。 | 高     | 05-2_Backend_Write.js, (新規トリガー関数)          | GRP-会計機能     |
| `ARC-16`  | `[ ]` | 高     | **[セキュリティ] サーバーサイド入力値検証の強化**      | WebAppから受け取る全てのユーザー入力に対し、サーバーサイドで型、長さ、不正文字のチェックを行うバリデーション機構を導入し、XSS等の脆弱性を防止する。                        | 中     | 05-2_Backend_Write.js, 04_Backend_User.js          | GRP-データ基盤   |
| `UI-19`   | `[ ]` | 高     | **[UX] 非同期呼び出しとローディング改善**              | スピナーによるローディング表示は実装済み。`google.script.run`をPromiseでラップし、コールバック地獄を解消することで、コードの可読性と保守性を向上させる。                   | 中     | 14_WebApp_Handlers.html                            | GRP-予約体験改善 |
| `ARC-01`  | `[ ]` | 高     | **[データモデル] 予約IDの役割の再定義（席単位予約）**  | `NF-01`のさらに先を見据えた、システムの抜本的なアーキテクチャ変更。1予約N席のデータモデルを実現する。                                                                      | 最高   | (全ファイル)                                       | GRP-データ基盤   |
| `UI-12`   | `[ ]` | 中     | **[デザイン改善] デザインの統一感向上**                | 「あなたの予約」のカード形式デザインを、新規予約エリアなど他の部分にも適用し、全体的な統一感を高める。                                                                     | 低     | 13_WebApp_Views.html                               | GRP-予約体験改善 |
| `NF-051`  | `[ ]` | 中     | **[通知機能] 管理者通知の高度化**                      | 現在のプレーンテキスト形式のメール通知を、より詳細な情報（予約オプション、会計内訳等）を含む、視認性の高いHTMLメールにアップグレードする。                                 | 中     | 08_Utilities.gs, 05-2_Backend_Write.gs, (新規HTML) | GRP-運用基盤     |
| `NF-04`   | `[ ]` | 中     | **[WebApp] 初回参加申し込みフォームの統合**            | GoogleフォームのヒアリングをWebAppの新規登録フローに統合する。                                                                                                             | 高     | 04_Backend_User.gs, 13_WebApp_Views.html           | -                |
| `NF-10`   | `[ ]` | 中     | **[拡張] Cloud Functions移行**                         | 重い処理をFirebase/Cloud Runにオフロードし、GAS制約を回避。                                                                                                                | 最高   | (新規ファイル)                                     | GRP-運用基盤     |
| `OPS-021` | `[ ]` | 中     | **[運用] 構造化ロギングの高度化**                      | 現在の`logActivity`を拡張し、エラー発生時のスタックトレースや実行関数名などのコンテキスト情報を追加。ログレベルの概念も導入し、問題追跡の効率を向上させる。                | 中     | 08_Utilities.gs                                    | GRP-運用基盤     |
| `UI-20`   | `[ ]` | 中     | **[UX/UI] レスポンシブデザインの包括的レビューと改善** | 会計画面など情報量の多い画面がスマートフォン等で正しく表示・操作できるかを確認し、レイアウト崩れや操作性の問題を修正する。                                                 | 中     | 10_WebApp.html, 13_WebApp_Views.html               | GRP-予約体験改善 |
| `BUG-16`  | `[ ]` | 低     | **[仕様] 複数名予約時の手動操作によるデータ不整合**    | 根本原因はコードの不具合ではなく仕様上の制約。短期的にはダミー電話番号による運用で回避。タスクの優先度を下げ、`NF-01`での恒久対応を目指す。                                | 高     | -                                                  | GRP-会計機能     |
| `UI-16`   | `[ ]` | 低     | **[UX改善] ナビゲーションの改善**                      | ページ遷移のナビゲーションをより直感的で分かりやすいものに改善する。                                                                                                       | 低     | 13_WebApp_Views.html, 14_WebApp_Handlers.html      | GRP-予約体験改善 |
| `UI-17`   | `[ ]` | 低     | **[デザイン改善] 配色調整**                            | サイト全体の配色を見直し、調整する。                                                                                                                                       | 低     | 11_WebApp_Config.html                              | GRP-予約体験改善 |

---

## 4. 完了済みタスク (Completed Tasks)

| ID        | 状態  | 優先度 | タスク名                                                         | 詳細・メモ                                                                                                                                                                                                                  | 難易度 | 担当ファイル                                                                             | 関連グループ             | 依存関係 |
| :-------- | :---- | :----- | :--------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----- | :--------------------------------------------------------------------------------------- | :----------------------- | :------- |
| `UI-11`   | `[x]` | 低     | **[UX改善] ローディングメッセージの多様化**                      | 処理状況に応じたメッセージや、ユーモラスなメッセージをランダムに表示する機能を実装済み。ログイン時、申し込み時、会計時のカテゴリ別メッセージとデフォルトメッセージをランダムに3秒ごとに切り替え表示。                          | 低     | 10_WebApp.html, 12_WebApp_Core.html, 14_WebApp_Handlers.html                            | GRP-予約体験改善         | -        |
| `NF-08`   | `[x]` | 中     | **[予約機能] 先生へのメッセージ機能**                            | 予約申し込み時に、先生へのメッセージを任意で入力できる欄を追加する。フロントエンド・バックエンドともに完全実装済み。                                                                                                        | 中     | 05-2_Backend_Write.js, 13_WebApp_Views.html, 14_WebApp_Handlers.html                     | GRP-予約体験改善         | -        |
| `UI-15`   | `[x]` | 中     | **[UX改善] 制作メモの楽観的UI編集**                              | 制作メモをモーダルで編集する機能を実装済み。楽観的UI（即座にフロントエンド更新、サーバー同期）により良好なUX体験を提供。v1.5で完全実装済み。                                                                                | 中     | 13_WebApp_Views.html, 14_WebApp_Handlers.html, 09_Backend_Endpoints.js                   | GRP-参加記録機能         | -        |
| `OPS-05`  | `[x]` | 高     | **[品質] 自動テストの部分導入**                                  | GAS用の簡易テストフレームワークを導入。フロントエンド関数（filterFutureAvailableSlots、groupSlotsByMonth）やメモ編集機能の部分的テストを実装。バックエンド関数の包括的テストは今後の課題。                                  | 高     | test_webapp_functions.html, test_memo_edit.html, test_venue_display.html                 | GRP-運用基盤             | -        |
| `ARC-14`  | `[x]` | 高     | **[セキュリティ] ハードコードID移行**                            | ハードコードされていたID情報をPropertiesServiceに移行完了。SPECIAL_NO_PHONE_LOGIN_COMMAND、ADMIN_EMAIL、SALES_SPREADSHEET_ID等の機密情報が適切に管理されている。                                                            | 高     | 01_Code.js, 04_Backend_User.js, 08_Utilities.js                                          | GRP-データ基盤           | -        |
| `OPS-022` | `[x]` | 中     | **[運用] アクティビティログ機能の強化**                          | アクティビティログの可読性と情報量を向上させ、管理者による利用状況の追跡と問題発生時の原因究明を容易にする。`logActivity`関数の簡素化、スプレッドシート側のARRAYFORMULAと条件付き書式の設定、アクション名の日本語化を実施。 | 中     | 08_Utilities.js, 04_Backend_User.js, 05-2_Backend_Write.js                               | GRP-運用基盤             | -        |
| `NF-01`   | `[x]` | 最高   | **[会計/予約] 電話番号なしユーザーの予約・会計対応**             | 体験参加者や同伴者など、電話番号未登録でも予約・会計処理を可能にする。**複数名同時予約の課題解決**に直結する最重要タスク。                                                                                                  | 中     | 04_Backend_User.js, 05-2_Backend_Write.js, 13_WebApp_Views.html, 14_WebApp_Handlers.html | GRP-会計機能             |          |
| `BUG-17`  | `[x]` | 緊急   | **[会計機能] 「その他販売品」の2行目以降が計算されない不具合**   | `addOtherSalesRow`関数が不正なHTMLを生成していた問題を修正。                                                                                                                                                                | 低     | 14_WebApp_Handlers.html, 13_WebApp_Views.html                                            | GRP-会計機能             | -        |
| `UI-13`   | `[x]` | 低     | **[UX改善] キャンセル待ちの説明強化**                            | 予約確認・一覧画面で「キャンセル待ち」と明記する機能を実装済みのため完了扱い。                                                                                                                                              | 低     | 05-2_Backend_Write.gs, 13_WebApp_Views.html                                              | GRP-予約体験改善         | -        |
| `UI-18`   | `[x]` | 低     | **[デザイン改善] フォント変更**                                  | Webフォント(Zen Kaku Gothic New)を導入済みのため完了扱い。フォントの再選定は別途タスクとする。                                                                                                                              | 低     | 10_WebApp.html                                                                           | GRP-予約体験改善         | -        |
| `FE-13`   | `[x]` | 緊急   | **[会計機能] 会計フローの再設計**                                | 確認モーダルと支払い方法選択による二段階確認を実装。当初計画のチェックボックス方式から変更。                                                                                                                                | 高     | 13_WebApp_Views.html, 14_WebApp_Handlers.html                                            | GRP-会計機能             | -        |
| `NF-05`   | `[x]` | 中     | **[通知機能] 管理者への予約状況通知**                            | `sendAdminNotification`関数により実装済みのため完了扱い。                                                                                                                                                                   | 中     | 05-2_Backend_Write.gs, 08_Utilities.gs                                                   | GRP-運用基盤             | -        |
| `OPS-02`  | `[x]` | 中     | **[運用] 構造化ロギング**                                        | `logActivity`関数により実装済みのため完了扱い。                                                                                                                                                                             | 中     | 08_Utilities.gs                                                                          | GRP-運用基盤             | -        |
| `ARC-11`  | `[x]` | 高     | **[フロントエンド] WebAppのファイル分割**                        | -                                                                                                                                                                                                                           | 高     | 08, 09, 11, 12, 13, 14                                                                   | GRP-運用基盤             | -        |
| `ARC-12`  | `[x]` | 高     | **[ビジネスロジック] イベント処理とバッチ処理のファイル分割**    | -                                                                                                                                                                                                                           | 高     | 02, 02-1, 02-2, 02-3                                                                     | GRP-運用基盤             | -        |
| `FE-15`   | `[x]` | 高     | **[予約シート] 時間制教室のガントチャート自動描画機能**          | -                                                                                                                                                                                                                           | 高     | 02-2, 02-3                                                                               | GRP-時刻関連機能統合     | -        |
| `BUG-15`  | `[x]` | 緊急   | **[UX] データ更新後の画面リロード不具合**                        | -                                                                                                                                                                                                                           | 中     | 09_Backend_Endpoints.gs, 14_WebApp_Handlers.html                                         | GRP-予約体験改善         | -        |
| `BUG-14`  | `[x]` | 緊急   | **[WebApp] ログイン時に「きろく」が表示されない不具合**          | -                                                                                                                                                                                                                           | 中     | 13_WebApp_Views.html, 14_WebApp_Handlers.html                                            | GRP-参加記録機能         | -        |
| `BUG-13`  | `[x]` | 緊急   | **[キャッシュ] 「きろく」キャッシュが1列ズレて生成される不具合** | -                                                                                                                                                                                                                           | 高     | 07_CacheManager.gs                                                                       | GRP-データ基盤           | -        |
| `BUG-12`  | `[x]` | 緊急   | **[キャッシュ] 「きろく」キャッシュが正しく生成されない不具合**  | -                                                                                                                                                                                                                           | 高     | 07_CacheManager.gs                                                                       | GRP-データ基盤           | -        |
| `BUG-11`  | `[x]` | 緊急   | **[会計機能] 受講時間計算が休憩時間を反映しない不具合**          | -                                                                                                                                                                                                                           | 高     | 02-3_BusinessLogic_SheetUtils.gs                                                         | GRP-時刻関連機能統合     | -        |
| `BUG-10`  | `[x]` | 緊急   | **[ガントチャート] 時刻入力時に描画が消える不具合**              | -                                                                                                                                                                                                                           | 高     | 02-2_BusinessLogic_Handlers.gs, 02-3_BusinessLogic_SheetUtils.gs                         | GRP-時刻関連機能統合     | -        |
| `BUG-09`  | `[x]` | 緊急   | **[予約キャンセル] 予約キャンセル後に画面が更新されない不具合**  | -                                                                                                                                                                                                                           | 中     | 05-2_Backend_Write.gs                                                                    | GRP-予約体験改善         | -        |
| `FE-16`   | `[x]` | 最高   | **[会計機能] 会計処理と予約データの同期**                        | -                                                                                                                                                                                                                           | 高     | 05-2, 12, 14                                                                             | GRP-会計機能             | -        |
| `NF-11`   | `[x]` | 最高   | **[パフォーマンス] 過去の参加記録のキャッシュ機能**              | -                                                                                                                                                                                                                           | 最高   | 00-2, 02-1, 07, 09, 13                                                                   | GRP-データ基盤           | -        |
| `NF-12`   | `[x]` | 最高   | **[パフォーマンス] 将来の予約キャッシュ機能（個人秘書方式）**    | -                                                                                                                                                                                                                           | 最高   | 00-2, 02-2, 02-3, 05-2, 09, 14                                                           | GRP-データ基盤           | -        |
| `BUG-07`  | `[x]` | 緊急   | **[サマリー機能] アプリ経由の予約時にサマリーが更新されない**    | -                                                                                                                                                                                                                           | 高     | 05-2, 10                                                                                 | GRP-データ基盤           | -        |
| `BUG-05`  | `[x]` | 緊急   | **[シート操作] GASによる数式の上書き問題**                       | -                                                                                                                                                                                                                           | 高     | 02-3_BusinessLogic_SheetUtils.gs                                                         | GRP-データ基盤           | -        |
| `BUG-08`  | `[x]` | 緊急   | **[予約更新] 東京教室の予約更新時に時刻が消える**                | -                                                                                                                                                                                                                           | 高     | 05-2_Backend_Write.gs                                                                    | GRP-東京教室時刻ロジック | -        |
| `FE-11`   | `[x]` | 高     | **[予約機能] 東京教室の時刻自動設定**                            | -                                                                                                                                                                                                                           | 高     | 05-2_Backend_Write.gs                                                                    | GRP-東京教室時刻ロジック | -        |
| `FE-12`   | `[x]` | 高     | **[予約機能] 東京教室のオプション時刻反映**                      | -                                                                                                                                                                                                                           | 高     | 05-2_Backend_Write.gs                                                                    | GRP-東京教室時刻ロジック | -        |
| `FE-09`   | `[x]` | 高     | **[予約プロセス] 予約完了時のデータ先読み**                      | -                                                                                                                                                                                                                           | 高     | 14_WebApp_Handlers.html, 10_Backend_Endpoints.gs                                         | GRP-予約体験改善         | -        |
| `FE-10`   | `[x]` | 高     | **[きろく機能] 履歴の段階的読み込み**                            | -                                                                                                                                                                                                                           | 高     | 05-1_Backend_Read.gs, 14_WebApp_Handlers.html                                            | GRP-参加記録機能         | -        |
| `BUG-06`  | `[x]` | 高     | **[きろく機能] 制作メモが保存されない不具合**                    | -                                                                                                                                                                                                                           | 中     | 05-2_Backend_Write.gs                                                                    | GRP-参加記録機能         | -        |
| `BUG-04`  | `[x]` | 緊急   | **[ユーザー登録] 電話番号の型変換不具合**                        | -                                                                                                                                                                                                                           | 中     | 04_Backend_User.gs                                                                       | GRP-データ基盤           | -        |
| `BUG-03`  | `[x]` | 緊急   | **[サマリー機能] 予約サマリーの不整合**                          | -                                                                                                                                                                                                                           | 高     | 03_BusinessLogic_Summary.gs, 06_ExternalServices.gs                                      | GRP-データ基盤           | -        |
| `UI-09`   | `[x]` | 高     | **[WebApp全体] プロフィール編集ボタンのレスポンシブ対応**        | -                                                                                                                                                                                                                           | 中     | 9_WebApp.html                                                                            | GRP-予約体験改善         | -        |

---

## 5. グループ定義 (Group Definitions)

| グループID                 | グループ名               | 説明                  -                                                                                                               |
| :------------------------- | :----------------------- | :------------------------------------------------------------------------------------------------------------------------------------ |
| `GRP-会計機能`             | 会計機能関連             | WebAppの会計機能、およびそれに関連するバックエンド処理、データモデル、UIコンポーネントに関するタスク群。                              |
| `GRP-データ基盤`           | データ基盤関連           | 予約データ、生徒名簿、キャッシュなど、システムの根幹をなすデータ構造とその整合性、信頼性を担保するためのタスク群。                    |
| `GRP-運用基盤`             | 運用基盤関連             | ログ、通知、テスト、管理者向け機能など、システムの安定運用と保守性を支えるためのタスク群。                                            |
| `GRP-予約体験改善`         | 予約体験改善関連         | ユーザーが予約を行う際のUI/UX、レスポンス速度、フィードバックなど、予約フロー全体の体験を向上させるためのタスク群。                   |
| `GRP-参加記録機能`         | 参加記録機能関連         | WebAppの「きろく」画面、制作メモの保存・表示、過去の参加履歴の閲覧など、ユーザーが自身の活動を振り返るための機能に関するタスク群。    |
| `GRP-時刻関連機能統合`     | 時刻関連機能統合関連     | 時間制教室のガントチャート描画、受講時間計算、時刻入力のUI/UXなど、時刻データを扱う機能群のロジック統一と不具合修正に関するタスク群。 |
| `GRP-東京教室時刻ロジック` | 東京教室時刻ロジック関連 | 東京教室に特有の、予約種別（本講座、初回講習など）に応じた開始・終了時刻の自動設定ロジックに関するタスク群。                          |
