# パフォーマンス改善計画書

## 1. 背景と目的

本アプリケーションは、データモデルの複雑さに起因するスプレッドシートへの過剰なアクセスがボトルネックとなり、パフォーマンスの遅延が発生しています。

この計画の目的は、**[データモデル再設計提案書](data_model_redesign.md)に基づき、キャッシュ戦略の最適化とデータ構造の抜本的な見直しを行う**ことで、以下の2点を達成することです。

1. **読み込み速度の劇的な向上:** アプリケーションの起動や画面遷移を高速化する。
2. **データ整合性の確保と保守性の向上:** シンプルなデータモデルで、将来の機能拡張を容易にする。

## 2. 基本方針

**[データモデル再設計提案書](data_model_redesign.md)**で定義された新しいアーキテクチャに基づき、サーバーサイドとフロントエンドを段階的に改修します。

## 3. 新しいアーキテクチャ

### 3.1. データソースの役割分担

- **スプレッドシート:**
  - `統合予約シート`: 全ての予約情報のマスター（真実の源泉）。
  - `日程マスタシート`: 開催スケジュールのマスター。
  - `会計マスタシート`: 料金体系・販売品情報のマスター。
  - `生徒名簿シート`: 生徒の基本情報のマスター。
  - `きろくキャッシュシート`: 全生徒の過去の参加記録のマスター。
- **CacheService (高速・揮発性キャッシュ):**
  - 複数ユーザー間で共有され、頻繁に参照されるデータを一時的に保存。
  - 応答速度が最優先されるデータ（全予約情報、日程マスタ、会計マスタ、生徒基本情報）に利用。
- **PropertiesService (永続キャッシュ):**
  - 生徒個別の最新の参加履歴など、永続性が必要な少量のデータに限定して使用。

### 3.2. データごとのキャッシュ戦略

| データ種別         | 保存先              | 詳細                                                                                                                                                             |
| :----------------- | :------------------ | :--------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **全予約データ**   | `CacheService`      | ・キー: `all_reservations` ・値: `統合予約シート`の全データを格納したオブジェクト。 ・更新戦略: 編集時に即座更新 + 定期的なポーリング。                          |
| **日程マスタ**     | `CacheService`      | ・キー: `master_schedule_data` ・値: `日程マスタシート`の全データを格納したオブジェクト。 ・更新戦略: 時間主導型トリガーによる定期的な再構築。                   |
| **生徒基本情報**   | `CacheService`      | ・キー: `all_students_basic` ・値: `生徒名簿シート`からWebAppで利用する必須項目のみを抽出したオブジェクト。 ・更新戦略: 時間主導型トリガーによる定期的な再構築。 |
| **会計マスタ**     | `CacheService`      | ・キー: `master_accounting_data` ・値: 料金や商品のマスターデータ。 ・備考: 実装済み。時間主導型トリガーによる定期的な再構築。                                   |
| **生徒別参加履歴** | `PropertiesService` | ・キー: `student_records_{生徒ID}` ・値: 最新20件の参加記録。 ・備考: 20件を超える過去の記録は`きろくキャッシュシート`からオンデマンドで取得。                   |

### 3.3. 書き込み処理

- 書き込み処理は、まずマスターデータであるスプレッドシート（`統合予約シート`など）を更新し、その後、関連する`CacheService`のキャッシュを更新します。
- これにより、データの一貫性を保ちつつ、後続の読み取り処理を高速化します。

## 4. 実装ステップ

**[データモデル再設計提案書](data_model_redesign.md)**の移行戦略に準拠します。

### Phase 1: データ基盤とキャッシュシステムの構築

1. **マスターデータ基盤の構築:** `日程マスタ`、`統合予約シート`を作成。
2. **新CacheServiceシステムの拡張:** `all_reservations`, `master_schedule_data`,
   `all_students_basic` のキャッシュを構築。
3. **定期的なキャッシュ再構築:** 時間主導型トリガーを設定し、キャッシュの可用性を高める。

### Phase 2: フロントエンド統合・高速化

1. **WebAppの改修:** データ取得ロジックを全面的に`CacheService`経由に変更。
2. **きろく機能の移行:** `きろくキャッシュシート`を参照する方式に改修。
3. **パフォーマンステスト:** 表示速度やキャッシュヒット率を測定・検証。

### Phase 3: システム最適化・クリーンアップ

1. **レガシーシステムの廃止:** 旧予約シート、サマリーシート、生徒名簿の旧列を削除。
2. **コードのクリーンアップ:** 未使用となった関数やロジックを削除。

## 5. 期待される効果

- **パフォーマンス:**
  - 予約カードの表示や更新にかかる時間が **90%以上削減** される見込み。
  - スプレッドシートAPIの呼び出し回数が大幅に減少し、実行時間のタイムアウトエラーのリスクが低減する。
- **保守性と拡張性:**
  - データ構造がシンプルになることで、コードの可読性が向上し、メンテナンスが容易になる。
  - 新機能の追加が容易になる。

## 6. 今後の可能性

- **楽観的UI (Optimistic UI) の導入:**
  - **概要:** ユーザーの書き込み操作時に、サーバーの応答を待たずにUIを即時更新する手法。
  - **メリット:** 書き込み時の待ち時間がなくなり、非常にスムーズな操作感を実現できる。
  - **検討事項:**
    今回のデータモデル再設計が完了し、システムの安定稼働が確認された後、さらなるUX向上のための次期改善フェーズで導入を検討する。堅牢なエラーハンドリングとデータ同期の仕組みが不可欠となる。

---

**作成日:** 2025年8月21日 **バージョン:** 2.0 (データモデル再設計に基づき改訂)
