# パフォーマンス改善とUX向上計画

## 1. 背景と目的

現在のアプリケーションは、初期表示やデータ更新の際にスプレッドシートへのアクセスがボトルネックとなり、パフォーマンスの遅延が発生している。
この計画の目的は、キャッシュ戦略を全面的に再設計し、楽観的UIを導入することで、以下の2点を達成することにある。

1. **読み込み速度の劇的な向上:** アプリケーションの起動や画面遷移を高速化する。
2. **書き込み体験の向上:** データ更新時の待ち時間をなくし、ストレスのない操作感を実現する。

## 2. 基本方針

一度、キャッシュサービス導入前のコミット `77203f4a541ded89ffa945ecee0da61c901ead62` にプロジェクトの状態をリセットする。
その上で、以下の新しいアーキテクチャに基づいて、サーバーサイドとフロントエンドを再構築する。

## 3. 新しいアーキテクチャ

### 3.1. データソースの役割分担

- **スプレッドシート:** 全てのデータのマスター（真実の源泉）。永続的なデータはすべてここに保存される。
- **PropertiesService (永続キャッシュ):** 頻繁にアクセスするが、更新はそれほど頻繁ではないデータを保存する。スプレッドシートへのアクセスを削減する主目的を担う。
- **CacheService (高速・揮発性キャッシュ):** 複数ユーザー間で共有され、かつ頻繁に更新・参照されるデータを一時的に保存する。応答速度が最優先されるデータに利用する。

### 3.2. データごとのキャッシュ戦略

| データ種別           | 保存先              | 詳細                                                                                                                                                                                                                               |
| :------------------- | :------------------ | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **生徒データ**       | `PropertiesService` | ・キー: `student_{生徒ID}` ・値: 生徒の基本情報、**最新20件**の「きろく」、全「よやく」を含むJSON文字列。 ・備考: 20件を超える過去の「きろく」は、UIのボタン操作に応じて都度スプレッドシートから取得する（オンデマンド読み込み）。 |
| **予約サマリー**     | `CacheService`      | ・キー: `reservation_summary` ・値: 全体の予約状況を集計したオブジェクト。 ・備考: UIのメイン画面などで使用。キャッシュの有効期限切れに備えたフォールバック処理を実装する。                                                        |
| **料金・商品マスタ** | `PropertiesService` | ・キー: `master_data` ・値: 料金や商品のマスターデータを格納したJSON文字列。 ・備考: 更新頻度が極めて低いため、`PropertiesService`で永続化する。                                                                                   |

### 3.3. 書き込み処理のUX改善

- **楽観的UI (Optimistic UI)** を全面的に採用する。
- **フロー:**
    1. **UIの即時更新:** ユーザーが書き込み操作（予約追加など）を行うと、サーバーの応答を待たずに、まずUIを成功したものとして即座に更新する。
    2. **バックグラウンド処理:** `google.script.run` を非同期で呼び出し、サーバー側でスプレッドシートと各種キャッシュ（`PropertiesService`, `CacheService`）への書き込み処理を実行する。
    3. **エラーハンドリング:** サーバー処理が失敗した場合のみ、UIを操作前の状態に差し戻し、ユーザーにエラーを通知する。

## 4. 実装ステップ概要

1. **プロジェクトのリセット:** `git reset --hard 77203f4a541ded89ffa945ecee0da61c901ead62` を実行する。
2. **バックエンド (GAS) の実装:**
    - `PropertiesService` および `CacheService` を操作するためのヘルパー関数群を作成する。
    - データ取得関数（例: `getUserData`）を、新しいキャッシュ戦略に基づいて修正する。
    - データ書き込み関数（例: `addReservation`）を、スプレッドシートと関連するキャッシュをすべて更新するように修正する。
    - 特定の生徒の全記録をスプレッドシートから取得する、オンデマンド用の関数を新規作成する。
3. **フロントエンド (HTML/JavaScript) の実装:**
    - データ取得ロジックを、新しいバックエンド関数を呼び出すように修正する。
    - 楽観的UIのロジック（UIの即時更新、`google.script.run` の呼び出し、コールバックでのエラーハンドリング）を実装する。
    - 「全きろくを表示」ボタンと、それに対応するイベントハンドラ（オンデマンド取得関数を呼び出す）を実装する。
