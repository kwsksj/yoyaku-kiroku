# システムアーキテクチャ仕様書

このドキュメントは、Google Apps Script (GAS)で構築された予約管理システム「きぼりの よやく・きろく」の詳細なアーキテクチャを解説します。プロジェクトの構造、扱うデータモデル、そして各ファイルの具体的な機能について網羅的に説明します。

> **開発者向けクイックスタートは [`README.md`](../README.md) を参照してください**

- **目次**
  - [1. プロジェクトの構成](#1-プロジェクトの構成)
  - [2. データモデル（スプレッドシート構造）](#2-データモデルスプレッドシート構造)
    - [2.1. 予約シート (例: 東京教室, つくば教室, 沼津教室)](#21-予約シート-例-東京教室-つくば教室-沼津教室)
    - [2.2. 生徒名簿シート (`ROSTER_SHEET_NAME`)](#22-生徒名簿シート-roster_sheet_name)
    - [2.3. 料金・商品マスタシート (`ACCOUNTING_MASTER_SHEET_NAME`)](#23-料金商品マスタシート-accounting_master_sheet_name)
    - [2.4. 予約サマリーシート (`SUMMARY_SHEET_NAME`)](#24-予約サマリーシート-summary_sheet_name)
    - [2.5. アクティビティログシート (`LOG_SHEET_NAME`)](#25-アクティビティログシート-log_sheet_name)
  - [3. ファイルカテゴリと機能詳細](#3-ファイルカテゴリと機能詳細)
    - [3.1. ファイルカテゴリ](#31-ファイルカテゴリ)
    - [3.2. スプレッドシート管理とパフォーマンス最適化](#32-スプレッドシート管理とパフォーマンス最適化)
    - [3.3. エントリーポイントとグローバル設定](#33-エントリーポイントとグローバル設定)
    - [3.4. ビジネスロジック](#34-ビジネスロジック)
    - [3.5. バックエンドAPI](#35-バックエンドapi)
    - [3.6. 外部サービス連携](#36-外部サービス連携)
    - [3.7. キャッシュ管理](#37-キャッシュ管理)
    - [3.8. ユーティリティ](#38-ユーティリティ)
    - [3.9. Webアプリケーション (HTML/JavaScript)](#39-webアプリケーション-htmljavascript)
  - [4. システムアーキテクチャとデータフロー](#4-システムアーキテクチャとデータフロー)
    - [4.1. 全体的なデータフロー](#41-全体的なデータフロー)
    - [4.2. 主要な処理パターン](#42-主要な処理パターン)
    - [4.3. キャッシュ戦略とパフォーマンス](#43-キャッシュ戦略とパフォーマンス)
  - [5. エラーハンドリングと障害対応](#5-エラーハンドリングと障害対応)
    - [5.1. エラーハンドリング戦略](#51-エラーハンドリング戦略)
    - [5.2. 一般的なエラーパターンと対処法](#52-一般的なエラーパターンと対処法)
    - [5.3. 障害時の復旧手順](#53-障害時の復旧手順)
  - [6. パフォーマンス指針と最適化](#6-パフォーマンス指針と最適化)
    - [6.1. 重い処理とボトルネック](#61-重い処理とボトルネック)
    - [6.2. パフォーマンス最適化のベストプラクティス](#62-パフォーマンス最適化のベストプラクティス)
    - [6.3. スケーラビリティの考慮事項](#63-スケーラビリティの考慮事項)

## 1. プロジェクトの構成

プロジェクトは、責務に応じて機能ごとにファイルが分割されています。主な構成要素は以下の通りです。

- **データモデル**: アプリケーションが扱うデータの構造（スプレッドシートの各シートの定義）。
- **スクリプトファイル**: 役割に応じて分類された、ロジックを実装するファイルの集まり。
- **ロードマップ**: プロジェクトの将来的な計画、目標、および開発の方向性を示すドキュメント。詳細は [roadmap.md](roadmap.md) を参照してください。

## 2. データモデル（スプレッドシート構造）

このプロジェクトは、以下のGoogleスプレッドシートをデータベースとして利用します。

### 2.1. 予約シート (例: 東京教室, つくば教室, 沼津教室)

各教室の予約情報を時系列で記録する主要なデータテーブル。

| ヘッダー名 (定数)                         | データ型             | 説明                                                                                                           |
| ----------------------------------------- | -------------------- | -------------------------------------------------------------------------------------------------------------- |
| `予約ID` (`HEADER_RESERVATION_ID`)        | `UUID (String)`      | 各予約行を一位に特定するID。行挿入時に自動採番される。                                                         |
| `生徒ID` (`HEADER_STUDENT_ID`)            | `UUID (String)`      | 予約者を示すID。「生徒名簿」シートの`生徒ID`と関連する。                                                       |
| `日付` (`HEADER_DATE`)                    | `Date`               | 予約日。この列を基準にソートされる。**必須項目**。                                                             |
| `会場` (`HEADER_VENUE`)                   | `String`             | 東京教室の場合のみ、カレンダーから自動入力される。                                                             |
| `人数` (`HEADER_PARTICIPANT_COUNT`)       | `Number` or `String` | 予約者の出席番号（1, 2, ...）を示す数値、または`waiting`, `cancel`といった予約の特殊な状態を示す文字列が入る。 |
| `名前` (`HEADER_NAME`)                    | `String`             | 予約者の名前（本名またはニックネーム）。入力されると`生徒ID`が自動補完される。**必須項目**。                   |
| `回数` (`HEADER_CLASS_COUNT`)             | `Number`             | その予約時点での、その生徒の累計参加回数。名簿から自動入力される。                                             |
| `初講` (`HEADER_FIRST_LECTURE`)           | `Boolean`            | 初回講習の参加者であるかを示すフラグ (`TRUE`または空欄)。                                                      |
| `早出` (`HEADER_EARLY_ARRIVAL`)           | `Boolean`            | 早出オプションの利用者であるかを示すフラグ (`TRUE`または空欄)。                                                |
| `彫刻刀レンタル` (`HEADER_CHISEL_RENTAL`) | `Boolean`            | 彫刻刀レンタルの利用者であるかを示すフラグ (`TRUE`または空欄)。                                                |
| `受講時間` (`HEADER_TIME`)                | `Number`             | 時間制教室での課金対象時間。`開始時刻`と`終了時刻`から自動計算される。                                         |
| `制作メモ` (`HEADER_WORK_IN_PROGRESS`)    | `String`             | その日の作業内容のメモ。WebAppから編集可能。                                                                   |
| `order` (`HEADER_ORDER`)                  | `String`             | 物販の購入希望など。WebAppから編集可能。                                                                       |
| `会計詳細` (`HEADER_ACCOUNTING_DETAILS`)  | `JSON (String)`      | WebAppの会計機能で記録された詳細な会計情報。JSON形式で保存される。                                             |
| `LINE`, `in the future`, `notes`, `from`  | `String`             | 生徒名簿と同期される、各種メモ情報。                                                                           |
| `開始時刻` (`HEADER_START_TIME`)          | `Time`               | 時間制教室での講座開始時刻。                                                                                   |
| `終了時刻` (`HEADER_END_TIME`)            | `Time`               | 時間制教室での講座終了時刻。                                                                                   |
| `休憩開始` (`HEADER_BREAK_START`)         | `Time`               | 時間制教室での休憩開始時刻（マスタ参照用）。                                                                   |
| `休憩終了` (`HEADER_BREAK_END`)           | `Time`               | 時間制教室での休憩終了時刻（マスタ参照用）。                                                                   |

### 2.2. 生徒名簿シート (`ROSTER_SHEET_NAME`)

全ての生徒の基本情報と、予約シートから同期されるキャッシュ情報を管理する。現在は36列の詳細な情報を管理している。

#### 基本情報

| ヘッダー名 (定数)                         | データ型        | 説明                                                                                     |
| ----------------------------------------- | --------------- | ---------------------------------------------------------------------------------------- |
| `生徒ID` (`HEADER_STUDENT_ID`)            | `UUID (String)` | 全ての生徒を一位に特定するID。**主キー**。初回予約時または新規登録時に自動採番。          |
| `本名` (`HEADER_REAL_NAME`)               | `String`        | 生徒の本名。                                                                             |
| `ニックネーム` (`HEADER_NICKNAME`)        | `String`        | WebApp上での表示名。空欄の場合は本名が使用される。                                       |
| `電話番号` (`HEADER_PHONE`)               | `String`        | WebAppのログイン認証に使用。先頭ゼロが消えないよう文字列として保存。                     |
| `メールアドレス`                          | `String`        | 生徒の連絡用メールアドレス。                                                             |
| `メール連絡希望`                          | `Boolean`       | メールでの連絡を希望するかのフラグ。                                                     |
| `登録日時`                                | `Timestamp`     | 生徒がシステムに登録された日時。                                                         |

#### 参加回数管理

| ヘッダー名                                | データ型 | 説明                                                             |
| ----------------------------------------- | -------- | ---------------------------------------------------------------- |
| `参加回数` (`HEADER_UNIFIED_CLASS_COUNT`) | `Number` | 全教室の累計参加回数。アーカイブ処理時に自動で加算される。       |
| `参加回数（東京）`                        | `Number` | 東京教室での参加回数。                                           |
| `参加回数（沼津）`                        | `Number` | 沼津教室での参加回数。                                           |
| `参加回数（つくば）`                      | `Number` | つくば教室での参加回数。                                         |
| `参加回数（三越）`                        | `Number` | 三越教室での参加回数。                                           |

#### プロフィール情報

| ヘッダー名                   | データ型 | 説明                                               |
| ---------------------------- | -------- | -------------------------------------------------- |
| `年代`                       | `String` | 生徒の年代（例：20代、30代など）。                 |
| `年齢`                       | `Number` | 生徒の具体的な年齢。                               |
| `性別`                       | `String` | 生徒の性別。                                       |
| `利き手`                     | `String` | 右利き・左利きの情報。彫刻刀の配置などで参考。     |
| `住所`                       | `String` | 生徒の住所情報。                                   |

#### 受講関連設定

| ヘッダー名               | データ型   | 説明                                                   |
| ------------------------ | ---------- | ------------------------------------------------------ |
| `車`                     | `Boolean`  | 車で来場する生徒であるかを示すフラグ。                             |
| `彫刻刀レンタル`         | `Boolean`  | 彫刻刀レンタルの利用者であるかを示すフラグ。           |
| `同行者`                 | `String`   | 通常の同行者情報（家族、友人など）。                   |
| `来場手段`               | `String`   | 通常の来場手段（電車、車、徒歩など）。                 |
| `送迎`                   | `String`   | 送迎に関する特記事項。                                 |

#### 木彫り関連情報

| ヘッダー名                      | データ型 | 説明                                           |
| ------------------------------- | -------- | ---------------------------------------------- |
| `将来制作したいもの`            | `String` | 生徒が将来作りたい作品の希望。                 |
| `木彫り経験`                    | `String` | 過去の木彫り経験の有無・内容。                 |
| `過去の制作物`                  | `String` | これまでに制作した作品の記録。                 |
| `今後のご参加について`          | `String` | 継続参加の意向や頻度の希望。                   |

#### メモ・コミュニケーション

| ヘッダー名            | データ型 | 説明                                                 |
| --------------------- | -------- | ---------------------------------------------------- |
| `LINE`                | `String` | LINE関連の連絡事項。予約シートから同期される。       |
| `in the future`       | `String` | 将来的な計画や要望。予約シートから同期される。       |
| `notes`               | `String` | 一般的なメモ。予約シートから同期される。             |
| `from`                | `String` | 生徒の出身地や紹介元情報。予約シートから同期される。 |

#### キャッシュデータ

| ヘッダー名              | データ型        | 説明                                                                                                                                                                                                                                                                                                                                                  |
| ----------------------- | --------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `よやくキャッシュ`      | `JSON (String)` | 未来の予約情報オブジェクトの配列をJSON文字列として保存するキャッシュ列。                                                                                                                                                                                                                                                                              |
| `きろく_2025`           | `JSON (String)` | 2025年の参加日時、教室名、会場、制作メモ、会計詳細の配列をJSON文字列として保存するキャッシュ列。                                                                                                                                                                                                                                                      |
| `きろく_2024`           | `JSON (String)` | 2024年の参加履歴キャッシュ。                                                                                                                                                                                                                                                                                                                          |
| `きろく_2023`           | `JSON (String)` | 2023年の参加履歴キャッシュ。                                                                                                                                                                                                                                                                                                                          |
| `きろく_2022`           | `JSON (String)` | 2022年の参加履歴キャッシュ。                                                                                                                                                                                                                                                                                                                          |
| `きろく_2021`           | `JSON (String)` | 2021年の参加履歴キャッシュ。**[設計思想]** 会計詳細は`予約シート`や`売上ログ`にも記録されるためデータとしては冗長だが、WebAppの「きろく」画面での会計詳細表示を高速化（サーバー通信を不要に）し、エラー発生リスクを最小化するため、意図的にキャッシュに含めている（非正規化）。                                                                 |

### 2.3. 料金・商品マスタシート (`ACCOUNTING_MASTER_SHEET_NAME`)

WebAppの会計機能で使用される、全ての料金体系と販売商品を定義する。

| ヘッダー名 | データ型 | 説明                                                                           |
| ---------- | -------- | ------------------------------------------------------------------------------ |
| `種別`     | `String` | `授業料`, `物販`, `材料`のいずれか。WebAppの会計画面の表示分類に使用。         |
| `項目名`   | `String` | 料金や商品の名前（例：「本講座」「彫刻刀レンタル」「クスノキ」）。**主キー**。 |
| `単価`     | `Number` | 料金または商品の単価。                                                         |
| `単位`     | `String` | 料金の単位（例：「30分」「cm³」）。時間制や体積計算のロジック分岐に使用。      |
| `対象教室` | `String` | その項目が適用される教室名。`共通`または特定の教室名を記述。                   |
| `備考`     | `String` | 割引の条件など、補足的な説明。旧`説明`列。                                     |
| `講座開始` | `Time`   | 授業料タイプの項目における、講座の公式な開始時刻。                             |
| `講座終了` | `Time`   | 授業料タイプの項目における、講座の公式な終了時刻。                             |
| `休憩開始` | `Time`   | 時間制教室における、課金対象から除外する休憩時間の開始時刻。                   |
| `休憩終了` | `Time`   | 時間制教室における、課金対象から除外する休憩時間の終了時刻。                   |

### 2.4. 予約サマリーシート (`SUMMARY_SHEET_NAME`)

WebAppの空席表示を高速化するための、集計済みデータ。`rebuildSummarySheet`または`updateSummarySheet`によって自動更新される。

| ヘッダー名 (定数)                              | データ型    | 説明                                                       |
| ---------------------------------------------- | ----------- | ---------------------------------------------------------- |
| `ユニークキー` (`HEADER_SUMMARY_UNIQUE_KEY`)   | `String`    | `日付_教室名_セッション`の形式。この行を一位に特定するID。 |
| `日付` (`HEADER_DATE`)                         | `Date`      | 予約日。                                                   |
| `教室名` (`HEADER_SUMMARY_CLASSROOM`)          | `String`    | 教室名。                                                   |
| `セッション` (`HEADER_SUMMARY_SESSION`)        | `String`    | `午前`, `午後`, `全日`, `本講座`, `初回講習`のいずれか。   |
| `会場` (`HEADER_SUMMARY_VENUE`)                | `String`    | 教室の開催場所。                                           |
| `定員` (`HEADER_SUMMARY_CAPACITY`)             | `Number`    | そのセッションの定員。                                     |
| `予約数` (`HEADER_SUMMARY_RESERVATION_COUNT`)  | `Number`    | 現在の予約者数。                                           |
| `空席数` (`HEADER_SUMMARY_AVAILABLE_COUNT`)    | `Number`    | `定員 - 予約数`で算出される空席数。                        |
| `最終更新日時` (`HEADER_SUMMARY_LAST_UPDATED`) | `Timestamp` | この行が最後に更新された日時。                             |

### 2.5. アクティビティログシート (`LOG_SHEET_NAME`)

ユーザーの操作やシステムの重要なイベントを時系列で記録する。問題発生時の追跡や利用状況の分析に用いる。

| ヘッダー名       | データ型    | 説明                                                                                               |
| ---------------- | ----------- | -------------------------------------------------------------------------------------------------- |
| `タイムスタンプ` | `Timestamp` | ログが記録された日時。                                                                             |
| `生徒ID`         | `String`    | 操作を行ったユーザーの「生徒ID」。システムによる操作の場合は`system`や管理者メールアドレスが入る。 |
| `ニックネーム`   | `String`    | 操作を行ったユーザーの表示名（ニックネーム、または本名）。                                         |
| `アクション`     | `String`    | 操作の種類を識別する文字列 (例: `LOGIN_SUCCESS`, `RESERVATION_CREATE`)。                           |
| `結果`           | `String`    | 操作の結果 (`SUCCESS` or `FAILURE`)。                                                              |
| `詳細`           | `String`    | 操作に関する追加情報（予約ID、エラーメッセージなど）。                                             |

## 3. ファイルカテゴリと機能詳細

### 3.1. ファイルカテゴリ

プロジェクトは大きく分けて以下のカテゴリに分類されます。

1. **スプレッドシート管理とパフォーマンス最適化**: スプレッドシートオブジェクトのキャッシュ管理とアクセス最適化。
2. **エントリーポイントとグローバル設定**: プロジェクトのグローバル定数、UI定義、マニフェスト設定。
3. **ビジネスロジック**: アプリケーションの主要な機能（バッチ処理、イベントハンドラ、シート操作、サマリー更新）。
4. **バックエンドAPI**: Webアプリケーションからのデータ読み書き要求を処理するAPI。
5. **外部サービス連携**: GoogleフォームやGoogleカレンダーとの連携。
6. **キャッシュ管理**: パフォーマンス向上のためのデータキャッシュ処理。
7. **ユーティリティ**: プロジェクト全体で利用される汎用関数。
8. **Webアプリケーション (HTML/JavaScript)**: ユーザーインターフェースとクライアントサイドロジック。

---

### 3.2. スプレッドシート管理とパフォーマンス最適化

- **`00_SpreadsheetManager.js`**
  - **役割**: スプレッドシートオブジェクトの共通管理とキャッシュによるパフォーマンス向上を実現します。`SpreadsheetApp.getActiveSpreadsheet()`の重複呼び出しを避け、シートオブジェクトもキャッシュすることで処理速度を向上させます。
  - **主要機能**:

    | 主要機能・クラス      | 役割                                                                                                 |
    | :-------------------- | :--------------------------------------------------------------------------------------------------- |
    | `SpreadsheetManager`  | スプレッドシートとシートオブジェクトのキャッシュ管理を行うクラス                                     |
    | `getSpreadsheet()`    | アクティブなスプレッドシートオブジェクトをキャッシュ付きで取得                                       |
    | `getSheet(sheetName)` | 指定されたシートをキャッシュ付きで取得                                                               |
    | `getTimezone()`       | スプレッドシートのタイムゾーンをキャッシュ付きで取得                                                 |
    | `clearCache()`        | 全キャッシュをクリア（テスト時や強制リフレッシュ時に使用）                                           |
    | `SS_MANAGER`          | グローバルインスタンス。プロジェクト全体でスプレッドシートアクセスを統一管理                         |
    | 互換性ヘルパー関数    | `getActiveSpreadsheet()`, `getSheetByName()`, `getSpreadsheetTimezone()`で既存コードとの互換性を保持 |

---

### 3.3. エントリーポイントとグローバル設定

- **`01_Code.js`**
  - **役割**: プロジェクト全体の中央設定とエントリーポイント。グローバル定数、トリガー関数、テスト機能を集約。
  - **主要機能**:

    | 主要関数                 | 役割                                                                                  |
    | :----------------------- | :------------------------------------------------------------------------------------ |
    | `include(filename)`      | HTMLファイルのサーバーサイドインクルード（GASテンプレート評価）。                     |
    | `doGet(e)`               | Webアプリケーションのメインエントリーポイント。テスト/本番モードの切り替えも管理。    |
    | `onOpen()`               | スプレッドシート開封時のカスタムUIメニュー作成。                                      |
    | `addAdminMenu(menu)`     | 管理者機能（バッチ処理、テスト環境構築など）をメニューに追加。                        |
    | `addCacheMenu(menu)`     | キャッシュ管理機能をメニューに追加。                                                  |
    | `handleOnChange(e)`      | シート変更イベントのトリガーハンドラ。実際の処理は02-2_BusinessLogic_Handlers.jsに委譲。 |
    | `handleEdit(e)`          | セル編集イベントのトリガーハンドラ。実際の処理は02-2_BusinessLogic_Handlers.jsに委譲。   |
    | `debugTestSetup()`       | デバッグ用のテスト環境構築。                                                          |
    | `runDirectTest()`        | 直接テスト実行機能。                                                                  |
    | `runRegressionTest()`    | リグレッションテスト実行機能。                                                        |

  - **重要な定数定義**: 教室名、シート名、ヘッダー定数、定員設定、外部サービスID、ステータス定数など、システム全体で使用される設定値を一元管理。

- **`appsscript.json`**
  - **役割**: プロジェクトのマニフェストファイル。タイムゾーン、依存ライブラリ、実行APIのスコープ（権限）、Webアプリのアクセスレベルなど、プロジェクト全体の動作に関わる設定を定義します。

---

### 3.4. ビジネスロジック

- **`02-1_BusinessLogic_Batch.js`**
  - **役割**: データアーカイブと一括処理を担当する重いバッチ処理モジュール。手動実行またはスケジュール実行される。
  - **主要機能**:

    | 主要関数                                         | 役割                                                                           |
    | :----------------------------------------------- | :----------------------------------------------------------------------------- |
    | `processYesterdayData()`                         | 昨日までのデータを処理するメニュー関数。                                       |
    | `processTodayData()`                             | 今日のデータを処理するメニュー関数。                                           |
    | `processOldestDate()`                            | 最も古い日付のデータを処理するメニュー関数。                                   |
    | `processReservations(mode)`                      | 予約処理のメイン関数。過去の予約をアーカイブし、売上データを転記する。         |
    | `transferPastReservationsToArchive(options)`     | 過去の予約をアーカイブシートに移動し、売上ログと名簿キャッシュを更新。         |
    | `updateRosterWithRecordCache(archivedData, headerMap, classroomName)` | アーカイブされた予約データに基づき、生徒名簿の「きろく」キャッシュを更新する。 |
    | `deleteProcessedReservations(sheet, rowsToDelete)` | 処理済みの予約行をシートから削除。                                       |
    | `logSalesFromArchivedData()`                     | アーカイブデータから会計情報を抽出し、売上ログに転記。                         |
    | `setupTestEnvironment()`                         | 開発用のテスト環境をセットアップ。スプレッドシートをコピーして作成。           |

  - **処理フロー**: 過去データの特定 → アーカイブ転送 → 売上ログ作成 → キャッシュ更新 → 元データ削除の順序で実行。

- **`02-2_BusinessLogic_Handlers.js`**
  - **役割**: スプレッドシートのリアルタイム編集イベントに応答する即座反映システム。
  - **主要機能**:

    | 主要関数                                   | 役割                                                               |
    | :----------------------------------------- | :----------------------------------------------------------------- |
    | `processCellEdit(e)`                       | セル編集イベントの中央調整器。編集対象に応じて適切なハンドラに分岐。 |
    | `processChange(changeType)`                | シート構造変更（行挿入等）イベントの処理。                         |
    | `handleReservationSheetEdit(e)`            | 予約シート専用の編集イベント処理。名前・人数変更時の自動補完を管理。 |
    | `handleRosterEdit(e)`                      | 生徒名簿シート専用の編集イベント処理。                             |
    | `handleNameEdit(e, header)`                | 予約シートで名前列編集時の自動データ補完処理。                     |
    | `_handleParticipantCountEditInReservation()` | 人数列でキャンセル入力時の特殊処理。                               |

  - **即時性**: GASトリガーによる即座反映でユーザー操作に対する高いレスポンシブネスを実現。

- **`02-3_BusinessLogic_SheetUtils.js`**
  - **役割**: シート操作の共通ライブラリ。予約・名簿シートの複雑な操作を抽象化。
  - **主要機能**:

    | 主要関数                                      | 役割                                                                               |
    | :-------------------------------------------- | :--------------------------------------------------------------------------------- |
    | `updateAndSortSheet(sheet, editedRange, oldValue)` | 包括的なシートソート・再採番・罫線描画処理。                                   |
    | `sortAndRenumberDateBlock(sheet, date)`       | 特定日付ブロックのソートと人数列の連番再採番。                                     |
    | `manuallyReSortAndNumberSheet()`              | メニューからのシート全体手動ソート・採番機能。                                     |
    | `updateBillableTime(sheet, rowIndex)`         | 時間制教室の課金対象時間計算と「受講時間」列更新。                                 |
    | `updateGanttChart(sheet, rowIndex)`           | 指定行のガントチャート（時間可視化）更新。                                         |
    | `handleRowInsert(sheet)`                      | 新規行挿入時の日付・会場自動入力処理。                                             |
    | `insertEmptyRowForCancellation()`             | キャンセル処理用の空行挿入。                                                       |
    | `handleReservationNameClear()`                | 予約者名クリア時の関連データ一括クリア処理。                                       |
    | `populateReservationWithRosterData()`         | 名前入力時の生徒名簿データからの自動補完処理。                                     |
    | `updateFutureReservations()`                  | 生徒名簿更新時の未来予約データ同期処理。                                           |
    | `getRosterData()`                             | 生徒名簿シートからの構造化データ取得・整形。                                       |
    | `_rebuildFutureBookingsCacheForStudent(studentId)` | 指定生徒の将来予約情報の全シート再集計・キャッシュ再構築。                 |
    | `_updateFutureBookingsCacheIncrementally()`   | 効率的なキャッシュ差分更新処理。                                                   |

  - **特徴**: ハンドラやバッチ処理から呼び出される共通操作レイヤー。複雑なシート操作のカプセル化を実現。

- **`03_BusinessLogic_Summary.js`**
  - **役割**: 予約集計・サマリー管理とGoogleフォーム連携を担当するデータ集約システム。
  - **主要機能**:

    | 主要関数                               | 役割                                                                       |
    | :------------------------------------- | :------------------------------------------------------------------------- |
    | `updateSummaryAndForm(classroom, date)` | サマリーシートとGoogleフォーム選択肢の統合更新処理。                       |
    | `triggerSummaryUpdateFromEdit(e)`      | 編集イベント起点での関連日付サマリー更新トリガー。                         |
    | `rebuildSummarySheet()`                | 予約サマリーシート全体のゼロからの再構築処理。                             |
    | `_updateSummaryForDate(sheetName, date)` | 特定教室・日付の予約状況再計算とサマリーシート書き込み。                   |
    | `_getReservationCountsForDate()`       | 指定日付の予約数セッション別集計。                                         |
    | `_createSummaryRowData()`              | サマリー行データのフォーマット処理。                                       |
    | `_calculateTokyoAvailability()`        | 東京教室の特別な空席計算ロジック。                                         |
    | `_getVenueForDate()`                   | 指定日付の会場情報取得。                                                   |

  - **データフロー**: 予約データ集計 → サマリーシート更新 → Googleフォーム選択肢反映のパイプライン処理。

---

### 3.5. バックエンドAPI

- **`04_Backend_User.js`**
  - **役割**: WebApp向けユーザー認証・プロフィール管理API。電話番号ベース認証システムの中核。
  - **主要機能**:

    | 主要関数                              | 役割                                                           |
    | :------------------------------------ | :------------------------------------------------------------- |
    | `authenticateUser(phoneNumber)`       | 電話番号ベースのユーザー認証処理。                             |
    | `getUsersWithoutPhoneNumber()`        | 電話番号未登録ユーザーリスト取得（特別ログイン用）。           |
    | `registerNewUser(userInfo)`           | 新規ユーザーの生徒名簿登録処理。                               |
    | `updateUserProfile(userInfo)`         | ユーザープロフィール（本名、ニックネーム、電話番号）更新。     |
    | `_normalizeAndValidatePhone(phoneNumber, allowEmpty)` | 電話番号の正規化・バリデーション処理。                 |

  - **認証方式**: 電話番号をキーとした認証で、セキュリティと利便性のバランスを実現。

- **`05-1_Backend_Read.js`**
  - **役割**: WebApp向けの読み取り専用データ取得API。パフォーマンス最適化された参照処理。
  - **主要機能**:

    | 主要関数                            | 役割                                                             |
    | :---------------------------------- | :--------------------------------------------------------------- |
    | `getReservationDetails(params)`     | 会計・詳細画面用の予約情報取得。                                 |
    | `getReservationDetailsForEdit()`    | 予約編集画面向けの全詳細情報取得。                               |
    | `getAccountingMasterData()`         | 料金・商品マスタデータの取得。                                   |
    | `getParticipationHistory(studentId, limit, offset)` | ページング対応の生徒参加履歴取得。                   |

  - **特徴**: 読み取り専用に特化した高速データアクセスレイヤー。キャッシュデータの積極活用で応答性を向上。

- **`05-2_Backend_Write.js`**
  - **役割**: WebApp向けの複雑な書き込み・状態変更処理API。ビジネスロジックとデータ整合性を保証。
  - **主要機能**:

    | 主要関数                            | 役割                                                     |
    | :---------------------------------- | :------------------------------------------------------- |
    | `makeReservation(reservationInfo)`  | 新規予約作成処理（バリデーション、競合チェック含む）。   |
    | `cancelReservation(cancelInfo)`     | 予約キャンセル処理とサマリー更新。                       |
    | `updateReservationDetails(details)` | 予約詳細情報の一括更新処理。                             |
    | `saveAccountingDetails(payload)`    | 会計詳細の処理・保存とレシート生成。                     |
    | `updateMemoAndGetLatestHistory()`   | 制作メモ更新と最新参加履歴の同期取得。                   |
    | `_validateTimeBasedReservation()`   | 時間制予約の詳細バリデーション。                         |
    | `_logSalesForSingleReservation()`   | 個別予約の売上ログ記録。                                 |
    | `_updateRecordCacheForSingleReservation()` | 個別予約のレコードキャッシュ更新。                 |
    | `_archiveSingleReservation()`       | 完了予約の個別アーカイブ処理。                           |

  - **複雑性**: 状態変更、データ整合性、関連テーブル更新、キャッシュ同期を一元管理する重要な処理層。

- **`09_Backend_Endpoints.js`**
  - **役割**: WebApp通信最適化のための統合APIエンドポイント。レスポンス時間とUX向上を重視。
  - **主要機能**:

    | 主要関数                                          | 役割                                                           |
    | :------------------------------------------------ | :------------------------------------------------------------- |
    | `getInitialWebApp_Data(studentId)`               | WebApp初期化用全データの一括取得（通信回数削減）。             |
    | `makeReservationAndGetLatestData()`               | 予約実行と成功時の最新予約情報同期取得。                       |
    | `cancelReservationAndGetLatestData()`             | 予約キャンセルと成功時の最新予約情報同期取得。                 |
    | `updateReservationDetailsAndGetLatestData()`      | 予約詳細更新と成功時の最新情報同期取得。                       |
    | `searchNoPhoneUsersByFilterForWebApp()`           | 電話番号未登録ユーザー検索専用WebAppエンドポイント。           |
    | `updateMemo()`                                    | メモ更新と最新履歴の同期取得。                                 |
    | `getAvailableSlotsFromSummary()`                  | サマリーからの効率的空席情報取得。                             |

  - **最適化戦略**: 「操作実行 + 最新データ取得」の組み合わせにより、WebAppの通信回数を大幅削減してUXを向上。

---

### 3.6. 外部サービス連携

- **`06_ExternalServices.js`**
  - **役割**: Googleサービス（フォーム・カレンダー）との統合処理。システム外部との連携を管理。
  - **主要機能**:

    | 主要関数                                    | 役割                                                                             |
    | :------------------------------------------ | :------------------------------------------------------------------------------- |
    | `setCheckboxChoices(classroomName)`         | Googleフォームの予約選択肢を現在の予約状況に基づいて動的更新。                   |
    | `createStringArrayFromCounts(classroomName)` | フォーム選択肢用文字列配列の新定員管理ロジック対応生成。                     |
    | `addCalendarEventsToSheetWithSpecifics()`   | Googleカレンダーイベントの各教室予約シートへのインポート処理。                   |

  - **連携フロー**: 内部状態変更 → 外部サービス反映の自動連携により、一貫性のあるユーザー体験を提供。

---

### 3.7. キャッシュ管理

- **`07_CacheManager.js`**
  - **役割**: パフォーマンス最適化用キャッシュシステム。生徒データの高速アクセス実現。
  - **主要機能**:

    | 主要関数                              | 役割                                                                   |
    | :------------------------------------ | :--------------------------------------------------------------------- |
    | `updateRosterCache()`                 | 手動キャッシュ更新のメインエントリーポイント。                         |
    | `getAllStudentNames()`                | 全生徒名の収集処理。                                                   |
    | `updateRosterSheet()`                 | 名簿シートの欠損生徒データ更新。                                       |
    | `getAllReservations()`                | キャッシュ用予約データの包括的収集。                                   |
    | `updateRosterCacheColumns()`          | 名簿シートのキャッシュ列更新処理。                                     |
    | `migrateAllRecordsToCache()`          | 過去全データの「きろく」キャッシュ一括生成・更新。                     |
    | `migrateAllFutureBookingsToCache()`   | 現在全予約シートの「よやくキャッシュ」一括生成・更新。                 |
    | `getAllFutureReservations()`          | 未来予約データの包括的取得処理。                                       |

  - **パフォーマンス戦略**: 重いデータ集計を事前処理してキャッシュ化し、WebAppの高速応答を実現。

---

### 3.8. ユーティリティ

- **`08_Utilities.js`**
  - **役割**: ドメイン非依存の汎用ヘルパー関数ライブラリ。プロジェクト全体の基盤機能を提供。
  - **主要機能**:

    | 主要関数                             | 役割                                                                                                                             |
    | :----------------------------------- | :------------------------------------------------------------------------------------------------------------------------------- |
    | `createHeaderMap(headerRow)`         | ヘッダー行配列から列名→インデックスマップの生成。                                                                               |
    | `shouldProcessRowByDate()`           | 日付ベースの行処理判定フィルター。                                                                                               |
    | `handleError(message, isError)`      | 統一エラーハンドリング・通知・ログ記録システム。                                                                                 |
    | `findRowIndexByValue()`              | 特定値を持つ行のインデックス検索。                                                                                               |
    | `findLastRowOfDateBlock()`           | 日付グループの最終行検索。                                                                                                       |
    | `formatSheetWithBordersSafely()`     | 安全な罫線描画処理。                                                                                                             |
    | `createSalesRow()`                   | 売上ログエントリの生成。                                                                                                         |
    | `logActivity()`                      | アクティビティログシートへの操作記録。                                                                                           |
    | `sendAdminNotification()`            | 管理者へのメール通知送信。                                                                                                       |
    | `setupConditionalFormattingForLogSheet()` | ログシートの視覚的フォーマット設定。                                                                                     |

  - **設計方針**: 再利用可能で安定した基盤機能として、他のモジュールから広く利用される共通ライブラリ。

---

### 3.9. Webアプリケーション (HTML/JavaScript)

- **`10_WebApp.html`**
  - **役割**: Webアプリケーション全体の骨格となるメインHTMLファイル。
  - **主要機能**: 基本的なHTML構造の定義、外部ライブラリの読み込みと設定、他のHTMLファイルのインクルード。

- **`11_WebApp_Config.html`**
  - **役割**: WebAppのフロントエンドで使用される、静的な設定値や定数を集約するファイル。
  - **主要機能**: `DesignConfig`オブジェクトによるUIスタイルの一元管理など。

- **`12_WebApp_Core.html`**
  - **役割**: WebAppのフロントエンドにおける中核的なロジックを担うファイル。状態管理、UIコンポーネント生成、汎用ユーティリティ、計算ロジックなどを集約します。
  - **主要機能**: `appState`による状態管理、`Components`によるUI部品生成、`calculateAccountingDetails`による会計計算。

- **`13_WebApp_Views.html`**
  - **役割**: アプリケーションの各画面（ビュー）のHTML構造を生成する関数群を専門に扱うファイル。
  - **主要機能**: `getLoginView`、`getBookingView`など、`appState`の状態に応じて画面のHTMLを返す。

- **`14_WebApp_Handlers.html`**
  - **役割**: ユーザーの操作（クリックなど）に応じた処理（アクション）と、アプリケーション全体の制御フローを管理するファイル。
  - **主要機能**: `actionHandlers`によるイベント処理、`google.script.run`によるサーバー通信、`setState`と`render`による画面更新。

## 4. システムアーキテクチャとデータフロー

### 4.1. 全体的なデータフロー

このシステムは、Webアプリケーション、Google Apps Script、Google Sheetsの3層構造で構成されています。

```text
[ユーザー]
    ↓ 操作
[WebApp (HTML/JavaScript)]
    ↓ google.script.run API
[Google Apps Script (サーバーサイド)]
    ↓ SpreadsheetApp API
[Google Sheets (データベース)]
```

#### 主要なデータフローパターン

##### **1. 予約作成フロー**

```text
ユーザー入力 → WebApp検証 → GAS makeReservation() →
予約シート書き込み → サマリーシート更新 → キャッシュ更新 →
WebApp画面更新
```

##### **2. データ表示フロー**

```text
WebApp初期化 → GAS getInitialWebApp_Data() →
複数シート読み込み → キャッシュデータ取得 →
JSON統合 → WebApp描画
```

##### **3. バッチ処理フロー**

```text
スケジュール実行 → processReservations() →
アーカイブ転送 → 売上ログ生成 →
名簿キャッシュ更新 → サマリーシート再構築
```

### 4.2. 主要な処理パターン

#### リアルタイム処理（スプレッドシート編集時）

- **トリガー**: `onEdit`, `onChange`
- **処理**: 名前入力時の自動補完、人数変更時の再採番
- **特徴**: 即座に反映、ロック機構で競合回避

#### バッチ処理（定期実行）

- **トリガー**: 手動実行またはスケジュール
- **処理**: 過去データのアーカイブ、キャッシュ一括更新
- **特徴**: 大量データ処理、長時間実行対応

#### WebApp API処理

- **トリガー**: フロントエンドからの API 呼び出し
- **処理**: 予約CRUD操作、認証、データ取得
- **特徴**: 高速レスポンス重視、エラーハンドリング充実

### 4.3. キャッシュ戦略とパフォーマンス

#### 多層キャッシュ構造

##### **1. スプレッドシートオブジェクトキャッシュ**

- **場所**: `00_SpreadsheetManager.js`
- **対象**: Spreadsheet, Sheet オブジェクト
- **効果**: API 呼び出し回数削減

##### **2. 生徒名簿キャッシュ**

- **場所**: 生徒名簿シートの専用列
- **対象**: `よやくキャッシュ`（未来の予約）, `きろく_YYYY`（過去の参加履歴）
- **効果**: WebApp 画面描画の高速化

##### **3. 予約サマリーキャッシュ**

- **場所**: 予約サマリーシート
- **対象**: 集計済み空席情報
- **効果**: フォーム選択肢生成の高速化

#### キャッシュ更新タイミング

- **リアルタイム**: 予約・キャンセル時の差分更新
- **バッチ**: 日次での一括再構築
- **手動**: 管理者による強制更新

## 5. エラーハンドリングと障害対応

### 5.1. エラーハンドリング戦略

#### 階層化されたエラー処理

##### **1. フロントエンド（WebApp）**

```javascript
// ユーザー入力検証
if (!validateInput(data)) {
  showError('入力内容に不備があります');
  return;
}

// サーバー通信エラー
google.script.run
  .withFailureHandler(handleServerError)
  .withSuccessHandler(handleSuccess)
  .serverFunction(data);
```

##### **2. サーバーサイド（GAS）**

```javascript
// 統一エラーハンドリング
function safeExecute(func, ...args) {
  try {
    return func(...args);
  } catch (error) {
    handleError(error);
    return { success: false, error: error.message };
  }
}
```

##### **3. データベース層（Sheets）**

- ロック機構による競合回避（`LockService`）
- トランザクション的な操作の実装
- データ整合性チェック

#### ログ機能

- **アクティビティログ**: 全ユーザー操作の記録
- **エラーログ**: システムエラーの詳細記録
- **管理者通知**: 重要なエラーのメール通知

### 5.2. 一般的なエラーパターンと対処法

#### よくあるエラーと対処法

| エラーパターン                      | 原因               | 対処法                              |
| ----------------------------------- | ------------------ | ----------------------------------- |
| `Cannot read property of undefined` | データ構造の不整合 | null チェック強化、デフォルト値設定 |
| `Lock wait timeout`                 | 同時アクセス過多   | リトライ機構、ロック時間短縮        |
| `Quota exceeded`                    | API 制限超過       | バッチサイズ調整、実行頻度制限      |
| `Sheet not found`                   | シート名変更・削除 | シート存在チェック、自動復旧        |
| `Permission denied`                 | 権限不足           | 認証フロー見直し、権限確認          |

#### 予防的措置

- **入力検証**: フロントエンドとサーバーサイドの二重チェック
- **デフォルト値**: 未定義データに対する適切なフォールバック
- **トランザクション**: 部分的失敗の防止
- **冪等性**: 同じ操作の重複実行に対する安全性

### 5.3. 障害時の復旧手順

#### データ整合性チェック

1. **生徒ID の重複チェック**
2. **予約ID の一意性確認**
3. **キャッシュデータと実データの整合性**
4. **サマリーシートの集計値検証**

#### 復旧操作

1. **キャッシュ再構築**: `updateRosterCache()` 実行
2. **サマリー再生成**: `rebuildSummarySheet()` 実行
3. **アーカイブ再処理**: 必要に応じて過去データの再処理
4. **データバックアップ**: 修復前の状態保存

#### 緊急時対応

- **サービス停止**: WebApp のメンテナンスモード切り替え
- **ロールバック**: バックアップからの復元
- **部分復旧**: 影響範囲を限定した段階的復旧

## 6. パフォーマンス指針と最適化

### 6.1. 重い処理とボトルネック

#### 最も処理負荷の高い操作

##### **1. バッチ処理（重度）**

- `processReservations()`: 全教室の過去データ処理
- `migrateAllRecordsToCache()`: 全生徒の履歴キャッシュ再構築
- `rebuildSummarySheet()`: サマリーシート全再構築

##### **2. リアルタイム処理（中度）**

- 名前入力時の生徒名簿検索・自動補完
- 予約作成時のサマリーシート更新
- キャッシュの差分更新

##### **3. WebApp 初期化（軽度〜中度）**

- `getInitialWebApp_Data()`: 複数シートの並列読み込み
- ユーザー認証とプロフィール取得

#### 処理時間の目安

- **通常操作**: 1-3秒（予約作成、データ表示）
- **キャッシュ更新**: 5-15秒（差分更新）
- **バッチ処理**: 30秒〜5分（データ量により変動）

### 6.2. パフォーマンス最適化のベストプラクティス

#### スプレッドシートアクセス最適化

```javascript
// ❌ 非効率: 1セルずつアクセス
for (let i = 0; i < rows.length; i++) {
  sheet.getRange(i + 1, 1).setValue(data[i]);
}

// ✅ 効率的: 一括アクセス
const values = data.map(item => [item]);
sheet.getRange(1, 1, values.length, 1).setValues(values);
```

#### キャッシュ活用

```javascript
// ✅ SpreadsheetManager を使用
const sheet = SS_MANAGER.getSheet('生徒名簿');

// ✅ 生徒名簿キャッシュを活用
const futureBookings = JSON.parse(rosterData.よやくキャッシュ || '[]');
```

#### バッチサイズの調整

- **推奨バッチサイズ**: 100-500行（データの複雑さにより調整）
- **タイムアウト対策**: 長時間処理の分割実行
- **メモリ管理**: 大量データ処理時の変数クリア

### 6.3. スケーラビリティの考慮事項

#### 現在の制限と対応策

##### **Google Apps Script の制限**

- **実行時間**: 最大6分 → バッチ処理の分割実行
- **トリガー数**: プロジェクト単位で制限 → 効率的なトリガー設計
- **API 配当**: 日単位で制限 → アクセス頻度の最適化

##### **Google Sheets の制限**

- **セル数**: 1000万セル → アーカイブによるデータ分割
- **同時アクセス**: 100ユーザー → ロック機構とキャッシュ活用
- **関数の複雑さ**: → サーバーサイドでの計算処理

#### 成長への対応設計

- **教室数拡張**: 新シート追加時の自動設定
- **ユーザー数増加**: キャッシュ戦略の段階的強化
- **機能追加**: モジュール化された設計による影響範囲の限定

#### 監視とアラート

- **パフォーマンス監視**: 処理時間のログ記録
- **エラー率監視**: 失敗率の閾値監視
- **リソース使用量**: API 配当使用量の追跡
